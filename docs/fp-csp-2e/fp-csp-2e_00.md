# 前置材料

## 前言

函数式编程（FP）已成为主流编程中一个重要且令人兴奋的部分。在 2010 年代创建的大多数新语言和框架都是函数式的，导致一些人预测编程的未来将是函数式的。与此同时，像 C#和 Java 这样的流行面向对象（OO）语言在每次新版本中都引入了更多函数式特性，使得多范式编程风格成为可能。然而，在 C#社区中的采用速度却很慢。为什么是这样呢？我认为其中一个原因是缺乏优秀的文献：

+   大多数函数式编程文献是用函数式语言编写的，尤其是 Haskell。对于有面向对象（OOP）背景的开发者来说，这构成了学习函数式编程概念的语言障碍。尽管许多概念适用于像 C#这样的多范式语言，但一次学习一个新的范式和一种新语言是一项艰巨的任务。

+   更重要的是，文献中的大多数书籍倾向于用数学或计算机科学领域的例子来说明函数式技术和概念。对于大多数日复一日从事业务线（LOB）应用开发的程序员来说，这造成了领域差距，并让他们怀疑这些技术对于现实世界应用的相关性。

这些缺点在我的函数式编程学习之路上设置了巨大的障碍。在翻阅了第 n 本解释所谓的柯里化（通过展示如何使用数字 3 对`add`函数进行柯里化，创建一个可以将 3 加到任何数字上的函数——你能想到任何这种应用可能有一点点用处的场景吗？）的书之后，我决定走自己的研究之路。这包括学习半打函数式语言，并尝试找出哪些函数式编程的概念可以有效地应用于 C#以及大多数开发者被支付编写的那种应用。我的研究最终导致了这本书的撰写。

本书通过展示如何在 C#语言中利用函数式技术，为 C#开发者架起了语言差距的桥梁。它还通过展示如何将函数式技术应用于典型的商业场景，弥合了领域差距。我采取了一种实用主义的方法，并涵盖了在典型的 LOB 应用场景中有用的函数式技术，摒弃了大多数函数式编程背后的理论。最终，你应该关注函数式编程，因为它为你提供了以下：

+   *力量*——这仅仅意味着你可以用更少的代码完成更多的工作。函数式编程提高了抽象级别，允许你编写高级代码，同时让你摆脱那些增加复杂性但无价值的底层技术细节。

+   *安全性*——函数式编程不倾向于状态突变。这意味着以函数式风格编写的程序不太可能进入无效状态。此外，对状态突变采取保守的方法在处理并发时极为有益。以命令式风格编写的程序在单线程实现中可能运行良好，但在并发出现时可能会引发各种错误。函数式代码在并发场景中提供了更好的保证，因此在多核处理器时代，我们对函数式编程的兴趣激增是自然而然的事情。

+   *清晰度*——我们花费更多的时间维护和消费现有代码，而不是编写新代码，因此我们的代码必须是清晰且意图明显的。随着您学习以函数式方式思考，实现这种清晰度会变得更加自然。

如果您已经以面向对象的方式编程了一段时间，那么在本书中的概念得以实现之前，可能需要一些努力和实验的意愿。为了确保学习函数式编程是一个愉快且有益的过程，我有两个建议：

+   *耐心*——您可能需要多次阅读某些部分。您可能放下这本书几周，然后发现再次拿起它时，之前看似晦涩的内容突然开始变得有意义。

+   *在代码中进行实验*。除非您亲自动手，否则您不会学到东西。本书提供了许多示例和练习，许多代码片段可以在 REPL 中进行测试。

您的同事可能不如您那样渴望探索。预期他们会抗议您采用这种新风格，并困惑地看着您的代码，说出诸如，“为什么不直接做*x*？”（其中*x*是无聊的、过时的，通常是有害的）之类的话。不要讨论。只需坐下来观察他们最终会转而使用您的技术来解决他们反复遇到的问题。

## 致谢

我想感谢保罗·劳斯，他不仅通过他的语言扩展库（我从其中借鉴了许多好想法）提供了灵感，而且在各个阶段慷慨地审阅了本书。

曼宁出版社的严谨编辑流程确保了本书的质量远远优于如果让我自行处理的情况。为此，我想感谢参与本书的团队，包括迈克·斯蒂普斯，发展编辑玛琳娜·迈克尔斯，技术编辑雷内·范登伯格，项目经理迪尔德丽·希姆，以及校对员梅洛迪·多拉布。

特别感谢丹尼尔·马巴赫和塔米尔·德谢舍尔对技术洞察的贡献，以及所有参与同行评审的人，包括大卫·帕库德、福斯特·海恩斯、乔治·奥诺弗雷、戈特·赫尔勒、奥利弗·弗拉尔、杰里米·凯尼、肯特·斯皮尔纳、马特·范·温克尔、耶迪吉亚·博里索、马克·埃尔斯顿、纳吉布·阿里夫、奥利弗·科滕和罗伯特·威尔克。

感谢斯科特·沃尔申（Scott Wlaschin）在[`fsharpforfunandprofit.com`](http://fsharpforfunandprofit.com)分享他的文章，以及许多其他 FP 社区的成员，他们通过文章、博客和开源项目分享他们的知识和热情。

## 关于本书

本书旨在展示如何利用 C#中的函数式技术编写简洁、优雅、健壮和可维护的代码。

### 谁应该阅读这本书？

这本书是为一群有雄心的开发者编写的。你了解.NET 和 C#或类似的语言，如 Java、Swift 或 Kotlin。你有开发现实世界应用的经验，并且熟悉 OOP 概念、模式和最佳实践。但是，你希望通过学习函数式技术来扩展你的工具箱，以便充分利用 C#作为多范式语言。

如果你正在尝试或计划学习一种函数式语言，这本书也将非常有价值，因为你在熟悉的语言中学习如何以函数式的方式思考。改变你的思维方式是难点；一旦实现，学习任何特定语言的语法就相对容易了。

### 本书是如何组织的：路线图

本书由 19 章组成，分为 4 部分：

+   第一部分涵盖了函数式编程的基本原理。我们将从了解什么是函数式编程以及 C#如何支持函数式编程风格开始。然后，我们将探讨高阶函数的力量和纯函数的重要性。到第一部分结束时，你将具备概念和实践工具，以便开始学习更具体的函数式技术。

+   第二部分展示了函数式技术的实际应用：如何设计类型和函数签名，以及简单函数如何组合成复杂程序。到第二部分结束时，你将很好地了解以函数式风格编写的程序看起来是什么样子，以及这种风格所能带来的好处。

+   在掌握了这些基本概念之后，我们将在第三部分加快速度，转向更广泛的问题，如函数式错误处理、模块化和组合应用程序，以及理解状态和表示变化的函数式方法。到第三部分结束时，你将掌握一套工具，使你能够有效地使用函数式方法处理许多编程任务。

+   第四部分探讨了更高级的主题，包括惰性求值、有状态计算、异步、数据流和并发。第四部分的每一章都介绍了可能完全改变你编写和思考软件方式的关键技术。

你可以在封面的前部分找到每个章节的更详细的主题分解和表示，以及阅读任何特定章节之前需要阅读的章节。

### 为现实世界应用编码

本书旨在贴近现实场景。为此，许多例子涉及实际任务，如读取配置、连接数据库、验证 HTTP 请求等——这些可能是你已经知道如何做的，但你会从函数式思维的新视角看到它们。

在整本书中，我使用一个长期运行的例子来说明函数式编程（FP）在编写 LOB 应用程序时如何提供帮助。为此，我选择了虚构的 Codeland 银行的在线银行应用程序（BOC）——我知道这听起来很俗气，但至少它有一个必要的三个字母的缩写。因为大多数人都能访问在线银行服务，所以应该很容易想象所需的功能，并看到讨论的问题如何与实际应用相关。

我使用几个其他场景来说明如何以函数式风格解决典型的编程问题。希望这种在实用示例和 FP 概念之间的不断往返，能够帮助弥合理论与实践之间的差距，这是我发现在现有的文献中有所欠缺的。

### 利用函数式库

类似于 C#这样的语言可能具有函数式特性，但要充分利用这些特性，你通常会使用库来简化常见任务。在这本书中，你将了解

+   `System.Linq`——是的，如果你不知道的话，它是一个函数式库！鉴于它是.NET 如此重要的一个部分，我假设你熟悉它。

+   `System.Collections.Immutable`——这是一个不可变集合库，我们将在第十一章开始使用。

+   `System.Interactive`和`System.Reactive`——这些库（你可能知道它们是.NET 的*交互式扩展*和*响应式扩展*）允许你处理数据流，我们将在第十六章和第十八章中讨论。

这就排除了许多其他重要的类型和函数，它们是 FP 的基石。因此，一些独立开发者编写了库来填补这些空白。到目前为止，最完整的是由 Paul Louth 编写的 language-ext 库，它旨在改善 C#开发者以函数式编程方式编码时的体验。¹

在本书中，我不直接使用 language-ext；相反，我会向你展示我是如何开发自己的函数式实用程序库的，这个库叫做`LaYumba.Functional`，尽管它与 language-ext 有很大重叠。这有几个教学上的原因更有用：

+   代码在本书出版后将会保持稳定。

+   你有机会深入了解并看到那些强大的函数式结构定义起来竟然如此简单。

+   你可以专注于本质。我会以最纯粹的形式向你展示这些结构，这样你就不会被一个完整库处理的细节和边缘情况所分散注意力。

### 关于代码

《C#函数式编程》的第二版使用 C# 10 和.NET 6。² 许多（如果不是全部）技术可以应用于语言的前版本，尽管这样做通常需要额外的输入。附录具体说明了如何在早期版本的 C#中使用不可变数据和模式匹配，这些早期版本的 C#不将这些作为语言特性。

您可以从本书的 liveBook（在线）版本中获取可执行的代码片段，请访问[`livebook.manning.com/book/functional-programming-in-c-sharp-second-edition`](https://livebook.manning.com/book/functional-programming-in-c-sharp-second-edition)。您可以在 REPL 中执行许多较短的代码片段，从而获得即时的实践反馈。更长的示例可以在[`github.com/la-yumba/functional-csharp-code-2`](https://github.com/la-yumba/functional-csharp-code-2)下载，包括练习的设置和解决方案。您还可以从[www.manning.com/books/functional-programming-in-c-sharp-second-edition](https://www.manning.com/books/functional-programming-in-c-sharp-second-edition)下载本书的源代码。

书中的代码列表专注于讨论的主题，因此可能会省略`using`语句、命名空间声明、平凡的构造函数或之前列表中出现的且未更改的代码部分。如果您想看到列表的完整、可编译版本，您可以在代码仓库中找到它。

### liveBook 讨论论坛

购买《C#函数式编程 第二版》包括对 Manning 的在线阅读平台 liveBook 的免费访问。使用 liveBook 的独特讨论功能，您可以在全球范围内或针对特定章节或段落添加评论。为自己做笔记、提问和回答技术问题，以及从作者和其他用户那里获得帮助都非常简单。要访问论坛，请访问[`livebook.manning.com/book/functional-programming-in-c-sharp-second-edition/welcome/v-7/`](https://livebook.manning.com/book/functional-programming-in-c-sharp-second-edition/welcome/v-7/)。您还可以在[`livebook.manning.com/#!/discussion`](https://livebook.manning.com/#!/discussion)了解更多关于 Manning 论坛和行为准则的信息。

Manning 对我们读者的承诺是提供一个场所，让读者之间以及读者与作者之间可以进行有意义的对话。这不是对作者参与特定数量活动的承诺，作者对论坛的贡献仍然是自愿的（且未付费）。我们建议您尝试向作者提出一些挑战性的问题，以免他的兴趣转移！只要本书有售，论坛和先前讨论的存档将可通过出版社的网站访问。

## 关于作者

Enrico Buonanno 于 2001 年从哥伦比亚大学获得计算机科学硕士学位，自那时起一直担任软件开发人员和架构师。他为金融科技领域的知名公司（包括国际清算银行、巴克莱银行和瑞士信贷）以及其他技术驱动型业务处理了关键任务项目。

* * *

¹ language-ext 是开源的，可在 GitHub 和 NuGet 上获取：[`github.com/louthy/language-ext`](https://github.com/louthy/language-ext)。

C# 10 和 .NET 6 在撰写本文时仍处于预览阶段，因此可能存在一些差异。这些差异将在本书的相关部分中指出。
