<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 7. Manipulating Data"><div class="chapter" id="manipulating_data">
<h1><span class="label">Chapter 7. </span>Manipulating Data</h1>


<p><a data-type="indexterm" data-primary="manipulating data" id="ix_ch07-asciidoc0"/>Every application uses data, and we need to manipulate that data from one form to another. This chapter offers several topics on data transformation in areas such as secret management, JSON serialization, and XML serialization.</p>

<p><a data-type="indexterm" data-primary="secrets" data-secondary="defined" id="idm45678771897424"/>Secrets are data, such as passwords or API keys, that we don’t want to expose to third parties. This chapter has three sections on managing secrets for hashing, encryption, and hidden storage.</p>

<p>Much of the data we work with today is in JSON format. Basic serialization/deserialization is simple in modern frameworks, and it’s even simpler when you own both the data consumer and provider. When consuming third-party data, you don’t have control over that data’s consistency or standards. That’s why the JSON sections of this chapter drill down on customizations to help you handle JSON in whatever format you need.</p>

<p>Finally, although JSON has a dominant place among internet data formats today, there’s still plenty of XML data to work with, which is the subject of the XML sections. You’ll see another flavor of LINQ, called LINQ to XML, which gives you full control over the serialization/deserialization process.</p>






<section data-type="sect1" data-pdf-bookmark="7.1 Generating Password Hashes"><div class="sect1" id="idm45678771894416">
<h1>7.1 Generating Password Hashes</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678771893408">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="hashing, for passwords" id="ix_ch07-asciidoc1"/><a data-type="indexterm" data-primary="manipulating data" data-secondary="generating password hashes" id="ix_ch07-asciidoc2"/><a data-type="indexterm" data-primary="password management" id="ix_ch07-asciidoc3"/><a data-type="indexterm" data-primary="security" data-secondary="generating password hashes" id="ix_ch07-asciidoc4"/>You need to securely store user passwords.</p>
</div></section>













<section data-type="sect2" class="pagebreak-before less_space" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678771887328">
<h2>Solution</h2>

<p>This method generates a random salt to protect secrets:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="kt">byte</code><code class="p">[]</code> <code class="nf">GenerateSalt</code><code class="p">()</code>
<code class="p">{</code>
    <code class="k">const</code> <code class="kt">int</code> <code class="n">SaltLength</code> <code class="p">=</code> <code class="m">64</code><code class="p">;</code>

    <code class="kt">byte</code><code class="p">[]</code> <code class="n">salt</code> <code class="p">=</code> <code class="k">new</code> <code class="kt">byte</code><code class="p">[</code><code class="n">SaltLength</code><code class="p">];</code>
    <code class="kt">var</code> <code class="n">rngRand</code> <code class="p">=</code> <code class="k">new</code> <code class="n">RNGCryptoServiceProvider</code><code class="p">();</code>

    <code class="n">rngRand</code><code class="p">.</code><code class="n">GetBytes</code><code class="p">(</code><code class="n">salt</code><code class="p">);</code>

    <code class="k">return</code> <code class="n">salt</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>The next two methods use that salt to generate hashes:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="kt">byte</code><code class="p">[]</code> <code class="nf">GenerateMD5Hash</code><code class="p">(</code><code class="kt">string</code> <code class="n">password</code><code class="p">,</code> <code class="kt">byte</code><code class="p">[]</code> <code class="n">salt</code><code class="p">)</code>
<code class="p">{</code>
    <code class="kt">byte</code><code class="p">[]</code> <code class="n">passwordBytes</code> <code class="p">=</code> <code class="n">Encoding</code><code class="p">.</code><code class="n">UTF8</code><code class="p">.</code><code class="n">GetBytes</code><code class="p">(</code><code class="n">password</code><code class="p">);</code>

    <code class="kt">byte</code><code class="p">[]</code> <code class="n">saltedPassword</code> <code class="p">=</code>
        <code class="k">new</code> <code class="kt">byte</code><code class="p">[</code><code class="n">salt</code><code class="p">.</code><code class="n">Length</code> <code class="p">+</code> <code class="n">passwordBytes</code><code class="p">.</code><code class="n">Length</code><code class="p">];</code>

    <code class="k">using</code> <code class="nn">var</code> <code class="n">hash</code> <code class="p">=</code> <code class="k">new</code> <code class="n">MD5CryptoServiceProvider</code><code class="p">();</code>

    <code class="k">return</code> <code class="n">hash</code><code class="p">.</code><code class="n">ComputeHash</code><code class="p">(</code><code class="n">saltedPassword</code><code class="p">);</code>
<code class="p">}</code>

<code class="k">static</code> <code class="kt">byte</code><code class="p">[]</code> <code class="nf">GenerateSha256Hash</code><code class="p">(</code><code class="kt">string</code> <code class="n">password</code><code class="p">,</code> <code class="kt">byte</code><code class="p">[]</code> <code class="n">salt</code><code class="p">)</code>
<code class="p">{</code>
    <code class="kt">byte</code><code class="p">[]</code> <code class="n">passwordBytes</code> <code class="p">=</code> <code class="n">Encoding</code><code class="p">.</code><code class="n">UTF8</code><code class="p">.</code><code class="n">GetBytes</code><code class="p">(</code><code class="n">password</code><code class="p">);</code>

    <code class="kt">byte</code><code class="p">[]</code> <code class="n">saltedPassword</code> <code class="p">=</code>
        <code class="k">new</code> <code class="kt">byte</code><code class="p">[</code><code class="n">salt</code><code class="p">.</code><code class="n">Length</code> <code class="p">+</code> <code class="n">passwordBytes</code><code class="p">.</code><code class="n">Length</code><code class="p">];</code>

    <code class="k">using</code> <code class="nn">var</code> <code class="n">hash</code> <code class="p">=</code> <code class="k">new</code> <code class="n">SHA256CryptoServiceProvider</code><code class="p">();</code>

    <code class="k">return</code> <code class="n">hash</code><code class="p">.</code><code class="n">ComputeHash</code><code class="p">(</code><code class="n">saltedPassword</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>And here’s how to use the methods to generate hashes:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">(</code><code class="kt">string</code><code class="p">[]</code> <code class="n">args</code><code class="p">)</code>
<code class="p">{</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"\nPassword Hash Demo\n"</code><code class="p">);</code>

    <code class="n">Console</code><code class="p">.</code><code class="n">Write</code><code class="p">(</code><code class="s">"What is your password? "</code><code class="p">);</code>
    <code class="kt">string</code> <code class="n">password</code> <code class="p">=</code> <code class="n">Console</code><code class="p">.</code><code class="n">ReadLine</code><code class="p">();</code>

    <code class="kt">byte</code><code class="p">[]</code> <code class="n">salt</code> <code class="p">=</code> <code class="n">GenerateSalt</code><code class="p">();</code>

    <code class="kt">byte</code><code class="p">[]</code> <code class="n">md5Hash</code> <code class="p">=</code> <code class="n">GenerateMD5Hash</code><code class="p">(</code><code class="n">password</code><code class="p">,</code> <code class="n">salt</code><code class="p">);</code>
    <code class="kt">string</code> <code class="n">md5HashString</code> <code class="p">=</code> <code class="n">Convert</code><code class="p">.</code><code class="n">ToBase64String</code><code class="p">(</code><code class="n">md5Hash</code><code class="p">);</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"\nMD5:    {md5HashString}"</code><code class="p">);</code>

    <code class="kt">byte</code><code class="p">[]</code> <code class="n">sha256Hash</code> <code class="p">=</code> <code class="n">GenerateSha256Hash</code><code class="p">(</code><code class="n">password</code><code class="p">,</code> <code class="n">salt</code><code class="p">);</code>
    <code class="kt">string</code> <code class="n">sha256HashString</code> <code class="p">=</code> <code class="n">Convert</code><code class="p">.</code><code class="n">ToBase64String</code><code class="p">(</code><code class="n">sha256Hash</code><code class="p">);</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"\nSHA256: {sha256HashString}"</code><code class="p">);</code>
<code class="p">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678776337248">
<h2>Discussion</h2>

<p>ASP.NET identity has nice support for password and group/role management, which should be on anyone’s list of considerations when planning a new project. However, there are a lot of situations where ASP.NET identity won’t be the best option, for instance, when you have to use a database that ASP.NET identity doesn’t support or must use an existing database with its own homegrown password management.</p>

<p>When building a custom password management solution, best practice is to hash the password with a salt. A hash is a one-way translation of a password to a string of unintelligible characters. Every time you hash a specific password, you always get the same hash. That said, an important difference from encryption is that you can’t decrypt a hash—there’s no way to translate a hash back into the original password. That begs the question of how to know if the user enters the correct password. Since this is a book on C#, database development is out of scope. That said, here are the steps required to verify a password:</p>
<ol>
<li>
<p>When you create the user account, hash the password and store the hash in the database with the username.</p>
</li>
<li>
<p>When the user logs in, they provide the username and password.</p>
</li>
<li>
<p>With the username, your code makes a database query and retrieves the matching hash.</p>
</li>
<li>
<p>Hash the password the user entered.</p>
</li>
<li>
<p>Compare the hashed passwords.</p>
</li>
<li>
<p>If the password hashes match, validation succeeds—otherwise validation fails.</p>
</li>

</ol>

<p>Security is a constant game of cat and mouse. As soon as we learned to protect passwords with hashes, hackers looked for ways to break through that. Ultimately, the best we can do is to find a level of security that makes it prohibitively expensive for hackers, based on our need to protect the information compared to the hacker’s desire to obtain it. How much security can you afford?</p>

<p>Fortunately, there’s an easy way to beef up password security. A security best practice around hashed passwords is to include a salt, a random array of bytes appended to a password. We save the salt in the database, along with the username and password. This is effective in protecting against a rainbow attack, described in the note. The <code>GenerateSalt</code> method in the solution produces a random 64-byte value. The salt prevents a rainbow attack and forces the hacker to drop down to a dictionary attack, which is much more compute-intensive.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>If a hacker breaks into your system or figures out how to get a copy of the table holding passwords, there are a couple of common attacks: dictionary and rainbow.</p>

<p><a data-type="indexterm" data-primary="dictionary attack" id="idm45678771510960"/>In a dictionary attack, the hacker has a dictionary of words and phrases and iterates through that list, hashing each item and comparing to the database table. For all the complexity rules and the number of people who follow them, there are always some people that use single-word passwords. Spoiler alert: for all the people who think they’re clever with the symbol/number character replacements—that doesn’t work; the hacker’s dictionaries and algorithms already account for that.</p>

<p><a data-type="indexterm" data-primary="rainbow attack" id="idm45678771509360"/>The rainbow attack is another variation of the dictionary attack, and the difference is that the rainbow attack already hashed common words, so all they need is a simple comparison to move through the password table quicker.</p>
</div>

<p>Both the <code>GenerateMD5Hash</code> and <code>GenerateSha256</code> hash methods accept a password and a salt. Both methods translate the password into a <code>byte[]</code>, concatenate the password and hash, and generate a hash. The syntactic difference between the MD5 and SHA256 implementations is the <code>MD5CryptoServiceProvider</code> versus the <code>SHA256​Cryp⁠to​ServiceProvider</code>, respectively.</p>

<p>In practice, there are different reasons to use specific hash algorithms. The .NET Framework has several hash algorithms, which you can find by looking up <code>HashAlgorithm</code> and examining its derived classes. Many recent implementations use the SHA256 hash because it provides better protection than earlier hash algorithms. I included the MD5 algorithm to make the point that you don’t always have the luxury of selecting the algorithm because the password table might have already been created using MD5. In this case, the inconvenience to users might preclude the need for them to reenter passwords to accommodate another hash algorithm.</p>

<p>The <code>Main</code> method demonstrates how to use these algorithms to generate hashes. An interesting bit here is calling <code>Convert.ToBase64String</code>. Anytime you’re moving data from one place to another, the transport mechanism has a protocol and format based on special characters. If the characters in the hashed bytes translate into special characters during transport, the software will break. A standard way to work around this is to use a data format known as Base64, which generates characters that won’t conflict with special data format or transport protocol characters.<a data-type="indexterm" data-startref="ix_ch07-asciidoc4" id="idm45678771502048"/><a data-type="indexterm" data-startref="ix_ch07-asciidoc3" id="idm45678771501344"/><a data-type="indexterm" data-startref="ix_ch07-asciidoc2" id="idm45678771500672"/><a data-type="indexterm" data-startref="ix_ch07-asciidoc1" id="idm45678771500000"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.2 Encrypting and Decrypting Secrets"><div class="sect1" id="idm45678771499200">
<h1>7.2 Encrypting and Decrypting Secrets</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678771498288">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="API keys" id="ix_ch07-asciidoc5"/><a data-type="indexterm" data-primary="Crypto class" id="ix_ch07-asciidoc6"/><a data-type="indexterm" data-primary="encryption of secrets" id="ix_ch07-asciidoc7"/><a data-type="indexterm" data-primary="manipulating data" data-secondary="encrypting/decrypting secrets" id="ix_ch07-asciidoc8"/><a data-type="indexterm" data-primary="secrets" data-secondary="encrypting/decrypting" id="ix_ch07-asciidoc9"/><a data-type="indexterm" data-primary="security" data-secondary="encrypting/decrypting secrets" id="ix_ch07-asciidoc10"/>You have API keys that need to be encrypted at rest.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678771490112">
<h2>Solution</h2>

<p>This class encrypts and decrypts secrets:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">Crypto</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">byte</code><code class="p">[]</code> <code class="nf">Encrypt</code><code class="p">(</code><code class="kt">string</code> <code class="n">plainText</code><code class="p">,</code> <code class="kt">byte</code><code class="p">[]</code> <code class="n">key</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">using</code> <code class="nn">Aes</code> <code class="n">aes</code> <code class="p">=</code> <code class="n">Aes</code><code class="p">.</code><code class="n">Create</code><code class="p">();</code>
        <code class="n">aes</code><code class="p">.</code><code class="n">Key</code> <code class="p">=</code> <code class="n">key</code><code class="p">;</code>

        <code class="k">using</code> <code class="nn">var</code> <code class="n">memStream</code> <code class="p">=</code> <code class="k">new</code> <code class="n">MemoryStream</code><code class="p">();</code>
        <code class="n">memStream</code><code class="p">.</code><code class="n">Write</code><code class="p">(</code><code class="n">aes</code><code class="p">.</code><code class="n">IV</code><code class="p">,</code> <code class="m">0</code><code class="p">,</code> <code class="n">aes</code><code class="p">.</code><code class="n">IV</code><code class="p">.</code><code class="n">Length</code><code class="p">);</code>

        <code class="k">using</code> <code class="nn">var</code> <code class="n">cryptoStream</code> <code class="p">=</code> <code class="k">new</code> <code class="n">CryptoStream</code><code class="p">(</code>
            <code class="n">memStream</code><code class="p">,</code>
            <code class="n">aes</code><code class="p">.</code><code class="n">CreateEncryptor</code><code class="p">(),</code>
            <code class="n">CryptoStreamMode</code><code class="p">.</code><code class="n">Write</code><code class="p">);</code>

        <code class="kt">byte</code><code class="p">[]</code> <code class="n">plainTextBytes</code> <code class="p">=</code> <code class="n">Encoding</code><code class="p">.</code><code class="n">UTF8</code><code class="p">.</code><code class="n">GetBytes</code><code class="p">(</code><code class="n">plainText</code><code class="p">);</code>

        <code class="n">cryptoStream</code><code class="p">.</code><code class="n">Write</code><code class="p">(</code><code class="n">plainTextBytes</code><code class="p">);</code>
        <code class="n">cryptoStream</code><code class="p">.</code><code class="n">FlushFinalBlock</code><code class="p">();</code>

        <code class="n">memStream</code><code class="p">.</code><code class="n">Position</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code>

        <code class="k">return</code> <code class="n">memStream</code><code class="p">.</code><code class="n">ToArray</code><code class="p">();</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="kt">string</code> <code class="nf">Decrypt</code><code class="p">(</code><code class="kt">byte</code><code class="p">[]</code> <code class="n">cypherBytes</code><code class="p">,</code> <code class="kt">byte</code><code class="p">[]</code> <code class="n">key</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">using</code> <code class="nn">var</code> <code class="n">memStream</code> <code class="p">=</code> <code class="k">new</code> <code class="n">MemoryStream</code><code class="p">();</code>
        <code class="n">memStream</code><code class="p">.</code><code class="n">Write</code><code class="p">(</code><code class="n">cypherBytes</code><code class="p">);</code>
        <code class="n">memStream</code><code class="p">.</code><code class="n">Position</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code>

        <code class="k">using</code> <code class="nn">var</code> <code class="n">aes</code> <code class="p">=</code> <code class="n">Aes</code><code class="p">.</code><code class="n">Create</code><code class="p">();</code>

        <code class="kt">byte</code><code class="p">[]</code> <code class="n">iv</code> <code class="p">=</code> <code class="k">new</code> <code class="kt">byte</code><code class="p">[</code><code class="n">aes</code><code class="p">.</code><code class="n">IV</code><code class="p">.</code><code class="n">Length</code><code class="p">];</code>
        <code class="n">memStream</code><code class="p">.</code><code class="n">Read</code><code class="p">(</code><code class="n">iv</code><code class="p">,</code> <code class="m">0</code><code class="p">,</code> <code class="n">iv</code><code class="p">.</code><code class="n">Length</code><code class="p">);</code>

        <code class="k">using</code> <code class="nn">var</code> <code class="n">cryptoStream</code> <code class="p">=</code> <code class="k">new</code> <code class="n">CryptoStream</code><code class="p">(</code>
            <code class="n">memStream</code><code class="p">,</code>
            <code class="n">aes</code><code class="p">.</code><code class="n">CreateDecryptor</code><code class="p">(</code><code class="n">key</code><code class="p">,</code> <code class="n">iv</code><code class="p">),</code>
            <code class="n">CryptoStreamMode</code><code class="p">.</code><code class="n">Read</code><code class="p">);</code>

        <code class="kt">int</code> <code class="n">plainTextByteLength</code> <code class="p">=</code> <code class="n">cypherBytes</code><code class="p">.</code><code class="n">Length</code> <code class="p">-</code> <code class="n">iv</code><code class="p">.</code><code class="n">Length</code><code class="p">;</code>
        <code class="kt">var</code> <code class="n">plainTextBytes</code> <code class="p">=</code> <code class="k">new</code> <code class="kt">byte</code><code class="p">[</code><code class="n">plainTextByteLength</code><code class="p">];</code>
        <code class="n">cryptoStream</code><code class="p">.</code><code class="n">Read</code><code class="p">(</code><code class="n">plainTextBytes</code><code class="p">,</code> <code class="m">0</code><code class="p">,</code> <code class="n">plainTextByteLength</code><code class="p">);</code>

        <code class="k">return</code> <code class="n">Encoding</code><code class="p">.</code><code class="n">UTF8</code><code class="p">.</code><code class="n">GetString</code><code class="p">(</code><code class="n">plainTextBytes</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>Here’s a method that generates a random key:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="kt">byte</code><code class="p">[]</code> <code class="nf">GenerateKey</code><code class="p">()</code>
<code class="p">{</code>
    <code class="k">const</code> <code class="kt">int</code> <code class="n">KeyLength</code> <code class="p">=</code> <code class="m">32</code><code class="p">;</code>

    <code class="kt">byte</code><code class="p">[]</code> <code class="n">key</code> <code class="p">=</code> <code class="k">new</code> <code class="kt">byte</code><code class="p">[</code><code class="n">KeyLength</code><code class="p">];</code>
    <code class="kt">var</code> <code class="n">rngRand</code> <code class="p">=</code> <code class="k">new</code> <code class="n">RNGCryptoServiceProvider</code><code class="p">();</code>

    <code class="n">rngRand</code><code class="p">.</code><code class="n">GetBytes</code><code class="p">(</code><code class="n">key</code><code class="p">);</code>

    <code class="k">return</code> <code class="n">key</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>Here’s how to use the <code>Crypto</code> class and a random key to encrypt and decrypt secrets:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">()</code>
<code class="p">{</code>
    <code class="kt">var</code> <code class="n">crypto</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Crypto</code><code class="p">();</code>

    <code class="n">Console</code><code class="p">.</code><code class="n">Write</code><code class="p">(</code><code class="s">"Please enter text to encrypt: "</code><code class="p">);</code>
    <code class="kt">string</code> <code class="n">userPlainText</code> <code class="p">=</code> <code class="n">Console</code><code class="p">.</code><code class="n">ReadLine</code><code class="p">();</code>

    <code class="kt">byte</code><code class="p">[]</code> <code class="n">key</code> <code class="p">=</code> <code class="n">GenerateKey</code><code class="p">();</code>

    <code class="kt">byte</code><code class="p">[]</code> <code class="n">cypherBytes</code> <code class="p">=</code> <code class="n">crypto</code><code class="p">.</code><code class="n">Encrypt</code><code class="p">(</code><code class="n">userPlainText</code><code class="p">,</code> <code class="n">key</code><code class="p">);</code>

    <code class="kt">string</code> <code class="n">cypherText</code> <code class="p">=</code> <code class="n">Convert</code><code class="p">.</code><code class="n">ToBase64String</code><code class="p">(</code><code class="n">cypherBytes</code><code class="p">);</code>

    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"Cypher Text: {cypherText}"</code><code class="p">);</code>

    <code class="kt">string</code> <code class="n">decryptedPlainText</code> <code class="p">=</code> <code class="n">crypto</code><code class="p">.</code><code class="n">Decrypt</code><code class="p">(</code><code class="n">cypherBytes</code><code class="p">,</code> <code class="n">key</code><code class="p">);</code>

    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"Plain Text: {decryptedPlainText}"</code><code class="p">);</code>
<code class="p">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678771099984">
<h2>Discussion</h2>

<p>We often have secrets—API keys or other sensitive information—to protect. Encryption is how we protect information at rest. Before saving, we encrypt the data, and after retrieving the encrypted data, we decrypt it for use.</p>

<p>In the solution, the <code>Crypto</code> class has methods to encrypt and decrypt data. The <code>key</code> parameter is a secret value used by the encryption/decryption algorithms. We’ll be using a technique called <em>symmetric key encryption</em>, where we use a single key to encrypt/decrypt all the data. Clearly, you don’t store the encryption key in the same place as the data because if a hacker is able to read the data, they would also need to figure out where the encryption key is. In this demo, the <code>GenerateKey</code> method produces a random 32-bit key, required by the crypto provider.</p>

<p>The crypto provider is the code that uses a special algorithm to encrypt/decrypt data. The solution example uses Advanced Encryption Standard (AES), which is a modern and secure encryption algorithm.</p>

<p>When saving the data, you pass the <code>plainText</code> string, along with the <code>key</code>, into the <code>Encrypt</code> method. Calling <code>AES.Create</code> returns an instance of <code>AES</code>. The value stored in the database is the concatenated initialization vector (IV) and encrypted text. Notice how the <code>memStream</code> first loads the IV from the <code>AES</code> instance.</p>

<p>The three arguments to <code>CryptoStream</code> are the <code>memStream</code> (containing the IV), an <code>ICryptoTransform</code> (returned by the call to <code>AES.CreateEncryptor</code>), and a <code>Crypto​S⁠treamMode</code> (indicating that we’re writing to the stream). The <code>cryptoStream</code> instance will append encrypted bytes to the IV in <code>memStream</code>. We’re working with <code>byte[]</code> <span class="keep-together">representations</span> of the data, including <code>plainText</code>. Calling <code>Write</code> on <code>cryptoStream</code> performs the encryption, and calling <code>FlushFinalBlock</code> ensures all the bytes are processed and pushed into <code>memStream</code>.</p>

<p>The <code>Decrypt</code> method reverses this process. In addition to the <code>key</code>, which is the same key used to encrypt, there’s a <code>cypherBytes</code> parameter. If you recall from the <code>Encrypt</code> process, the encrypted value includes both the IV and the appended encrypted value, and these are the contents of <code>cypherBytes</code>. After loading <code>memStream</code> with <code>cypherBytes</code>, the code repositions <code>memStream</code> to the beginning and extracts the IV into <code>iv</code>. This leaves the <code>memStream</code> positioned at <code>iv.Length</code>, where the encrypted value begins.</p>

<p>This time, <code>cryptoStream</code> uses the encrypted text (<code>memStream</code> positioned appropriately). Here, <code>ICryptoTransform</code> is different because we call <code>CreateDecryptor</code> with <code>iv</code> and <code>key</code>. Also, the <code>CryptoStreamMode</code> needs to be <code>Read</code>. Calling <code>Read</code> on <code>cryptoStream</code> performs the decryption.</p>

<p>The <code>Main</code> method shows how to use the <code>Encrypt</code> and <code>Decrypt</code> methods. Notice that it uses the same <code>key</code> for both. The <code>Convert.ToBase64String</code> ensures we can work with the data without random bytes being interpreted in unexpected ways. For instance, if you print a binary file to the console, you might hear dings because some of the bytes were interpreted as bell characters. Also, when transporting data, Base64 helps avoid bytes being interpreted as transport protocol or formatting characters, which breaks code.<a data-type="indexterm" data-startref="ix_ch07-asciidoc10" id="idm45678770952624"/><a data-type="indexterm" data-startref="ix_ch07-asciidoc9" id="idm45678770951920"/><a data-type="indexterm" data-startref="ix_ch07-asciidoc8" id="idm45678770951248"/><a data-type="indexterm" data-startref="ix_ch07-asciidoc7" id="idm45678770950576"/><a data-type="indexterm" data-startref="ix_ch07-asciidoc6" id="idm45678770949904"/><a data-type="indexterm" data-startref="ix_ch07-asciidoc5" id="idm45678770949232"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.3 Hiding Development Secrets"><div class="sect1" id="idm45678770948432">
<h1>7.3 Hiding Development Secrets</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678770947472">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="manipulating data" data-secondary="hiding development secrets" id="ix_ch07-asciidoc11"/><a data-type="indexterm" data-primary="secrets" data-secondary="hiding development secrets" id="ix_ch07-asciidoc12"/><a data-type="indexterm" data-primary="security" data-secondary="hiding development secrets" id="ix_ch07-asciidoc13"/>You need to avoid accidentally checking secrets, like passwords and API keys, into source control.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678770942016">
<h2>Solution</h2>

<p>Here’s the project file:</p>

<pre data-type="programlisting" data-code-language="xml"><code class="nt">&lt;Project</code> <code class="na">Sdk=</code><code class="s">"Microsoft.NET.Sdk"</code><code class="nt">&gt;</code>
    <code class="nt">&lt;PropertyGroup&gt;</code>
    <code class="nt">&lt;OutputType&gt;</code>Exe<code class="nt">&lt;/OutputType&gt;</code>
    <code class="nt">&lt;TargetFramework&gt;</code>net5.0<code class="nt">&lt;/TargetFramework&gt;</code>
    <code class="nt">&lt;RootNamespace&gt;</code>Section_07_03<code class="nt">&lt;/RootNamespace&gt;</code>
    <code class="nt">&lt;UserSecretsId&gt;</code>d3d91a8b-d440-414a-821e-7f11eec48f32<code class="nt">&lt;/UserSecretsId&gt;</code>
    <code class="nt">&lt;/PropertyGroup&gt;</code>

    <code class="nt">&lt;ItemGroup&gt;</code>
    <code class="nt">&lt;PackageReference</code>
        <code class="na">Include=</code><code class="s">"Microsoft.Extensions.Hosting"</code> <code class="na">Version=</code><code class="s">"5.0.0"</code> <code class="nt">/&gt;</code>
    <code class="nt">&lt;/ItemGroup&gt;</code>
<code class="nt">&lt;/Project&gt;</code></pre>

<p>This code shows how easy it is to add code supporting hidden secrets:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">class</code> <code class="nc">Program</code>
<code class="p">{</code>
    <code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="kt">var</code> <code class="n">config</code> <code class="p">=</code> <code class="k">new</code> <code class="n">ConfigurationBuilder</code><code class="p">()</code>
            <code class="p">.</code><code class="n">AddUserSecrets</code><code class="p">&lt;</code><code class="n">Program</code><code class="p">&gt;()</code>
            <code class="p">.</code><code class="n">Build</code><code class="p">();</code>

        <code class="kt">string</code> <code class="n">key</code> <code class="p">=</code> <code class="s">"CSharpCookbook:ApiKey"</code><code class="p">;</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"{key}: {config[key]}"</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678770918240">
<h2>Discussion</h2>

<p>This is so common, where developers accidentally check database connection strings from configuration files into source control. Another frequent issue is when a developer needs help in an online forum and accidentally leaves secrets in their code sample. Hopefully, it’s clear that these mistakes have the potential for grave damage to an application or even a business.</p>

<p><a data-type="indexterm" data-primary="Secret Manager" id="idm45678770819808"/>One solution for this is to use the Secret Manager. While the Secret Manager is normally associated with ASP.NET because of built-in configuration support, you can use it with any type of application. The solution shows how easy it is to use the secret manager with a console application.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>This is a feature that’s useful for working in a development environment. In production, you would want to use a more secure option, for instance, Key Vault if you were deploying to Azure. Holding secrets in environment variables is another way to avoid storing them in code or configuration.</p>

<p>Some project types, such as ASP.NET already have support for ensuring you don’t accidentally put development code in production, like this:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">if</code> <code class="p">(</code><code class="n">env</code><code class="p">.</code><code class="n">IsDevelopment</code><code class="p">())</code>
<code class="p">{</code>
    <code class="n">config</code><code class="p">.</code><code class="n">AddUserSecrets</code><code class="p">&lt;</code><code class="n">Program</code><code class="p">&gt;();</code>
<code class="p">}</code></pre>
</div>

<p>You can set up an application to use Secret Manager with the dotnet CLI. The first thing is to update the project by typing this on the command line:</p>

<pre data-type="programlisting" data-code-language="text">dotnet user-secrets init</pre>

<p>That adds a <code>UserSecretsID</code> tag to the project file, as previously shown. That GUID identifies the location in your file system where the secrets are stored. In this example, that location is:</p>

<pre data-type="programlisting" data-code-language="text">%APPDATA%\Microsoft\UserSecrets\d3d91a8b-d440-414a-821e-7f11eec48f32
\secrets.json</pre>

<p>on Windows or:</p>

<pre data-type="programlisting" data-code-language="text">~/.microsoft/usersecrets/d3d91a8b-d440-414a-821e-7f11eec48f32
/secrets.json</pre>

<p>for Linux or macOS machines.</p>

<p>After setting up, you can start adding secrets, like this (in the same location as the project folder):</p>

<pre data-type="programlisting" data-code-language="text">dotnet user-secrets set "CSharpCookbook:ApiKey" "mYaPIsECRET"</pre>

<p>You can verify that the secret was saved by looking at <code>secrets.json</code> or the following command:</p>

<pre data-type="programlisting" data-code-language="text">dotnet user-secrets list</pre>

<p>The <code>Main</code> method shows how to read Secret Manager keys. Remember to reference the <code>Microsoft.Extensions.Hosting</code> NuGet package. Just call <code>AddUserSecrets</code> on a new <code>ConfigurationBuilder</code>. Calling <code>Build</code> on that returns an <code>IConfigurationRoot</code> instance that provides indexer support for reading keys.<a data-type="indexterm" data-startref="ix_ch07-asciidoc13" id="idm45678770765216"/><a data-type="indexterm" data-startref="ix_ch07-asciidoc12" id="idm45678770713136"/><a data-type="indexterm" data-startref="ix_ch07-asciidoc11" id="idm45678770712464"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.4 Producing JSON"><div class="sect1" id="producing_json">
<h1>7.4 Producing JSON</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678770710304">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="JSON" data-secondary="customizing output formatting" id="ix_ch07-asciidoc14"/><a data-type="indexterm" data-primary="manipulating data" data-secondary="producing JSON" id="ix_ch07-asciidoc15"/>You need to customize JSON output formatting.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678770714416">
<h2>Solution</h2>

<p>This code shows what a <code>PurchaseOrder</code> looks like:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">enum</code> <code class="n">PurchaseOrderStatus</code>
<code class="p">{</code>
    <code class="n">Received</code><code class="p">,</code>
    <code class="n">Processing</code><code class="p">,</code>
    <code class="n">Fulfilled</code>
<code class="p">}</code>

<code class="k">public</code> <code class="k">class</code> <code class="nc">PurchaseItem</code>
<code class="p">{</code>
<code class="na">    [JsonPropertyName("serialNo")]</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">SerialNumber</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [JsonPropertyName("description")]</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Description</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [JsonPropertyName("qty")]</code>
    <code class="k">public</code> <code class="kt">float</code> <code class="n">Quantity</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [JsonPropertyName("amount")]</code>
    <code class="k">public</code> <code class="kt">decimal</code> <code class="n">Price</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code>

<code class="k">public</code> <code class="k">class</code> <code class="nc">PurchaseOrder</code>
<code class="p">{</code>
<code class="na">    [JsonPropertyName("company")]</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">CompanyName</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
<code class="na">    [JsonPropertyName("address")]</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Address</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
<code class="na">    [JsonPropertyName("phone")]</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Phone</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [JsonPropertyName("status")]</code>
    <code class="k">public</code> <code class="n">PurchaseOrderStatus</code> <code class="n">Status</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [JsonPropertyName("other")]</code>
    <code class="k">public</code> <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="kt">string</code><code class="p">&gt;</code> <code class="n">AdditionalInfo</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [JsonPropertyName("details")]</code>
    <code class="k">public</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">PurchaseItem</code><code class="p">&gt;</code> <code class="n">Items</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code></pre>

<p>This code serializes a <code>PurchaseOrder</code>:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">PurchaseOrderService</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">void</code> <code class="nf">View</code><code class="p">(</code><code class="n">PurchaseOrder</code> <code class="n">po</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="kt">var</code> <code class="n">jsonOptions</code> <code class="p">=</code> <code class="k">new</code> <code class="n">JsonSerializerOptions</code>
        <code class="p">{</code>
            <code class="n">WriteIndented</code> <code class="p">=</code> <code class="k">true</code>
        <code class="p">};</code>

        <code class="kt">string</code> <code class="n">poJson</code> <code class="p">=</code> <code class="n">JsonSerializer</code><code class="p">.</code><code class="n">Serialize</code><code class="p">(</code><code class="n">po</code><code class="p">,</code> <code class="n">jsonOptions</code><code class="p">);</code>

        <code class="c1">// send HTTP request</code>

        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">poJson</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>Here’s how to populate a <code>PurchaseOrder</code>:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="n">PurchaseOrder</code> <code class="nf">GetPurchaseOrder</code><code class="p">()</code>
<code class="p">{</code>
    <code class="k">return</code> <code class="k">new</code> <code class="n">PurchaseOrder</code>
    <code class="p">{</code>
        <code class="n">CompanyName</code> <code class="p">=</code> <code class="s">"Acme, Inc."</code><code class="p">,</code>
        <code class="n">Address</code> <code class="p">=</code> <code class="s">"123 4th St."</code><code class="p">,</code>
        <code class="n">Phone</code> <code class="p">=</code> <code class="s">"555-835-7609"</code><code class="p">,</code>
        <code class="n">AdditionalInfo</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="kt">string</code><code class="p">&gt;</code>
        <code class="p">{</code>
            <code class="p">{</code> <code class="s">"terms"</code><code class="p">,</code> <code class="s">"Net 30"</code> <code class="p">},</code>
            <code class="p">{</code> <code class="s">"poc"</code><code class="p">,</code> <code class="s">"J. Smith"</code> <code class="p">}</code>
        <code class="p">},</code>
        <code class="n">Items</code> <code class="p">=</code> <code class="k">new</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">PurchaseItem</code><code class="p">&gt;</code>
        <code class="p">{</code>
            <code class="k">new</code> <code class="n">PurchaseItem</code>
            <code class="p">{</code>
                <code class="n">Description</code> <code class="p">=</code> <code class="s">"Widget"</code><code class="p">,</code>
                <code class="n">Price</code> <code class="p">=</code> <code class="m">13.95</code><code class="n">m</code><code class="p">,</code>
                <code class="n">Quantity</code> <code class="p">=</code> <code class="m">5</code><code class="p">,</code>
                <code class="n">SerialNumber</code> <code class="p">=</code> <code class="s">"123"</code>
            <code class="p">}</code>
        <code class="p">}</code>
    <code class="p">};</code>
<code class="p">}</code></pre>

<p>The <code>Main</code> method drives the process:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">()</code>
<code class="p">{</code>
    <code class="n">PurchaseOrder</code> <code class="n">po</code> <code class="p">=</code> <code class="n">GetPurchaseOrder</code><code class="p">();</code>
    <code class="k">new</code> <code class="nf">PurchaseOrderService</code><code class="p">().</code><code class="n">View</code><code class="p">(</code><code class="n">po</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>And here’s the output:</p>

<pre data-type="programlisting" data-code-language="json"><code class="p">{</code>
  <code class="nt">"company"</code><code class="p">:</code> <code class="s2">"Acme, Inc."</code><code class="p">,</code>
  <code class="nt">"address"</code><code class="p">:</code> <code class="s2">"123 4th St."</code><code class="p">,</code>
  <code class="nt">"phone"</code><code class="p">:</code> <code class="s2">"555-835-7609"</code><code class="p">,</code>
  <code class="nt">"status"</code><code class="p">:</code> <code class="mi">0</code><code class="p">,</code>
  <code class="nt">"other"</code><code class="p">:</code> <code class="p">{</code>
    <code class="nt">"terms"</code><code class="p">:</code> <code class="s2">"Net 30"</code><code class="p">,</code>
    <code class="nt">"poc"</code><code class="p">:</code> <code class="s2">"J. Smith"</code>
  <code class="p">},</code>
  <code class="nt">"details"</code><code class="p">:</code> <code class="p">[</code>
    <code class="p">{</code>
      <code class="nt">"serialNo"</code><code class="p">:</code> <code class="s2">"123"</code><code class="p">,</code>
      <code class="nt">"description"</code><code class="p">:</code> <code class="s2">"Widget"</code><code class="p">,</code>
      <code class="nt">"qty"</code><code class="p">:</code> <code class="mi">5</code><code class="p">,</code>
      <code class="nt">"amount"</code><code class="p">:</code> <code class="mf">13.95</code>
    <code class="p">}</code>
  <code class="p">]</code>
<code class="p">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678770804928">
<h2>Discussion</h2>

<p>Just calling <code>JsonSerializer.Serialize</code>, from the <code>System.Text.Json</code> namespace, is a simple and quick way to serialize objects into JSON. If you own the producing and consuming parts of an application, this might be the way to go for simplicity and speed. However, it’s often the case that you’re consuming a third-party API that specifies its own JSON data format. Additionally, its naming convention won’t match C# Pascal-cased property names. This section shows how to perform those serializer output customizations.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Microsoft introduced the <code>System.Text.Json</code> namespace in .NET Core 3. Previously, a popular choice was the excellently supported <code>Newtonsoft.Json</code> library.</p>
</div>

<p>In the solution scenario, we want to send a JSON document to an API, but the property names don’t match. That’s why <code>PurchaseOrder</code> (and supporting types) decorates properties with the <code>JsonPropertyName</code> attribute. The <code>JsonSerializer</code> uses <code>JsonPropertyName</code> to specify the output property name.</p>

<p>The <code>PurchaseOrderService</code> has a <code>View</code> method that serializes a <code>PurchaseOrder</code>. By default, the serializer output is a single line and we want to see formatted output. The code uses a <code>JsonSerializerOption</code>, with <code>WriteIndented</code> set to true, producing the output shown in the solution.</p>

<p>The <code>Main</code> method drives the process, getting a new <code>PurchaseOrder</code> and then calling <code>View</code> to print out the results.</p>

<p>Sometimes, APIs grow organically and their naming conventions lack consistency, making this the ideal approach to customizing output. However, if you are using an API with a consistent naming convention, <a data-type="xref" href="#consuming_json">Recipe 7.5</a> explains how to build a converter to avoid decorating every property with <code>JsonPropertyName</code>.<a data-type="indexterm" data-startref="ix_ch07-asciidoc15" id="idm45678770131376"/><a data-type="indexterm" data-startref="ix_ch07-asciidoc14" id="idm45678770130640"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45678770129840">
<h2>See Also</h2>

<p><a data-type="xref" data-xrefstyle="rec-num-title" href="#consuming_json">Recipe 7.5, “Consuming JSON”</a></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.5 Consuming JSON"><div class="sect1" id="consuming_json">
<h1>7.5 Consuming JSON</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678770125792">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="JSON" data-secondary="consuming" id="ix_ch07-asciidoc16"/><a data-type="indexterm" data-primary="manipulating data" data-secondary="consuming JSON" id="ix_ch07-asciidoc17"/>You need to read a JSON object that doesn’t fit default deserialization options.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678770121712">
<h2>Solution</h2>

<p>Here’s what a <code>PurchaseOrder</code> looks like:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">enum</code> <code class="n">PurchaseOrderStatus</code>
<code class="p">{</code>
    <code class="n">Received</code><code class="p">,</code>
    <code class="n">Processing</code><code class="p">,</code>
    <code class="n">Fulfilled</code>
<code class="p">}</code>

<code class="k">public</code> <code class="k">class</code> <code class="nc">PurchaseItem</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">SerialNumber</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="kt">string</code> <code class="n">Description</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="kt">float</code> <code class="n">Quantity</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="kt">decimal</code> <code class="n">Price</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code>

<code class="k">public</code> <code class="k">class</code> <code class="nc">PurchaseOrder</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">CompanyName</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Address</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Phone</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [JsonConverter(typeof(PurchaseOrderStatusConverter))]</code>
    <code class="k">public</code> <code class="n">PurchaseOrderStatus</code> <code class="n">Status</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="kt">string</code><code class="p">&gt;</code> <code class="n">AdditionalInfo</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">PurchaseItem</code><code class="p">&gt;</code> <code class="n">Items</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code></pre>

<p>Here’s a custom <code>JsonConverter</code> class:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">PurchaseOrderStatusConverter</code>
    <code class="p">:</code> <code class="n">JsonConverter</code><code class="p">&lt;</code><code class="n">PurchaseOrderStatus</code><code class="p">&gt;</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">override</code> <code class="n">PurchaseOrderStatus</code> <code class="nf">Read</code><code class="p">(</code>
        <code class="k">ref</code> <code class="n">Utf8JsonReader</code> <code class="n">reader</code><code class="p">,</code>
        <code class="n">Type</code> <code class="n">typeToConvert</code><code class="p">,</code>
        <code class="n">JsonSerializerOptions</code> <code class="n">options</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="kt">string</code> <code class="n">statusString</code> <code class="p">=</code> <code class="n">reader</code><code class="p">.</code><code class="n">GetString</code><code class="p">();</code>

        <code class="k">if</code> <code class="p">(</code><code class="n">Enum</code><code class="p">.</code><code class="n">TryParse</code><code class="p">(</code>
            <code class="n">statusString</code><code class="p">,</code>
            <code class="k">out</code> <code class="n">PurchaseOrderStatus</code> <code class="n">status</code><code class="p">))</code>
        <code class="p">{</code>
            <code class="k">return</code> <code class="n">status</code><code class="p">;</code>
        <code class="p">}</code>
        <code class="k">else</code>
        <code class="p">{</code>
            <code class="k">throw</code> <code class="k">new</code> <code class="nf">JsonException</code><code class="p">(</code>
                <code class="err">$</code><code class="s">"{statusString} is not a valid "</code> <code class="p">+</code>
                <code class="err">$</code><code class="s">"{nameof(PurchaseOrderStatus)} value."</code><code class="p">);</code>
        <code class="p">}</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">override</code> <code class="k">void</code> <code class="nf">Write</code><code class="p">(</code>
        <code class="n">Utf8JsonWriter</code> <code class="n">writer</code><code class="p">,</code>
        <code class="n">PurchaseOrderStatus</code> <code class="k">value</code><code class="p">,</code>
        <code class="n">JsonSerializerOptions</code> <code class="n">options</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">writer</code><code class="p">.</code><code class="n">WriteStringValue</code><code class="p">(</code><code class="k">value</code><code class="p">.</code><code class="n">ToString</code><code class="p">());</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>This is a custom JSON naming policy:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">SnakeCaseNamingPolicy</code> <code class="p">:</code> <code class="n">JsonNamingPolicy</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">override</code> <code class="kt">string</code> <code class="nf">ConvertName</code><code class="p">(</code><code class="kt">string</code> <code class="n">name</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="kt">var</code> <code class="n">targetChars</code> <code class="p">=</code> <code class="k">new</code> <code class="n">List</code><code class="p">&lt;</code><code class="kt">char</code><code class="p">&gt;();</code>
        <code class="kt">char</code><code class="p">[]</code> <code class="n">sourceChars</code> <code class="p">=</code> <code class="n">name</code><code class="p">.</code><code class="n">ToCharArray</code><code class="p">();</code>

        <code class="kt">char</code> <code class="n">first</code> <code class="p">=</code> <code class="n">sourceChars</code><code class="p">[</code><code class="m">0</code><code class="p">];</code>
        <code class="k">if</code> <code class="p">(</code><code class="kt">char</code><code class="p">.</code><code class="n">IsUpper</code><code class="p">(</code><code class="n">first</code><code class="p">))</code>
            <code class="n">targetChars</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code><code class="kt">char</code><code class="p">.</code><code class="n">ToLower</code><code class="p">(</code><code class="n">first</code><code class="p">));</code>
        <code class="k">else</code>
            <code class="n">targetChars</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code><code class="n">first</code><code class="p">);</code>

        <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code> <code class="p">=</code> <code class="m">1</code><code class="p">;</code> <code class="n">i</code> <code class="p">&lt;</code> <code class="n">sourceChars</code><code class="p">.</code><code class="n">Length</code><code class="p">;</code> <code class="n">i</code><code class="p">++)</code>
        <code class="p">{</code>
            <code class="kt">char</code> <code class="n">ch</code> <code class="p">=</code> <code class="n">sourceChars</code><code class="p">[</code><code class="n">i</code><code class="p">];</code>

            <code class="k">if</code> <code class="p">(</code><code class="kt">char</code><code class="p">.</code><code class="n">IsUpper</code><code class="p">(</code><code class="n">ch</code><code class="p">))</code>
            <code class="p">{</code>
                <code class="n">targetChars</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code><code class="sc">'_'</code><code class="p">);</code>
                <code class="n">targetChars</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code><code class="kt">char</code><code class="p">.</code><code class="n">ToLower</code><code class="p">(</code><code class="n">ch</code><code class="p">));</code>
            <code class="p">}</code>
            <code class="k">else</code>
            <code class="p">{</code>
                <code class="n">targetChars</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code><code class="n">ch</code><code class="p">);</code>
            <code class="p">}</code>
        <code class="p">}</code>

        <code class="k">return</code> <code class="k">new</code> <code class="nf">string</code><code class="p">(</code><code class="n">targetChars</code><code class="p">.</code><code class="n">ToArray</code><code class="p">());</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>This class simulates a request, returning JSON formatted data:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">PurchaseOrderService</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="nf">Get</code><code class="p">(</code><code class="kt">int</code> <code class="n">poID</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="c1">// get HTTP request</code>

        <code class="k">return</code> <code class="s">@"{</code>
<code class="s">""company_name"": ""Acme, Inc."",</code>
<code class="s">""address"": ""123 4th St."",</code>
<code class="s">""phone"": ""555-835-7609"",</code>
<code class="s">""additional_info"": {</code>
<code class="s">    ""terms"": ""Net 30"",</code>
<code class="s">    ""poc"": ""J. Smith"",</code>
<code class="s">},</code>
<code class="s">""status"": ""Processing"",</code>
<code class="s">""items"": [</code>
<code class="s">    {</code>
<code class="s">        ""serial_number"": ""123"",</code>
<code class="s">        ""description"": ""Widget"",</code>
<code class="s">        ""quantity"": 5,</code>
<code class="s">        ""price"": 13.95</code>
<code class="s">    }</code>
<code class="s">]</code>
<code class="s">}"</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p class="pagebreak-before less_space">The <code>Main</code> method shows how to use custom converters, options, and policies:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">()</code>
<code class="p">{</code>
    <code class="kt">string</code> <code class="n">poJson</code> <code class="p">=</code>
        <code class="k">new</code> <code class="nf">PurchaseOrderService</code><code class="p">()</code>
            <code class="p">.</code><code class="n">Get</code><code class="p">(</code><code class="n">poID</code><code class="p">:</code> <code class="m">123</code><code class="p">);</code>

    <code class="kt">var</code> <code class="n">jsonOptions</code> <code class="p">=</code> <code class="k">new</code> <code class="n">JsonSerializerOptions</code>
    <code class="p">{</code>
        <code class="n">AllowTrailingCommas</code> <code class="p">=</code> <code class="k">true</code><code class="p">,</code>
        <code class="n">Converters</code> <code class="p">=</code>
        <code class="p">{</code>
            <code class="k">new</code> <code class="nf">PurchaseOrderStatusConverter</code><code class="p">()</code>
        <code class="p">},</code>
        <code class="n">PropertyNameCaseInsensitive</code> <code class="p">=</code> <code class="k">true</code><code class="p">,</code>
        <code class="n">PropertyNamingPolicy</code> <code class="p">=</code> <code class="k">new</code> <code class="n">SnakeCaseNamingPolicy</code><code class="p">(),</code>
        <code class="n">WriteIndented</code> <code class="p">=</code> <code class="k">true</code>
    <code class="p">};</code>

    <code class="n">PurchaseOrder</code> <code class="n">po</code> <code class="p">=</code>
        <code class="n">JsonSerializer</code>
        <code class="p">.</code><code class="n">Deserialize</code><code class="p">&lt;</code><code class="n">PurchaseOrder</code><code class="p">&gt;(</code><code class="n">poJson</code><code class="p">,</code> <code class="n">jsonOptions</code><code class="p">);</code>

    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"{po.CompanyName}"</code><code class="p">);</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"{po.AdditionalInfo["</code><code class="n">terms</code><code class="s">"]}"</code><code class="p">);</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"{po.Items[0].Description}"</code><code class="p">);</code>

    <code class="kt">string</code> <code class="n">poJson2</code> <code class="p">=</code> <code class="n">JsonSerializer</code><code class="p">.</code><code class="n">Serialize</code><code class="p">(</code><code class="n">po</code><code class="p">,</code> <code class="n">jsonOptions</code><code class="p">);</code>

    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">poJson2</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>And here’s the output:</p>

<pre data-type="programlisting" data-code-language="text">Acme, Inc.
Net 30
Widget
{
  "company_name": "Acme, Inc.",
  "address": "123 4th St.",
  "phone": "555-835-7609",
  "status": "Processing",
  "additional_info": {
    "terms": "Net 30",
    "poc": "J. Smith"
  },
  "items": [
    {
      "serial_number": "123",
      "description": "Widget",
      "quantity": 5,
      "price": 13.95
    }
  ]
}</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678770121120">
<h2>Discussion</h2>

<p><code>JsonSerializer</code> has a built-in converter for producing camel case property names, via <code>JsonInitializerOptions</code>, like this:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="kt">var</code> <code class="n">serializeOptions</code> <code class="p">=</code> <code class="k">new</code> <code class="n">JsonSerializerOptions</code>
<code class="p">{</code>
    <code class="n">PropertyNamingPolicy</code> <code class="p">=</code> <code class="n">JsonNamingPolicy</code><code class="p">.</code><code class="n">CamelCase</code>
<code class="p">};</code></pre>

<p>That handles a lot of scenarios, but what if a third-party API didn’t use Pascal case or camel case property names? This solution includes support for property names that are snake case, where words are divided by an underscore. For instance, <code>SnakeCase</code> becomes <code>snake_case</code>. In addition to a new naming policy, the solution also includes other customizations, including <code>enum</code> support.</p>

<p>Notice that <code>PurchaseOrder</code> doesn’t decorate any properties with <code>JsonPropertyName</code>. Instead, we use a custom naming policy, defined in the <code>SnakeCaseNamingPolicy</code> class, which derives from <code>JsonNamingPolicy</code>. The algorithm in <code>ConvertName</code> assumes that it has received a Pascal case property name. It iterates through characters, looking for an uppercase character. When encountering an uppercase character it appends an underscore, <code>_</code>, lowercases the letter, and appends the lowercase of the letter into the results. Otherwise, it appends the character, which is already lowercase.</p>

<p>The <code>Main</code> method instantiates a <code>JsonSerializerOptions</code>, setting <code>PropertyNaming​Po⁠licy</code> to an instance of <code>SnakeCaseNamingPolicy</code>. This applies the naming policy to all property names, producing snake case property names.</p>
<div data-type="tip"><h6>Tip</h6>
<p>As with many situations, you might encounter an exception to the rule, where a JSON property doesn’t conform to snake case rules. In that situation, use a <code>JsonPropertyName</code> attribute, as described in <a data-type="xref" href="#producing_json">Recipe 7.4</a>, to that property, which overrides the naming policy.</p>
</div>

<p>You might have noticed that <code>JsonSerializerOptions</code>, in <code>Main</code>, has other customizations. The <code>AllowTrailingCommas</code> is interesting because sometimes you receive JSON data containing a list, where the last item in the list has a trailing comma. This breaks deserialization, and setting <code>AllowTrailingCommas</code> to <code>true</code> ignores the trailing comma.</p>

<p><code>PropertyNameCaseInsensitive</code> is an alternative that doesn’t consider the property name format. It allows lowercase property names to match their uppercase equivalent when deserializing. It’s useful when the incoming JSON property names might not be consistent in casing.</p>

<p>By default, <code>JsonSerializer</code> produces a single-line JSON document. Setting <code>Write​In⁠dented</code> formats the text for readability, as shown in the output.</p>

<p>One of the properties, <code>Converters</code>, is a collection of types that do custom conversions on properties. The <code>PurchaseOrderStatusConverter</code>, which derives from <code>JsonConverter&lt;T&gt;</code>, allows deserialization of the <code>Status</code> property to the <code>PurchaseOrderStatus</code> enum. There are two ways to apply this: in <code>JsonSerialization</code> options or via attribute. Adding a converter to the <code>JsonSerializationOptions</code> <code>Converter</code> collection applies the conversion for all <code>PurchaseOrderStatus</code> property types. Also, the <span class="keep-together"><code>PurchaseOrder</code></span> class decorates the <code>Status</code> property with a <code>JsonConverter</code> attribute. I added both methods in the solution so you could see how each of them work. Adding to the <code>Converters</code> collection is sufficient. However, if you wanted to apply a different converter to a specific property or needed different converters for different properties, then use the <code>JsonConverter</code> attribute, because it has precedence over the <span class="keep-together"><code>Converters</code></span> collection.</p>

<p>The <code>Main</code> method shows how to use the same <code>JsonSerializationOptions</code> for both deserialization and serialization.<a data-type="indexterm" data-startref="ix_ch07-asciidoc17" id="idm45678769302400"/><a data-type="indexterm" data-startref="ix_ch07-asciidoc16" id="idm45678769301728"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45678769383184">
<h2>See Also</h2>

<p><a data-type="xref" data-xrefstyle="rec-num-title" href="#producing_json">Recipe 7.4, “Producing JSON”</a></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.6 Working with JSON Data"><div class="sect1" id="working_with_json_data">
<h1>7.6 Working with JSON Data</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678769297104">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="JSON" data-secondary="working with JSON data" id="ix_ch07-asciidoc18"/><a data-type="indexterm" data-primary="manipulating data" data-secondary="working with JSON data" id="ix_ch07-asciidoc19"/>You received JSON data that doesn’t cleanly deserialize into an object.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678769293024">
<h2>Solution</h2>

<p>Here’s what a <code>PurchaseOrder</code> looks like:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">enum</code> <code class="n">PurchaseOrderStatus</code>
<code class="p">{</code>
    <code class="n">Received</code><code class="p">,</code>
    <code class="n">Processing</code><code class="p">,</code>
    <code class="n">Fulfilled</code>
<code class="p">}</code>

<code class="k">public</code> <code class="k">class</code> <code class="nc">PurchaseItem</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">SerialNumber</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="kt">string</code> <code class="n">Description</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="kt">double</code> <code class="n">Quantity</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="kt">decimal</code> <code class="n">Price</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code>

<code class="k">public</code> <code class="k">class</code> <code class="nc">PurchaseOrder</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">CompanyName</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Address</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Phone</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Terms</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">POC</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="n">PurchaseOrderStatus</code> <code class="n">Status</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="kt">string</code><code class="p">&gt;</code> <code class="n">AdditionalInfo</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">PurchaseItem</code><code class="p">&gt;</code> <code class="n">Items</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code></pre>

<p>This class simulates a request that returns JSON data:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">PurchaseOrderService</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="nf">Get</code><code class="p">(</code><code class="kt">int</code> <code class="n">poID</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="c1">// get HTTP request</code>

        <code class="k">return</code> <code class="s">@"{</code>
<code class="s">""company_name"": ""Acme, Inc."",</code>
<code class="s">""address"": ""123 4th St."",</code>
<code class="s">""phone"": ""555-835-7609"",</code>
<code class="s">""additional_info"": {</code>
<code class="s">    ""terms"": ""Net 30"",</code>
<code class="s">    ""poc"": ""J. Smith""</code>
<code class="s">},</code>
<code class="s">""status"": ""Processing"",</code>
<code class="s">""items"": [</code>
<code class="s">    {</code>
<code class="s">        ""serial_number"": ""123"",</code>
<code class="s">        ""description"": ""Widget"",</code>
<code class="s">        ""quantity"": 5,</code>
<code class="s">        ""price"": 13.95</code>
<code class="s">    }</code>
<code class="s">]</code>
<code class="s">}"</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p class="pagebreak-before less_space">Here’s a class that supports custom deserialization:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">static</code> <code class="k">class</code> <code class="nc">JsonConversionExtensions</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">static</code> <code class="kt">bool</code> <code class="nf">IsNull</code><code class="p">(</code><code class="k">this</code> <code class="n">JsonElement</code> <code class="n">json</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">return</code>
            <code class="n">json</code><code class="p">.</code><code class="n">ValueKind</code> <code class="p">==</code> <code class="n">JsonValueKind</code><code class="p">.</code><code class="n">Undefined</code> <code class="p">||</code>
            <code class="n">json</code><code class="p">.</code><code class="n">ValueKind</code> <code class="p">==</code> <code class="n">JsonValueKind</code><code class="p">.</code><code class="n">Null</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">static</code> <code class="kt">string</code> <code class="nf">GetString</code><code class="p">(</code>
        <code class="k">this</code> <code class="n">JsonElement</code> <code class="n">json</code><code class="p">,</code>
        <code class="kt">string</code> <code class="n">propertyName</code><code class="p">,</code>
        <code class="kt">string</code> <code class="n">defaultValue</code> <code class="p">=</code> <code class="k">default</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">if</code> <code class="p">(!</code><code class="n">json</code><code class="p">.</code><code class="n">IsNull</code><code class="p">()</code> <code class="p">&amp;&amp;</code>
            <code class="n">json</code><code class="p">.</code><code class="n">TryGetProperty</code><code class="p">(</code><code class="n">propertyName</code><code class="p">,</code> <code class="k">out</code> <code class="n">JsonElement</code> <code class="n">element</code><code class="p">))</code>
            <code class="k">return</code> <code class="n">element</code><code class="p">.</code><code class="n">GetString</code><code class="p">()</code> <code class="p">??</code> <code class="n">defaultValue</code><code class="p">;</code>

        <code class="k">return</code> <code class="n">defaultValue</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">static</code> <code class="kt">int</code> <code class="nf">GetInt</code><code class="p">(</code>
        <code class="k">this</code> <code class="n">JsonElement</code> <code class="n">json</code><code class="p">,</code>
        <code class="kt">string</code> <code class="n">propertyName</code><code class="p">,</code>
        <code class="kt">int</code> <code class="n">defaultValue</code> <code class="p">=</code> <code class="k">default</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">if</code> <code class="p">(!</code><code class="n">json</code><code class="p">.</code><code class="n">IsNull</code><code class="p">()</code> <code class="p">&amp;&amp;</code>
            <code class="n">json</code><code class="p">.</code><code class="n">TryGetProperty</code><code class="p">(</code><code class="n">propertyName</code><code class="p">,</code> <code class="k">out</code> <code class="n">JsonElement</code> <code class="n">element</code><code class="p">)</code> <code class="p">&amp;&amp;</code>
            <code class="p">!</code><code class="n">element</code><code class="p">.</code><code class="n">IsNull</code><code class="p">()</code> <code class="p">&amp;&amp;</code>
            <code class="n">element</code><code class="p">.</code><code class="n">TryGetInt32</code><code class="p">(</code><code class="k">out</code> <code class="kt">int</code> <code class="k">value</code><code class="p">))</code>
            <code class="k">return</code> <code class="k">value</code><code class="p">;</code>

        <code class="k">return</code> <code class="n">defaultValue</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">static</code> <code class="kt">ulong</code> <code class="nf">GetULong</code><code class="p">(</code>
        <code class="k">this</code> <code class="kt">string</code> <code class="n">val</code><code class="p">,</code>
        <code class="kt">ulong</code> <code class="n">defaultValue</code> <code class="p">=</code> <code class="k">default</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="kt">string</code><code class="p">.</code><code class="n">IsNullOrWhiteSpace</code><code class="p">(</code><code class="n">val</code><code class="p">)</code> <code class="p">||</code>
            <code class="p">!</code><code class="kt">ulong</code><code class="p">.</code><code class="n">TryParse</code><code class="p">(</code><code class="n">val</code><code class="p">,</code> <code class="k">out</code> <code class="kt">ulong</code> <code class="n">result</code><code class="p">)</code>
                <code class="p">?</code> <code class="n">defaultValue</code>
                <code class="p">:</code> <code class="n">result</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">static</code> <code class="kt">ulong</code> <code class="nf">GetUlong</code><code class="p">(</code>
        <code class="k">this</code> <code class="n">JsonElement</code> <code class="n">json</code><code class="p">,</code>
        <code class="kt">string</code> <code class="n">propertyName</code><code class="p">,</code>
        <code class="kt">ulong</code> <code class="n">defaultValue</code> <code class="p">=</code> <code class="k">default</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">if</code> <code class="p">(!</code><code class="n">json</code><code class="p">.</code><code class="n">IsNull</code><code class="p">()</code> <code class="p">&amp;&amp;</code>
            <code class="n">json</code><code class="p">.</code><code class="n">TryGetProperty</code><code class="p">(</code><code class="n">propertyName</code><code class="p">,</code> <code class="k">out</code> <code class="n">JsonElement</code> <code class="n">element</code><code class="p">)</code> <code class="p">&amp;&amp;</code>
            <code class="p">!</code><code class="n">element</code><code class="p">.</code><code class="n">IsNull</code><code class="p">()</code> <code class="p">&amp;&amp;</code>
            <code class="n">element</code><code class="p">.</code><code class="n">TryGetUInt64</code><code class="p">(</code><code class="k">out</code> <code class="kt">ulong</code> <code class="k">value</code><code class="p">))</code>
            <code class="k">return</code> <code class="k">value</code><code class="p">;</code>

        <code class="k">return</code> <code class="n">defaultValue</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">static</code> <code class="kt">long</code> <code class="nf">GetLong</code><code class="p">(</code>
        <code class="k">this</code> <code class="n">JsonElement</code> <code class="n">json</code><code class="p">,</code>
        <code class="kt">string</code> <code class="n">propertyName</code><code class="p">,</code>
        <code class="kt">long</code> <code class="n">defaultValue</code> <code class="p">=</code> <code class="k">default</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">if</code> <code class="p">(!</code><code class="n">json</code><code class="p">.</code><code class="n">IsNull</code><code class="p">()</code> <code class="p">&amp;&amp;</code>
            <code class="n">json</code><code class="p">.</code><code class="n">TryGetProperty</code><code class="p">(</code><code class="n">propertyName</code><code class="p">,</code> <code class="k">out</code> <code class="n">JsonElement</code> <code class="n">element</code><code class="p">)</code> <code class="p">&amp;&amp;</code>
            <code class="p">!</code><code class="n">element</code><code class="p">.</code><code class="n">IsNull</code><code class="p">()</code> <code class="p">&amp;&amp;</code>
            <code class="n">element</code><code class="p">.</code><code class="n">TryGetInt64</code><code class="p">(</code><code class="k">out</code> <code class="kt">long</code> <code class="k">value</code><code class="p">))</code>
            <code class="k">return</code> <code class="k">value</code><code class="p">;</code>

        <code class="k">return</code> <code class="n">defaultValue</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">static</code> <code class="kt">bool</code> <code class="nf">GetBool</code><code class="p">(</code>
        <code class="k">this</code> <code class="n">JsonElement</code> <code class="n">json</code><code class="p">,</code>
        <code class="kt">string</code> <code class="n">propertyName</code><code class="p">,</code>
        <code class="kt">bool</code> <code class="n">defaultValue</code> <code class="p">=</code> <code class="k">default</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">if</code> <code class="p">(!</code><code class="n">json</code><code class="p">.</code><code class="n">IsNull</code><code class="p">()</code> <code class="p">&amp;&amp;</code>
            <code class="n">json</code><code class="p">.</code><code class="n">TryGetProperty</code><code class="p">(</code><code class="n">propertyName</code><code class="p">,</code> <code class="k">out</code> <code class="n">JsonElement</code> <code class="n">element</code><code class="p">)</code> <code class="p">&amp;&amp;</code>
            <code class="p">!</code><code class="n">element</code><code class="p">.</code><code class="n">IsNull</code><code class="p">())</code>
            <code class="k">return</code> <code class="n">element</code><code class="p">.</code><code class="n">GetBoolean</code><code class="p">();</code>

        <code class="k">return</code> <code class="n">defaultValue</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">static</code> <code class="kt">double</code> <code class="nf">GetDouble</code><code class="p">(</code>
        <code class="k">this</code> <code class="kt">string</code> <code class="n">val</code><code class="p">,</code>
        <code class="kt">double</code> <code class="n">defaultValue</code> <code class="p">=</code> <code class="k">default</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="kt">string</code><code class="p">.</code><code class="n">IsNullOrWhiteSpace</code><code class="p">(</code><code class="n">val</code><code class="p">)</code> <code class="p">||</code>
            <code class="p">!</code><code class="kt">double</code><code class="p">.</code><code class="n">TryParse</code><code class="p">(</code><code class="n">val</code><code class="p">,</code> <code class="k">out</code> <code class="kt">double</code> <code class="n">result</code><code class="p">)</code>
                <code class="p">?</code> <code class="n">defaultValue</code>
                <code class="p">:</code> <code class="n">result</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">static</code> <code class="kt">double</code> <code class="nf">GetDouble</code><code class="p">(</code>
        <code class="k">this</code> <code class="n">JsonElement</code> <code class="n">json</code><code class="p">,</code>
        <code class="kt">string</code> <code class="n">propertyName</code><code class="p">,</code>
        <code class="kt">double</code> <code class="n">defaultValue</code> <code class="p">=</code> <code class="k">default</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">if</code> <code class="p">(!</code><code class="n">json</code><code class="p">.</code><code class="n">IsNull</code><code class="p">()</code> <code class="p">&amp;&amp;</code>
            <code class="n">json</code><code class="p">.</code><code class="n">TryGetProperty</code><code class="p">(</code><code class="n">propertyName</code><code class="p">,</code> <code class="k">out</code> <code class="n">JsonElement</code> <code class="n">element</code><code class="p">)</code> <code class="p">&amp;&amp;</code>
            <code class="p">!</code><code class="n">element</code><code class="p">.</code><code class="n">IsNull</code><code class="p">()</code> <code class="p">&amp;&amp;</code>
            <code class="n">element</code><code class="p">.</code><code class="n">TryGetDouble</code><code class="p">(</code><code class="k">out</code> <code class="kt">double</code> <code class="k">value</code><code class="p">))</code>
            <code class="k">return</code> <code class="k">value</code><code class="p">;</code>

        <code class="k">return</code> <code class="n">defaultValue</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">static</code> <code class="kt">decimal</code> <code class="nf">GetDecimal</code><code class="p">(</code>
        <code class="k">this</code> <code class="n">JsonElement</code> <code class="n">json</code><code class="p">,</code>
        <code class="kt">string</code> <code class="n">propertyName</code><code class="p">,</code>
        <code class="kt">decimal</code> <code class="n">defaultValue</code> <code class="p">=</code> <code class="k">default</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">if</code> <code class="p">(!</code><code class="n">json</code><code class="p">.</code><code class="n">IsNull</code><code class="p">()</code> <code class="p">&amp;&amp;</code>
            <code class="n">json</code><code class="p">.</code><code class="n">TryGetProperty</code><code class="p">(</code><code class="n">propertyName</code><code class="p">,</code> <code class="k">out</code> <code class="n">JsonElement</code> <code class="n">element</code><code class="p">)</code> <code class="p">&amp;&amp;</code>
            <code class="p">!</code><code class="n">element</code><code class="p">.</code><code class="n">IsNull</code><code class="p">()</code> <code class="p">&amp;&amp;</code>
            <code class="n">element</code><code class="p">.</code><code class="n">TryGetDecimal</code><code class="p">(</code><code class="k">out</code> <code class="kt">decimal</code> <code class="k">value</code><code class="p">))</code>
            <code class="k">return</code> <code class="k">value</code><code class="p">;</code>

        <code class="k">return</code> <code class="n">defaultValue</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">static</code> <code class="n">TEnum</code> <code class="n">GetEnum</code><code class="p">&lt;</code><code class="n">TEnum</code><code class="p">&gt;</code>
        <code class="p">(</code><code class="k">this</code> <code class="n">JsonElement</code> <code class="n">json</code><code class="p">,</code>
        <code class="kt">string</code> <code class="n">propertyName</code><code class="p">,</code>
        <code class="n">TEnum</code> <code class="n">defaultValue</code> <code class="p">=</code> <code class="k">default</code><code class="p">)</code>
        <code class="k">where</code> <code class="n">TEnum</code><code class="p">:</code> <code class="k">struct</code>
    <code class="p">{</code>
        <code class="k">if</code> <code class="p">(!</code><code class="n">json</code><code class="p">.</code><code class="n">IsNull</code><code class="p">()</code> <code class="p">&amp;&amp;</code>
            <code class="n">json</code><code class="p">.</code><code class="n">TryGetProperty</code><code class="p">(</code><code class="n">propertyName</code><code class="p">,</code> <code class="k">out</code> <code class="n">JsonElement</code> <code class="n">element</code><code class="p">)</code> <code class="p">&amp;&amp;</code>
            <code class="p">!</code><code class="n">element</code><code class="p">.</code><code class="n">IsNull</code><code class="p">())</code>
        <code class="p">{</code>
            <code class="kt">string</code> <code class="n">enumString</code> <code class="p">=</code> <code class="n">element</code><code class="p">.</code><code class="n">GetString</code><code class="p">();</code>

            <code class="k">if</code> <code class="p">(</code><code class="n">enumString</code> <code class="p">!=</code> <code class="k">null</code> <code class="p">&amp;&amp;</code>
                <code class="n">Enum</code><code class="p">.</code><code class="n">TryParse</code><code class="p">(</code><code class="n">enumString</code><code class="p">,</code> <code class="k">out</code> <code class="n">TEnum</code> <code class="n">num</code><code class="p">))</code>
                <code class="k">return</code> <code class="n">num</code><code class="p">;</code>
        <code class="p">}</code>

        <code class="k">return</code> <code class="n">defaultValue</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>The <code>Main</code> method shows how to perform custom deserialization:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">()</code>
<code class="p">{</code>
    <code class="kt">string</code> <code class="n">poJson</code> <code class="p">=</code>
        <code class="k">new</code> <code class="nf">PurchaseOrderService</code><code class="p">()</code>
            <code class="p">.</code><code class="n">Get</code><code class="p">(</code><code class="n">poID</code><code class="p">:</code> <code class="m">123</code><code class="p">);</code>

    <code class="n">JsonElement</code> <code class="n">elm</code> <code class="p">=</code> <code class="n">JsonDocument</code><code class="p">.</code><code class="n">Parse</code><code class="p">(</code><code class="n">poJson</code><code class="p">).</code><code class="n">RootElement</code><code class="p">;</code>

    <code class="n">JsonElement</code> <code class="n">additional</code> <code class="p">=</code> <code class="n">elm</code><code class="p">.</code><code class="n">GetProperty</code><code class="p">(</code><code class="s">"additional_info"</code><code class="p">);</code>
    <code class="n">JsonElement</code> <code class="n">items</code> <code class="p">=</code> <code class="n">elm</code><code class="p">.</code><code class="n">GetProperty</code><code class="p">(</code><code class="s">"items"</code><code class="p">);</code>

    <code class="k">if</code> <code class="p">(</code><code class="n">additional</code><code class="p">.</code><code class="n">IsNull</code><code class="p">()</code> <code class="p">||</code> <code class="n">items</code><code class="p">.</code><code class="n">IsNull</code><code class="p">())</code>
        <code class="k">throw</code> <code class="k">new</code> <code class="nf">ArgumentException</code><code class="p">(</code><code class="s">"incomplete PO"</code><code class="p">);</code>

    <code class="kt">var</code> <code class="n">po</code> <code class="p">=</code> <code class="k">new</code> <code class="n">PurchaseOrder</code>
    <code class="p">{</code>
        <code class="n">Address</code> <code class="p">=</code> <code class="n">elm</code><code class="p">.</code><code class="n">GetString</code><code class="p">(</code><code class="s">"address"</code><code class="p">,</code> <code class="s">"none"</code><code class="p">),</code>
        <code class="n">CompanyName</code> <code class="p">=</code> <code class="n">elm</code><code class="p">.</code><code class="n">GetString</code><code class="p">(</code><code class="s">"company_name"</code><code class="p">,</code> <code class="kt">string</code><code class="p">.</code><code class="n">Empty</code><code class="p">),</code>
        <code class="n">Phone</code> <code class="p">=</code> <code class="n">elm</code><code class="p">.</code><code class="n">GetString</code><code class="p">(</code><code class="s">"phone"</code><code class="p">,</code> <code class="kt">string</code><code class="p">.</code><code class="n">Empty</code><code class="p">),</code>
        <code class="n">Status</code> <code class="p">=</code> <code class="n">elm</code><code class="p">.</code><code class="n">GetEnum</code><code class="p">(</code><code class="s">"status"</code><code class="p">,</code> <code class="n">PurchaseOrderStatus</code><code class="p">.</code><code class="n">Received</code><code class="p">),</code>
        <code class="n">Terms</code> <code class="p">=</code> <code class="n">additional</code><code class="p">.</code><code class="n">GetString</code><code class="p">(</code><code class="s">"terms"</code><code class="p">,</code> <code class="kt">string</code><code class="p">.</code><code class="n">Empty</code><code class="p">),</code>
        <code class="n">POC</code> <code class="p">=</code> <code class="n">additional</code><code class="p">.</code><code class="n">GetString</code><code class="p">(</code><code class="s">"poc"</code><code class="p">,</code> <code class="kt">string</code><code class="p">.</code><code class="n">Empty</code><code class="p">),</code>
        <code class="n">AdditionalInfo</code> <code class="p">=</code>
            <code class="p">(</code><code class="k">from</code> <code class="n">jElem</code> <code class="k">in</code> <code class="n">additional</code><code class="p">.</code><code class="n">EnumerateObject</code><code class="p">()</code>
             <code class="k">select</code> <code class="n">jElem</code><code class="p">)</code>
            <code class="p">.</code><code class="n">ToDictionary</code><code class="p">(</code>
                <code class="n">key</code> <code class="p">=&gt;</code> <code class="n">key</code><code class="p">.</code><code class="n">Name</code><code class="p">,</code>
                <code class="n">val</code> <code class="p">=&gt;</code> <code class="n">val</code><code class="p">.</code><code class="n">Value</code><code class="p">.</code><code class="n">GetString</code><code class="p">()),</code>
        <code class="n">Items</code> <code class="p">=</code>
            <code class="p">(</code><code class="k">from</code> <code class="n">jElem</code> <code class="k">in</code> <code class="n">items</code><code class="p">.</code><code class="n">EnumerateArray</code><code class="p">()</code>
             <code class="k">select</code> <code class="k">new</code> <code class="n">PurchaseItem</code>
             <code class="p">{</code>
                 <code class="n">Description</code> <code class="p">=</code> <code class="n">jElem</code><code class="p">.</code><code class="n">GetString</code><code class="p">(</code><code class="s">"description"</code><code class="p">),</code>
                 <code class="n">Price</code> <code class="p">=</code> <code class="n">jElem</code><code class="p">.</code><code class="n">GetDecimal</code><code class="p">(</code><code class="s">"price"</code><code class="p">),</code>
                 <code class="n">Quantity</code> <code class="p">=</code> <code class="n">jElem</code><code class="p">.</code><code class="n">GetDouble</code><code class="p">(</code><code class="s">"quantity"</code><code class="p">),</code>
                 <code class="n">SerialNumber</code> <code class="p">=</code> <code class="n">jElem</code><code class="p">.</code><code class="n">GetString</code><code class="p">(</code><code class="s">"serial_number"</code><code class="p">)</code>
             <code class="p">})</code>
            <code class="p">.</code><code class="n">ToList</code><code class="p">()</code>
    <code class="p">};</code>

    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"{po.CompanyName}"</code><code class="p">);</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"{po.Terms}"</code><code class="p">);</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"{po.AdditionalInfo["</code><code class="n">terms</code><code class="s">"]}"</code><code class="p">);</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"{po.Items[0].Description}"</code><code class="p">);</code>
<code class="p">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678768203008">
<h2>Discussion</h2>

<p>While using the <code>JsonSerializer</code> is the preferred choice in serialization and deserialization, sometimes you don’t get a clean one-to-one structural match between JSON and C# objects. For example, you might need to get data from different sources with different formats and have a single C# object to populate. Other times, you might have a hierarchical JSON document and want to flatten it into your own object. Another common situation is to have objects that already work with one version, and a new version of the API changes structure. In a way, these are multiple viewpoints of the same problem, which you can solve by doing custom <span class="keep-together">deserialization</span>.</p>

<p>The two types from the <code>System.Text.Json</code> namespace for custom deserialization are <code>JsonDocument</code> and <code>JsonElement</code>. The <code>Main</code> method shows how to use <code>JsonDocument</code> to parse JSON input and obtain a <code>JsonElement</code> via the <code>RootElement</code> property. After that, we just work with <code>JsonElement</code> members.</p>

<p><code>JsonElement</code> has several members, including <code>GetString</code> and <code>GetInt64</code>, for doing conversions. The problem with relying on those alone is that data is often not clean. Even if you own the consumer and producer ends of the application, obtaining perfectly clean data might be illusive. To solve this problem, I created the <code>JsonConversion​)Ex⁠tensions</code> class.</p>

<p>Conceptually, <code>JsonConversionExtensions</code> wraps a lot of boilerplate code that you need to call to ensure the data you’re reading is what you expect. It also has an optional default value concept.</p>

<p>The first trick to work around is that a <code>null</code> value in <code>JsonElement</code> isn’t represented as <code>null</code>. The <code>IsNull</code> method examines the <code>ValueKind</code> property, checking if either the <code>Undefined</code> or <code>Null</code> properties are true. This is an important method used by other conversion methods.</p>

<p>Skimming through the rest of the methods, you’ll see a familiar pattern. Each of them checks for <code>IsNull</code> on the element and then uses one or more combinations of <code>TryGetXxx</code> and <code>IsNull</code> calls to get the value. This is safe and avoids exceptions in case the value is <code>null</code> or is of the wrong type. That’s right, some APIs document values of one type and return another type at runtime, set numbers to <code>null</code>, and omit properties.</p>

<p>Each method has a default parameter. If the code isn’t able to extract a real value, it uses <code>defaultValue</code>. The <code>defaultValue</code> parameter is optional and reverts to the C# <code>default</code> of the return type.</p>

<p>The <code>Main</code> method shows how to construct an object with <code>JsonElement</code> and the <code>JsonConversionExtensions</code> class. You can see how the code populates each property with a <code>GetXxx</code> method.</p>

<p>A couple of useful <code>JsonElement</code> methods are <code>EnumerateObject</code> and <code>EnumerateArray</code>. In previous sections, <code>JsonSerializer</code> deserialized the JSON <code>additional_info</code> object into a C# dictionary. This is how you handle an object with variable information, where you don’t know what the properties of the object are. You might see this for an API that returns multiple errors in a single error JSON response, where each property is a code or description of the error. In the <code>PurchaseOrder</code> example, this represents a place where someone can add miscellaneous information that doesn’t fit into a <span class="keep-together">predesigned</span> property. To read these properties manually, use <code>EnumerateObject</code>. It returns each property/value pair in the object. You can see the LINQ statement that creates a new dictionary by extracting the <code>Key</code> and <code>Value</code> from each <code>JsonProperty</code> that <span class="keep-together"><code>EnumerateObject</code></span> returns.</p>

<p><code>EnumerateArray</code> returns each element of a list. In the solution, we project each <span class="keep-together"><code>JsonElement</code></span> returned from <code>EnumerateArray</code> into a new <code>PurchaseOrderItem</code> instance.</p>

<p>The <code>JsonConversionExtensions</code> is incomplete, because it doesn’t include dates. Since <code>DateTime</code> processing is a special case, I separated it from this example; you can find more information about it in <a data-type="xref" href="#flexible_datetime_reading">Recipe 7.10</a>.<a data-type="indexterm" data-startref="ix_ch07-asciidoc19" id="idm45678767849328"/><a data-type="indexterm" data-startref="ix_ch07-asciidoc18" id="idm45678767848624"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45678768202416">
<h2>See Also</h2>

<p><a data-type="xref" data-xrefstyle="rec-num-title" href="#flexible_datetime_reading">Recipe 7.10, “Flexible DateTime Reading”</a></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.7 Consuming XML"><div class="sect1" id="consuming_xml">
<h1>7.7 Consuming XML</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678767844096">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="manipulating data" data-secondary="consuming XML" id="ix_ch07-asciidoc20"/><a data-type="indexterm" data-primary="XML" data-secondary="consuming" id="ix_ch07-asciidoc21"/><a data-type="indexterm" data-primary="XML" data-secondary="converting XML document to an object" id="ix_ch07-asciidoc22"/>You need to convert an XML document to an object.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678767838672">
<h2>Solution</h2>

<p>Here’s what a <code>PurchaseOrder</code> looks like:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">enum</code> <code class="n">PurchaseOrderStatus</code>
<code class="p">{</code>
    <code class="n">Received</code><code class="p">,</code>
    <code class="n">Processing</code><code class="p">,</code>
    <code class="n">Fulfilled</code>
<code class="p">}</code>

<code class="k">public</code> <code class="k">class</code> <code class="nc">PurchaseItem</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">SerialNumber</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="kt">string</code> <code class="n">Description</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="kt">float</code> <code class="n">Quantity</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="kt">decimal</code> <code class="n">Price</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code>

<code class="k">public</code> <code class="k">class</code> <code class="nc">PurchaseOrder</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">CompanyName</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Address</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Phone</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="n">PurchaseOrderStatus</code> <code class="n">Status</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="kt">string</code><code class="p">&gt;</code> <code class="n">AdditionalInfo</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">PurchaseItem</code><code class="p">&gt;</code> <code class="n">Items</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code></pre>

<p>This method simulates a request that returns XML data:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="kt">string</code> <code class="nf">GetXml</code><code class="p">()</code>
<code class="p">{</code>
    <code class="k">return</code> <code class="s">@"</code>
<code class="s">&lt;PurchaseOrder "&gt;</code>
<code class="s">  &lt;Address&gt;123 4th St.&lt;/Address&gt;</code>
<code class="s">  &lt;CompanyName&gt;Acme, Inc.&lt;/CompanyName&gt;</code>
<code class="s">  &lt;Phone&gt;555-835-7609&lt;/Phone&gt;</code>
<code class="s">  &lt;Status&gt;Received&lt;/Status&gt;</code>
<code class="s">  &lt;AdditionalInfo&gt;</code>
<code class="s">    &lt;Terms&gt;Net 30&lt;/Terms&gt;</code>
<code class="s">    &lt;POC&gt;J. Smith&lt;/POC&gt;</code>
<code class="s">  &lt;/AdditionalInfo&gt;</code>
<code class="s">  &lt;Items&gt;</code>
<code class="s">    &lt;PurchaseItem SerialNumber=""123""&gt;</code>
<code class="s">      &lt;Description&gt;Widget&lt;/Description&gt;</code>
<code class="s">      &lt;Price&gt;13.95&lt;/Price&gt;</code>
<code class="s">      &lt;Quantity&gt;5&lt;/Quantity&gt;</code>
<code class="s">    &lt;/PurchaseItem&gt;</code>
<code class="s">  &lt;/Items&gt;</code>
<code class="s">&lt;/PurchaseOrder&gt;"</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>The <code>Main</code> method shows how to deserialize XML into objects:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">(</code><code class="kt">string</code><code class="p">[]</code> <code class="n">args</code><code class="p">)</code>
<code class="p">{</code>
    <code class="n">XNamespace</code> <code class="n">or</code> <code class="p">=</code> <code class="s">"https://www.oreilly.com"</code><code class="p">;</code>

    <code class="n">XName</code> <code class="n">address</code> <code class="p">=</code> <code class="n">or</code> <code class="p">+</code> <code class="n">nameof</code><code class="p">(</code><code class="n">PurchaseOrder</code><code class="p">.</code><code class="n">Address</code><code class="p">);</code>
    <code class="n">XName</code> <code class="n">company</code> <code class="p">=</code> <code class="n">or</code> <code class="p">+</code> <code class="n">nameof</code><code class="p">(</code><code class="n">PurchaseOrder</code><code class="p">.</code><code class="n">CompanyName</code><code class="p">);</code>
    <code class="n">XName</code> <code class="n">phone</code> <code class="p">=</code> <code class="n">or</code> <code class="p">+</code> <code class="n">nameof</code><code class="p">(</code><code class="n">PurchaseOrder</code><code class="p">.</code><code class="n">Phone</code><code class="p">);</code>
    <code class="n">XName</code> <code class="n">status</code> <code class="p">=</code> <code class="n">or</code> <code class="p">+</code> <code class="n">nameof</code><code class="p">(</code><code class="n">PurchaseOrder</code><code class="p">.</code><code class="n">Status</code><code class="p">);</code>
    <code class="n">XName</code> <code class="n">info</code> <code class="p">=</code> <code class="n">or</code> <code class="p">+</code> <code class="n">nameof</code><code class="p">(</code><code class="n">PurchaseOrder</code><code class="p">.</code><code class="n">AdditionalInfo</code><code class="p">);</code>
    <code class="n">XName</code> <code class="n">poItems</code> <code class="p">=</code> <code class="n">or</code> <code class="p">+</code> <code class="n">nameof</code><code class="p">(</code><code class="n">PurchaseOrder</code><code class="p">.</code><code class="n">Items</code><code class="p">);</code>
    <code class="n">XName</code> <code class="n">purchaseItem</code> <code class="p">=</code> <code class="n">or</code> <code class="p">+</code> <code class="n">nameof</code><code class="p">(</code><code class="n">PurchaseItem</code><code class="p">);</code>
    <code class="n">XName</code> <code class="n">description</code> <code class="p">=</code> <code class="n">or</code> <code class="p">+</code> <code class="n">nameof</code><code class="p">(</code><code class="n">PurchaseItem</code><code class="p">.</code><code class="n">Description</code><code class="p">);</code>
    <code class="n">XName</code> <code class="n">price</code> <code class="p">=</code> <code class="n">or</code> <code class="p">+</code> <code class="n">nameof</code><code class="p">(</code><code class="n">PurchaseItem</code><code class="p">.</code><code class="n">Price</code><code class="p">);</code>
    <code class="n">XName</code> <code class="n">quantity</code> <code class="p">=</code> <code class="n">or</code> <code class="p">+</code> <code class="n">nameof</code><code class="p">(</code><code class="n">PurchaseItem</code><code class="p">.</code><code class="n">Quantity</code><code class="p">);</code>
    <code class="n">XName</code> <code class="n">serialNum</code> <code class="p">=</code> <code class="n">nameof</code><code class="p">(</code><code class="n">PurchaseItem</code><code class="p">.</code><code class="n">SerialNumber</code><code class="p">);</code>

    <code class="kt">string</code> <code class="n">poXml</code> <code class="p">=</code> <code class="n">GetXml</code><code class="p">();</code>

    <code class="n">XElement</code> <code class="n">poElmt</code> <code class="p">=</code> <code class="n">XElement</code><code class="p">.</code><code class="n">Parse</code><code class="p">(</code><code class="n">poXml</code><code class="p">);</code>

    <code class="n">PurchaseOrder</code> <code class="n">po</code> <code class="p">=</code>
        <code class="k">new</code> <code class="n">PurchaseOrder</code>
        <code class="p">{</code>
            <code class="n">Address</code> <code class="p">=</code> <code class="p">(</code><code class="kt">string</code><code class="p">)</code><code class="n">poElmt</code><code class="p">.</code><code class="n">Element</code><code class="p">(</code><code class="n">address</code><code class="p">),</code>
            <code class="n">CompanyName</code> <code class="p">=</code> <code class="p">(</code><code class="kt">string</code><code class="p">)</code><code class="n">poElmt</code><code class="p">.</code><code class="n">Element</code><code class="p">(</code><code class="n">company</code><code class="p">),</code>
            <code class="n">Phone</code> <code class="p">=</code> <code class="p">(</code><code class="kt">string</code><code class="p">)</code><code class="n">poElmt</code><code class="p">.</code><code class="n">Element</code><code class="p">(</code><code class="n">phone</code><code class="p">),</code>
            <code class="n">Status</code> <code class="p">=</code>
                <code class="n">Enum</code><code class="p">.</code><code class="n">TryParse</code><code class="p">(</code>
                    <code class="p">(</code><code class="kt">string</code><code class="p">)</code><code class="n">poElmt</code><code class="p">.</code><code class="n">Element</code><code class="p">(</code><code class="n">nameof</code><code class="p">(</code><code class="n">po</code><code class="p">.</code><code class="n">Status</code><code class="p">)),</code>
                    <code class="k">out</code> <code class="n">PurchaseOrderStatus</code> <code class="n">poStatus</code><code class="p">)</code>
                <code class="p">?</code> <code class="n">poStatus</code>
                <code class="p">:</code> <code class="n">PurchaseOrderStatus</code><code class="p">.</code><code class="n">Received</code><code class="p">,</code>
            <code class="n">AdditionalInfo</code> <code class="p">=</code>
                <code class="p">(</code><code class="k">from</code> <code class="n">addInfo</code> <code class="k">in</code> <code class="n">poElmt</code><code class="p">.</code><code class="n">Element</code><code class="p">(</code><code class="n">info</code><code class="p">).</code><code class="n">Descendants</code><code class="p">()</code>
                 <code class="k">select</code> <code class="n">addInfo</code><code class="p">)</code>
                <code class="p">.</code><code class="n">ToDictionary</code><code class="p">(</code>
                    <code class="n">key</code> <code class="p">=&gt;</code> <code class="n">key</code><code class="p">.</code><code class="n">Name</code><code class="p">.</code><code class="n">LocalName</code><code class="p">,</code>
                    <code class="n">val</code> <code class="p">=&gt;</code> <code class="n">val</code><code class="p">.</code><code class="n">Value</code><code class="p">),</code>
            <code class="n">Items</code> <code class="p">=</code>
                <code class="p">(</code><code class="k">from</code> <code class="n">item</code> <code class="k">in</code> <code class="n">poElmt</code>
                                <code class="p">.</code><code class="n">Element</code><code class="p">(</code><code class="n">poItems</code><code class="p">)</code>
                                <code class="p">.</code><code class="n">Descendants</code><code class="p">(</code><code class="n">purchaseItem</code><code class="p">)</code>
                 <code class="k">select</code> <code class="k">new</code> <code class="n">PurchaseItem</code>
                 <code class="p">{</code>
                     <code class="n">Description</code> <code class="p">=</code> <code class="p">(</code><code class="kt">string</code><code class="p">)</code><code class="n">item</code><code class="p">.</code><code class="n">Element</code><code class="p">(</code><code class="n">description</code><code class="p">),</code>
                     <code class="n">Price</code> <code class="p">=</code>
                        <code class="kt">decimal</code><code class="p">.</code><code class="n">TryParse</code><code class="p">(</code>
                            <code class="p">(</code><code class="kt">string</code><code class="p">)</code><code class="n">item</code><code class="p">.</code><code class="n">Element</code><code class="p">(</code><code class="n">price</code><code class="p">),</code>
                            <code class="k">out</code> <code class="kt">decimal</code> <code class="n">itemPrice</code><code class="p">)</code>
                        <code class="p">?</code> <code class="n">itemPrice</code>
                        <code class="p">:</code> <code class="m">0</code><code class="n">m</code><code class="p">,</code>
                     <code class="n">Quantity</code> <code class="p">=</code>
                        <code class="kt">float</code><code class="p">.</code><code class="n">TryParse</code><code class="p">(</code>
                            <code class="p">(</code><code class="kt">string</code><code class="p">)</code><code class="n">item</code><code class="p">.</code><code class="n">Element</code><code class="p">(</code><code class="n">quantity</code><code class="p">),</code>
                            <code class="k">out</code> <code class="kt">float</code> <code class="n">qty</code><code class="p">)</code>
                        <code class="p">?</code> <code class="n">qty</code>
                        <code class="p">:</code> <code class="m">0f</code><code class="p">,</code>
                     <code class="n">SerialNumber</code> <code class="p">=</code> <code class="p">(</code><code class="kt">string</code><code class="p">)</code><code class="n">item</code><code class="p">.</code><code class="n">Attribute</code><code class="p">(</code><code class="n">serialNum</code><code class="p">)</code>
                 <code class="p">})</code>
                <code class="p">.</code><code class="n">ToList</code><code class="p">()</code>
        <code class="p">};</code>

    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"{po.CompanyName}"</code><code class="p">);</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"{po.AdditionalInfo["</code><code class="n">Terms</code><code class="s">"]}"</code><code class="p">);</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"{po.Items[0].Description}"</code><code class="p">);</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"{po.Items[0].SerialNumber}"</code><code class="p">);</code>
<code class="p">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678767565888">
<h2>Discussion</h2>

<p>Before JSON took over as the dominant data format, XML was ubiquitous. When working with things like configuration files, project files, or Extensible Application Markup Language (XAML), it’s clear that XML is still with us. There’s also a fair amount of legacy code, including Windows Communication Foundation (WCF) Web Services, that uses XML extensively. For the time being, knowing how to work with XML is a valuable skill, and LINQ to XML is an excellent tool for that.</p>

<p>The solution shows how to deserialize XML into a <code>PurchaseOrder</code> object. The first thing the <code>Main</code> method does is set up the namespace. Namespaces in XML are common, and the code creates a namespace tag, <code>or</code>. The <code>XNamespace</code> type has a converter that transforms a string into a namespace. <code>XNamespace</code> also overloads the <code>+</code> operator, letting you tag elements with a specific namespace, creating a new <code>XName</code>. The code sets up an <code>XName</code> for each element to make the construction of <code>PurchaseOrder</code> easier to read.</p>

<p>Each element has a namespace, except for <code>serialNum</code>, which is an attribute. You don’t annotate data attributes with namespaces because they’re in the containing element’s namespace. The exception is if you wanted to add a namespace attribute to an element, putting it into a new namespace.</p>

<p>After getting the XML, <code>Main</code> calls <code>XElement.Parse</code> to get a new <code>XElement</code> to work with. <code>XElement</code> has all the axis methods required to move around the document and read anything you need. This example keeps things simple by moving through the document hierarchically with the <code>Attribute</code>, <code>Element</code>, and <code>Descendants</code> axis <span class="keep-together">methods</span>.</p>

<p>The <code>Element</code> method helps read a subelement under the current element. The <code>Descendants</code> method goes one level deeper, accessing the children of a specified element. In the XML returned from <code>GetXml</code>, <code>PurchaseOrder</code> is the root element, represented by <code>poElmt</code>. Looking at the <code>PurchaseOrder</code>, <code>poElmt.Element(address)</code> reads the <code>Address</code> element, a subelement of <code>PurchaseOrder</code>. If you recall, <code>address</code> is a namespace-qualified <code>XName</code>.</p>

<p>Populating the <code>AdditionalInfo</code> and <code>Items</code> properties shows how to use <code>Descendants</code>. We use <code>Element</code> to read the subelement and <code>Descendants</code> to get a list of that element’s children. For <code>AdditionalInfo</code>, <code>Descendants</code> are variable elements and values, and we don’t pass an <code>XName</code> argument. In the case of <code>Items</code>, we need to pass the <code>purchaseItem</code> <code>XName</code> to <code>Descendants</code> to operate on each object.</p>

<p>We use the <code>Attribute</code> method to populate the <code>SerialNumber</code> property of each <span class="keep-together"><code>PurchaseOrderItem</code></span>.</p>

<p>An interesting part of this object construction is the ability to declare the <code>out</code> parameter in <code>TryParse</code> operations. This allows us to code the assignment inline. Prior to this C# feature, we would need to declare the variable outside the object construction, which doesn’t feel natural, especially when populating during a LINQ projection, like the <code>Items</code> property in the solution.<a data-type="indexterm" data-startref="ix_ch07-asciidoc22" id="idm45678767062192"/><a data-type="indexterm" data-startref="ix_ch07-asciidoc21" id="idm45678767061488"/><a data-type="indexterm" data-startref="ix_ch07-asciidoc20" id="idm45678767060816"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45678767060016">
<h2>See Also</h2>

<p><a data-type="xref" data-xrefstyle="rec-num-title" href="#producting_xml">Recipe 7.8, “Producing XML”</a></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.8 Producing XML"><div class="sect1" id="producting_xml">
<h1>7.8 Producing XML</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678767056064">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="manipulating data" data-secondary="producing XML" id="ix_ch07-asciidoc23"/><a data-type="indexterm" data-primary="XML" data-secondary="converting an object to XML" id="ix_ch07-asciidoc24"/><a data-type="indexterm" data-primary="XML" data-secondary="producing" id="ix_ch07-asciidoc25"/>You need to convert an object to XML.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678767050992">
<h2>Solution</h2>

<p>Here’s what a <code>PurchaseOrder</code> looks like:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">enum</code> <code class="n">PurchaseOrderStatus</code>
<code class="p">{</code>
    <code class="n">Received</code><code class="p">,</code>
    <code class="n">Processing</code><code class="p">,</code>
    <code class="n">Fulfilled</code>
<code class="p">}</code>

<code class="k">public</code> <code class="k">class</code> <code class="nc">PurchaseItem</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">SerialNumber</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="kt">string</code> <code class="n">Description</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="kt">float</code> <code class="n">Quantity</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="kt">decimal</code> <code class="n">Price</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code>

<code class="k">public</code> <code class="k">class</code> <code class="nc">PurchaseOrder</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">CompanyName</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Address</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Phone</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="n">PurchaseOrderStatus</code> <code class="n">Status</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="kt">string</code><code class="p">&gt;</code> <code class="n">AdditionalInfo</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">PurchaseItem</code><code class="p">&gt;</code> <code class="n">Items</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code></pre>

<p>This method simulates a data request that returns a <code>PurchaseOrder</code>:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="n">PurchaseOrder</code> <code class="nf">GetPurchaseOrder</code><code class="p">()</code>
<code class="p">{</code>
    <code class="k">return</code> <code class="k">new</code> <code class="n">PurchaseOrder</code>
    <code class="p">{</code>
        <code class="n">CompanyName</code> <code class="p">=</code> <code class="s">"Acme, Inc."</code><code class="p">,</code>
        <code class="n">Address</code> <code class="p">=</code> <code class="s">"123 4th St."</code><code class="p">,</code>
        <code class="n">Phone</code> <code class="p">=</code> <code class="s">"555-835-7609"</code><code class="p">,</code>
        <code class="n">AdditionalInfo</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="kt">string</code><code class="p">&gt;</code>
        <code class="p">{</code>
            <code class="p">{</code> <code class="s">"Terms"</code><code class="p">,</code> <code class="s">"Net 30"</code> <code class="p">},</code>
            <code class="p">{</code> <code class="s">"POC"</code><code class="p">,</code> <code class="s">"J. Smith"</code> <code class="p">}</code>
        <code class="p">},</code>
        <code class="n">Items</code> <code class="p">=</code> <code class="k">new</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">PurchaseItem</code><code class="p">&gt;</code>
        <code class="p">{</code>
            <code class="k">new</code> <code class="n">PurchaseItem</code>
            <code class="p">{</code>
                <code class="n">Description</code> <code class="p">=</code> <code class="s">"Widget"</code><code class="p">,</code>
                <code class="n">Price</code> <code class="p">=</code> <code class="m">13.95</code><code class="n">m</code><code class="p">,</code>
                <code class="n">Quantity</code> <code class="p">=</code> <code class="m">5</code><code class="p">,</code>
                <code class="n">SerialNumber</code> <code class="p">=</code> <code class="s">"123"</code>
            <code class="p">}</code>
        <code class="p">}</code>
    <code class="p">};</code>
<code class="p">}</code></pre>

<p>The <code>Main</code> method shows how to serialize that <code>PurchaseOrder</code> instance into XML:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">(</code><code class="kt">string</code><code class="p">[]</code> <code class="n">args</code><code class="p">)</code>
<code class="p">{</code>
    <code class="n">PurchaseOrder</code> <code class="n">po</code> <code class="p">=</code> <code class="n">GetPurchaseOrder</code><code class="p">();</code>

    <code class="n">XNamespace</code> <code class="n">or</code> <code class="p">=</code> <code class="s">"https://www.oreilly.com"</code><code class="p">;</code>

    <code class="n">XElement</code> <code class="n">poXml</code> <code class="p">=</code>
        <code class="k">new</code> <code class="nf">XElement</code><code class="p">(</code><code class="n">or</code> <code class="p">+</code> <code class="n">nameof</code><code class="p">(</code><code class="n">PurchaseOrder</code><code class="p">),</code>
            <code class="k">new</code> <code class="nf">XElement</code><code class="p">(</code>
                <code class="n">or</code> <code class="p">+</code> <code class="n">nameof</code><code class="p">(</code><code class="n">PurchaseOrder</code><code class="p">.</code><code class="n">Address</code><code class="p">),</code>
                <code class="n">po</code><code class="p">.</code><code class="n">Address</code><code class="p">),</code>
            <code class="k">new</code> <code class="nf">XElement</code><code class="p">(</code>
                <code class="n">or</code> <code class="p">+</code> <code class="n">nameof</code><code class="p">(</code><code class="n">PurchaseOrder</code><code class="p">.</code><code class="n">CompanyName</code><code class="p">),</code>
                <code class="n">po</code><code class="p">.</code><code class="n">CompanyName</code><code class="p">),</code>
            <code class="k">new</code> <code class="nf">XElement</code><code class="p">(</code>
                <code class="n">or</code> <code class="p">+</code> <code class="n">nameof</code><code class="p">(</code><code class="n">PurchaseOrder</code><code class="p">.</code><code class="n">Phone</code><code class="p">),</code>
                <code class="n">po</code><code class="p">.</code><code class="n">Phone</code><code class="p">),</code>
            <code class="k">new</code> <code class="nf">XElement</code><code class="p">(</code>
                <code class="n">or</code> <code class="p">+</code> <code class="n">nameof</code><code class="p">(</code><code class="n">PurchaseOrder</code><code class="p">.</code><code class="n">Status</code><code class="p">),</code>
                <code class="n">po</code><code class="p">.</code><code class="n">Status</code><code class="p">),</code>
            <code class="k">new</code> <code class="nf">XElement</code><code class="p">(</code>
                <code class="n">or</code> <code class="p">+</code> <code class="n">nameof</code><code class="p">(</code><code class="n">PurchaseOrder</code><code class="p">.</code><code class="n">AdditionalInfo</code><code class="p">),</code>
                <code class="p">(</code><code class="k">from</code> <code class="n">info</code> <code class="k">in</code> <code class="n">po</code><code class="p">.</code><code class="n">AdditionalInfo</code>
                 <code class="k">select</code>
                     <code class="k">new</code> <code class="nf">XElement</code><code class="p">(</code>
                         <code class="n">or</code> <code class="p">+</code> <code class="n">info</code><code class="p">.</code><code class="n">Key</code><code class="p">,</code>
                         <code class="n">info</code><code class="p">.</code><code class="n">Value</code><code class="p">))</code>
                <code class="p">.</code><code class="n">ToList</code><code class="p">()),</code>
            <code class="k">new</code> <code class="nf">XElement</code><code class="p">(</code>
                <code class="n">or</code> <code class="p">+</code> <code class="n">nameof</code><code class="p">(</code><code class="n">PurchaseOrder</code><code class="p">.</code><code class="n">Items</code><code class="p">),</code>
                <code class="p">(</code><code class="k">from</code> <code class="n">item</code> <code class="k">in</code> <code class="n">po</code><code class="p">.</code><code class="n">Items</code>
                 <code class="k">select</code> <code class="k">new</code> <code class="nf">XElement</code><code class="p">(</code>
                     <code class="n">or</code> <code class="p">+</code> <code class="n">nameof</code><code class="p">(</code><code class="n">PurchaseItem</code><code class="p">),</code>
                     <code class="k">new</code> <code class="nf">XAttribute</code><code class="p">(</code>
                         <code class="n">nameof</code><code class="p">(</code><code class="n">PurchaseItem</code><code class="p">.</code><code class="n">SerialNumber</code><code class="p">),</code>
                         <code class="n">item</code><code class="p">.</code><code class="n">SerialNumber</code><code class="p">),</code>
                     <code class="k">new</code> <code class="nf">XElement</code><code class="p">(</code>
                         <code class="n">or</code> <code class="p">+</code> <code class="n">nameof</code><code class="p">(</code><code class="n">PurchaseItem</code><code class="p">.</code><code class="n">Description</code><code class="p">),</code>
                         <code class="n">item</code><code class="p">.</code><code class="n">Description</code><code class="p">),</code>
                     <code class="k">new</code> <code class="nf">XElement</code><code class="p">(</code>
                         <code class="n">or</code> <code class="p">+</code> <code class="n">nameof</code><code class="p">(</code><code class="n">PurchaseItem</code><code class="p">.</code><code class="n">Price</code><code class="p">),</code>
                         <code class="n">item</code><code class="p">.</code><code class="n">Price</code><code class="p">),</code>
                     <code class="k">new</code> <code class="nf">XElement</code><code class="p">(</code>
                         <code class="n">or</code> <code class="p">+</code> <code class="n">nameof</code><code class="p">(</code><code class="n">PurchaseItem</code><code class="p">.</code><code class="n">Quantity</code><code class="p">),</code>
                         <code class="n">item</code><code class="p">.</code><code class="n">Quantity</code><code class="p">)))</code>
                <code class="p">.</code><code class="n">ToList</code><code class="p">()));</code>

    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">poXml</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>And here’s the output:</p>

<pre data-type="programlisting" data-code-language="xml"><code class="nt">&lt;PurchaseOrder</code> <code class="na">xmlns=</code><code class="s">"https://www.oreilly.com"</code><code class="nt">&gt;</code>
  <code class="nt">&lt;Address&gt;</code>123 4th St.<code class="nt">&lt;/Address&gt;</code>
  <code class="nt">&lt;CompanyName&gt;</code>Acme, Inc.<code class="nt">&lt;/CompanyName&gt;</code>
  <code class="nt">&lt;Phone&gt;</code>555-835-7609<code class="nt">&lt;/Phone&gt;</code>
  <code class="nt">&lt;Status&gt;</code>Received<code class="nt">&lt;/Status&gt;</code>
  <code class="nt">&lt;AdditionalInfo&gt;</code>
    <code class="nt">&lt;Terms&gt;</code>Net 30<code class="nt">&lt;/Terms&gt;</code>
    <code class="nt">&lt;POC&gt;</code>J. Smith<code class="nt">&lt;/POC&gt;</code>
  <code class="nt">&lt;/AdditionalInfo&gt;</code>
  <code class="nt">&lt;Items&gt;</code>
    <code class="nt">&lt;PurchaseItem</code> <code class="na">SerialNumber=</code><code class="s">"123"</code><code class="nt">&gt;</code>
      <code class="nt">&lt;Description&gt;</code>Widget<code class="nt">&lt;/Description&gt;</code>
      <code class="nt">&lt;Price&gt;</code>13.95<code class="nt">&lt;/Price&gt;</code>
      <code class="nt">&lt;Quantity&gt;</code>5<code class="nt">&lt;/Quantity&gt;</code>
    <code class="nt">&lt;/PurchaseItem&gt;</code>
  <code class="nt">&lt;/Items&gt;</code>
<code class="nt">&lt;/PurchaseOrder&gt;</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678766727808">
<h2>Discussion</h2>

<p><a data-type="xref" href="#consuming_xml">Recipe 7.7</a> deserialized an XML document into a <code>PurchaseOrder</code> object. This section goes in the other direction—serializing the <code>PurchaseOrder</code> into an XML document.</p>

<p>We start with the <code>XNamespace</code>, <code>or</code>, which is used as the <code>XName</code> parameter for each element to keep all elements in the same namespace.</p>

<p>The solution builds the XML document via calls to <code>XElement</code> and <code>XAttribute</code>. The only place we use <code>XAttribute</code> is for the <code>SerialNumber</code> attribute on each <code>Purchase​Or⁠derItem</code> element.</p>

<p>Visually, you can see that the LINQ to XML query clause is laid out with the same hierarchical structure as the XML output it produces. The solution uses two <code>XElement</code> constructor overloads. If an element is a bottom node, without children, the second parameter is the element value. However, if the element is a parent element, with children, the second parameter is a new <code>XElement</code>.</p>

<p>The LINQ statements for both <code>AdditionalInfo</code> and <code>Items</code> project into a new <span class="keep-together"><code>XElement</code></span>.<a data-type="indexterm" data-startref="ix_ch07-asciidoc25" id="idm45678766362368"/><a data-type="indexterm" data-startref="ix_ch07-asciidoc24" id="idm45678766361664"/><a data-type="indexterm" data-startref="ix_ch07-asciidoc23" id="idm45678766360992"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45678766360192">
<h2>See Also</h2>

<p><a data-type="xref" data-xrefstyle="rec-num-title" href="#consuming_xml">Recipe 7.7, “Consuming XML”</a></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.9 Encoding and Decoding URL Parameters"><div class="sect1" id="idm45678766357696">
<h1>7.9 Encoding and Decoding URL Parameters</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678766356688">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="manipulating data" data-secondary="encoding/decoding URL parameters" id="ix_ch07-asciidoc26"/><a data-type="indexterm" data-primary="networks" data-secondary="encoding/decoding URL parameters" id="ix_ch07-asciidoc27"/><a data-type="indexterm" data-primary="URLs, encoding/decoding parameters" id="ix_ch07-asciidoc28"/>You’ve working with an API that requires RFC 3986–compliant URLs.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678766351744">
<h2>Solution</h2>

<p>Here’s a class that properly encodes URL parameters:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">Url</code>
<code class="p">{</code>
    <code class="c1">/// &lt;summary&gt;</code>
    <code class="c1">/// Implements Percent Encoding according to RFC 3986</code>
    <code class="c1">/// &lt;/summary&gt;</code>
    <code class="c1">/// &lt;param name="value"&gt;string to be encoded&lt;/param&gt;</code>
    <code class="c1">/// &lt;returns&gt;Encoded string&lt;/returns&gt;</code>
    <code class="k">public</code> <code class="k">static</code> <code class="kt">string</code> <code class="nf">PercentEncode</code><code class="p">(</code>
        <code class="kt">string?</code> <code class="k">value</code><code class="p">,</code> <code class="kt">bool</code> <code class="n">isParam</code> <code class="p">=</code> <code class="k">true</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">const</code> <code class="kt">string</code> <code class="n">IsParamReservedChars</code> <code class="p">=</code> <code class="s">@"`!@#$^&amp;*+=,:;'?/|\[] "</code><code class="p">;</code>
        <code class="k">const</code> <code class="kt">string</code> <code class="n">NoParamReservedChars</code> <code class="p">=</code> <code class="s">@"`!@#$^&amp;*()+=,:;'?/|\[] "</code><code class="p">;</code>

        <code class="kt">var</code> <code class="n">result</code> <code class="p">=</code> <code class="k">new</code> <code class="n">StringBuilder</code><code class="p">();</code>

        <code class="k">if</code> <code class="p">(</code><code class="kt">string</code><code class="p">.</code><code class="n">IsNullOrWhiteSpace</code><code class="p">(</code><code class="k">value</code><code class="p">))</code>
            <code class="k">return</code> <code class="kt">string</code><code class="p">.</code><code class="n">Empty</code><code class="p">;</code>

        <code class="kt">var</code> <code class="n">escapedValue</code> <code class="p">=</code> <code class="n">EncodeDataString</code><code class="p">(</code><code class="k">value</code><code class="p">);</code>

        <code class="kt">var</code> <code class="n">reservedChars</code> <code class="p">=</code>
            <code class="n">isParam</code> <code class="p">?</code> <code class="n">IsParamReservedChars</code> <code class="p">:</code> <code class="n">NoParamReservedChars</code><code class="p">;</code>

        <code class="k">foreach</code> <code class="p">(</code><code class="kt">char</code> <code class="n">symbol</code> <code class="k">in</code> <code class="n">escapedValue</code><code class="p">)</code>
        <code class="p">{</code>
            <code class="k">if</code> <code class="p">(</code><code class="n">reservedChars</code><code class="p">.</code><code class="n">IndexOf</code><code class="p">(</code><code class="n">symbol</code><code class="p">)</code> <code class="p">!=</code> <code class="p">-</code><code class="m">1</code><code class="p">)</code>
                <code class="n">result</code><code class="p">.</code><code class="n">Append</code><code class="p">(</code>
                    <code class="sc">'%'</code> <code class="p">+</code>
                    <code class="kt">string</code><code class="p">.</code><code class="n">Format</code><code class="p">(</code><code class="s">"{0:X2}"</code><code class="p">,</code> <code class="p">(</code><code class="kt">int</code><code class="p">)</code><code class="n">symbol</code><code class="p">).</code><code class="n">ToUpper</code><code class="p">());</code>
            <code class="k">else</code>
                <code class="n">result</code><code class="p">.</code><code class="n">Append</code><code class="p">(</code><code class="n">symbol</code><code class="p">);</code>
        <code class="p">}</code>

        <code class="k">return</code> <code class="n">result</code><code class="p">.</code><code class="n">ToString</code><code class="p">();</code>
    <code class="p">}</code>

    <code class="c1">/// &lt;summary&gt;</code>
    <code class="c1">/// URL-encode a string of any length.</code>
    <code class="c1">/// &lt;/summary&gt;</code>
    <code class="k">static</code> <code class="kt">string</code> <code class="nf">EncodeDataString</code><code class="p">(</code><code class="kt">string</code> <code class="n">data</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="c1">// the max length in .NET 4.5+ is 65520</code>
        <code class="k">const</code> <code class="kt">int</code> <code class="n">maxLength</code> <code class="p">=</code> <code class="m">65519</code><code class="p">;</code>

        <code class="k">if</code> <code class="p">(</code><code class="n">data</code><code class="p">.</code><code class="n">Length</code> <code class="p">&lt;=</code> <code class="n">maxLength</code><code class="p">)</code>
            <code class="k">return</code> <code class="n">Uri</code><code class="p">.</code><code class="n">EscapeDataString</code><code class="p">(</code><code class="n">data</code><code class="p">);</code>

        <code class="kt">var</code> <code class="n">totalChunks</code> <code class="p">=</code> <code class="n">data</code><code class="p">.</code><code class="n">Length</code> <code class="p">/</code> <code class="n">maxLength</code><code class="p">;</code>

        <code class="kt">var</code> <code class="n">builder</code> <code class="p">=</code> <code class="k">new</code> <code class="n">StringBuilder</code><code class="p">();</code>
        <code class="k">for</code> <code class="p">(</code><code class="kt">var</code> <code class="n">i</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code> <code class="n">i</code> <code class="p">&lt;=</code> <code class="n">totalChunks</code><code class="p">;</code> <code class="n">i</code><code class="p">++)</code>
        <code class="p">{</code>
            <code class="kt">string?</code> <code class="n">chunk</code> <code class="p">=</code>
                <code class="n">i</code> <code class="p">&lt;</code> <code class="n">totalChunks</code> <code class="p">?</code>
                    <code class="n">data</code><code class="p">[(</code><code class="n">maxLength</code> <code class="p">*</code> <code class="n">i</code><code class="p">)..</code><code class="n">maxLength</code><code class="p">]</code> <code class="p">:</code>
                    <code class="n">data</code><code class="p">[(</code><code class="n">maxLength</code> <code class="p">*</code> <code class="n">i</code><code class="p">)..];</code>

            <code class="n">builder</code><code class="p">.</code><code class="n">Append</code><code class="p">(</code><code class="n">Uri</code><code class="p">.</code><code class="n">EscapeDataString</code><code class="p">(</code><code class="n">chunk</code><code class="p">));</code>
        <code class="p">}</code>
        <code class="k">return</code> <code class="n">builder</code><code class="p">.</code><code class="n">ToString</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>This method parses a URL, encodes parameters, and rebuilds the URL:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="kt">string</code> <code class="nf">EscapeUrlParams</code><code class="p">(</code><code class="kt">string</code> <code class="n">originalUrl</code><code class="p">)</code>
<code class="p">{</code>
    <code class="k">const</code> <code class="kt">int</code> <code class="n">Base</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code>
    <code class="k">const</code> <code class="kt">int</code> <code class="n">Parms</code> <code class="p">=</code> <code class="m">1</code><code class="p">;</code>
    <code class="k">const</code> <code class="kt">int</code> <code class="n">Key</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code>
    <code class="k">const</code> <code class="kt">int</code> <code class="n">Val</code> <code class="p">=</code> <code class="m">1</code><code class="p">;</code>
    <code class="kt">string</code><code class="p">[]</code> <code class="n">parts</code> <code class="p">=</code> <code class="n">originalUrl</code><code class="p">.</code><code class="n">Split</code><code class="p">(</code><code class="sc">'?'</code><code class="p">);</code>
    <code class="kt">string</code><code class="p">[]</code> <code class="n">pairs</code> <code class="p">=</code> <code class="n">parts</code><code class="p">[</code><code class="n">Parms</code><code class="p">].</code><code class="n">Split</code><code class="p">(</code><code class="sc">'&amp;'</code><code class="p">);</code>

    <code class="kt">string</code> <code class="n">escapedParms</code> <code class="p">=</code>
        <code class="kt">string</code><code class="p">.</code><code class="n">Join</code><code class="p">(</code><code class="sc">'&amp;'</code><code class="p">,</code>
            <code class="p">(</code><code class="k">from</code> <code class="n">pair</code> <code class="k">in</code> <code class="n">pairs</code>
             <code class="k">let</code> <code class="n">keyVal</code> <code class="p">=</code> <code class="n">pair</code><code class="p">.</code><code class="n">Split</code><code class="p">(</code><code class="sc">'='</code><code class="p">)</code>
             <code class="k">let</code> <code class="n">encodedVal</code> <code class="p">=</code> <code class="n">Url</code><code class="p">.</code><code class="n">PercentEncode</code><code class="p">(</code><code class="n">keyVal</code><code class="p">[</code><code class="n">Val</code><code class="p">])</code>
             <code class="k">select</code> <code class="err">$</code><code class="s">"{keyVal[Key]}={encodedVal}"</code><code class="p">)</code>
            <code class="p">.</code><code class="n">ToList</code><code class="p">());</code>

    <code class="k">return</code> <code class="err">$</code><code class="s">"{parts[Base]}?{escapedParms}"</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>The <code>Main</code> method compares different encodings:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">()</code>
<code class="p">{</code>
    <code class="k">const</code> <code class="kt">string</code> <code class="n">OriginalUrl</code> <code class="p">=</code>
        <code class="s">"https://myco.com/po/search?company=computers+"</code><code class="p">;</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"Original:    '{OriginalUrl}'"</code><code class="p">);</code>

    <code class="kt">string</code> <code class="n">escapedUri</code> <code class="p">=</code> <code class="n">Uri</code><code class="p">.</code><code class="n">EscapeUriString</code><code class="p">(</code><code class="n">OriginalUrl</code><code class="p">);</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"Escape URI:  '{escapedUri}'"</code><code class="p">);</code>

    <code class="kt">string</code> <code class="n">escapedData</code> <code class="p">=</code> <code class="n">Uri</code><code class="p">.</code><code class="n">EscapeDataString</code><code class="p">(</code><code class="n">OriginalUrl</code><code class="p">);</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"Escape Data: '{escapedData}'"</code><code class="p">);</code>

    <code class="kt">string</code> <code class="n">escapedUrl</code> <code class="p">=</code> <code class="n">EscapeUrlParams</code><code class="p">(</code><code class="n">OriginalUrl</code><code class="p">);</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"Escaped URL: '{escapedUrl}'"</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>Producing this output:</p>

<pre data-type="programlisting" data-code-language="text">Original:    'https://myco.com/po/search?company=computers+'
Escape URI:  'https://myco.com/po/search?company=computers+'
Escape Data: 'https%3A%2F%2Fmyco.com%2Fpo%2Fsearch%3Fcompany
%3Dcomputers%2B'
Escaped URL: 'https://myco.com/po/search?company=computers%2B'</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678765771232">
<h2>Discussion</h2>

<p>If you’re building both the consumer and producer parts of network communications, such as an internal enterprise application, getting encoding right might not matter because both parts use the same library. However, some third-party APIs require strong compliance with RFC 3986. Your first thought may be that the .NET <code>System.Uri</code> class has <code>EscapeUriString</code> and <code>EscapeDataString</code> methods. Unfortunately, these methods haven’t always implemented RFC 3986 properly. While .NET 5+ is cross-platform and seems to have a good implementation, earlier versions of the .NET Framework for different technologies did not. To fix this, I created the <code>Url</code> class in the solution.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>RFC 3986 is the standard defining internet URL encoding. RFC stands for “Request for Comments,” and standards are generally labeled with RFC followed by some unique number.</p>
</div>

<p>The <code>PercentEncode</code> replaces each character of the value parameter with a two-digit hex representation with a percent (<code>%</code>) prefix. The first operation is to call <code>EscapeDataString</code>. This method calls <code>Uri.EscapeDataString</code>. One of the issues with <code>Uri.​Esca⁠peDataString</code> is a length constraint, so this method chunks the input to ensure all the data is encoded. The approach is to allow <code>Uri.EscapeDataString</code> to take care of most of the conversion and let <code>PercentEncode</code> supplement for characters that weren’t encoded.</p>

<p><code>PercentEncode</code> has a second parameter, <code>isParam</code>, that indicates whether we should encode parentheses. It defaults to <code>true</code>, and users would set it to <code>false</code> to prevent encoding parentheses, which is the only difference between the <code>IsParamReservedChars</code> and <code>NoParamReservedChars</code>. If the method finds a character that hasn’t been encoded, it does the encoding manually.</p>

<p>We only encode query string parameter values because the base URL, segments, and parameter names are values that don’t need encoding. The <code>EscapeUrlParameters</code> method does this by splitting the URL from the parameters and iterating through each parameter. For each parameter, it splits the parameter name from its value and calls <code>PercentEncode</code> on the value. After encoding values, the code rebuilds and returns the URL.</p>

<p>The <code>Main</code> method shows the different types of encoding, illuminating why we chose the custom encoding approach. Notice that <code>Uri.EscapeUriString</code> didn’t encode the <code>+</code> symbol. Using <code>Uri.EscapeDataString</code> encoded the entire URL, which isn’t what you want. Breaking up the URL and encoding each value worked perfectly.</p>

<p>Remember that you might get good results in a .NET 5+ application. However, if you’re doing cross-platform work in older .NET Framework versions, the results of <code>Uri.EscapeUriString</code> and <code>Uri.EscapeDataString</code> are inconsistent and likely to cause bugs. Regardless of framework/technology version, the technique of only encoding parameter values is a common requirement.<a data-type="indexterm" data-startref="ix_ch07-asciidoc28" id="idm45678765753536"/><a data-type="indexterm" data-startref="ix_ch07-asciidoc27" id="idm45678765752832"/><a data-type="indexterm" data-startref="ix_ch07-asciidoc26" id="idm45678765752160"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="7.10 Flexible DateTime Reading"><div class="sect1" id="flexible_datetime_reading">
<h1>7.10 Flexible DateTime Reading</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678765749776">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="date/time information" data-secondary="flexible datetime reading" id="ix_ch07-asciidoc29"/><a data-type="indexterm" data-primary="DateTime values" id="ix_ch07-asciidoc30"/><a data-type="indexterm" data-primary="manipulating data" data-secondary="flexible datetime reading" id="ix_ch07-asciidoc31"/>You need to parse <code>DateTime</code> values that can be in multiple different formats.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678765728048">
<h2>Solution</h2>

<p>These extension methods help in parsing dates:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">static</code> <code class="k">class</code> <code class="nc">StringExtensions</code>
<code class="p">{</code>
    <code class="k">static</code> <code class="k">readonly</code> <code class="kt">string</code><code class="p">[]</code> <code class="n">dateFormats</code> <code class="p">=</code>
    <code class="p">{</code>
        <code class="s">"ddd MMM dd HH:mm:ss %zzzz yyyy"</code><code class="p">,</code>
        <code class="s">"yyyy-MM-dd\\THH:mm:ss.000Z"</code><code class="p">,</code>
        <code class="s">"yyyy-MM-dd\\THH:mm:ss\\Z"</code><code class="p">,</code>
        <code class="s">"yyyy-MM-dd HH:mm:ss"</code><code class="p">,</code>
        <code class="s">"yyyy-MM-dd HH:mm"</code>
    <code class="p">};</code>

    <code class="k">public</code> <code class="k">static</code> <code class="n">DateTime</code> <code class="nf">GetDate</code><code class="p">(</code>
        <code class="k">this</code> <code class="kt">string</code> <code class="n">date</code><code class="p">,</code>
        <code class="n">DateTime</code> <code class="n">defaultValue</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="kt">string</code><code class="p">.</code><code class="n">IsNullOrWhiteSpace</code><code class="p">(</code><code class="n">date</code><code class="p">)</code> <code class="p">||</code>
            <code class="p">!</code><code class="n">DateTime</code><code class="p">.</code><code class="n">TryParseExact</code><code class="p">(</code>
                    <code class="n">date</code><code class="p">,</code>
                    <code class="n">dateFormats</code><code class="p">,</code>
                    <code class="n">CultureInfo</code><code class="p">.</code><code class="n">InvariantCulture</code><code class="p">,</code>
                    <code class="n">DateTimeStyles</code><code class="p">.</code><code class="n">AssumeUniversal</code> <code class="p">|</code>
                    <code class="n">DateTimeStyles</code><code class="p">.</code><code class="n">AdjustToUniversal</code><code class="p">,</code>
                    <code class="k">out</code> <code class="n">DateTime</code> <code class="n">result</code><code class="p">)</code>
                <code class="p">?</code> <code class="n">defaultValue</code>
                <code class="p">:</code> <code class="n">result</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">static</code> <code class="n">DateTime</code> <code class="nf">GetDate</code><code class="p">(</code>
        <code class="k">this</code> <code class="n">JsonElement</code> <code class="n">json</code><code class="p">,</code>
        <code class="kt">string</code> <code class="n">propertyName</code><code class="p">,</code>
        <code class="n">DateTime</code> <code class="n">defaultValue</code> <code class="p">=</code> <code class="k">default</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="kt">string?</code> <code class="n">date</code> <code class="p">=</code> <code class="n">json</code><code class="p">.</code><code class="n">GetString</code><code class="p">(</code><code class="n">propertyName</code><code class="p">);</code>
        <code class="k">return</code> <code class="n">date</code><code class="p">?.</code><code class="n">GetDate</code><code class="p">(</code><code class="n">defaultValue</code><code class="p">)</code> <code class="p">??</code> <code class="n">defaultValue</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">static</code> <code class="kt">string?</code> <code class="n">GetString</code><code class="p">(</code>
        <code class="k">this</code> <code class="n">JsonElement</code> <code class="n">json</code><code class="p">,</code>
        <code class="kt">string</code> <code class="n">propertyName</code><code class="p">,</code>
        <code class="kt">string?</code> <code class="n">defaultValue</code> <code class="p">=</code> <code class="k">default</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">if</code> <code class="p">(!</code><code class="n">json</code><code class="p">.</code><code class="n">IsNull</code><code class="p">()</code> <code class="p">&amp;&amp;</code>
            <code class="n">json</code><code class="p">.</code><code class="n">TryGetProperty</code><code class="p">(</code><code class="n">propertyName</code><code class="p">,</code> <code class="k">out</code> <code class="n">JsonElement</code> <code class="n">element</code><code class="p">))</code>
            <code class="k">return</code> <code class="n">element</code><code class="p">.</code><code class="n">GetString</code><code class="p">()</code> <code class="p">??</code> <code class="n">defaultValue</code><code class="p">;</code>

        <code class="k">return</code> <code class="n">defaultValue</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">static</code> <code class="kt">bool</code> <code class="nf">IsNull</code><code class="p">(</code><code class="k">this</code> <code class="n">JsonElement</code> <code class="n">json</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">return</code>
            <code class="n">json</code><code class="p">.</code><code class="n">ValueKind</code> <code class="p">==</code> <code class="n">JsonValueKind</code><code class="p">.</code><code class="n">Undefined</code> <code class="p">||</code>
            <code class="n">json</code><code class="p">.</code><code class="n">ValueKind</code> <code class="p">==</code> <code class="n">JsonValueKind</code><code class="p">.</code><code class="n">Null</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>The <code>Main</code> method shows how to extract and parse a JSON document date:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">()</code>
<code class="p">{</code>
    <code class="k">const</code> <code class="kt">string</code> <code class="n">TweetID</code> <code class="p">=</code> <code class="s">"1305895383260782593"</code><code class="p">;</code>
    <code class="k">const</code> <code class="kt">string</code> <code class="n">CreatedDate</code> <code class="p">=</code> <code class="s">"created_at"</code><code class="p">;</code>

    <code class="kt">string</code> <code class="n">tweetJson</code> <code class="p">=</code> <code class="n">GetTweet</code><code class="p">(</code><code class="n">TweetID</code><code class="p">);</code>

    <code class="n">JsonElement</code> <code class="n">tweetElem</code> <code class="p">=</code> <code class="n">JsonDocument</code><code class="p">.</code><code class="n">Parse</code><code class="p">(</code><code class="n">tweetJson</code><code class="p">).</code><code class="n">RootElement</code><code class="p">;</code>

    <code class="n">DateTime</code> <code class="n">created</code> <code class="p">=</code> <code class="n">tweetElem</code><code class="p">.</code><code class="n">GetDate</code><code class="p">(</code><code class="n">CreatedDate</code><code class="p">);</code>

    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"Created Date: {created}"</code><code class="p">);</code>
<code class="p">}</code>

<code class="k">static</code> <code class="kt">string</code> <code class="nf">GetTweet</code><code class="p">(</code><code class="kt">string</code> <code class="n">tweetID</code><code class="p">)</code>
<code class="p">{</code>
    <code class="k">return</code> <code class="s">@"{</code>
<code class="s">        ""text"": ""Thanks @github for approving sponsorship for</code>
<code class="s">            LINQ to Twitter: https://t.co/jWeDEN07HN"",</code>
<code class="s">        ""id"": ""1305895383260782593"",</code>
<code class="s">        ""author_id"": ""15411837"",</code>
<code class="s">        ""created_at"": ""2020-09-15T15:44:56.000Z""</code>
<code class="s">      }"</code><code class="p">;</code>
<code class="p">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678765449744">
<h2>Discussion</h2>

<p>When using third-party APIs, you’ll encounter occasional inconsistencies in data representation. One problematic area is parsing dates. Different APIs have different date formats or even represent different date properties with separate formats in the same API. The <code>StringExtensions</code> class in the solution helps fix this problem.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>I extracted <code>StringExtensions</code> members from <code>JsonConversion​Ex⁠tensions</code> in <a data-type="xref" href="#working_with_json_data">Recipe 7.6</a>.</p>
</div>

<p>The solution includes a <code>dateFormats</code> array containing instances of date format strings. These are all the possible date formats that this code can accommodate. The <code>GetDate</code> method uses <code>dateFormats</code> in the call to <code>TryParseExact</code>. Whenever you encounter a new date format (for instance, if an API offers a new version and updates date formats), add it to <code>dateFormats</code>.</p>

<p>It’s best practice to represent dates as UTC values, so the <code>DateTimeStyles</code> arguments reflect this assumption.</p>

<p>There are two overloads of <code>GetDate</code>, depending on whether you need to pass in a <code>string</code> or a <code>JsonElement</code>. The <code>JsonElement</code> overload uses the <code>GetString</code> extension method and forwards the result to the other <code>GetDate</code> method.</p>

<p>These methods are safe because you have to account for bad data. They check for <code>null</code>, use <code>TryParse</code>, and return <code>default</code> values when they can’t read a valid value. The <code>defaultValue</code> is optional, using the <code>default</code> of the return type if not provided<a data-type="indexterm" data-startref="ix_ch07-asciidoc31" id="idm45678765327056"/><a data-type="indexterm" data-startref="ix_ch07-asciidoc30" id="idm45678765326352"/><a data-type="indexterm" data-startref="ix_ch07-asciidoc29" id="idm45678765325680"/>.<a data-type="indexterm" data-startref="ix_ch07-asciidoc0" id="idm45678765324880"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45678765324176">
<h2>See Also</h2>

<p><a data-type="xref" data-xrefstyle="rec-num-title" href="#working_with_json_data">Recipe 7.6, “Working with JSON Data”</a></p>
</div></section>





</div></section>







</div></section></div></body></html>