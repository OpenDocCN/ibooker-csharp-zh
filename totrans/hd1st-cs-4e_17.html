<html><head></head><body><section data-pdf-bookmark="Chapter 11. Captain Amazing: The Death of the Object" data-type="chapter" epub:type="chapter"><div class="chapter" id="captain_amazing_the_death_of_the_object">
<h1><span class="label">Chapter 11. </span>Captain Amazing: <em>The Death of the Object</em></h1>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg587a.png"/>
<h6/>
</div></figure>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg587.png"/>
<h6/>
</div></figure>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg588.png"/>
<h6/>
</div></figure>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg589.png"/>
<h6/>
</div></figure>
<section data-pdf-bookmark="The life and death of an object" data-type="sect1"><div class="sect1" id="the_life_and_death_of_an_object">
<h1>The life and death of an object</h1>
<p><a data-primary="CLR (Common Language Runtime)" data-type="indexterm" id="idm46402338826584"/><a data-primary="garbage collection" data-type="indexterm" id="idm46402338825256"/><a data-primary="objects" data-secondary="about" data-type="indexterm" id="idm46402338824456"/><a data-primary="Captain Amazing" data-type="indexterm" id="idm46402338823336"/>Here’s a quick review of what we know about how objects live and die:</p>
<ul>
<li><p>When you create an object, the CLR—which runs your .NET applications and manages memory—allocates enough memory for it on the heap, a special portion of your computer’s memory reserved for objects and their data.</p></li>
<li><p>It’s kept “alive” by a reference, which can be stored in a variable, a collection, or a property or field of another object.</p></li>
<li><p>There can be lots of references to the same object—like you saw in <a href="ch04.html#types_and_references_getting_the_referen">#types_and_references_getting_the_referen</a>, when you pointed the <code>lloyd</code> and <code>lucinda</code> reference variables to the same instance of Elephant.</p></li>
<li><p>When you took away the last reference to the Elephant object, that caused the CLR to mark it for garbage collection.</p></li>
<li><p>And eventually the CLR removed the Elephant object and the memory was reclaimed so it could be used for new instances of objects that your program would go on to create later.</p></li>
</ul>
<p>Now we’ll explore all of these points in more detail, writing small programs that help show how garbage collection works.</p>
<p>But before we can start experimenting with garbage collection, we need to take a step back. You learned earlier that objects are “marked” for garbage collection—but that the actual removal of the object can happen at any time (or never!). We’ll need a way to know when an object has been garbage-collected, and a way to force that garbage collection to happen. So that’s where we’ll start.</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg590-1.png"/>
<h6/>
</div></figure>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg590-2.png"/>
<h6/>
</div></figure>
</div></section>
<section data-pdf-bookmark="Use the GC class (with caution) to force garbage collection" data-type="sect1"><div class="sect1" id="use_the_gc_class_left_parenthesiswith_ca">
<h1>Use the GC class (<u>with caution</u>) to force garbage collection</h1>
<p>.NET gives you a <strong>GC class</strong> that controls the garbage collector. We’ll use its static methods—like GetTotalMemory, which returns a long with an <em>approximate</em> count of the number of bytes currently <em>thought</em> to be allocated on the heap:</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg591-1.png"/>
<h6/>
</div></figure>
<p>You may be thinking, “Why <em>approximate</em>? What does <em>thought</em> to be allocated mean? How can the garbage collector not know exactly how much memory is allocated?” That reflects one of the basic rules of garbage collection: you can absolutely, 100% rely on garbage collection, but <strong><em>there are a lot of unknowns and approximations.</em></strong></p>
<p>In this chapter we’re going to use a few GC functions:</p>
<ul>
<li><p>GC.GetTotalMemory returns the approximate number of bytes currently thought to be allocated on the heap.</p></li>
<li><p>GC.GetTotalAllocatedBytes returns the approximate number of bytes that have been allocated since the program was started.</p></li>
<li><p>GC.Collect forces the garbage collector to reclaim all unreferenced objects immediately.</p></li>
</ul>
<p>There’s just one thing about these methods: we’re using them for learning and exploration, but unless you <strong><em>really</em></strong> know what you’re doing, <strong>do <u>not</u> call GC.Collect in code for a real project</strong>. The .NET garbage collector is a finely tuned, carefully calibrated piece of engineering. In general, when it comes to determining when to collect objects, it’s smarter than we are, and we should trust it to do its job.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="there_are_no_dumb_questions-idd0036">
<h5>there are no Dumb Questions</h5>
<p><strong>Q: I have...questions. What...how do I put this...what exactly <strong><em>is</em></strong> Captain Amazing?</strong></p>
<p><strong>A:</strong> Captain Amazing is the world’s most amazing object, the superhero protector of the innocent citizens of Objectville, and friend to all small animals everywhere.</p>
<p>More specifically, Captain Amazing is an anthropomorphized object, inspired by one of the most important comic book events of the early 21st century that deals with the death of a superhero—specifically, a comic that came out in 2007, when we were working on the first draft of <em>Head First C#</em> and looking for a good way to talk about the life and death of an object. We noticed a striking similarity between the shape of the objects in our memory heap diagrams and the shield of a certain famous comic book Captain... and thus, Captain Amazing was born. (If you’re not a comic book fan, don’t worry—you don’t need to know anything about the comic we’re making a reference to in order to understand the material in this chapter.)</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg591-2.png"/>
<h6/>
</div></figure>
<p><strong>Q: Why do your “clones” look like robots? Shouldn’t they be people?</strong></p>
<p><strong>A:</strong> Yes, in our comic, we made the clones look like this:</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg591-3.png"/>
<h6/>
</div></figure>
<p>because we didn’t want to show graphic depictions of people getting destroyed.</p>
<p>Also, <em>relax</em>. The point of the comic panels in this chapter is to help get important C# and .NET concepts into your brain. The story is just a tool to draw some helpful analogies.</p>
</div></aside>
</div></section>
<section data-pdf-bookmark="Your last chance to DO something...your object’s finalizer" data-type="sect1"><div class="sect1" id="your_last_chance_to_do_somethinghellipyo">
<h1>Your last chance to <u>DO</u> something...your object’s finalizer</h1>
<p><a data-primary="CLR (Common Language Runtime)" data-type="indexterm" id="idm46402338785576"/><a data-primary="finalizers" data-secondary="about" data-type="indexterm" id="idm46402338783256"/>Sometimes you need to be sure something happens <strong><em>before</em></strong> your object gets garbage-collected, like <strong>releasing unmanaged resources.</strong></p>
<p>A special method in your object called the <strong>finalizer</strong> allows you to write code that will always execute when your object is destroyed. It gets executed last, no matter what.</p>
<p>Let’s do some experimentation with finalizers. <strong>Create a new console app</strong> and add this class with a finalizer:</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><strong>In general, you’ll never write a finalizer for an object that only owns <u><span style="color:#9D9EA0;">managed resources</span></u>. Everything you’ve encountered so far in this book has been managed by the CLR. But occasionally programmers need to access a Windows resource that isn’t in a .NET namespace. For example, if you find code on the internet that has <code>[DllImport]</code> above a declaration, you might be using an <span style="color:#9D9EA0;"><u>unmanaged resource</u></span>. And some of those non-.NET resources might leave your system unstable if they’re not “cleaned up.” That’s what finalizers are for.</strong></p>
</div>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg592.png"/>
<h6/>
</div></figure>
</div></section>
<section data-pdf-bookmark="When EXACTLY does a finalizer run?" data-type="sect1"><div class="sect1" id="when_exactly_does_a_finalizer_runquestio">
<h1>When <u>EXACTLY</u> does a finalizer run?</h1>
<p><a data-primary="finalizers" data-secondary="when they run" data-type="indexterm" id="idm46402338770696"/><a data-primary="GC.Collect( ) method" data-type="indexterm" id="idm46402338769672"/><a data-primary=".NET Framework" data-secondary="garbage collection" data-type="indexterm" id="idm46402338768872"/>The finalizer for your object runs <strong>after</strong> all references are gone, but <strong>before</strong> that object gets garbage-collected. Garbage collection only happens after <strong><em>all</em></strong> references to your object go away, but it doesn’t always happen <em>right after</em> the last reference disappears.</p>
<p>Suppose you have an object with a reference to it. The CLR sends the garbage collector to work, and it checks out your object. But since there are references to your object, the garbage collector ignores it and moves along. Your object keeps living on in memory.</p>
<p>Then, something happens. That last object holding a reference to <em>your</em> object removes that reference. Now your object is sitting in memory, with no references. It can’t be accessed. It’s basically a <strong>dead object</strong>.</p>
<p>But here’s the thing: <strong><em>garbage collection is something that the CLR controls</em></strong>, not your objects. So if the garbage collector isn’t sent out again for, say, a few seconds, or maybe even a few minutes, your object still lives on in memory. It’s unusable, but it hasn’t been garbage-collected. <strong>And the object’s finalizer cannot (yet) run.</strong></p>
<p>Finally, the CLR sends the garbage collector out again. It checks your object, finds there are no references, and runs the finalizer...possibly several minutes after the last reference to the object was removed or changed. Now that it’s been finalized, your object is dead, and the collector tosses it away.</p>
<section data-pdf-bookmark="You can SUGGEST to .NET that it’s time to collect the garbage" data-type="sect2"><div class="sect2" id="you_can_suggest_to_dotnet_that_itapostro">
<h2>You can <u>SUGGEST</u> to .NET that it’s time to collect the garbage</h2>
<p>.NET does let you <strong><em>suggest</em></strong> that garbage collection would be a good idea. <strong>Most times, you’ll never use this method, because garbage collection is tuned to respond to a lot of conditions in the CLR, and calling it <em>isn’t really a good idea</em></strong>. But just to see how a finalizer works, you could call for garbage collection on your own, using GC.Collect.</p>
<p>Be careful, though. That method doesn’t <strong><em>force</em></strong> the CLR to garbage-collect things immediately. It just says, “Do garbage collection as soon as possible.”</p>
<p><strong>The life and death of an object...a timeline</strong></p>
<ol>
<li><p><strong>Your object is living its best life on the heap. Another object has a reference to it, keeping it alive.</strong></p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg593-1.png"/>
<h6/>
</div></figure>
</li>
<li><p><strong>The other object changes its reference, so now there are no other objects referencing your object.</strong></p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg593-2.png"/>
<h6/>
</div></figure>
</li>
<li><p><strong>The CLR marks your object for garbage collection.</strong></p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg593-3.png"/>
<h6/>
</div></figure>
</li>
<li><p><strong>Eventually the garbage collector runs the object’s finalizer and removes the object from the heap.</strong></p>
</li>
</ol>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>We’re using GC.Collect as a learning tool to help you understand how garba<u>ge collection</u> works. You definitely should not use it outside of toy programs (unless you really understand how garbage collection in .NET works on a deeper level than we’ll go into in this book).</p>
</div>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg594.png"/>
<h6/>
</div></figure>
</div></section>
</div></section>
<section data-pdf-bookmark="Finalizers can’t depend on other objects" data-type="sect1"><div class="sect1" id="finalizers_canapostrophet_depend_on_othe">
<h1>Finalizers <u>can’t</u> depend on other objects</h1>
<p><a data-primary="Dispose() method" data-secondary="finalizers" data-type="indexterm" id="idm46402338739768"/><a data-primary="finalizers" data-secondary="depending on references being valid" data-type="indexterm" id="idm46402338738472"/><a data-primary="finalizers" data-secondary="Dispose( ) method" data-type="indexterm" id="idm46402338737464"/><a data-primary="IDisposable interface" data-secondary="Dispose( ) as alternative to finalizers" data-type="indexterm" id="idm46402338736424"/><a data-primary="serialization" data-secondary="finalizers and" data-type="indexterm" id="idm46402338735272"/>When you write a finalizer, you can’t depend on it running at any one time. Even if you call GC.Collect, you’re only <strong><em>suggesting</em></strong> that the garbage collector is run. It’s not a guarantee that it’ll happen right away. And when it does, you have no way of knowing what order the objects will be collected in.</p>
<p>So what does that mean, in practical terms? Well, think about what happens if you’ve got two objects that have references to each other. If object #1 is collected first, then object #2’s reference to it is pointing to an object that’s no longer there. But if object #2 is collected first, then object #1’s reference is invalid. That means <strong><em>you can’t depend on references in your object’s finalizer</em></strong>. Which means that it’s a really bad idea to try to do something inside a finalizer that depends on references being valid.</p>
<section data-pdf-bookmark="Don’t use finalizers for serialization" data-type="sect2"><div class="sect2" id="donapostrophet_use_finalizers_for_serial">
<h2>Don’t use finalizers for serialization</h2>
<p>Serialization is a really good example of something that you <strong>shouldn’t do inside a finalizer</strong>. If your object’s got a bunch of references to other objects, serialization depends on <strong><em>all</em></strong> of those objects still being in memory...and all of the objects they reference, and the ones those objects reference, and so on. So if you try to serialize when garbage collection is happening, you could end up <strong>missing</strong> vital parts of your program because some objects might’ve been collected <strong><em>before</em></strong> the finalizer ran.</p>
<p>Luckily, C# gives us a really good solution to this: IDisposable. Anything that could modify your core data or that depends on other objects being in memory needs to happen as part of a Dispose method, not a finalizer.</p>
<p>Some people like to think of a finalizer as a kind of fail-safe for the Dispose method. And that makes sense—you saw with your Clone object that just because you implement IDisposable, that doesn’t mean the object’s Dispose method will get called. But you need to be careful—if your Dispose method depends on other objects that are on the heap, then calling Dispose from your finalizer can cause trouble. The best way around this is to make sure you <strong>always use a <code>using</code> statement</strong> any time you’re creating an IDisposable object.</p>
<p><strong>Start with two objects with references to each other.</strong></p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg595-1.png"/>
<h6/>
</div></figure>
<p><strong>If all other objects on the heap remove their references to objects #1 and #2, they’ll <u>both</u> be marked for collection.</strong></p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg595-2.png"/>
<h6/>
</div></figure>
<p><strong>If object #1 is collected first, then its data won’t be available when the CLR runs object #2’s finalizer.</strong></p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg595-3.png"/>
<h6/>
</div></figure>
<p><strong>On the other hand, object #2 could disappear before object #1. You’ve got no way of knowing the order.</strong></p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg595-4.png"/>
<h6/>
</div></figure>
<p><strong>And that’s why one object’s finalizer can’t rely on any other object still being on the heap.</strong></p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg596.png"/>
<h6/>
</div></figure>
<p><a data-primary="Dispose() method" data-secondary="finalizers" data-type="indexterm" id="idm46402338710760"/><a data-primary="finalizers" data-secondary="Dispose( ) method" data-type="indexterm" id="idm46402338709432"/>Tonight’s debate: <strong>the Dispose method and a finalizer spar over who’s more valuable</strong> to you, a C# developer.</p>
<table>
<tbody>
<tr>
<td><strong>Dispose:</strong></td>
<td><strong>Finalizer:</strong></td>
</tr>
<tr>
<td>To be honest, I’m a little surprised I was invited here. I thought the programming world had come to a consensus. I mean, I’m simply far more valuable as a C# tool than you are. Really, you’re pretty feeble. You can’t even depend on other objects still being around by the time that you’re called. Pretty unstable, aren’t you?</td>
<td>Excuse me? That’s rich. I’m “feeble”? OK. Well, I didn’t want to get into this, but since we’re already stooping this low...at least I don’t need an interface to get started. Without the IDisposable interface, well, let’s face it... you’re just another useless method.</td>
</tr>
<tr>
<td>There’s an interface specifically <strong>because</strong> I’m so important. In fact, I’m the only method in it!</td>
<td>Right, right...keep telling yourself that. And what happens when someone forgets to use a <code>using</code> statement when they instantiate their object? Then you’re nowhere to be found.</td>
</tr>
<tr>
<td>OK, you’re right, programmers need to know they’re going to need me and either call me directly or use a <code>using</code> statement to call me. But they always know when I’ll run, and they can use me to do whatever they need to do to clean up after their objects. I’m powerful, reliable, and easy to use. I’m a triple threat. And you? Nobody knows exactly when you’ll run or what the state of the app will be when you finally do decide to show up.</td>
<td>But if you need to do something at the very last moment just before an object is garbage-collected, there’s no way to do it without me. I can free up network resources and Windows <u>handles</u> and anything else that might cause a problem for the rest of the app if you don’t clean it up. I can make sure that your objects deal with being trashed more gracefully, and that’s nothing to sneeze at.<br/><span style="color:#9D9EA0;">Handles are what your programs use when they go around .NET and the CLR and interact directly with Windows. Since .NET doesn’t know about them, it can’t clean them up for you.</span></td>
</tr>
<tr>
<td>You think you’re a big shot because you always run with GC, but at least I can depend on other objects.</td>
<td>That’s right, pal—but I always run. You need someone else to run you. I don’t need anyone or anything!</td>
</tr>
</tbody>
</table>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg597.png"/>
<h6/>
</div></figure>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="there_are_no_dumb_questions-idd0037">
<h5>there are no Dumb Questions</h5>
<p><a data-primary="finalizers" data-secondary="fields and methods" data-type="indexterm" id="idm46402338691480"/><a data-primary="GC.Collect( ) method" data-type="indexterm" id="idm46402338690184"/><strong>Q: Can a finalizer use all of an object’s fields and methods?</strong></p>
<p><strong>A:</strong> Yes. While you can’t pass parameters to a finalizer method, you can use any of the fields in an object, either directly or using <code>this</code>—but be careful, because if those fields reference other objects, then the other objects may have already been garbage-collected. So your finalizer can call other methods and properties in the object...as long as those methods and properties <em>don’t depend on other objects.</em></p>
<p><strong>Q: What happens to exceptions that get thrown in a finalizer?</strong></p>
<p><strong>A:</strong> Good question. Exceptions in finalizers work exactly like they do anywhere else in your code. Try replacing your EvilClone finalizer with this one that throws an exception:</p>
<pre data-type="programlisting">~EvilClone() =&gt; throw new Exception();</pre>
<p>Then run your app again, create some EvilClone instances, clear the list, and run the garbage collector. Your app will halt in the finalizer, just like it would if it hit any other exceptions. (Spoiler alert: in the next chapter you’ll learn about how to <em>catch</em> exceptions, detecting when they happen and running code to handle them.)</p>
<p><strong>Q: How often does the garbage collector run automatically?</strong></p>
<p><strong>A:</strong> The short answer is: we’re not sure. Garbage collection doesn’t run on an easily predictable cycle, and you don’t have firm control over it. You can be sure it will run when your program exits normally. Even when you call GC.Collect (which you generally should avoid), you’re only suggesting that the CLR should start garbage collection.</p>
<p><strong>Q: So how soon after I call GC.Collect will collection start?</strong></p>
<p><strong>A:</strong> When you run GC.Collect, you’re telling .NET to garbage-collect as soon as possible. That’s <strong><em>usually</em></strong> as soon as .NET finishes whatever it’s doing. That means it’ll happen pretty soon, but you can’t precisely control when it starts.</p>
<p><strong>Q: If something absolutely must run, do I put it in a finalizer?</strong></p>
<p><strong>A:</strong> No. It’s possible that your finalizer won’t run. And it’s possible to suppress finalizers when garbage collection happens. Or the process could end entirely. If you aren’t freeing unmanaged resources, you’re almost always better off using IDisposable and <code>using</code> statements.</p>
</div></aside>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg598.png"/>
<h6/>
</div></figure>
</div></section>
</div></section>
<section data-pdf-bookmark="A struct looks like an object..." data-type="sect1"><div class="sect1" id="a_struct_looks_like_an_objecthellip">
<h1>A struct <u>looks</u> like an object...</h1>
<p><a data-primary=".NET Framework" data-secondary="structs" data-type="indexterm" id="idm46402338674952"/><a data-primary="structs" data-secondary="about" data-type="indexterm" id="idm46402338673704"/>We’ve been talking about the heap, because that’s where your objects live. But that’s not the only part of memory where objects live. One of the types in .NET we haven’t talked about much is the <em>struct</em>, and we’ll use it to explore a different aspect of life and death in C#. Struct is short for <strong>structure</strong>, and structs look a lot like objects. They have fields and properties, just like objects. And you can even pass them into a method that takes an object type parameter:</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg599-1.png"/>
<h6/>
</div></figure>
<section data-pdf-bookmark="...but isn’t an object" data-type="sect2"><div class="sect2" id="hellipbut_isnapostrophet_an_object">
<h2>...but <u>isn’t</u> an object</h2>
<p>But structs <strong><em>aren’t</em></strong> objects. They <em>can</em> have methods and fields, but they <em>can’t</em> have finalizers. They also can’t inherit from classes or other structs, or have classes or structs inherit from them—you’re allowed to use the : colon operator in a struct’s declaration, but only if it’s followed by one or more interfaces.</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg599-2.png"/>
<h6/>
</div></figure>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><strong>All structs extend System.ValueType, which in turn extends System.Object. That’s why every struct has a ToString method—it gets it from Object. But that’s <span style="color:#9D9EA0;"><u>the only inheriting</u></span> that structs are allowed to do.</strong></p>
</div>
<blockquote>
<p><strong>The power of objects lies in their ability to mimic real-world behavior, through inheritance and polymorphism.</strong></p>
</blockquote>
<blockquote>
<p><strong>Structs are best used for storing data, but the lack of inheritance and references can be a serious limitation.</strong></p>
</blockquote>
</div></section>
</div></section>
<section data-pdf-bookmark="Values get copied; references get assigned" data-type="sect1"><div class="sect1" id="values_get_copied_references_get_assigne">
<h1>Values get copied; references get assigned</h1>
<p><a data-primary="garbage collection" data-type="indexterm" id="idm46402338661192"/><a data-primary="objects" data-secondary="value types versus" data-type="indexterm" id="idm46402338655512"/><a data-primary="references" data-secondary="versus values" data-type="indexterm" id="idm46402338654440"/><a data-primary="values" data-type="indexterm" id="idm46402338653368"/><a data-primary="value types" data-secondary="versus objects" data-type="indexterm" id="idm46402338652536"/>We’ve seen how important references are to garbage collection—reassign the last reference to an object, and it gets marked for collection. But we also know that those rules don’t quite make sense for values. If we want to get a better sense of how objects and values live and die in the CLR’s memory, we’ll need to take a closer look at values and references: how they’re similar, and more importantly, how they’re different.</p>
<p>You already have a sense of how some types are different from others. On the one hand you’ve got <strong>value types</strong> like int, bool, and decimal. On the other hand, you’ve got <strong>objects</strong> like List, Stream, and Exception. And they don’t quite work exactly the same way, do they?</p>
<p>When you use the equals sign to set one value type variable to another, it <strong>makes a copy of the value</strong>, and afterward, the two variables aren’t connected to each other. On the other hand, when you use the equals sign with references, what you’re doing is <strong>pointing both references at the same object</strong>.</p>
<ul>
<li><p>Variable declaration and assignment work the same with value types and object types:</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg600-1.png"/>
<h6/>
</div></figure>
</li>
<li><p>But once you start assigning values, you can see how they’re different. Value types all are handled with copying. Here’s an example—this should be familiar stuff:</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg600-2.png"/>
<h6/>
</div></figure>
<p>The output here shows that <code>fifteenMore</code> and <code>howMany</code> are <strong><em>not</em></strong> connected:</p></li>
<li><p>But as we know, when it comes to objects you’re assigning references, not values:</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg601-1.png"/>
<h6/>
</div></figure>
</li>
</ul>
<p>So changing the List means both references see the update, since they both point to a single List object. Check this by writing a line of output:</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg601-2.png"/>
<h6/>
</div></figure>
<p>The output here demonstrates that <code>copy</code> and <code>temps</code> are actually pointing to the <strong><em>same</em></strong> object:</p>
<pre data-type="programlisting">temps has <u>3</u>, copy has <u>3</u></pre>
</div></section>
<section data-pdf-bookmark="Structs are value types; objects are reference types" data-type="sect1"><div class="sect1" id="structs_are_value_types_objects_are_refe">
<h1>Structs are <u>value</u> types; objects are <u>reference</u> types</h1>
<p><a data-primary="objects" data-secondary="versus structs" data-type="indexterm" id="idm46402338629144"/><a data-primary="structs" data-secondary="versus objects" data-type="indexterm" id="idm46402338627752"/><a data-primary="value types" data-secondary="structs as" data-type="indexterm" id="idm46402338626728"/>Let’s take a closer look at how structs work, so you can start to understand when you might want to use a struct versus an object. When you create a struct, you’re creating a <strong>value type</strong>. What that means is when you use equals to set one struct variable equal to another, you’re creating a fresh <em>copy</em> of the struct in the new variable. So even though a struct <em>looks</em> like an object, it doesn’t act like one.</p>
<p><strong><em>Do this!</em></strong></p>
<ol>
<li><p><strong>Create a struct called Dog.</strong></p>
<p>Here’s a simple struct to keep track of a dog. It looks just like an object, but it’s not. Add it to a <strong>new console application:</strong></p>
<pre data-type="programlisting">  public struct Dog {

    public string Name { get; set; }
    public string Breed { get; set; }

    public Dog(string name, string breed) {
      this.Name = name;
      this.Breed = breed;
    }

    public void Speak() {
        Console.WriteLine("My name is {0} and I’m a {1}.", Name, Breed);
    }
  }</pre></li>
<li><p><strong>Create a class called Canine.</strong></p>
<p>Make an exact copy of the Dog struct, except <strong>replace <code>struct</code> with <code>class</code></strong> and then <strong>replace Dog with Canine</strong>. Don’t forget to rename Dog’s constructor. Now you’ll have a Canine <em>class</em> that you can play with, which is almost exactly equivalent to the Dog <em>struct</em>.</p></li>
<li><p><strong>Add a Main method that makes some copies of Dog and Canine data.</strong></p>
<p>Here’s the code for the Main method:</p>
<pre data-type="programlisting">  Canine spot = new Canine("Spot", "pug");
  Canine bob = spot;
  bob.Name = "Spike";
  bob.Breed = "beagle";
  spot.Speak();
  Dog jake = new Dog("Jake", "poodle");
  Dog betty = jake;
  betty.Name = "Betty";
  betty.Breed = "pit bull";
  jake.Speak();</pre></li>
<li><p><strong>Before you run the program...</strong></p>
<p>Write down what you think will be written to the console when you run this code:</p>
<p>...................................................................................</p>
<p>...................................................................................</p></li>
</ol>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/601fig01a.png"/>
<h6/>
</div></figure>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg602.png"/>
<h6/>
</div></figure>
<section data-pdf-bookmark="Here’s what happened..." data-type="sect2"><div class="sect2" id="hereapostrophes_what_happenedhellip">
<h2>Here’s what happened...</h2>
<p><a data-primary="structs" data-secondary="setting one equal to another" data-type="indexterm" id="idm46402338606472"/>The <code>bob</code> and <code>spot</code> references both point to the same object, so both changed the same fields and accessed the same Speak method. But structs don’t work that way. When you created <code>betty</code>, you made a fresh copy of the data in <code>jake</code>. The two structs are completely independent of each other.</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg602-1.png"/>
<h6/>
</div></figure>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg602-2.png"/>
<h6/>
</div></figure>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><strong>When you set one struct equal to another, you’re creating a fresh <u>COPY</u> of the data inside the struct. That’s because struct is a <u>VALUE TYPE</u> (not an object or reference type).</strong></p>
</div>
</div></section>
</div></section>
<section data-pdf-bookmark="The stack vs. the heap: more on memory" data-type="sect1"><div class="sect1" id="the_stack_vsdot_the_heap_more_on_memory">
<h1>The stack vs. the heap: more on memory</h1>
<p><a data-primary="CLR (Common Language Runtime)" data-type="indexterm" id="idm46402338595112"/><a data-primary="garbage collection" data-type="indexterm" id="idm46402338594024"/><a data-primary="memory" data-secondary="stack versus heap" data-type="indexterm" id="idm46402338593176"/>Let’s quickly recap how a struct differs from an object. You’ve seen that you can make a fresh copy of a struct just using equals, which you can’t do with an object. But what’s really going on behind the scenes?</p>
<p>The CLR divides your data between two places in memory: the heap and the stack. You already know that objects live on the <strong>heap</strong>. The CLR also reserves another part of memory called the <code>stack</code>, where it stores the local variables you declare in your methods and the parameters that you pass into those methods. You can think of the stack as a bunch of slots that you can stick values in. When a method gets called, the CLR adds more slots to the top of the stack. When it returns, its slots are removed.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="behind_the_scenes-idd0004">
<h5><span class="inlineimage"><img alt="Images" src="assets/icon5.png"/></span> Behind the Scenes</h5>
<p><span style="color:#9D9EA0;">Remember, when your program’s running, the CLR is actively managing memory, dealing with the heap, and collecting garbage.</span></p>
</div></aside>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg603-1.png"/>
<h6/>
</div></figure>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg604-1.png"/>
<h6/>
</div></figure>
<p><a data-primary="boxed objects and structs" data-type="indexterm" id="idm46402338582584"/><a data-primary="objects" data-secondary="boxed" data-type="indexterm" id="idm46402338581528"/><a data-primary="structs" data-secondary="boxed" data-type="indexterm" id="idm46402338580408"/><strong>It’s important to understand how a struct you copy by value is different from an object you copy by reference.</strong></p>
<p>There are times when you need to be able to write a method that can take either a value type <strong><em>or</em></strong> a reference type—perhaps a method that can work with either a Dog struct or a Canine object. If you find yourself in that situation, you can use the <code>object</code> keyword:</p>
<pre data-type="programlisting">   public void WalkDogOrCanine(object getsWalked) { ... }</pre>
<p>If you send this method a struct, the struct gets <strong>boxed</strong> into a special object “wrapper” that allows it to live on the heap. While the wrapper’s on the heap, you can’t do much with the struct. You have to “unwrap” the struct to work with it. Luckily, all of this happens <em>automatically</em> when you set an object equal to a value type, or pass a value type into a method that expects an object.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><span style="color:#9D9EA0;">You can also use the “is” keyword to see if an object is a struct, or any other value type, that’s been boxed and put on the heap.</span></p>
</div>
<ol>
<li><p>Here’s what the stack and heap look like after you create an object variable and set it equal to a Dog struct.</p>
<pre data-type="programlisting">Dog sid = new Dog("Sid", "husky");
WalkDogOrCanine(sid);</pre>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg604-2.png"/>
<h6/>
</div></figure>
</li>
<li><p>If you want to <strong>unbox the object</strong>, all you need to do is cast it to the right type, and it gets unboxed automatically. The <code>is</code> keyword works just fine with structs, but be careful, because the <code>as</code> keyword doesn’t work with value types.</p>
<pre data-type="programlisting">if (getsWalked is Dog doggo) doggo.Speak();</pre>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg604-3.png"/>
<h6/>
</div></figure>
</li>
</ol>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="behind_the_scenes-idd0005">
<h5><span class="inlineimage"><img alt="Images" src="assets/icon5.png"/></span> Behind the Scenes</h5>
<p><a data-primary="CLR (Common Language Runtime)" data-type="indexterm" id="idm46402338561064"/><strong>When a method is called, it looks for its arguments on the stack.</strong></p>
<p>The stack plays an important part in how the CLR manages your app’s data. One thing we take for granted is the fact that we can write a method that calls another method, which in turn calls another method. In fact, a method can call itself (which is called <em>recursion</em>). The stack is what gives our programs the ability to do that.</p>
<p>Here are three methods from a dog simulator program. The FeedDog method calls the Eat method, which calls the CheckBowl method.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><span style="color:#9D9EA0;">Remember the terminology here: a parameter specifies the values a method needs; an argument is the actual value or reference that you pass into a method when you call it.</span></p>
</div>
<p>Here’s what the stack looks like as FeedDog calls Eat, which calls CheckBowl, which in turn calls Console.WriteLine().</p>
<pre data-type="programlisting">public double FeedDog(Canine dogToFeed, Bowl dogBowl) {
    double eaten = Eat(dogToFeed.MealSize, dogBowl);
    return eaten + .05D; // A little is always spilled
}

public void Eat(double mealSize, Bowl dogBowl) {
    dogBowl.Capacity -= mealSize;
    CheckBowl(dogBowl.Capacity);
}

public void CheckBowl(double capacity) {
    if (capacity &lt; 12.5D) {
        string message = "My bowl’s almost empty!";
        Console.WriteLine(message);
    }
}</pre>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg605.png"/>
<h6/>
</div></figure>
</div></aside>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg605-5.png"/>
<h6/>
</div></figure>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><strong>Go to a Unity project and hover over Vector3—it’s a struct. Garbage collection (or GC) can seriously slow down an app’s performance, and a lot of object instances in your game could trigger extra GCs and slow down the frame rate. Games often use a LOT of vectors. Making them structs means their data is kept on the stack, so even creating millions of vectors won’t cause extra GCs that will slow down your game.</strong></p>
</div>
</div></section>
<section data-pdf-bookmark="Use out parameters to make a method return more than one value" data-type="sect1"><div class="sect1" id="use_out_parameters_to_make_a_method_retu">
<h1>Use <u>out</u> parameters to make a method return more than one value</h1>
<p><a data-primary="methods" data-secondary="returning more than one value with out parameters" data-type="indexterm" id="idm46402338549096"/><a data-primary="out parameters" data-type="indexterm" id="idm46402338547640"/>Speaking of parameters and arguments, there are a few more ways that you can get values into and out of your programs. They all involve adding <strong>modifiers</strong> to your method declarations. One of the most common ways of doing this is by using the <strong><code>out</code> modifier</strong> to specify an output parameter. You’ve seen the <code>out</code> modifier many times—you use it every time you call the int.TryParse method. You can also use the <code>out</code> modifier in your own methods. Create a new console app and add this empty method declaration to the form. Note the <code>out</code> modifiers on both parameters:</p>
<p><strong><em>Do this!</em></strong></p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg606-1.png"/>
<h6/>
</div></figure>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><strong>A method can return more than one value by using <span style="color:#9D9EA0;">out</span> parameters.</strong></p>
</div>
<p>Take a closer look at those two errors:</p>
<ul>
<li><p><em>The out parameter ‘half’ must be assigned to before control leaves the current method</em></p></li>
<li><p><em>The out parameter ‘twice’ must be assigned to before control leaves the current method</em></p></li>
</ul>
<p>Any time you use an <code>out</code> parameter, you <strong><em>always</em></strong> need to set it before the method returns—just like you always need to use a <code>return</code> statement if your method is declared with a return value.</p>
<p>Here’s all of the code for the app::</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg606-2.png"/>
<h6/>
</div></figure>
<p>Here’s what it looks like when you run the app:</p>
<pre data-type="programlisting">Enter a number: 17
Outputs: plus one = 18, half = 8.50, twice = 34</pre>
</div></section>
<section data-pdf-bookmark="Pass by reference using the ref modifier" data-type="sect1"><div class="sect1" id="pass_by_reference_using_the_ref_modifier">
<h1>Pass by reference using the ref modifier</h1>
<p><a data-primary="methods" data-secondary="passing arguments by reference" data-type="indexterm" id="idm46402338527960"/><a data-primary="references" data-secondary="passing by reference using ref modifier" data-type="indexterm" id="idm46402338526376"/><a data-primary="ref keyword" data-type="indexterm" id="idm46402338525224"/><a data-primary="TryParse method" data-type="indexterm" id="idm46402338524424"/><a data-primary="value types" data-secondary="TryParse method" data-type="indexterm" id="idm46402338523608"/>One thing you’ve seen over and over again is that every time you pass an int, double, struct, or any other value type into a method, you’re passing a copy of that value to that method. There’s a name for that: <strong>pass by value</strong>, which means that the entire value of the argument is copied.</p>
<p>But there’s another way to pass arguments into methods, and it’s called <strong>pass by reference</strong>. You can use the <code><strong>ref</strong></code> keyword to allow a method to work directly with the argument that’s passed to it. Just like the <code>out</code> modifier, you need to use <code><strong>ref</strong></code> when you declare the method and also when you call it. It doesn’t matter if it’s a value type or a reference type, either—any variable that you pass to a method’s <code>ref</code> parameter will be directly altered by that method.</p>
<p>To see how it works, create a new console app with this Guy class and these methods:</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><span style="color:#9D9EA0;">Under the hood, an “out” argument is just like a “ref” argument, except that it doesn’t need to be assigned before going into the method, and must be assigned before the method returns.</span></p>
</div>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg607.png"/>
<h6/>
</div></figure>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="value_types_have_a_tryparse_method_that">
<h5>Value types have a TryParse method that uses out parameters</h5>
<p><strong>You’ve been using int.TryParse to convert strings to int values (“parsing” means analyzing text and extracting values). Other value types have similar functions: double.TryParse will attempt to convert strings to double values, bool.TryParse will do the same for Boolean values, and so on for decimal.TryParse, float.TryParse, long.TryParse, byte.TryParse, and more. And remember back in <a href="ch10.html#reading_and_writing_files_save_the_last">#reading_and_writing_files_save_the_last</a> when we used a <code>switch</code> statement to convert the string “Spades” into a Suits.Spades enum value? Well, the static Enum.TryParse method does the same thing, except for enums.</strong></p>
</div></aside>
</div></section>
<section data-pdf-bookmark="Use optional parameters to set default values" data-type="sect1"><div class="sect1" id="use_optional_parameters_to_set_default_v">
<h1>Use optional parameters to set default values</h1>
<p><a data-primary="methods" data-secondary="optional parameters, using to set default values" data-type="indexterm" id="idm46402338510376"/><a data-primary="optional parameters, using to set default values" data-type="indexterm" id="idm46402338508888"/>A lot of times, your methods will be called with the same arguments over and over again, but the method still needs the parameter because occasionally it changes. It would be useful if you could set a <em>default value</em>, so you only needed to specify the argument when calling the method if it was different.</p>
<p>That’s exactly what <strong>optional parameters</strong> do. You can specify an optional parameter in a method declaration by using an equals sign followed by the default value for that parameter. You can have as many optional parameters as you want, but all of the optional parameters have to come after the required parameters.</p>
<p>Here’s an example of a method that uses optional parameters to check if someone has a fever:</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg608.png"/>
<h6/>
</div></figure>
<p>This method has two optional parameters: <code>tooHigh</code> has a default value of 99.5, and <code>tooLow</code> has a default value of 96.5. Calling CheckTemperature with one argument uses the default values for both <code>tooHigh</code> and <code>tooLow</code>. If you call it with two arguments, it will use the second argument for the value of <code>tooHigh</code>, but still use the default value for <code>tooLow</code>. You can specify all three arguments to pass values for all three parameters.</p>
<p>If you want to use some (but not all) of the default values, you can use <strong>named arguments</strong> to pass values for just those parameters that you want to pass. All you need to do is give the name of each parameter followed by a colon and its values. If you use more than one named argument, make sure you separate them with commas, just like any other arguments.</p>
<p><strong>Add the CheckTemperature method to a console app</strong>, then add this Main method:</p>
<pre data-type="programlisting">static void Main(string[] args)
{
    // Those values are fine for your average person
    CheckTemperature(101.3);

    // A dog’s temperature should be between 100.5 and 102.5 Fahrenheit
    CheckTemperature(101.3, 102.5, 100.5);

    // Bob’s temperature is always a little low, so set tooLow to 95.5
    CheckTemperature(96.2, tooLow: 95.5);
}</pre>
<p>It prints this output, working differently based on different values for the optional parameters:</p>
<pre data-type="programlisting">Uh-oh 101.3 degrees F -- better see a doctor!
101.3 degrees F - feeling good!
96.2 degrees F - feeling good!</pre>
<blockquote>
<p><strong>Use optional parameters and named arguments when you want your methods to have default values.</strong></p>
</blockquote>
</div></section>
<section data-pdf-bookmark="A null reference doesn’t refer to any object" data-type="sect1"><div class="sect1" id="a_null_reference_doesnapostrophet_refer">
<h1>A <u>null reference</u> doesn’t refer to any object</h1>
<p><a data-primary="null" data-type="indexterm" id="idm46402338490808"/><a data-primary="null reference" data-type="indexterm" id="idm46402338489864"/><a data-primary="NullReferenceException (NRE)" data-type="indexterm" id="idm46402338488984"/>When you create a new reference and don’t set it to anything, it has a value. It starts off set to <code><strong>null</strong></code>, which means it’s not pointing to anything. Let’s experiment with null references.</p>
<p><strong><em>Do this!</em></strong></p>
<ol>
<li><p><strong>Create a new console app</strong> and add the Guy class you used to experiment with the <code>ref</code> keyword.</p></li>
<li><p>Then <strong>add this code</strong> that creates a new Guy object but <em><u>doesn’t set</u> its Name property:</em></p>
<pre data-type="programlisting">static void Main(string[] args)
{
    Guy guy;
    guy = new Guy() { Age = 25 };
    Console.WriteLine("guy.Name is {0} letters long", guy.Name.Length);
}</pre></li>
<li><p><strong>Place a breakpoint</strong> on the last line of the Main method, then debug your app.</p>
<p>When it hits the breakpoint, <strong>hover over <code>guy</code></strong> to inspect its property values:</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg609-1.png"/>
<h6/>
</div></figure>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><span style="color:#9D9EA0;">String is a reference type. Since you didn’t set its value in the Guy object, it still has its default value: null.</span></p>
</div></li>
<li><p><strong>Continue running the code.</strong> Console.WriteLine tries to access the Length property of the String object referenced by the guy.Name property, and throws an exception:</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg609-2.png"/>
<h6/>
</div></figure>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><strong>When the CLR throws a <span style="color:#9D9EA0;"><u>NullReferenceException</u></span> (which developers often refer to as an <span style="color:#9D9EA0;"><u>NRE</u></span>) it’s telling you that it tried to access a member of an object, but the reference that it used to access that member was null. Developers <span style="color:#9D9EA0;"><u>try to prevent</u></span> null reference exceptions.</strong></p>
</div></li>
</ol>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="brain_power-idd0027">
<h5><span class="inlineimage"><img alt="Images" src="assets/brainpower.png"/></span> Brain Power</h5>
<p>Can you think of some ways to prevent null reference exceptions?</p>
</div></aside>
</div></section>
<section data-pdf-bookmark="Non-nullable reference types help you avoid NREs" data-type="sect1"><div class="sect1" id="non_nullable_reference_types_help_you_av">
<h1>Non-nullable reference types help you avoid NREs</h1>
<p><a data-primary="encapsulation" data-secondary="using to prevent null properties" data-type="indexterm" id="idm46402338464856"/><a data-primary="non-nullable reference types" data-type="indexterm" id="idm46402338463448"/>The easiest way to avoid null reference exceptions (or NREs) is to <strong>design your code so references can’t be null</strong>. Luckily, the C# compiler gives you a really useful tool to help deal with nulls. Add the following code to the top of your Guy class—it can be either inside or outside the namespace declaration:</p>
<pre data-type="programlisting"><span style="color:#9D9EA0;">#nullable enable</span></pre>
<p>A line that starts with # is a <strong>directive</strong>, or a way to tell the compiler to set specific options. In this case, it’s telling the compiler to treat any reference as a <strong>non-nullable reference type</strong>. As soon as you add the directive, Visual Studio draws a warning squiggle under the Name property. Hover over the property to see the warning:</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg610-1.png"/>
<h6/>
</div></figure>
<p>The C# compiler did something really interesting: it used <em>flow analysis</em> (or a way of analyzing the various paths through the code) to determine that <strong><em>it’s possible for the Name property to be assigned a null value</em></strong>. That means your code could potentially throw an NRE.</p>
<p>You can get rid of the warning by <u>forcing</u> the Name property to be a <strong>nullable reference type</strong>. You can do this by adding a <code>?</code> character after the type:</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg610-2.png"/>
<h6/>
</div></figure>
<p>But while that gets rid of the error message, it doesn’t actually prevent any exceptions.</p>
<section data-pdf-bookmark="Use encapsulation to prevent your property from ever being null" data-type="sect2"><div class="sect2" id="use_encapsulation_to_prevent_your_proper">
<h2>Use encapsulation to prevent your property from ever being null</h2>
<p>Back in <a href="ch05.html#encapsulation_keep_your_privateshellippr">#encapsulation_keep_your_privateshellippr</a> you learned all about how to use encapsulation to keep your class members from having invalid values. So go ahead and make the Name property private, then add a constructor to set its value:</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg610-3.png"/>
<h6/>
</div></figure>
<p>Once you encapsulate the Name property, you prevent it from ever being set to <code>null</code>, and the warning disappears.</p>
</div></section>
</div></section>
<section data-pdf-bookmark="The null-coalescing operator ?? helps with nulls" data-type="sect1"><div class="sect1" id="the_null_coalescing_operator_question_ma">
<h1>The null-coalescing operator ?? helps with nulls</h1>
<p><a data-primary="null-coalescing operator (??)" data-type="indexterm" id="idm46402338443912"/>Sometimes you can’t avoid working with nulls. For example, you learned about reading data from strings using StringReader in <a href="ch10.html#reading_and_writing_files_save_the_last">#reading_and_writing_files_save_the_last</a>. Create a new console app and add this code:</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg611-1.png"/>
<h6/>
</div></figure>
<p>Run the code—you’ll get an NRE. What can we do about it?</p>
<section data-pdf-bookmark="?? checks for null and returns an alternative" data-type="sect2"><div class="sect2" id="question_markquestion_mark_checks_for_nu">
<h2>?? checks for null and returns an alternative</h2>
<p>One way to prevent a null reference from being accessed (or <strong>dereferenced</strong>) is to use the <strong>null-coalescing operator</strong> <strong>??</strong> to evaluate the potentially null expression—in this case, calling stringReader.ReadLine—and returning an alternative value if it’s null. Modify the first line of the <code>using</code> block to add  <code>?? String.Empty</code> to the end of the line:</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg611-2.png"/>
<h6/>
</div></figure>
<p>And as soon as you add this, the warning goes away. That’s because the null coalescing operator tells the C# compiler to execute stringReader.ReadLine;  and use the value it returns if it’s non-null, but substitute the value you provided (in this case, an empty string) if it is.</p>
</div></section>
<section data-pdf-bookmark="??= assigns a value to a variable only if it’s null" data-type="sect2"><div class="sect2" id="question_markquestion_markequals_assigns">
<h2>??= assigns a value to a variable only if it’s null</h2>
<p>When you’re working with null values, it’s really common to write code that checks if a value is null and assigns it a non-null value to avoid an NRE. For example, if you wanted to modify your program to print the first line of code, you might write this:</p>
<pre data-type="programlisting">     if (nextLine == null)
         nextLine = "(the first line is null)";

     // Code that works with nextLine and needs it to be non-null</pre>
<p>You can rewrite that conditional statement using the <strong>null assignment</strong> <strong>??=</strong> operator:</p>
<pre data-type="programlisting">        nextLine ??= "(the first line was empty)";</pre>
<p>The ??= operator checks the variable, property, or field on the left side of the expression (in this case, nextLine) to see if it’s null. If it is, the operator assigns the value on the right side of the expression to it. If not, it leaves the value intact.</p>
</div></section>
</div></section>
<section data-pdf-bookmark="Nullable value types can be null...and handled safely" data-type="sect1"><div class="sect1" id="nullable_value_types_can_be_nullhellipan">
<h1>Nullable value types can be null...and handled safely</h1>
<p><a data-primary="Nullable&lt;T&gt;" data-type="indexterm" id="idm46402338425016"/><a data-primary="T? alias for Nullable&lt;T&gt;" data-type="indexterm" id="idm46402338423576"/><a data-primary="value types" data-secondary="nullable xxv" data-type="indexterm" id="idm46402338422808"/>When you declare an int, bool, or another value type, if you don’t specify a value the CLR assigns it a default value like 0 or true. But let’s say you’re writing code to store data from a survey where there’s a yes/no question that’s optional. What if you need to represent a Boolean value that could be true or false, or not have a value at all?</p>
<p>That’s where <strong>nullable value types</strong> can be very useful. A nullable value type can either have a value or be set to null. It takes advantage of a generic struct Nullable&lt;T&gt; that can be used to <strong><em>wrap</em></strong> a value (or contain the value and provide members to access and work with it). If you set a nullable value type to null, it doesn’t have a value—and Nullable&lt;T&gt; gives you handy members to let you work safely with it <em>even in this case</em>.</p>
<p>You can declare a nullable Boolean value like this:</p>
<pre data-type="programlisting">    Nullable&lt;bool&gt; optionalYesNoAnswer = null;</pre>
<p>C# also has a shortcut—for a value type T, you can declare Nullable&lt;T&gt; like this: <strong>T?</strong>.</p>
<pre data-type="programlisting">    bool? anotherYesNoAnswer = false;</pre>
<p>The Nullable&lt;T&gt; struct has a property called Value that gets or sets the value. A bool? will have a value of type bool, an int? will have one of type int, etc. They’ll also have a property called HasValue that returns true if it’s not null.</p>
<p>You can always convert a value type to a nullable type:</p>
<pre data-type="programlisting">    int? myNullableInt = 9321;</pre>
<p>And you can get the value back using its handy Value property:</p>
<pre data-type="programlisting">    int = myNullableInt.Value;</pre>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg612-1.png"/>
<h6/>
</div></figure>
<p>But the Value call eventually just casts the value with <code>(int)myNullableInt</code>—and it will throw an InvalidOperationException if the value is null. That’s why Nullable&lt;T&gt; also has a HasValue property, which returns true if the value is not null, and false if it is. You can also use the convenient GetValueOrDefault method, which safely returns a default value if the Nullable has no value. You can optionally pass it a default value to use, or use the type’s normal default value.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="tquestion_mark_is_an_alias_for_nullablel">
<h5>T? is an alias for Nullable&lt;T&gt;</h5>
<p><strong>When you add a question mark to any value type (like int? or decimal?), the compiler translates that to the Nullable&lt;T&gt; struct (Nullable&lt;int&gt; or Nullable&lt;decimal&gt;). You can see this for yourself: add a Nullable&lt;bool&gt; variable to a program, put a breakpoint on it, and add a watch for it in the debugger. You’ll see bool? displayed in the Watch window in the IDE. This is an example of an aliasalias, and it’s not the first one you’ve encountered. Hover your cursor over any int. You’ll see that it translates to a struct called System.Int32:</strong></p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg612-2.png"/>
<h6/>
</div></figure>
<p><strong>Take a minute and do that for each of the types at the beginning of <a href="ch04.html#types_and_references_getting_the_referen">#types_and_references_getting_the_referen</a>. Notice how all of them are aliases for structs—except for string, which is a class called System.String, not a value type.</strong></p>
</div></aside>
</div></section>
<section data-pdf-bookmark="“Captain” Amazing...not so much" data-type="sect1"><div class="sect1" id="quotation_markcaptainquotation_mark_amaz">
<h1>“Captain” Amazing...not so much</h1>
<p><a data-primary="as keyword" data-type="indexterm" id="idm46402338400072"/><a data-primary="boxed objects and structs" data-type="indexterm" id="idm46402338408312"/><a data-primary="Captain Amazing" data-type="indexterm" id="idm46402338407544"/><a data-primary="objects" data-secondary="versus structs" data-type="indexterm" id="idm46402338406776"/><a data-primary="structs" data-secondary="boxed" data-type="indexterm" id="idm46402338405736"/>You should have a pretty good idea by now of what was going on with the less-powerful, more-tired Captain Amazing. In fact, it wasn’t Captain Amazing at all, but a boxed struct:</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg613.png"/>
<h6/>
</div></figure>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="there_are_no_dumb_questions-idd0038">
<h5>there are no Dumb Questions</h5>
<p><a data-primary="boxed objects and structs" data-type="indexterm" id="idm46402338393064"/><a data-primary="classes" data-secondary="versus structs" data-type="indexterm" id="idm46402338391992"/><a data-primary="CLR (Common Language Runtime)" data-type="indexterm" id="idm46402338390840"/><a data-primary="encapsulation" data-secondary="about" data-type="indexterm" id="idm46402338390040"/><a data-primary="garbage collection" data-type="indexterm" id="idm46402338388888"/><a data-primary="stacks" data-secondary="about" data-type="indexterm" id="idm46402338388056"/><a data-primary="structs" data-secondary="setting one equal to another" data-type="indexterm" id="idm46402338386936"/><a data-primary="structs" data-secondary="versus classes" data-type="indexterm" id="idm46402338385784"/><strong>Q: OK, back up a minute. Why do I care about the stack?</strong></p>
<p><strong>A:</strong> Because understanding the difference between the stack and the heap helps you keep your reference types and value types straight. It’s easy to forget that structs and objects work very differently—when you use the equals sign with both of them, they look really similar. Having some idea of how .NET and the CLR handle things under the hood helps you understand <strong><em>why</em></strong> reference and value types are different.</p>
<p><strong>Q: And boxing? Why is that important to me?</strong></p>
<p><strong>A:</strong> Because you need to know when things end up on the stack, and you need to know when data’s being copied back and forth. Boxing takes extra memory and more time. When you’re only doing it a few times (or a few hundred times) in your program, then you won’t notice the difference. But let’s say you’re writing a program that does the same thing over and over again, millions of times a second. That’s not too far-fetched: your Unity games might do exactly that. If you find that your program’s taking up more and more memory, or going slower and slower, then it’s possible that you can make it more efficient by avoiding boxing in the part of the program that repeats.</p>
<p><strong>Q: I get how you get a fresh copy of a struct when you set one struct variable equal to another one. But why is that useful to me?</strong></p>
<p>A: One place that’s really helpful is with <strong>encapsulation</strong>. Take a look at this code:</p>
<pre data-type="programlisting">private Point location;
public Point Location {
  get { return location; }
}</pre>
<p>If Point were a class, then this would be terrible encapsulation. It wouldn’t matter that location is private, because you made a public read-only property that returns a reference to it—so any other object would be able to access it.</p>
<p>Lucky for us, Point happens to be a struct. And that means that the public Location property returns a fresh copy of the point. The object that uses it can do whatever it wants to that copy—none of those changes will make it to the private location field.</p>
<p><strong>Q: How do I know whether to use a struct or a class?</strong></p>
<p><strong>A:</strong> Most of the time, programmers use classes. Structs have a lot of limitations that can really make it hard to work with them for large jobs. They don’t support inheritance or abstraction, and only limited polymorphism, and you already know how important those things are for writing code.</p>
<p>Where structs come in really handy is if you have a small, limited type of data that you need to work with repeatedly. Unity vectors are good examples—some games will use them over and over again, possibly millions of times. Reusing a vector by assigning it to the same variable reuses that same memory on the stack. If Vector3 were a class, then the CLR would have to allocate new memory on the heap for each new Vector3, and it would constantly be garbage-collecting. So by making Vector3 a struct and not a class, the team that develops Unity gave you the gift of higher frame rates—without you having to do a thing.</p>
</div></aside>
<blockquote>
<p><strong>A struct can be valuable for encapsulation, because a read-only property that returns a struct always makes a fresh copy of it.</strong></p>
</blockquote>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="mini_sharpen_your_pencil">
<h5><span class="inlineimage"><img alt="Images" src="assets/Common.png"/></span> Mini Sharpen your pencil</h5>
<p>This method is supposed to kill an Evil<code>Clone</code> object by marking it for GC, but it doesn’t work. Why not?</p>
<pre data-type="programlisting"><strong>void SetCloneToNull(EvilClone clone) =&gt; clone = null;</strong></pre>
<p>......................................................................................</p>
<p>......................................................................................</p>
</div></aside>
</div></section>
<section data-pdf-bookmark="Pool Puzzle" data-type="sect1"><div class="sect1" id="pool_puzzle-idd0003">
<h1>Pool Puzzle</h1>
<p>Your <strong>job</strong> is to take snippets from the pool and place them into the blank lines in the code. You <strong>may</strong> use the same snippet more than once, and you won’t need to use all the snippets. Your <strong>goal</strong> is to make the code write the output shown below to the console when this app is executed.</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg615.png"/>
<h6/>
</div></figure>
</div></section>
<section data-pdf-bookmark="Pool Puzzle Solution" data-type="sect1"><div class="sect1" id="pool_puzzle_solution-idd0003">
<h1>Pool Puzzle Solution</h1>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg616-1.png"/>
<h6/>
</div></figure>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="mini_sharpen_your_pencil_solutio-idd0001">
<h5><span class="inlineimage"><img alt="Images" src="assets/pencil.png"/></span> MiNi Sharpen your pencil Solution</h5>
<p>This method is supposed to kill an EvilClone object by marking it for GC, but it doesn’t work. Why not?</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg616-2.png"/>
<h6/>
</div></figure>
</div></aside>
</div></section>
<section data-pdf-bookmark="Extension methods add new behavior to EXISTING classes" data-type="sect1"><div class="sect1" id="extension_methods_add_new_behavior_to_ex">
<h1>Extension methods add new behavior to <u>EXISTING</u> classes</h1>
<p><a data-primary="extension methods" data-type="indexterm" id="idm46402338351928"/><a data-primary=".NET Framework" data-secondary="sealed classes" data-type="indexterm" id="idm46402338350840"/><a data-primary="this keyword" data-secondary="in extension method’s first parameter" data-type="indexterm" id="idm46402338349688"/>Sometimes you need to extend a class that you can’t inherit from, like a sealed class (a lot of the .NET classes are sealed, so you can’t inherit from them). And C# gives you a flexible tool for that:  <strong>extension methods</strong>. When you add a class with extension methods to your project, it <strong>adds new methods that appear on classes</strong> that already exist. All you have to do is create a static class, and add a static method that accepts an instance of the class as its first parameter using the this keyword.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><span style="color:#9D9EA0;">Remember the sealed modifier from <a href="ch07.html#interfacescomma_castingcomma_and_quotati">#interfacescomma_castingcomma_and_quotati</a>? It’s how you set up a class that can’t be extended.</span></p>
</div>
<p>So let’s say you’ve got a sealed OrdinaryHuman class:</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg617.png"/>
<h6/>
</div></figure>
<p>As soon as the AmazeballsSerum class is added to the project, OrdinaryHuman gets a BreakWalls method. So now your Main method can use it:</p>
<pre data-type="programlisting">static void Main(string[] args){
    OrdinaryHuman steve = new OrdinaryHuman(185);
    Console.WriteLine(steve.BreakWalls(89.2));
}</pre>
<p>And that’s it! All you need to do is add the AmazeballsSerum class to your project, and suddenly every OrdinaryHuman class gets a brand-new BreakWalls method.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><strong>When the program creates an instance of the OrdinaryHuman class, it can access the BreakWalls method directly—as long as the AmazeballsSerum class is in the project. Go ahead, try it out! <span style="color:#9D9EA0;"><u>Create a new console application</u></span> and add the two classes and the Main method to it. Debug into the BreakWalls method and see what’s going on.</strong></p>
</div>
<p><strong><em>Hmm...earlier in the book we “magically” added methods to classes just by adding a <code>using</code> directive to the top of our code. Do you remember where that was?</em></strong></p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="there_are_no_dumb_questions-idd0039">
<h5>there are no Dumb Questions</h5>
<p><a data-primary="extension methods" data-type="indexterm" id="idm46402338334840"/><a data-primary="LINQ (Language Integrated Query)" data-type="indexterm" id="idm46402338333912"/><a data-primary="LINQ (Language Integrated Query)" data-secondary="about" data-type="indexterm" id="idm46402338333176"/><a data-primary="queries" data-see="LINQ (Language Integrated Query)" data-type="indexterm" id="idm46402338332024"/><strong>Q: Tell me again why I wouldn’t add the new methods I need directly to my class code, instead of using extensions?</strong></p>
<p><strong>A:</strong> You could do that, and you probably should if you’re just talking about adding a method to one class. Extension methods should be used pretty sparingly, and only in cases where you absolutely can’t change the class you’re working with for some reason (like it’s part of the .NET Framework or another third party). Where extension methods really become powerful is when you need to extend the behavior of something you <strong><em>wouldn’t normally have access to</em></strong>, like a type or an object that comes for free with the .NET Framework or another library.</p>
<p><strong>Q: Why use extension methods at all? Why not just extend the class with inheritance?</strong></p>
<p><strong>A:</strong> If you can extend the class, then you’ll usually end up doing that—extension methods aren’t meant to be a replacement for inheritance. But they come in really handy when you’ve got classes that you can’t extend. With extension methods, you can change the behavior of whole groups of objects, and even add functionality to some of the most basic classes in the .NET Framework.</p>
<p>Extending a class gives you new behavior, but requires that you use the new subclass if you want to use that new behavior.</p>
<p><strong>Q: Does my extension method affect all instances of a class, or just a certain instance of the class?</strong></p>
<p><strong>A:</strong> It will affect all instances of a class that you extend. In fact, once you’ve created an extension method, the new method will show up in your IDE alongside the extended class’s normal methods.</p>
</div></aside>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><span style="color:#9D9EA0;">One more point to remember about extension methods: you don’t gain access to any of the class’s internals by creating an extension method, so it’s still acting as an outsider.</span></p>
</div>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg618-1.png"/>
<h6/>
</div></figure>
<p><strong>Yes! LINQ is based on extension methods.</strong></p>
<p>In addition to extending classes, you can also extend <strong>interfaces</strong>. All you have to do is use an interface name in place of the class, after the <code>this</code> keyword in the extension method’s first parameter. The extension method will be added to <strong>every class that implements that interface</strong>. And that’s exactly what the .NET team did when they created LINQ—all of the LINQ methods are static extension methods for the IEnumerable&lt;T&gt; interface.</p>
<p>Here’s how it works. When you add <code>using System.Linq;</code> to the top of your code, it causes your code to “see” a static class called System.Linq.Enumerable. You’ve used some of its methods, like Enumerable.Range, but it also has extension methods. Go to the IDE and type <code>Enumerable.First</code>, then look at the declaration. It starts with <code>(extension)</code> to tell you that it’s an extension method, and its first parameter uses the <code>this</code> keyword just like the extension method you wrote. You’ll see the same pattern for every LINQ method.</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg618-2.png"/>
<h6/>
</div></figure>
</div></section>
<section data-pdf-bookmark="Extending a fundamental type: string" data-type="sect1"><div class="sect1" id="extending_a_fundamental_type_string">
<h1>Extending a fundamental type: string</h1>
<p><a data-primary="strings" data-secondary="extending" data-type="indexterm" id="idm46402338312536"/>Let’s explore how extension methods work by extending the String class. <strong>Create a new Console App project</strong>, and add a file called <em>HumanExtensions.cs</em>.</p>
<p>Do this!</p>
<ol>
<li><p><strong>Put all of your extension methods in a separate namespace.</strong></p>
<p>It’s a good idea to keep all of your extensions in a different namespace than the rest of your code. That way, you won’t have trouble finding them for use in other programs. Set up a static class for your method to live in, too:</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg619-1.png"/>
<h6/>
</div></figure>
</li>
<li><p><strong>Create the static extension method, and define its first parameter as <u>this</u> and then the type you’re extending.</strong></p>
<p>The two main things you need to know when you declare an extension method are that the method needs to be static and it takes the class it’s extending as its first parameter:</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg619-2.png"/>
<h6/>
</div></figure>
</li>
<li><p><strong>Finish the extension method.</strong></p>
<p>This method checks the string to see if it contains the word “Help!”—if it does, then that string is a distress call, which every superhero is sworn to answer:</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg619-3.png"/>
<h6/>
</div></figure>
</li>
<li><p><strong>Use your new IsDistressCall extension method.</strong></p>
<p>Add <code>using AmazingExtensions;</code> to the top of the file with your Program class. Then add code to the class that creates a string and calls its IsDistressCall method. You’ll see your extension in the IntelliSense window:</p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg619-4.png"/>
<h6/>
</div></figure>
</li>
</ol>
</div></section>
<section data-pdf-bookmark="Extension Magnets" data-type="sect1"><div class="sect1" id="extension_magnets">
<h1>Extension Magnets</h1>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg620-1.png"/>
<h6/>
</div></figure>
<p>Arrange the magnets to produce this output:</p>
<p><strong>a buck begets more bucks</strong></p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg620.png"/>
<h6/>
</div></figure>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg621.png"/>
<h6/>
</div></figure>
</div></section>
<section data-pdf-bookmark="Extension Magnets Solution" data-type="sect1"><div class="sect1" id="extension_magnets_solution">
<h1>Extension Magnets Solution</h1>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg620-1.png"/>
<h6/>
</div></figure>
<p><a data-primary="Captain Amazing" data-type="indexterm" id="idm46402338282904"/>Your job was to arrange the magnets to produce this output:</p>
<p><strong>a buck begets more bucks</strong></p>
<figure class="informal"><div class="figure">
<img alt="Images" src="assets/pg622.png"/>
<h6/>
</div></figure>
</div></section>
</div></section></body></html>