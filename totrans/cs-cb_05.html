<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 5. Implementing Dynamic and Reflection"><div class="chapter" id="implementing_dynamic_and_reflection">
<h1><span class="label">Chapter 5. </span>Implementing Dynamic and Reflection</h1>


<p><a data-type="indexterm" data-primary="reflection" data-secondary="implementing" id="ix_ch05-asciidoc0"/>Reflection <a data-type="indexterm" data-primary="reflection" data-secondary="defined" id="idm45678783567792"/>allows code to look inside of a type and examine its details and members. This is useful for libraries and tools that want to give the user maximum flexibility to submit objects to perform some automatic operation. A common example of code that does reflection are unit testing frameworks. As described in <a data-type="xref" href="ch03.xhtml#writing_a_unit_test">Recipe 3.1</a>, unit tests take classes whose members have attributes to indicate which methods are tests. The unit testing framework uses reflection to find classes that are tests, locate the test methods, and execute the tests.</p>

<p>The example in this chapter is based on a dynamic report-building application. It uses reflection to read attributes of a class, access type members, and execute methods. The first four sections of this chapter show how to do that.</p>

<p><a data-type="indexterm" data-primary="dynamic" data-secondary="defined" id="idm45678783564432"/>In addition to reflection, another way to work flexibly with code is a C# feature called dynamic. In C#, much of the code we write is strongly typed, and that’s a huge benefit for productivity and maintainability. <a data-type="indexterm" data-primary="dynamic keyword" id="idm45678783563088"/>That said, C# has a <code>dynamic</code> keyword that allows developers to assume that objects have a certain structure. This is much like dynamic programming languages, like JavaScript and Python, where developers access objects based on documentation that specifies what members an object has. So, they just write code that uses those members. Dynamic code allows C# to do the same thing.</p>

<p>When performing operations requiring COM interop, dynamic is particularly useful, and there’s a section explaining how that works. You’ll see how dynamic can be useful in significantly reducing and simplifying the code, as compared to the verbosity and complexity of reflection. There are also types that allow us to build an inherently dynamic type. <a data-type="indexterm" data-primary="dynamic language runtime (DLR)" id="idm45678783560720"/>Additionally, there’s a dynamic language runtime (DLR) that enables interop between C# and dynamic languages, such as Python, and you’ll see two sections on interoperability between C# and Python.</p>






<section data-type="sect1" data-pdf-bookmark="5.1 Reading Attributes with Reflection"><div class="sect1" id="reading_attributes_with_reflection">
<h1>5.1 Reading Attributes with Reflection</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678783558032">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="attributes, reading with reflection" id="ix_ch05-asciidoc1"/><a data-type="indexterm" data-primary="reflection" data-secondary="reading attributes with" id="ix_ch05-asciidoc2"/>You want consumers of your library to have maximum flexibility when passing objects, but they still need to communicate important details of the object.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678783554016">
<h2>Solution</h2>

<p>Here’s an <code>Attribute</code> class, representing report column metadata:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="na">[AttributeUsage(</code>
<code class="na">    AttributeTargets.Property | AttributeTargets.Method,</code>
<code class="na">    AllowMultiple = false)]</code>
<code class="k">public</code> <code class="k">class</code> <code class="nc">ColumnAttribute</code> <code class="p">:</code> <code class="n">Attribute</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="nf">ColumnAttribute</code><code class="p">(</code><code class="kt">string</code> <code class="n">name</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">Name</code> <code class="p">=</code> <code class="n">name</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="kt">string</code> <code class="n">Name</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="kt">string</code> <code class="n">Format</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code></pre>

<p>This class represents a record to display and uses the attribute:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">InventoryItem</code>
<code class="p">{</code>
<code class="na">    [Column("Part #")]</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">PartNumber</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [Column("Name")]</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Description</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [Column("Amount")]</code>
    <code class="k">public</code> <code class="kt">int</code> <code class="n">Count</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [Column("Price")]</code>
    <code class="k">public</code> <code class="kt">decimal</code> <code class="n">ItemPrice</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [Column("Total")]</code>
    <code class="k">public</code> <code class="kt">decimal</code> <code class="nf">CalculateTotal</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="n">ItemPrice</code> <code class="p">*</code> <code class="n">Count</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>The <code>Main</code> method shows how to instantiate and pass the data:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">()</code>
<code class="p">{</code>
    <code class="kt">var</code> <code class="n">inventory</code> <code class="p">=</code> <code class="k">new</code> <code class="n">List</code><code class="p">&lt;</code><code class="kt">object</code><code class="p">&gt;</code>
    <code class="p">{</code>
        <code class="k">new</code> <code class="n">InventoryItem</code>
        <code class="p">{</code>
            <code class="n">PartNumber</code> <code class="p">=</code> <code class="s">"1"</code><code class="p">,</code>
            <code class="n">Description</code> <code class="p">=</code> <code class="s">"Part #1"</code><code class="p">,</code>
            <code class="n">Count</code> <code class="p">=</code> <code class="m">3</code><code class="p">,</code>
            <code class="n">ItemPrice</code> <code class="p">=</code> <code class="m">5.26</code><code class="n">m</code>
        <code class="p">},</code>
        <code class="k">new</code> <code class="n">InventoryItem</code>
        <code class="p">{</code>
            <code class="n">PartNumber</code> <code class="p">=</code> <code class="s">"2"</code><code class="p">,</code>
            <code class="n">Description</code> <code class="p">=</code> <code class="s">"Part #2"</code><code class="p">,</code>
            <code class="n">Count</code> <code class="p">=</code> <code class="m">1</code><code class="p">,</code>
            <code class="n">ItemPrice</code> <code class="p">=</code> <code class="m">7.95</code><code class="n">m</code>
        <code class="p">},</code>
        <code class="k">new</code> <code class="n">InventoryItem</code>
        <code class="p">{</code>
            <code class="n">PartNumber</code> <code class="p">=</code> <code class="s">"3"</code><code class="p">,</code>
            <code class="n">Description</code> <code class="p">=</code> <code class="s">"Part #3"</code><code class="p">,</code>
            <code class="n">Count</code> <code class="p">=</code> <code class="m">2</code><code class="p">,</code>
            <code class="n">ItemPrice</code> <code class="p">=</code> <code class="m">23.13</code><code class="n">m</code>
        <code class="p">},</code>
    <code class="p">};</code>

    <code class="kt">string</code> <code class="n">report</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Report</code><code class="p">().</code><code class="n">Generate</code><code class="p">(</code><code class="n">inventory</code><code class="p">);</code>

    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">report</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>This <code>Report</code> class has methods for building a report header and generating a report:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">Report</code>
<code class="p">{</code>
    <code class="c1">// contains Generate and GetHeaders methods</code>
<code class="p">}</code></pre>

<p>This method is a member of the <code>Report</code> class and uses reflection to find all type members:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="kt">string</code> <code class="nf">Generate</code><code class="p">(</code><code class="n">List</code><code class="p">&lt;</code><code class="kt">object</code><code class="p">&gt;</code> <code class="n">items</code><code class="p">)</code>
<code class="p">{</code>
    <code class="n">_</code> <code class="p">=</code> <code class="n">items</code> <code class="p">??</code>
        <code class="k">throw</code> <code class="k">new</code> <code class="nf">ArgumentNullException</code><code class="p">(</code>
            <code class="err">$</code><code class="s">"{nameof(items)} is required"</code><code class="p">);</code>

    <code class="n">MemberInfo</code><code class="p">[]</code> <code class="n">members</code> <code class="p">=</code>
        <code class="n">items</code><code class="p">.</code><code class="n">First</code><code class="p">().</code><code class="n">GetType</code><code class="p">().</code><code class="n">GetMembers</code><code class="p">();</code>

    <code class="kt">var</code> <code class="n">report</code> <code class="p">=</code> <code class="k">new</code> <code class="n">StringBuilder</code><code class="p">(</code><code class="s">"# Report\n\n"</code><code class="p">);</code>

    <code class="n">report</code><code class="p">.</code><code class="n">Append</code><code class="p">(</code><code class="n">GetHeaders</code><code class="p">(</code><code class="n">members</code><code class="p">));</code>

    <code class="k">return</code> <code class="n">report</code><code class="p">.</code><code class="n">ToString</code><code class="p">();</code>
<code class="p">}</code></pre>

<p>This method is a member of the <code>Report</code> class and uses reflection to read attributes of a type:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">const</code> <code class="kt">string</code> <code class="n">ColumnSeparator</code> <code class="p">=</code> <code class="s">" | "</code><code class="p">;</code>

<code class="n">StringBuilder</code> <code class="nf">GetHeaders</code><code class="p">(</code><code class="n">MemberInfo</code><code class="p">[]</code> <code class="n">members</code><code class="p">)</code>
<code class="p">{</code>
    <code class="kt">var</code> <code class="n">columnNames</code> <code class="p">=</code> <code class="k">new</code> <code class="n">List</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;();</code>
    <code class="kt">var</code> <code class="n">underscores</code> <code class="p">=</code> <code class="k">new</code> <code class="n">List</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;();</code>

    <code class="k">foreach</code> <code class="p">(</code><code class="kt">var</code> <code class="n">member</code> <code class="k">in</code> <code class="n">members</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="kt">var</code> <code class="n">attribute</code> <code class="p">=</code>
            <code class="n">member</code><code class="p">.</code><code class="n">GetCustomAttribute</code><code class="p">&lt;</code><code class="n">ColumnAttribute</code><code class="p">&gt;();</code>

        <code class="k">if</code> <code class="p">(</code><code class="n">attribute</code> <code class="p">!=</code> <code class="k">null</code><code class="p">)</code>
        <code class="p">{</code>
            <code class="kt">string</code> <code class="n">columnTitle</code> <code class="p">=</code> <code class="n">attribute</code><code class="p">.</code><code class="n">Name</code><code class="p">;</code>
            <code class="kt">string</code> <code class="n">dashes</code> <code class="p">=</code> <code class="s">""</code><code class="p">.</code><code class="n">PadLeft</code><code class="p">(</code><code class="n">columnTitle</code><code class="p">.</code><code class="n">Length</code><code class="p">,</code> <code class="sc">'-'</code><code class="p">);</code>

            <code class="n">columnNames</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code><code class="n">columnTitle</code><code class="p">);</code>
            <code class="n">underscores</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code><code class="n">dashes</code><code class="p">);</code>
        <code class="p">}</code>
    <code class="p">}</code>

    <code class="kt">var</code> <code class="n">header</code> <code class="p">=</code> <code class="k">new</code> <code class="n">StringBuilder</code><code class="p">();</code>

    <code class="n">header</code><code class="p">.</code><code class="n">AppendJoin</code><code class="p">(</code><code class="n">ColumnSeparator</code><code class="p">,</code> <code class="n">columnNames</code><code class="p">);</code>
    <code class="n">header</code><code class="p">.</code><code class="n">Append</code><code class="p">(</code><code class="s">"\n"</code><code class="p">);</code>

    <code class="n">header</code><code class="p">.</code><code class="n">AppendJoin</code><code class="p">(</code><code class="n">ColumnSeparator</code><code class="p">,</code> <code class="n">underscores</code><code class="p">);</code>
    <code class="n">header</code><code class="p">.</code><code class="n">Append</code><code class="p">(</code><code class="s">"\n"</code><code class="p">);</code>

    <code class="k">return</code> <code class="n">header</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>And here’s the output:</p>

<pre data-type="programlisting" data-code-language="markdown"><code class="gh">#</code> Report

Total | Part # | Name | Amount | Price
----- | ------ | ---- | ------ | -----</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678783553424">
<h2>Discussion</h2>

<p>Attributes, which are metadata, typically exist to support tooling on code. The solution in this section takes a similar approach where the <code>ColumnAttribute</code> is metadata for a column of data in a report. You can see where the <code>AttributeUsage</code> specifies that you can apply <code>ColumnAttribute</code> to either properties or methods. Thinking of which features that a report column might be able to support, this attribute boils down to two typical features: <code>Name</code> and <code>Format</code>. Because a C# property name might not represent the text of a column header, <code>Name</code> lets you specify anything you want. Also, without specifying a string format, <code>DateTime</code> and <code>decimal</code> columns would take default displays, which is often not what you want. This essentially solves the problem where a consumer of a report library wants to pass any type of object they want, using <code>ColumnAttribute</code> to share important details.</p>

<p><code>InventoryItem</code> shows how <code>ColumnAttribute</code> works. Notice how the positional property, <code>Name</code>, differs from the name of the properties and method. <a data-type="xref" href="#accessing_type_members_with_reflection">Recipe 5.2</a> has an example of how the <code>Format</code> property works, while this section only concentrates on how to extract and display the metadata as a Markdown formatted column.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Architecturally, you should look at this project as two separate applications. There’s a reusable report library that anyone can submit objects to. The report library consists of a <code>Report</code> class and the <code>ColumnAttribute</code> attribute. Then there’s a consumer application, which is the <code>Main</code> method. For simplicity, the source code for this demo puts all the code into the same project, but in practice, these would be separate.</p>
</div>

<p>The <code>Main</code> method instantiates a <code>List&lt;object&gt;</code> that contains <code>InventoryItem</code> instances. This is data that would typically come from a database or other data source. It instantiates the <code>Report</code>, passes the data, and prints the result.</p>

<p>The <code>Generate</code> method belongs to the <code>Report</code> class. Notice that it accepts a <code>List&lt;object&gt;</code>, which is why <code>Main</code> passed a <code>List&lt;object&gt;</code>. Essentially, <code>Report</code> wants to be able to operate on any object type.</p>

<p>After validating input items, <code>Generate</code> uses reflection to discover what members exist in the objects passed. You see, we’re no longer able to know because the objects aren’t strongly typed, and we want maximum flexibility in what types can be passed. This is a good case for reflection. That said, we no longer have the guarantee that all instances in items are the same type, and that has to be an implied contract, rather than enforced by code. <a data-type="xref" href="#instantiating_type_members_with_reflection">Recipe 5.3</a> fixes this by showing how to use generics so we have both type safety and the ability to use generics, and using interfaces might be another approach.</p>

<p>We’re assuming all objects are the same, and <code>Generate</code> calls <code>First</code> on <code>items</code>, because it has the exact same attributes of all objects in <code>items</code>. <code>Generate</code> then calls <code>GetType</code> on the first item. The <code>Type</code> instance is the gateway for performing reflection.</p>

<p>After getting the <code>Type</code> instance, you can ask for anything about a type and work with particular instances. This example calls <code>GetMembers</code> to get a <code>MemberInfo[]</code>. A <code>MemberInfo</code> has all the information about a particular type member, like its name and type. In this example, the <code>MemberInfo[]</code> contains the properties and methods from the <code>InventoryItem</code> that <code>Main</code> passed in: <code>PartNumber</code>, <code>Description</code>, <code>Count</code>, <code>ItemPrice</code>, and <code>CalculateTotal</code>.</p>

<p>Because the report is a string of Markdown text and there is a lot of concatenation, the solution uses <code>StringBuilder</code>. <a data-type="xref" href="ch02.xhtml#processing_strings_efficiently">Recipe 2.1</a> explains why this is a good approach.</p>

<p>Because we’re concerned with attributes, this solution only prints the report header, and later sections in this chapter explain a lot of different ways to generate the report body, depending on your needs. The <code>GetHeader</code> method takes the <code>MemberInfo[]</code> and uses reflection to learn what those header titles should be.</p>

<p>In Markdown, we separate table headers with pipes, <code>|</code>, and add an underscore, which is why we have two arrays for <code>columnNames</code> and <code>underscores</code>. The <code>foreach</code> loop examines each <code>MemberInfo</code>, calling <code>GetCustomAttribute</code>. Notice that the type parameter for <code>GetCustomAttribute</code> is <code>ColumnAttribute</code>—members could have multiple attributes, but we only want that one. The instance returned from <code>GetCustom​Attri⁠bute</code> is <code>ColumnAttribute</code>, so we have access to its properties, such as <code>Name</code>. The code populates <code>columnNames</code> with <code>Name</code> and adds an underscore that is the same length as <code>Name</code>.</p>

<p>Finally, <code>GetHeaders</code> concatenates values with pipes, <code>|</code>, and returns the resulting header. Following this back through the call chain, <code>Generate</code> appends the <code>GetHeaders</code> results and <code>Main</code> prints the header, which you can see in the solution output.<a data-type="indexterm" data-startref="ix_ch05-asciidoc2" id="idm45678782862800"/><a data-type="indexterm" data-startref="ix_ch05-asciidoc1" id="idm45678782862096"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45678782903216">
<h2>See Also</h2>

<p><a data-type="xref" data-xrefstyle="rec-num-title" href="ch02.xhtml#processing_strings_efficiently">Recipe 2.1, “Processing Strings Efficiently”</a></p>

<p><a data-type="xref" data-xrefstyle="rec-num-title" href="#accessing_type_members_with_reflection">Recipe 5.2, “Accessing Type Members with Reflection”</a></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.2 Accessing Type Members with Reflection"><div class="sect1" id="accessing_type_members_with_reflection">
<h1>5.2 Accessing Type Members with Reflection</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678782856032">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="reflection" data-secondary="accessing type members with" id="ix_ch05-asciidoc3"/><a data-type="indexterm" data-primary="type members" data-secondary="accessing with reflection" id="ix_ch05-asciidoc4"/>You need to examine an object to see what properties you can read.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678782851904">
<h2>Solution</h2>

<p>This class represents a record to display:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">InventoryItem</code>
<code class="p">{</code>
<code class="na">    [Column("Part #")]</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">PartNumber</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [Column("Name")]</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Description</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [Column("Amount")]</code>
    <code class="k">public</code> <code class="kt">int</code> <code class="n">Count</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [Column("Price", Format = "{0:c}")]</code>
    <code class="k">public</code> <code class="kt">decimal</code> <code class="n">ItemPrice</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code></pre>

<p>Here’s a class that contains metadata for each report column:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">ColumnDetail</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Name</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="n">ColumnAttribute</code> <code class="n">Attribute</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="n">PropertyInfo</code> <code class="n">PropertyInfo</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code></pre>

<p>This method collects the data to populate column metadata:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="n">ColumnDetail</code><code class="p">&gt;</code> <code class="n">GetColumnDetails</code><code class="p">(</code>
    <code class="n">List</code><code class="p">&lt;</code><code class="kt">object</code><code class="p">&gt;</code> <code class="n">items</code><code class="p">)</code>
<code class="p">{</code>
     <code class="kt">object</code> <code class="n">itemInstance</code> <code class="p">=</code> <code class="n">items</code><code class="p">.</code><code class="n">First</code><code class="p">();</code>
     <code class="n">Type</code> <code class="n">itemType</code> <code class="p">=</code> <code class="n">itemInstance</code><code class="p">.</code><code class="n">GetType</code><code class="p">();</code>
     <code class="n">PropertyInfo</code><code class="p">[]</code> <code class="n">itemProperties</code> <code class="p">=</code> <code class="n">itemType</code><code class="p">.</code><code class="n">GetProperties</code><code class="p">();</code>

    <code class="k">return</code>
        <code class="p">(</code><code class="k">from</code> <code class="n">prop</code> <code class="k">in</code> <code class="n">itemProperties</code>
         <code class="k">let</code> <code class="n">attribute</code> <code class="p">=</code> <code class="n">prop</code><code class="p">.</code><code class="n">GetCustomAttribute</code><code class="p">&lt;</code><code class="n">ColumnAttribute</code><code class="p">&gt;()</code>
         <code class="k">where</code> <code class="n">attribute</code> <code class="p">!=</code> <code class="k">null</code>
         <code class="k">select</code> <code class="k">new</code> <code class="n">ColumnDetail</code>
         <code class="p">{</code>
             <code class="n">Name</code> <code class="p">=</code> <code class="n">prop</code><code class="p">.</code><code class="n">Name</code><code class="p">,</code>
             <code class="n">Attribute</code> <code class="p">=</code> <code class="n">attribute</code><code class="p">,</code>
             <code class="n">PropertyInfo</code> <code class="p">=</code> <code class="n">prop</code>
         <code class="p">})</code>
        <code class="p">.</code><code class="n">ToDictionary</code><code class="p">(</code>
            <code class="n">key</code> <code class="p">=&gt;</code> <code class="n">key</code><code class="p">.</code><code class="n">Name</code><code class="p">,</code>
            <code class="n">val</code> <code class="p">=&gt;</code> <code class="n">val</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>Here’s a more streamlined way to get header data with LINQ:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="n">StringBuilder</code> <code class="nf">GetHeaders</code><code class="p">(</code>
    <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="n">ColumnDetail</code><code class="p">&gt;</code> <code class="n">details</code><code class="p">)</code>
<code class="p">{</code>
    <code class="kt">var</code> <code class="n">header</code> <code class="p">=</code> <code class="k">new</code> <code class="n">StringBuilder</code><code class="p">();</code>

    <code class="n">header</code><code class="p">.</code><code class="n">AppendJoin</code><code class="p">(</code>
        <code class="n">ColumnSeparator</code><code class="p">,</code>
        <code class="k">from</code> <code class="n">detail</code> <code class="k">in</code> <code class="n">details</code><code class="p">.</code><code class="n">Values</code>
        <code class="k">select</code> <code class="n">detail</code><code class="p">.</code><code class="n">Attribute</code><code class="p">.</code><code class="n">Name</code><code class="p">);</code>

    <code class="n">header</code><code class="p">.</code><code class="n">Append</code><code class="p">(</code><code class="s">"\n"</code><code class="p">);</code>

    <code class="n">header</code><code class="p">.</code><code class="n">AppendJoin</code><code class="p">(</code>
        <code class="n">ColumnSeparator</code><code class="p">,</code>
        <code class="k">from</code> <code class="n">detail</code> <code class="k">in</code> <code class="n">details</code><code class="p">.</code><code class="n">Values</code>
        <code class="k">let</code> <code class="n">length</code> <code class="p">=</code> <code class="n">detail</code><code class="p">.</code><code class="n">Attribute</code><code class="p">.</code><code class="n">Name</code><code class="p">.</code><code class="n">Length</code>
        <code class="k">select</code> <code class="s">""</code><code class="p">.</code><code class="n">PadLeft</code><code class="p">(</code><code class="n">length</code><code class="p">,</code> <code class="sc">'-'</code><code class="p">));</code>

    <code class="n">header</code><code class="p">.</code><code class="n">Append</code><code class="p">(</code><code class="s">"\n"</code><code class="p">);</code>

    <code class="k">return</code> <code class="n">header</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>This method uses reflection to pull the value out of an object property:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="p">(</code><code class="kt">object</code><code class="p">,</code> <code class="n">Type</code><code class="p">)</code> <code class="n">GetReflectedResult</code><code class="p">(</code>
    <code class="kt">object</code> <code class="n">item</code><code class="p">,</code> <code class="n">PropertyInfo</code> <code class="n">property</code><code class="p">)</code>
<code class="p">{</code>
    <code class="kt">object</code> <code class="n">result</code> <code class="p">=</code> <code class="n">property</code><code class="p">.</code><code class="n">GetValue</code><code class="p">(</code><code class="n">item</code><code class="p">);</code>
    <code class="n">Type</code> <code class="n">type</code> <code class="p">=</code> <code class="n">property</code><code class="p">.</code><code class="n">PropertyType</code><code class="p">;</code>

    <code class="k">return</code> <code class="p">(</code><code class="n">result</code><code class="p">,</code> <code class="n">type</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>This method uses reflection to retrieve and format property data:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="n">List</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="n">GetColumns</code><code class="p">(</code>
    <code class="n">IEnumerable</code><code class="p">&lt;</code><code class="n">ColumnDetail</code><code class="p">&gt;</code> <code class="n">details</code><code class="p">,</code>
    <code class="kt">object</code> <code class="n">item</code><code class="p">)</code>
<code class="p">{</code>
    <code class="kt">var</code> <code class="n">columns</code> <code class="p">=</code> <code class="k">new</code> <code class="n">List</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;();</code>

    <code class="k">foreach</code> <code class="p">(</code><code class="kt">var</code> <code class="n">detail</code> <code class="k">in</code> <code class="n">details</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">PropertyInfo</code> <code class="n">member</code> <code class="p">=</code> <code class="n">detail</code><code class="p">.</code><code class="n">PropertyInfo</code><code class="p">;</code>
        <code class="kt">string</code> <code class="n">format</code> <code class="p">=</code>
            <code class="kt">string</code><code class="p">.</code><code class="n">IsNullOrWhiteSpace</code><code class="p">(</code>
                <code class="n">detail</code><code class="p">.</code><code class="n">Attribute</code><code class="p">.</code><code class="n">Format</code><code class="p">)</code> <code class="p">?</code>
                <code class="s">"{0}"</code> <code class="p">:</code>
                <code class="n">detail</code><code class="p">.</code><code class="n">Attribute</code><code class="p">.</code><code class="n">Format</code><code class="p">;</code>

        <code class="p">(</code><code class="kt">object</code> <code class="n">result</code><code class="p">,</code> <code class="n">Type</code> <code class="n">columnType</code><code class="p">)</code> <code class="p">=</code>
            <code class="n">GetReflectedResult</code><code class="p">(</code><code class="n">item</code><code class="p">,</code> <code class="n">member</code><code class="p">);</code>

        <code class="k">switch</code> <code class="p">(</code><code class="n">columnType</code><code class="p">.</code><code class="n">FullName</code><code class="p">)</code>
        <code class="p">{</code>
            <code class="k">case</code> <code class="s">"System.Decimal"</code><code class="p">:</code>
                <code class="n">columns</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code>
                    <code class="kt">string</code><code class="p">.</code><code class="n">Format</code><code class="p">(</code><code class="n">format</code><code class="p">,</code> <code class="p">(</code><code class="kt">decimal</code><code class="p">)</code><code class="n">result</code><code class="p">));</code>
                <code class="k">break</code><code class="p">;</code>
            <code class="k">case</code> <code class="s">"System.Int32"</code><code class="p">:</code>
                <code class="n">columns</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code>
                    <code class="kt">string</code><code class="p">.</code><code class="n">Format</code><code class="p">(</code><code class="n">format</code><code class="p">,</code> <code class="p">(</code><code class="kt">int</code><code class="p">)</code><code class="n">result</code><code class="p">));</code>
                <code class="k">break</code><code class="p">;</code>
            <code class="k">case</code> <code class="s">"System.String"</code><code class="p">:</code>
                <code class="n">columns</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code>
                    <code class="kt">string</code><code class="p">.</code><code class="n">Format</code><code class="p">(</code><code class="n">format</code><code class="p">,</code> <code class="p">(</code><code class="kt">string</code><code class="p">)</code><code class="n">result</code><code class="p">));</code>
                <code class="k">break</code><code class="p">;</code>
            <code class="k">default</code><code class="p">:</code>
                <code class="k">break</code><code class="p">;</code>
        <code class="p">}</code>
    <code class="p">}</code>

    <code class="k">return</code> <code class="n">columns</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>This method combines and formats all rows of data:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="n">StringBuilder</code> <code class="nf">GetRows</code><code class="p">(</code>
    <code class="n">List</code><code class="p">&lt;</code><code class="kt">object</code><code class="p">&gt;</code> <code class="n">items</code><code class="p">,</code>
    <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="n">ColumnDetail</code><code class="p">&gt;</code> <code class="n">details</code><code class="p">)</code>
<code class="p">{</code>
    <code class="kt">var</code> <code class="n">rows</code> <code class="p">=</code> <code class="k">new</code> <code class="n">StringBuilder</code><code class="p">();</code>

    <code class="k">foreach</code> <code class="p">(</code><code class="kt">var</code> <code class="n">item</code> <code class="k">in</code> <code class="n">items</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">List</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="n">columns</code> <code class="p">=</code>
            <code class="n">GetColumns</code><code class="p">(</code><code class="n">details</code><code class="p">.</code><code class="n">Values</code><code class="p">,</code> <code class="n">item</code><code class="p">);</code>

        <code class="n">rows</code><code class="p">.</code><code class="n">AppendJoin</code><code class="p">(</code><code class="n">ColumnSeparator</code><code class="p">,</code> <code class="n">columns</code><code class="p">);</code>

        <code class="n">rows</code><code class="p">.</code><code class="n">Append</code><code class="p">(</code><code class="s">"\n"</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">return</code> <code class="n">rows</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>Finally, this method uses all of the others to build a complete report:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">const</code> <code class="kt">string</code> <code class="n">ColumnSeparator</code> <code class="p">=</code> <code class="s">" | "</code><code class="p">;</code>

<code class="k">public</code> <code class="kt">string</code> <code class="nf">Generate</code><code class="p">(</code><code class="n">List</code><code class="p">&lt;</code><code class="kt">object</code><code class="p">&gt;</code> <code class="n">items</code><code class="p">)</code>
<code class="p">{</code>
    <code class="kt">var</code> <code class="n">report</code> <code class="p">=</code> <code class="k">new</code> <code class="n">StringBuilder</code><code class="p">(</code><code class="s">"# Report\n\n"</code><code class="p">);</code>

    <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="n">ColumnDetail</code><code class="p">&gt;</code> <code class="n">columnDetails</code> <code class="p">=</code>
        <code class="n">GetColumnDetails</code><code class="p">(</code><code class="n">items</code><code class="p">);</code>
    <code class="n">report</code><code class="p">.</code><code class="n">Append</code><code class="p">(</code><code class="n">GetHeaders</code><code class="p">(</code><code class="n">columnDetails</code><code class="p">));</code>
    <code class="n">report</code><code class="p">.</code><code class="n">Append</code><code class="p">(</code><code class="n">GetRows</code><code class="p">(</code><code class="n">items</code><code class="p">,</code> <code class="n">columnDetails</code><code class="p">));</code>

    <code class="k">return</code> <code class="n">report</code><code class="p">.</code><code class="n">ToString</code><code class="p">();</code>
<code class="p">}</code></pre>

<p>And here’s the output:</p>

<pre data-type="programlisting" data-code-language="markdown">|| Total | Part # | Name | Amount | Price ||
| $15.78 | 1 | Part <code class="ni">#1</code> | 3 | 5.26 |
| $7.95 | 2 | Part <code class="ni">#2</code> | 1 | 7.95 |
| $46.26 | 3 | Part <code class="ni">#3</code> | 2 | 23.13 |</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678782851312">
<h2>Discussion</h2>

<p>The report library in the solution receives a <code>List&lt;object&gt;</code> so that consumers can send objects of any type they want. Since the input objects aren’t strongly typed, the <code>Report</code> class needs to perform reflection to extract data from each object. <a data-type="xref" href="#reading_attributes_with_reflection">Recipe 5.1</a> explained how the <code>Main</code> method passes this data and how the solution generates the header. This section concentrates on data, and the solution doesn’t repeat the exact code from <a data-type="xref" href="#reading_attributes_with_reflection">Recipe 5.1</a>.</p>

<p>The <code>InventoryItem</code> class uses <code>ColumnAttribute</code> attributes. Notice that <code>ItemPrice</code> now has the named property <code>Format</code>, specifying that this column should be formatted in the report as currency.</p>

<p>During reflection, we need to extract a set of data from the objects that helps with report layout and formatting. The <code>ColumnDetail</code> helps with this because when processing each column, we need to know:</p>

<ul>
<li>
<p><code>Name</code> to ensure we’re working on the right column</p>
</li>
<li>
<p><code>Attribute</code> for formatting column data</p>
</li>
<li>
<p><code>PropertyInfo</code> for getting property data</p>
</li>
</ul>

<p>The <code>GetColumnDetails</code> method populates a <code>ColumnDetail</code> for each column. Getting the first object in the data, it gets the type and then calls <code>GetProperties</code> on the types for a <code>PropertyInfo[]</code>. Unlike <a data-type="xref" href="#reading_attributes_with_reflection">Recipe 5.1</a>, which calls <code>GetMembers</code> for a <code>MemberInfo[]</code>, this only gets the properties from the type and not any other members.</p>
<div data-type="tip"><h6>Tip</h6>
<p>In addition to <code>GetMembers</code> and <code>GetProperties</code>, <code>Type</code> has other reflection methods that will only get constructors, fields, or methods. These would be useful if you need to restrict the type of member you’re working with.</p>
</div>

<p>Because reflection returns a collection of objects (<code>PropertyInfo[]</code> in this solution), we can use LINQ to Objects for a more declarative approach. This is what <code>GetColumnDetails</code> does, projecting into <code>ColumnDetails</code> instances and returning a <code>Dictionary</code> with the column name as key and <code>ColumnDetail</code> as value.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>As you’ll see later in the solution, the code iterates through the <code>Dictionary&lt;string, ColumnDetail&gt;</code>, assuming that columns and their data are laid out in the order returned by reflection queries. However, imagine a future implementation where <code>ColumnAttribute</code> had an <code>Order</code> property or the consumer could pass <code>include/exclude</code> column metadata that didn’t guarantee that the order of the columns matches what reflection returned. In that case, having the dictionary is essential to look up <code>ColumnDetail</code> metadata based on which column you’re working on. Although that’s left out of this example to reduce complexity and focus on the original problem statement, it might give you ideas on how something like this could be extended.</p>
</div>

<p>The <code>GetHeaders</code> method does exactly the same thing as <a data-type="xref" href="#reading_attributes_with_reflection">Recipe 5.1</a>, except it’s written as LINQ statements to reduce and simplify the code.</p>

<p>The <code>GetReflectedResult</code> returns a tuple, <code>(object, Type)</code>. Its task is to pull out the value from the property and the type of the property from its <code>PropertyInfo</code>. Here, <code>item</code> is the actual object instance and <code>property</code> is the reflected metadata for that property. Using <code>property</code>, the code calls <code>GetValue</code> with <code>item</code> as the parameter—it reads that property from <code>item</code>. Again, we’re using reflection and don’t know the type for the property, so we put it in type object. <code>PropertyInfo</code> also has a <code>PropertyType</code>, which is where we get the <code>Type</code> object from.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>This application uses reflection to put property data into a variable of type <code>object</code>. If the property type is a value type (e.g., <code>int</code>, <span class="keep-together"><code>double</code></span>, <code>decimal</code>), you incur a boxing penalty, which affects application performance. If you were doing this millions of times, you might need to take a second look at your requirements and analyze whether this was a good approach for your scenario. That said, this is a report. Think about how many records you might include in a report for the purpose of displaying the data to a human. In this case, any performance issues would be negligible. It’s a classic trade-off of flexibility versus performance; you just need to think about how it affects your situation.</p>
</div>

<p>The <code>GetColumns</code> method uses <code>GetReflectedResult</code> as it loops through each column for a given object. The collection of <code>ColumnDetail</code> is useful, providing <code>Proper⁠ty​Info</code> for the current column. The format defaults to no format if the <code>Column​Attri⁠bute</code> for a column doesn’t include the <code>Format</code> property. The <code>switch</code> statement applies the format to the object based on the <code>Type</code> returned from <code>GetReflectedResult</code>.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>For simplicity, the <code>switch</code> statement in <code>GetColumns</code> only contains types in the solution, though you might imagine it including all built-in types. We might have used reflection to invoke <code>ToString</code> with a format specifier and type, which we’ll discuss in <a data-type="xref" href="#invoking_methods_with_reflection">Recipe 5.4</a>, to reduce code. However, at some point the additional complexity doesn’t add value. In this case, we’re just covering a finite set of built-in types, and once that code is written, it will be unlikely to change. My thoughts on this trade-off are that sometimes being too clever results in code that’s difficult to read and takes longer to write.</p>
</div>

<p>Finally, <code>GetRows</code> calls <code>GetColumns</code> for each row and returns to <code>Generate</code>. Then, having called <code>GetHeaders</code> and <code>GetRows</code>, <code>Generate</code> appends the results to a <code>StringBuilder</code> and returns the string to the caller with the entire report, which you can see in the solution output.<a data-type="indexterm" data-startref="ix_ch05-asciidoc4" id="idm45678781884784"/><a data-type="indexterm" data-startref="ix_ch05-asciidoc3" id="idm45678781884080"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45678781953536">
<h2>See Also</h2>

<p><a data-type="xref" data-xrefstyle="rec-num-title" href="#reading_attributes_with_reflection">Recipe 5.1, “Reading Attributes with Reflection”</a></p>

<p><a data-type="xref" data-xrefstyle="rec-num-title" href="#invoking_methods_with_reflection">Recipe 5.4, “Invoking Methods with Reflection”</a></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.3 Instantiating Type Members with Reflection"><div class="sect1" id="instantiating_type_members_with_reflection">
<h1>5.3 Instantiating Type Members with Reflection</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678781878192">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="generic types, instantiating with reflection" id="ix_ch05-asciidoc5"/><a data-type="indexterm" data-primary="instantiation" data-secondary="reflection for" id="ix_ch05-asciidoc6"/><a data-type="indexterm" data-primary="reflection" data-secondary="instantiating type members with" id="ix_ch05-asciidoc7"/><a data-type="indexterm" data-primary="type instantiation" data-secondary="reflection for" id="ix_ch05-asciidoc8"/><a data-type="indexterm" data-primary="type safety" id="ix_ch05-asciidoc9"/><a data-type="indexterm" data-primary="types" data-secondary="instantiating members with reflection" id="ix_ch05-asciidoc10"/>You need to instantiate generic types but don’t know the type or type parameters ahead of time.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678781869536">
<h2>Solution</h2>

<p>The solution generates a uniquely formatted report, depending on this enum:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">enum</code> <code class="n">ReportType</code>
<code class="p">{</code>
    <code class="n">Html</code><code class="p">,</code>
    <code class="n">Markdown</code>
<code class="p">}</code></pre>

<p>Here’s a reusable base class for generating reports:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">abstract</code> <code class="k">class</code> <code class="nc">GeneratorBase</code><code class="p">&lt;</code><code class="n">TData</code><code class="p">&gt;</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="nf">Generate</code><code class="p">(</code><code class="n">List</code><code class="p">&lt;</code><code class="n">TData</code><code class="p">&gt;</code> <code class="n">items</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">StringBuilder</code> <code class="n">report</code> <code class="p">=</code> <code class="n">GetTitle</code><code class="p">();</code>

        <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="n">ColumnDetail</code><code class="p">&gt;</code> <code class="n">columnDetails</code> <code class="p">=</code>
            <code class="n">GetColumnDetails</code><code class="p">(</code><code class="n">items</code><code class="p">);</code>
        <code class="n">report</code><code class="p">.</code><code class="n">Append</code><code class="p">(</code><code class="n">GetHeaders</code><code class="p">(</code><code class="n">columnDetails</code><code class="p">));</code>
        <code class="n">report</code><code class="p">.</code><code class="n">Append</code><code class="p">(</code><code class="n">GetRows</code><code class="p">(</code><code class="n">items</code><code class="p">,</code> <code class="n">columnDetails</code><code class="p">));</code>

        <code class="k">return</code> <code class="n">report</code><code class="p">.</code><code class="n">ToString</code><code class="p">();</code>
    <code class="p">}</code>

    <code class="k">protected</code> <code class="k">abstract</code> <code class="n">StringBuilder</code> <code class="nf">GetTitle</code><code class="p">();</code>

    <code class="k">protected</code> <code class="k">abstract</code> <code class="n">StringBuilder</code> <code class="nf">GetHeaders</code><code class="p">(</code>
        <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="n">ColumnDetail</code><code class="p">&gt;</code> <code class="n">details</code><code class="p">);</code>

    <code class="k">protected</code> <code class="k">abstract</code> <code class="n">StringBuilder</code> <code class="nf">GetRows</code><code class="p">(</code>
        <code class="n">List</code><code class="p">&lt;</code><code class="n">TData</code><code class="p">&gt;</code> <code class="n">items</code><code class="p">,</code>
        <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="n">ColumnDetail</code><code class="p">&gt;</code> <code class="n">details</code><code class="p">);</code>

    <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="n">ColumnDetail</code><code class="p">&gt;</code> <code class="n">GetColumnDetails</code><code class="p">(</code>
        <code class="n">List</code><code class="p">&lt;</code><code class="n">TData</code><code class="p">&gt;</code> <code class="n">items</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">TData</code> <code class="n">itemInstance</code> <code class="p">=</code> <code class="n">items</code><code class="p">.</code><code class="n">First</code><code class="p">();</code>
        <code class="n">Type</code> <code class="n">itemType</code> <code class="p">=</code> <code class="n">itemInstance</code><code class="p">.</code><code class="n">GetType</code><code class="p">();</code>
        <code class="n">PropertyInfo</code><code class="p">[]</code> <code class="n">itemProperties</code> <code class="p">=</code> <code class="n">itemType</code><code class="p">.</code><code class="n">GetProperties</code><code class="p">();</code>

        <code class="k">return</code>
            <code class="p">(</code><code class="k">from</code> <code class="n">prop</code> <code class="k">in</code> <code class="n">itemProperties</code>
             <code class="k">let</code> <code class="n">attribute</code> <code class="p">=</code> <code class="n">prop</code><code class="p">.</code><code class="n">GetCustomAttribute</code><code class="p">&lt;</code><code class="n">ColumnAttribute</code><code class="p">&gt;()</code>
             <code class="k">where</code> <code class="n">attribute</code> <code class="p">!=</code> <code class="k">null</code>
             <code class="k">select</code> <code class="k">new</code> <code class="n">ColumnDetail</code>
             <code class="p">{</code>
                 <code class="n">Name</code> <code class="p">=</code> <code class="n">prop</code><code class="p">.</code><code class="n">Name</code><code class="p">,</code>
                 <code class="n">Attribute</code> <code class="p">=</code> <code class="n">attribute</code><code class="p">,</code>
                 <code class="n">PropertyInfo</code> <code class="p">=</code> <code class="n">prop</code>
             <code class="p">})</code>
            <code class="p">.</code><code class="n">ToDictionary</code><code class="p">(</code>
                <code class="n">key</code> <code class="p">=&gt;</code> <code class="n">key</code><code class="p">.</code><code class="n">Name</code><code class="p">,</code>
                <code class="n">val</code> <code class="p">=&gt;</code> <code class="n">val</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">protected</code> <code class="n">List</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="n">GetColumns</code><code class="p">(</code>
        <code class="n">IEnumerable</code><code class="p">&lt;</code><code class="n">ColumnDetail</code><code class="p">&gt;</code> <code class="n">details</code><code class="p">,</code>
        <code class="n">TData</code> <code class="n">item</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="kt">var</code> <code class="n">columns</code> <code class="p">=</code> <code class="k">new</code> <code class="n">List</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;();</code>

        <code class="k">foreach</code> <code class="p">(</code><code class="kt">var</code> <code class="n">detail</code> <code class="k">in</code> <code class="n">details</code><code class="p">)</code>
        <code class="p">{</code>
            <code class="n">PropertyInfo</code> <code class="n">member</code> <code class="p">=</code> <code class="n">detail</code><code class="p">.</code><code class="n">PropertyInfo</code><code class="p">;</code>
            <code class="kt">string</code> <code class="n">format</code> <code class="p">=</code>
                <code class="kt">string</code><code class="p">.</code><code class="n">IsNullOrWhiteSpace</code><code class="p">(</code>
                    <code class="n">detail</code><code class="p">.</code><code class="n">Attribute</code><code class="p">.</code><code class="n">Format</code><code class="p">)</code> <code class="p">?</code>
                    <code class="s">"{0}"</code> <code class="p">:</code>
                    <code class="n">detail</code><code class="p">.</code><code class="n">Attribute</code><code class="p">.</code><code class="n">Format</code><code class="p">;</code>

            <code class="p">(</code><code class="kt">object</code> <code class="n">result</code><code class="p">,</code> <code class="n">Type</code> <code class="n">columnType</code><code class="p">)</code> <code class="p">=</code>
                <code class="n">GetReflectedResult</code><code class="p">(</code><code class="n">item</code><code class="p">,</code> <code class="n">member</code><code class="p">);</code>

            <code class="k">switch</code> <code class="p">(</code><code class="n">columnType</code><code class="p">.</code><code class="n">Name</code><code class="p">)</code>
            <code class="p">{</code>
                <code class="k">case</code> <code class="s">"Decimal"</code><code class="p">:</code>
                    <code class="n">columns</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code>
                        <code class="kt">string</code><code class="p">.</code><code class="n">Format</code><code class="p">(</code><code class="n">format</code><code class="p">,</code> <code class="p">(</code><code class="kt">decimal</code><code class="p">)</code><code class="n">result</code><code class="p">));</code>
                    <code class="k">break</code><code class="p">;</code>
                <code class="k">case</code> <code class="s">"Int32"</code><code class="p">:</code>
                    <code class="n">columns</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code>
                        <code class="kt">string</code><code class="p">.</code><code class="n">Format</code><code class="p">(</code><code class="n">format</code><code class="p">,</code> <code class="p">(</code><code class="kt">int</code><code class="p">)</code><code class="n">result</code><code class="p">));</code>
                    <code class="k">break</code><code class="p">;</code>
                <code class="k">case</code> <code class="s">"String"</code><code class="p">:</code>
                    <code class="n">columns</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code>
                        <code class="kt">string</code><code class="p">.</code><code class="n">Format</code><code class="p">(</code><code class="n">format</code><code class="p">,</code> <code class="p">(</code><code class="kt">string</code><code class="p">)</code><code class="n">result</code><code class="p">));</code>
                    <code class="k">break</code><code class="p">;</code>
                <code class="k">default</code><code class="p">:</code>
                    <code class="k">break</code><code class="p">;</code>
            <code class="p">}</code>
        <code class="p">}</code>

        <code class="k">return</code> <code class="n">columns</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="p">(</code><code class="kt">object</code><code class="p">,</code> <code class="n">Type</code><code class="p">)</code> <code class="n">GetReflectedResult</code><code class="p">(</code><code class="n">TData</code> <code class="n">item</code><code class="p">,</code> <code class="n">PropertyInfo</code> <code class="n">property</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="kt">object</code> <code class="n">result</code> <code class="p">=</code> <code class="n">property</code><code class="p">.</code><code class="n">GetValue</code><code class="p">(</code><code class="n">item</code><code class="p">);</code>
        <code class="n">Type</code> <code class="n">type</code> <code class="p">=</code> <code class="n">property</code><code class="p">.</code><code class="n">PropertyType</code><code class="p">;</code>

        <code class="k">return</code> <code class="p">(</code><code class="n">result</code><code class="p">,</code> <code class="n">type</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>This class uses that base class to generate Markdown reports:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">MarkdownGenerator</code><code class="p">&lt;</code><code class="n">TData</code><code class="p">&gt;</code> <code class="p">:</code> <code class="n">GeneratorBase</code><code class="p">&lt;</code><code class="n">TData</code><code class="p">&gt;</code>
<code class="p">{</code>
    <code class="k">const</code> <code class="kt">string</code> <code class="n">ColumnSeparator</code> <code class="p">=</code> <code class="s">" | "</code><code class="p">;</code>

    <code class="k">protected</code> <code class="k">override</code> <code class="n">StringBuilder</code> <code class="nf">GetTitle</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="k">new</code> <code class="nf">StringBuilder</code><code class="p">(</code><code class="s">"# Report\n\n"</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">protected</code> <code class="k">override</code> <code class="n">StringBuilder</code> <code class="nf">GetHeaders</code><code class="p">(</code>
        <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="n">ColumnDetail</code><code class="p">&gt;</code> <code class="n">details</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="kt">var</code> <code class="n">header</code> <code class="p">=</code> <code class="k">new</code> <code class="n">StringBuilder</code><code class="p">();</code>

        <code class="n">header</code><code class="p">.</code><code class="n">AppendJoin</code><code class="p">(</code>
            <code class="n">ColumnSeparator</code><code class="p">,</code>
            <code class="k">from</code> <code class="n">detail</code> <code class="k">in</code> <code class="n">details</code><code class="p">.</code><code class="n">Values</code>
            <code class="k">select</code> <code class="n">detail</code><code class="p">.</code><code class="n">Attribute</code><code class="p">.</code><code class="n">Name</code><code class="p">);</code>

        <code class="n">header</code><code class="p">.</code><code class="n">Append</code><code class="p">(</code><code class="s">"\n"</code><code class="p">);</code>

        <code class="n">header</code><code class="p">.</code><code class="n">AppendJoin</code><code class="p">(</code>
            <code class="n">ColumnSeparator</code><code class="p">,</code>
            <code class="k">from</code> <code class="n">detail</code> <code class="k">in</code> <code class="n">details</code><code class="p">.</code><code class="n">Values</code>
            <code class="k">let</code> <code class="n">length</code> <code class="p">=</code> <code class="n">detail</code><code class="p">.</code><code class="n">Attribute</code><code class="p">.</code><code class="n">Name</code><code class="p">.</code><code class="n">Length</code>
            <code class="k">select</code> <code class="s">""</code><code class="p">.</code><code class="n">PadLeft</code><code class="p">(</code><code class="n">length</code><code class="p">,</code> <code class="sc">'-'</code><code class="p">));</code>

        <code class="n">header</code><code class="p">.</code><code class="n">Append</code><code class="p">(</code><code class="s">"\n"</code><code class="p">);</code>

        <code class="k">return</code> <code class="n">header</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">protected</code> <code class="k">override</code> <code class="n">StringBuilder</code> <code class="nf">GetRows</code><code class="p">(</code>
        <code class="n">List</code><code class="p">&lt;</code><code class="n">TData</code><code class="p">&gt;</code> <code class="n">items</code><code class="p">,</code>
        <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="n">ColumnDetail</code><code class="p">&gt;</code> <code class="n">details</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="kt">var</code> <code class="n">rows</code> <code class="p">=</code> <code class="k">new</code> <code class="n">StringBuilder</code><code class="p">();</code>

        <code class="k">foreach</code> <code class="p">(</code><code class="kt">var</code> <code class="n">item</code> <code class="k">in</code> <code class="n">items</code><code class="p">)</code>
        <code class="p">{</code>
            <code class="n">List</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="n">columns</code> <code class="p">=</code>
                <code class="n">GetColumns</code><code class="p">(</code><code class="n">details</code><code class="p">.</code><code class="n">Values</code><code class="p">,</code> <code class="n">item</code><code class="p">);</code>

            <code class="n">rows</code><code class="p">.</code><code class="n">AppendJoin</code><code class="p">(</code><code class="n">ColumnSeparator</code><code class="p">,</code> <code class="n">columns</code><code class="p">);</code>

            <code class="n">rows</code><code class="p">.</code><code class="n">Append</code><code class="p">(</code><code class="s">"\n"</code><code class="p">);</code>
        <code class="p">}</code>

        <code class="k">return</code> <code class="n">rows</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>And this class uses that base class to generate HTML reports:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">HtmlGenerator</code><code class="p">&lt;</code><code class="n">TData</code><code class="p">&gt;</code> <code class="p">:</code> <code class="n">GeneratorBase</code><code class="p">&lt;</code><code class="n">TData</code><code class="p">&gt;</code>
<code class="p">{</code>
    <code class="k">protected</code> <code class="k">override</code> <code class="n">StringBuilder</code> <code class="nf">GetTitle</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="k">new</code> <code class="nf">StringBuilder</code><code class="p">(</code><code class="s">"&lt;h1&gt;Report&lt;/h1&gt;\n"</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">protected</code> <code class="k">override</code> <code class="n">StringBuilder</code> <code class="nf">GetHeaders</code><code class="p">(</code>
        <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="n">ColumnDetail</code><code class="p">&gt;</code> <code class="n">details</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="kt">var</code> <code class="n">header</code> <code class="p">=</code> <code class="k">new</code> <code class="n">StringBuilder</code><code class="p">(</code><code class="s">"&lt;tr&gt;\n"</code><code class="p">);</code>

        <code class="n">header</code><code class="p">.</code><code class="n">AppendJoin</code><code class="p">(</code>
            <code class="s">"\n"</code><code class="p">,</code>
            <code class="k">from</code> <code class="n">detail</code> <code class="k">in</code> <code class="n">details</code><code class="p">.</code><code class="n">Values</code>
            <code class="k">let</code> <code class="n">columnName</code> <code class="p">=</code> <code class="n">detail</code><code class="p">.</code><code class="n">Attribute</code><code class="p">.</code><code class="n">Name</code>
            <code class="k">select</code> <code class="err">$</code><code class="s">"  &lt;th&gt;{columnName}&lt;/th&gt;"</code><code class="p">);</code>

        <code class="n">header</code><code class="p">.</code><code class="n">Append</code><code class="p">(</code><code class="s">"\n&lt;/tr&gt;\n"</code><code class="p">);</code>

        <code class="k">return</code> <code class="n">header</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">protected</code> <code class="k">override</code> <code class="n">StringBuilder</code> <code class="nf">GetRows</code><code class="p">(</code>
        <code class="n">List</code><code class="p">&lt;</code><code class="n">TData</code><code class="p">&gt;</code> <code class="n">items</code><code class="p">,</code>
        <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="n">ColumnDetail</code><code class="p">&gt;</code> <code class="n">details</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">StringBuilder</code> <code class="n">rows</code> <code class="p">=</code> <code class="k">new</code> <code class="n">StringBuilder</code><code class="p">();</code>
        <code class="n">Type</code> <code class="n">itemType</code> <code class="p">=</code> <code class="n">items</code><code class="p">.</code><code class="n">First</code><code class="p">().</code><code class="n">GetType</code><code class="p">();</code>

        <code class="k">foreach</code> <code class="p">(</code><code class="kt">var</code> <code class="n">item</code> <code class="k">in</code> <code class="n">items</code><code class="p">)</code>
        <code class="p">{</code>
            <code class="n">rows</code><code class="p">.</code><code class="n">Append</code><code class="p">(</code><code class="s">"&lt;tr&gt;\n"</code><code class="p">);</code>

            <code class="n">List</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="n">columns</code> <code class="p">=</code>
                <code class="n">GetColumns</code><code class="p">(</code><code class="n">details</code><code class="p">.</code><code class="n">Values</code><code class="p">,</code> <code class="n">item</code><code class="p">);</code>

            <code class="n">rows</code><code class="p">.</code><code class="n">AppendJoin</code><code class="p">(</code>
                <code class="s">"\n"</code><code class="p">,</code>
                <code class="k">from</code> <code class="n">columnValue</code> <code class="k">in</code> <code class="n">columns</code>
                <code class="k">select</code> <code class="err">$</code><code class="s">"  &lt;td&gt;{columnValue}&lt;/td&gt;"</code><code class="p">);</code>

            <code class="n">rows</code><code class="p">.</code><code class="n">Append</code><code class="p">(</code><code class="s">"\n&lt;/tr&gt;\n"</code><code class="p">);</code>
        <code class="p">}</code>

        <code class="k">return</code> <code class="n">rows</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>This method, from the <code>Report</code> class, manages the report-generation process:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="kt">string</code> <code class="nf">Generate</code><code class="p">(</code><code class="n">List</code><code class="p">&lt;</code><code class="n">TData</code><code class="p">&gt;</code> <code class="n">items</code><code class="p">,</code> <code class="n">ReportType</code> <code class="n">reportType</code><code class="p">)</code>
<code class="p">{</code>
    <code class="n">GeneratorBase</code><code class="p">&lt;</code><code class="n">TData</code><code class="p">&gt;</code> <code class="n">generator</code> <code class="p">=</code> <code class="n">CreateGenerator</code><code class="p">(</code><code class="n">reportType</code><code class="p">);</code>

    <code class="kt">string</code> <code class="n">report</code> <code class="p">=</code> <code class="n">generator</code><code class="p">.</code><code class="n">Generate</code><code class="p">(</code><code class="n">items</code><code class="p">);</code>

    <code class="k">return</code> <code class="n">report</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>Here’s a method, from the <code>Report</code> class, that uses an enum to figure out which report format to generate:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="n">GeneratorBase</code><code class="p">&lt;</code><code class="n">TData</code><code class="p">&gt;</code> <code class="n">CreateGenerator</code><code class="p">(</code><code class="n">ReportType</code> <code class="n">reportType</code><code class="p">)</code>
<code class="p">{</code>
    <code class="n">Type</code> <code class="n">generatorType</code><code class="p">;</code>

    <code class="k">switch</code> <code class="p">(</code><code class="n">reportType</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">case</code> <code class="n">ReportType</code><code class="p">.</code><code class="n">Html</code><code class="p">:</code>
            <code class="n">generatorType</code> <code class="p">=</code> <code class="k">typeof</code><code class="p">(</code><code class="n">HtmlGenerator</code><code class="p">&lt;&gt;);</code>
            <code class="k">break</code><code class="p">;</code>
        <code class="k">case</code> <code class="n">ReportType</code><code class="p">.</code><code class="n">Markdown</code><code class="p">:</code>
            <code class="n">generatorType</code> <code class="p">=</code> <code class="k">typeof</code><code class="p">(</code><code class="n">MarkdownGenerator</code><code class="p">&lt;&gt;);</code>
            <code class="k">break</code><code class="p">;</code>
        <code class="k">default</code><code class="p">:</code>
            <code class="k">throw</code> <code class="k">new</code> <code class="nf">ArgumentException</code><code class="p">(</code>
                <code class="err">$</code><code class="s">"Unexpected ReportType: '{reportType}'"</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="n">Type</code> <code class="n">dataType</code> <code class="p">=</code> <code class="k">typeof</code><code class="p">(</code><code class="n">TData</code><code class="p">);</code>
    <code class="n">Type</code> <code class="n">genericType</code> <code class="p">=</code> <code class="n">generatorType</code><code class="p">.</code><code class="n">MakeGenericType</code><code class="p">(</code><code class="n">dataType</code><code class="p">);</code>

    <code class="kt">object</code> <code class="n">generator</code> <code class="p">=</code> <code class="n">Activator</code><code class="p">.</code><code class="n">CreateInstance</code><code class="p">(</code><code class="n">genericType</code><code class="p">);</code>

    <code class="k">return</code> <code class="p">(</code><code class="n">GeneratorBase</code><code class="p">&lt;</code><code class="n">TData</code><code class="p">&gt;)</code><code class="n">generator</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>Here’s another way, via convention, to figure out which report format to generate:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="n">GeneratorBase</code><code class="p">&lt;</code><code class="n">TData</code><code class="p">&gt;</code> <code class="n">CreateGenerator</code><code class="p">(</code><code class="n">ReportType</code> <code class="n">reportType</code><code class="p">)</code>
<code class="p">{</code>
    <code class="n">Type</code> <code class="n">dataType</code> <code class="p">=</code> <code class="k">typeof</code><code class="p">(</code><code class="n">TData</code><code class="p">);</code>

    <code class="kt">string</code> <code class="n">generatorNamespace</code> <code class="p">=</code> <code class="s">"Section_05_03."</code><code class="p">;</code>
    <code class="kt">string</code> <code class="n">generatorTypeName</code> <code class="p">=</code> <code class="err">$</code><code class="s">"{reportType}Generator`1"</code><code class="p">;</code>
    <code class="kt">string</code> <code class="n">typeParameterName</code> <code class="p">=</code> <code class="err">$</code><code class="s">"[[{dataType.FullName}]]"</code><code class="p">;</code>

    <code class="kt">string</code> <code class="n">fullyQualifiedTypeName</code> <code class="p">=</code>
        <code class="n">generatorNamespace</code> <code class="p">+</code>
        <code class="n">generatorTypeName</code> <code class="p">+</code>
        <code class="n">typeParameterName</code><code class="p">;</code>

    <code class="n">Type</code> <code class="n">generatorType</code> <code class="p">=</code> <code class="n">Type</code><code class="p">.</code><code class="n">GetType</code><code class="p">(</code><code class="n">fullyQualifiedTypeName</code><code class="p">);</code>

    <code class="kt">object</code> <code class="n">generator</code> <code class="p">=</code> <code class="n">Activator</code><code class="p">.</code><code class="n">CreateInstance</code><code class="p">(</code><code class="n">generatorType</code><code class="p">);</code>

    <code class="k">return</code> <code class="p">(</code><code class="n">GeneratorBase</code><code class="p">&lt;</code><code class="n">TData</code><code class="p">&gt;)</code><code class="n">generator</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>The <code>Main</code> method passes data and specifies which report format it wants:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">()</code>
<code class="p">{</code>
    <code class="kt">var</code> <code class="n">inventory</code> <code class="p">=</code> <code class="k">new</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">InventoryItem</code><code class="p">&gt;</code>
    <code class="p">{</code>
        <code class="k">new</code> <code class="n">InventoryItem</code>
        <code class="p">{</code>
            <code class="n">PartNumber</code> <code class="p">=</code> <code class="s">"1"</code><code class="p">,</code>
            <code class="n">Description</code> <code class="p">=</code> <code class="s">"Part #1"</code><code class="p">,</code>
            <code class="n">Count</code> <code class="p">=</code> <code class="m">3</code><code class="p">,</code>
            <code class="n">ItemPrice</code> <code class="p">=</code> <code class="m">5.26</code><code class="n">m</code>
        <code class="p">},</code>
        <code class="k">new</code> <code class="n">InventoryItem</code>
        <code class="p">{</code>
            <code class="n">PartNumber</code> <code class="p">=</code> <code class="s">"2"</code><code class="p">,</code>
            <code class="n">Description</code> <code class="p">=</code> <code class="s">"Part #2"</code><code class="p">,</code>
            <code class="n">Count</code> <code class="p">=</code> <code class="m">1</code><code class="p">,</code>
            <code class="n">ItemPrice</code> <code class="p">=</code> <code class="m">7.95</code><code class="n">m</code>
        <code class="p">},</code>
        <code class="k">new</code> <code class="n">InventoryItem</code>
        <code class="p">{</code>
            <code class="n">PartNumber</code> <code class="p">=</code> <code class="s">"3"</code><code class="p">,</code>
            <code class="n">Description</code> <code class="p">=</code> <code class="s">"Part #3"</code><code class="p">,</code>
            <code class="n">Count</code> <code class="p">=</code> <code class="m">2</code><code class="p">,</code>
            <code class="n">ItemPrice</code> <code class="p">=</code> <code class="m">23.13</code><code class="n">m</code>
        <code class="p">},</code>
    <code class="p">};</code>

    <code class="kt">string</code> <code class="n">report</code> <code class="p">=</code>
        <code class="k">new</code> <code class="n">Report</code><code class="p">&lt;</code><code class="n">InventoryItem</code><code class="p">&gt;()</code>
        <code class="p">.</code><code class="n">Generate</code><code class="p">(</code><code class="n">inventory</code><code class="p">,</code> <code class="n">ReportType</code><code class="p">.</code><code class="n">Markdown</code><code class="p">);</code>

    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">report</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>And here’s the output:</p>

<pre data-type="programlisting" data-code-language="text"># Report

Part # | Name | Amount | Price
------ | ---- | ------ | -----
1 | Part #1 | 3 | $5.26
2 | Part #2 | 1 | $7.95
3 | Part #3 | 2 | $23.13</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678781868944">
<h2>Discussion</h2>

<p><a data-type="xref" href="#accessing_type_members_with_reflection">Recipe 5.2</a> created reports based on a generic object type, and this caused us to lose the type safety we are accustomed to. This section fixes that problem by using generics and showing how to use reflection to instantiate objects with a generic type <span class="keep-together">parameter</span>.</p>

<p>The concept of the previous sections was to generate a report in Markdown format. However, a report generator could be much more useful if it had the ability to generate reports in any format of your choosing. This example refactors the example in <a data-type="xref" href="#accessing_type_members_with_reflection">Recipe 5.2</a> to offer both a Markdown and an HTML output report.</p>

<p>The <code>ReportType</code> enum specifies the type of report output to generate: <code>Html</code> or <code>Markdown</code>. Because we can generate multiple formats, we need separate classes for each format: <code>HtmlGenerator</code> and <code>MarkdownGenerator</code>. Further, we don’t want to duplicate code, so each format generation class derives from <code>GeneratorBase</code>.</p>

<p>Notice that <code>GeneratorBase</code> is an abstract class (you can’t instantiate it), with both <code>abstract</code> and implemented methods. The implemented methods in <code>GeneratorBase</code> have code that is independent of output formatted and that all derived generator classes will use: <code>GetColumns</code>, <code>GetColumnDetails</code>, and <code>GetReflectedResult</code>. By definition, the derived generator classes must <code>override</code> the <code>abstract</code> methods, which are format specific: <code>GetTitle</code>, <code>GetHeaders</code>, <code>GetRows</code>. Looking at <code>HtmlGenerator</code> and <code>MarkdownGenerator</code>, you can see the <code>override</code> implementations for these <code>abstract</code> 
<span class="keep-together">methods</span>.</p>

<p>Now, let’s put this all together so it makes sense. When the program starts, the first method called on the <code>Report</code> instance is <code>Generate</code>, in <code>GeneratorBase</code>. Notice how <code>Generate</code> calls the sequence: <code>GetTitle</code>, <code>GetColumnDetails</code>, <code>GetHeaders</code>, and then <code>GetRows</code>. This is essentially the same sequence as described in <a data-type="xref" href="#accessing_type_members_with_reflection">Recipe 5.2</a>. You can imagine a report being generated top to bottom by writing the title, getting metadata for the rest of the report, writing the header, and then writing each of the rows of the report. To get code reuse and create an extensible framework for adding report formats in the future, we have a general abstract base class, <code>GeneratorBase</code>, and derived classes that understand the format. Using <code>MarkdownGenerator</code> as an example, here’s the sequence:</p>
<ol>
<li>
<p>External code calls <code>GeneratorBase.Generate</code>.</p>
</li>
<li>
<p><code>Generator.Generate</code> calls <code>MarkdownGenerator.GetTitle</code>.</p>
</li>
<li>
<p><code>Generator.Generate</code> calls <code>Generator.GetColumnDetails</code>.</p>
</li>
<li>
<p><code>Generator.Generate</code> calls <code>MarkdownGenerator.GetHeader</code>.</p>
</li>
<li>
<p><code>Generator.Generate</code> calls <code>MarkdownGenerator.GetRows</code>.</p>
</li>
<li>
<p><code>MarkdownGenerator.GetRows</code> calls <code>Generator.GetColumns</code>.</p>
</li>
<li>
<p><code>Generator.GetColumns</code> calls <code>Generator.GetReflectedResult</code>.</p>
</li>
<li>
<p><code>MarkdownGenerator.GetRows</code> completes, returning to <code>Generator.Generate</code>.</p>
</li>
<li>
<p><code>Generator.Generate</code> returns the report to calling code.</p>
</li>

</ol>

<p>The <code>HtmlGenerator</code> works exactly the same way, and so would any future <span class="keep-together">report</span> format. In fact, <a data-type="xref" href="#performing_interop_with_office_apps">Recipe 5.6</a> extends this example by adding a third format to support creating an Excel report.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><a data-type="indexterm" data-primary="template pattern" id="idm45678780295264"/>The solution uses a pattern known as the <em>template pattern</em>. In this pattern, a base class implements common logic and delegates implementation-specific work to derived classes. This is the object-oriented principle of polymorphism at work.</p>

<p>The fact that we can extend this framework without needing to re-write boilerplate logic makes this a viable approach. <a data-type="xref" href="#performing_interop_with_office_apps">Recipe 5.6</a> shows how that works.</p>
</div>

<p>The <code>GenerateBase</code> class is intentionally <code>abstract</code> because the only way for this to work is via an instance of a derived class. The <code>Report.Generate</code> method calls <code>GeneratorBase.Generate</code>. Before doing so, it must figure out which specific <code>GeneratorBase</code> derived class to instantiate via <code>CreateGenerator</code>, of which there are two examples.</p>

<p>The first example of <code>CreateGenerator</code> examines the <code>ReportType</code> enum to see which type of report to generate via a <code>switch</code> statement. As explained in earlier sections, you need a <code>Type</code> object to perform reflection, which the <code>typeof</code> operator does. Notice that we’re passing a generic type with the <code>&lt;&gt;</code> suffix, without the generic type. After that, we use the <code>typeof</code> operator to get the type of the type parameter passed to the <code>Report</code> class, <code>TData</code>. Now we have a type for both the generic type and its type parameter. Next, we need to bring the generic type and its parameter type together to get a fully constructed type, (e.g., <code>HtmlGenerator&lt;TData&gt;</code> for <code>Html</code>). Once you have a fully constructed type, you can use the <code>Activator</code> class to call <code>CreateInstance</code>, which instantiates the type. With a new instance of the <code>GeneratorBase</code>-derived type, <code>CreateGenerate</code> returns to <code>ReportGenerate</code>, which calls <code>Generate</code> on the new instance. As you learned earlier, <code>GeneratorBase</code> implements <code>Generate</code> for all derived instances.</p>

<p>That is one way to use reflection to instantiate a generic type, as specified by the problem statement. One thing to consider, though, is whether you want to add more formats to support in the future. You’ll have to go back into the <code>Report</code> class and change the <code>switch</code> statement, which is a configuration by code change. What if you prefer to write the <code>Report</code> class one time and never touch it again? Further, what if you preferred a design by the principles of convention-over-configuration? A good example of convention over configuration in .NET is ASP.NET MVC. A couple of ASP.NET MVC conventions are that controllers go in a <code>Controllers</code> folder and views go in a <code>Views</code> folder. Another is that the controller name is the URL path with a <code>Controller</code> suffix to its name. Things just work because that’s the convention. The second example of <code>CreateGenerator</code> uses the convention-over-configuration approach.</p>

<p>Notice that the second implementation of <code>CreateGenerator</code> builds a fully qualified type name with namespace and typename (e.g., <code>Section_05_03.HtmlGenerator</code> for <code>Html</code>). Also notice that the <code>ReportType</code> enum members match the class names exactly. This means that anytime in the future, you can create a new format, derived from <code>GeneratorBase</code>, and add the prefix to <code>ReportType</code> with <code>Generator</code> as the suffix and it will work. No need to ever touch the <code>Report</code> class again, unless adding a new feature.</p>

<p>After getting type objects, both <code>CreateGenerator</code> examples call <code>Activator.Create​In⁠stance</code> to return a new instance to <code>Report.Generate</code>.</p>

<p>Finally, looking at the <code>Main</code> method, all a user of this report library needs to do is pass in the data and the <code>ReportType</code> they want to generate.<a data-type="indexterm" data-startref="ix_ch05-asciidoc10" id="idm45678780267888"/><a data-type="indexterm" data-startref="ix_ch05-asciidoc9" id="idm45678780267152"/><a data-type="indexterm" data-startref="ix_ch05-asciidoc8" id="idm45678780266480"/><a data-type="indexterm" data-startref="ix_ch05-asciidoc7" id="idm45678780265808"/><a data-type="indexterm" data-startref="ix_ch05-asciidoc6" id="idm45678780265136"/><a data-type="indexterm" data-startref="ix_ch05-asciidoc5" id="idm45678780264464"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45678780350784">
<h2>See Also</h2>

<p><a data-type="xref" data-xrefstyle="rec-num-title" href="#accessing_type_members_with_reflection">Recipe 5.2, “Accessing Type Members with Reflection”</a></p>

<p><a data-type="xref" data-xrefstyle="rec-num-title" href="#performing_interop_with_office_apps">Recipe 5.6, “Performing Interop with Office Apps”</a></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.4 Invoking Methods with Reflection"><div class="sect1" id="invoking_methods_with_reflection">
<h1>5.4 Invoking Methods with Reflection</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678780258400">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="methods" data-secondary="invoking with reflection" id="ix_ch05-asciidoc11"/><a data-type="indexterm" data-primary="reflection" data-secondary="invoking methods with" id="ix_ch05-asciidoc12"/>An object you’ve received has methods that you need to invoke.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678780254288">
<h2>Solution</h2>

<p>The column metadata class has a <code>MemberInfo</code> property:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">ColumnDetail</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Name</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="n">ColumnAttribute</code> <code class="n">Attribute</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="n">MemberInfo</code> <code class="n">MemberInfo</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code></pre>

<p>This class, to be reflected upon, has properties and a method:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">InventoryItem</code>
<code class="p">{</code>
<code class="na">    [Column("Part #")]</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">PartNumber</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [Column("Name")]</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Description</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [Column("Amount")]</code>
    <code class="k">public</code> <code class="kt">int</code> <code class="n">Count</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [Column("Price", Format = "{0:c}")]</code>
    <code class="k">public</code> <code class="kt">decimal</code> <code class="n">ItemPrice</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [Column("Total", Format = "{0:c}")]</code>
    <code class="k">public</code> <code class="kt">decimal</code> <code class="nf">CalculateTotal</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="n">ItemPrice</code> <code class="p">*</code> <code class="n">Count</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>This method calls <code>GetMembers</code> to work with <code>MemberInfo</code> instances:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="n">ColumnDetail</code><code class="p">&gt;</code> <code class="n">GetColumnDetails</code><code class="p">(</code>
    <code class="n">List</code><code class="p">&lt;</code><code class="kt">object</code><code class="p">&gt;</code> <code class="n">items</code><code class="p">)</code>
<code class="p">{</code>
    <code class="k">return</code>
        <code class="p">(</code><code class="k">from</code> <code class="n">member</code> <code class="k">in</code>
            <code class="n">items</code><code class="p">.</code><code class="n">First</code><code class="p">().</code><code class="n">GetType</code><code class="p">().</code><code class="n">GetMembers</code><code class="p">()</code>
         <code class="k">let</code> <code class="n">attribute</code> <code class="p">=</code>
            <code class="n">member</code><code class="p">.</code><code class="n">GetCustomAttribute</code><code class="p">&lt;</code><code class="n">ColumnAttribute</code><code class="p">&gt;()</code>
         <code class="k">where</code> <code class="n">attribute</code> <code class="p">!=</code> <code class="k">null</code>
         <code class="k">select</code> <code class="k">new</code> <code class="n">ColumnDetail</code>
         <code class="p">{</code>
             <code class="n">Name</code> <code class="p">=</code> <code class="n">member</code><code class="p">.</code><code class="n">Name</code><code class="p">,</code>
             <code class="n">Attribute</code> <code class="p">=</code> <code class="n">attribute</code><code class="p">,</code>
             <code class="n">MemberInfo</code> <code class="p">=</code> <code class="n">member</code>
         <code class="p">})</code>
        <code class="p">.</code><code class="n">ToDictionary</code><code class="p">(</code>
            <code class="n">key</code> <code class="p">=&gt;</code> <code class="n">key</code><code class="p">.</code><code class="n">Name</code><code class="p">,</code>
            <code class="n">val</code> <code class="p">=&gt;</code> <code class="n">val</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>This method uses the <code>MemberInfo</code> type to determine how to retrieve a value:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="p">(</code><code class="kt">object</code><code class="p">,</code> <code class="n">Type</code><code class="p">)</code> <code class="n">GetReflectedResult</code><code class="p">(</code>
    <code class="n">Type</code> <code class="n">itemType</code><code class="p">,</code> <code class="kt">object</code> <code class="n">item</code><code class="p">,</code> <code class="n">MemberInfo</code> <code class="n">member</code><code class="p">)</code>
<code class="p">{</code>
    <code class="kt">object</code> <code class="n">result</code><code class="p">;</code>
    <code class="n">Type</code> <code class="n">type</code><code class="p">;</code>

    <code class="k">switch</code> <code class="p">(</code><code class="n">member</code><code class="p">.</code><code class="n">MemberType</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">case</code> <code class="n">MemberTypes</code><code class="p">.</code><code class="n">Method</code><code class="p">:</code>
            <code class="n">MethodInfo</code> <code class="n">method</code> <code class="p">=</code>
                <code class="n">itemType</code><code class="p">.</code><code class="n">GetMethod</code><code class="p">(</code><code class="n">member</code><code class="p">.</code><code class="n">Name</code><code class="p">);</code>
            <code class="n">result</code> <code class="p">=</code> <code class="n">method</code><code class="p">.</code><code class="n">Invoke</code><code class="p">(</code><code class="n">item</code><code class="p">,</code> <code class="k">null</code><code class="p">);</code>
            <code class="n">type</code> <code class="p">=</code> <code class="n">method</code><code class="p">.</code><code class="n">ReturnType</code><code class="p">;</code>
            <code class="k">break</code><code class="p">;</code>
        <code class="k">case</code> <code class="n">MemberTypes</code><code class="p">.</code><code class="n">Property</code><code class="p">:</code>
            <code class="n">PropertyInfo</code> <code class="n">property</code> <code class="p">=</code>
                <code class="n">itemType</code><code class="p">.</code><code class="n">GetProperty</code><code class="p">(</code><code class="n">member</code><code class="p">.</code><code class="n">Name</code><code class="p">);</code>
            <code class="n">result</code> <code class="p">=</code> <code class="n">property</code><code class="p">.</code><code class="n">GetValue</code><code class="p">(</code><code class="n">item</code><code class="p">);</code>
            <code class="n">type</code> <code class="p">=</code> <code class="n">property</code><code class="p">.</code><code class="n">PropertyType</code><code class="p">;</code>
            <code class="k">break</code><code class="p">;</code>
        <code class="k">default</code><code class="p">:</code>
            <code class="k">throw</code> <code class="k">new</code> <code class="nf">ArgumentException</code><code class="p">(</code>
                <code class="s">"Expected property or method."</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">return</code> <code class="p">(</code><code class="n">result</code><code class="p">,</code> <code class="n">type</code><code class="p">);</code>
<code class="p">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678779972000">
<h2>Discussion</h2>

<p>Earlier sections in this chapter worked primarily with properties as report inputs. In this section we’ll modify the example in <a data-type="xref" href="#accessing_type_members_with_reflection">Recipe 5.2</a> and add a method that we’ll need to invoke via reflection.</p>

<p>The first change is that <code>ColumnDetail</code> has a <code>MemberInfo</code> property, which holds metadata for any type member.</p>

<p>The <code>InventoryItem</code> class has a <code>CalculateTotal</code> method. It multiplies the <code>ItemPrice</code> and <code>Count</code> to show the total price for that amount of items.</p>

<p>The change in <code>GetColumnDetails</code> is in the LINQ statement, where it iterates on the result of <code>GetMembers</code>, which is a <code>MemberInfo[]</code>. Unlike <a data-type="xref" href="#accessing_type_members_with_reflection">Recipe 5.2</a>, we’re using <code>MemberInfo</code>. This is required for this solution because we want information on both properties and methods.</p>

<p>Finally, <code>GetReflectedResult</code> has a <code>switch</code> statement to figure out how to get a member’s value. Since the parameter is a <code>MemberInfo</code>, we look at the <code>MemberType</code> property to figure out whether we’re working with a property or method. In either case, we have to call <code>GetProperty</code> or <code>GetMethod</code> to get a <code>PropertyInfo</code> or <code>MethodInfo</code>, respectively. Call the <code>Invoke</code> method for methods, with <code>item</code> as the object instance to invoke the method on. The second parameter to <code>Invoke</code> is <code>null</code>, indicating that the method, <code>CalculateTotal</code> in this example, doesn’t have arguments. If you need to pass arguments, put an <code>object[]</code> in the second parameter of <code>Invoke</code> with the members in the order that the method expects them. As in <a data-type="xref" href="#accessing_type_members_with_reflection">Recipe 5.2</a>, call <code>GetValue</code> on the <code>Proper⁠ty​Info</code> instance, with <code>item</code> as the object reference to get the value of that property.</p>

<p>To summarize, anytime you need to call a method on an object via reflection, get its <code>Type</code> object, get a <code>MethodInfo</code> (even if you need the intermediate step of pulling from a <code>MemberInfo</code>), and call the <code>Invoke</code> method on the <code>MethodInfo</code> with the object instance as the argument<a data-type="indexterm" data-startref="ix_ch05-asciidoc12" id="idm45678779786544"/><a data-type="indexterm" data-startref="ix_ch05-asciidoc11" id="idm45678779785840"/>.<a data-type="indexterm" data-startref="ix_ch05-asciidoc0" id="idm45678779785040"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45678779784336">
<h2>See Also</h2>

<p><a data-type="xref" data-xrefstyle="rec-num-title" href="#accessing_type_members_with_reflection">Recipe 5.2, “Accessing Type Members with Reflection”</a></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.5 Replacing Reflection with Dynamic Code"><div class="sect1" id="idm45678779781872">
<h1>5.5 Replacing Reflection with Dynamic Code</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678779780752">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="dynamic" data-secondary="implementing" id="ix_ch05-asciidoc13"/>You’re <a data-type="indexterm" data-primary="dynamic" data-secondary="replacing reflection with dynamic code" id="ix_ch05-asciidoc14"/><a data-type="indexterm" data-primary="reflection" data-secondary="replacing with dynamic code" id="ix_ch05-asciidoc15"/>using reflection but know what some of a type’s members are and want to simplify code.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678779775136">
<h2>Solution</h2>

<p>This class contains the list of data for a report:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">Inventory</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Title</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="n">List</code><code class="p">&lt;</code><code class="kt">object</code><code class="p">&gt;</code> <code class="n">Data</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code></pre>

<p>Here’s the <code>Main</code> method that populates the data:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">()</code>
<code class="p">{</code>
    <code class="kt">var</code> <code class="n">inventory</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Inventory</code>
    <code class="p">{</code>
        <code class="n">Title</code> <code class="p">=</code> <code class="s">"Inventory Report"</code><code class="p">,</code>
        <code class="n">Data</code> <code class="p">=</code> <code class="k">new</code> <code class="n">List</code><code class="p">&lt;</code><code class="kt">object</code><code class="p">&gt;</code>
        <code class="p">{</code>
            <code class="k">new</code> <code class="n">InventoryItem</code>
            <code class="p">{</code>
                <code class="n">PartNumber</code> <code class="p">=</code> <code class="s">"1"</code><code class="p">,</code>
                <code class="n">Description</code> <code class="p">=</code> <code class="s">"Part #1"</code><code class="p">,</code>
                <code class="n">Count</code> <code class="p">=</code> <code class="m">3</code><code class="p">,</code>
                <code class="n">ItemPrice</code> <code class="p">=</code> <code class="m">5.26</code><code class="n">m</code>
            <code class="p">},</code>
            <code class="k">new</code> <code class="n">InventoryItem</code>
            <code class="p">{</code>
                <code class="n">PartNumber</code> <code class="p">=</code> <code class="s">"2"</code><code class="p">,</code>
                <code class="n">Description</code> <code class="p">=</code> <code class="s">"Part #2"</code><code class="p">,</code>
                <code class="n">Count</code> <code class="p">=</code> <code class="m">1</code><code class="p">,</code>
                <code class="n">ItemPrice</code> <code class="p">=</code> <code class="m">7.95</code><code class="n">m</code>
            <code class="p">},</code>
            <code class="k">new</code> <code class="n">InventoryItem</code>
            <code class="p">{</code>
                <code class="n">PartNumber</code> <code class="p">=</code> <code class="s">"3"</code><code class="p">,</code>
                <code class="n">Description</code> <code class="p">=</code> <code class="s">"Part #3"</code><code class="p">,</code>
                <code class="n">Count</code> <code class="p">=</code> <code class="m">2</code><code class="p">,</code>
                <code class="n">ItemPrice</code> <code class="p">=</code> <code class="m">23.13</code><code class="n">m</code>
            <code class="p">},</code>
        <code class="p">}</code>
    <code class="p">};</code>

    <code class="kt">string</code> <code class="n">report</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Report</code><code class="p">().</code><code class="n">Generate</code><code class="p">(</code><code class="n">inventory</code><code class="p">);</code>

    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">report</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>This method uses reflection to extract a property’s values:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="kt">string</code> <code class="nf">Generate</code><code class="p">(</code><code class="kt">object</code> <code class="n">reportDetails</code><code class="p">)</code>
<code class="p">{</code>
    <code class="n">Type</code> <code class="n">reportType</code> <code class="p">=</code> <code class="n">reportDetails</code><code class="p">.</code><code class="n">GetType</code><code class="p">();</code>
    <code class="n">PropertyInfo</code> <code class="n">titleProp</code> <code class="p">=</code> <code class="n">reportType</code><code class="p">.</code><code class="n">GetProperty</code><code class="p">(</code><code class="s">"Title"</code><code class="p">);</code>
    <code class="kt">string</code> <code class="n">title</code> <code class="p">=</code> <code class="p">(</code><code class="kt">string</code><code class="p">)</code><code class="n">titleProp</code><code class="p">.</code><code class="n">GetValue</code><code class="p">(</code><code class="n">reportDetails</code><code class="p">);</code>

    <code class="kt">var</code> <code class="n">report</code> <code class="p">=</code> <code class="k">new</code> <code class="n">StringBuilder</code><code class="p">(</code><code class="err">$</code><code class="s">"# {title}\n\n"</code><code class="p">);</code>

    <code class="n">PropertyInfo</code> <code class="n">dataProp</code> <code class="p">=</code> <code class="n">reportType</code><code class="p">.</code><code class="n">GetProperty</code><code class="p">(</code><code class="s">"Data"</code><code class="p">);</code>
    <code class="n">List</code><code class="p">&lt;</code><code class="kt">object</code><code class="p">&gt;</code> <code class="n">items</code> <code class="p">=</code>
        <code class="p">(</code><code class="n">List</code><code class="p">&lt;</code><code class="kt">object</code><code class="p">&gt;)</code><code class="n">dataProp</code><code class="p">.</code><code class="n">GetValue</code><code class="p">(</code><code class="n">reportDetails</code><code class="p">);</code>

    <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="n">ColumnDetail</code><code class="p">&gt;</code> <code class="n">columnDetails</code> <code class="p">=</code>
        <code class="n">GetColumnDetails</code><code class="p">(</code><code class="n">items</code><code class="p">);</code>
    <code class="n">report</code><code class="p">.</code><code class="n">Append</code><code class="p">(</code><code class="n">GetHeaders</code><code class="p">(</code><code class="n">columnDetails</code><code class="p">));</code>
    <code class="n">report</code><code class="p">.</code><code class="n">Append</code><code class="p">(</code><code class="n">GetRows</code><code class="p">(</code><code class="n">items</code><code class="p">,</code> <code class="n">columnDetails</code><code class="p">));</code>

    <code class="k">return</code> <code class="n">report</code><code class="p">.</code><code class="n">ToString</code><code class="p">();</code>
<code class="p">}</code></pre>

<p>And this class extracts the same property values but uses <code>dynamic</code>:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="kt">string</code> <code class="nf">Generate</code><code class="p">(</code><code class="kt">dynamic</code> <code class="n">reportDetails</code><code class="p">)</code>
<code class="p">{</code>
    <code class="kt">string</code> <code class="n">title</code> <code class="p">=</code> <code class="n">reportDetails</code><code class="p">.</code><code class="n">Title</code><code class="p">;</code>

    <code class="kt">var</code> <code class="n">report</code> <code class="p">=</code> <code class="k">new</code> <code class="n">StringBuilder</code><code class="p">(</code>
        <code class="err">$</code><code class="s">"# {title}\n\n"</code><code class="p">);</code>

    <code class="n">List</code><code class="p">&lt;</code><code class="kt">object</code><code class="p">&gt;</code> <code class="n">items</code> <code class="p">=</code> <code class="n">reportDetails</code><code class="p">.</code><code class="n">Data</code><code class="p">;</code>

    <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="n">ColumnDetail</code><code class="p">&gt;</code> <code class="n">columnDetails</code> <code class="p">=</code>
        <code class="n">GetColumnDetails</code><code class="p">(</code><code class="n">items</code><code class="p">);</code>
    <code class="n">report</code><code class="p">.</code><code class="n">Append</code><code class="p">(</code><code class="n">GetHeaders</code><code class="p">(</code><code class="n">columnDetails</code><code class="p">));</code>
    <code class="n">report</code><code class="p">.</code><code class="n">Append</code><code class="p">(</code><code class="n">GetRows</code><code class="p">(</code><code class="n">items</code><code class="p">,</code> <code class="n">columnDetails</code><code class="p">));</code>

    <code class="k">return</code> <code class="n">report</code><code class="p">.</code><code class="n">ToString</code><code class="p">();</code>
<code class="p">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678779399072">
<h2>Discussion</h2>

<p>The concept of this solution is again to give users of the report library maximum control over what types they want to work with. However, what if you did have some constraints? For instance, there must be some way to set the report title, and you would need to know what that property is. This solution meets the user halfway by telling them to provide an object with <code>Title</code> and <code>Data</code> properties. <code>Title</code> has the report title and <code>Data</code> has report rows. They can use any object they want as long as they provide those properties. If the input objects had other properties on the object we don’t care about, it won’t affect the report library.</p>

<p>The class we’ll use is <code>Inventory</code>, with a <code>Title</code> string and <code>Data</code> collection. The <code>Main</code> method populates an <code>Inventory</code> instance and passes it to <code>Generate</code>.</p>

<p>We have two examples of <code>Generate</code>: one uses reflection and the other uses dynamic. After getting the type, the first example calls <code>GetProperty</code> and <code>GetValue</code> to get the value of each property. The rest of the method works just like in <a data-type="xref" href="#accessing_type_members_with_reflection">Recipe 5.2</a>.</p>

<p><a data-type="indexterm" data-primary="dynamic" data-secondary="reflection versus" id="idm45678779284576"/><a data-type="indexterm" data-primary="reflection" data-secondary="dynamic versus" id="idm45678779283376"/>As you see, reflection can be verbose, making many method calls and converting types. This is a good case for using <code>dynamic</code>. We know that <code>Title</code> and <code>Data</code> exist, so why not just access them? That’s what the second example does. First, notice that the <code>reportDetails</code> parameter type is <code>dynamic</code>. Then observe how the code calls <code>Title</code> and <code>Data</code>, placing them in strongly typed variables.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><a data-type="indexterm" data-primary="dynamic language runtime (DLR)" id="idm45678779278240"/>The <code>dynamic</code> type is still type <code>object</code> but with a little extra magic performed behind the scenes by the DLR.</p>
</div>

<p>While you don’t get IntelliSense during development because <code>dynamic</code> doesn’t know what types it’s working with, you do get readable code. Behind the scenes, the DLR did all the work for you. When you know the members of the types being passed to the code, <code>dynamic</code> is a better mechanism for reflection.<a data-type="indexterm" data-startref="ix_ch05-asciidoc15" id="idm45678779274992"/><a data-type="indexterm" data-startref="ix_ch05-asciidoc14" id="idm45678779274288"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45678779273488">
<h2>See Also</h2>

<p><a data-type="xref" data-xrefstyle="rec-num-title" href="#accessing_type_members_with_reflection">Recipe 5.2, “Accessing Type Members with Reflection”</a></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.6 Performing Interop with Office Apps"><div class="sect1" id="performing_interop_with_office_apps">
<h1>5.6 Performing Interop with Office Apps</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678779269456">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="applications" data-secondary="performing interop with Office apps" id="ix_ch05-asciidoc16"/><a data-type="indexterm" data-primary="dynamic" data-secondary="performing interop with Office apps" id="ix_ch05-asciidoc17"/><a data-type="indexterm" data-primary="interop, performing with Office apps" id="ix_ch05-asciidoc18"/><a data-type="indexterm" data-primary="Microsoft Office, performing interop with apps" id="ix_ch05-asciidoc19"/><a data-type="indexterm" data-primary="Office, performing interop with apps" id="ix_ch05-asciidoc20"/>You need to populate an Excel spreadsheet with object data with the simplest code possible.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678779262320">
<h2>Solution</h2>

<p>Here’s an enum with extra members for Excel:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">enum</code> <code class="n">ReportType</code>
<code class="p">{</code>
    <code class="n">Html</code><code class="p">,</code>
    <code class="n">Markdown</code><code class="p">,</code>
    <code class="n">ExcelTyped</code><code class="p">,</code>
    <code class="n">ExcelDynamic</code>
<code class="p">}</code></pre>

<p>Excel report generator without <code>dynamic</code>:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">ExcelTypedGenerator</code><code class="p">&lt;</code><code class="n">TData</code><code class="p">&gt;</code> <code class="p">:</code> <code class="n">GeneratorBase</code><code class="p">&lt;</code><code class="n">TData</code><code class="p">&gt;</code>
<code class="p">{</code>
    <code class="n">ApplicationClass</code> <code class="n">excelApp</code><code class="p">;</code>
    <code class="n">Workbook</code> <code class="n">wkBook</code><code class="p">;</code>
    <code class="n">Worksheet</code> <code class="n">wkSheet</code><code class="p">;</code>

    <code class="k">public</code> <code class="nf">ExcelTypedGenerator</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">excelApp</code> <code class="p">=</code> <code class="k">new</code> <code class="n">ApplicationClass</code><code class="p">();</code>
        <code class="n">excelApp</code><code class="p">.</code><code class="n">Visible</code> <code class="p">=</code> <code class="k">true</code><code class="p">;</code>

        <code class="n">wkBook</code> <code class="p">=</code> <code class="n">excelApp</code><code class="p">.</code><code class="n">Workbooks</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code><code class="n">Missing</code><code class="p">.</code><code class="n">Value</code><code class="p">);</code>
        <code class="n">wkSheet</code> <code class="p">=</code> <code class="p">(</code><code class="n">Worksheet</code><code class="p">)</code><code class="n">wkBook</code><code class="p">.</code><code class="n">ActiveSheet</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">protected</code> <code class="k">override</code> <code class="n">StringBuilder</code> <code class="nf">GetTitle</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">wkSheet</code><code class="p">.</code><code class="n">Cells</code><code class="p">[</code><code class="m">1</code><code class="p">,</code> <code class="m">1</code><code class="p">]</code> <code class="p">=</code> <code class="s">"Report"</code><code class="p">;</code>

        <code class="k">return</code> <code class="k">new</code> <code class="nf">StringBuilder</code><code class="p">(</code><code class="s">"Added Title...\n"</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">protected</code> <code class="k">override</code> <code class="n">StringBuilder</code> <code class="nf">GetHeaders</code><code class="p">(</code>
        <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="n">ColumnDetail</code><code class="p">&gt;</code> <code class="n">details</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">ColumnDetail</code><code class="p">[]</code> <code class="n">values</code> <code class="p">=</code> <code class="n">details</code><code class="p">.</code><code class="n">Values</code><code class="p">.</code><code class="n">ToArray</code><code class="p">();</code>

        <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code> <code class="n">i</code> <code class="p">&lt;</code> <code class="n">values</code><code class="p">.</code><code class="n">Length</code><code class="p">;</code> <code class="n">i</code><code class="p">++)</code>
        <code class="p">{</code>
            <code class="n">ColumnDetail</code> <code class="n">detail</code> <code class="p">=</code> <code class="n">values</code><code class="p">[</code><code class="n">i</code><code class="p">];</code>
            <code class="n">wkSheet</code><code class="p">.</code><code class="n">Cells</code><code class="p">[</code><code class="m">3</code><code class="p">,</code> <code class="n">i</code><code class="p">+</code><code class="m">1</code><code class="p">]</code> <code class="p">=</code> <code class="n">detail</code><code class="p">.</code><code class="n">Attribute</code><code class="p">.</code><code class="n">Name</code><code class="p">;</code>
        <code class="p">}</code>

        <code class="k">return</code> <code class="k">new</code> <code class="nf">StringBuilder</code><code class="p">(</code><code class="s">"Added Header...\n"</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">protected</code> <code class="k">override</code> <code class="n">StringBuilder</code> <code class="nf">GetRows</code><code class="p">(</code>
        <code class="n">List</code><code class="p">&lt;</code><code class="n">TData</code><code class="p">&gt;</code> <code class="n">items</code><code class="p">,</code>
        <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="n">ColumnDetail</code><code class="p">&gt;</code> <code class="n">details</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">const</code> <code class="kt">int</code> <code class="n">DataStartRow</code> <code class="p">=</code> <code class="m">4</code><code class="p">;</code>

        <code class="kt">int</code> <code class="n">rows</code> <code class="p">=</code> <code class="n">items</code><code class="p">.</code><code class="n">Count</code><code class="p">;</code>
        <code class="kt">int</code> <code class="n">cols</code> <code class="p">=</code> <code class="n">details</code><code class="p">.</code><code class="n">Count</code><code class="p">;</code>

        <code class="kt">var</code> <code class="n">data</code> <code class="p">=</code> <code class="k">new</code> <code class="kt">string</code><code class="p">[</code><code class="n">rows</code><code class="p">,</code> <code class="n">cols</code><code class="p">];</code>

        <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code> <code class="n">i</code> <code class="p">&lt;</code> <code class="n">rows</code><code class="p">;</code> <code class="n">i</code><code class="p">++)</code>
        <code class="p">{</code>
            <code class="n">List</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="n">columns</code> <code class="p">=</code>
                <code class="n">GetColumns</code><code class="p">(</code><code class="n">details</code><code class="p">.</code><code class="n">Values</code><code class="p">,</code> <code class="n">items</code><code class="p">[</code><code class="n">i</code><code class="p">]);</code>

            <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">j</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code> <code class="n">j</code> <code class="p">&lt;</code> <code class="n">cols</code><code class="p">;</code> <code class="n">j</code><code class="p">++)</code>
            <code class="p">{</code>
                <code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code> <code class="n">j</code><code class="p">]</code> <code class="p">=</code> <code class="n">columns</code><code class="p">[</code><code class="n">j</code><code class="p">];</code>
            <code class="p">}</code>
        <code class="p">}</code>

        <code class="kt">int</code> <code class="n">FirstCol</code> <code class="p">=</code> <code class="sc">'A'</code><code class="p">;</code>
        <code class="kt">int</code> <code class="n">LastExcelCol</code> <code class="p">=</code> <code class="n">FirstCol</code> <code class="p">+</code> <code class="n">cols</code> <code class="p">-</code> <code class="m">1</code><code class="p">;</code>
        <code class="kt">int</code> <code class="n">LastExcelRow</code> <code class="p">=</code> <code class="n">DataStartRow</code> <code class="p">+</code> <code class="n">rows</code> <code class="p">-</code> <code class="m">1</code><code class="p">;</code>
        <code class="kt">string</code> <code class="n">EndRangeCol</code> <code class="p">=</code> <code class="p">((</code><code class="kt">char</code><code class="p">)</code><code class="n">LastExcelCol</code><code class="p">).</code><code class="n">ToString</code><code class="p">();</code>
        <code class="kt">string</code> <code class="n">EndRangeRow</code> <code class="p">=</code> <code class="n">LastExcelRow</code><code class="p">.</code><code class="n">ToString</code><code class="p">();</code>

        <code class="kt">string</code> <code class="n">EndRange</code> <code class="p">=</code> <code class="n">EndRangeCol</code> <code class="p">+</code> <code class="n">EndRangeRow</code><code class="p">;</code>
        <code class="kt">string</code> <code class="n">BeginRange</code> <code class="p">=</code> <code class="s">"A"</code> <code class="p">+</code> <code class="n">DataStartRow</code><code class="p">.</code><code class="n">ToString</code><code class="p">();</code>

        <code class="kt">var</code> <code class="n">dataRange</code> <code class="p">=</code> <code class="n">wkSheet</code><code class="p">.</code><code class="n">get_Range</code><code class="p">(</code><code class="n">BeginRange</code><code class="p">,</code> <code class="n">EndRange</code><code class="p">);</code>
        <code class="n">dataRange</code><code class="p">.</code><code class="n">Value2</code> <code class="p">=</code> <code class="n">data</code><code class="p">;</code>

        <code class="n">wkBook</code><code class="p">.</code><code class="n">SaveAs</code><code class="p">(</code>
            <code class="s">"Report.xlsx"</code><code class="p">,</code> <code class="n">Missing</code><code class="p">.</code><code class="n">Value</code><code class="p">,</code> <code class="n">Missing</code><code class="p">.</code><code class="n">Value</code><code class="p">,</code>
            <code class="n">Missing</code><code class="p">.</code><code class="n">Value</code><code class="p">,</code> <code class="n">Missing</code><code class="p">.</code><code class="n">Value</code><code class="p">,</code> <code class="n">Missing</code><code class="p">.</code><code class="n">Value</code><code class="p">,</code>
            <code class="n">XlSaveAsAccessMode</code><code class="p">.</code><code class="n">xlShared</code><code class="p">,</code> <code class="n">Missing</code><code class="p">.</code><code class="n">Value</code><code class="p">,</code> <code class="n">Missing</code><code class="p">.</code><code class="n">Value</code><code class="p">,</code>
            <code class="n">Missing</code><code class="p">.</code><code class="n">Value</code><code class="p">,</code> <code class="n">Missing</code><code class="p">.</code><code class="n">Value</code><code class="p">,</code> <code class="n">Missing</code><code class="p">.</code><code class="n">Value</code><code class="p">);</code>

        <code class="k">return</code> <code class="k">new</code> <code class="nf">StringBuilder</code><code class="p">(</code>
            <code class="s">"Added Data...\n"</code> <code class="p">+</code>
            <code class="s">"Excel file created at Report.xlsx"</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>Excel report generator with dynamic:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">ExcelDynamicGenerator</code><code class="p">&lt;</code><code class="n">TData</code><code class="p">&gt;</code> <code class="p">:</code> <code class="n">GeneratorBase</code><code class="p">&lt;</code><code class="n">TData</code><code class="p">&gt;</code>
<code class="p">{</code>
    <code class="n">ApplicationClass</code> <code class="n">excelApp</code><code class="p">;</code>
    <code class="kt">dynamic</code> <code class="n">wkBook</code><code class="p">;</code>
    <code class="n">Worksheet</code> <code class="n">wkSheet</code><code class="p">;</code>

    <code class="k">public</code> <code class="nf">ExcelDynamicGenerator</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">excelApp</code> <code class="p">=</code> <code class="k">new</code> <code class="n">ApplicationClass</code><code class="p">();</code>
        <code class="n">excelApp</code><code class="p">.</code><code class="n">Visible</code> <code class="p">=</code> <code class="k">true</code><code class="p">;</code>

        <code class="n">wkBook</code> <code class="p">=</code> <code class="n">excelApp</code><code class="p">.</code><code class="n">Workbooks</code><code class="p">.</code><code class="n">Add</code><code class="p">();</code>
        <code class="n">wkSheet</code> <code class="p">=</code> <code class="n">wkBook</code><code class="p">.</code><code class="n">ActiveSheet</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">protected</code> <code class="k">override</code> <code class="n">StringBuilder</code> <code class="nf">GetTitle</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">wkSheet</code><code class="p">.</code><code class="n">Cells</code><code class="p">[</code><code class="m">1</code><code class="p">,</code> <code class="m">1</code><code class="p">]</code> <code class="p">=</code> <code class="s">"Report"</code><code class="p">;</code>

        <code class="k">return</code> <code class="k">new</code> <code class="nf">StringBuilder</code><code class="p">(</code><code class="s">"Added Title...\n"</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">protected</code> <code class="k">override</code> <code class="n">StringBuilder</code> <code class="nf">GetHeaders</code><code class="p">(</code>
        <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="n">ColumnDetail</code><code class="p">&gt;</code> <code class="n">details</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">ColumnDetail</code><code class="p">[]</code> <code class="n">values</code> <code class="p">=</code> <code class="n">details</code><code class="p">.</code><code class="n">Values</code><code class="p">.</code><code class="n">ToArray</code><code class="p">();</code>

        <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code> <code class="n">i</code> <code class="p">&lt;</code> <code class="n">values</code><code class="p">.</code><code class="n">Length</code><code class="p">;</code> <code class="n">i</code><code class="p">++)</code>
        <code class="p">{</code>
            <code class="n">ColumnDetail</code> <code class="n">detail</code> <code class="p">=</code> <code class="n">values</code><code class="p">[</code><code class="n">i</code><code class="p">];</code>
            <code class="n">wkSheet</code><code class="p">.</code><code class="n">Cells</code><code class="p">[</code><code class="m">3</code><code class="p">,</code> <code class="n">i</code><code class="p">+</code><code class="m">1</code><code class="p">]</code> <code class="p">=</code> <code class="n">detail</code><code class="p">.</code><code class="n">Attribute</code><code class="p">.</code><code class="n">Name</code><code class="p">;</code>
        <code class="p">}</code>

        <code class="k">return</code> <code class="k">new</code> <code class="nf">StringBuilder</code><code class="p">(</code><code class="s">"Added Header...\n"</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">protected</code> <code class="k">override</code> <code class="n">StringBuilder</code> <code class="nf">GetRows</code><code class="p">(</code>
        <code class="n">List</code><code class="p">&lt;</code><code class="n">TData</code><code class="p">&gt;</code> <code class="n">items</code><code class="p">,</code>
        <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="n">ColumnDetail</code><code class="p">&gt;</code> <code class="n">details</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">const</code> <code class="kt">int</code> <code class="n">DataStartRow</code> <code class="p">=</code> <code class="m">4</code><code class="p">;</code>

        <code class="kt">int</code> <code class="n">rows</code> <code class="p">=</code> <code class="n">items</code><code class="p">.</code><code class="n">Count</code><code class="p">;</code>
        <code class="kt">int</code> <code class="n">cols</code> <code class="p">=</code> <code class="n">details</code><code class="p">.</code><code class="n">Count</code><code class="p">;</code>

        <code class="kt">var</code> <code class="n">data</code> <code class="p">=</code> <code class="k">new</code> <code class="kt">string</code><code class="p">[</code><code class="n">rows</code><code class="p">,</code> <code class="n">cols</code><code class="p">];</code>

        <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code> <code class="n">i</code> <code class="p">&lt;</code> <code class="n">rows</code><code class="p">;</code> <code class="n">i</code><code class="p">++)</code>
        <code class="p">{</code>
            <code class="n">List</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="n">columns</code> <code class="p">=</code>
                <code class="n">GetColumns</code><code class="p">(</code><code class="n">details</code><code class="p">.</code><code class="n">Values</code><code class="p">,</code> <code class="n">items</code><code class="p">[</code><code class="n">i</code><code class="p">]);</code>

            <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">j</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code> <code class="n">j</code> <code class="p">&lt;</code> <code class="n">cols</code><code class="p">;</code> <code class="n">j</code><code class="p">++)</code>
            <code class="p">{</code>
                <code class="n">data</code><code class="p">[</code><code class="n">i</code><code class="p">,</code> <code class="n">j</code><code class="p">]</code> <code class="p">=</code> <code class="n">columns</code><code class="p">[</code><code class="n">j</code><code class="p">];</code>
            <code class="p">}</code>
        <code class="p">}</code>

        <code class="kt">int</code> <code class="n">FirstCol</code> <code class="p">=</code> <code class="sc">'A'</code><code class="p">;</code>
        <code class="kt">int</code> <code class="n">LastExcelCol</code> <code class="p">=</code> <code class="n">FirstCol</code> <code class="p">+</code> <code class="n">cols</code> <code class="p">-</code> <code class="m">1</code><code class="p">;</code>
        <code class="kt">int</code> <code class="n">LastExcelRow</code> <code class="p">=</code> <code class="n">DataStartRow</code> <code class="p">+</code> <code class="n">rows</code> <code class="p">-</code> <code class="m">1</code><code class="p">;</code>
        <code class="kt">string</code> <code class="n">EndRangeCol</code> <code class="p">=</code> <code class="p">((</code><code class="kt">char</code><code class="p">)</code><code class="n">LastExcelCol</code><code class="p">).</code><code class="n">ToString</code><code class="p">();</code>
        <code class="kt">string</code> <code class="n">EndRangeRow</code> <code class="p">=</code> <code class="n">LastExcelRow</code><code class="p">.</code><code class="n">ToString</code><code class="p">();</code>

        <code class="kt">string</code> <code class="n">EndRange</code> <code class="p">=</code> <code class="n">EndRangeCol</code> <code class="p">+</code> <code class="n">EndRangeRow</code><code class="p">;</code>
        <code class="kt">string</code> <code class="n">BeginRange</code> <code class="p">=</code> <code class="s">"A"</code> <code class="p">+</code> <code class="n">DataStartRow</code><code class="p">.</code><code class="n">ToString</code><code class="p">();</code>

        <code class="kt">var</code> <code class="n">dataRange</code> <code class="p">=</code> <code class="n">wkSheet</code><code class="p">.</code><code class="n">get_Range</code><code class="p">(</code><code class="n">BeginRange</code><code class="p">,</code> <code class="n">EndRange</code><code class="p">);</code>
        <code class="n">dataRange</code><code class="p">.</code><code class="n">Value2</code> <code class="p">=</code> <code class="n">data</code><code class="p">;</code>

        <code class="n">wkBook</code><code class="p">.</code><code class="n">SaveAs</code><code class="p">(</code>
            <code class="s">"Report.xlsx"</code><code class="p">,</code>
            <code class="n">XlSaveAsAccessMode</code><code class="p">.</code><code class="n">xlShared</code><code class="p">);</code>

        <code class="k">return</code> <code class="k">new</code> <code class="nf">StringBuilder</code><code class="p">(</code>
            <code class="s">"Added Data...\n"</code> <code class="p">+</code>
            <code class="s">"Excel file created at Report.xlsx"</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678778660432">
<h2>Discussion</h2>

<p>This example is based on the multiple report format generation code in <a data-type="xref" href="#instantiating_type_members_with_reflection">Recipe 5.3</a>, which briefly explains how to add another report type. This solution shows how to <span class="keep-together">do it</span>.</p>

<p>First, notice that the <code>ReportType</code> enum has two extra members: <code>ExcelTyped</code> and <code>ExcelDynamic</code>. Both use the convention where <code>ExcelTyped</code> creates a <code>ExcelTyped​Gen⁠erator</code> instance and <code>ExcelDynamic</code> creates an <code>ExcelDynamicGenerator</code> instance. The difference is that <code>ExcelTypedGenerator</code> uses strongly typed code to generate an Excel report, and <code>ExcelDynamicGenerator</code> uses dynamic code to generate an Excel report.</p>
<div data-type="tip"><h6>Tip</h6>
<p>You can use techniques like this to automate any Microsoft Office application. <a data-type="indexterm" data-primary="Visual Studio Tools for Office (VSTO)" id="idm45678778197776"/>The trick is to ensure you’ve installed Visual Studio Tools for Office (VSTO) via the Visual Studio Installer. <a data-type="indexterm" data-primary="primary interop assemblies (PIAs)" id="idm45678778196848"/>This will install what is called <em>primary interop assemblies</em> (PIAs). After installation, you can find these PIAs under your Visual Studio installation folder (for instance, the folder on my machine is <em>C:\Program Files (x86)\Microsoft Visual Studio\Shared\Visual Studio Tools for Office\PIA</em>) and use the version corresponding to the Microsoft Office version you have installed. Search the <a href="https://oreil.ly/vbMvL">download options</a> if you have an older version of Office that the VSTO couldn’t install.</p>
</div>

<p>To see the differences between the two examples, go member by member. In particular, <code>ExcelTypedGenerator</code> has strongly typed fields, so it must use the <code>Missing.Value</code> placeholder anytime it doesn’t use a parameter and needs to perform a conversion on return types. Notice the <code>SaveAs</code> method call at the end of the <code>GetRows</code> method, which is particularly onerous.</p>

<p>In contrast, compare those examples with the <code>ExcelDynamicGenerator</code> code. Making the <code>wkBook</code> field <code>dynamic</code>, rather than strongly typed, transforms the code. No more <code>Missing.Value</code> placeholders or type conversions. The code is much easier to write and easier to read.<a data-type="indexterm" data-startref="ix_ch05-asciidoc20" id="idm45678778189232"/><a data-type="indexterm" data-startref="ix_ch05-asciidoc19" id="idm45678778188528"/><a data-type="indexterm" data-startref="ix_ch05-asciidoc18" id="idm45678778187856"/><a data-type="indexterm" data-startref="ix_ch05-asciidoc17" id="idm45678778187184"/><a data-type="indexterm" data-startref="ix_ch05-asciidoc16" id="idm45678778186512"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45678778185840">
<h2>See Also</h2>

<p><a data-type="xref" data-xrefstyle="rec-num-title" href="#instantiating_type_members_with_reflection">Recipe 5.3, “Instantiating Type Members with Reflection”</a></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.7 Creating an Inherently Dynamic Type"><div class="sect1" id="creating_an_inherently_dynamic_type">
<h1>5.7 Creating an Inherently Dynamic Type</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678778181696">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="data" data-secondary="creating an inherently dynamic type" id="ix_ch05-asciidoc21"/><a data-type="indexterm" data-primary="dynamic" data-secondary="creating an inherently dynamic type" id="ix_ch05-asciidoc22"/><a data-type="indexterm" data-primary="types" data-secondary="creating an inherently dynamic type" id="ix_ch05-asciidoc23"/>You have data in a proprietary format but want to access members through an object without parsing yourself.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678778176208">
<h2>Solution</h2>

<p>This class holds data to display in a report:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">LogEntry</code>
<code class="p">{</code>
<code class="na">    [Column("Log Date", Format = "{0:yyyy-MM-dd hh:mm}")]</code>
    <code class="k">public</code> <code class="n">DateTime</code> <code class="n">CreatedAt</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [Column("Severity")]</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Type</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [Column("Location")]</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Where</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [Column("Message")]</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Description</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code></pre>

<p><a data-type="indexterm" data-primary="DynamicObject type" id="ix_ch05-asciidoc24"/>These methods get log data and return a list of <code>DynamicObject</code> types with that data:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="n">List</code><code class="p">&lt;</code><code class="kt">dynamic</code><code class="p">&gt;</code> <code class="n">GetData</code><code class="p">()</code>
<code class="p">{</code>
    <code class="kt">string</code> <code class="n">headers</code> <code class="p">=</code> <code class="s">"Date|Severity|Location|Message"</code><code class="p">;</code>

    <code class="kt">string</code> <code class="n">logData</code> <code class="p">=</code> <code class="n">GetLogData</code><code class="p">();</code>

    <code class="k">return</code>
        <code class="p">(</code><code class="k">from</code> <code class="n">line</code> <code class="k">in</code> <code class="n">logData</code><code class="p">.</code><code class="n">Split</code><code class="p">(</code><code class="sc">'\n'</code><code class="p">)</code>
         <code class="k">select</code> <code class="k">new</code> <code class="nf">DynamicLog</code><code class="p">(</code><code class="n">headers</code><code class="p">,</code> <code class="n">line</code><code class="p">))</code>
        <code class="p">.</code><code class="n">ToList</code><code class="p">&lt;</code><code class="kt">dynamic</code><code class="p">&gt;();</code>
<code class="p">}</code>

<code class="k">static</code> <code class="kt">string</code> <code class="nf">GetLogData</code><code class="p">()</code>
<code class="p">{</code>
    <code class="k">return</code>
<code class="s">"2022-11-12 12:34:56.7890|INFO|Section_05_07.Program|Got this far\n"</code> <code class="p">+</code>
<code class="s">"2022-11-12 12:35:12.3456|ERROR|Section_05_07.Report|Index out of range\n"</code> <code class="p">+</code>
<code class="s">"2022-11-12 12:55:34.5678|WARNING|Section_05_07.Report|Please check this"</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>This class is a <code>DynamicObject</code> that knows how to read log files and dynamically expose properties:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">DynamicLog</code> <code class="p">:</code> <code class="n">DynamicObject</code>
<code class="p">{</code>
    <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="kt">string</code><code class="p">&gt;</code> <code class="n">members</code> <code class="p">=</code>
        <code class="k">new</code> <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="kt">string</code><code class="p">&gt;();</code>

    <code class="k">public</code> <code class="nf">DynamicLog</code><code class="p">(</code><code class="kt">string</code> <code class="n">headerString</code><code class="p">,</code> <code class="kt">string</code> <code class="n">logString</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="kt">string</code><code class="p">[]</code> <code class="n">headers</code> <code class="p">=</code> <code class="n">headerString</code><code class="p">.</code><code class="n">Split</code><code class="p">(</code><code class="sc">'|'</code><code class="p">);</code>
        <code class="kt">string</code><code class="p">[]</code> <code class="n">logData</code> <code class="p">=</code> <code class="n">logString</code><code class="p">.</code><code class="n">Split</code><code class="p">(</code><code class="sc">'|'</code><code class="p">);</code>

        <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code> <code class="n">i</code> <code class="p">&lt;</code> <code class="n">headers</code><code class="p">.</code><code class="n">Length</code><code class="p">;</code> <code class="n">i</code><code class="p">++)</code>
            <code class="n">members</code><code class="p">[</code><code class="n">headers</code><code class="p">[</code><code class="n">i</code><code class="p">]]</code> <code class="p">=</code> <code class="n">logData</code><code class="p">[</code><code class="n">i</code><code class="p">];</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">override</code> <code class="kt">bool</code> <code class="nf">TryGetMember</code><code class="p">(</code>
        <code class="n">GetMemberBinder</code> <code class="n">binder</code><code class="p">,</code> <code class="k">out</code> <code class="kt">object</code> <code class="n">result</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">result</code> <code class="p">=</code> <code class="n">members</code><code class="p">[</code><code class="n">binder</code><code class="p">.</code><code class="n">Name</code><code class="p">];</code>
        <code class="k">return</code> <code class="k">true</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">override</code> <code class="kt">bool</code> <code class="nf">TryInvokeMember</code><code class="p">(</code>
        <code class="n">InvokeMemberBinder</code> <code class="n">binder</code><code class="p">,</code> <code class="kt">object</code><code class="p">[]</code> <code class="n">args</code><code class="p">,</code> <code class="k">out</code> <code class="kt">object</code> <code class="n">result</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="k">base</code><code class="p">.</code><code class="n">TryInvokeMember</code><code class="p">(</code><code class="n">binder</code><code class="p">,</code> <code class="n">args</code><code class="p">,</code> <code class="k">out</code> <code class="n">result</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">override</code> <code class="kt">bool</code> <code class="nf">TrySetMember</code><code class="p">(</code>
        <code class="n">SetMemberBinder</code> <code class="n">binder</code><code class="p">,</code> <code class="kt">object</code> <code class="k">value</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">members</code><code class="p">[</code><code class="n">binder</code><code class="p">.</code><code class="n">Name</code><code class="p">]</code> <code class="p">=</code> <code class="p">(</code><code class="kt">string</code><code class="p">)</code><code class="k">value</code><code class="p">;</code>
        <code class="k">return</code> <code class="k">true</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>The <code>Main</code> method consumes the dynamic data, populates data objects, and gets a new report:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">()</code>
<code class="p">{</code>
    <code class="n">List</code><code class="p">&lt;</code><code class="kt">dynamic</code><code class="p">&gt;</code> <code class="n">logData</code> <code class="p">=</code> <code class="n">GetData</code><code class="p">();</code>

    <code class="kt">var</code> <code class="n">tempDateTime</code> <code class="p">=</code> <code class="n">DateTime</code><code class="p">.</code><code class="n">MinValue</code><code class="p">;</code>
    <code class="n">List</code><code class="p">&lt;</code><code class="kt">object</code><code class="p">&gt;</code> <code class="n">inventory</code> <code class="p">=</code>
        <code class="p">(</code><code class="k">from</code> <code class="n">log</code> <code class="k">in</code> <code class="n">logData</code>
         <code class="k">let</code> <code class="n">canParse</code> <code class="p">=</code>
            <code class="n">DateTime</code><code class="p">.</code><code class="n">TryParse</code><code class="p">(</code>
                <code class="n">log</code><code class="p">.</code><code class="n">Date</code><code class="p">,</code> <code class="k">out</code> <code class="n">tempDateTime</code><code class="p">)</code>
         <code class="k">select</code> <code class="k">new</code> <code class="n">LogEntry</code>
         <code class="p">{</code>
             <code class="n">CreatedAt</code> <code class="p">=</code> <code class="n">tempDateTime</code><code class="p">,</code>
             <code class="n">Type</code> <code class="p">=</code> <code class="n">log</code><code class="p">.</code><code class="n">Severity</code><code class="p">,</code>
             <code class="n">Where</code> <code class="p">=</code> <code class="n">log</code><code class="p">.</code><code class="n">Location</code><code class="p">,</code>
             <code class="n">Description</code> <code class="p">=</code> <code class="n">log</code><code class="p">.</code><code class="n">Message</code>
         <code class="p">})</code>
        <code class="p">.</code><code class="n">ToList</code><code class="p">&lt;</code><code class="kt">object</code><code class="p">&gt;();</code>

    <code class="kt">string</code> <code class="n">report</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Report</code><code class="p">().</code><code class="n">Generate</code><code class="p">(</code><code class="n">inventory</code><code class="p">);</code>

    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">report</code><code class="p">);</code>
<code class="p">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678777756864">
<h2>Discussion</h2>

<p>The <code>DynamicObject</code> type is part of the .NET Framework and supports the DLR for interoperability with dynamic languages. It’s a peculiar type that lets anyone call type members, and it can intercept the call and behave in any way you’ve programmed it to. Rather than wave hands and enumerate several ways to use <code>DynamicObject</code>, this solution focuses on the problem where you need an object to work on proprietary data. In this solution, the data is a log file format. Here, we’ll use the <code>DynamicObject</code> to provide the data and the report library from <a data-type="xref" href="#accessing_type_members_with_reflection">Recipe 5.2</a> to display the log data.</p>

<p>The <code>LogEntry</code> class represents a row in the report. We can’t give a <code>DynamicObject</code> instance to <code>Report</code> because there isn’t a way to reflect on it and extract attributes. Any workaround is cumbersome, and it’s easier to use the <code>DynamicObject</code> for working with the data, generate a collection of <code>LogEntry</code> objects, and pass them to the <code>Report</code>.</p>

<p>The <code>GetLogData</code> method shows what the log file looks like. <code>GetData</code> defines a <code>headers</code> string, which is metadata for each entry of the log file. The LINQ query iterates through each line of the log, resulting in a <code>List&lt;dynamic&gt;</code>. The projection instantiates a new <code>DynamicLog</code> instance with the header and log entry.</p>

<p>The <code>DynamicLog</code> type derives from <code>DynamicObject</code>, implementing only the methods it needs. The <code>DynamicLog</code> implementation shows a few of these members: <code>TryGetMember</code>, <code>TryInvokeMember</code>, and <code>TrySetMember</code>. The solution doesn’t use <code>TryInvokeMember</code>, but I left it in there to show that <code>DynamicObject</code> does more than work with properties and that there are other overloads. The <code>Dictionary&lt;string, string&gt;</code> <code>members</code>, hold a value for each field in the log with the key coming from the header and the value coming from the identically positioned string in the log file.</p>

<p>The constructor populates members. It splits each field on the pipe, <code>(|)</code>, separator and iterates through the headers until members has an entry for each column. The <code>TryGetMembers</code> method reads from the dictionary to return the value via the <code>out object result</code> parameter. Remember to return <code>true</code> when successful because returning <code>false</code> indicates that you couldn’t perform the operation, and the user will receive a runtime exception. <code>TrySetMember</code> populates the dictionary with the value.</p>

<p><code>GetMemberBinder</code> and <code>SetMemberBinder</code> contain metadata on the property that is being accessed. For example, the following would call <code>TryGetMember</code>:</p>
<pre>string severity = log.Severity;</pre>

<p>Assuming that log is an instance of <code>DynamicLog</code>, the <code>GetMemberBinder</code> <code>Name</code> property would be <code>Severity</code>. It would index into the dictionary and return whatever value is assigned to that key. Similarly, the following would call <code>TrySetMember</code>:</p>
<pre>log.Severity = "ERROR";</pre>

<p>In this case, <code>binder.Name</code> would be <code>Severity</code>, and it would update that key in the dictionary with the value <code>ERROR</code>.</p>

<p>That means now we have an object where you can set property names of your choosing and provide any log file of the same format (pipe-separated). No need for a custom class every time you want to accommodate a pipe-separated format log file.</p>

<p><code>GetData</code> returns a <code>List&lt;dynamic&gt;</code>. Because it’s a dynamic object and we already know what the property names should be (they match the header), we can project into <code>LogEntry</code> instances by only specifying the property name on the dynamic object. Additionally, you could specify what those headers should be in a configuration file or database where they can be data-driven and change every time. Maybe you even want the ability to change the delimiter on the file to accommodate handling even more file types. As you can see, that’s easy to do with <code>DynamicObject</code><a data-type="indexterm" data-startref="ix_ch05-asciidoc24" id="idm45678777591376"/>.<a data-type="indexterm" data-startref="ix_ch05-asciidoc23" id="idm45678777590544"/><a data-type="indexterm" data-startref="ix_ch05-asciidoc22" id="idm45678777589840"/><a data-type="indexterm" data-startref="ix_ch05-asciidoc21" id="idm45678777589168"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45678777756272">
<h2>See Also</h2>

<p><a data-type="xref" data-xrefstyle="rec-num-title" href="#accessing_type_members_with_reflection">Recipe 5.2, “Accessing Type Members with Reflection”</a></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.8 Adding and Removing Type Members Dynamically"><div class="sect1" id="idm45678777586096">
<h1>5.8 Adding and Removing Type Members Dynamically</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678777584912">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="dynamic" data-secondary="adding/removing type members dynamically" id="ix_ch05-asciidoc25"/><a data-type="indexterm" data-primary="type members" data-secondary="adding/removing dynamically" id="ix_ch05-asciidoc26"/>You want a fully dynamic object that you can add members to during runtime, as in JavaScript.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678777580688">
<h2>Solution</h2>

<p><a data-type="indexterm" data-primary="ExpandObject" id="ix_ch05-asciidoc27"/>This method uses an <code>ExpandoObject</code> to collect data:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="n">List</code><code class="p">&lt;</code><code class="kt">dynamic</code><code class="p">&gt;</code> <code class="n">GetData</code><code class="p">()</code>
<code class="p">{</code>
    <code class="k">const</code> <code class="kt">int</code> <code class="n">Date</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code>
    <code class="k">const</code> <code class="kt">int</code> <code class="n">Severity</code> <code class="p">=</code> <code class="m">1</code><code class="p">;</code>
    <code class="k">const</code> <code class="kt">int</code> <code class="n">Location</code> <code class="p">=</code> <code class="m">2</code><code class="p">;</code>
    <code class="k">const</code> <code class="kt">int</code> <code class="n">Message</code> <code class="p">=</code> <code class="m">3</code><code class="p">;</code>

    <code class="kt">var</code> <code class="n">logEntries</code> <code class="p">=</code> <code class="k">new</code> <code class="n">List</code><code class="p">&lt;</code><code class="kt">dynamic</code><code class="p">&gt;();</code>

    <code class="kt">string</code> <code class="n">logData</code> <code class="p">=</code> <code class="n">GetLogData</code><code class="p">();</code>

    <code class="k">foreach</code> <code class="p">(</code><code class="kt">var</code> <code class="n">line</code> <code class="k">in</code> <code class="n">logData</code><code class="p">.</code><code class="n">Split</code><code class="p">(</code><code class="sc">'\n'</code><code class="p">))</code>
    <code class="p">{</code>
        <code class="kt">string</code><code class="p">[]</code> <code class="n">columns</code> <code class="p">=</code> <code class="n">line</code><code class="p">.</code><code class="n">Split</code><code class="p">(</code><code class="sc">'|'</code><code class="p">);</code>

        <code class="kt">dynamic</code> <code class="n">logEntry</code> <code class="p">=</code> <code class="k">new</code> <code class="n">ExpandoObject</code><code class="p">();</code>

        <code class="n">logEntry</code><code class="p">.</code><code class="n">Date</code> <code class="p">=</code> <code class="n">columns</code><code class="p">[</code><code class="n">Date</code><code class="p">];</code>
        <code class="n">logEntry</code><code class="p">.</code><code class="n">Severity</code> <code class="p">=</code> <code class="n">columns</code><code class="p">[</code><code class="n">Severity</code><code class="p">];</code>
        <code class="n">logEntry</code><code class="p">.</code><code class="n">Location</code> <code class="p">=</code> <code class="n">columns</code><code class="p">[</code><code class="n">Location</code><code class="p">];</code>
        <code class="n">logEntry</code><code class="p">.</code><code class="n">Message</code> <code class="p">=</code> <code class="n">columns</code><code class="p">[</code><code class="n">Message</code><code class="p">];</code>

        <code class="n">logEntries</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code><code class="n">logEntry</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">return</code> <code class="n">logEntries</code><code class="p">;</code>
<code class="p">}</code>

<code class="k">static</code> <code class="kt">string</code> <code class="nf">GetLogData</code><code class="p">()</code>
<code class="p">{</code>
    <code class="k">return</code>
        <code class="s">"2022-11-12 12:34:56.7890|INFO"</code> <code class="p">+</code>
        <code class="s">"|Section_05_07.Program|Got this far\n"</code> <code class="p">+</code>
        <code class="s">"2022-11-12 12:35:12.3456|ERROR"</code> <code class="p">+</code>
        <code class="s">"|Section_05_07.Report|Index out of range\n"</code> <code class="p">+</code>
        <code class="s">"2022-11-12 12:55:34.5678|WARNING"</code> <code class="p">+</code>
        <code class="s">"|Section_05_07.Report|Please check this"</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>The <code>Main</code> method converts a <code>List&lt;dynamic&gt;</code> to a <code>List&lt;LogEntry&gt;</code> and gets the report:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">()</code>
<code class="p">{</code>
    <code class="n">List</code><code class="p">&lt;</code><code class="kt">dynamic</code><code class="p">&gt;</code> <code class="n">logData</code> <code class="p">=</code> <code class="n">GetData</code><code class="p">();</code>

    <code class="kt">var</code> <code class="n">tempDateTime</code> <code class="p">=</code> <code class="n">DateTime</code><code class="p">.</code><code class="n">MinValue</code><code class="p">;</code>
    <code class="n">List</code><code class="p">&lt;</code><code class="kt">object</code><code class="p">&gt;</code> <code class="n">inventory</code> <code class="p">=</code>
        <code class="p">(</code><code class="k">from</code> <code class="n">log</code> <code class="k">in</code> <code class="n">logData</code>
         <code class="k">let</code> <code class="n">canParse</code> <code class="p">=</code>
            <code class="n">DateTime</code><code class="p">.</code><code class="n">TryParse</code><code class="p">(</code>
                <code class="n">log</code><code class="p">.</code><code class="n">Date</code><code class="p">,</code> <code class="k">out</code> <code class="n">tempDateTime</code><code class="p">)</code>
         <code class="k">select</code> <code class="k">new</code> <code class="n">LogEntry</code>
         <code class="p">{</code>
             <code class="n">CreatedAt</code> <code class="p">=</code> <code class="n">tempDateTime</code><code class="p">,</code>
             <code class="n">Type</code> <code class="p">=</code> <code class="n">log</code><code class="p">.</code><code class="n">Severity</code><code class="p">,</code>
             <code class="n">Where</code> <code class="p">=</code> <code class="n">log</code><code class="p">.</code><code class="n">Location</code><code class="p">,</code>
             <code class="n">Description</code> <code class="p">=</code> <code class="n">log</code><code class="p">.</code><code class="n">Message</code>
         <code class="p">})</code>
        <code class="p">.</code><code class="n">ToList</code><code class="p">&lt;</code><code class="kt">object</code><code class="p">&gt;();</code>

    <code class="kt">string</code> <code class="n">report</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Report</code><code class="p">().</code><code class="n">Generate</code><code class="p">(</code><code class="n">inventory</code><code class="p">);</code>

    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">report</code><code class="p">);</code>
<code class="p">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678777373968">
<h2>Discussion</h2>

<p>This is similar to the <code>DynamicObject</code> example in <a data-type="xref" href="#creating_an_inherently_dynamic_type">Recipe 5.7</a>, except it covers a simpler case where you don’t need as much flexibility. What if you knew what the file format was ahead of time and that it won’t change, yet you want a simple way to pull the data into a dynamic object without creating a new type every time you need to send data to the report?</p>

<p>In this case, you can use <code>ExpandoObject</code>, a .NET Framework type that lets you add and remove type members on the fly, the same as in JavaScript.</p>

<p>In the solution, the <code>GetData</code> method instantiates an <code>ExpandoObject</code>, assigning it to the <code>dynamic</code> <code>logEntry</code>. Then, it adds properties on the fly and populates them with the parsed log file data.</p>

<p>The <code>Main</code> method accepts a <code>List&lt;dynamic&gt;</code> from <code>GetData</code>. As long as each object has the properties it expects, everything works well<a data-type="indexterm" data-startref="ix_ch05-asciidoc27" id="idm45678777225936"/>.<a data-type="indexterm" data-startref="ix_ch05-asciidoc26" id="idm45678777225104"/><a data-type="indexterm" data-startref="ix_ch05-asciidoc25" id="idm45678777224400"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45678777223728">
<h2>See Also</h2>

<p><a data-type="xref" data-xrefstyle="rec-num-title" href="#creating_an_inherently_dynamic_type">Recipe 5.7, “Creating an Inherently Dynamic Type”</a></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.9 Calling Python Code from C#"><div class="sect1" id="calling_python_code_from_C_sharp">
<h1>5.9 Calling Python Code from C#</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678777220256">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="dynamic" data-secondary="calling Python code from C#" id="ix_ch05-asciidoc28"/><a data-type="indexterm" data-primary="Python" data-secondary="calling Python code from C#" id="ix_ch05-asciidoc29"/><a data-type="indexterm" data-primary="social media data" id="ix_ch05-asciidoc30"/>You have a C# program and want to use some Python code but don’t want to rewrite it.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678777215232">
<h2>Solution</h2>

<p>This Python file has code that we need to use:</p>

<pre data-type="programlisting" data-code-language="python"><code class="kn">import</code> <code class="nn">sys</code>
<code class="n">sys</code><code class="o">.</code><code class="n">path</code><code class="o">.</code><code class="n">append</code><code class="p">(</code>
    <code class="s2">"/System/Library/Frameworks/Python.framework"</code> <code class="o">+</code>
    <code class="s2">"/Versions/Current/lib/python2.7"</code><code class="p">)</code>

<code class="kn">from</code> <code class="nn">random</code> <code class="kn">import</code> <code class="o">*</code>

<code class="k">class</code> <code class="nc">SemanticAnalysis</code><code class="p">:</code>
    <code class="nd">@staticmethod</code>
    <code class="k">def</code> <code class="nf">Eval</code><code class="p">(</code><code class="n">text</code><code class="p">):</code>
        <code class="n">val</code> <code class="o">=</code> <code class="n">random</code><code class="p">()</code>
        <code class="k">return</code> <code class="n">val</code> <code class="o">&lt;</code> <code class="o">.</code><code class="mi">5</code></pre>

<p>This class represents social media data:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">Tweet</code>
<code class="p">{</code>
<code class="na">    [Column("Screen Name")]</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">ScreenName</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [Column("Date")]</code>
    <code class="k">public</code> <code class="n">DateTime</code> <code class="n">CreatedAt</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [Column("Text")]</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Text</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [Column("Semantic Analysis")]</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Semantics</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code></pre>

<p>The <code>Main</code> method gets data and generates a report:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">()</code>
<code class="p">{</code>
    <code class="n">List</code><code class="p">&lt;</code><code class="kt">object</code><code class="p">&gt;</code> <code class="n">tweets</code> <code class="p">=</code> <code class="n">GetTweets</code><code class="p">();</code>

    <code class="kt">string</code> <code class="n">report</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Report</code><code class="p">().</code><code class="n">Generate</code><code class="p">(</code><code class="n">tweets</code><code class="p">);</code>

    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">report</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>These are the required namespaces that are part of the <code>IronPython</code> NuGet package:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">using</code> <code class="nn">IronPython.Hosting</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">Microsoft.Scripting.Hosting</code><code class="p">;</code></pre>

<p>This method sets up the Python interop:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="n">List</code><code class="p">&lt;</code><code class="kt">object</code><code class="p">&gt;</code> <code class="n">GetTweets</code><code class="p">()</code>
<code class="p">{</code>
    <code class="n">ScriptRuntime</code> <code class="n">py</code> <code class="p">=</code> <code class="n">Python</code><code class="p">.</code><code class="n">CreateRuntime</code><code class="p">();</code>
    <code class="kt">dynamic</code> <code class="n">semantic</code> <code class="p">=</code> <code class="n">py</code><code class="p">.</code><code class="n">UseFile</code><code class="p">(</code><code class="s">"../../../Semantic.py"</code><code class="p">);</code>
    <code class="kt">dynamic</code> <code class="n">semanticAnalysis</code> <code class="p">=</code> <code class="n">semantic</code><code class="p">.</code><code class="n">SemanticAnalysis</code><code class="p">();</code>

    <code class="n">DateTime</code> <code class="n">date</code> <code class="p">=</code> <code class="n">DateTime</code><code class="p">.</code><code class="n">UtcNow</code><code class="p">;</code>

    <code class="kt">var</code> <code class="n">tweets</code> <code class="p">=</code> <code class="k">new</code> <code class="n">List</code><code class="p">&lt;</code><code class="kt">object</code><code class="p">&gt;</code>
    <code class="p">{</code>
        <code class="k">new</code> <code class="n">Tweet</code>
        <code class="p">{</code>
            <code class="n">ScreenName</code> <code class="p">=</code> <code class="s">"SomePerson"</code><code class="p">,</code>
            <code class="n">CreatedAt</code> <code class="p">=</code> <code class="n">date</code><code class="p">.</code><code class="n">AddMinutes</code><code class="p">(</code><code class="m">5</code><code class="p">),</code>
            <code class="n">Text</code> <code class="p">=</code> <code class="s">"Comment #1"</code><code class="p">,</code>
            <code class="n">Semantics</code> <code class="p">=</code> <code class="n">GetSemanticText</code><code class="p">(</code><code class="n">semanticAnalysis</code><code class="p">,</code> <code class="s">"Comment #1"</code><code class="p">)</code>
        <code class="p">},</code>
        <code class="k">new</code> <code class="n">Tweet</code>
        <code class="p">{</code>
            <code class="n">ScreenName</code> <code class="p">=</code> <code class="s">"SomePerson"</code><code class="p">,</code>
            <code class="n">CreatedAt</code> <code class="p">=</code> <code class="n">date</code><code class="p">.</code><code class="n">AddMinutes</code><code class="p">(</code><code class="m">7</code><code class="p">),</code>
            <code class="n">Text</code> <code class="p">=</code> <code class="s">"Comment #2"</code><code class="p">,</code>
            <code class="n">Semantics</code> <code class="p">=</code> <code class="n">GetSemanticText</code><code class="p">(</code><code class="n">semanticAnalysis</code><code class="p">,</code> <code class="s">"Comment #2"</code><code class="p">)</code>
        <code class="p">},</code>
        <code class="k">new</code> <code class="n">Tweet</code>
        <code class="p">{</code>
            <code class="n">ScreenName</code> <code class="p">=</code> <code class="s">"SomePerson"</code><code class="p">,</code>
            <code class="n">CreatedAt</code> <code class="p">=</code> <code class="n">date</code><code class="p">.</code><code class="n">AddMinutes</code><code class="p">(</code><code class="m">12</code><code class="p">),</code>
            <code class="n">Text</code> <code class="p">=</code> <code class="s">"Comment #3"</code><code class="p">,</code>
            <code class="n">Semantics</code> <code class="p">=</code> <code class="n">GetSemanticText</code><code class="p">(</code><code class="n">semanticAnalysis</code><code class="p">,</code> <code class="s">"Comment #3"</code><code class="p">)</code>
        <code class="p">},</code>
    <code class="p">};</code>

    <code class="k">return</code> <code class="n">tweets</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>This method calls the Python code via <code>dynamic</code> instance:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="kt">string</code> <code class="nf">GetSemanticText</code><code class="p">(</code><code class="kt">dynamic</code> <code class="n">semantic</code><code class="p">,</code> <code class="kt">string</code> <code class="n">text</code><code class="p">)</code>
<code class="p">{</code>
    <code class="kt">bool</code> <code class="n">result</code> <code class="p">=</code> <code class="n">semantic</code><code class="p">.</code><code class="n">Eval</code><code class="p">(</code><code class="n">text</code><code class="p">);</code>
    <code class="k">return</code> <code class="n">result</code> <code class="p">?</code> <code class="s">"Positive"</code> <code class="p">:</code> <code class="s">"Negative"</code><code class="p">;</code>
<code class="p">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678777214640">
<h2>Discussion</h2>

<p>The scenario in this example is one where you’re working with social media data. One of the report items is semantics, telling whether a user’s tweet was positive or negative. You’ve got this great semantic analysis AI model, but it’s built with TensorFlow in a Python module. It would be helpful to be able to reuse that code instead of rewriting it.</p>

<p><a data-type="indexterm" data-primary="dynamic language runtime (DLR)" id="idm45678776684320"/>This is where the DLR comes in, because it lets you call Python (and other dynamic languages) from C#. Considering that it could have taken many months to build a machine learning model (or any other type of module), the advantage of reusing that code across languages can be huge.</p>

<p>The <code>SemanticAnalysis</code> class in the Python file simulates a model, returning <code>true</code> for a positive result or <code>false</code> for a negative result.</p>

<p>The <code>Main</code> method calls <code>GetTweets</code> to get data and uses the <code>Report</code> class, which is the same as in <a data-type="xref" href="#accessing_type_members_with_reflection">Recipe 5.2</a>. The <code>List&lt;object&gt;</code> returned from <code>GetTweets</code> contains <code>Tweet</code> objects that can work with the report generator.</p>
<div data-type="tip"><h6>Tip</h6>
<p>To set this up, you’ll need to reference the <code>IronPython</code> package, which you can find on NuGet. You also might find it useful to install Python Tools for Visual Studio via the Visual Studio <span class="keep-together">Installer</span>.</p>
</div>

<p>The <code>GetTweets</code> method needs a reference to the Python <code>SemanticAnalysis</code> class. Calling <code>CreateRuntime</code> creates a DLR reference. Then you need to specify the location of the Python file via <code>UseFile</code>. After that, you can instantiate the <code>SemanticAnalysis</code> class. Each <code>Tweet</code> instance sets the <code>Semantics</code> property with a call to <code>GetSemanticText</code>, passing the <code>SemanticAnalysis</code> reference and <code>text</code> to evaluate.</p>

<p>The <code>GetSemanticText</code> method calls <code>Eval</code> with <code>text</code> as its parameter and returns a <code>bool</code> result, which it then translates to a report-friendly “Positive” or “Negative” string.</p>

<p>In just a few lines of code, you saw how easy it is to reuse important code that was written in a dynamic language. Languages supported by the DLR include Ruby and JavaScript, among others.<a data-type="indexterm" data-startref="ix_ch05-asciidoc30" id="idm45678776634624"/><a data-type="indexterm" data-startref="ix_ch05-asciidoc29" id="idm45678776633920"/><a data-type="indexterm" data-startref="ix_ch05-asciidoc28" id="idm45678776633248"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45678776632448">
<h2>See Also</h2>

<p><a data-type="xref" data-xrefstyle="rec-num-title" href="#accessing_type_members_with_reflection">Recipe 5.2, “Accessing Type Members with Reflection”</a></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.10 Calling C# Code from Python"><div class="sect1" id="idm45678776629936">
<h1>5.10 Calling C# Code from Python</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678776628768">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="dynamic" data-secondary="calling C# code from Python" id="ix_ch05-asciidoc31"/><a data-type="indexterm" data-primary="Python" data-secondary="calling C# code from" id="ix_ch05-asciidoc32"/>You have a Python program and want to use C# code but don’t want to rewrite it.</p>
</div></section>













<section data-type="sect2" class="pagebreak-before less_space" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678776624656">
<h2>Solution</h2>

<p>Here’s the main Python application that needs to use the report generator:</p>

<pre data-type="programlisting" data-code-language="python"><code class="kn">import</code> <code class="nn">clr</code><code class="o">,</code> <code class="nn">sys</code>

<code class="n">sys</code><code class="o">.</code><code class="n">path</code><code class="o">.</code><code class="n">append</code><code class="p">(</code>
    <code class="s-Affix">r</code><code class="s2">"C:\Path Where You Cloned The Project"</code> <code class="o">+</code>
    <code class="s2">"\Chapter05\Section-05-10</code><code class="se">\b</code><code class="s2">in\Debug"</code><code class="p">)</code>
<code class="n">clr</code><code class="o">.</code><code class="n">AddReference</code><code class="p">(</code>
    <code class="s-Affix">r</code><code class="s2">"C:\Path Where You Cloned The Project"</code> <code class="o">+</code>
    \<code class="n">Chapter05</code>\<code class="n">Section</code><code class="o">-</code><code class="mo">05</code><code class="o">-</code><code class="mi">10</code>\<code class="nb">bin</code>\<code class="n">Debug</code>\<code class="n">PythonToCS</code><code class="o">.</code><code class="n">dll</code><code class="s2">")</code>

<code class="kn">from</code> <code class="nn">PythonToCS</code> <code class="kn">import</code> <code class="n">Report</code>
<code class="kn">from</code> <code class="nn">PythonToCS</code> <code class="kn">import</code> <code class="n">InventoryItem</code>
<code class="kn">from</code> <code class="nn">System</code> <code class="kn">import</code> <code class="n">Decimal</code>

<code class="n">inventory</code> <code class="o">=</code> <code class="p">[</code>
    <code class="n">InventoryItem</code><code class="p">(</code><code class="s2">"1"</code><code class="p">,</code> <code class="s2">"Part #1"</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="n">Decimal</code><code class="p">(</code><code class="mf">5.26</code><code class="p">)),</code>
    <code class="n">InventoryItem</code><code class="p">(</code><code class="s2">"2"</code><code class="p">,</code> <code class="s2">"Part #2"</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="n">Decimal</code><code class="p">(</code><code class="mf">7.95</code><code class="p">)),</code>
    <code class="n">InventoryItem</code><code class="p">(</code><code class="s2">"3"</code><code class="p">,</code> <code class="s2">"Part #1"</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="n">Decimal</code><code class="p">(</code><code class="mf">23.13</code><code class="p">))]</code>

<code class="n">rpt</code> <code class="o">=</code> <code class="n">Report</code><code class="p">()</code>

<code class="n">result</code> <code class="o">=</code> <code class="n">rpt</code><code class="o">.</code><code class="n">GenerateDynamic</code><code class="p">(</code><code class="n">inventory</code><code class="p">)</code>

<code class="k">print</code><code class="p">(</code><code class="n">result</code><code class="p">)</code></pre>

<p>This class has a constructor to make it easier to work with in Python:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">InventoryItem</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="nf">InventoryItem</code><code class="p">(</code>
        <code class="kt">string</code> <code class="n">partNumber</code><code class="p">,</code> <code class="kt">string</code> <code class="n">description</code><code class="p">,</code>
        <code class="kt">int</code> <code class="n">count</code><code class="p">,</code> <code class="kt">decimal</code> <code class="n">itemPrice</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">PartNumber</code> <code class="p">=</code> <code class="n">partNumber</code><code class="p">;</code>
        <code class="n">Description</code> <code class="p">=</code> <code class="n">description</code><code class="p">;</code>
        <code class="n">Count</code> <code class="p">=</code> <code class="n">count</code><code class="p">;</code>
        <code class="n">ItemPrice</code> <code class="p">=</code> <code class="n">itemPrice</code><code class="p">;</code>
    <code class="p">}</code>

<code class="na">    [Column("Part #")]</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">PartNumber</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [Column("Name")]</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Description</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [Column("Amount")]</code>
    <code class="k">public</code> <code class="kt">int</code> <code class="n">Count</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

<code class="na">    [Column("Price", Format = "{0:c}")]</code>
    <code class="k">public</code> <code class="kt">decimal</code> <code class="n">ItemPrice</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code></pre>

<p>Here’s the C# method that the Python code calls to generate the report:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="kt">string</code> <code class="nf">GenerateDynamic</code><code class="p">(</code><code class="kt">dynamic</code><code class="p">[]</code> <code class="n">items</code><code class="p">)</code>
<code class="p">{</code>
    <code class="n">List</code><code class="p">&lt;</code><code class="kt">object</code><code class="p">&gt;</code> <code class="n">inventory</code> <code class="p">=</code>
        <code class="p">(</code><code class="k">from</code> <code class="n">item</code> <code class="k">in</code> <code class="n">items</code>
         <code class="k">select</code> <code class="k">new</code> <code class="nf">InventoryItem</code>
         <code class="p">(</code>
             <code class="n">item</code><code class="p">.</code><code class="n">PartNumber</code><code class="p">,</code>
             <code class="n">item</code><code class="p">.</code><code class="n">Description</code><code class="p">,</code>
             <code class="n">item</code><code class="p">.</code><code class="n">Count</code><code class="p">,</code>
             <code class="n">item</code><code class="p">.</code><code class="n">ItemPrice</code>
         <code class="p">))</code>
        <code class="p">.</code><code class="n">ToList</code><code class="p">&lt;</code><code class="kt">object</code><code class="p">&gt;();</code>

    <code class="k">return</code> <code class="nf">Generate</code><code class="p">(</code><code class="n">inventory</code><code class="p">);</code>
<code class="p">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678776335952">
<h2>Discussion</h2>

<p>In <a data-type="xref" href="#calling_python_code_from_C_sharp">Recipe 5.9</a>, the scenario was to call Python from C#. The scenario in this problem is opposite in that I have a Python application and need to be able to generate reports. However, the report generator is written in C#. So much work has gone into the report library that it doesn’t make sense to rewrite in Python. Fortunately, the DLR allows us to call that C# code with Python.</p>

<p>The report is the same one used in <a data-type="xref" href="#accessing_type_members_with_reflection">Recipe 5.2</a> and the C# code has the same <code>Inventor⁠y​Item</code> class.</p>
<div data-type="tip"><h6>Tip</h6>
<p>To set this up, you might need to install the <a href="https://oreil.ly/hY9bZ"><code>pythonnet</code> package</a>:</p>
<pre>&gt;pip install pythonnet</pre>
</div>

<p>You set up the Python code by importing <code>clr</code> and <code>sys</code>, calling <code>sys.path.append</code> as a reference to the path where the C# DLL resides and then calling <code>clr.AddReference</code> to add a reference to the C# DLL you want to use.</p>

<p>In Python, whenever you need to use a .NET type from either the framework or a custom assembly, use the <code>from Namespace import type</code> syntax, which is roughly equivalent to a C# <code>using</code> declaration. The namespace in the C# source code is <code>PythonToCS</code> and the code uses that to import a reference to <code>Report</code> and <code>InventoryItem</code>. It also uses the <code>System</code> namespace to get a reference to the <code>Decimal</code> type, which aliases the C# <code>decimal</code> type.</p>

<p><a data-type="indexterm" data-primary="[] (square brackets)" id="idm45678776242640"/><a data-type="indexterm" data-primary="list (data structure)" id="idm45678776241712"/><a data-type="indexterm" data-primary="square brackets ([])" id="idm45678776241040"/>In Python, whenever you use square brackets, <code>[]</code>, you’re creating a data structure called a <code>list</code>. It’s a collection of objects with Python semantics. In this example, we’re creating a list of <code>InventoryItem</code>, assigning it to a variable named <code>inventory</code>.</p>

<p>Notice we’re using <code>Decimal</code> for the last parameter, <code>itemPrice</code>, of the <code>InventoryItem</code> constructor. Python doesn’t have a concept of <code>decimal</code> and will pass that value as a <code>float</code>, which causes an error because the C# <code>InventoryItem</code> defines that parameter as a <code>decimal</code>.</p>

<p>Next, the Python code instantiates <code>Report</code>, <code>rpt</code>, and calls <code>GenerateDynamic</code>, passing <code>inventory</code>. This calls the <code>GenerateDynamic</code> in <code>Report</code> and automatically translates inventory from a Python <code>list</code> into a C# <code>dynamic[]</code>, <code>items</code>. Because each object in <code>items</code> is <code>dynamic</code>, we can query it using a LINQ statement, accessing the names of each object dynamically in the projection.</p>

<p>Finally, <code>GenerateDynamically</code> calls <code>Generate</code>, the application returns a report, and the Python code prints the report<a data-type="indexterm" data-startref="ix_ch05-asciidoc32" id="idm45678776227888"/><a data-type="indexterm" data-startref="ix_ch05-asciidoc31" id="idm45678776227184"/>.<a data-type="indexterm" data-startref="ix_ch05-asciidoc13" id="idm45678776226384"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45678776255792">
<h2>See Also</h2>

<p><a data-type="xref" data-xrefstyle="rec-num-title" href="#accessing_type_members_with_reflection">Recipe 5.2, “Accessing Type Members with Reflection”</a></p>

<p><a data-type="xref" data-xrefstyle="rec-num-title" href="#calling_python_code_from_C_sharp">Recipe 5.9, “Calling Python Code from C#”</a></p>
</div></section>





</div></section>







</div></section></div></body></html>