<html><head></head><body><section data-pdf-bookmark="Chapter 8. Accepting Form Input with Validation" data-type="chapter" epub:type="chapter"><div class="chapter" id="chapter-eight">
<h1><span class="label">Chapter 8. </span>Accepting Form Input with Validation</h1>


<p>In this chapter, you’ll learn how to use the framework-provided components for accepting form input to bind custom C# models to the <code>EditForm</code> component. We’ll cover native speech recognition when used in forms. You’ll also learn how to use Reactive Extensions with Rx.NET. The model app’s contact page form will demonstrate all of this.</p>

<p>Let’s start with how form submission is used to accept and validate user input. You’ll see how valid user input can be sent to HTTP endpoints for processing.</p>






<section data-pdf-bookmark="The Basics of Form Submission" data-type="sect1"><div class="sect1" id="idm46365007058096">
<h1>The Basics of Form Submission</h1>

<p>The core functionality of an HTML <code>form</code> element is <a data-primary="forms" data-secondary="submitting" data-type="indexterm" id="idm46365007056576"/>to accept and validate user input. When a user’s input is invalid, the user should be notified. When there is valid input, submit that input to an HTTP endpoint to process. The form submission <a data-primary="form element" data-type="indexterm" id="idm46365007055600"/>process is as follows:</p>
<ol>
<li>
<p>The <code>form</code> is presented to the user to fill out.</p>
</li>
<li>
<p>The user fills out the <code>form</code> and attempts to submit it.</p>
</li>
<li>
<p>The <code>form</code> is validated.</p>
<ol>
<li>
<p>If the <code>form</code> is invalid, validation messages or errors are shown to the user.</p>
</li>
<li>
<p>If the <code>form</code> is valid, the input is sent off for processing.</p>
</li>

</ol>
</li>

</ol>

<p>Between these steps, the user interacts with the <code>form</code> in various ways, sometimes by typing, sometimes by clicking, sometimes by selecting a radio button, etc. When the form is invalid, the state of the <code>form</code> can display validation messages or errors to the user. A form can accept many different types of user input. We can apply dynamic CSS to desirable input elements to indicate that the user has entered invalid input. We can control which element has focus, and we can <a data-primary="disabled elements" data-type="indexterm" id="idm46365007046832"/><a data-primary="readonly elements" data-type="indexterm" id="idm46365007046224"/>set elements as <code>disabled</code> or make them <code>readonly</code>. These styles include animations to emphasize errant conditions and draw the user’s attention to a specific area.</p>
</div></section>













<section data-pdf-bookmark="Framework-Provided Components for Forms" data-type="sect1"><div class="sect1" id="idm46365007044464">
<h1>Framework-Provided Components for Forms</h1>

<p>Blazor provides many <a data-primary="forms" data-secondary="components" data-type="indexterm" id="frpwk"/>components that apply a layer atop native HTML elements. One such component is <code>EditForm</code>. The <code>EditForm</code> component <a data-primary="EditForm" data-type="indexterm" id="idm46365007040688"/>is designed to be used as a wrapper around the native HTML <code>form</code> element. This is what’s used in the 
<span class="keep-together"><code>Contact</code></span> form of <a data-primary="forms" data-secondary="Contact" data-tertiary="EditForm" data-type="indexterm" id="idm46365007038816"/>the book’s model app. There are other 
<span class="keep-together">framework-provided</span> components as well. In the next section, you’ll see the various framework-
<span class="keep-together">provided components</span> that can be used with <code>EditForm</code>.</p>

<p><a data-type="xref" href="#built-in-components">Table 8-1</a> shows the various framework-provided components that can be used with the <code>EditForm</code> component.<sup><a data-type="noteref" href="ch08.html#idm46365007034848" id="idm46365007034848-marker">1</a></sup></p>
<table id="built-in-components">
<caption><span class="label">Table 8-1. </span>Framework-provided form components</caption>
<thead>
<tr>
<th>Blazor component</th>
<th>HTML element wrapped</th>
<th>Purpose of component</th>
</tr>
</thead>
<tbody>
<tr>
<td><p><code>EditForm</code></p></td>
<td><p><code>&lt;form&gt;</code></p></td>
<td><p>Provides a wrapper around the native HTML <code>form</code> element</p></td>
</tr>
<tr>
<td><p><code>InputCheckbox</code></p></td>
<td><p><code>&lt;input type="checkbox"&gt;</code></p></td>
<td><p>Accepts user input for either <code>true</code> or <code>false</code></p></td>
</tr>
<tr>
<td><p><code>Input⁠Date​&lt;TValue&gt;</code></p></td>
<td><p><code>&lt;input type="date"&gt;</code></p></td>
<td><p>Accepts a <code>DateTime</code> value as user input</p></td>
</tr>
<tr>
<td><p><code>InputFile</code></p></td>
<td><p><code>&lt;input type="file"&gt;</code></p></td>
<td><p>Accepts a file upload</p></td>
</tr>
<tr>
<td><p><code>InputNum⁠ber​&lt;TValue&gt;</code></p></td>
<td><p><span class="keep-together"><code>&lt;input type="number"&gt;</code></span></p></td>
<td><p>Accepts a numeric value as user input</p></td>
</tr>
<tr>
<td><p><code>InputRa⁠dio​&lt;TValue&gt;</code></p></td>
<td><p><code>&lt;input type="radio"&gt;</code></p></td>
<td><p>Accepts a mutually exclusive set of values representing a single choice</p></td>
</tr>
<tr>
<td><p><code>InputRa⁠dioGroup​&lt;TValue&gt;</code></p></td>
<td><p>Parent of one or more <code>Input​Ra⁠dio&lt;TValue&gt;</code> components</p></td>
<td><p>Semantically wraps the <code>InputRa⁠dio​&lt;TValue&gt;</code> components together such that they’re mutually exclusive</p></td>
</tr>
<tr>
<td><p><code>InputSe⁠lect​&lt;TValue&gt;</code></p></td>
<td><p><code>&lt;select&gt;</code></p></td>
<td><p>Accepts a <code>TValue</code> value as user input from a list of custom options</p></td>
</tr>
<tr>
<td><p><code>InputText</code></p></td>
<td><p><code>&lt;input type="text"&gt;</code></p></td>
<td><p>Accepts a string value as user input</p></td>
</tr>
<tr>
<td><p><code>InputTextArea</code></p></td>
<td><p><code>&lt;textarea&gt;</code></p></td>
<td><p>Accepts a string value as user input but traditionally displays and expects larger values than the <code>InputText</code> component</p></td>
</tr>
</tbody>
</table>

<p>Using these aforementioned components, you can build out a form that is as rich and as complex as your app needs.</p>

<p>In the next section, I’ll show you how to build a model that will represent the state of the form and the user interacting with it. This model will be decorated with metadata that will power the <a data-primary="forms" data-secondary="components" data-startref="frpwk" data-type="indexterm" id="idm46365007003600"/>validation of the form it binds to.</p>
</div></section>













<section data-pdf-bookmark="Models and Data Annotations" data-type="sect1"><div class="sect1" id="idm46365007002064">
<h1>Models and Data Annotations</h1>

<p>One of the common use cases for forms is to give <a data-primary="data annotations" data-type="indexterm" id="dtta"/>the end user a way to contact someone from within the app for various reasons. The <a href="https://oreil.ly/LZzCM"><code>Contact</code> form</a> of the Learning Blazor app does exactly that. The user can fill out the form and send me, the owner of the app, a message. After they hit send and confirm that they’re human, the message is sent to me as an email. We’ll go over how this works throughout the chapter.</p>

<p>Let’s start by going through the form’s user inputs:</p>
<ol>
<li>
<p>The user’s email address (current user of the app, <a data-primary="Contact form" data-secondary="user inputs" data-type="indexterm" id="idm46365006997072"/>which is prefilled if the user is logged in).</p>
</li>
<li>
<p>The user’s first and last name, as a pair.</p>
</li>
<li>
<p>The subject of the message, or the reason they’re contacting through the app.</p>
</li>
<li>
<p>The message input, which uses a <code>TextArea</code> component and some interesting JavaScript interop. The message input exposes a microphone button that toggles speech recognition.</p>
</li>

</ol>

<p>As a visual point of reference, consider <a data-type="xref" href="#contact-page">Figure 8-1</a>.</p>

<figure><div class="figure" id="contact-page">
<img alt="" src="assets/lblz_0801.png"/>
<h6><span class="label">Figure 8-1. </span>An example rendering of the <code>Contact</code> page</h6>
</div></figure>








<section data-pdf-bookmark="Defining Component Models" data-type="sect2"><div class="sect2" id="idm46365006988784">
<h2>Defining Component Models</h2>

<p>As part of the form submission process, <code>EditForm</code> will validate <a data-primary="models, component models" data-type="indexterm" id="mdcmf"/><a data-primary="component models, defining" data-type="indexterm" id="cpmdd"/>the user’s input. <code>EditForm</code> will also display validation messages and errors. This is all based on either <code>EditContext</code> or a model. A model is a C# class used to bind to properties and represent relevant values. In the case of the <code>Contact</code> page, it’s using <code>EditContext</code> to manage the state <a data-primary="EditContext" data-type="indexterm" id="idm46365006982608"/>of the form. And <code>EditContext</code> relies on a corresponding model. Let’s take a look at <code>ContactComponentModel</code> in the <em>ContactComponentModel.cs</em> C# file, which is <a data-primary="ContactComponentModel.cs" data-type="indexterm" id="ccpmd"/>responsible for representing the state of the form:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code><code> </code><code class="nn">Learning.Blazor.ComponentModels</code><code class="p">;</code><code>
</code><code>
</code><code class="k">public</code><code> </code><code class="n">record</code><code> </code><code class="nf">ContactComponentModel</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO1-1" id="co_accepting_form_input_with_validation_CO1-1"><img alt="1" src="assets/1.png"/></a><code>
</code><code class="p">{</code><code>
</code><code class="na">    [Required]</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO1-2" id="co_accepting_form_input_with_validation_CO1-2"><img alt="2" src="assets/2.png"/></a><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="kt">string?</code><code> </code><code class="n">FirstName</code><code> </code><code class="p">{</code><code> </code><code class="k">get</code><code class="p">;</code><code> </code><code class="k">set</code><code class="p">;</code><code> </code><code class="p">}</code><code> </code><code class="p">=</code><code> </code><code class="k">null</code><code class="p">!</code><code class="p">;</code><code>
</code><code class="na">
    [Required]</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="kt">string?</code><code> </code><code class="n">LastName</code><code> </code><code class="p">{</code><code> </code><code class="k">get</code><code class="p">;</code><code> </code><code class="k">set</code><code class="p">;</code><code> </code><code class="p">}</code><code> </code><code class="p">=</code><code> </code><code class="k">null</code><code class="p">!</code><code class="p">;</code><code>
</code><code class="na">
    [RegexEmailAddress(IsRequired = true)]</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO1-3" id="co_accepting_form_input_with_validation_CO1-3"><img alt="3" src="assets/3.png"/></a><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="kt">string?</code><code> </code><code class="n">EmailAddress</code><code> </code><code class="p">{</code><code> </code><code class="k">get</code><code class="p">;</code><code> </code><code class="k">set</code><code class="p">;</code><code> </code><code class="p">}</code><code> </code><code class="p">=</code><code> </code><code class="k">null</code><code class="p">!</code><code class="p">;</code><code>
</code><code class="na">
    [Required]</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="kt">string?</code><code> </code><code class="n">Subject</code><code> </code><code class="p">{</code><code> </code><code class="k">get</code><code class="p">;</code><code> </code><code class="k">set</code><code class="p">;</code><code> </code><code class="p">}</code><code> </code><code class="p">=</code><code> </code><code class="k">null</code><code class="p">!</code><code class="p">;</code><code>
</code><code class="na">
    [RequiredAcceptance]</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO1-4" id="co_accepting_form_input_with_validation_CO1-4"><img alt="4" src="assets/4.png"/></a><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="kt">bool</code><code> </code><code class="n">AgreesToTerms</code><code> </code><code class="p">{</code><code> </code><code class="k">get</code><code class="p">;</code><code> </code><code class="k">set</code><code class="p">;</code><code> </code><code class="p">}</code><code>
</code><code class="na">
    [Required]</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="kt">string?</code><code> </code><code class="n">Message</code><code> </code><code class="p">{</code><code> </code><code class="k">get</code><code class="p">;</code><code> </code><code class="k">set</code><code class="p">;</code><code> </code><code class="p">}</code><code> </code><code class="p">=</code><code> </code><code class="k">null</code><code class="p">!</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="n">AreYouHumanMath</code><code> </code><code class="n">NotRobot</code><code> </code><code class="p">{</code><code> </code><code class="k">get</code><code class="p">;</code><code> </code><code class="p">}</code><code> </code><code class="p">=</code><code>
</code><code>        </code><code class="n">AreYouHumanMath</code><code class="p">.</code><code class="n">CreateNew</code><code class="p">(</code><code class="n">MathOperator</code><code class="p">.</code><code class="n">Subtraction</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO1-5" id="co_accepting_form_input_with_validation_CO1-5"><img alt="5" src="assets/5.png"/></a><code>
</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="kt">string</code><code> </code><code class="n">RobotQuestion</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">NotRobot</code><code class="p">.</code><code class="n">GetQuestion</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="k">static</code><code> </code><code class="k">implicit</code><code> </code><code class="k">operator</code><code> </code><code class="nf">ContactRequest</code><code class="p">(</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO1-6" id="co_accepting_form_input_with_validation_CO1-6"><img alt="6" src="assets/6.png"/></a><code>
</code><code>        </code><code class="n">ContactComponentModel</code><code> </code><code class="n">model</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="k">new</code><code class="p">(</code><code class="n">model</code><code class="p">.</code><code class="n">FirstName</code><code class="p">!</code><code class="p">,</code><code>
</code><code>            </code><code class="n">model</code><code class="p">.</code><code class="n">LastName</code><code class="p">!</code><code class="p">,</code><code>
</code><code>            </code><code class="n">model</code><code class="p">.</code><code class="n">EmailAddress</code><code class="p">!</code><code class="p">,</code><code>
</code><code>            </code><code class="n">model</code><code class="p">.</code><code class="n">Subject</code><code class="p">!</code><code class="p">,</code><code>
</code><code>            </code><code class="n">model</code><code class="p">.</code><code class="n">Message</code><code class="p">!</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO1-1" id="callout_accepting_form_input_with_validation_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The model is a <code>record</code> type.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO1-2" id="callout_accepting_form_input_with_validation_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>FirstName</code> and <code>LastName</code> properties are required, per the <code>Required</code> attribute.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO1-3" id="callout_accepting_form_input_with_validation_CO1-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>EmailAddress</code> property is required, and it must be a valid email address.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO1-4" id="callout_accepting_form_input_with_validation_CO1-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The <code>AgreesToTerms</code> property is required as <code>true</code>.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO1-5" id="callout_accepting_form_input_with_validation_CO1-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>The <code>NotRobot</code> property is a <code>readonly</code> property that is calculated from the <code>AreYouHumanMath</code> class.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO1-6" id="callout_accepting_form_input_with_validation_CO1-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>The <code>record</code> defines an operator to convert to a <code>ContactRequest</code>.</p></dd>
</dl>

<p>This model exposes the values that the user is expected to provide. The user’s first and last name is required, as well as a valid email address. The <code>Required</code> attribute is a framework-provided data annotation attribute that is used to indicate that the user must provide a value for the property. If the user doesn’t provide a value, and they attempt to either submit the form or navigate away from the underlying HTML element, <code>EditForm</code> will display an error message. C# attributes are used to provide <a data-primary="models, component models" data-startref="mdcmf" data-type="indexterm" id="idm46365006684512"/><a data-primary="component models, defining" data-startref="cpmdd" data-type="indexterm" id="idm46365006683664"/><a data-primary="ContactComponentModel.cs" data-startref="ccpmd" data-type="indexterm" id="idm46365006682816"/>additional information about the thing they’re applied to.</p>
</div></section>













<section data-pdf-bookmark="Defining and Consuming Validation Attributes" data-type="sect2"><div class="sect2" id="idm46365006681584">
<h2>Defining and Consuming Validation Attributes</h2>

<p>The <code>RegexEmailAddress</code> attribute is a <a data-primary="RegexEmailAddress" data-type="indexterm" id="idm46365006679408"/>custom attribute that is used to indicate that the user must provide a valid email address. When decorating a model property, this attribute will validate it as an email address. The <code>RequiredAcceptance</code> attribute is a custom attribute that is used to indicate that the user must accept the terms and conditions. You can use all sorts of attributes to define objects. The <code>Message</code> property is required, as is the <code>Subject</code> property.</p>

<p>Let’s take a look at the <code>RegexEmailAddress</code> attribute implementation in the <em>Regex​E⁠mailAddressAttribute.cs</em> C# file:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">using</code><code> </code><code class="nn">System.Text.RegularExpressions</code><code class="p">;</code><code>
</code><code>
</code><code class="k">namespace</code><code> </code><code class="nn">Learning.Blazor.DataAnnotations</code><code class="p">;</code><code>
</code><code class="na">
[
    AttributeUsage( </code><a class="co" href="#callout_accepting_form_input_with_validation_CO2-1" id="co_accepting_form_input_with_validation_CO2-1"><img alt="1" src="assets/1.png"/></a><code class="na">
        AttributeTargets.Property |
        AttributeTargets.Field |
        AttributeTargets.Parameter,
        AllowMultiple = false)
]</code><code>
</code><code class="k">public</code><code> </code><code class="k">sealed</code><code> </code><code class="k">class</code><code> </code><code class="nc">RegexEmailAddressAttribute</code><code> </code><code class="p">:</code><code> </code><code class="n">DataTypeAttribute</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">internal</code><code> </code><code class="k">static</code><code> </code><code class="k">readonly</code><code> </code><code class="n">Regex</code><code> </code><code class="n">EmailExpression</code><code> </code><code class="p">=</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO2-2" id="co_accepting_form_input_with_validation_CO2-2"><img alt="2" src="assets/2.png"/></a><code>
</code><code>        </code><code class="k">new</code><code class="p">(</code><code class="s">"^([a-zA-Z0-9_\\-\\.]+)@"</code><code> </code><code class="p">+</code><code>
</code><code>        </code><code class="s">"((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.)"</code><code> </code><code class="p">+</code><code>
</code><code>        </code><code class="s">"|(([a-zA-Z0-9\\-]+\\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\\]?)$"</code><code class="p">,</code><code>
</code><code>            </code><code class="n">RegexOptions</code><code class="p">.</code><code class="n">CultureInvariant</code><code> </code><code class="p">|</code><code> </code><code class="n">RegexOptions</code><code class="p">.</code><code class="n">Singleline</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="c1">/// &lt;summary&gt;
</code><code>    </code><code class="c1">/// Gets or sets a value indicating if an email is required.
</code><code>    </code><code class="c1">/// &lt;/summary&gt;
</code><code>    </code><code class="c1">/// &lt;remarks&gt;Defaults to &lt;c&gt;true&lt;/c&gt;.&lt;/remarks&gt;
</code><code>    </code><code class="k">public</code><code> </code><code class="kt">bool</code><code> </code><code class="n">IsRequired</code><code> </code><code class="p">{</code><code> </code><code class="k">get</code><code class="p">;</code><code> </code><code class="k">set</code><code class="p">;</code><code> </code><code class="p">}</code><code> </code><code class="p">=</code><code> </code><code class="k">true</code><code class="p">;</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO2-3" id="co_accepting_form_input_with_validation_CO2-3"><img alt="3" src="assets/3.png"/></a><code>
</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="nf">RegexEmailAddressAttribute</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="p">:</code><code> </code><code class="k">base</code><code class="p">(</code><code class="n">DataType</code><code class="p">.</code><code class="n">EmailAddress</code><code class="p">)</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO2-4" id="co_accepting_form_input_with_validation_CO2-4"><img alt="4" src="assets/4.png"/></a><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="k">override</code><code> </code><code class="kt">bool</code><code> </code><code class="nf">IsValid</code><code class="p">(</code><code class="kt">object?</code><code> </code><code class="k">value</code><code class="p">)</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO2-5" id="co_accepting_form_input_with_validation_CO2-5"><img alt="5" src="assets/5.png"/></a><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="p">(</code><code class="k">value</code><code> </code><code class="k">is</code><code> </code><code class="k">null</code><code class="p">)</code><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="k">return</code><code> </code><code class="p">!</code><code class="n">IsRequired</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="k">value</code><code> </code><code class="k">is</code><code> </code><code class="kt">string</code><code> </code><code class="n">valueAsString</code><code>
</code><code>            </code><code class="p">&amp;</code><code class="p">&amp;</code><code> </code><code class="n">EmailExpression</code><code class="p">.</code><code class="n">IsMatch</code><code class="p">(</code><code class="n">valueAsString</code><code class="p">)</code><code class="p">;</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO2-1" id="callout_accepting_form_input_with_validation_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>AttributeUsage</code> decorator specifies the usage of another attribute class, in this case, <code>RegexEmailAddressAttribute</code>, which applies only to properties, fields, and parameters.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO2-2" id="callout_accepting_form_input_with_validation_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p><code>EmailExpression</code> is a <code>readonly Regex</code> instance that is used to validate the email address.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO2-3" id="callout_accepting_form_input_with_validation_CO2-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>IsRequired</code> property allows the developer to determine whether an email address is required at all.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO2-4" id="callout_accepting_form_input_with_validation_CO2-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The constructor calls its base constructor with the <code>DataType.EmailAddress</code> value.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO2-5" id="callout_accepting_form_input_with_validation_CO2-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>The <code>IsValid</code> method is used to validate the email address, which is passed as a nullable <code>object?</code>.</p></dd>
</dl>

<p>Blazor developers can author a custom <code>DataTypeAttribute</code>. If the user enters an email address that doesn’t match the regular expression, <code>EditForm</code> will display an error message. If the value is <code>null</code> and the <code>IsRequired</code> property is <code>true</code>, <code>EditForm</code> will display an error message. The other custom attribute is <code>RequireAcceptance​At⁠tribute</code>. This attribute is used to indicate that the user must accept the terms and conditions.</p>

<p>Next, let’s look at <code>RequiredAcceptanceAttribute</code>, which is defined in the <em>Require⁠d​AcceptanceAttribute.cs</em> C# file:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code><code> </code><code class="nn">Learning.Blazor.DataAnnotations</code><code class="p">;</code><code>
</code><code class="na">
[
    AttributeUsage( </code><a class="co" href="#callout_accepting_form_input_with_validation_CO3-1" id="co_accepting_form_input_with_validation_CO3-1"><img alt="1" src="assets/1.png"/></a><code class="na">
        AttributeTargets.Property |
        AttributeTargets.Field |
        AttributeTargets.Parameter,
        AllowMultiple = false)
]</code><code>
</code><code class="k">public</code><code> </code><code class="k">sealed</code><code> </code><code class="k">class</code><code> </code><code class="nc">RequiredAcceptanceAttribute</code><code> </code><code class="p">:</code><code> </code><code class="n">DataTypeAttribute</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="nf">RequiredAcceptanceAttribute</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="p">:</code><code> </code><code class="k">base</code><code class="p">(</code><code class="n">DataType</code><code class="p">.</code><code class="n">Custom</code><code class="p">)</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO3-2" id="co_accepting_form_input_with_validation_CO3-2"><img alt="2" src="assets/2.png"/></a><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="k">override</code><code> </code><code class="kt">bool</code><code> </code><code class="nf">IsValid</code><code class="p">(</code><code class="kt">object?</code><code> </code><code class="k">value</code><code class="p">)</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO3-3" id="co_accepting_form_input_with_validation_CO3-3"><img alt="3" src="assets/3.png"/></a><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="p">(</code><code class="k">value</code><code> </code><code class="k">is</code><code> </code><code class="k">null</code><code class="p">)</code><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="k">return</code><code> </code><code class="k">false</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="kt">bool</code><code class="p">.</code><code class="n">TryParse</code><code class="p">(</code><code class="k">value</code><code class="p">.</code><code class="n">ToString</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="k">out</code><code> </code><code class="kt">var</code><code> </code><code class="n">isAccepted</code><code class="p">)</code><code>
</code><code>            </code><code class="p">&amp;</code><code class="p">&amp;</code><code> </code><code class="n">isAccepted</code><code class="p">;</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO3-1" id="callout_accepting_form_input_with_validation_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p><code>RequiredAcceptanceAttribute</code> is similar to <code>RegexEmailAddressAttribute</code>.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO3-2" id="callout_accepting_form_input_with_validation_CO3-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The constructor calls the <code>DataTypeAttribute</code> base constructor with the <code>DataType.Custom</code> value.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO3-3" id="callout_accepting_form_input_with_validation_CO3-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>IsValid</code> method is used to validate the acceptance of the terms and 
<span class="keep-together">conditions.</span></p></dd>
</dl>

<p>If the user doesn’t accept the terms and conditions, <code>EditForm</code> will display an error message. When the object that represents <code>value</code> is <code>null</code>, or <code>value</code> is <code>false</code>, the error condition is triggered. You’re free to create any custom business logic rules that you may require. Whenever you need to accept user input, you’ll start with modeling an object that represents your needs. You’ll attribute the model’s properties with either custom or framework-provided data annotations. In the next section, we’ll put this into practice and see how a model is bound to <a data-primary="data annotations" data-startref="dtta" data-type="indexterm" id="idm46365006313568"/>the form components.</p>
</div></section>





</div></section>













<section data-pdf-bookmark="Implementing a Contact Form" data-type="sect1"><div class="sect1" id="idm46365006680992">
<h1>Implementing a Contact Form</h1>

<p>The markup for the <code>Contact</code> page is a bit <a data-primary="Contact form" data-secondary="implementing" data-type="indexterm" id="ctfp"/><a data-primary="forms" data-secondary="Contact" data-type="indexterm" id="frmct"/>lengthy, but it contains a fair number of user inputs with various functionality and validation requirements. To animate the controls and provide the appropriate styles when user input is in a state of error, the form needs a bit more markup than a semantic form. The page markup is contained <a data-primary="Contact.cshtml Razor file" data-type="indexterm" id="cthrz"/>in the <em>Contact.cshtml</em> Razor file:</p>

<pre data-code-language="html" data-type="programlisting"><code>@page "/contact" </code><a class="co" href="#callout_accepting_form_input_with_validation_CO4-1" id="co_accepting_form_input_with_validation_CO4-1"><img alt="1" src="assets/1.png"/></a><code>
@attribute [AllowAnonymous]
@inherits LocalizableComponentBase</code><code class="p">&lt;</code><code class="nt">Contact</code><code class="p">&gt;</code><code>

</code><code class="p">&lt;</code><code class="nt">PageTitle</code><code class="p">&gt;</code><code>@Localizer["Contact"]</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">PageTitle</code><code class="p">&gt;</code><code>

</code><code class="p">&lt;</code><code class="nt">section</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"section"</code><code class="p">&gt;</code><code>
    </code><code class="p">&lt;</code><code class="nt">h1</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"is-size-3 pb-3"</code><code class="p">&gt;</code><code>@Localizer["Contact"]</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">h1</code><code class="p">&gt;</code><code>

    </code><code class="p">&lt;</code><code class="nt">EditForm</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"pb-4"</code><code> </code><code class="na">Context</code><code class="o">=</code><code class="s">"cxt"</code><code> </code><code class="na">EditContext</code><code class="o">=</code><code class="s">"_editContext"</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO4-2" id="co_accepting_form_input_with_validation_CO4-2"><img alt="2" src="assets/2.png"/></a><code>
              </code><code class="na">OnValidSubmit</code><code class="o">=</code><code class="s">@(async</code><code> </code><code class="na">c </code><code class="o">=</code><code class="err">&gt;</code><code class="err"> </code><code class="s">await</code><code> </code><code class="na">OnValidSubmitAsync</code><code class="err">(</code><code class="na">c</code><code class="err">)</code><code class="err">)</code><code class="p">&gt;</code><code>
        </code><code class="p">&lt;</code><code class="nt">DataAnnotationsValidator</code><code> </code><code class="p">/</code><code class="p">&gt;</code><code>

        </code><code class="cm">&lt;!-- Email address --&gt;</code><code>
        </code><code class="p">&lt;</code><code class="nt">FieldInput</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO4-3" id="co_accepting_form_input_with_validation_CO4-3"><img alt="3" src="assets/3.png"/></a><code>
            </code><code class="p">&lt;</code><code class="nt">FieldLabelContent</code><code class="p">&gt;</code><code>
                @Localizer["Email"]
                </code><code class="p">&lt;</code><code class="nt">i</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"pl-4 far fa-lg
                    @cxt.GetValidityCss(() =&gt; _model.EmailAddress)"</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">i</code><code class="p">&gt;</code><code>
            </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">FieldLabelContent</code><code class="p">&gt;</code><code>
            </code><code class="p">&lt;</code><code class="nt">FieldControlContent</code><code class="p">&gt;</code><code>
                </code><code class="p">&lt;</code><code class="nt">InputText</code><code> </code><code class="err">@</code><code class="na">ref</code><code class="o">=</code><code class="s">"_emailInput"</code><code>
                    </code><code class="err">@</code><code class="na">bind-Value</code><code class="o">=</code><code class="s">"_model.EmailAddress"</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"input"</code><code>
                    </code><code class="na">readonly</code><code class="o">=</code><code class="s">@_isEmailReadonly</code><code> </code><code class="na">disabled</code><code class="o">=</code><code class="s">@_isEmailReadonly</code><code>
                    </code><code class="na">placeholder</code><code class="o">=</code><code class="s">"@Localizer["</code><code class="na">EmailPlaceholder</code><code class="err">"</code><code class="err">]</code><code class="err">"</code><code> </code><code class="p">/</code><code class="p">&gt;</code><code>
                </code><code class="p">&lt;</code><code class="nt">span</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"icon is-small is-left"</code><code class="p">&gt;</code><code>
                    </code><code class="p">&lt;</code><code class="nt">i</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"fas fa-envelope"</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">i</code><code class="p">&gt;</code><code>
                </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">span</code><code class="p">&gt;</code><code>
            </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">FieldControlContent</code><code class="p">&gt;</code><code>
        </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">FieldInput</code><code class="p">&gt;</code><code>
        </code><code class="cm">&lt;!-- First and last name --&gt;</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO4-4" id="co_accepting_form_input_with_validation_CO4-4"><img alt="4" src="assets/4.png"/></a><code>
        </code><code class="p">&lt;</code><code class="nt">div</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"field is-horizontal"</code><code class="p">&gt;</code><code>
            </code><code class="p">&lt;</code><code class="nt">div</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"field-label is-normal"</code><code class="p">&gt;</code><code>
                </code><code class="p">&lt;</code><code class="nt">label</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"label"</code><code class="p">&gt;</code><code>
                    @Localizer["From"]
                    </code><code class="p">&lt;</code><code class="nt">i</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"pl-4 far fa-lg
                        @cxt.GetValidityCss(
                            () =&gt; _model.FirstName,
                            () =&gt; _model.LastName)"</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">i</code><code class="p">&gt;</code><code>
                </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">label</code><code class="p">&gt;</code><code>
            </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code><code>
            </code><code class="p">&lt;</code><code class="nt">div</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"field-body"</code><code class="p">&gt;</code><code>
                </code><code class="p">&lt;</code><code class="nt">div</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"field"</code><code class="p">&gt;</code><code>
                    </code><code class="p">&lt;</code><code class="nt">p</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"control is-expanded has-icons-left"</code><code class="p">&gt;</code><code>
                        </code><code class="p">&lt;</code><code class="nt">InputText</code><code> </code><code class="err">@</code><code class="na">ref</code><code class="o">=</code><code class="s">"_firstNameInput"</code><code>
                            </code><code class="err">@</code><code class="na">bind-Value</code><code class="o">=</code><code class="s">"_model.FirstName"</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"input"</code><code>
                            </code><code class="na">placeholder</code><code class="o">=</code><code class="s">"@Localizer["</code><code class="na">FirstName</code><code class="err">"</code><code class="err">]</code><code class="err">"</code><code> </code><code class="p">/</code><code class="p">&gt;</code><code>
                        </code><code class="p">&lt;</code><code class="nt">span</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"icon is-small is-left"</code><code class="p">&gt;</code><code>
                            </code><code class="p">&lt;</code><code class="nt">i</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"fas fa-user"</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">i</code><code class="p">&gt;</code><code>
                        </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">span</code><code class="p">&gt;</code><code>
                    </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">p</code><code class="p">&gt;</code><code>
                </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code><code>
                </code><code class="p">&lt;</code><code class="nt">div</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"field"</code><code class="p">&gt;</code><code>
                    </code><code class="p">&lt;</code><code class="nt">p</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"control is-expanded has-icons-left"</code><code class="p">&gt;</code><code>
                        </code><code class="p">&lt;</code><code class="nt">InputText</code><code> </code><code class="err">@</code><code class="na">bind-Value</code><code class="o">=</code><code class="s">"_model.LastName"</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"input"</code><code>
                                   </code><code class="na">placeholder</code><code class="o">=</code><code class="s">"@Localizer["</code><code class="na">LastName</code><code class="err">"</code><code class="err">]</code><code class="err">"</code><code> </code><code class="p">/</code><code class="p">&gt;</code><code>
                        </code><code class="p">&lt;</code><code class="nt">span</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"icon is-small is-left"</code><code class="p">&gt;</code><code>
                            </code><code class="p">&lt;</code><code class="nt">i</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"fas fa-user"</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">i</code><code class="p">&gt;</code><code>
                        </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">span</code><code class="p">&gt;</code><code>
                    </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">p</code><code class="p">&gt;</code><code>
                </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code><code>
            </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code><code>
        </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code><code>
        </code><code class="cm">&lt;!-- Subject --&gt;</code><code>
        </code><code class="p">&lt;</code><code class="nt">FieldInput</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO4-5" id="co_accepting_form_input_with_validation_CO4-5"><img alt="5" src="assets/5.png"/></a><code>
            </code><code class="p">&lt;</code><code class="nt">FieldLabelContent</code><code class="p">&gt;</code><code>
                @Localizer["Subject"]
                </code><code class="p">&lt;</code><code class="nt">i</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"pl-4 far fa-lg
                    @cxt.GetValidityCss(() =&gt; _model.Subject)"</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">i</code><code class="p">&gt;</code><code>
            </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">FieldLabelContent</code><code class="p">&gt;</code><code>
            </code><code class="p">&lt;</code><code class="nt">FieldControlContent</code><code class="p">&gt;</code><code>
                </code><code class="p">&lt;</code><code class="nt">InputText</code><code> </code><code class="err">@</code><code class="na">bind-Value</code><code class="o">=</code><code class="s">"_model.Subject"</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"input"</code><code>
                    </code><code class="na">placeholder</code><code class="o">=</code><code class="s">"@Localizer["</code><code class="na">SubjectPlaceholder</code><code class="err">"</code><code class="err">]</code><code class="err">"</code><code> </code><code class="p">/</code><code class="p">&gt;</code><code>
                </code><code class="p">&lt;</code><code class="nt">span</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"icon is-small is-left"</code><code class="p">&gt;</code><code>
                    </code><code class="p">&lt;</code><code class="nt">i</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"fas fa-info-circle"</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">i</code><code class="p">&gt;</code><code>
                </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">span</code><code class="p">&gt;</code><code>
            </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">FieldControlContent</code><code class="p">&gt;</code><code>
        </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">FieldInput</code><code class="p">&gt;</code><code>
        </code><code class="cm">&lt;!-- Message --&gt;</code><code>
        </code><code class="p">&lt;</code><code class="nt">FieldInput</code><code> </code><code class="na">ControlClasses</code><code class="o">=</code><code class="s">@(Array.Empty&lt;string</code><code class="p">&gt;</code><code>())&gt;
            </code><code class="p">&lt;</code><code class="nt">FieldLabelContent</code><code class="p">&gt;</code><code>
                @Localizer["Message"]
                </code><code class="p">&lt;</code><code class="nt">i</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"pl-4 far fa-lg
                    @cxt.GetValidityCss(() =&gt; _model.Message)"</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">i</code><code class="p">&gt;</code><code>
            </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">FieldLabelContent</code><code class="p">&gt;</code><code>
            </code><code class="p">&lt;</code><code class="nt">FieldControlContent</code><code class="p">&gt;</code><code>
                </code><code class="p">&lt;</code><code class="nt">AdditiveSpeechRecognitionComponent</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO4-6" id="co_accepting_form_input_with_validation_CO4-6"><img alt="6" src="assets/6.png"/></a><code>
                    </code><code class="na">SpeechRecognitionStarted</code><code class="o">=</code><code class="s">OnRecognitionStarted</code><code>
                    </code><code class="na">SpeechRecognitionStopped</code><code class="o">=</code><code class="s">OnRecognitionStopped</code><code>
                    </code><code class="na">SpeechRecognized</code><code class="o">=</code><code class="s">OnSpeechRecognized</code><code> </code><code class="p">/</code><code class="p">&gt;</code><code>
                </code><code class="p">&lt;</code><code class="nt">InputTextArea</code><code> </code><code class="err">@</code><code class="na">bind-Value</code><code class="o">=</code><code class="s">"_model.Message"</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"textarea"</code><code>
                    </code><code class="na">readonly</code><code class="o">=</code><code class="s">@_isMessageReadonly</code><code> </code><code class="na">disabled</code><code class="o">=</code><code class="s">@_isMessageReadonly</code><code>
                    </code><code class="na">placeholder</code><code class="o">=</code><code class="s">"@Localizer["</code><code class="na">MessagePlaceholder</code><code class="err">"</code><code class="err">]</code><code class="err">"</code><code> </code><code class="p">/</code><code class="p">&gt;</code><code>
            </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">FieldControlContent</code><code class="p">&gt;</code><code>
        </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">FieldInput</code><code class="p">&gt;</code><code>
        </code><code class="cm">&lt;!-- Agree to terms --&gt;</code><code>
        </code><code class="p">&lt;</code><code class="nt">FieldInput</code><code> </code><code class="na">ControlClasses</code><code class="o">=</code><code class="s">@(Array.Empty&lt;string</code><code class="p">&gt;</code><code>())&gt; </code><a class="co" href="#callout_accepting_form_input_with_validation_CO4-7" id="co_accepting_form_input_with_validation_CO4-7"><img alt="7" src="assets/7.png"/></a><code>
            </code><code class="p">&lt;</code><code class="nt">FieldLabelContent</code><code class="p">&gt;</code><code>
                @Localizer["AgreeToTerms"]
                </code><code class="p">&lt;</code><code class="nt">i</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"pl-4 far fa-lg
                    @cxt.GetValidityCss(() =&gt; _model.AgreesToTerms)"</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">i</code><code class="p">&gt;</code><code>
            </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">FieldLabelContent</code><code class="p">&gt;</code><code>
            </code><code class="p">&lt;</code><code class="nt">FieldControlContent</code><code class="p">&gt;</code><code>
                </code><code class="p">&lt;</code><code class="nt">label</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"checkbox"</code><code class="p">&gt;</code><code>
                    </code><code class="p">&lt;</code><code class="nt">InputCheckbox</code><code> </code><code class="err">@</code><code class="na">bind-Value</code><code class="o">=</code><code class="s">"_model.AgreesToTerms"</code><code> </code><code class="p">/</code><code class="p">&gt;</code><code>
                    @Localizer["TermsAndConditions"]
                    </code><code class="p">&lt;</code><code class="nt">a</code><code> </code><code class="na">href</code><code class="o">=</code><code class="s">"/termsandconditions"</code><code> </code><code class="na">target</code><code class="o">=</code><code class="s">"_blank"</code><code>
                        </code><code class="na">rel</code><code class="o">=</code><code class="s">"noopener noreferrer"</code><code class="p">&gt;</code><code>
                        </code><code class="p">&lt;</code><code class="nt">i</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"fas fa-external-link-alt"</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">i</code><code class="p">&gt;</code><code>
                    </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">a</code><code class="p">&gt;</code><code>
                </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">label</code><code class="p">&gt;</code><code>
            </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">FieldControlContent</code><code class="p">&gt;</code><code>
        </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">FieldInput</code><code class="p">&gt;</code><code>
        </code><code class="cm">&lt;!-- Send button --&gt;</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO4-8" id="co_accepting_form_input_with_validation_CO4-8"><img alt="8" src="assets/8.png"/></a><code>
        </code><code class="p">&lt;</code><code class="nt">div</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"field is-horizontal"</code><code class="p">&gt;</code><code>
            </code><code class="p">&lt;</code><code class="nt">div</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"field-label"</code><code class="p">&gt;</code><code>
                </code><code class="cm">&lt;!-- Left empty for spacing --&gt;</code><code>
            </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code><code>
            </code><code class="p">&lt;</code><code class="nt">div</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"field-body"</code><code class="p">&gt;</code><code>
                </code><code class="p">&lt;</code><code class="nt">div</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"field is-grouped"</code><code class="p">&gt;</code><code>
                    </code><code class="p">&lt;</code><code class="nt">button</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"button is-success is-large"</code><code> </code><code class="na">type</code><code class="o">=</code><code class="s">"submit"</code><code class="p">&gt;</code><code>
                        </code><code class="p">&lt;</code><code class="nt">span</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"icon"</code><code class="p">&gt;</code><code>
                            </code><code class="p">&lt;</code><code class="nt">i</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"fas fa-paper-plane"</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">i</code><code class="p">&gt;</code><code>
                        </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">span</code><code class="p">&gt;</code><code>
                        </code><code class="p">&lt;</code><code class="nt">span</code><code class="p">&gt;</code><code>@Localizer["Send"]</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">span</code><code class="p">&gt;</code><code>
                    </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">button</code><code class="p">&gt;</code><code>
                </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code><code>
            </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code><code>
        </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code><code>
    </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">EditForm</code><code class="p">&gt;</code><code>
</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">section</code><code class="p">&gt;</code><code>

</code><code class="p">&lt;</code><code class="nt">VerificationModalComponent</code><code> </code><code class="err">@</code><code class="na">ref</code><code class="o">=</code><code class="s">"_modalComponent"</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO4-9" id="co_accepting_form_input_with_validation_CO4-9"><img alt="9" src="assets/9.png"/></a><code>
    </code><code class="na">VerificationAttempted</code><code class="o">=</code><code class="s">@OnVerificationAttempted</code><code> </code><code class="p">/</code><code class="p">&gt;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO4-1" id="callout_accepting_form_input_with_validation_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>Contact</code> page allows anonymous users to contact the site owner.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO4-2" id="callout_accepting_form_input_with_validation_CO4-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p><code>EditForm</code> is a framework-provided <a data-primary="EditForm" data-type="indexterm" id="idm46365005950512"/>component that is used to render a <code>form</code>.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO4-3" id="callout_accepting_form_input_with_validation_CO4-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The page model accepts an <code>EmailAddress</code> <a data-primary="EmailAddress property" data-type="indexterm" id="idm46365005946480"/>property and renders an <code>&lt;InputText&gt;</code> element.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO4-4" id="callout_accepting_form_input_with_validation_CO4-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The page model accepts <code>FirstName</code> and <code>LastName</code> properties <a data-primary="FirstName property" data-type="indexterm" id="idm46365005883104"/><a data-primary="LastName property" data-type="indexterm" id="idm46365005882368"/>and renders two <code>&lt;input type="text"&gt;</code> elements.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO4-5" id="callout_accepting_form_input_with_validation_CO4-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>The page model accepts a <code>Subject</code> property <a data-primary="Subject property" data-type="indexterm" id="idm46365006087440"/>and renders an <code>&lt;InputText&gt;</code> 
<span class="keep-together">element.</span></p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO4-6" id="callout_accepting_form_input_with_validation_CO4-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>The page model accepts a <code>Message</code> property <a data-primary="Message property" data-type="indexterm" id="idm46365005743200"/>and renders an <code>&lt;InputTextArea&gt;</code> element. This is where the additive speech recognition component is rendered, and that’s detailed later in this chapter.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO4-7" id="callout_accepting_form_input_with_validation_CO4-7"><img alt="7" src="assets/7.png"/></a></dt>
<dd><p>The page model accepts an <code>AgreesToTerms</code> property <a data-primary="AgreesToTerms property" data-type="indexterm" id="idm46365006193296"/>and renders an <code>&lt;Input​Check⁠box&gt;</code> element.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO4-8" id="callout_accepting_form_input_with_validation_CO4-8"><img alt="8" src="assets/8.png"/></a></dt>
<dd><p>The page model accepts a <code>Send</code> button and <a data-primary="Send button" data-type="indexterm" id="idm46365006189136"/><a data-primary="VerificationModalComponent, spam filter and" data-type="indexterm" id="idm46365005898944"/>renders a <code>&lt;button&gt;</code> element.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO4-9" id="callout_accepting_form_input_with_validation_CO4-9"><img alt="9" src="assets/9.png"/></a></dt>
<dd><p>The page references <code>VerificationModalComponent</code> for a spam filter.</p></dd>
</dl>

<p>The page that displays when the <code>/contact</code> route is requested renders as shown in <a data-type="xref" href="#contact-page-rendered">Figure 8-2</a>.</p>

<figure><div class="figure" id="contact-page-rendered">
<img alt="" src="assets/lblz_0802.png"/>
<h6><span class="label">Figure 8-2. </span>A blank <code>Contact</code> page form with only the email address prefilled</h6>
</div></figure>

<p>Let’s summarize what’s going on here. The <code>Contact</code> page is a form with a few fields. The page model is a class that contains the properties that are bound to the form elements. The <code>EditForm</code> component is a framework-provided component that renders an HTML <code>form</code> element. It requires either <code>EditContext</code> or <code>Model</code>, but not both. In this case, <code>EditContext</code> wraps <code>ContactComponentModel</code>. The model used in <code>Edit​Con⁠text</code> can be any <code>object</code>. <code>EditContext</code> holds metadata related to a data editing process, such as flags to indicate which fields have been modified and the current set of validation messages. The <code>EditContext.Model</code> will be used by <code>EditForm</code> to render the form. <code>EditContext.OnValidSubmit</code> event handler is used to handle the form submission. When the form is both valid and submitted, the 
<span class="keep-together"><code>Contact.OnValidSubmitAsync</code></span> event handler is called. The <code>DataAnno⁠tations​Val⁠ida⁠tor</code> framework-provided component is used to add validation <code>Data​Annota⁠tions</code> attribute support that informs the <code>EditContext</code> instance with metadata about the model.</p>

<p>The fields in the form are as follows:</p>
<dl>
<dt>Email</dt>
<dd>
<p>A <code>FieldInput</code> custom component <a data-primary="Contact form" data-secondary="fields" data-type="indexterm" id="idm46365005791632"/><a data-primary="forms" data-secondary="Contact" data-tertiary="fields" data-type="indexterm" id="idm46365005790624"/>bound to the model’s <code>EmailAddress</code> property.</p>
</dd>
<dt>From</dt>
<dd>
<p>Two horizontal fields presented as framework-provided <code>InputText</code> components, bound to the model’s <code>FirstName</code> and <code>LastName</code> properties. These values are both required and can alter the state of the validation for a shared validation icon.</p>
</dd>
<dt>Subject</dt>
<dd>
<p>A <code>FieldInput</code> custom component bound to the model’s <code>Subject</code> property.</p>
</dd>
<dt>Message</dt>
<dd>
<p>A <code>FieldInput</code> custom component bound to the model’s <code>Message</code> property but relying on <code>AdditiveSpeechRecognitionComponent</code> to add speech recognition support that is tied to an <code>InputTextArea</code> component. <code>AdditiveSpeech​Rec⁠ogni⁠tionComponent</code> renders an overlay toggle <code>&lt;button&gt;</code> in the upper-righthand corner of its parent HTML element.</p>
</dd>
<dt>Whether the user agrees to the terms</dt>
<dd>
<p>A <code>FieldInput</code> custom component bound to the model’s <code>AgreesToTerms</code> property, and the framework-provided <code>InputCheckbox</code> component that is used to render a checkbox.</p>
</dd>
<dt>Submit form button</dt>
<dd>
<p>A send <code>&lt;button type="submit"&gt;</code> element at the end of the <code>EditForm</code> markup. When the user clicks this button, the <code>EditContext.OnValidSubmit</code> event handler is called, if the form is valid.</p>
</dd>
<dt>Modal dialog</dt>
<dd>
<p>A dialog rendered by <code>VerificationModalComponent</code> is shown when the user clicks the <code>Send</code> button. The dialog serves as a spam filter, as it requires the user <a data-primary="Contact.cshtml Razor file" data-startref="cthrz" data-type="indexterm" id="idm46365005807392"/>who submitted the form to answer a math question in string form.</p>
</dd>
</dl>

<p>The shadow component does this because there’s a fair bit of Razor markup. It’s used to manage the framework-provided <code>EditContext</code>, <code>_model</code>, <code>_emailInput</code>, <code>_firstNameInput</code>, <code>_modalComponent</code>, and two <code>bool</code> values for whether the email or message input elements should be <code>readonly</code>. These are detailed in the coming sections. Since the contact page is attributed with <code>AllowAnonymous</code>, it can be accessed by 
<span class="keep-together">nonauthenticated</span> users; this is intentional to allow potential users of the app to reach out with questions.</p>

<p>It is common for Razor <a data-primary="expression trees" data-type="indexterm" id="idm46365005636576"/><a data-primary="Razor" data-secondary="expression trees" data-type="indexterm" id="idm46365005635840"/>components to use <code>Expression&lt;Func&lt;T&gt;&gt;</code> semantics (or expression trees) when evaluating model properties. An expression tree represents code as a data structure, where each node is an expression. Expressions look like <a data-primary="expressions, parsing" data-type="indexterm" id="idm46365005634352"/>functions but are not evaluated. Instead, an expression is parsed. For example, when we pass in <code>_model.EmailAddress</code>, the Blazor library calls <code>FieldCssClass</code>. The expression is then parsed extracting how to evaluate both our model and its corresponding property value.</p>

<p>As a convenience for determining which CSS classes are applicable given the state of a specific model’s property expression, the <code>GetValidityCss</code> extension method calculates the appropriate CSS classes <a data-primary="EditContextExtensions.cs" data-type="indexterm" id="ecxxt"/>for the property. Consider the <em>EditContext​Ex⁠tensions.cs</em> C# file:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code><code> </code><code class="nn">Learning.Blazor.Extensions</code><code class="p">;</code><code>
</code><code>
</code><code class="k">public</code><code> </code><code class="k">static</code><code> </code><code class="k">class</code><code> </code><code class="nc">EditContextExtensions</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="c1">/// &lt;summary&gt;
</code><code>    </code><code class="c1">/// Maps the given &lt;paramref name="accessor"/&gt;
</code><code>    </code><code class="c1">/// expression to the resulting CSS.
</code><code>    </code><code class="c1">/// &lt;/summary&gt;
</code><code>    </code><code class="k">public</code><code> </code><code class="k">static</code><code> </code><code class="kt">string</code><code> </code><code class="n">GetValidityCss</code><code class="p">&lt;</code><code class="n">T</code><code class="p">&gt;</code><code class="p">(</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO5-1" id="co_accepting_form_input_with_validation_CO5-1"><img alt="1" src="assets/1.png"/></a><code>
</code><code>        </code><code class="k">this</code><code> </code><code class="n">EditContext</code><code> </code><code class="n">context</code><code class="p">,</code><code>
</code><code>        </code><code class="n">Expression</code><code class="p">&lt;</code><code class="n">Func</code><code class="p">&lt;</code><code class="n">T</code><code class="p">?</code><code class="p">&gt;</code><code class="p">&gt;</code><code> </code><code class="n">accessor</code><code class="p">)</code><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="kt">var</code><code> </code><code class="n">css</code><code> </code><code class="p">=</code><code> </code><code class="n">context</code><code class="p">?</code><code class="p">.</code><code class="n">FieldCssClass</code><code class="p">(</code><code class="n">accessor</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="nf">GetValidityCss</code><code class="p">(</code><code>
</code><code>            </code><code class="n">IsValid</code><code class="p">(</code><code class="n">css</code><code class="p">)</code><code class="p">,</code><code>
</code><code>            </code><code class="n">IsInvalid</code><code class="p">(</code><code class="n">css</code><code class="p">)</code><code class="p">,</code><code>
</code><code>            </code><code class="n">IsModified</code><code class="p">(</code><code class="n">css</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code>
</code><code>    </code><code class="c1">/// &lt;summary&gt;
</code><code>    </code><code class="c1">/// Maps the given &lt;paramref name="accessorOne"/&gt; and
</code><code>    </code><code class="c1">/// &lt;paramref name="accessorTwo"/&gt; expressions to
</code><code>    </code><code class="c1">/// the resulting CSS.
</code><code>    </code><code class="c1">/// &lt;/summary&gt;
</code><code>    </code><code class="k">public</code><code> </code><code class="k">static</code><code> </code><code class="kt">string</code><code> </code><code class="n">GetValidityCss</code><code class="p">&lt;</code><code class="n">TOne</code><code class="p">,</code><code> </code><code class="n">TTwo</code><code class="p">&gt;</code><code class="p">(</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO5-2" id="co_accepting_form_input_with_validation_CO5-2"><img alt="2" src="assets/2.png"/></a><code>
</code><code>        </code><code class="k">this</code><code> </code><code class="n">EditContext</code><code> </code><code class="n">context</code><code class="p">,</code><code>
</code><code>        </code><code class="n">Expression</code><code class="p">&lt;</code><code class="n">Func</code><code class="p">&lt;</code><code class="n">TOne</code><code class="p">?</code><code class="p">&gt;</code><code class="p">&gt;</code><code> </code><code class="n">accessorOne</code><code class="p">,</code><code>
</code><code>        </code><code class="n">Expression</code><code class="p">&lt;</code><code class="n">Func</code><code class="p">&lt;</code><code class="n">TTwo</code><code class="p">?</code><code class="p">&gt;</code><code class="p">&gt;</code><code> </code><code class="n">accessorTwo</code><code class="p">)</code><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="kt">var</code><code> </code><code class="n">cssOne</code><code> </code><code class="p">=</code><code> </code><code class="n">context</code><code class="p">?</code><code class="p">.</code><code class="n">FieldCssClass</code><code class="p">(</code><code class="n">accessorOne</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="kt">var</code><code> </code><code class="n">cssTwo</code><code> </code><code class="p">=</code><code> </code><code class="n">context</code><code class="p">?</code><code class="p">.</code><code class="n">FieldCssClass</code><code class="p">(</code><code class="n">accessorTwo</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="nf">GetValidityCss</code><code class="p">(</code><code>
</code><code>            </code><code class="n">IsValid</code><code class="p">(</code><code class="n">cssOne</code><code class="p">)</code><code> </code><code class="p">&amp;</code><code class="p">&amp;</code><code> </code><code class="n">IsValid</code><code class="p">(</code><code class="n">cssTwo</code><code class="p">)</code><code class="p">,</code><code>
</code><code>            </code><code class="n">IsInvalid</code><code class="p">(</code><code class="n">cssOne</code><code class="p">)</code><code> </code><code class="p">|</code><code class="p">|</code><code> </code><code class="n">IsInvalid</code><code class="p">(</code><code class="n">cssTwo</code><code class="p">)</code><code class="p">,</code><code>
</code><code>            </code><code class="n">IsModified</code><code class="p">(</code><code class="n">cssOne</code><code class="p">)</code><code> </code><code class="p">&amp;</code><code class="p">&amp;</code><code> </code><code class="n">IsModified</code><code class="p">(</code><code class="n">cssTwo</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code>
</code><code>    </code><code class="c1">/// &lt;summary&gt;
</code><code>    </code><code class="c1">/// Maps the given validation states into corresponding CSS classes.
</code><code>    </code><code class="c1">/// &lt;/summary&gt;
</code><code>    </code><code class="k">public</code><code> </code><code class="k">static</code><code> </code><code class="kt">string</code><code> </code><code class="nf">GetValidityCss</code><code class="p">(</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO5-3" id="co_accepting_form_input_with_validation_CO5-3"><img alt="3" src="assets/3.png"/></a><code>
</code><code>        </code><code class="kt">bool</code><code> </code><code class="n">isValid</code><code class="p">,</code><code> </code><code class="kt">bool</code><code> </code><code class="n">isInvalid</code><code class="p">,</code><code> </code><code class="kt">bool</code><code> </code><code class="n">isModified</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="p">(</code><code class="n">isValid</code><code class="p">,</code><code> </code><code class="n">isInvalid</code><code class="p">)</code><code> </code><code class="k">switch</code><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="p">(</code><code class="k">true</code><code class="p">,</code><code> </code><code class="k">false</code><code class="p">)</code><code> </code><code class="k">when</code><code> </code><code class="n">isModified</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="s">"fa-check-circle has-text-success"</code><code class="p">,</code><code>
</code><code>            </code><code class="p">(</code><code class="k">false</code><code class="p">,</code><code> </code><code class="k">true</code><code class="p">)</code><code> </code><code class="k">when</code><code> </code><code class="n">isModified</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="s">"fa-times-circle has-text-danger"</code><code class="p">,</code><code>
</code><code>
</code><code>            </code><code class="n">_</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="s">"fa-question-circle"</code><code>
</code><code>        </code><code class="p">}</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">private</code><code> </code><code class="k">static</code><code> </code><code class="kt">bool</code><code> </code><code class="nf">IsValid</code><code class="p">(</code><code class="kt">string?</code><code> </code><code class="n">css</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO5-4" id="co_accepting_form_input_with_validation_CO5-4"><img alt="4" src="assets/4.png"/></a><code>
</code><code>        </code><code class="n">IsContainingClass</code><code class="p">(</code><code class="n">css</code><code class="p">,</code><code> </code><code class="s">"valid"</code><code class="p">)</code><code> </code><code class="p">&amp;</code><code class="p">&amp;</code><code> </code><code class="p">!</code><code class="n">IsInvalid</code><code class="p">(</code><code class="n">css</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">private</code><code> </code><code class="k">static</code><code> </code><code class="kt">bool</code><code> </code><code class="nf">IsInvalid</code><code class="p">(</code><code class="kt">string?</code><code> </code><code class="n">css</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO5-5" id="co_accepting_form_input_with_validation_CO5-5"><img alt="5" src="assets/5.png"/></a><code>
</code><code>        </code><code class="n">IsContainingClass</code><code class="p">(</code><code class="n">css</code><code class="p">,</code><code> </code><code class="s">"invalid"</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">private</code><code> </code><code class="k">static</code><code> </code><code class="kt">bool</code><code> </code><code class="nf">IsModified</code><code class="p">(</code><code class="kt">string?</code><code> </code><code class="n">css</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO5-6" id="co_accepting_form_input_with_validation_CO5-6"><img alt="6" src="assets/6.png"/></a><code>
</code><code>        </code><code class="n">IsContainingClass</code><code class="p">(</code><code class="n">css</code><code class="p">,</code><code> </code><code class="s">"modified"</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">private</code><code> </code><code class="k">static</code><code> </code><code class="kt">bool</code><code> </code><code class="nf">IsContainingClass</code><code class="p">(</code><code class="kt">string?</code><code> </code><code class="n">css</code><code class="p">,</code><code> </code><code class="kt">string</code><code> </code><code class="n">name</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">css</code><code class="p">?</code><code class="p">.</code><code class="n">Contains</code><code class="p">(</code><code class="n">name</code><code class="p">,</code><code> </code><code class="n">StringComparison</code><code class="p">.</code><code class="n">OrdinalIgnoreCase</code><code class="p">)</code><code> </code><code class="p">?</code><code class="p">?</code><code> </code><code class="k">false</code><code class="p">;</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO5-1" id="callout_accepting_form_input_with_validation_CO5-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>Expression&lt;Func&lt;T&gt;&gt;</code> parameter is used to access the model’s property.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO5-2" id="callout_accepting_form_input_with_validation_CO5-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>Expression&lt;Func&lt;TOne&gt;&gt;</code> and <code>Expression&lt;Func&lt;TTwo&gt;&gt;</code> parameters are used to access the model’s property.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO5-3" id="callout_accepting_form_input_with_validation_CO5-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>bool</code> parameters are used to determine the CSS class to return.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO5-4" id="callout_accepting_form_input_with_validation_CO5-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The <code>IsValid</code> method is used to determine if the property is valid.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO5-5" id="callout_accepting_form_input_with_validation_CO5-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>The <code>IsInvalid</code> method is used to determine if the property is invalid.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO5-6" id="callout_accepting_form_input_with_validation_CO5-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>The <code>IsModified</code> method is used to determine if the property is modified.</p></dd>
</dl>

<p>The <code>EditContextExtensions</code> class contains some extension methods that are used to determine the CSS class to return based on the state of the model’s property. The <code>GetValidityCss</code> method and its overloads are used to determine the CSS class to return based on the state of the <a data-primary="EditContextExtensions.cs" data-startref="ecxxt" data-type="indexterm" id="idm46365005999664"/>model’s property. Using the framework-provided <code>EditContextFieldClassExtensions.FieldCssClass</code> extension method, we can 
<span class="keep-together">evaluate</span> the current CSS classes given the state of the corresponding expression. The <code>Get​Vali⁠dityCss</code> method is <a data-primary="GetValidityCss method" data-type="indexterm" id="idm46365005997136"/><a data-primary="methods" data-secondary="GetValidityCss" data-type="indexterm" id="idm46365005996400"/>used throughout the markup.</p>

<p>Next, let’s have a look <a data-primary="Contact.razor.cs" data-type="indexterm" id="cnttz"/>at the <em>Contact.razor.cs</em> C# file:</p>

<pre class="widows_48 pagebreak-after" data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code><code> </code><code class="nn">Learning.Blazor.Pages</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="k">sealed</code><code> </code><code class="k">partial</code><code> </code><code class="k">class</code><code> </code><code class="nc">Contact</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO6-1" id="co_accepting_form_input_with_validation_CO6-1"><img alt="1" src="assets/1.png"/></a><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="k">private</code><code> </code><code class="n">EditContext</code><code> </code><code class="n">_editContext</code><code> </code><code class="p">=</code><code> </code><code class="k">null</code><code class="p">!</code><code class="p">;</code><code>
</code><code>        </code><code class="k">private</code><code> </code><code class="n">ContactComponentModel</code><code> </code><code class="n">_model</code><code> </code><code class="p">=</code><code> </code><code class="k">new</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="k">private</code><code> </code><code class="n">InputText</code><code> </code><code class="n">_emailInput</code><code> </code><code class="p">=</code><code> </code><code class="k">null</code><code class="p">!</code><code class="p">;</code><code>
</code><code>        </code><code class="k">private</code><code> </code><code class="n">InputText</code><code> </code><code class="n">_firstNameInput</code><code> </code><code class="p">=</code><code> </code><code class="k">null</code><code class="p">!</code><code class="p">;</code><code>
</code><code>        </code><code class="k">private</code><code> </code><code class="n">VerificationModalComponent</code><code> </code><code class="n">_modalComponent</code><code> </code><code class="p">=</code><code> </code><code class="k">null</code><code class="p">!</code><code class="p">;</code><code>
</code><code>        </code><code class="k">private</code><code> </code><code class="kt">bool</code><code> </code><code class="n">_isEmailReadonly</code><code> </code><code class="p">=</code><code> </code><code class="k">false</code><code class="p">;</code><code>
</code><code>        </code><code class="k">private</code><code> </code><code class="kt">bool</code><code> </code><code class="n">_isMessageReadonly</code><code> </code><code class="p">=</code><code> </code><code class="k">false</code><code class="p">;</code><code>
</code><code class="na">
        [Inject]</code><code>
</code><code>        </code><code class="k">public</code><code> </code><code class="n">IHttpClientFactory</code><code> </code><code class="n">HttpFactory</code><code> </code><code class="p">{</code><code> </code><code class="k">get</code><code class="p">;</code><code> </code><code class="k">set</code><code class="p">;</code><code> </code><code class="p">}</code><code> </code><code class="p">=</code><code> </code><code class="k">null</code><code class="p">!</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="k">protected</code><code> </code><code class="k">override</code><code> </code><code class="k">async</code><code> </code><code class="n">Task</code><code> </code><code class="nf">OnInitializedAsync</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO6-2" id="co_accepting_form_input_with_validation_CO6-2"><img alt="2" src="assets/2.png"/></a><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="c1">// Initializes the "User" instance.
</code><code>            </code><code class="k">await</code><code> </code><code class="k">base</code><code class="p">.</code><code class="n">OnInitializedAsync</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>            </code><code class="n">InitializeModelAndContext</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>
</code><code>        </code><code class="k">private</code><code> </code><code class="k">void</code><code> </code><code class="nf">InitializeModelAndContext</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO6-3" id="co_accepting_form_input_with_validation_CO6-3"><img alt="3" src="assets/3.png"/></a><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="k">if</code><code> </code><code class="p">(</code><code class="n">User</code><code> </code><code class="k">is</code><code> </code><code class="p">{</code><code> </code><code class="n">Identity</code><code class="p">.</code><code class="n">IsAuthenticated</code><code class="p">:</code><code> </code><code class="k">true</code><code> </code><code class="p">}</code><code class="p">)</code><code>
</code><code>            </code><code class="p">{</code><code>
</code><code>                </code><code class="n">_model</code><code> </code><code class="p">=</code><code> </code><code class="n">_model</code><code> </code><code class="n">with</code><code>
</code><code>                </code><code class="p">{</code><code>
</code><code>                    </code><code class="n">EmailAddress</code><code> </code><code class="p">=</code><code> </code><code class="n">User</code><code class="p">.</code><code class="n">GetFirstEmailAddress</code><code class="p">(</code><code class="p">)</code><code>
</code><code>                </code><code class="p">}</code><code class="p">;</code><code>
</code><code>                </code><code class="n">_isEmailReadonly</code><code> </code><code class="p">=</code><code> </code><code class="n">_model</code><code class="p">.</code><code class="n">EmailAddress</code><code> </code><code class="k">is</code><code> </code><code class="n">not</code><code> </code><code class="k">null</code><code>
</code><code>                    </code><code class="p">&amp;</code><code class="p">&amp;</code><code> </code><code class="n">RegexEmailAddressAttribute</code><code class="p">.</code><code class="n">EmailExpression</code><code class="p">.</code><code class="n">IsMatch</code><code class="p">(</code><code>
</code><code>                        </code><code class="n">_model</code><code class="p">.</code><code class="n">EmailAddress</code><code class="p">)</code><code class="p">;</code><code>
</code><code>            </code><code class="p">}</code><code>
</code><code>
</code><code>            </code><code class="n">_editContext</code><code> </code><code class="p">=</code><code> </code><code class="k">new</code><code class="p">(</code><code class="n">_model</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>
</code><code>        </code><code class="k">protected</code><code> </code><code class="k">override</code><code> </code><code class="k">async</code><code> </code><code class="n">Task</code><code> </code><code class="nf">OnAfterRenderAsync</code><code class="p">(</code><code class="kt">bool</code><code> </code><code class="n">firstRender</code><code class="p">)</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO6-4" id="co_accepting_form_input_with_validation_CO6-4"><img alt="4" src="assets/4.png"/></a><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="k">if</code><code> </code><code class="p">(</code><code class="n">firstRender</code><code class="p">)</code><code>
</code><code>            </code><code class="p">{</code><code>
</code><code>                </code><code class="kt">var</code><code> </code><code class="n">input</code><code> </code><code class="p">=</code><code> </code><code class="n">_isEmailReadonly</code><code> </code><code class="p">?</code><code> </code><code class="n">_firstNameInput</code><code> </code><code class="p">:</code><code> </code><code class="n">_emailInput</code><code class="p">;</code><code>
</code><code>                </code><code class="k">await</code><code> </code><code class="p">(</code><code class="n">input</code><code class="p">?</code><code class="p">.</code><code class="n">Element</code><code class="p">?</code><code class="p">.</code><code class="n">FocusAsync</code><code class="p">(</code><code class="n">preventScroll</code><code class="p">:</code><code> </code><code class="k">true</code><code class="p">)</code><code>
</code><code>                    </code><code class="p">?</code><code class="p">?</code><code> </code><code class="n">ValueTask</code><code class="p">.</code><code class="n">CompletedTask</code><code class="p">)</code><code class="p">;</code><code>
</code><code>            </code><code class="p">}</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>
</code><code>        </code><code class="k">private</code><code> </code><code class="k">void</code><code> </code><code class="nf">OnRecognitionStarted</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">_isMessageReadonly</code><code> </code><code class="p">=</code><code> </code><code class="k">true</code><code class="p">;</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO6-5" id="co_accepting_form_input_with_validation_CO6-5"><img alt="5" src="assets/5.png"/></a><code>
</code><code>
</code><code>        </code><code class="k">private</code><code> </code><code class="k">void</code><code> </code><code class="nf">OnRecognitionStopped</code><code class="p">(</code><code>
</code><code>            </code><code class="n">SpeechRecognitionErrorEvent</code><code class="p">?</code><code> </code><code class="n">error</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>            </code><code class="n">_isMessageReadonly</code><code> </code><code class="p">=</code><code> </code><code class="k">false</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="k">private</code><code> </code><code class="k">void</code><code> </code><code class="nf">OnSpeechRecognized</code><code class="p">(</code><code class="kt">string</code><code> </code><code class="n">transcript</code><code class="p">)</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO6-6" id="co_accepting_form_input_with_validation_CO6-6"><img alt="6" src="assets/6.png"/></a><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="n">_model</code><code class="p">.</code><code class="n">Message</code><code> </code><code class="p">=</code><code> </code><code class="n">_model</code><code class="p">.</code><code class="n">Message</code><code> </code><code class="k">switch</code><code>
</code><code>            </code><code class="p">{</code><code>
</code><code>                </code><code class="k">null</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">transcript</code><code class="p">,</code><code>
</code><code>                </code><code class="n">_</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="err">$</code><code class="s">"{_model.Message.Trim()} {transcript}"</code><code class="p">.</code><code class="n">Trim</code><code class="p">(</code><code class="p">)</code><code>
</code><code>            </code><code class="p">}</code><code class="p">;</code><code>
</code><code>
</code><code>            </code><code class="n">_editContext</code><code class="p">.</code><code class="n">NotifyFieldChanged</code><code class="p">(</code><code>
</code><code>                </code><code class="n">_editContext</code><code class="p">.</code><code class="n">Field</code><code class="p">(</code><code class="n">nameof</code><code class="p">(</code><code class="n">_model</code><code class="p">.</code><code class="n">Message</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>
</code><code>        </code><code class="k">private</code><code> </code><code class="n">Task</code><code> </code><code class="nf">OnValidSubmitAsync</code><code class="p">(</code><code class="n">EditContext</code><code> </code><code class="n">context</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO6-7" id="co_accepting_form_input_with_validation_CO6-7"><img alt="7" src="assets/7.png"/></a><code>
</code><code>            </code><code class="n">_modalComponent</code><code class="p">.</code><code class="n">PromptAsync</code><code class="p">(</code><code class="n">context</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="k">private</code><code> </code><code class="k">async</code><code> </code><code class="n">Task</code><code> </code><code class="nf">OnVerificationAttempted</code><code class="p">(</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO6-8" id="co_accepting_form_input_with_validation_CO6-8"><img alt="8" src="assets/8.png"/></a><code>
</code><code>            </code><code class="p">(</code><code class="kt">bool</code><code> </code><code class="n">IsVerified</code><code class="p">,</code><code> </code><code class="kt">object?</code><code> </code><code class="n">State</code><code class="p">)</code><code> </code><code class="n">attempt</code><code class="p">)</code><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="k">if</code><code> </code><code class="p">(</code><code class="n">attempt</code><code class="p">.</code><code class="n">IsVerified</code><code class="p">)</code><code>
</code><code>            </code><code class="p">{</code><code>
</code><code>                </code><code class="kt">var</code><code> </code><code class="n">client</code><code> </code><code class="p">=</code><code>
</code><code>                    </code><code class="n">HttpFactory</code><code class="p">.</code><code class="n">CreateClient</code><code class="p">(</code><code class="n">HttpClientNames</code><code class="p">.</code><code class="n">ServerApi</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>                </code><code class="k">using</code><code> </code><code class="nn">var</code><code> </code><code class="n">response</code><code> </code><code class="p">=</code><code>
</code><code>                    </code><code class="k">await</code><code> </code><code class="n">client</code><code class="p">.</code><code class="n">PostAsJsonAsync</code><code class="p">&lt;</code><code class="n">ContactRequest</code><code class="p">&gt;</code><code class="p">(</code><code>
</code><code>                    </code><code class="s">"api/contact"</code><code class="p">,</code><code>
</code><code>                    </code><code class="n">_model</code><code class="p">,</code><code>
</code><code>                    </code><code class="n">DefaultJsonSerialization</code><code class="p">.</code><code class="n">Options</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>                </code><code class="k">if</code><code> </code><code class="p">(</code><code class="n">response</code><code class="p">.</code><code class="n">IsSuccessStatusCode</code><code class="p">)</code><code>
</code><code>                </code><code class="p">{</code><code>
</code><code>                    </code><code class="n">AppState</code><code class="p">?</code><code class="p">.</code><code class="n">ContactPageSubmitted</code><code class="p">?</code><code class="p">.</code><code class="n">Invoke</code><code class="p">(</code><code class="n">_model</code><code class="p">)</code><code class="p">;</code><code>
</code><code>                    </code><code class="n">_model</code><code> </code><code class="p">=</code><code> </code><code class="k">new</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>                    </code><code class="n">InitializeModelAndContext</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>                    </code><code class="k">await</code><code> </code><code class="nf">InvokeAsync</code><code class="p">(</code><code class="n">StateHasChanged</code><code class="p">)</code><code class="p">;</code><code>
</code><code>                </code><code class="p">}</code><code>
</code><code>            </code><code class="p">}</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist less_space">
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO6-1" id="callout_accepting_form_input_with_validation_CO6-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>EditContext</code> instance wraps <code>ContactComponentModel</code>.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO6-2" id="callout_accepting_form_input_with_validation_CO6-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>OnInitializedAsync</code> method calls the <code>base</code> implementation, which initializes the <code>User</code> instance and immediately calls <code>InitializeModelAndContext</code>.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO6-3" id="callout_accepting_form_input_with_validation_CO6-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>InitializeModelAndContext</code> method initializes the <code>_model</code> and <code>_edit​Con⁠text</code> properties from the <code>User</code> instance.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO6-4" id="callout_accepting_form_input_with_validation_CO6-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The <code>OnAfterRenderAsync</code> method determines which input element should have focus when the page is rendered.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO6-5" id="callout_accepting_form_input_with_validation_CO6-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>The <code>OnRecognitionStarted</code> method sets the <code>_isMessageReadonly</code> property to <code>true</code>.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO6-6" id="callout_accepting_form_input_with_validation_CO6-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>The <code>OnSpeechRecognized</code> method updates the <code>_model.Message</code> property with the transcript and notifies the <code>_editContext</code> instance that the <code>Message</code> property has changed.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO6-7" id="callout_accepting_form_input_with_validation_CO6-7"><img alt="7" src="assets/7.png"/></a></dt>
<dd><p>The <code>OnValidSubmitAsync</code> method is called when the user clicks the <code>Send</code> button.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO6-8" id="callout_accepting_form_input_with_validation_CO6-8"><img alt="8" src="assets/8.png"/></a></dt>
<dd><p>The <code>OnVerificationAttempted</code> method throws a <code>ContactRequest</code> at the Web.Api project’s <code>[HttpPost("api/contact")]</code> endpoint.</p></dd>
</dl>

<p>When the <code>Contact</code> page is <a data-primary="Contact form" data-secondary="base.User instance" data-type="indexterm" id="idm46365004117872"/>initialized, the <code>base.User</code> instance is initialized as well. If there is an authenticated user, the email address is set as <code>readonly</code> and the user’s email is <a data-primary="Contact.razor.cs" data-startref="cnttz" data-type="indexterm" id="idm46365004115792"/>used. If there is no authenticated user, the <code>_model</code> instance is initialized with an empty <code>ContactComponentModel</code> instance. When the page first is rendered, either the <code>_emailInput</code> or <code>_firstNameInput</code> element is focused.</p>

<p>There are two methods responsible for managing whether the <code>_messageInput</code> element is <code>readonly</code>. The <code>OnRecognitionStarted</code> method sets the <code>_isMessageReadonly</code> property to <code>true</code>; <code>OnRecognitionStopped</code> sets it to <code>false</code>. When speech is recognized, the <code>_model.Message</code> property is updated with the transcript, and the <code>_edit​Con⁠text</code> instance is notified that the <code>Message</code> property has changed.</p>

<p class="pagebreak-after">When the user supplies all of the required inputs, the form is considered “valid.” At this point, the user is free to submit the form. When the form is submitted, the <code>_modalComponent</code> instance is shown, which prompts the user to answer one question. If they’re able to do so, the form information is sent to the Web.Api project’s <code>[HttpPost("api/contact")]</code> endpoint for processing.</p>

<p>To help encapsulate a bit of common code for various field inputs, I wrote a <code>Field​In⁠put</code> form component. This component is used throughout the <code>Contact</code> page. Let’s take a look <a data-primary="FieldInput.razor" data-type="indexterm" id="fdpur"/>at the <em>FieldInput.razor</em> Razor markup file:</p>

<pre data-code-language="html" data-type="programlisting"><code class="p">&lt;</code><code class="nt">div</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"field is-horizontal"</code><code class="p">&gt;</code><code>
    </code><code class="p">&lt;</code><code class="nt">div</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"field-label @LabelSpecifierClass"</code><code class="p">&gt;</code><code>
        </code><code class="p">&lt;</code><code class="nt">label</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"label"</code><code class="p">&gt;</code><code>
            @FieldLabelContent </code><a class="co" href="#callout_accepting_form_input_with_validation_CO7-1" id="co_accepting_form_input_with_validation_CO7-1"><img alt="1" src="assets/1.png"/></a><code>
        </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">label</code><code class="p">&gt;</code><code>
    </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code><code>
    </code><code class="p">&lt;</code><code class="nt">div</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"field-body"</code><code class="p">&gt;</code><code>
        </code><code class="p">&lt;</code><code class="nt">div</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"field @ControlSpecifierClass"</code><code class="p">&gt;</code><code>
            </code><code class="p">&lt;</code><code class="nt">p</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"control @ControlClasses.ToSpaceDelimitedString()"</code><code class="p">&gt;</code><code>
                @FieldControlContent </code><a class="co" href="#callout_accepting_form_input_with_validation_CO7-2" id="co_accepting_form_input_with_validation_CO7-2"><img alt="2" src="assets/2.png"/></a><code>
            </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">p</code><code class="p">&gt;</code><code>
        </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code><code>
    </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code><code>
</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code><code>

@code { </code><a class="co" href="#callout_accepting_form_input_with_validation_CO7-3" id="co_accepting_form_input_with_validation_CO7-3"><img alt="3" src="assets/3.png"/></a><code>
    [Parameter]
    public string? LabelSpecifierClass { get; set; } = "is-normal";

    [Parameter]
    public string? ControlSpecifierClass { get; set; }

    [Parameter]
    public RenderFragment? FieldLabelContent { get; set; }

    [Parameter, EditorRequired]
    public RenderFragment? FieldControlContent { get; set; }

    [Parameter]
    public string[]? ControlClasses { get; set; } = new string[]
    {
        "is-expanded", "has-icons-left"
    };
}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO7-1" id="callout_accepting_form_input_with_validation_CO7-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>FieldLabelContent</code> property is used to render <code>label</code> for the field.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO7-2" id="callout_accepting_form_input_with_validation_CO7-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>FieldControlContent</code> property is used to render <code>input</code> for the field.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO7-3" id="callout_accepting_form_input_with_validation_CO7-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The component accepts several optional and required parameters.</p></dd>
</dl>

<p class="pagebreak-before">Since the <code>label</code> and <code>input</code> elements are rendered as a <code>RenderFragment</code>, the consumer is free to render whatever they want. In the <code>Contact</code> page markup, you can see examples of <code>FieldInput</code> components <a data-primary="FieldInput.razor" data-startref="fdpur" data-type="indexterm" id="idm46365004078752"/>with the following components:</p>

<ul>
<li>
<p>Single framework-provided <code>InputText</code> component</p>
</li>
<li>
<p>Multiple framework-provided <code>InputText</code> components</p>
</li>
<li>
<p>A custom <code>AdditiveSpeechRecognitionComponent</code> component</p>
</li>
<li>
<p>Single framework-provided <code>InputCheckbox</code> component</p>
</li>
</ul>

<p>Let’s explore a few more states that the form can be rendered as.</p>

<p>In addition to <code>label</code>, icons are used to help deliver even more clarity to validation errors. Imagine the user enters the first name, forgets to enter the last name, and then provides a subject. They’re free to attempt clicking the <code>Send</code> button, but the <code>_lastNameInput</code> element will be outlined with a red border and its validity icon will change to a red cross. The
<code>_subjectInput</code> element will have its validity icon change from the question mark to a green check mark, but the <code>_messageInput</code> element will not be highlighted, as shown in <a data-type="xref" href="#contact-page-invalid-close-up">Figure 8-3</a>.</p>

<figure><div class="figure" id="contact-page-invalid-close-up">
<img alt="" src="assets/lblz_0803.png"/>
<h6><span class="label">Figure 8-3. </span>An example close-up rendering of an invalid <code>Contact</code> page</h6>
</div></figure>

<p class="pagebreak-after">The user could provide a value for the last name and a message, thus <a data-primary="validation errors, clearing" data-type="indexterm" id="idm46365004066416"/>clearing the validation errors, as shown in <a data-type="xref" href="#contact-page-valid-close-up">Figure 8-4</a>.</p>

<figure><div class="figure" id="contact-page-valid-close-up">
<img alt="" src="assets/lblz_0804.png"/>
<h6><span class="label">Figure 8-4. </span>An example close-up rendering of a valid <code>Contact</code> page</h6>
</div></figure>

<p>In Figures <a data-type="xref" data-xrefstyle="select:labelnumber" href="#contact-page-invalid-close-up">8-3</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="#contact-page-valid-close-up">8-4</a>, you may have noticed a microphone. The message input element has a button rendered in the upper-righthand corner of its bounding box. When the user clicks the button, the <code>_messageInput</code> element is temporarily disabled. This element accepts speech recognition as a form of input. The next section will show you how to <a data-primary="Contact form" data-secondary="implementing" data-startref="ctfp" data-type="indexterm" id="idm46365004059840"/><a data-primary="forms" data-secondary="Contact" data-startref="frmct" data-type="indexterm" id="idm46365004058752"/>incorporate speech recognition input into your form.</p>
</div></section>













<section data-pdf-bookmark="Implementing Speech Recognition as User Input" data-type="sect1"><div class="sect1" id="idm46365006311680">
<h1>Implementing Speech Recognition as User Input</h1>

<p>Speech recognition is a commonly used <a data-primary="speech recognition" data-secondary="implementing" data-type="indexterm" id="spgp"/>input mechanism in modern apps, both for accessibility and overall convenience. More than 90% of web browsers support the speech recognition API, according to the <a href="https://oreil.ly/qhqjt">“Can I Use <em>Speech Recognition</em>?” web page</a>. The speech recognition API allows web developers to acquire a transcript from a recognition session from the user’s voice as input. The API is supported by all modern browsers, including Chrome, Firefox, Safari, and Edge.</p>

<p>To make it so that the user can use speech recognition to input text in the message field of a form, you need to rely on the browser’s native speech recognition API. This requires JavaScript interop. To use this API, you could either write your own implementation to interface with the native API or use a library that contains this logic. I maintain a <a data-primary="ISpeechRecognitionService" data-type="indexterm" id="idm46365004053344"/><a data-primary="Razor" data-secondary="class libraries" data-type="indexterm" id="idm46365004052736"/>Razor class library that provides an <code>ISpeech​Recog⁠nitionService</code> implementation that’s published on NuGet as <a href="https://oreil.ly/UpI60"><code>Blazor.Speech​Recog⁠nition.WebAssem⁠bly</code></a>. This library exposes this type through DI, allowing consumers to call 
<span class="keep-together"><code>.AddSpeechRecognitionServices</code></span> on the <code>IServiceCollection</code> type. Once the services are registered, you can consume this interface. This is an abstraction over the speech recognition API, and it uses Blazor JavaScript interop. It’s a good example of how you can create a reusable Razor class library.</p>

<p>Blazor class libraries let <a data-primary="class libraries, component writing" data-type="indexterm" id="idm46365004049232"/><a data-primary="components" data-secondary="writing, class libraries" data-type="indexterm" id="idm46365004048208"/>you write components, effectively sharing common markup, logic, and even static assets. Static assets are typically <a data-primary="wwwroot folder" data-type="indexterm" id="idm46365004047104"/>in the <em>wwwroot</em> folder in ASP.NET Core apps. The <code>Blazor.SpeechRecognition.WebAssembly</code> library <a data-primary="Blazor.SpeechRecognition.WebAssembly library" data-type="indexterm" id="idm46365004045600"/><a data-primary="speech recognition" data-secondary="Blazor.SpeechRecognition.WebAssembly library" data-type="indexterm" id="idm46365004044992"/>defines a bit of JavaScript code in the <em>wwwroot</em>. Let’s take a look at the <em>blazorators.speech​Recog⁠nition.js</em> JavaScript <a data-primary="blazorators.speechRecognition.js" data-type="indexterm" id="bzprg"/>file that exposes the <code>speechSynthesis</code> functionality:</p>

<pre data-code-language="javascript" data-type="programlisting"><code class="kd">let</code><code> </code><code class="nx">_recognition</code><code> </code><code class="o">=</code><code> </code><code class="kc">null</code><code class="p">;</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO8-1" id="co_accepting_form_input_with_validation_CO8-1"><img alt="1" src="assets/1.png"/></a><code>

</code><code class="cm">/**
 * Cancels any active speech recognition session,
 * considered best practice to properly clean up.
 * @param {boolean} isAborted
 */</code><code>
</code><code class="kr">export</code><code> </code><code class="kr">const</code><code> </code><code class="nx">cancelSpeechRecognition</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="nx">isAborted</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO8-2" id="co_accepting_form_input_with_validation_CO8-2"><img alt="2" src="assets/2.png"/></a><code>
    </code><code class="k">if</code><code> </code><code class="p">(</code><code class="nx">_recognition</code><code> </code><code class="o">!==</code><code> </code><code class="kc">null</code><code class="p">)</code><code> </code><code class="p">{</code><code>
        </code><code class="k">if</code><code> </code><code class="p">(</code><code class="nx">isAborted</code><code class="p">)</code><code> </code><code class="p">{</code><code>
            </code><code class="nx">_recognition</code><code class="p">.</code><code class="nx">abort</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
        </code><code class="p">}</code><code> </code><code class="k">else</code><code> </code><code class="p">{</code><code>
            </code><code class="nx">_recognition</code><code class="p">.</code><code class="nx">stop</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
        </code><code class="p">}</code><code>
        </code><code class="nx">_recognition</code><code> </code><code class="o">=</code><code> </code><code class="kc">null</code><code class="p">;</code><code>
    </code><code class="p">}</code><code>
</code><code class="p">}</code><code class="p">;</code><code>

</code><code class="cm">/**
 * Starts recognizing speech in the browser and registers
 * all the callbacks for the given dotnetObj in context.
 * @param {any} dotnetObj
 * @param {string} lang The BCP47 tag for the language.
 * @param {string} key Used for round-trip verification and callback-receipts.
 * @param {string} onResultMethodName Incremental recognition results callback.
 * @param {string | null} onErrorMethodName Recognition error callback.
 * @param {string | null} onStartMethodName Recognition started callback.
 * @param {string | null} onEndMethodName Recognition ended callback.
 */</code><code>
</code><code class="kr">export</code><code> </code><code class="kr">const</code><code> </code><code class="nx">recognizeSpeech</code><code> </code><code class="o">=</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO8-3" id="co_accepting_form_input_with_validation_CO8-3"><img alt="3" src="assets/3.png"/></a><code>
    </code><code class="p">(</code><code class="nx">dotnetObj</code><code class="p">,</code><code> </code><code class="nx">lang</code><code class="p">,</code><code> </code><code class="nx">key</code><code class="p">,</code><code> </code><code class="nx">onResultMethodName</code><code class="p">,</code><code>
        </code><code class="nx">onErrorMethodName</code><code class="p">,</code><code> </code><code class="nx">onStartMethodName</code><code class="p">,</code><code> </code><code class="nx">onEndMethodName</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code>
        </code><code class="k">if</code><code> </code><code class="p">(</code><code class="o">!</code><code class="nx">dotnetObj</code><code> </code><code class="o">||</code><code> </code><code class="o">!</code><code class="nx">onResultMethodName</code><code class="p">)</code><code> </code><code class="p">{</code><code>
            </code><code class="k">return</code><code class="p">;</code><code>
        </code><code class="p">}</code><code>

        </code><code class="nx">cancelSpeechRecognition</code><code class="p">(</code><code class="kc">true</code><code class="p">)</code><code class="p">;</code><code>

        </code><code class="nx">_recognition</code><code> </code><code class="o">=</code><code>
            </code><code class="k">new</code><code> </code><code class="nx">webkitSpeechRecognition</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">||</code><code> </code><code class="k">new</code><code> </code><code class="nx">SpeechRecognition</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
        </code><code class="nx">_recognition</code><code class="p">.</code><code class="nx">continuous</code><code> </code><code class="o">=</code><code> </code><code class="kc">true</code><code class="p">;</code><code>
        </code><code class="nx">_recognition</code><code class="p">.</code><code class="nx">interimResults</code><code> </code><code class="o">=</code><code> </code><code class="kc">true</code><code class="p">;</code><code>
        </code><code class="nx">_recognition</code><code class="p">.</code><code class="nx">lang</code><code> </code><code class="o">=</code><code> </code><code class="nx">lang</code><code class="p">;</code><code>

        </code><code class="k">if</code><code> </code><code class="p">(</code><code class="nx">onStartMethodName</code><code class="p">)</code><code> </code><code class="p">{</code><code>
            </code><code class="nx">_recognition</code><code class="p">.</code><code class="nx">onstart</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO8-4" id="co_accepting_form_input_with_validation_CO8-4"><img alt="4" src="assets/4.png"/></a><code>
                </code><code class="nx">dotnetObj</code><code class="p">.</code><code class="nx">invokeMethod</code><code class="p">(</code><code class="nx">onStartMethodName</code><code class="p">,</code><code> </code><code class="nx">key</code><code class="p">)</code><code class="p">;</code><code>
            </code><code class="p">}</code><code class="p">;</code><code>
        </code><code class="p">}</code><code>
        </code><code class="k">if</code><code> </code><code class="p">(</code><code class="nx">onEndMethodName</code><code class="p">)</code><code> </code><code class="p">{</code><code>
            </code><code class="nx">_recognition</code><code class="p">.</code><code class="nx">onend</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code>
                </code><code class="nx">dotnetObj</code><code class="p">.</code><code class="nx">invokeMethod</code><code class="p">(</code><code class="nx">onEndMethodName</code><code class="p">,</code><code> </code><code class="nx">key</code><code class="p">)</code><code class="p">;</code><code>
            </code><code class="p">}</code><code class="p">;</code><code>
        </code><code class="p">}</code><code>
        </code><code class="k">if</code><code> </code><code class="p">(</code><code class="nx">onErrorMethodName</code><code class="p">)</code><code> </code><code class="p">{</code><code>
            </code><code class="nx">_recognition</code><code class="p">.</code><code class="nx">onerror</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="nx">error</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code>
                </code><code class="nx">dotnetObj</code><code class="p">.</code><code class="nx">invokeMethod</code><code class="p">(</code><code class="nx">onErrorMethodName</code><code class="p">,</code><code> </code><code class="nx">key</code><code class="p">,</code><code> </code><code class="nx">error</code><code class="p">)</code><code class="p">;</code><code>
            </code><code class="p">}</code><code class="p">;</code><code>
        </code><code class="p">}</code><code>
        </code><code class="nx">_recognition</code><code class="p">.</code><code class="nx">onresult</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="nx">result</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO8-5" id="co_accepting_form_input_with_validation_CO8-5"><img alt="5" src="assets/5.png"/></a><code>
            </code><code class="kd">let</code><code> </code><code class="nx">transcript</code><code> </code><code class="o">=</code><code> </code><code class="s1">''</code><code class="p">;</code><code>
            </code><code class="kd">let</code><code> </code><code class="nx">isFinal</code><code> </code><code class="o">=</code><code> </code><code class="kc">false</code><code class="p">;</code><code>
            </code><code class="k">for</code><code> </code><code class="p">(</code><code class="kd">let</code><code> </code><code class="nx">i</code><code> </code><code class="o">=</code><code> </code><code class="nx">result</code><code class="p">.</code><code class="nx">resultIndex</code><code class="p">;</code><code> </code><code class="nx">i</code><code> </code><code class="o">&lt;</code><code> </code><code class="nx">result</code><code class="p">.</code><code class="nx">results</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code><code> </code><code class="o">++</code><code class="nx">i</code><code class="p">)</code><code> </code><code class="p">{</code><code>
                </code><code class="nx">transcript</code><code> </code><code class="o">+=</code><code> </code><code class="nx">result</code><code class="p">.</code><code class="nx">results</code><code class="p">[</code><code class="nx">i</code><code class="p">]</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="p">.</code><code class="nx">transcript</code><code class="p">;</code><code>
                </code><code class="k">if</code><code> </code><code class="p">(</code><code class="nx">result</code><code class="p">.</code><code class="nx">results</code><code class="p">[</code><code class="nx">i</code><code class="p">]</code><code class="p">.</code><code class="nx">isFinal</code><code class="p">)</code><code> </code><code class="p">{</code><code>
                    </code><code class="nx">isFinal</code><code> </code><code class="o">=</code><code> </code><code class="kc">true</code><code class="p">;</code><code>
                </code><code class="p">}</code><code>
            </code><code class="p">}</code><code>
            </code><code class="k">if</code><code> </code><code class="p">(</code><code class="nx">isFinal</code><code class="p">)</code><code> </code><code class="p">{</code><code>
                </code><code class="kr">const</code><code> </code><code class="nx">punctuation</code><code> </code><code class="o">=</code><code> </code><code class="nx">transcript</code><code class="p">.</code><code class="nx">endsWith</code><code class="p">(</code><code class="s1">'.'</code><code class="p">)</code><code> </code><code class="o">?</code><code> </code><code class="s1">''</code><code> </code><code class="o">:</code><code> </code><code class="s1">'.'</code><code class="p">;</code><code>
                </code><code class="kr">const</code><code> </code><code class="nx">replaced</code><code> </code><code class="o">=</code><code>
                    </code><code class="nx">transcript</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/\S/</code><code class="p">,</code><code> </code><code class="nx">str</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">str</code><code class="p">.</code><code class="nx">toLocaleUpperCase</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
                </code><code class="nx">transcript</code><code> </code><code class="o">=</code><code>
                    </code><code class="sb">`</code><code class="si">${</code><code class="nx">replaced</code><code class="si">}</code><code class="si">${</code><code class="nx">punctuation</code><code class="si">}</code><code class="sb">`</code><code class="p">;</code><code>
            </code><code class="p">}</code><code>
            </code><code class="nx">dotnetObj</code><code class="p">.</code><code class="nx">invokeMethod</code><code class="p">(</code><code>
                </code><code class="nx">onResultMethodName</code><code class="p">,</code><code> </code><code class="nx">key</code><code class="p">,</code><code> </code><code class="nx">transcript</code><code class="p">,</code><code> </code><code class="nx">isFinal</code><code class="p">)</code><code class="p">;</code><code>
        </code><code class="p">}</code><code class="p">;</code><code>
        </code><code class="nx">_recognition</code><code class="p">.</code><code class="nx">start</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
    </code><code class="p">}</code><code class="p">;</code><code>

</code><code class="nb">window</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'beforeunload'</code><code class="p">,</code><code> </code><code class="nx">_</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO8-6" id="co_accepting_form_input_with_validation_CO8-6"><img alt="6" src="assets/6.png"/></a><code>
    </code><code class="nx">cancelSpeechRecognition</code><code class="p">(</code><code class="kc">true</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="p">}</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO8-1" id="callout_accepting_form_input_with_validation_CO8-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>_recognition</code> variable is used to store <a data-primary="SpeechRecognition, storage" data-type="indexterm" id="idm46365003841088"/>the current <code>SpeechRecognition</code> instance globally.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO8-2" id="callout_accepting_form_input_with_validation_CO8-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>cancelSpeechRecognition</code> method is used to cancel the current speech recognition session.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO8-3" id="callout_accepting_form_input_with_validation_CO8-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>recognizeSpeech</code> method is used to start the speech recognition session.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO8-4" id="callout_accepting_form_input_with_validation_CO8-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The <code>_recognition</code> instance has several callbacks, each of which is registered.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO8-5" id="callout_accepting_form_input_with_validation_CO8-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>The <code>_recognition.onresult</code> callback is used to send the results back to the client.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO8-6" id="callout_accepting_form_input_with_validation_CO8-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>The <code>window.addEventListener</code> method aborts any active speech recognition session.</p></dd>
</dl>

<p>Although we’ve used JavaScript for other functionality in this book, this one’s different because the functions defined <a data-primary="export keyword" data-type="indexterm" id="idm46365003594288"/>here use the <code>export</code> keyword. The <code>export</code> JavaScript keyword allows you to export a function or variable as an <code>import</code>-able code from another module. This is a very common JavaScript feature, and it’s used to make your code more sharable and readable and easier to maintain. Blazor can <code>import</code> these functions into .NET via JavaScript interop calls to <code>import</code> and a path to a JavaScript module. Modules simply <code>export</code> their desired functionality, and other modules consume it. In .NET, this module is represented as the framework-provided <code>IJSInProcessObjectReference</code> type. For more information about JavaScript isolation, see Microsoft’s <a href="https://oreil.ly/0nf9D">“Call JavaScript Functions from .NET Methods in ASP.NET Core Blazor” documentation</a>.</p>

<p>The two functions of this JavaScript file are <code>cancelSpeechRecognition</code> and 
<span class="keep-together"><code>recognizeSpeech</code></span>. The primary function is <code>recognizeSpeech</code> as it conditionally registers all of the <a data-primary="blazorators.speechRecognition.js" data-startref="bzprg" data-type="indexterm" id="idm46365003497696"/>provided callbacks when they’re able to be handled. It’s responsible for instantiating a <code>SpeechRecognition</code> instance and assigning it to the global 
<span class="keep-together"><code>_recognition</code></span> variable of the JavaScript code. Next, we’ll look at the <code>ISpeech​Rec⁠ogni⁠tionService</code> interface. It’s defined <a data-primary="ISpeechRecognitionService.cs" data-type="indexterm" id="spgv"/>in the <em>ISpeechRecognitionService.cs</em> C# file:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code><code> </code><code class="nn">Microsoft.JSInterop</code><code class="p">;</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO9-1" id="co_accepting_form_input_with_validation_CO9-1"><img alt="1" src="assets/1.png"/></a><code>
</code><code>
</code><code class="k">public</code><code> </code><code class="k">interface</code><code> </code><code class="n">ISpeechRecognitionService</code><code> </code><code class="p">:</code><code> </code><code class="n">IAsyncDisposable</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO9-2" id="co_accepting_form_input_with_validation_CO9-2"><img alt="2" src="assets/2.png"/></a><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="n">Task</code><code> </code><code class="nf">InitializeModuleAsync</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO9-3" id="co_accepting_form_input_with_validation_CO9-3"><img alt="3" src="assets/3.png"/></a><code>
</code><code>
</code><code>    </code><code class="k">void</code><code> </code><code class="nf">CancelSpeechRecognition</code><code class="p">(</code><code class="kt">bool</code><code> </code><code class="n">isAborted</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO9-4" id="co_accepting_form_input_with_validation_CO9-4"><img alt="4" src="assets/4.png"/></a><code>
</code><code>
</code><code>    </code><code class="n">IDisposable</code><code> </code><code class="nf">RecognizeSpeech</code><code class="p">(</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO9-5" id="co_accepting_form_input_with_validation_CO9-5"><img alt="5" src="assets/5.png"/></a><code>
</code><code>        </code><code class="kt">string</code><code> </code><code class="n">language</code><code class="p">,</code><code>
</code><code>        </code><code class="n">Action</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code><code> </code><code class="n">onRecognized</code><code class="p">,</code><code>
</code><code>        </code><code class="n">Action</code><code class="p">&lt;</code><code class="n">SpeechRecognitionErrorEvent</code><code class="p">&gt;</code><code class="p">?</code><code> </code><code class="n">onError</code><code> </code><code class="p">=</code><code> </code><code class="k">null</code><code class="p">,</code><code>
</code><code>        </code><code class="n">Action</code><code class="p">?</code><code> </code><code class="n">onStarted</code><code> </code><code class="p">=</code><code> </code><code class="k">null</code><code class="p">,</code><code>
</code><code>        </code><code class="n">Action</code><code class="p">?</code><code> </code><code class="n">onEnded</code><code> </code><code class="p">=</code><code> </code><code class="k">null</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO9-1" id="callout_accepting_form_input_with_validation_CO9-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The interface declares itself in the <code>Microsoft.JSInterop</code> namespace as a 
<span class="keep-together">convenience.</span></p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO9-2" id="callout_accepting_form_input_with_validation_CO9-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>ISpeechRecognitionService</code> interface is used to define the public <code>Speech​Re⁠cognition</code> API.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO9-3" id="callout_accepting_form_input_with_validation_CO9-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>InitializeModuleAsync</code> method is used to initialize the speech recognition module.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO9-4" id="callout_accepting_form_input_with_validation_CO9-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The <code>CancelSpeechRecognition</code> method is used to cancel the speech recognition session.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO9-5" id="callout_accepting_form_input_with_validation_CO9-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>The <code>RecognizeSpeech</code> method is used to start the speech recognition session.</p></dd>
</dl>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>Declaring a type in someone else’s namespace (such as 
<span class="keep-together"><code>Microsoft.JSInterop</code></span>) should <a data-primary="namespaces" data-secondary="type declaration" data-type="indexterm" id="idm46365003346416"/><a data-primary="type declaration, namespaces" data-type="indexterm" id="idm46365003345568"/>not be overused. This practice is typically not publicly recommended, but it’s used here to make the library more accessible to developers. In this way, as developers opt in to using this NuGet package, where their apps are already making use of <code>Microsoft.JSInterop</code>, they can also use the <code>SpeechRecognition</code> API.</p>
</div>

<p>This interface inherits <code>IAsyncDisposable</code>, and its <code>DisposeAsync</code> call will perform the necessary cleanup of the captured <a data-primary="ISpeechRecognitionService.cs" data-startref="spgv" data-type="indexterm" id="idm46365003342560"/><a data-primary="IAsyncDisposable" data-type="indexterm" id="idm46365003341712"/><a data-primary="DisposeAsync" data-type="indexterm" id="idm46365003341104"/>module reference. The <code>ISpeechRecognitionService</code> interface is small, so it’s a good candidate for simple unit testing, which is discussed in <a data-type="xref" href="ch09.html#chapter-nine">Chapter 9</a>. This makes it easy to perform unit tests on the logic surrounding the speech recognition module. Next, we’ll look at the <code>DefaultSpeech​Re⁠cognitionService</code> class. It’s defined <a data-primary="DefaultSpeechRecognitionService.cs" data-type="indexterm" id="dscgv"/>in the <em>DefaultSpeechRecognitionService.cs</em> C# file:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code><code> </code><code class="nn">Microsoft.JSInterop</code><code class="p">;</code><code>
</code><code>
</code><code class="k">internal</code><code> </code><code class="k">sealed</code><code> </code><code class="k">class</code><code> </code><code class="nc">DefaultSpeechRecognitionService</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO10-1" id="co_accepting_form_input_with_validation_CO10-1"><img alt="1" src="assets/1.png"/></a><code>
</code><code>    </code><code class="p">:</code><code> </code><code class="n">ISpeechRecognitionService</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">const</code><code> </code><code class="kt">string</code><code> </code><code class="n">ContentFolder</code><code> </code><code class="p">=</code><code> </code><code class="s">"_content"</code><code class="p">;</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO10-2" id="co_accepting_form_input_with_validation_CO10-2"><img alt="2" src="assets/2.png"/></a><code>
</code><code>    </code><code class="k">const</code><code> </code><code class="kt">string</code><code> </code><code class="n">Package</code><code> </code><code class="p">=</code><code> </code><code class="s">"Blazor.SpeechRecognition.WebAssembly"</code><code class="p">;</code><code>
</code><code>    </code><code class="k">const</code><code> </code><code class="kt">string</code><code> </code><code class="n">Module</code><code> </code><code class="p">=</code><code> </code><code class="s">"blazorators.speechRecognition.js"</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">readonly</code><code> </code><code class="n">IJSInProcessRuntime</code><code> </code><code class="n">_javaScript</code><code class="p">;</code><code>
</code><code>    </code><code class="k">readonly</code><code> </code><code class="n">SpeechRecognitionCallbackRegistry</code><code> </code><code class="n">_callbackRegistry</code><code> </code><code class="p">=</code><code> </code><code class="k">new</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="n">IJSInProcessObjectReference</code><code class="p">?</code><code> </code><code class="n">_speechRecognitionModule</code><code class="p">;</code><code>
</code><code>    </code><code class="n">SpeechRecognitionSubject</code><code class="p">?</code><code> </code><code class="n">_speechRecognition</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="nf">DefaultSpeechRecognitionService</code><code class="p">(</code><code>
</code><code>        </code><code class="n">IJSInProcessRuntime</code><code> </code><code class="n">javaScript</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">_javaScript</code><code> </code><code class="p">=</code><code> </code><code class="n">javaScript</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">void</code><code> </code><code class="nf">InitializeSpeechRecognitionSubject</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="p">(</code><code class="n">_speechRecognition</code><code> </code><code class="k">is</code><code> </code><code class="n">not</code><code> </code><code class="k">null</code><code class="p">)</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO10-3" id="co_accepting_form_input_with_validation_CO10-3"><img alt="3" src="assets/3.png"/></a><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="n">CancelSpeechRecognition</code><code class="p">(</code><code class="k">false</code><code class="p">)</code><code class="p">;</code><code>
</code><code>            </code><code class="n">_speechRecognition</code><code class="p">.</code><code class="n">Dispose</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>
</code><code>        </code><code class="n">_speechRecognition</code><code> </code><code class="p">=</code><code> </code><code class="n">SpeechRecognitionSubject</code><code class="p">.</code><code class="n">Factory</code><code class="p">(</code><code>
</code><code>            </code><code class="n">_callbackRegistry</code><code class="p">.</code><code class="n">InvokeOnRecognized</code><code class="p">)</code><code class="p">;</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code>
</code><code>    </code><code class="c1">/// &lt;inheritdoc /&gt;
</code><code>    </code><code class="k">public</code><code> </code><code class="k">async</code><code> </code><code class="n">Task</code><code> </code><code class="nf">InitializeModuleAsync</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO10-4" id="co_accepting_form_input_with_validation_CO10-4"><img alt="4" src="assets/4.png"/></a><code>
</code><code>        </code><code class="n">_speechRecognitionModule</code><code> </code><code class="p">=</code><code>
</code><code>            </code><code class="k">await</code><code> </code><code class="n">_javaScript</code><code class="p">.</code><code class="n">InvokeAsync</code><code class="p">&lt;</code><code class="n">IJSInProcessObjectReference</code><code class="p">&gt;</code><code class="p">(</code><code>
</code><code>                </code><code class="s">"import"</code><code class="p">,</code><code>
</code><code>                </code><code class="err">$</code><code class="s">"./{ContentFolder}/{Package}/{Module}"</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="c1">/// &lt;inheritdoc /&gt;
</code><code>    </code><code class="k">public</code><code> </code><code class="k">void</code><code> </code><code class="nf">CancelSpeechRecognition</code><code class="p">(</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO10-5" id="co_accepting_form_input_with_validation_CO10-5"><img alt="5" src="assets/5.png"/></a><code>
</code><code>        </code><code class="kt">bool</code><code> </code><code class="n">isAborted</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">_speechRecognitionModule</code><code class="p">?</code><code class="p">.</code><code class="n">InvokeVoid</code><code class="p">(</code><code>
</code><code>            </code><code class="s">"cancelSpeechRecognition"</code><code class="p">,</code><code>
</code><code>            </code><code class="n">isAborted</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="c1">/// &lt;inheritdoc /&gt;
</code><code>    </code><code class="k">public</code><code> </code><code class="n">IDisposable</code><code> </code><code class="nf">RecognizeSpeech</code><code class="p">(</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO10-6" id="co_accepting_form_input_with_validation_CO10-6"><img alt="6" src="assets/6.png"/></a><code>
</code><code>        </code><code class="kt">string</code><code> </code><code class="n">language</code><code class="p">,</code><code>
</code><code>        </code><code class="n">Action</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code><code> </code><code class="n">onRecognized</code><code class="p">,</code><code>
</code><code>        </code><code class="n">Action</code><code class="p">&lt;</code><code class="n">SpeechRecognitionErrorEvent</code><code class="p">&gt;</code><code class="p">?</code><code> </code><code class="n">onError</code><code class="p">,</code><code>
</code><code>        </code><code class="n">Action</code><code class="p">?</code><code> </code><code class="n">onStarted</code><code class="p">,</code><code>
</code><code>        </code><code class="n">Action</code><code class="p">?</code><code> </code><code class="n">onEnded</code><code class="p">)</code><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="n">InitializeSpeechRecognitionSubject</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="kt">var</code><code> </code><code class="n">key</code><code> </code><code class="p">=</code><code> </code><code class="n">Guid</code><code class="p">.</code><code class="n">NewGuid</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="n">_callbackRegistry</code><code class="p">.</code><code class="n">RegisterOnRecognized</code><code class="p">(</code><code class="n">key</code><code class="p">,</code><code> </code><code class="n">onRecognized</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="p">(</code><code class="n">onError</code><code> </code><code class="k">is</code><code> </code><code class="n">not</code><code> </code><code class="k">null</code><code class="p">)</code><code>
</code><code>            </code><code class="n">_callbackRegistry</code><code class="p">.</code><code class="n">RegisterOnError</code><code class="p">(</code><code class="n">key</code><code class="p">,</code><code> </code><code class="n">onError</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="p">(</code><code class="n">onStarted</code><code> </code><code class="k">is</code><code> </code><code class="n">not</code><code> </code><code class="k">null</code><code class="p">)</code><code>
</code><code>            </code><code class="n">_callbackRegistry</code><code class="p">.</code><code class="n">RegisterOnStarted</code><code class="p">(</code><code class="n">key</code><code class="p">,</code><code> </code><code class="n">onStarted</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="p">(</code><code class="n">onEnded</code><code> </code><code class="k">is</code><code> </code><code class="n">not</code><code> </code><code class="k">null</code><code class="p">)</code><code>
</code><code>            </code><code class="n">_callbackRegistry</code><code class="p">.</code><code class="n">RegisterOnEnded</code><code class="p">(</code><code class="n">key</code><code class="p">,</code><code> </code><code class="n">onEnded</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="n">_speechRecognitionModule</code><code class="p">?</code><code class="p">.</code><code class="n">InvokeVoid</code><code class="p">(</code><code>
</code><code>            </code><code class="s">"recognizeSpeech"</code><code class="p">,</code><code>
</code><code>            </code><code class="n">DotNetObjectReference</code><code class="p">.</code><code class="n">Create</code><code class="p">(</code><code class="k">this</code><code class="p">)</code><code class="p">,</code><code>
</code><code>            </code><code class="n">language</code><code class="p">,</code><code>
</code><code>            </code><code class="n">key</code><code class="p">,</code><code>
</code><code>            </code><code class="n">nameof</code><code class="p">(</code><code class="n">OnSpeechRecognized</code><code class="p">)</code><code class="p">,</code><code>
</code><code>            </code><code class="n">nameof</code><code class="p">(</code><code class="n">OnRecognitionError</code><code class="p">)</code><code class="p">,</code><code>
</code><code>            </code><code class="n">nameof</code><code class="p">(</code><code class="n">OnStarted</code><code class="p">)</code><code class="p">,</code><code>
</code><code>            </code><code class="n">nameof</code><code class="p">(</code><code class="n">OnEnded</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">_speechRecognition</code><code class="p">!</code><code class="p">;</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code class="na">
    [JSInvokable]</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="k">void</code><code> </code><code class="nf">OnStarted</code><code class="p">(</code><code class="kt">string</code><code> </code><code class="n">key</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO10-7" id="co_accepting_form_input_with_validation_CO10-7"><img alt="7" src="assets/7.png"/></a><code>
</code><code>        </code><code class="n">_callbackRegistry</code><code class="p">.</code><code class="n">InvokeOnStarted</code><code class="p">(</code><code class="n">key</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="na">
    [JSInvokable]</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="k">void</code><code> </code><code class="nf">OnEnded</code><code class="p">(</code><code class="kt">string</code><code> </code><code class="n">key</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">_callbackRegistry</code><code class="p">.</code><code class="n">InvokeOnEnded</code><code class="p">(</code><code class="n">key</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="na">
    [JSInvokable]</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="k">void</code><code> </code><code class="nf">OnRecognitionError</code><code class="p">(</code><code>
</code><code>        </code><code class="kt">string</code><code> </code><code class="n">key</code><code class="p">,</code><code> </code><code class="n">SpeechRecognitionErrorEvent</code><code> </code><code class="n">errorEvent</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">_callbackRegistry</code><code class="p">.</code><code class="n">InvokeOnError</code><code class="p">(</code><code class="n">key</code><code class="p">,</code><code> </code><code class="n">errorEvent</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="na">
    [JSInvokable]</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="k">void</code><code> </code><code class="nf">OnSpeechRecognized</code><code class="p">(</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO10-8" id="co_accepting_form_input_with_validation_CO10-8"><img alt="8" src="assets/8.png"/></a><code>
</code><code>        </code><code class="kt">string</code><code> </code><code class="n">key</code><code class="p">,</code><code> </code><code class="kt">string</code><code> </code><code class="n">transcript</code><code class="p">,</code><code> </code><code class="kt">bool</code><code> </code><code class="n">isFinal</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">_speechRecognition</code><code class="p">?</code><code class="p">.</code><code class="n">RecognitionReceived</code><code class="p">(</code><code>
</code><code>            </code><code class="k">new</code><code> </code><code class="nf">SpeechRecognitionResult</code><code class="p">(</code><code class="n">key</code><code class="p">,</code><code> </code><code class="n">transcript</code><code class="p">,</code><code> </code><code class="n">isFinal</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">async</code><code> </code><code class="n">ValueTask</code><code> </code><code class="n">IAsyncDisposable</code><code class="p">.</code><code class="n">DisposeAsync</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="n">_speechRecognition</code><code class="p">?</code><code class="p">.</code><code class="n">Dispose</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="n">_speechRecognition</code><code> </code><code class="p">=</code><code> </code><code class="k">null</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="p">(</code><code class="n">_speechRecognitionModule</code><code> </code><code class="k">is</code><code> </code><code class="n">not</code><code> </code><code class="k">null</code><code class="p">)</code><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="k">await</code><code> </code><code class="n">_speechRecognitionModule</code><code class="p">.</code><code class="n">DisposeAsync</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>            </code><code class="n">_speechRecognitionModule</code><code> </code><code class="p">=</code><code> </code><code class="k">null</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO10-1" id="callout_accepting_form_input_with_validation_CO10-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>DefaultSpeechRecognitionService</code> class <a data-primary="DefaultSpeechRecognitionService class" data-type="indexterm" id="idm46365002964144"/>is both <code>sealed</code> and <code>internal</code>.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO10-2" id="callout_accepting_form_input_with_validation_CO10-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>There are several fields required for this implementation besides the <code>const string</code> fields—two framework-provided types (<code>IJSInProcessRuntime</code> and <code>IJSInProcessObjectReference</code>) and two custom types (<code>SpeechRecognitionCallbackRegistry</code> and <code>SpeechRecognitionSubject</code>).</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO10-3" id="callout_accepting_form_input_with_validation_CO10-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p><code>InitializeSpeechRecognitionSubject</code> creates the speech recognition subject. If it already exists, the existing speech recognition session is canceled.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO10-4" id="callout_accepting_form_input_with_validation_CO10-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The <code>InitializeModuleAsync</code> method is used to initialize the speech recognition module.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO10-5" id="callout_accepting_form_input_with_validation_CO10-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>The <code>CancelSpeechRecognition</code> method is used to cancel the speech recognition session.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO10-6" id="callout_accepting_form_input_with_validation_CO10-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>The <code>RecognizeSpeech</code> method is used to start the speech recognition session.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO10-7" id="callout_accepting_form_input_with_validation_CO10-7"><img alt="7" src="assets/7.png"/></a></dt>
<dd><p>The <code>OnStarted</code> method is used to invoke the <code>onStarted</code> callback.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO10-8" id="callout_accepting_form_input_with_validation_CO10-8"><img alt="8" src="assets/8.png"/></a></dt>
<dd><p>The <code>OnSpeechRecognized</code> method is <a data-primary="DefaultSpeechRecognitionService.cs" data-startref="dscgv" data-type="indexterm" id="idm46365002821248"/>used to invoke the <code>onRecognized</code> callback.</p></dd>
</dl>

<p>The <code>InitializeModuleAsync</code> method <a data-primary="InitializeModuleAsync method" data-type="indexterm" id="idm46365002795568"/><a data-primary="methods" data-secondary="InitializeModuleAsync" data-type="indexterm" id="idm46365002794816"/>is required to be called before any other call. This ensures that the <code>_speechRecognitionModule</code> field is initialized. The <code>Cancel​Spee⁠chRecognition</code> method is used to cancel the speech recognition session. The 
<span class="keep-together"><code>RecognizeSpeech</code></span> method is used to start the speech recognition session. When the speech recognition session is started, the <code>_speechRecognition</code> field is initialized. An invocation key is created (<code>Guid.NewGuid()</code>), and this is passed from .NET into the JavaScript interop calls. The calling JavaScript then uses the given <code>key</code> when it invokes its callbacks. This is then used to ensure that callbacks are removed from the <code>_callbackRegistry</code> once they’re called. The <code>OnStarted</code>, <code>OnEnded</code>, and 
<span class="keep-together"><code>OnRecognitionError</code></span> methods are used to invoke the corresponding callbacks. The 
<span class="keep-together"><code>OnSpeechRecognized</code></span> is different, as it instead pushes the given <code>transcript</code> and <code>isFinal</code> values into the <code>SpeechRecognitionResult</code> object and calls the <code>Recognition​Received</code> method on the <code>_speechRecognition</code> field.</p>

<p>The <code>_speechRecognition</code> field is a <code>SpeechRecognitionSubject</code> type. This custom type wraps a bit of reactive code and provides an encapsulated observer and observable pair. In the next section, I’ll explain how ReactiveX (Reactive Extensions) are used to create the <code>SpeechRecognitionSubject</code> type.</p>








<section data-pdf-bookmark="Reactive Programming with the Observer Pattern" data-type="sect2"><div class="sect2" id="idm46365002918048">
<h2>Reactive Programming with the Observer Pattern</h2>

<p>Unlike the <code>OnStarted</code>, <code>OnEnded</code>, and <code>OnRecognitionError</code> events, the <code>OnSpeech​Recog⁠nized</code> event triggers many times. This is because the JavaScript speech recognition <a data-primary="OnSpeechRecognized event" data-type="indexterm" id="idm46365002885712"/><a data-primary="events" data-secondary="OnSpeechRecognized" data-type="indexterm" id="idm46365002884976"/>code sets the <code>continuous</code> flag to <code>true</code> when the speech recognition session is started. The JavaScript code will invoke the <code>onRecognized</code> callback multiple times, with the <code>isFinal</code> flag set to <code>false</code> for each invocation. When intermediate recognition results are available, a final recognition result is still only intermittent. When final, it’s a complete thought or sentence. The speech recognition service will continue to listen until either an error occurs or a cancellation is requested. We’ll use reactive programming, which relies on asynchronous programming logic to handle real-time updates to otherwise static content. As the speech recognition service fires, our app will observe each occurrence of the event and take appropriate action.</p>

<p><a href="https://reactivex.io">ReactiveX (or Reactive Extensions)</a> is an API for asynchronous <a data-primary="ReactiveX API" data-type="indexterm" id="idm46365002868896"/><a data-primary="API (application programming interface)" data-secondary="ReactiveX" data-type="indexterm" id="idm46365002747936"/>programming with observable streams. ReactiveX is an implementation of the <em>observer pattern</em>.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46365002746288">
<h5>The Observer Pattern</h5>
<p>The observer pattern allows some <a data-primary="observer pattern" data-type="indexterm" id="idm46365002744928"/><a data-primary="patterns" data-secondary="observer" data-type="indexterm" id="idm46365002744224"/>objects to notify other objects about their state change. This pattern provides a way to subscribe and unsubscribe to and from these events for any object that implements a subscriber interface. The observer pattern is used to implement the <code>SpeechRecognitionSubject</code> type, which relies on 
<span class="keep-together">Reactive</span> Extensions. For more information about this pattern, see Microsoft’s <a href="https://oreil.ly/DnKMR">“Observer Design Pattern” documentation</a>.</p>
</div></aside>

<p>The .NET implementation of Reactive <a data-primary="Reactive Extensions, Rx.NET" data-type="indexterm" id="idm46365002896656"/><a data-primary="Rx.NET, Reactive Extensions" data-type="indexterm" id="idm46365002895888"/>Extensions is known as Rx.NET. Within this library, a <code>Subject</code> type represents an object that is both an observable sequence and an observer. In the case of speech recognition, the <code>SpeechRecognition​Sub⁠ject</code> type observes <a data-primary="SpeechRecognitionSubject.cs" data-type="indexterm" id="spgj"/>a stream of <code>SpeechRecognitionResult</code> objects. Consider the <em>Speech​Recogni⁠tionSubject.cs</em> C# file:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code><code> </code><code class="nn">Microsoft.JSInterop</code><code class="p">;</code><code>
</code><code>
</code><code class="k">internal</code><code> </code><code class="k">sealed</code><code> </code><code class="k">class</code><code> </code><code class="nc">SpeechRecognitionSubject</code><code> </code><code class="p">:</code><code> </code><code class="n">IDisposable</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO11-1" id="co_accepting_form_input_with_validation_CO11-1"><img alt="1" src="assets/1.png"/></a><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">readonly</code><code> </code><code class="n">Subject</code><code class="p">&lt;</code><code class="n">SpeechRecognitionResult</code><code class="p">&gt;</code><code> </code><code class="n">_speechRecognitionSubject</code><code> </code><code class="p">=</code><code> </code><code class="k">new</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>    </code><code class="k">readonly</code><code> </code><code class="n">IObservable</code><code class="p">&lt;</code><code class="p">(</code><code class="kt">string</code><code class="p">,</code><code> </code><code class="kt">string</code><code class="p">)</code><code class="p">&gt;</code><code> </code><code class="n">_speechRecognitionObservable</code><code class="p">;</code><code>
</code><code>    </code><code class="k">readonly</code><code> </code><code class="n">IDisposable</code><code> </code><code class="n">_speechRecognitionSubscription</code><code class="p">;</code><code>
</code><code>    </code><code class="k">readonly</code><code> </code><code class="n">Action</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code><code> </code><code class="kt">string</code><code class="p">&gt;</code><code> </code><code class="n">_observer</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">private</code><code> </code><code class="nf">SpeechRecognitionSubject</code><code class="p">(</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO11-2" id="co_accepting_form_input_with_validation_CO11-2"><img alt="2" src="assets/2.png"/></a><code>
</code><code>        </code><code class="n">Action</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code><code> </code><code class="kt">string</code><code class="p">&gt;</code><code> </code><code class="n">observer</code><code class="p">)</code><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="n">_observer</code><code> </code><code class="p">=</code><code> </code><code class="n">observer</code><code class="p">;</code><code>
</code><code>        </code><code class="n">_speechRecognitionObservable</code><code> </code><code class="p">=</code><code>
</code><code>            </code><code class="n">_speechRecognitionSubject</code><code class="p">.</code><code class="n">AsObservable</code><code class="p">(</code><code class="p">)</code><code>
</code><code>                </code><code class="p">.</code><code class="n">Where</code><code class="p">(</code><code class="n">r</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">r</code><code class="p">.</code><code class="n">IsFinal</code><code class="p">)</code><code>
</code><code>                </code><code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">r</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="p">(</code><code class="n">r</code><code class="p">.</code><code class="n">Key</code><code class="p">,</code><code> </code><code class="n">r</code><code class="p">.</code><code class="n">Transcript</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="n">_speechRecognitionSubscription</code><code> </code><code class="p">=</code><code>
</code><code>            </code><code class="n">_speechRecognitionObservable</code><code class="p">.</code><code class="n">Subscribe</code><code class="p">(</code><code>
</code><code>                </code><code class="p">(</code><code class="p">(</code><code class="kt">string</code><code> </code><code class="n">Key</code><code class="p">,</code><code> </code><code class="kt">string</code><code> </code><code class="n">SpeechRecognition</code><code class="p">)</code><code> </code><code class="n">tuple</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>                    </code><code class="n">_observer</code><code class="p">(</code><code class="n">tuple</code><code class="p">.</code><code class="n">Key</code><code class="p">,</code><code> </code><code class="n">tuple</code><code class="p">.</code><code class="n">SpeechRecognition</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code>
</code><code>    </code><code class="k">internal</code><code> </code><code class="k">static</code><code> </code><code class="n">SpeechRecognitionSubject</code><code> </code><code class="nf">Factory</code><code class="p">(</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO11-3" id="co_accepting_form_input_with_validation_CO11-3"><img alt="3" src="assets/3.png"/></a><code>
</code><code>        </code><code class="n">Action</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code><code> </code><code class="kt">string</code><code class="p">&gt;</code><code> </code><code class="n">observer</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="k">new</code><code class="p">(</code><code class="n">observer</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">internal</code><code> </code><code class="k">void</code><code> </code><code class="nf">RecognitionReceived</code><code class="p">(</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO11-4" id="co_accepting_form_input_with_validation_CO11-4"><img alt="4" src="assets/4.png"/></a><code>
</code><code>        </code><code class="n">SpeechRecognitionResult</code><code> </code><code class="n">recognition</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">_speechRecognitionSubject</code><code class="p">.</code><code class="n">OnNext</code><code class="p">(</code><code class="n">recognition</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="k">void</code><code> </code><code class="nf">Dispose</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">_speechRecognitionSubscription</code><code class="p">.</code><code class="n">Dispose</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO11-5" id="co_accepting_form_input_with_validation_CO11-5"><img alt="5" src="assets/5.png"/></a><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO11-1" id="callout_accepting_form_input_with_validation_CO11-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>SpeechRecognitionSubject</code> type relies on a subject, observer, observable, and subscription.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO11-2" id="callout_accepting_form_input_with_validation_CO11-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>_observer</code> field is used to invoke the <code>onRecognized</code> callback, and the constructor is <code>private</code>.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO11-3" id="callout_accepting_form_input_with_validation_CO11-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>Factory</code> method is used to create the <code>SpeechRecognitionSubject</code> type.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO11-4" id="callout_accepting_form_input_with_validation_CO11-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The <code>RecognitionReceived</code> method is used to push the given <code>recognition</code> value into the <code>_speechRecognitionSubject</code> field.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO11-5" id="callout_accepting_form_input_with_validation_CO11-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>The <code>Dispose</code> method is used to dispose of the <code>_speechRecognition​Sub⁠scrip⁠tion</code> field.</p></dd>
</dl>

<p>The <code>SpeechRecognitionSubject</code> allows the consumer to push <code>SpeechRecognitionResult</code> instances into its underlying <code>Subject</code>. The consumer also provides an <code>Action&lt;string, string&gt;</code> observer function, which is used within the observables subscription. When <code>Subject</code> acts as an observable, it means its stream of intermittent results can be filtered and conditionally dispatched to the consumer. When the final <code>transcript</code> is ready, the consumer is notified and provided with the <code>key</code> and <code>transcript</code> values.</p>

<p>The custom subject wrapper defines <a data-primary="SpeechRecognitionSubject.cs" data-startref="spgj" data-type="indexterm" id="idm46365002302256"/>only a <code>private</code> constructor, which means it’s not possible to instantiate this object unless using the <code>static</code> factory method. The <code>Factory</code> functionality accepts the <code>observer</code> used to instantiate <code>SpeechRecognitionSubject</code>. The subscription instance is stored as a field so that it can be explicitly cleaned up when the subject is disposed of.</p>
</div></section>













<section data-pdf-bookmark="Managing Callbacks with a Registry" data-type="sect2"><div class="sect2" id="idm46365002917584">
<h2>Managing Callbacks with a Registry</h2>

<p>Since the service exposes <a data-primary="callbacks" data-secondary="SpeechRecognitionSubject" data-type="indexterm" id="idm46365002297776"/>several callbacks, it manages the interop callbacks in a custom registry. The <code>SpeechRecognitionCallbackRegistry</code> object allows for registering a <a data-primary="callbacks" data-secondary="SpeechRecognitionCallbackRegistry" data-type="indexterm" id="idm46365002296416"/>callback and the corresponding invocation of a callback given its key. Let’s look <a data-primary="SpeechRecognitionCallbackRegistry.cs" data-type="indexterm" id="srgkg"/>at the <em>SpeechRecognitionCallbackRegistry.cs</em> C# file:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code><code> </code><code class="nn">Microsoft.JSInterop</code><code class="p">;</code><code>
</code><code>
</code><code class="k">internal</code><code> </code><code class="k">sealed</code><code> </code><code class="k">class</code><code> </code><code class="nc">SpeechRecognitionCallbackRegistry</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO12-1" id="co_accepting_form_input_with_validation_CO12-1"><img alt="1" src="assets/1.png"/></a><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">readonly</code><code> </code><code class="n">ConcurrentDictionary</code><code class="p">&lt;</code><code class="n">Guid</code><code class="p">,</code><code> </code><code class="n">Action</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">_onResultCallbackRegister</code><code> </code><code class="p">=</code><code> </code><code class="k">new</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>    </code><code class="k">readonly</code><code> </code><code class="n">ConcurrentDictionary</code><code class="p">&lt;</code><code class="n">Guid</code><code class="p">,</code><code> </code><code class="n">Action</code><code class="p">&lt;</code><code class="n">SpeechRecognitionErrorEvent</code><code class="p">&gt;</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">_onErrorCallbackRegister</code><code> </code><code class="p">=</code><code> </code><code class="k">new</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>    </code><code class="k">readonly</code><code> </code><code class="n">ConcurrentDictionary</code><code class="p">&lt;</code><code class="n">Guid</code><code class="p">,</code><code> </code><code class="n">Action</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">_onStartedCallbackRegister</code><code> </code><code class="p">=</code><code> </code><code class="k">new</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>    </code><code class="k">readonly</code><code> </code><code class="n">ConcurrentDictionary</code><code class="p">&lt;</code><code class="n">Guid</code><code class="p">,</code><code> </code><code class="n">Action</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">_onEndedCallbackRegister</code><code> </code><code class="p">=</code><code> </code><code class="k">new</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">internal</code><code> </code><code class="k">void</code><code> </code><code class="nf">RegisterOnRecognized</code><code class="p">(</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO12-2" id="co_accepting_form_input_with_validation_CO12-2"><img alt="2" src="assets/2.png"/></a><code>
</code><code>        </code><code class="n">Guid</code><code> </code><code class="n">key</code><code class="p">,</code><code> </code><code class="n">Action</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code><code> </code><code class="n">callback</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">_onResultCallbackRegister</code><code class="p">[</code><code class="n">key</code><code class="p">]</code><code> </code><code class="p">=</code><code> </code><code class="n">callback</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">internal</code><code> </code><code class="k">void</code><code> </code><code class="nf">RegisterOnError</code><code class="p">(</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO12-3" id="co_accepting_form_input_with_validation_CO12-3"><img alt="3" src="assets/3.png"/></a><code>
</code><code>        </code><code class="n">Guid</code><code> </code><code class="n">key</code><code class="p">,</code><code> </code><code class="n">Action</code><code class="p">&lt;</code><code class="n">SpeechRecognitionErrorEvent</code><code class="p">&gt;</code><code> </code><code class="n">callback</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">_onErrorCallbackRegister</code><code class="p">[</code><code class="n">key</code><code class="p">]</code><code> </code><code class="p">=</code><code> </code><code class="n">callback</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">internal</code><code> </code><code class="k">void</code><code> </code><code class="nf">RegisterOnStarted</code><code class="p">(</code><code>
</code><code>        </code><code class="n">Guid</code><code> </code><code class="n">key</code><code class="p">,</code><code> </code><code class="n">Action</code><code> </code><code class="n">callback</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">_onStartedCallbackRegister</code><code class="p">[</code><code class="n">key</code><code class="p">]</code><code> </code><code class="p">=</code><code> </code><code class="n">callback</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">internal</code><code> </code><code class="k">void</code><code> </code><code class="nf">RegisterOnEnded</code><code class="p">(</code><code>
</code><code>        </code><code class="n">Guid</code><code> </code><code class="n">key</code><code class="p">,</code><code> </code><code class="n">Action</code><code> </code><code class="n">callback</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">_onEndedCallbackRegister</code><code class="p">[</code><code class="n">key</code><code class="p">]</code><code> </code><code class="p">=</code><code> </code><code class="n">callback</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">internal</code><code> </code><code class="k">void</code><code> </code><code class="nf">InvokeOnRecognized</code><code class="p">(</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO12-4" id="co_accepting_form_input_with_validation_CO12-4"><img alt="4" src="assets/4.png"/></a><code>
</code><code>        </code><code class="kt">string</code><code> </code><code class="n">key</code><code class="p">,</code><code> </code><code class="kt">string</code><code> </code><code class="n">transcript</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">OnInvokeCallback</code><code class="p">(</code><code>
</code><code>            </code><code class="n">key</code><code class="p">,</code><code> </code><code class="n">_onResultCallbackRegister</code><code class="p">,</code><code>
</code><code>            </code><code class="n">callback</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">callback</code><code class="p">?</code><code class="p">.</code><code class="n">Invoke</code><code class="p">(</code><code class="n">transcript</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">internal</code><code> </code><code class="k">void</code><code> </code><code class="nf">InvokeOnError</code><code class="p">(</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO12-5" id="co_accepting_form_input_with_validation_CO12-5"><img alt="5" src="assets/5.png"/></a><code>
</code><code>        </code><code class="kt">string</code><code> </code><code class="n">key</code><code class="p">,</code><code> </code><code class="n">SpeechRecognitionErrorEvent</code><code> </code><code class="n">error</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">OnInvokeCallback</code><code class="p">(</code><code>
</code><code>            </code><code class="n">key</code><code class="p">,</code><code> </code><code class="n">_onErrorCallbackRegister</code><code class="p">,</code><code>
</code><code>            </code><code class="n">callback</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">callback</code><code class="p">?</code><code class="p">.</code><code class="n">Invoke</code><code class="p">(</code><code class="n">error</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">internal</code><code> </code><code class="k">void</code><code> </code><code class="nf">InvokeOnStarted</code><code class="p">(</code><code class="kt">string</code><code> </code><code class="n">key</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">OnInvokeCallback</code><code class="p">(</code><code>
</code><code>            </code><code class="n">key</code><code class="p">,</code><code> </code><code class="n">_onStartedCallbackRegister</code><code class="p">,</code><code>
</code><code>            </code><code class="n">callback</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">callback</code><code class="p">?</code><code class="p">.</code><code class="n">Invoke</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">internal</code><code> </code><code class="k">void</code><code> </code><code class="nf">InvokeOnEnded</code><code class="p">(</code><code class="kt">string</code><code> </code><code class="n">key</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">OnInvokeCallback</code><code class="p">(</code><code>
</code><code>            </code><code class="n">key</code><code class="p">,</code><code> </code><code class="n">_onEndedCallbackRegister</code><code class="p">,</code><code>
</code><code>            </code><code class="n">callback</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">callback</code><code class="p">?</code><code class="p">.</code><code class="n">Invoke</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">static</code><code> </code><code class="k">void</code><code> </code><code class="n">OnInvokeCallback</code><code class="p">&lt;</code><code class="n">T</code><code class="p">&gt;</code><code class="p">(</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO12-6" id="co_accepting_form_input_with_validation_CO12-6"><img alt="6" src="assets/6.png"/></a><code>
</code><code>        </code><code class="kt">string</code><code> </code><code class="n">key</code><code class="p">,</code><code>
</code><code>        </code><code class="n">ConcurrentDictionary</code><code class="p">&lt;</code><code class="n">Guid</code><code class="p">,</code><code> </code><code class="n">T</code><code class="p">&gt;</code><code> </code><code class="n">callbackRegister</code><code class="p">,</code><code>
</code><code>        </code><code class="n">Action</code><code class="p">&lt;</code><code class="n">T</code><code class="p">?</code><code class="p">&gt;</code><code> </code><code class="n">handleCallback</code><code class="p">)</code><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="p">(</code><code class="n">key</code><code> </code><code class="k">is</code><code> </code><code class="k">null</code><code> </code><code class="n">or</code><code> </code><code class="p">{</code><code> </code><code class="n">Length</code><code class="p">:</code><code> </code><code class="m">0</code><code> </code><code class="p">}</code><code> </code><code class="p">|</code><code class="p">|</code><code>
</code><code>            </code><code class="n">callbackRegister</code><code> </code><code class="k">is</code><code> </code><code class="k">null</code><code> </code><code class="n">or</code><code> </code><code class="p">{</code><code> </code><code class="n">Count</code><code class="p">:</code><code> </code><code class="m">0</code><code> </code><code class="p">}</code><code class="p">)</code><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="k">return</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="p">(</code><code class="n">Guid</code><code class="p">.</code><code class="n">TryParse</code><code class="p">(</code><code class="n">key</code><code class="p">,</code><code> </code><code class="k">out</code><code> </code><code class="kt">var</code><code> </code><code class="n">guid</code><code class="p">)</code><code> </code><code class="p">&amp;</code><code class="p">&amp;</code><code>
</code><code>            </code><code class="n">callbackRegister</code><code class="p">.</code><code class="n">TryRemove</code><code class="p">(</code><code class="n">guid</code><code class="p">,</code><code> </code><code class="k">out</code><code> </code><code class="kt">var</code><code> </code><code class="n">callback</code><code class="p">)</code><code class="p">)</code><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="n">handleCallback</code><code class="p">?</code><code class="p">.</code><code class="n">Invoke</code><code class="p">(</code><code class="n">callback</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO12-1" id="callout_accepting_form_input_with_validation_CO12-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>_onResultCallbackRegister</code> field is used to store the callback register for the <code>onRecognized</code> callback.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO12-2" id="callout_accepting_form_input_with_validation_CO12-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>RegisterOnRecognized</code> method registers the <code>onRecognized</code> callback, and the <code>_onResultCallbackRegister</code> field is used to store the callback.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO12-3" id="callout_accepting_form_input_with_validation_CO12-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>RegisterOnError</code> method registers the <code>onError</code> callback, and the <code>_onErrorCallbackRegister</code> field is used to store the callback.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO12-4" id="callout_accepting_form_input_with_validation_CO12-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The <code>InvokeOnRecognized</code> method invokes the <code>onRecognized</code> callback, and the <code>OnInvokeCallback</code> method invokes the callback.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO12-5" id="callout_accepting_form_input_with_validation_CO12-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>The <code>InvokeOnError</code> method invokes the <code>onError</code> callback, and the <code>OnInvoke​Call⁠back</code> method invokes the callback.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO12-6" id="callout_accepting_form_input_with_validation_CO12-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>The <code>OnInvokeCallback</code> method invokes the <a data-primary="SpeechRecognitionCallbackRegistry.cs" data-startref="srgkg" data-type="indexterm" id="idm46365001957440"/>callback in the register after it’s removed.</p></dd>
</dl>

<p>A <code>ConcurrentDictionary</code> represents a <a data-primary="ConcurrentDictionary" data-type="indexterm" id="idm46365002274416"/><a data-primary="key/value pairs (KVPs)" data-secondary="ConcurrentDictionary" data-type="indexterm" id="idm46365002273680"/>thread-safe collection of KVPs that can be accessed by multiple threads concurrently. There are many alternative approaches to managing callbacks, but the <code>SpeechRecognitionCallbackRegistry</code> object is the simplest and most performant. It’s thread-safe and uses globally unique identifiers to manage the callbacks—which ensures that a single registration is tethered to a single invocation of a callback. One of the advantages to using C# in a browser such as this is that we’re spoiled with the native types provided by the .NET ecosystem. Having access to primitives like <code>ConcurrentDictionary</code>, <code>Guid</code>, strongly typed delegates (<code>Action&lt;T&gt;</code> for example), and even Rx.NET is a huge advantage.</p>
</div></section>













<section data-pdf-bookmark="Applying the Speech Recognition Service to Components" data-type="sect2"><div class="sect2" id="idm46365002270848">
<h2>Applying the Speech Recognition Service to Components</h2>

<p>Applying <code>SpeechRecognitionSubject</code> and <code>SpeechRecognitionCallbackRegistry</code> to expose the <code>ISpeechRecognitionService</code> interface, <a data-primary="ISpeechRecognitionService" data-type="indexterm" id="idm46365001723824"/><a data-primary="SpeechRecognitionSubject, applying to components" data-type="indexterm" id="spgjp"/>we can now create a custom component that can be added to an HTML element and surface speech recognition functionality. Let’s look at the <em>AdditiveSpeechRecognitionComponent.cs</em> C# file:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">using</code><code> </code><code class="nn">RecognitionError</code><code> </code><code class="p">=</code><code> </code><code class="n">Microsoft</code><code class="p">.</code><code class="n">JSInterop</code><code class="p">.</code><code class="n">SpeechRecognitionErrorEvent</code><code class="p">;</code><code>
</code><code>
</code><code class="k">namespace</code><code> </code><code class="nn">Learning.Blazor.Components</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="k">sealed</code><code> </code><code class="k">partial</code><code> </code><code class="k">class</code><code> </code><code class="nc">AdditiveSpeechRecognitionComponent</code><code>
</code><code>        </code><code class="p">:</code><code> </code><code class="n">IAsyncDisposable</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO13-1" id="co_accepting_form_input_with_validation_CO13-1"><img alt="1" src="assets/1.png"/></a><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="n">IDisposable</code><code class="p">?</code><code> </code><code class="n">_recognitionSubscription</code><code class="p">;</code><code>
</code><code>        </code><code class="n">SpeechRecognitionErrorEvent</code><code class="p">?</code><code> </code><code class="n">_error</code><code> </code><code class="p">=</code><code> </code><code class="k">null</code><code class="p">;</code><code>
</code><code>        </code><code class="kt">bool</code><code> </code><code class="n">_isRecognizing</code><code> </code><code class="p">=</code><code> </code><code class="k">false</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="kt">string</code><code> </code><code class="n">_dynamicCSS</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">_isRecognizing</code><code> </code><code class="p">?</code><code> </code><code class="s">"is-flashing"</code><code> </code><code class="p">:</code><code> </code><code class="s">""</code><code class="p">;</code><code>
</code><code class="na">
        [Inject]</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO13-2" id="co_accepting_form_input_with_validation_CO13-2"><img alt="2" src="assets/2.png"/></a><code>
</code><code>        </code><code class="k">private</code><code> </code><code class="n">ISpeechRecognitionService</code><code> </code><code class="n">SpeechRecognition</code><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="k">get</code><code class="p">;</code><code>
</code><code>            </code><code class="k">set</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code> </code><code class="p">=</code><code> </code><code class="k">null</code><code class="p">!</code><code class="p">;</code><code>
</code><code class="na">
        [Parameter]</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO13-3" id="co_accepting_form_input_with_validation_CO13-3"><img alt="3" src="assets/3.png"/></a><code>
</code><code>        </code><code class="k">public</code><code> </code><code class="n">EventCallback</code><code> </code><code class="n">SpeechRecognitionStarted</code><code> </code><code class="p">{</code><code> </code><code class="k">get</code><code class="p">;</code><code> </code><code class="k">set</code><code class="p">;</code><code> </code><code class="p">}</code><code>
</code><code class="na">
        [Parameter]</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO13-4" id="co_accepting_form_input_with_validation_CO13-4"><img alt="4" src="assets/4.png"/></a><code>
</code><code>        </code><code class="k">public</code><code> </code><code class="n">EventCallback</code><code class="p">&lt;</code><code class="n">RecognitionError</code><code class="p">?</code><code class="p">&gt;</code><code> </code><code class="n">SpeechRecognitionStopped</code><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="k">get</code><code class="p">;</code><code>
</code><code>            </code><code class="k">set</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code class="na">
        [Parameter, EditorRequired]</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO13-5" id="co_accepting_form_input_with_validation_CO13-5"><img alt="5" src="assets/5.png"/></a><code>
</code><code>        </code><code class="k">public</code><code> </code><code class="n">EventCallback</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code><code> </code><code class="n">SpeechRecognized</code><code> </code><code class="p">{</code><code> </code><code class="k">get</code><code class="p">;</code><code> </code><code class="k">set</code><code class="p">;</code><code> </code><code class="p">}</code><code>
</code><code>
</code><code>        </code><code class="k">protected</code><code> </code><code class="k">override</code><code> </code><code class="k">async</code><code> </code><code class="n">Task</code><code> </code><code class="nf">OnAfterRenderAsync</code><code class="p">(</code><code class="kt">bool</code><code> </code><code class="n">firstRender</code><code class="p">)</code><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="k">if</code><code> </code><code class="p">(</code><code class="n">firstRender</code><code class="p">)</code><code>
</code><code>            </code><code class="p">{</code><code>
</code><code>                </code><code class="k">await</code><code> </code><code class="n">SpeechRecognition</code><code class="p">.</code><code class="n">InitializeModuleAsync</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO13-6" id="co_accepting_form_input_with_validation_CO13-6"><img alt="6" src="assets/6.png"/></a><code>
</code><code>            </code><code class="p">}</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>
</code><code>        </code><code class="k">void</code><code> </code><code class="nf">OnRecognizeButtonClick</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO13-7" id="co_accepting_form_input_with_validation_CO13-7"><img alt="7" src="assets/7.png"/></a><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="k">if</code><code> </code><code class="p">(</code><code class="n">_isRecognizing</code><code class="p">)</code><code>
</code><code>            </code><code class="p">{</code><code>
</code><code>                </code><code class="n">SpeechRecognition</code><code class="p">.</code><code class="n">CancelSpeechRecognition</code><code class="p">(</code><code class="k">false</code><code class="p">)</code><code class="p">;</code><code>
</code><code>            </code><code class="p">}</code><code>
</code><code>            </code><code class="k">else</code><code>
</code><code>            </code><code class="p">{</code><code>
</code><code>                </code><code class="kt">var</code><code> </code><code class="n">bcp47Tag</code><code> </code><code class="p">=</code><code> </code><code class="n">Culture</code><code class="p">.</code><code class="n">CurrentCulture</code><code class="p">.</code><code class="n">Name</code><code class="p">;</code><code>
</code><code>                </code><code class="n">_recognitionSubscription</code><code class="p">?</code><code class="p">.</code><code class="n">Dispose</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>                </code><code class="n">_recognitionSubscription</code><code> </code><code class="p">=</code><code> </code><code class="n">SpeechRecognition</code><code class="p">.</code><code class="n">RecognizeSpeech</code><code class="p">(</code><code>
</code><code>                    </code><code class="n">bcp47Tag</code><code class="p">,</code><code>
</code><code>                    </code><code class="n">OnRecognized</code><code class="p">,</code><code>
</code><code>                    </code><code class="n">OnError</code><code class="p">,</code><code>
</code><code>                    </code><code class="n">OnStarted</code><code class="p">,</code><code>
</code><code>                    </code><code class="n">OnEnded</code><code class="p">)</code><code class="p">;</code><code>
</code><code>            </code><code class="p">}</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>
</code><code>        </code><code class="k">void</code><code> </code><code class="nf">OnRecognized</code><code class="p">(</code><code class="kt">string</code><code> </code><code class="n">transcript</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_accepting_form_input_with_validation_CO13-8" id="co_accepting_form_input_with_validation_CO13-8"><img alt="8" src="assets/8.png"/></a><code>
</code><code>            </code><code class="n">_</code><code> </code><code class="p">=</code><code> </code><code class="n">SpeechRecognized</code><code class="p">.</code><code class="n">TryInvokeAsync</code><code class="p">(</code><code class="n">transcript</code><code class="p">,</code><code> </code><code class="k">this</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="k">void</code><code> </code><code class="nf">OnError</code><code class="p">(</code><code class="n">SpeechRecognitionErrorEvent</code><code> </code><code class="n">recognitionError</code><code class="p">)</code><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="p">(</code><code class="n">_isRecognizing</code><code class="p">,</code><code> </code><code class="n">_error</code><code class="p">)</code><code> </code><code class="p">=</code><code> </code><code class="p">(</code><code class="k">false</code><code class="p">,</code><code> </code><code class="n">recognitionError</code><code class="p">)</code><code class="p">;</code><code>
</code><code>            </code><code class="n">_</code><code> </code><code class="p">=</code><code> </code><code class="n">SpeechRecognitionStopped</code><code class="p">.</code><code class="n">TryInvokeAsync</code><code class="p">(</code><code class="n">_error</code><code class="p">,</code><code> </code><code class="k">this</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>
</code><code>        </code><code class="k">void</code><code> </code><code class="nf">OnStarted</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="n">_isRecognizing</code><code> </code><code class="p">=</code><code> </code><code class="k">true</code><code class="p">;</code><code>
</code><code>            </code><code class="n">_</code><code> </code><code class="p">=</code><code> </code><code class="n">SpeechRecognitionStarted</code><code class="p">.</code><code class="n">TryInvokeAsync</code><code class="p">(</code><code class="k">this</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>
</code><code>        </code><code class="k">public</code><code> </code><code class="k">void</code><code> </code><code class="nf">OnEnded</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="n">_isRecognizing</code><code> </code><code class="p">=</code><code> </code><code class="k">false</code><code class="p">;</code><code>
</code><code>            </code><code class="n">_</code><code> </code><code class="p">=</code><code> </code><code class="n">SpeechRecognitionStopped</code><code class="p">.</code><code class="n">TryInvokeAsync</code><code class="p">(</code><code class="n">_error</code><code class="p">,</code><code> </code><code class="k">this</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>
</code><code>        </code><code class="n">ValueTask</code><code> </code><code class="n">IAsyncDisposable</code><code class="p">.</code><code class="n">DisposeAsync</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="n">_recognitionSubscription</code><code class="p">?</code><code class="p">.</code><code class="n">Dispose</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>            </code><code class="k">return</code><code> </code><code class="n">SpeechRecognition</code><code class="p">.</code><code class="n">DisposeAsync</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO13-1" id="callout_accepting_form_input_with_validation_CO13-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>AdditiveSpeechRecognitionComponent</code> implements the <code>IAsyncDisposable</code> interface, which allows us to dispose of the speech recognition module when the component is removed from the DOM.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO13-2" id="callout_accepting_form_input_with_validation_CO13-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>SpeechRecognition</code> property is used to access the speech recognition 
<span class="keep-together">service.</span></p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO13-3" id="callout_accepting_form_input_with_validation_CO13-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>SpeechRecognitionStarted</code> property is optional and is used to notify the parent component that the speech recognition has started.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO13-4" id="callout_accepting_form_input_with_validation_CO13-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The <code>SpeechRecognitionStopped</code> property is also optional, and it’s signaled when speech recognition has stopped.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO13-5" id="callout_accepting_form_input_with_validation_CO13-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>The <code>SpeechRecognized</code> property is an <code>EditorRequired</code> parameter, and it’s called multiple times over the typical session.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO13-6" id="callout_accepting_form_input_with_validation_CO13-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>The <code>OnAfterRenderAsync</code> method is used to initialize the speech recognition module.</p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO13-7" id="callout_accepting_form_input_with_validation_CO13-7"><img alt="7" src="assets/7.png"/></a></dt>
<dd><p>The <code>OnRecognizeButtonClick</code> method is used to start or stop speech 
<span class="keep-together">recognition.</span></p></dd>
<dt><a class="co" href="#co_accepting_form_input_with_validation_CO13-8" id="callout_accepting_form_input_with_validation_CO13-8"><img alt="8" src="assets/8.png"/></a></dt>
<dd><p>The <code>OnRecognized</code> method is used to notify the parent component that speech recognition has been completed.</p></dd>
</dl>

<p>When the user clicks the microphone button, the <code>OnRecognizeButtonClick</code> method is called. The consuming <code>Contact</code> page will mark the corresponding <code>input</code> element as <code>readonly</code>. This helps to ensure that the user cannot edit the text in the input field, as it is automatically updating from the speech recognition. So, you can’t talk and type at the same time. The <code>EventCallback</code> instances signal any changes to the consumer. The <code>TryInvokeAsync</code> is an extension method that <a data-primary="speech recognition" data-secondary="implementing" data-startref="spgp" data-type="indexterm" id="idm46365001221696"/><a data-primary="SpeechRecognitionSubject, applying to components" data-startref="spgjp" data-type="indexterm" id="idm46365001220448"/>conditionally calls the <code>InvokeAsync</code> method on the <code>EventCallback</code> instance if its <code>HasDelegate</code> value is <code>true</code>.</p>
</div></section>





</div></section>













<section data-pdf-bookmark="Form Submission Validation and Verification" data-type="sect1"><div class="sect1" id="idm46365001224064">
<h1>Form Submission Validation and Verification</h1>

<p>Putting this all together, we’ve <a data-primary="form submission" data-type="indexterm" id="fbsvd"/>built a custom <code>Contact</code> page that displays a beautifully styled form that boasts speech recognition functionality with the click of a button. Before a user can submit the form, all fields must be validated. As the primary function of a form is to take user input and give it to the recipient, it’s vital to validate the input to make sure the information is communicated correctly.</p>

<p>The form model is bound to various form fields, and the form is validated on submission. Each form field is represented by an HTML element using Blazor components. The form field components are responsible for validating the user’s input. When the framework-provided <code>EditForm</code> component is given a C# model that is invalid, it will render the form with the appropriate error messages. Only when the form submission is valid will the <code>EditForm</code> component submit the form. Meaning all of the data annotations on the model are validated, including required fields, custom regex patterns, and custom validation
methods.</p>

<p>Once the <code>Contact</code> form is considered valid and submitted, the user is prompted by a modal that acts as a basic spam blocker. We set up this <code>VerificationModalComponent</code> in <a data-type="xref" href="ch04.html#are-you-human-modal">Figure 4-3</a> in <a data-type="xref" href="ch04.html#chapter-four">Chapter 4</a>. The modal prompts the user to answer random math problems and requires a correct answer for the submission to proceed.</p>

<p><a data-type="xref" href="#are-you-human-modal-zoom">Figure 8-5</a> shows an example of this modal prompt.</p>

<figure><div class="figure" id="are-you-human-modal-zoom">
<img alt="" src="assets/lblz_0805.png"/>
<h6><span class="label">Figure 8-5. </span>An example rendering of the <code>VerificationModalComponent</code> zoomed in</h6>
</div></figure>

<p>If the answer is incorrect, the modal will not allow the user’s form data to be sent to the Web.Api project’s endpoint for processing. An incorrect answer is shown in <a data-type="xref" href="#are-you-human-modal-zoom-wrong">Figure 8-6</a>.</p>

<figure><div class="figure" id="are-you-human-modal-zoom-wrong">
<img alt="" src="assets/lblz_0806.png"/>
<h6><span class="label">Figure 8-6. </span>An example rendering of the <code>VerificationModalComponent</code> zoomed in with the wrong answer</h6>
</div></figure>

<p class="pagebreak-after">Once the question is correctly answered, the modal is dismissed and the contact form is processed. A notification is triggered, which states that the contact attempt is successful, as shown in <a data-type="xref" href="#contact-page-message-sent-notification">Figure 8-7</a>.</p>

<figure><div class="figure" id="contact-page-message-sent-notification">
<img alt="" src="assets/lblz_0807.png"/>
<h6><span class="label">Figure 8-7. </span>An example rendering of the confirmation notification</h6>
</div></figure>

<p>Because the primary function of a form is to take user input and give it to the recipient, it’s vital to validate the input to make sure the information is communicated correctly. A model is bound to various form fields, and the form is validated on submission. Each form field is represented by an HTML element using Blazor components. The form field components are responsible for validating the user’s input. When the framework-provided <code>EditForm</code> component is given a C# model that is invalid, it will render the form with the appropriate error messages. Only when the form submission is valid will the <code>EditForm</code> component submit the form, meaning all of the data annotations on the model are validated, including required <a data-primary="form submission" data-startref="fbsvd" data-type="indexterm" id="idm46365001165360"/>fields, custom regex patterns, and custom validation methods.</p>
</div></section>













<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm46365001182224">
<h1>Summary</h1>

<p>In this chapter, I showed you how to implement a form that accepts input with validation. In the process, you learned the basics of form submission, including how to bind custom C# models to <code>EditForm</code>, how to use data annotations to decorate model properties with validation attributes, and how to render a form with validation errors. I also walked you through a speech recognition library that exposes the ability to accept a user’s spoken word as input that is bound to text input.</p>

<p>In the next chapter, I’m going to show you how to properly test your Blazor apps. From unit tests with xUnit to component tests with bUnit, you’ll learn how to write reliable tests that can be used to verify the functionality of your app.</p>
</div></section>







<div data-type="footnotes"><p data-type="footnote" id="idm46365007034848"><sup><a href="ch08.html#idm46365007034848-marker">1</a></sup> “ASP.NET Core Blazor Forms and Input Components,” Microsoft .NET Documentation, August 16, 2022, <a href="https://oreil.ly/3qzqQ"><em class="hyperlink">https://oreil.ly/3qzqQ</em></a>.</p></div></div></section></body></html>