<html><head></head><body><section data-pdf-bookmark="Chapter 9. LINQ and lambdas: Get control of your data" data-type="chapter" epub:type="chapter"><div class="chapter" id="linq_and_lambdas_get_control_of_your_dat">&#13;
<h1><span class="label">Chapter 9. </span>LINQ and lambdas: <em>Get control of your data</em></h1>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg467.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p><a data-primary="LINQ (Language Integrated Query)" data-secondary="about" data-type="indexterm" id="idm46402341085816"/><strong>It’s a data-driven world...we all need to know how to live in it.</strong></p>&#13;
<p>Gone are the days when you could program for days, even weeks, without dealing with <strong>loads of data</strong>. Today, <strong><em>everything is about data</em></strong>, and that’s where <strong>LINQ</strong> comes in. LINQ is a feature of C# and .NET that not only lets you <strong>query data</strong> in your .NET collections in an intuitive way, but lets you <strong>group data</strong> and <strong>merge data from different data sources</strong>. You’ll add <strong>unit tests</strong> to make sure your code is working the way you want. Once you’ve got the hang of wrangling your data into manageable chunks, you can use <strong>lambda expressions</strong> to refactor your C# code to make it even more expressive</p>&#13;
<section data-pdf-bookmark="Jimmy’s a Captain Amazing super-fan..." data-type="sect1"><div class="sect1" id="jimmyapostrophes_a_captain_amazing_super">&#13;
<h1>Jimmy’s a Captain Amazing super-fan...</h1>&#13;
<p><a data-primary="Captain Amazing" data-type="indexterm" id="idm46402341079032"/>Meet Jimmy, one of the most enthusiastic collectors of Captain Amazing comics, graphic novels, and paraphernalia. He knows all the Captain trivia, he’s got props from all the movies, and he’s got a comic collection that can only be described as, well, amazing.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg468.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
</div></section>&#13;
<section data-pdf-bookmark="...but his collection’s all over the place" data-type="sect1"><div class="sect1" id="hellipbut_his_collectionapostrophes_all">&#13;
<h1>...but his collection’s all over the place</h1>&#13;
<p>Jimmy may be passionate, but he’s not exactly organized. He’s trying to keep track of the most prized “crown jewel” comics of his collection, but he needs help. Can you build Jimmy an app to manage his comics?</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="relax-idd0003">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/common-12.png"/></span> Relax</h5>&#13;
<p><strong>LINQ works with values <em>and</em> objects.</strong></p>&#13;
<p>We’re going to use LINQ to query collections of numbers to introduce the ideas and syntax. You’ll probably be thinking, “But how does this help manage comic books?” That’s a great question to keep in mind in the first part of this chapter. Later on, we’ll use really similar LINQ queries to manage collections of Comic objects­.</p>&#13;
</div></aside>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg469.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
</div></section>&#13;
<section data-pdf-bookmark="Use LINQ to query your collections" data-type="sect1"><div class="sect1" id="use_linq_to_query_your_collections">&#13;
<h1>Use LINQ to query your collections</h1>&#13;
<p><a data-primary="collections" data-secondary="querying with LINQ" data-type="indexterm" id="idm46402341065400"/><a data-primary="LINQ (Language Integrated Query)" data-secondary="methods" data-type="indexterm" id="idm46402341064056"/><a data-primary="LINQ (Language Integrated Query)" data-secondary="querying collections with" data-type="indexterm" id="idm46402341062472"/>In this chapter you’ll learn about <strong>LINQ</strong> (or <strong><u>L</u>anguage-<strong><u>In</u>tegrated</strong> <u>Q</u>uery</strong>). LINQ combines really useful classes and methods with powerful features built directly into C#, all created to help you work with sequences of data—like Jimmy’s comic book collection.</p>&#13;
<p>Let’s use Visual Studio to start exploring LINQ. <strong>Create a new Console App</strong> (.NET Core) project and give it the name <strong><em>LinqTest</em></strong>. Add this code, and when you get to the last line <strong>add a period</strong> and look at the IntelliSense window:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg470.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>Let’s use some of those new methods to finish your console app:</p>&#13;
<pre data-type="programlisting">            IEnumerable&lt;int&gt; firstAndLastFive = numbers.Take(5).Concat(numbers.TakeLast(5));&#13;
            foreach (int i in firstAndLastFive)&#13;
            {&#13;
                Console.Write($"{i} ");&#13;
            }&#13;
        }&#13;
    }&#13;
}</pre>&#13;
<p>Now run your app. It prints this line of text to the console:</p>&#13;
<pre data-type="programlisting">1 2 3 4 5 95 96 97 98 99</pre>&#13;
<p>So what did you just do?</p>&#13;
<blockquote>&#13;
<p><strong>LINQ (or Language INtegrated Query) is a combination of C# features  and .NET classes that helps you work with sequences of data.</strong></p>&#13;
</blockquote>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="a_linq_query_up_close">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/zoom.png"/></span> A LINQ Query Up Close</h5>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/470fig01.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
</div></aside>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="use_method_chaining_with_linq_methods">&#13;
<h5>Use method chaining with LINQ methods</h5>&#13;
<p><a data-primary="LINQ (Language Integrated Query)" data-secondary="method chaining and" data-type="indexterm" id="idm46402341044632"/><a data-primary="method chaining" data-type="indexterm" id="idm46402341043432"/>When you add <code>using System.Linq</code>; to your code, the LINQ methods get added to lists. They also get added to arrays, queues, stacks...in fact, they’re added to any object that extends IEnumerable&lt;T&gt;. Since almost all of the LINQ methods return an IEnumerable&lt;T&gt;, you can take the results of a LINQ method and call another LINQ method directly on them without using a variable to keep track of the results.</p>&#13;
<p>That’s called method chaining, and it lets you write very compact code.</p>&#13;
<p>For example, we could have used variables to store the results of Take and TakeLast:</p>&#13;
<p>IEnumerable&lt;int&gt; firstFive = numbers.Take(5);</p>&#13;
<p>IEnumerable&lt;int&gt; lastFive = numbers.TakeLast(5);</p>&#13;
<p>IEnumerable&lt;int&gt; firstAndLastFive = firstFive.Concat(lastFive);</p>&#13;
<p>But method chaining lets us put it all into a single line of code, calling Concat directly on the output of numbers.Take(5). They both do the same thing. Keep in mind that compact code is not necessarily better than verbose code! Sometimes breaking a chained method call into extra lines of code makes it clearer and easier to understand. It’s up to you to decide which is more readable for any particular project.</p>&#13;
</div></aside>&#13;
</div></section>&#13;
<section data-pdf-bookmark="LINQ works with any IEnumerable&lt;T&gt;" data-type="sect1"><div class="sect1" id="linq_works_with_any_ienumerableless_than">&#13;
<h1>LINQ works with any IEnumerable&lt;T&gt;</h1>&#13;
<p><a data-primary="IEnumerable interface" data-secondary="LINQ and" data-type="indexterm" id="idm46402341038728"/><a data-primary="LINQ (Language Integrated Query)" data-secondary="IEnumerable interface and" data-type="indexterm" id="idm46402341037592"/>When you added the <code>using System.Linq;</code> directive to your code, your List&lt;int&gt; suddenly got “superpowered”—a bunch of LINQ methods repeated appeared on it. You can do the same thing for <strong><em><u>any</u></em></strong> <strong><em>class that implements IEnumerable&lt;T&gt;.</em></strong></p>&#13;
<p>When a class implements IEnumerable&lt;T&gt;, any instance of that class is a <strong>sequence:</strong></p>&#13;
<ul>&#13;
<li><p>The list of numbers from 1 to 99 was a sequence.</p></li>&#13;
<li><p>When you called its Take method, it returned a reference to a sequence that contained the first five elements.</p></li>&#13;
<li><p>When you called its TakeLast method, it returned another five-element sequence.</p></li>&#13;
<li><p>And when you used Concat to combine the two five-element sequences, it created a new sequence with 10 elements and returned a reference to that new sequence.</p></li>&#13;
</ul>&#13;
<blockquote>&#13;
<p><strong>Any time you have an object that implements the IEnumerable interface, you have a <u>sequence</u> that you can use with LINQ. Doing an operation on that sequence in order is called <u>enumerating</u> the sequence.</strong></p>&#13;
</blockquote>&#13;
<section data-pdf-bookmark="LINQ methods enumerate your sequences" data-type="sect2"><div class="sect2" id="linq_methods_enumerate_your_sequences">&#13;
<h2>LINQ methods enumerate your sequences</h2>&#13;
<p>You already know that <code>foreach</code> loops work with IEnumerable objects. Think about what a <code>foreach</code> loop does:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg472.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>When a method goes through each item in a sequence in order, that’s called <strong>enumerating</strong> the sequence. And that’s how LINQ methods work.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><strong>Objects that implement the IEnumerable interface can be <span style="color:#9D9EA0;">enumerated</span>. That’s the job objects that implement the IEnumerable interface do.</strong></p>&#13;
</div>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="e_nu_mer_atecomma_verbdot">&#13;
<h5>e-nu-mer-ate, verb.</h5>&#13;
<p><em>mention a number of things one by one. Suzy <strong>enumerated</strong> the toy cars in her collection for her dad, telling him each car’s make and model.</em></p>&#13;
</div></aside>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><a data-primary="exercises" data-secondary="Sharpen your pencil" data-tertiary="LINQ" data-type="indexterm" id="idm46402341016104"/><a data-primary="LINQ (Language Integrated Query)" data-secondary="exercises on" data-type="indexterm" id="idm46402341013560"/><a data-primary="Sharpen Your Pencil exercises" data-secondary="LINQ" data-type="indexterm" id="idm46402341012376"/><strong>What if you want to find the first 30 issues in Jimmy’s collection starting with issue #118? LINQ provides a really useful method to help with that. The static Enumerable.Range method generates a sequence of integers. Calling Enumerable.Range(8, 5) returns a sequence of 5 numbers starting with 8: 8, 9, 10, 11, 12.</strong></p>&#13;
</div>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg473-1.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="sharpen_your_pencil-idd0034">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/pencil.png"/></span> Sharpen your pencil</h5>&#13;
<p>Here are just a few of the LINQ methods that you’ll find on your sequences when you add the <code>using System.Linq;</code> directive to your code. They have pretty intuitive names—can you figure out just from their names what they do? <strong>Draw a line</strong> connecting each method call to its output.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg473-2.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
</div></aside>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="sharpen_your_pencil_solution-idd018">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/Common.png"/></span> Sharpen your pencil Solution</h5>&#13;
<p><a data-primary="Concat method" data-type="indexterm" id="idm46402340999592"/><a data-primary="Count method (LINQ)" data-type="indexterm" id="idm46402340998520"/><a data-primary="Last method" data-type="indexterm" id="idm46402340997752"/><a data-primary="LINQ (Language Integrated Query)" data-secondary="First method" data-type="indexterm" id="idm46402340996840"/><a data-primary="Max method (LINQ)" data-type="indexterm" id="idm46402340995688"/><a data-primary="Min method (LINQ)" data-type="indexterm" id="idm46402340994808"/><a data-primary="Reverse method (Unity)" data-type="indexterm" id="idm46402340993976"/><a data-primary="Skip method" data-type="indexterm" id="idm46402340993176"/><a data-primary="Sum method (LINQ)" data-type="indexterm" id="idm46402340992264"/><a data-primary="TakeLast method (LINQ)" data-type="indexterm" id="idm46402340991528"/><a data-primary="Take method (LINQ)" data-type="indexterm" id="idm46402340990696"/>Here are just a few of the LINQ methods that you’ll find on your sequences when you add the <code>using System.Linq;</code> directive to your code. They have pretty intuitive names—can you figure out just from their names what they do? <strong>Draw a line</strong> connecting each method call to its output.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg474.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
</div></aside>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><strong>The LINQ methods in this exercise have names that make it obvious what they do. Some LINQ methods, like Sum, Min, Max, Count, First, and Last, return a single value. The Sum method adds up the values in the sequence. The <span style="color:#9D9EA0;"><u>Average</u></span> method returns their average value. The <span style="color:#9D9EA0;"><u>Min</u></span> and <span style="color:#9D9EA0;"><u>Max</u></span> methods return the smallest and largest values in the sequence. The <span style="color:#9D9EA0;"><u>First</u></span> and <span style="color:#9D9EA0;"><u>Last</u></span> methods do exactly what it sounds like they do.</strong></p>&#13;
<p><strong>Other LINQ methods, like <span style="color:#9D9EA0;"><u>Take, TakeLast, Concat, Reverse</u></span> (which reverses the order in a sequence), and <span style="color:#9D9EA0;"><u>Skip</u></span> (which skips the first elements in a sequence), return another sequence.</strong></p>&#13;
</div>&#13;
</div></section>&#13;
</div></section>&#13;
<section data-pdf-bookmark="LINQ’s query syntax" data-type="sect1"><div class="sect1" id="linqapostrophes_query_syntax">&#13;
<h1>LINQ’s query syntax</h1>&#13;
<p><a data-primary="clauses in LINQ queries" data-type="indexterm" id="idm46402340977016"/><a data-primary="LINQ (Language Integrated Query)" data-secondary="queries" data-type="indexterm" id="idm46402340976280"/><a data-primary="LINQ (Language Integrated Query)" data-secondary="query syntax" data-type="indexterm" id="idm46402340975272"/>The LINQ methods you’ve seen so far may not be enough on their own to answer the kinds of questions about data that we might have—or the questions that Jimmy has about his comic collection.</p>&#13;
<p>And that’s where the <strong>LINQ declarative query syntax</strong> comes in. It uses special keywords—including <code>where</code>, <code>select</code>, <code>groupby</code>, and <code>join</code>—to build <strong>queries</strong> directly into your code.</p>&#13;
<section data-pdf-bookmark="LINQ queries are built from clauses" data-type="sect2"><div class="sect2" id="linq_queries_are_built_from_clauses">&#13;
<h2>LINQ queries are built from clauses</h2>&#13;
<p>Let’s build a query that finds the numbers in an int array that are under 37 and puts those numbers in ascending order. It does that using four <strong>clauses</strong> that tell it what object to query how to determine which of its members to select, how to sort the results, and how the results should be returned.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><strong>LINQ queries work on <u><span style="color:#9D9EA0;">sequences</span></u>, or objects that implement IEnumerable&lt;T&gt;. LINQ queries start with a from clause:</strong></p>&#13;
<pre data-type="programlisting">from (variable) in (sequence)</pre>&#13;
<p><strong>It tells the query what sequence to execute against, and assigns a name to use for each element being queried. It’s like the first line in a <code>foreach loop</code>: it declares a variable to use while iterating through the sequence that’s assigned each element in the sequence. So this:</strong></p>&#13;
<pre data-type="programlisting">from v in values</pre>&#13;
<p><strong>iterates through each element in the <code>values</code> array in order, assigning the first value in the array to v, then the second, then the third, etc.</strong></p>&#13;
</div>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg475.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="there_are_no_dumb_questions-idd0028">&#13;
<h5>there are no Dumb Questions</h5>&#13;
<p><strong>Q: So adding a <code><strong>using</strong></code> directive to the top of a file “magically” adds LINQ methods to every IEnumerable in it?</strong></p>&#13;
<p><strong>A:</strong> Basically, yes it does. You need a <code>using System.Linq;</code> directive at the top of your file to use LINQ methods (and, later, LINQ queries). Just like you saw in the last chapter, you’ll also need <code>using System.Collections.Generic;</code> if you want to use IEnumerable&lt;T&gt;—for example, as a return value.</p>&#13;
<p>(Obviously, there’s no <em>actual</em> magic involved. LINQ uses a C# feature called <strong>extension methods</strong>, which you’ll learn about in <a href="ch11.html#captain_amazing_the_death_of_the_object">#captain_amazing_the_death_of_the_object</a>. All you need to know for now is that when you add the <code>using</code> directive, you can use LINQ with any IEnumerable&lt;T&gt; reference.)</p>&#13;
<p><strong>Q: I’m still not clear on what method chaining is. How does it work, exactly, and why should I use it?</strong></p>&#13;
<p><strong>A:</strong> Method chaining is a really common way of making multiple method calls in a row. Since many of the LINQ methods return a sequence that implements IEnumerable&lt;T&gt;, you can call another LINQ method on the result. Method chaining isn’t unique to LINQ, either. You can use it in your own classes.</p>&#13;
<p><strong>Q: Can you show me an example of a class that uses method chaining?</strong></p>&#13;
<p><strong>A:</strong> Sure. Here’s a class that has two methods built for chaining:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg476-1.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
</div></aside>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg476-2.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p><strong>LINQ isn’t just for numbers. It works with <span style="color:#9D9EA0;">objects</span>, too.</strong> </p>&#13;
<p>When Jimmy looks at stacks and stacks of disorganized comics, he might see paper, ink, and a jumbled mess. When us developers look at them, we see something else: <strong>lots and lots of data</strong> just waiting to be organized. How do we organize comic book data in C#? The same way we organize playing cards, bees, or items on Sloppy Joe’s menu: we create a class, then we use a collection to manage that class. So all we need to help Jimmy out is a Comic class, and code to help us bring some sanity to his collection. And LINQ will help!</p>&#13;
</div></section>&#13;
</div></section>&#13;
<section data-pdf-bookmark="LINQ works with objects" data-type="sect1"><div class="sect1" id="linq_works_with_objects">&#13;
<h1>LINQ works with objects</h1>&#13;
<p><a data-primary="LINQ (Language Integrated Query)" data-secondary="objects and" data-type="indexterm" id="idm46402340942056"/><a data-primary="objects" data-secondary="LINQ and" data-type="indexterm" id="idm46402340940344"/>Jimmy wanted to know how much some of his prize comics are worth, so he hired a professional comic book appraiser to give him prices for each of them. It turns out that some of his comics are worth a lot of money! Let’s use collections to manage that data for him.</p>&#13;
<p><strong><em>Do this!</em></strong></p>&#13;
<ol>&#13;
<li><p><strong>Create a new console app and add a Comic class.</strong></p>&#13;
<p>Use two automatic properties for the name and issue number:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg477-1.png"/>&#13;
<h6/>&#13;
</div></figure></li>&#13;
<li><p><strong>Add a List that contains Jimmy’s catalog.</strong></p>&#13;
<p>Add this static Catalog field to the Comic class. It returns a sequence with Jimmy’s prized comics:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg477-2.png"/>&#13;
<h6/>&#13;
</div></figure></li>&#13;
<li><p><strong>Use a Dictionary to manage the prices.</strong></p>&#13;
<p>Add a static Comic.Prices field—it’s a Dictionary&lt;int, decimal&gt; that lets you look up the price of each comic using its issue number (using the collection initializer syntax for dictionaries that you learned in <a href="ch08.html#enums_and_collections_organizing_your_da">#enums_and_collections_organizing_your_da</a>). Note that we’re using the <strong>IReadOnlyDictionary interface</strong> for encapsulation—it’s an interface that includes only the methods to read values (so we don’t accidentally change the prices):</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg477-3.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><strong>We used a Dictionary to store the prices for the comics. We could have included a property called Price. We decided to keep information about the comic and price separate. We did this because prices for collectors’ items change all the time, but the name and issue number will always be the same. Do you think we made the right choice?</strong></p>&#13;
</div></li>&#13;
</ol>&#13;
</div></section>&#13;
<section data-pdf-bookmark="Use a LINQ query to finish the app for Jimmy" data-type="sect1"><div class="sect1" id="use_a_linq_query_to_finish_the_app_for_j">&#13;
<h1>Use a LINQ query to finish the app for Jimmy</h1>&#13;
<p>We used the LINQ declarative query syntax earlier to create a query with four clauses: a <code>from</code> clause to create a range variable, a <code>where</code> clause to include only numbers under 37, an <code>orderby</code> clause to sort them in descending order, and a <code>select</code> clause to determine which elements to include in the resulting sequence.</p>&#13;
<p>Let’s <strong>add a LINQ query to the Main method</strong> that works exactly the same way—except using Comic objects instead of int values, so it writes a list of comics with a price &gt; 500 in reverse order to the console. We’ll start with two <code>using</code> declarations so we can use IEnumerable&lt;T&gt; and LINQ methods. The query will return an IEnumerable&lt;Comic&gt;, then use a <code>foreach</code> loop to iterate through it and write the output.</p>&#13;
&#13;
<ol start="4">&#13;
<li><p><strong>Modify the Main method to use a LINQ query.</strong></p>&#13;
<p>Here’s the entire Program class, including the <code>using</code> directives that you needed to add to the top:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg478-1.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p><strong>Output:</strong></p>&#13;
<pre data-type="programlisting">Hippie Madness (misprinted) is worth $13,525.00&#13;
Johnny America vs. the Pinko is worth $3,600.00&#13;
Woman's Work is worth $650.00</pre></li>&#13;
<li><p><strong>Use the descending keyword to make your orderby clause more readable.</strong></p>&#13;
<p>Your <code>orderby</code> clause uses a minus sign to negate the comic prices before sorting, causing the query to sort them in descending order. But it’s easy to accidentally miss that minus sign when you’re reading the code and trying to figure out how it works. Luckily, there’s another way to get the same results. Remove the minus sign and <strong>add the <code>descending</code> keyword</strong> to the end of the clause:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg478-2.png"/>&#13;
<h6/>&#13;
</div></figure></li>&#13;
</ol>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="anatomy_of_a_query">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/icon4.png"/></span> Anatomy of a query</h5>&#13;
<p>Let’s explore how LINQ works by making a couple of small changes to the query:</p>&#13;
<ul>&#13;
<li><p>That minus in the <code>orderby</code> clause is easy to miss. We’ll make sure to use the <code>descending</code> keyword that you just added in step <span class="inlineimage"><img alt="Images" src="assets/five.png"/></span>.</p></li>&#13;
<li><p>The <code>select</code> clause you just wrote selected the comic, so the result of the query was a sequence of Comic references. Let’s replace it with an interpolated string that uses the <code>comic</code> range variable—now the result of the query is a sequence of strings.</p></li>&#13;
</ul>&#13;
<p>Here’s the updated LINQ query. Each clause in the query produces a sequence that feeds into the next clause—we’ve added a table under each clause that shows its result.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg479.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
</div></aside>&#13;
</div></section>&#13;
<section data-pdf-bookmark="The var keyword lets C# figure out variable types for you" data-type="sect1"><div class="sect1" id="the_var_keyword_lets_chash_figure_out_va">&#13;
<h1>The <u>var</u> keyword lets C# figure out variable types for you</h1>&#13;
<p><a data-primary="var keyword" data-type="indexterm" id="idm46402340895544"/>We just saw that when we made the small change to the <code>select</code> clause, the type of sequence that the query returned changed. When it was <code>select comic;</code> the return type was IEnumerable&lt;Comic&gt;. When we changed it to <code>select $"{comic} is worth {Comic.Prices[comic.Issue]:c}";</code> the return type changed to IEnumerable&lt;string&gt;. When you’re working with LINQ, that happens all the time—you’re constantly tweaking your queries. It’s not always obvious exactly what type they return. Sometimes going back and updating all of your declarations can get annoying.</p>&#13;
<p>Luckily, C# gives us a really useful tool to help keep variable declarations simple and readable. You can replace <u>any</u> variable declaration with the <code>var</code> <strong>keyword</strong>. So you can replace any of these declarations:</p>&#13;
<pre data-type="programlisting"><strong>IEnumerable&lt;int&gt;</strong> numbers = Enumerable.Range(1, 10);&#13;
<strong>string</strong> s = $"The count is {numbers.Count()}";&#13;
<strong>IEnumerable&lt;Comic&gt;</strong> comics = new List&lt;Comic&gt;();&#13;
<strong>IReadOnlyDictionary&lt;int, decimal&gt;</strong> prices = Comic.Prices;</pre>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>When you use the var keyword, you’re telling C# to use an <u><span style="color:#9D9EA0;">implicitly typed</span></u> variable. We saw that same word—implicit—back in <a href="ch08.html#enums_and_collections_organizing_your_da">#enums_and_collections_organizing_your_da</a> when we talked about covariance. It means that C# figures out the types on its own.</p>&#13;
</div>&#13;
<p>with these declarations, which do exactly the same thing:</p>&#13;
<pre data-type="programlisting"><strong>var</strong> numbers = Enumerable.Range(1, 10);&#13;
<strong>var</strong> s = $"The count is {numbers.Count()}";&#13;
<strong>var</strong> comics = new List&lt;Comic&gt;();&#13;
<strong>var</strong> prices = Comic.Prices;</pre>&#13;
<p>And you don’t have to change any of your code. Just replace the types with var and everything works.</p>&#13;
<section data-pdf-bookmark="When you use var, C# figures out the variable’s type automatically" data-type="sect2"><div class="sect2" id="when_you_use_varcomma_chash_figures_out">&#13;
<h2>When you use var, C# figures out the variable’s type automatically</h2>&#13;
<p>Go ahead—try it right now. Comment out the first line of the LINQ query you just wrote, then replace IEnumerable&lt;Comic&gt; with var:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg480.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>The IDE figured out the mostExpensive variable’s type—and it’s a type we haven’t seen before. Remember in <a href="ch07.html#interfacescomma_castingcomma_and_quotati">#interfacescomma_castingcomma_and_quotati</a> when we talked about how interfaces can extend other interfaces? The IOrderedEnumerable interface is part of LINQ—it’s used to represent a <em>sorted</em> sequence—and it extends the IEnumerable&lt;T&gt; interface. Try commenting out the <code>orderby</code> clause and hovering over the mostExpensive variable—you’ll find that it turns into an IEnumerable&lt;Comic&gt;. That’s because C# looks at the code to <strong><em>figure out the type of any variable you declare with</em></strong> <strong><em>var</em></strong>.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="linq_magnets">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/code.png"/></span> LINQ magnets</h5>&#13;
<p>We had a nice LINQ query that used the var keyword arranged with magnets on the refrigerator—but someone slammed the door and the magnets fell off! Rearrange the magnets so they produce the output at the bottom of the page.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg481.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p><strong>Output:</strong></p>&#13;
<p><strong>Get your kicks on route 66</strong></p>&#13;
</div></aside>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="linq_magnets_solution">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/code.png"/></span> LINQ Magnets Solution</h5>&#13;
<p>Rearrange the magnets so they produce the output at the bottom of the page.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg482.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p><strong>Output:</strong></p>&#13;
<p><strong>Get your kicks on route 66</strong></p>&#13;
</div></aside>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg483.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p><a data-primary="null" data-type="indexterm" id="idm46402340858968"/><strong>You really can use var in your variable declarations.</strong></p>&#13;
<p>And yes, it really is that simple. A lot of C# developers declare local variables using var almost all the time, and include the type only when it makes the code easier to read. As long as you’re declaring the variable and initializing it in the same statement, you can use var.</p>&#13;
<p>But there are some important restrictions on using var. For example:</p>&#13;
<ul>&#13;
<li><p>You can only declare one variable at a time with var.</p></li>&#13;
<li><p>You can’t use the variable you’re declaring in the declaration.</p></li>&#13;
<li><p>You can’t declare it equal to <code>null</code>.</p></li>&#13;
</ul>&#13;
<p>If you create a variable named <code>var</code>, you won’t be able to use it as a keyword anymore:</p>&#13;
<ul>&#13;
<li><p>You definitely can’t use var to declare a field or a property—you can only use it as a local variable inside a method.</p></li>&#13;
<li><p>If you stick to those ground rules, you can use var pretty much anywhere.</p></li>&#13;
</ul>&#13;
<p><strong>So when you did this in <a href="ch04.html#types_and_references_getting_the_referen">#types_and_references_getting_the_referen</a>:</strong></p>&#13;
<pre data-type="programlisting">int hours = 24;&#13;
short RPM = 33;&#13;
long radius = 3;&#13;
char initial = 'S';&#13;
int balance = 345667 - 567;</pre>&#13;
<p><strong>Or this in <a href="ch06.html#inheritance_your_objectapostrophes_famil">#inheritance_your_objectapostrophes_famil</a>:</strong></p>&#13;
<pre data-type="programlisting">SwordDamage swordDamage = new SwordDamage(RollDice(3));&#13;
ArrowDamage arrowDamage = new ArrowDamage(RollDice(1));</pre>&#13;
<p><strong>Or this in <a href="ch08.html#enums_and_collections_organizing_your_da">#enums_and_collections_organizing_your_da</a>:</strong></p>&#13;
<pre data-type="programlisting">List&lt;Card&gt; cards = new List&lt;Card&gt;();</pre>&#13;
<p><strong>You could have done this:</strong></p>&#13;
<pre data-type="programlisting">var hours = 24;&#13;
var RPM = 33;&#13;
var radius = 3;&#13;
var initial = 'S';&#13;
var balance = 345667 - 567;</pre>&#13;
<p><strong>Or this:</strong></p>&#13;
<pre data-type="programlisting">var swordDamage = new SwordDamage(RollDice(3));&#13;
var arrowDamage = new ArrowDamage(RollDice(1));</pre>&#13;
<p><strong>Or this:</strong></p>&#13;
<pre data-type="programlisting">var cards = new List&lt;Card&gt;();</pre>&#13;
<p><strong>...and your code would have worked exactly the same.</strong></p>&#13;
<p><strong>But you <u>can’t</u> use var to declare a field or property:</strong></p>&#13;
<pre data-type="programlisting">class Program&#13;
{&#13;
   static <span style="color:#9D9EA0;">var</span> random = new Random(); <span style="color:#9D9EA0;">// this will cause a compiler error</span>&#13;
&#13;
   static void Main(string[] args)&#13;
   {</pre>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="there_are_no_dumb_qustions-idd0001">&#13;
<h5>there are no Dumb Questions</h5>&#13;
<p><a data-primary="foreach loops" data-secondary="from clause in LINQ queries compared to" data-type="indexterm" id="idm46402340834232"/><a data-primary="var keyword" data-type="indexterm" id="idm46402340833048"/><strong>Q: How does the <code>from</code> clause work?</strong></p>&#13;
<p><strong>A:</strong> It’s a lot like the first line of a <code>foreach</code> loop. One thing that makes thinking about LINQ queries a little tricky is that you’re not just doing one operation. A LINQ query does the same thing over and over again for each item in a collection—in other words, it enumerates the sequence. So the <code>from</code> clause does two things: it tells LINQ which collection to use for the query, and it assigns a name to use for each member of the collection that’s being queried.</p>&#13;
<p>The way the <code>from</code> clause creates a new name for each item in the collection is really similar to how a <code>foreach</code> loop does it.</p>&#13;
<p>Here’s the first line of a <code>foreach</code> loop:</p>&#13;
<p><code>foreach (int i in values)</code></p>&#13;
<p>That <code>foreach</code> loop temporarily creates a variable called <code>i</code> which it assigns sequentially to each item in the values collection. Now look at a <code>from</code> clause in a LINQ query on the same collection:</p>&#13;
<pre data-type="programlisting">from i in values</pre>&#13;
<p>That clause does pretty much the same thing. It creates a range variable called <code>i</code> and assigns it sequentially to each item in the values collection. The <code>foreach</code> loop runs the same block of code for each item in the collection, while the LINQ query applies the same criteria in the <code>where</code> clause to each item in the collection to determine whether or not to include it in the results.</p>&#13;
<p><strong>Q: You took a LINQ query that returned a sequence of Comic references and made it return strings. What exactly did you do to make that work?</strong></p>&#13;
<p><strong>A</strong>: We modified the <code>select</code> clause. The <code>select</code> clause includes an expression that gets applied to every item in the sequence, and that expression determines the type of the output. So if your query produces a sequence of values or object references, you can use string interpolation in the <code>select</code> clause to turn each item in that sequence into a string. The query in the exercise solution ended with <code>select comic</code>, so it returned a sequence of Comic references. In our “Anatomy of a Query” code, we replaced it with <code>select $"{comic} is worth {Comic.Prices[comic.Issue]:c}"</code>—which caused the query to return a sequence of strings instead.</p>&#13;
<p><strong>Q: How does LINQ decide what goes into the results?</strong></p>&#13;
<p><strong>A</strong>: That’s what the <code>select</code> clause is for. Every LINQ query returns a sequence, and every item in that sequence is of the same type. It tells LINQ exactly what that sequence should contain. When you’re querying an array or list of a single type—like an array of ints or a List&lt;string&gt;—it’s obvious what goes into the <code>select</code> clause. What if you’re selecting from a list of Comic objects? You could do what Jimmy did and select the whole class. You could also change the last line of the query to <code>select comic.Name</code> to tell it to return a sequence of strings. Or you could do <code>select comic.Issue</code> and have it return a sequence of ints.</p>&#13;
<p><strong>Q: I understand how to use var in my code, but how does it actually work?</strong></p>&#13;
<p><strong>A:</strong> <code>var</code> is a keyword that tells the compiler to figure out the type of a variable at compilation time. The C# compiler figures out the type of the local variable that you’re using LINQ to query. When you build your solution, the compiler will replace var with the right type for the data you’re working with.</p>&#13;
<p>So when this line is compiled:</p>&#13;
<pre data-type="programlisting">var result = from v in values</pre>&#13;
<p>The compiler replaces var with this:</p>&#13;
<pre data-type="programlisting">IEnumerable&lt;int&gt;</pre>&#13;
<p>And you can always check a variable’s type by hovering over it in the IDE.</p>&#13;
<blockquote>&#13;
<p><strong>The <span style="color:#9D9EA0;"><strong>from</strong></span> clause in a LINQ query does two things: it tells LINQ which collection to use for the query, and it assigns a name to use for each member of the collection being queried.</strong></p>&#13;
</blockquote>&#13;
<p><strong>Q: LINQ queries use a lot of keywords I haven’t seen before—<strong><code>from</code></strong>, <code>where</code>, <code>orderby</code>, <code>select</code>...it’s like a whole different language. Why does it look so different from the rest of C#?</strong></p>&#13;
<p><strong>A:</strong> Because LINQ serves a different purpose. Most of the C# syntax was built to do one small operation or calculation at a time. You can start a loop, set a variable, do a mathematical operation, call a method...those are all single operations. For example:</p>&#13;
<pre data-type="programlisting">var under10 =&#13;
 from number in sequenceOfNumbers&#13;
 where number &lt; 10&#13;
 select number;</pre>&#13;
<p>That query looks pretty simple—not a lot of stuff there, right? But this is actually a pretty complex piece of code.</p>&#13;
<p>Think about what’s got to happen for the program to actually select all the numbers from sequenceOfNumbers (which must be a reference to an object that implements IEnumerable&lt;T&gt;) that are less than 10. First, it need s to loop through the entire array. Then, each number is compared to 10. Then those results need to be gathered together so the rest of the code can use them.</p>&#13;
<p>And that’s why LINQ looks a little odd: because it lets you cram a whole lot of behavior into a small—but easily readable!—amount of C# code.</p>&#13;
</div></aside>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="bullet_points-idd0020">&#13;
<h5>Bullet Points</h5>&#13;
<ul>&#13;
<li><p><a data-primary="LINQ (Language Integrated Query)" data-secondary="difference from most of C# syntax" data-type="indexterm" id="idm46402340801144"/>When a class implements IEnumerable&lt;T&gt;, any instance of that class is a <strong>sequence</strong>.</p></li>&#13;
<li><p>When you add <code>using System.Linq;</code> to the top of your code, you can use <strong>LINQ methods</strong> with any reference to a sequence.</p></li>&#13;
<li><p>When a method goes through each item in a sequence in order, that’s called <strong>enumerating</strong> the sequence, which is how LINQ methods work.</p></li>&#13;
<li><p>The <strong>Take method</strong> takes the first elements from a sequence. The <strong>TakeLast method</strong> takes the last elements from a sequence. The <strong>Concat method</strong> concatenates two sequences together.</p></li>&#13;
<li><p>The <strong>Average method</strong> returns the average value of a sequence of numbers. The <strong>Min and Max methods</strong> return the smallest and largest values in the sequence.</p></li>&#13;
<li><p>The <strong>First and Last methods</strong> return the first or last element in a sequence.The <strong>Skip method</strong> skips the first elements of a sequence and returns the rest.</p></li>&#13;
<li><p>Many LINQ methods return a sequence, which lets you do <strong>method chaining</strong>, or calling another LINQ method directly on the results without using an extra variable to keep track of those results.</p></li>&#13;
<li><p>The <strong>IReadOnlyDictionary interface</strong> is useful for encapsulation. You can assign any dictionary to it to create a reference that doesn’t allow the dictionary to be updated.</p></li>&#13;
<li><p>The <strong>LINQ declarative query syntax</strong> uses special keywords—including <code>where</code>, <code>select</code>, <code>groupby</code>, and <code>join</code>—to build queries directly into your code.</p></li>&#13;
<li><p>LINQ queries start with a <code><strong>from</strong> clause</code>, which assigns a variable to stand in for each value as it enumerates the sequence.</p></li>&#13;
<li><p>The variable declared in the <code>from</code> clause is the <strong>range variable</strong>, and it can be used throughout the query.</p></li>&#13;
<li><p>A <code>where</code> <strong>clause</strong> contains a conditional test that the query uses to determine which values to include in the results.</p></li>&#13;
<li><p>An <strong><code>orderby</code> clause</strong> contains an expression used to sort the results. You can optionally specify the <code><strong>descending</strong></code> keyword to reverse the sort order.</p></li>&#13;
<li><p>The query ends with a <code><strong>select</strong></code> <strong>clause</strong> that includes an expression to specify what to include in the results.</p></li>&#13;
<li><p>The <strong><code>var</code> keyword</strong> is used to declare an implicitly typed variable, which means the C# compiler figures out the type of the variable on its own.</p></li>&#13;
<li><p>You can use var <strong>in place of a variable type</strong> in any declaration statement that initializes a variable.</p></li>&#13;
<li><p>You can include <strong>a C# expression in a <code>select</code></strong> <strong>clause</strong>. That expression is applied to every element in the results, and determines the type of sequence returned by the query.</p></li>&#13;
</ul>&#13;
</div></aside>&#13;
</div></section>&#13;
</div></section>&#13;
<section data-pdf-bookmark="LINQ is versatile" data-type="sect1"><div class="sect1" id="linq_is_versatile">&#13;
<h1>LINQ is <u>versatile</u></h1>&#13;
<p><a data-primary="collections" data-secondary="performing calculations on" data-type="indexterm" id="idm46402340769720"/><a data-primary="LINQ (Language Integrated Query)" data-secondary="modifying items" data-type="indexterm" id="idm46402340768712"/><a data-primary="LINQ (Language Integrated Query)" data-secondary="performing calculations on collections" data-type="indexterm" id="idm46402340767432"/>With LINQ, you can do a lot more than just pull a few items out of a collection. You can modify the items before you return them. Once you’ve generated a set of result sequences, LINQ gives you a bunch of methods that work with them. Top to bottom, LINQ gives you the tools you need to manage your data. Let’s do a quick review of some of the LINQ features that we’ve already seen.</p>&#13;
<ul>&#13;
<li><p><strong>Modify every item returned from the query.</strong></p>&#13;
<p>This code will add a string onto the end of each element in an array of strings. It doesn’t change the array itself—it creates a new sequence of modified strings.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg486-1.png"/>&#13;
<h6/>&#13;
</div></figure></li>&#13;
<li><p><strong>Perform calculations on sequences.</strong></p>&#13;
<p>You can use the LINQ methods on their own to get statistics about a sequence of numbers.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><strong>The static <span style="color:#9D9EA0;"><u>String.Join</u></span> method concatenates all of the items in a sequence into a string, specifying the separator to use between them.</strong></p>&#13;
</div>&#13;
<pre data-type="programlisting">var random = new Random();&#13;
var numbers = new List&lt;int&gt;();&#13;
int length = random.Next(50, 150);&#13;
for (int i = 0; i &lt; length; i++)&#13;
    numbers.Add(random.Next(100));&#13;
&#13;
Console.WriteLine($@"Stats for these {numbers.Count()} numbers:&#13;
The first 5 numbers: {String.Join(", ", numbers.Take(5))}&#13;
The last 5 numbers: {String.Join(", ", numbers.TakeLast(5))}&#13;
The first is {numbers.First()} and the last is {numbers.Last()}&#13;
The smallest is {numbers.Min()}, and the biggest is {numbers.Max()}&#13;
The sum is {numbers.Sum()}&#13;
The average is {numbers.Average():F2}");</pre>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg486-2.png"/>&#13;
<h6/>&#13;
</div></figure></li>&#13;
</ul>&#13;
</div></section>&#13;
<section data-pdf-bookmark="LINQ queries aren’t run until you access their results" data-type="sect1"><div class="sect1" id="linq_queries_arenapostrophet_run_until_y">&#13;
<h1>LINQ queries aren’t run until you access their results</h1>&#13;
<p><a data-primary="deferred evaluation" data-type="indexterm" id="idm46402340753896"/>When you include a LINQ query in your code, it uses <strong>deferred evaluation</strong> (sometimes called lazy evaluation). That means the LINQ query doesn’t actually do any enumerating or looping until your code executes a statement that <strong><em>uses the results of the query</em></strong>. That sounds a little weird, but it makes a lot more sense when you see it in action. <strong>Create a new console app</strong> and add this code:</p>&#13;
<p><strong><em>Do this!</em></strong></p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg487-1.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><strong><span style="color:#9D9EA0;">Did you get a weird compiler error? Make sure you added the two <u>using directives</u> to your code!</span></strong></p>&#13;
</div>&#13;
<pre data-type="programlisting">    class PrintWhenGetting&#13;
    {&#13;
        private int instanceNumber;&#13;
        public int InstanceNumber&#13;
        {&#13;
            set { instanceNumber = value; }&#13;
            get&#13;
            {&#13;
                Console.WriteLine($"Getting #{instanceNumber}");&#13;
                return instanceNumber;&#13;
            }&#13;
        }&#13;
    }&#13;
    &#13;
    class Program&#13;
    {&#13;
        static void Main(string[] args)&#13;
        {&#13;
            var listOfObjects = new List&lt;PrintWhenGetting&gt;();&#13;
            for (int i = 1; i &lt; 5; i++)&#13;
                listOfObjects.Add(new PrintWhenGetting() { InstanceNumber = i });&#13;
    &#13;
            Console.WriteLine("Set up the query");&#13;
            var result =&#13;
                from o in listOfObjects&#13;
                select o.InstanceNumber;&#13;
    &#13;
            Console.WriteLine("Run the foreach");&#13;
            foreach (var number in result)&#13;
                Console.WriteLine($"Writing #{number}");&#13;
        }&#13;
    }</pre>&#13;
<p>Now run your app. Notice how the Console.WriteLine that prints <code>"Set up the query"</code> runs <strong><em>before</em></strong> the get accessor ever executes. That’s because the LINQ query won’t get executed until the <code>foreach</code> loop.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg487-2.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>If you need the query to execute right now, you can force <strong>immediate execution</strong> by calling a LINQ method that needs to enumerate the entire list—for example, the ToList method, which turns it into a List&lt;T&gt;. Add this line, and change the foreach to use the new List:</p>&#13;
<pre data-type="programlisting">        <strong>var immediate = result.ToList();</strong>&#13;
&#13;
<span style="color:#9D9EA0;">        Console.WriteLine("Run the foreach");</span>&#13;
<span style="color:#9D9EA0;">        foreach (var number in <strong>immediate)</strong></span>&#13;
<span style="color:#9D9EA0;">            Console.WriteLine($"Writing #{number}");</span></pre>&#13;
<p>Run the app again. This time you’ll see the get accessors called before the <code>foreach</code> loop starts executing—which makes sense, because ToList needs to access every element in the sequence to convert it to a List. Methods like Sum, Min, and Max also need to access every element in the sequence, so when you use them you’ll force LINQ to do immediate execution as well.</p>&#13;
</div></section>&#13;
<section data-pdf-bookmark="Use a group query to separate your sequence into groups" data-type="sect1"><div class="sect1" id="use_a_group_query_to_separate_your_seque">&#13;
<h1>Use a group query to separate your sequence into groups</h1>&#13;
<p><a data-primary="LINQ (Language Integrated Query)" data-secondary="group queries" data-type="indexterm" id="idm46402340733720"/>Sometimes you really want to slice and dice your data. For example, Jimmy might want to group his comics by the decade they were published. Or maybe he wants to separate them by price (cheap ones in one collection, expensive ones in another). There are lots of reasons you might want to group your data together. That’s where the <strong>LINQ group query</strong> comes in handy.</p>&#13;
<p><strong><em>Group this!</em></strong></p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg488.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<ol>&#13;
<li><p><strong>Create a new console app and add the card classes and enums.</strong></p>&#13;
<p>Create a <strong>new .NET Core console app named <em>CardLinq</em></strong>. Then go to the Solution Explorer panel, right-click on the project name, and choose Add &gt;&gt; Existing Items (or Add &gt;&gt;Existing Files on a Mac). Navigate to the folder where you saved the Two Decks project from <a href="ch08.html#enums_and_collections_organizing_your_da">#enums_and_collections_organizing_your_da</a>. Add the files with the <strong>Suit and Value enums</strong>, then add the <strong>Deck, Card, and CardComparerByValue classes</strong>.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><strong>You created the Deck class in the downloadable “Two Decks” project at the end of <a href="ch08.html#enums_and_collections_organizing_your_da">#enums_and_collections_organizing_your_da</a>.</strong></p>&#13;
</div>&#13;
<p>Make sure you <strong>modify the namespace in each file you added</strong> to match the namespace in <em>Program.cs</em> so your Main method can access the classes you added.</p>&#13;
</li>&#13;
<li><p><strong>Make your Card class sortable with IComparable&lt;T&gt;.</strong></p>&#13;
<p>We’ll be using a LINQ <code>orderby</code> clause to sort groups, so we need the Card class to be sortable. Luckily, this works exactly like the List.Sort method, which you learned about in <a href="ch07.html#interfacescomma_castingcomma_and_quotati">#interfacescomma_castingcomma_and_quotati</a>. Modify your Card class to <strong>extend the IComparable interface</strong>:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg487-2a.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
</li>&#13;
<li><p><strong>Modify the Deck.Shuffle method to support method chaining.</strong></p>&#13;
<p>The Shuffle class shuffles the deck. All you need to do to make it support method chaining is modify it to return a reference to the Deck instance that just got shuffled:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg489-1.png"/>&#13;
<h6/>&#13;
</div></figure></li>&#13;
<li><p><strong>Use a LINQ query with group...by clause to group the cards by suit.</strong></p>&#13;
<p>The Main method will get 16 random cards by shuffling the deck, then using the LINQ Take method to pull the first 16 cards. Then it will use a LINQ query with a <code>group...by</code> <strong>clause</strong> to separate the deck into smaller sequences, with one sequence for each suit in the 16 cards:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg489-2.png"/>&#13;
<h6/>&#13;
</div></figure></li>&#13;
</ol>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="ide_tip_rename_anythingexclamation_mark">&#13;
<h5>IDE Tip: Rename anything!</h5>&#13;
<p>When you need to change the name of a variable, field, property, namespace, or class, you can use a really handy <strong>refactoring tool</strong> built into Visual Studio. Just right-click on it and choose “Rename...” from the menu. When the IDE highlights it, edit its  name—and the IDE will <em>automatically rename it everywhere in the code</em>.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg489-3.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>Use Rename to change the name of a <strong>variable, field, property, class, or namespace</strong> (and a few other things, too!). When you rename one occurrence, the IDE changes its name everywhere it occurs in the code.</p>&#13;
</div></aside>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="anatomy_of_a_group_query">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/icon4.png"/></span> Anatomy of a group query</h5>&#13;
<p><a data-primary="group by clause (LINQ)" data-type="indexterm" id="idm46402340698792"/>Let’s take a closer look at how that group query works.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg490.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
</div></aside>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><strong>The group...by clause creates a sequence of groups that implement the IGrouping interface. IGrouping extends IEnumerable and adds exactly one member: a property called Key. So each group is a sequence of other sequences—in this case, it’s a group of Card sequences, where the key is the suit of the card (from the <code>Suits</code> enum). The full type of each group is IGrouping&lt;Suits, Card&gt;, which means it’s a sequence of Card sequences, each of which has a Suits value as its key.</strong></p>&#13;
</div>&#13;
</div></section>&#13;
<section data-pdf-bookmark="Use join queries to merge data from two sequences" data-type="sect1"><div class="sect1" id="use_join_queries_to_merge_data_from_two">&#13;
<h1>Use join queries to merge data from two sequences</h1>&#13;
<p><a data-primary="collections" data-secondary="using join to combine into one query" data-type="indexterm" id="idm46402340689048"/><a data-primary="join clause (LINQ)" data-type="indexterm" id="idm46402340693512"/><a data-primary="LINQ (Language Integrated Query)" data-secondary="join queries" data-type="indexterm" id="idm46402340692744"/><a data-primary="LINQ (Language Integrated Query)" data-secondary="using join to combine two collections into one query" data-type="indexterm" id="idm46402340691656"/><a data-primary="on…equals clause (LINQ)" data-type="indexterm" id="idm46402340687608"/>Every good collector knows that critical reviews can have a big impact on values. Jimmy’s been keeping track of reviewer scores from two big comic review aggregators, MuddyCritic and Rotten Tornadoes. Now he needs to match them up to his collection. How’s he going to do that?</p>&#13;
<p>LINQ to the rescue! Its <code>join</code> keyword lets you <strong>combine data from two sequences</strong> using a single query. It does it by comparing items in one sequence with their matching items in a second sequence. (LINQ is smart enough to do this efficiently—it doesn’t actually compare every pair of items unless it has to.) The final result combines every pair that matches.</p>&#13;
<ol>&#13;
<li><p>You’ll start your query with the usual <code>from</code> clause. But instead of following it up with the criteria to determine what goes into the results, you’ll add:</p>&#13;
<pre data-type="programlisting">join name in collection</pre>&#13;
<p>The <code>join</code> clause tells LINQ to enumerate both sequences to match up pairs with one member from each. It assigns <code>name</code> to the member it’ll pull out of the joined collection in each iteration. You’ll use that name in the <code>where</code> clause.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg491.png"/>&#13;
<h6/>&#13;
</div></figure></li>&#13;
<li><p>Next you’ll add the <code><strong>on</strong></code> clause, which tells LINQ how to match the two collections together. You’ll follow it with the name of the member of the first collection you’re matching, followed by <code><strong>equals</strong></code> and the name of the member of the second collection to match it up with.</p></li>&#13;
<li><p>You’ll continue the LINQ query with <code><strong>where</strong></code> and <code><strong>orderby</strong></code> clauses as usual. You could finish it with a normal <code><strong>select</strong></code> clause, but you usually want to return results that pull some data from one collection and other data from the other.</p></li>&#13;
</ol>&#13;
<p>The result is a sequence of objects that have Name and Issue properties from Comic, but Critic and Score properties from Review. The result can’t be a sequence of Comic objects, but it also can’t be a sequence of Review objects, because neither class has all of those properties. The result is a <u>different</u> kind of type: <strong><em>an anonymous type.</em></strong></p>&#13;
</div></section>&#13;
<section data-pdf-bookmark="Use the new keyword to create anonymous types" data-type="sect1"><div class="sect1" id="use_the_new_keyword_to_create_anonymous">&#13;
<h1>Use the <u>new</u> keyword to create anonymous types</h1>&#13;
<p><a data-primary="anonymous, defined" data-type="indexterm" id="idm46402340669224"/><a data-primary="anonymous types" data-type="indexterm" id="idm46402340668600"/><a data-primary="new keyword" data-secondary="using to create anonymous types" data-type="indexterm" id="idm46402340667832"/>You’ve been using the <code>new</code> keyword since <a href="ch03.html#objectshellipget_orientedexclamation_mar">#objectshellipget_orientedexclamation_mar</a> to create instances of objects. Every time you use it, you include a type (so the statement <code>new Guy();</code> creates an instance of the type Guy). You can also use the <code>new</code> keyword without a type to create an <strong>anonymous type</strong>. That’s a perfectly valid type that has read-only properties, but doesn’t have a name. The type we returned from the query that joined Jimmy’s comics to reviews is an anonymous type. You can add properties to your anonymous type by using an object initializer. Here’s what that looks like:</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="a_non_y_mouscomma_adjectivedot">&#13;
<h5>a-non-y-mous, adjective.</h5>&#13;
<p>not identified by name. <em>Secret Agent Dash Martin used his alias to become <strong>anonymous</strong> and keep the enemy spies from recognizing him.</em></p>&#13;
</div></aside>&#13;
<pre data-type="programlisting">public class Program&#13;
{&#13;
    public static void Main()&#13;
    {&#13;
        var whatAmI = new { Color = "Blue", Flavor = "Tasty", Height = 37 };&#13;
        Console.WriteLine(whatAmI);&#13;
    }&#13;
}</pre>&#13;
<p>Try pasting that into a new console app and running it. You’ll see this output:</p>&#13;
<pre data-type="programlisting">{ Color = Blue, Flavor = Tasty, Height = 37 }</pre>&#13;
<p>Now hover over <code>whatAmI</code> in the IDE and have a look at the IntelliSense window:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg492-2a.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><strong>The LINQ query we just saw that joins Jimmy’s comics with reviews returns an anonymous type. You’ll add that query to an app later in the chapter.</strong></p>&#13;
</div>&#13;
<p>The <code>whatAmI</code> variable is a reference type, just like any other reference. It points to an object on the heap, and you can use it to access that object’s members—in this case, two of its properties:</p>&#13;
<pre data-type="programlisting">Console.WriteLine($"My color is {whatAmI.Color} and I’m {whatAmI.Flavor}");</pre>&#13;
<p>Besides the fact that they don’t have names, anonymous types are <u>just like any other types.</u></p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg492-2.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p><strong>Right! You use var to declare anonymous types.</strong></p>&#13;
<p>In fact, that’s one of the most important uses of the <u><code>var</code></u> keyword.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="sharpen_your_pencil-idd0035">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/pencil.png"/></span> Sharpen your pencil</h5>&#13;
<p><a data-primary="exercises" data-secondary="Sharpen your pencil" data-tertiary="LINQ" data-type="indexterm" id="idm46402340645432"/><a data-primary="LINQ (Language Integrated Query)" data-secondary="exercises on" data-type="indexterm" id="idm46402340643800"/><a data-primary="Sharpen Your Pencil exercises" data-secondary="LINQ" data-type="indexterm" id="idm46402340642680"/>Joe, Bob, and Alice are some of the top competitive Go Fish players in the world. This LINQ code joins two arrays with anonymous types to generate a list of their winnings. Read through the code and write the output that it writes to the console.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg493.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
</div></aside>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="sharpen_your_pencil_solution-idd019">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/Common.png"/></span> Sharpen your pencil Solution</h5>&#13;
<p><a data-primary="LINQ (Language Integrated Query)" data-secondary="var keyword and" data-type="indexterm" id="idm46402340636616"/><a data-primary="var keyword" data-type="indexterm" id="idm46402340635304"/>Joe, Bob, and Alice are some of the top competitive Go Fish players in the world. This LINQ code joins two arrays with anonymous types to generate a list of their winnings. Read through the code and write the output that it writes to the console.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg495-1a.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
</div></aside>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="there_are_no_dumb_questions-idd0029">&#13;
<h5>there are no Dumb Questions</h5>&#13;
<p><strong>Q: Can you rewind a minute and explain what <code>var</code> is again?</strong></p>&#13;
<p><strong>A:</strong> Yes, definitely. The <code>var</code> keyword solves a tricky problem that LINQ brings with it. Normally, when you call a method or execute a statement, it’s absolutely clear what types you’re working with. If you’ve got a method that returns a string, for instance, then you can only store its results in a string variable or field.</p>&#13;
<p>But LINQ isn’t quite so simple. When you build a LINQ statement, it might return an anonymous type that <em>isn’t defined anywhere in your program</em>. Yes, you know that it’s going to be a sequence of some sort. But what kind of sequence will it be? You don’t know—because the objects that are contained in the sequence depend entirely on what you put in your LINQ query. Take this query, for example, from the code we wrote earlier for Jimmy. We originally wrote this:</p>&#13;
<pre data-type="programlisting">IEnumerable&lt;Comic&gt; mostExpensive =&#13;
      from comic in Comic.Catalog&#13;
      where Comic.Prices[comic.Issue] &gt; 500&#13;
      orderby -Comic.Prices[comic.Issue]&#13;
      select comic;</pre>&#13;
<p>But then we changed the first line to use the <code>var</code> keyword:</p>&#13;
<pre data-type="programlisting"> var mostExpensive =</pre>&#13;
<p>And that’s useful. For example, if we changed the last line to this:</p>&#13;
<pre data-type="programlisting">      select new {&#13;
         Name = comic.Name,&#13;
         IssueNumber = $"#{comic.Issue}"&#13;
       };</pre>&#13;
<p>the updated query would return a different (but perfectly valid!) type—an anonymous type with two members, a string called Name and a string called IssueNumber. But we don’t have a class definition for that type anywhere in our program! You don’t actually need to run the program to see exactly how that type is defined, but the <code>mostExpensive</code> variable still needs to be declared with <em>some</em> type.</p>&#13;
<p>That’s why C# gives us the <code>var</code> keyword, which tells the compiler, “OK, we know that this is a valid type, but we can’t exactly tell you what it is right now. So why don’t you just figure that out yourself and not bother us with it? Thanks so much.”</p>&#13;
</div></aside>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="ide_tip_refactoring_tool">&#13;
<h5>IDE Tip: Refactoring tool</h5>&#13;
<p><strong>Switch variables between implicit and explicit types</strong></p>&#13;
<p>When you’re working with group queries, you’ll often use the <code>var</code> keyword—not just because it’s convenient, but because the type returned by the group query can be a little cumbersome.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg495-1.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>But sometimes our code is actually easier to understand if we use the <strong>explicit type</strong>. Luckily, the IDE makes it easy to switch between the implicit type (<code>var</code>) and the explicit type for any variable. Just open the Quick Actions menu and choose “<strong>Use explicit type instead of ‘var’”</strong> to convert the var to its explicit type.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg495-2.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>You can also choose “<strong>Use implicit type”</strong> from the Quick Actions menu to change the variable back to <code>var</code>.</p>&#13;
<p><strong>Extract methods</strong></p>&#13;
<p>Your code will often be easier to read if you take a large method and break it into smaller ones. That’s why one of the most common ways that developers refactor code is <strong><em>extracting methods</em></strong>, or taking a block of code from a large method and moving it into its own method. The IDE gives you a really useful refactoring tool to make that easy.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg495-3.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>Start by selecting a block of code.Then <strong>choose Refactor &gt;&gt; Extract Method</strong> from the Edit menu (on Windows) or <strong>Extract Method</strong> (on a Mac) from the Quick Actions.</p>&#13;
<p>As soon as you do, the IDE moves the selected code into a new method called NewMethod with a return type that matches the type of the code that’s returned. Then it immediately jumps into the Rename feature so you can start typing a new method name.</p>&#13;
<p>In this screenshot, we selected the entire LINQ query from the card grouping project earlier in the chapter. After we extracted the method, this is what it looked like:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg495-4.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>Notice that it left a new explicitly typed <strong>grouped</strong> variable—the IDE figured out that the variable is used later in the code and left a variable in place. That’s yet another example of how the IDE helps write cleaner code.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg495-5.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
</div></aside>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="there_are_no_dumb_questions-idd0030">&#13;
<h5>there are no Dumb Questions</h5>&#13;
<p><a data-primary="anonymous types" data-type="indexterm" id="idm46402340596600"/><a data-primary="join clause (LINQ)" data-type="indexterm" id="idm46402340595624"/><a data-primary="LINQ (Language Integrated Query)" data-secondary="join queries" data-type="indexterm" id="idm46402340594824"/><a data-primary="on…equals clause (LINQ)" data-type="indexterm" id="idm46402340593672"/><a data-primary="var keyword" data-type="indexterm" id="idm46402340592872"/><strong>Q: Can you give me a little more detail on how <code>join</code> works?</strong></p>&#13;
<p><strong>A:</strong> <code>join</code> works with any two sequences. Let’s say you’re printing t-shirts for football players, using a collection called <code>players</code> with objects that have a Name property and a Number property. What if you need a different design for players with double-digit numbers? You could pull out the players with numbers greater than 10:</p>&#13;
<pre data-type="programlisting">    var doubleDigitPlayers =&#13;
       from player in players&#13;
       where player.Number &gt; 10&#13;
       select player;</pre>&#13;
<p>Now what if you need to get their shirt sizes? If you have a sequence called <code>jerseys</code> whose items have a Number property and a Size property, a join would work really well for combining the data:</p>&#13;
<pre data-type="programlisting">    var doubleDigitShirtSizes =&#13;
       from player in players&#13;
       where player.Number &gt; 10&#13;
       join shirt in jerseys&#13;
       on player.Number equals shirt.Number&#13;
       select shirt;</pre>&#13;
<p><strong>Q: That query will just give me a bunch of objects. What if I want to connect each player to their shirt size, and I don’t care about the number at all?</strong></p>&#13;
<p><strong>A:</strong> That’s what <strong>anonymous types</strong> are for—you can construct an anonymous type that only has the data you want in it. It lets you pick and choose from the various collections that you’re joining together, too.</p>&#13;
<p>So you can select the player’s name and the shirt’s size, and nothing else:</p>&#13;
<pre data-type="programlisting">   var doubleDigitShirtSizes =&#13;
       from player in players&#13;
       where player.Number &gt; 10&#13;
       join shirt in jerseys&#13;
       on player.Number equals shirt.Number&#13;
       select new {&#13;
           player.Name,&#13;
           shirt.Size&#13;
       };</pre>&#13;
<p>The IDE is smart enough to figure out exactly what results you’ll be creating with your query. If you create a loop to enumerate through the results, as soon as you type the variable name the IDE will pop up an IntelliSense list:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg496.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>Notice how the list has Name and Size in it. If you added more items to the <code>select</code> clause, they’d show up in the list too, because the query would create a different anonymous type with different members.</p>&#13;
<p><strong>Q: How do I write a method that returns an anonymous type?</strong></p>&#13;
<p><strong>A:</strong> You don’t. Methods cannot return anonymous types. C# doesn’t give you a way to do that. You can’t declare a field or a property with an anonymous type, either. You also can’t use an anonymous type for a parameter in a method or a constructor—that’s why you can’t use the <code>var</code> keyword with any of those things.</p>&#13;
<p>And when you think about it, these things make sense. Whenever you use var in a variable declaration, you always have to include a value, which the C# compiler or IDE uses to figure out the type of the variable. If you’re declaring a field or a method parameter, there’s no way to specify that value—which means there’s no way for C# to figure out the type. (Yes, you can specify a value for a property, but that’s not really the same thing—technically, the value is set just before the constructor is called.)</p>&#13;
<blockquote>&#13;
<p><strong>You can only use the <code><span style="color:#9D9EA0;">var</span></code> keyword when you’re declaring a variable. You can’t use <code><span style="color:#9D9EA0;">var</span></code> with a field or a property, or write a method that returns an anonymous type or takes one as a parameter.</strong></p>&#13;
</blockquote>&#13;
</div></aside>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="exercise-idd0030">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/exercise.png"/></span> Exercise</h5>&#13;
<p>Use what you’ve learned about LINQ so far to <strong>build a new console app called <em>JimmyLinq</em></strong> that organizes Jimmy’s comic collection. Start by <strong>adding a <code>Critics</code> enum</strong> with two members, <code>MuddyCritic</code> and <code>RottenTornadoes</code>, and <strong>a</strong> PriceRange <strong>enum</strong> with two members, <code>Cheap</code> and <code>Expensive</code>. Then <strong>add a Review class</strong> with three automatic properties: int Issue, Critics Critic, and double Score.</p>&#13;
<p>You’ll need data, so add a new static field to the Comic class that returns a sequence of reviews:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg497-01.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>Your job is to <strong>create a static class called ComicAnalyzer</strong> with three static methods (two of which are public):</p>&#13;
<ul>&#13;
<li><p>A private static method called CalculatePriceRange takes a Comic reference and returns PriceRange.Cheap if the price is under 100 and PriceRange.Expensive otherwise.</p></li>&#13;
<li><p>GroupComicsByPrice orders the comics by price, then groups them by CalculatePriceRange(comic) and returns a sequence of groups of comics (IEnumerable&lt;IGrouping&lt;PriceRange, Comic&gt;&gt;).</p></li>&#13;
<li><p>GetReviews orders the comics by issue number, then does the join you saw earlier in the chapter and returns a sequence of strings like this: <code>MuddyCritic rated #74 ‘Black Monday’ 84.20</code></p></li>&#13;
</ul>&#13;
</div></aside>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="exercise_solution-idd0021">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/Common-1.png"/></span> Exercise Solution</h5>&#13;
<p><a data-primary="exercises" data-secondary="LINQ" data-type="indexterm" id="idm46402340555736"/><a data-primary="LINQ (Language Integrated Query)" data-secondary="exercises on" data-type="indexterm" id="idm46402340554504"/>Use what you’ve learned about LINQ so far to <strong>build a new console app called <em>JimmyLinq</em></strong> that organizes Jimmy’s comic collection. Start by <strong>adding a <code>Critics</code> enum</strong> with two members, <code>MuddyCritic</code> and <code>RottenTornadoes</code>, and <strong>a</strong> PriceRange <strong>enum</strong> with two members, <code>Cheap</code> and <code>Expensive</code>. Then <strong>add a Review class</strong> with three automatic properties: int Issue, Critics Critic, and double Score.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg498-01.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p><strong>Once you have those, you can add the static ComicAnalyzer class with a private PriceRange method and public GroupComicsByPrice and GetReviews methods:</strong></p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg498.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p><strong>Did you run into a compiler error about “inconsistent accessibility” telling you the return type is less accessible than the method? That happens when a class is marked public but has members that are internal (the default if you leave off the access modifier). So make sure that <u><span style="color:#9D9EA0;">none of the classes or enums are marked public.</span></u></strong></p>&#13;
</div></aside>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg499.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="bullet_points-idd0021">&#13;
<h5>Bullet Points</h5>&#13;
<ul>&#13;
<li><p><a data-primary="by keyword" data-type="indexterm" id="idm46402340540584"/><a data-primary="group by clause (LINQ)" data-type="indexterm" id="idm46402340537400"/><a data-primary="group clause (LINQ)" data-type="indexterm" id="idm46402340536552"/><a data-primary="join clause (LINQ)" data-type="indexterm" id="idm46402340535688"/><a data-primary="on…equals clause (LINQ)" data-type="indexterm" id="idm46402340534856"/><a data-primary="select clause (LINQ)" data-type="indexterm" id="idm46402340534024"/><a data-primary="select new clause (LINQ)" data-type="indexterm" id="idm46402340533192"/>The <code>group...by</code> clause tells LINQ to group the results together—when you use it, LINQ creates a sequence of group sequences.</p></li>&#13;
<li><p>Every group contains members that have one member in common, called the group’s <strong>key</strong>. Use the <code><strong>by</strong></code> keyword to specify the key for the group. Each group sequence has a <code><strong>Key</strong></code> member that contains the group’s key.</p></li>&#13;
<li><p>Join queries use an <code><strong>on</strong></code>...<code><strong>equals</strong></code> clause to tell LINQ how to match the pairs of items.</p></li>&#13;
<li><p>Use a <code><strong>join</strong></code> clause to tell LINQ to combine two collections into a single query. When you do this, LINQ compares every member of the first collection with every member of the second collection, including the matching pairs in the results.</p></li>&#13;
<li><p>When you’re doing a join query, you usually want a set of results that includes some members from the first collection and other members from the second collection. The <code><strong>select</strong></code> clause lets you build custom results from both of them.</p></li>&#13;
<li><p>Use <code><strong>select new</strong></code> to construct custom LINQ query results with an anonymous type that includes only the specific properties you want in your result sequence.</p></li>&#13;
<li><p>LINQ queries use <strong>deferred evaluation</strong> (sometimes called lazy evaluation), which means they don’t run until a statement uses the results of the query.</p></li>&#13;
<li><p>Use the <code>new</code> keyword to create an instance of an <strong>anonymous type</strong>, or an object with a well-defined type that doesn’t have a name. The members specified in the <code>new</code> statement become automatic properties of the anonymous type.</p></li>&#13;
<li><p>Use the <strong>Rename feature</strong> in Visual Studio to easily rename every instance of a variable, field, property, class, or namespace at once.</p></li>&#13;
<li><p>Use Visual Studio’s Quick Actions menu to change a var declaration to an <strong>explicit type</strong>, or back to a var (or an implicit type) again.</p></li>&#13;
<li><p>One of the most common ways that developers refactor code is <strong>extracting methods</strong>. Visual Studio’s Extract Method feature makes it very easy to move a block of code into its own method.</p></li>&#13;
<li><p>You can <strong>only use the <code>var</code> keyword</strong> when you’re declaring a variable. You can’t write a method that returns an anonymous type, or which takes one as a parameter, or use one with a field or a property.</p></li>&#13;
</ul>&#13;
</div></aside>&#13;
</div></section>&#13;
<section data-pdf-bookmark="Unit tests help you make sure your code works" data-type="sect1"><div class="sect1" id="unit_tests_help_you_make_sure_your_code">&#13;
<h1>Unit tests help you make sure your code works</h1>&#13;
<p><a data-primary="Test Explorer window" data-type="indexterm" id="idm46402340513544"/><a data-primary="Unit Test tool window" data-type="indexterm" id="idm46402340512920"/><a data-primary="Visual Studio" data-secondary="for Mac" data-type="indexterm" id="idm46402340512152"/><a data-primary="Visual Studio" data-secondary="Test Explorer window" data-type="indexterm" id="idm46402340510824"/><a data-primary="Visual Studio" data-secondary="Unit Test tool window" data-type="indexterm" id="idm46402340509848"/>We intentionally left a bug in the code we gave you...but is that the <em>only</em> bug in the app? It’s easy to write code that doesn’t do exactly what you intended it to do. Luckily, there’s a way for us to find bugs so we can fix them. <strong>Unit tests</strong> are <em>automated</em> tests that help you make sure your code does what it’s supposed to do. Each unit test is a method that makes sure that a specific part of the code (the “unit” being tested) works. If the method runs without throwing an exception, it passes. If it throws an exception, it fails. Most large programs have a <strong>suite</strong> of tests that cover most or all of the code.</p>&#13;
<p>Visual Studio has built-in unit testing tools to help you write your tests and track which ones pass or fail. The unit tests in this book will use <strong>MSTest</strong>, a unit test framework (which means that it’s a set of classes that give you the tools to write unit tests) developed by Microsoft.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><span style="color:#9D9EA0;">Visual Studio also supports unit tests written in NUnit and xUnit, two popular open source unit test frameworks for C# and .NET code.</span></p>&#13;
</div>&#13;
<section data-pdf-bookmark="Visual Studio for Windows has a Test Explorer window" data-type="sect2"><div class="sect2" id="visual_studio_for_windows_has_a_test_exp">&#13;
<h2>Visual Studio for Windows has a Test Explorer window</h2>&#13;
<p>Open the Test Explorer window by choosing <strong><em>View &gt;&gt; Test Explorer</em></strong> from the main menu bar. It shows you the unit tests on the left, and the results of the most recent run on the right. The toolbar has buttons to run all tests, run a single test, and repeat the last run.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg500-1.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><strong>When you add unit tests to your solution, you can <strong><code>run</code></strong> your tests by clicking the Run All Tests button. You can <strong><code>debug</code></strong> your unit tests on Windows by choosing Tests &gt;&gt; Debug all tests, and on Mac by clicking Debug All Tests in the Unit Tests tool window.</strong></p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg500-2.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
</div>&#13;
</div></section>&#13;
<section data-pdf-bookmark="Visual Studio for Mac has the Unit Tests tool window" data-type="sect2"><div class="sect2" id="visual_studio_for_mac_has_the_unit_tests">&#13;
<h2>Visual Studio for Mac has the Unit Tests tool window</h2>&#13;
<p>Open the Unit Test pad by choosing <strong><em>View &gt;&gt; Tool Windows &gt;&gt; Unit Tests</em></strong> from the menu bar. It has buttons to run or debug your tests. When you run the unit tests, the IDE displays the results in a Test Results tool window (usually at the bottom of the IDE window).</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg500-3.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><a data-primary="commit, Git" data-type="indexterm" id="idm46402340489640"/><a data-primary="Game design... and beyond elements" data-secondary="Testing" data-type="indexterm" id="idm46402340488184"/><a data-primary="Testing Game design... and beyond element" data-type="indexterm" id="idm46402340487096"/><span style="color:#9D9EA0;">Back in <a href="ch03.html#objectshellipget_orientedexclamation_mar">#objectshellipget_orientedexclamation_mar</a> you learned about prototypes, or early versions of games that you can play, test, learn from, and improve—and you saw how that idea can work with any kind of project, not just games. The same thing applies to testing. Sometimes the idea of testing software can seem a little abstract. Thinking about how game developers test their games can help us get used to the idea, and can make the concept of testing feel more intuitive.</span></p>&#13;
</div>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="testing">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/game.png"/></span> Testing</h5>&#13;
<p><strong>Game design... and beyond</strong></p>&#13;
<p>As soon as you’ve got a playable prototype of your game, you’re ready to think about <strong>video game testing</strong>. Getting people to try out your game and give you feedback on it can make all the difference between a game that everybody loves playing and one that frustrates new users and gives an unsatisfying experience. If you’ve ever played a game that made you feel lost about what you were supposed to be doing, or one where the puzzles seemed unsolvable, then you know what happens when a game doesn’t get enough <strong>play testing</strong>.</p>&#13;
<p>There are a few approaches to game testing you’ll want to think about as you start designing and building games:</p>&#13;
<ul>&#13;
<li><p><strong>Individual play testing:</strong> Ask people you know to play the game, preferably with you watching. The most informal way to do play testing is to just ask a friend to play the game and talk about their experience as they’re playing. Having someone narrate what they think the game is asking them to do and what they think about the gameplay can really help you design an experience that’s accessible and satisfying to other people. Don’t give them very much instruction and pay special attention if your play testers get stuck. That will help you to understand if the point of your game is well understood and will make it easier for you to see if some of the game mechanics you’ve put in place are not obvious enough to a user. Write down all of the feedback testers give you so you can fix any design problems that they identify.</p>&#13;
<p>Getting individual feedback can be done informally or in a more formal setting where you’ve drawn up a list of tasks you want the user to perform and a <strong>questionnaire</strong> to capture feedback about the game. It should be done frequently as you’re adding new features, and you should ask people to play test your game as early in development as possible to make sure you find design problems when they are easiest to fix.</p></li>&#13;
<li><p><strong>Beta programs:</strong> When you are ready to have a larger audience check out the game you can ask a larger group of people to play it before you open it up to the general public. Beta programs are great for finding problems with load and performance in your game. Usually feedback from beta programs is analyzed through game logs. You can log the time it takes for users to accomplish various activities in your game and use those logs to find problems with how the game allocates resources. Sometimes areas that are not well understood by users in the game will show up this way too. Usually, you’ll have play testers sign up for a beta test, so you can ask them about their experience afterward and get their help troubleshooting issues you find in the log.</p></li>&#13;
<li><p><strong>Structured quality assurance tests:</strong> Most games have dedicated tests that are run as part of development. Usually these tests are based on an understanding of how the game is supposed to work, and they can be automated or manual. The goal of this kind of testing is to make sure that the product works as intended. When a quality assurance test is run, the idea is to find as many bugs as possible before a user has to deal with them. Those bugs get written down with clear step-by-step instructions so they can be replicated and fixed. Then they get triaged in order of how much they will impact the player’s experience with the game and fixed based on that priority. If a game crashes every time a user walks into a room, that bug will probably get fixed before a bug where a weapon isn’t rendered correctly in that same room.</p></li>&#13;
</ul>&#13;
</div></aside>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><span style="color:#9D9EA0;">Most development teams try to automate as much of their testing as possible, and run those tests before each commit. That way, they know if they inadvertently introduced a bug when they were making a fix or adding a new feature.</span></p>&#13;
</div>&#13;
</div></section>&#13;
</div></section>&#13;
<section data-pdf-bookmark="Add a unit test project to Jimmy’s comic collection app" data-type="sect1"><div class="sect1" id="add_a_unit_test_project_to_jimmyapostrop">&#13;
<h1>Add a unit test project to Jimmy’s comic collection app</h1>&#13;
<ol>&#13;
<li><p><a data-primary="unit testing" data-type="indexterm" id="idm46402340462344"/><strong>Add a new MSTest (.NET Core) project.</strong></p>&#13;
<p>Right-click on the solution name in the Solution Explorer, then choose <strong>Add &gt;&gt; New Project...</strong> from the menubar. Make sure it’s an <strong>MSTest Test Project (.NET Core)</strong>: on Windows use the “Search for Templates” box to search for MSTest; on macOS select Tests under “Web and Console” to see the project template. Name your project <em>JimmyLinqUnitTests</em>.</p></li>&#13;
<li><p><strong>Add a dependency on your existing project.</strong></p>&#13;
<p>You’ll be building unit tests for the ComicAnalyzer class. When you have two different projects in the same solution, they’re <em>independent</em>—by default, the classes in one project can’t use classes in another project—so you’ll need to set up a dependency to let your unit tests use ComicAnalyzer.</p>&#13;
<p>Expand the JimmyLinqUnitTests project in the Solution Explorer, then right-click on Dependencies and choose <strong>Add Reference...</strong> from the menu. Check the JimmyLinq project that you created for the exercise.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg502-1.png"/>&#13;
<h6/>&#13;
</div></figure></li>&#13;
<li><p><strong>Make your ComicAnalyzer class public.</strong></p>&#13;
<p>When Visual Studio added the unit test project, it created a class called UnitTest1. Edit the <em>UnitTest1.cs</em> file and try adding the <code>using JimmyLinq;</code> directive inside the namespace:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg502-2.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>Hmm, something’s wrong—the IDE won’t let you add the directive. The reason is that the JimmyLinq project has no public classes, enums, or other members. Try modifying the <code>Critics</code> enum to make it public (<code><strong>public enum Critics</strong></code>), then go back and try adding the <code>using</code> directive. Now you can add it! The IDE saw that the JimmyLinq namespace has public members, and added it to the pop-up window.</p>&#13;
<p>Now change the ComicAnalyzer declaration to make it public: <code><strong>public static class ComicAnalyzer</strong></code></p>&#13;
<p><strong><em>Uh-oh—something’s wrong.</em></strong> Did you get a bunch of “Inconsistent accessibility” compiler errors?</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg502-3.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>The problem is that ComicAnalyzer is public, but it exposes members that have no access modifiers,  which makes them <code><strong>internal</strong></code>—so other projects in the solution can’t see them. <strong>Add the <code>public</code> access modifier</strong> to <u><strong><em>every</em></strong></u> <strong><em>class and enum</em></strong> in the JimmyLinq project. Now your solution will build again.</p></li>&#13;
</ol>&#13;
</div></section>&#13;
<section data-pdf-bookmark="Write your first unit test" data-type="sect1"><div class="sect1" id="write_your_first_unit_test">&#13;
<h1>Write your first unit test</h1>&#13;
<p><a data-primary="Assert.AreEqual method" data-seealso="unit testing" data-type="indexterm" id="idm46402340444744"/><a data-primary="attribute" data-type="indexterm" id="idm46402340443768"/><a data-primary="Visual Studio" data-secondary="for Mac" data-type="indexterm" id="idm46402340443032"/>The IDE added a class called UnitTest1 to your new MSTest project. Rename the class (and the file) ComicAnalyzerTests. The class contains a test method called TestMethod1. Next, give it a very descriptive name: rename the method ComicAnalyzer_Should_Group_Comics. Here’s the code for your unit test class:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg503-1.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><strong>When you run your unit tests in the IDE, it looks for any class with <code>[TestClass]</code> above it. That’s called an <span style="color:#9D9EA0;"><u>attribute</u></span>. A test class includes test methods, which must be marked with the <code>[TestMethod]</code> attribute.</strong></p>&#13;
<p><strong>MSTest unit tests use the <span style="color:#9D9EA0;"><u>Assert class</u></span>, which has static methods that you can use to check that your code behaves the way you expect it to. This unit test uses the <span style="color:#9D9EA0;"><u>Assert.AreEqual method</u></span>. It takes two parameters, an expected result (what you think the code should do) and an actual result (what it actually does), and throws an exception if they’re not equal.</strong></p>&#13;
<p><strong>This test sets up some very limited test data: a sequence of three comics and a dictionary with three prices. Then it calls GroupComicsByPrice and uses Assert.AreEqual to validate that the results match what we expect.</strong></p>&#13;
</div>&#13;
<p>Run your test by choosing <strong>Test &gt;&gt; Run All Tests</strong> (Windows) or <strong>Run &gt;&gt; Run Unit Tests</strong> (Mac) from the menubar. The IDE will pop up a Test Explorer window (Windows) or Test Results panel (Mac) with the test results:</p>&#13;
<pre data-type="programlisting">Test method JimmyLinqUnitTests.ComicAnalyzerTests.ComicAnalyzer_Should_Group_Comics threw exception:&#13;
System.Collections.Generic.KeyNotFoundException: The given key ‘2’ was not present in the dictionary.</pre>&#13;
<p>This is the result of a <strong>failed unit test</strong>. Look for the <span class="inlineimage"><img alt="Images" src="assets/pg503-2.png"/></span> icon in Windows or the <span class="inlineimage"><img alt="Images" src="assets/pg503-3.png"/></span> message at the bottom of the IDE window in Visual Studio for Mac—that’s how you see a count of your failed unit tests.</p>&#13;
<p><strong><em>Did you expect that unit test to fail? Can you figure out what went wrong with the test?</em></strong></p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="sleuth_it_out-idd0003">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/cap.png"/></span> Sleuth it out</h5>&#13;
<p>Unit testing is all about discovering places where your code doesn’t act the way you expect and sleuthing out exactly what went wrong. Sherlock Holmes once said, “It is a capital mistake to theorize before one has data.” So let’s get some data.</p>&#13;
<p><strong>Let’s start with the assertions</strong></p>&#13;
<p>A good place to start is always the assertions that you included in the test, because they tell you what specific code you’re testing, and how you expect it to behave. Here are the assertions from your unit test:</p>&#13;
<pre data-type="programlisting">         Assert.AreEqual(2, groups.Count());&#13;
         Assert.AreEqual(PriceRange.Cheap, groups.First().Key);&#13;
         Assert.AreEqual(2, groups.First().First().Issue);&#13;
         Assert.AreEqual("Issue 2", groups.First().First().Name);</pre>&#13;
<p>When you look at the test data that you’re feeding into the GroupComicsByPrice method, these assertions look correct. It really should return two groups. The first one should have the key PriceRange.Cheap. The groups are sorted by ascending price, so the first comic in the first group should have Issue = 2 and Name = “Issue 2”—and that’s exactly what those assertions are testing. So if there’s a problem, it’s not here—these assertions really do seem to be correct.</p>&#13;
<p><strong>Now let’s have a look at the stack trace</strong></p>&#13;
<p>You’ve seen plenty of exceptions by now. Each exception comes with a <strong>stack trace</strong>, or a list of all of the method calls the program made right up to the line of code that threw it. If it’s in a method, it shows what line of code called that method, and what line called that one, all the way up to the Main method. <strong>Open the stack trace</strong> for your failed unit test:</p>&#13;
<ul>&#13;
<li><p>Windows: open the Test Explorer (View &gt;&gt; Test Explorer), click on the test, and scroll down in the Test Detail Summary</p></li>&#13;
<li><p>Mac: go to the Test Results panel, expand the test, then expand the Stack Trace section underneath it</p></li>&#13;
</ul>&#13;
<p>The stack trace will start like this (on Mac you’ll see fully qualified class names like JimmyLinq.ComicAnalyzer):</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg504-1.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>Stack traces look a little weird at first, but once you get used to them they’ve got a lot of useful information. Now we know that the test failed because an exception related to dictionary keys was thrown <em>somewhere</em> inside CalculatePriceRange.</p>&#13;
<p><strong>Use the debugger to gather clues</strong></p>&#13;
<p>Add a <strong>breakpoint to the first line</strong> of the CalculatePriceRange method: <code>if (Comic.Prices[comic.Issue] &lt; 100)</code></p>&#13;
<p>Then <strong>debug your unit tests</strong>: on Windows choose Test &gt;&gt; Debug All Tests, on Mac open the Unit Tests panel (View &gt;&gt; Tests) and click the Debug All Tests button at the top. Hover over <code>comic.Issue</code>—its value is 2. But wait a minute! The Comic.Prices dictionary <strong>doesn’t have an entry</strong> with the key 2. <strong><em>No wonder it threw the exception!</em></strong></p>&#13;
<p>Now we know <strong><em><u>how to fix the bug:</u></em></strong></p>&#13;
<ul>&#13;
<li><p>Add a second parameter to the CalculatePriceRange method:</p>&#13;
<pre data-type="programlisting"><span style="color:#9D9EA0;">private static PriceRange CalculatePriceRange(Comic comic</span>, IReadOnlyDictionary&lt;int, decimal&gt; prices<span style="color:#9D9EA0;">)</span></pre></li>&#13;
<li><p>Modify the first line to use the new parameter: <span style="color:#9D9EA0;">if (</span>prices<span style="color:#9D9EA0;">[comic.Issue] &lt; 100)</span></p></li>&#13;
<li><p>Modify the LINQ query: <code><strong><span style="color:#9D9EA0;">group comic by CalculatePriceRange(comic</span>, prices) <span style="color:#9D9EA0;">into priceGroup</span></strong></code></p></li>&#13;
</ul>&#13;
<p>Run your test again. This time it passes! <span class="inlineimage"><img alt="Images" src="assets/relaxa.png"/></span> <span class="inlineimage"><img alt="Images" src="assets/relax1.png"/></span></p>&#13;
</div></aside>&#13;
</div></section>&#13;
<section data-pdf-bookmark="Write a unit test for the GetReviews method" data-type="sect1"><div class="sect1" id="write_a_unit_test_for_the_getreviews_met">&#13;
<h1>Write a unit test for the GetReviews method</h1>&#13;
<p><a data-primary="GetReviews method" data-type="indexterm" id="idm46402340394824"/>The unit test for the GroupComicsByPrice method used MSTest’s static Assert.AreEqual method to check expected values against actual ones. The GetReviews method <em>returns a sequence of strings</em>, not an individual value. We <em>could</em> use Assert.AreEqual to compare individual elements in that sequence, just like we did with the last two assertions, using LINQ methods like First to get specific elements...but that would take a LOT of code.</p>&#13;
<p>Luckily, MSTest has a better way to compare collections: the <strong>CollectionAssert class</strong> has static methods for comparing expected versus actual collection results. So if you have a collection with expected results and a collection with actual results, you can compare them like this:</p>&#13;
<pre data-type="programlisting">   CollectionAssert.AreEqual(expectedResults, actualResults);</pre>&#13;
<p>If the expected and actual results don’t match the test will fail. Go ahead and <strong>add this test</strong> to validate the ComicAnalyzer.GetReviews method:</p>&#13;
<pre data-type="programlisting">[TestMethod]&#13;
public void ComicAnalyzer_Should_Generate_A_List_Of_Reviews()&#13;
{&#13;
    var testReviews = new[]&#13;
    {&#13;
        new Review() { Issue = 1, Critic = Critics.MuddyCritic, Score = 14.5},&#13;
        new Review() { Issue = 1, Critic = Critics.RottenTornadoes, Score = 59.93},&#13;
        new Review() { Issue = 2, Critic = Critics.MuddyCritic, Score = 40.3},&#13;
        new Review() { Issue = 2, Critic = Critics.RottenTornadoes, Score = 95.11},&#13;
    };&#13;
&#13;
    var expectedResults = new[]&#13;
    {&#13;
        "MuddyCritic rated #1 ‘Issue 1’ 14.50",&#13;
        "RottenTornadoes rated #1 ‘Issue 1’ 59.93",&#13;
        "MuddyCritic rated #2 ‘Issue 2’ 40.30",&#13;
        "RottenTornadoes rated #2 ‘Issue 2’ 95.11",&#13;
    };&#13;
&#13;
    var actualResults = ComicAnalyzer.GetReviews(testComics, testReviews).ToList();&#13;
    CollectionAssert.AreEqual(expectedResults, actualResults);&#13;
}</pre>&#13;
<p>Now run your tests again. You should see two unit tests pass.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="brain_power-idd0023">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/brainpower.png"/></span> Brain Power</h5>&#13;
<p>What happens if you pass a sequence with duplicate reviews to ComicAnalyzer.GetReviews? What if you pass it a review with a negative score?</p>&#13;
</div></aside>&#13;
</div></section>&#13;
<section data-pdf-bookmark="Write unit tests to handle edge cases and weird data" data-type="sect1"><div class="sect1" id="write_unit_tests_to_handle_edge_cases_an">&#13;
<h1>Write unit tests to handle edge cases and weird data</h1>&#13;
<p><a data-primary="edge cases" data-type="indexterm" id="idm46402340383800"/><a data-primary="robust design" data-type="indexterm" id="idm46402340382360"/>In the real world, data is messy. For example, we never really told you exactly what review data is supposed to look like. You’ve seen review scores between 0 and 100. Did you assume those were the only values allowed? That’s definitely the way some review websites in the real world operate. What if we get some weird review scores—like negative ones, or really big ones, or zero? What if we get more than one score from a reviewer for an issue? Even if these things aren’t <em>supposed to</em> happen, they <em>might</em> happen.</p>&#13;
<p>We want our code to be <strong>robust</strong>, which means that it handles problems, failures, and especially bad input data well. So let’s build a unit test that passes some weird data to GetReviews and makes sure it doesn’t break:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg506.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Always take time to write unit tests for edge cases and weird data—think of them as “must-have” and not “nice-to-have” tests. The point of unit testing is to cast the widest possible net to catch bugs, and these kinds of tests are really effective for that.</p>&#13;
</div>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="ro_bustcomma_adjectivedot">&#13;
<h5>ro-bust, adjective.</h5>&#13;
<p>sturdy in construction. <em>The bridge’s <strong>robust</strong> design allowed it to handle hurricane-force winds by flexing without breaking.</em></p>&#13;
</div></aside>&#13;
<blockquote>&#13;
<p><strong>It’s really important to add unit tests that handle edge cases and weird data. They can help you spot problems in your code that you wouldn’t find otherwise.</strong></p>&#13;
</blockquote>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="there_are_no_dumb_questions-idd0031">&#13;
<h5>there are no Dumb Questions</h5>&#13;
<p><a data-primary="access modifiers" data-type="indexterm" id="idm46402340370296"/><strong>Q: Why are they called <em>unit</em> tests?</strong></p>&#13;
<p><strong>A:</strong> The term “unit test” is a generic term that applies to many different languages, not just C#. It comes from the idea that your code is divided into discrete units, or small building blocks. Different languages have different units; in C# the basic unit of code is a class.</p>&#13;
<p>So from that perspective, the name “unit test” makes sense: you write tests for the units of code, or in our case, on a class-by-class basis.</p>&#13;
<p><strong>Q: I created two projects in a single solution. How does that work, exactly?</strong></p>&#13;
<p><strong>A:</strong> When you start a new C# project in Visual Studio, it creates a solution and adds a project to it. All of the solutions that you created so far in the book had a single project—until the unit test project. A solution can actually contain many projects. We used a separate project to keep the unit tests separate from the code that they’re testing. You can also add multiple Console App, WPF, or ASP.NET projects—a solution can contain combinations of different project types.</p>&#13;
<p><strong>Q: If a solution has multiple Console App, WPF, or ASP.NET projects, how does the IDE know which one to run?</strong></p>&#13;
<p><strong>A:</strong> Look at the Solution Explorer (or the Solution pad in VS for Mac)—one of the project names is boldfaced. The IDE calls that its <strong>Startup Project</strong>. You can right-click on any project in the solution and tell the IDE to use it as the startup project instead. Then the next time you press the Run button in the toolbar, that project will start.</p>&#13;
<p><strong>Q: Can you explain how the <code><strong>internal</strong></code> access modifier works again?</strong></p>&#13;
<p><strong>A:</strong> When you mark a class or interface internal, that means it can only be accessed by code inside that project. If you don’t use an access modifier at all, a class or interface defaults to internal. That’s why you had to make sure your classes were marked public—otherwise, the unit tests wouldn’t be able to see them. Also, <em>be careful with access modifiers</em>: while classes and interfaces default to internal if you leave off the access modifier, class members like methods, fields, and properties default to private.</p>&#13;
<p><strong>Q: If my unit tests are in a separate project from the code that they’re testing, how can they access private methods?</strong></p>&#13;
<p><strong>A</strong>: They don’t. Unit tests access whatever part of the unit is visible to the rest of the code—so for your C# classes, that means the public methods and fields—and use them to make sure the unit works. Unit tests are typically supposed to be <strong>black-box tests</strong>, which means that they only check the methods that they can see (as opposed to clear-box tests, where you can “see” the internals of the thing that you’re testing).</p>&#13;
<p><strong>Q: Do all of my tests need to pass? Is it OK if some of them fail?</strong></p>&#13;
<p><strong>A:</strong> Yes, all of your tests need to pass. And no, it’s not OK if they fail. Think of it this way—is it OK if some of your code doesn’t work? Of course not! So if your test fails, then either the code is has a bug or the test does. Either way, you should fix it so it passes.</p>&#13;
</div></aside>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg507.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p><strong>Your projects actually go faster when you write unit tests.</strong></p>&#13;
<p>We’re serious! It may seem counterintuitive that it takes <em>less time</em> to write <em>more code</em>, but if you’re in the habit of writing unit tests, your projects go a lot more smoothly because you find and fix bugs early. You’ve written a lot of code so far in the first eight and a half chapters of this book, which means you’ve almost certainly had to track down and fix bugs in your code. When you fixed those bugs, did you have to fix other code in your project too? When we find an unexpected bug, we often have to stop what we’re doing to track it down and fix it, and switching back and forth like that—losing our train of thought, having to interrupt our flow—can really slow things down. Unit tests help you find those bugs early, before they have a chance to interrupt your work.</p>&#13;
<p><strong><em>Still wondering exactly when unit tests should be written? We included a downloadable project at the end of the chapter to help answer that question.</em></strong></p>&#13;
</div></section>&#13;
<section data-pdf-bookmark="Use the =&gt; operator to create lambda expressions" data-type="sect1"><div class="sect1" id="use_the_equalsgreater_than_operator_to_c">&#13;
<h1>Use the =&gt; operator to create <u>lambda</u> <u>ex</u>p<u>ressions</u></h1>&#13;
<p><a data-primary="lambda expressions" data-type="indexterm" id="idm46402340347880"/><strong><em>We left you hanging back at  the beginning of the chapter.</em></strong> Remember that mysterious line we asked you to add to the Comic class? Here it is again:</p>&#13;
<pre data-type="programlisting">    public override string ToString() =&gt; $"{Name} (Issue #{Issue})";</pre>&#13;
<p>You’ve been using that ToString method throughout the chapter—you know it works. What would you do if we asked you to rewrite that method the way you’ve been writing methods so far? You might write something like this:</p>&#13;
<pre data-type="programlisting">    public override string ToString() {&#13;
        return $"{Name} (Issue #{Issue})";&#13;
    }</pre>&#13;
<p>And you’d basically be right. So what’s going on? What exactly is that =&gt; operator?</p>&#13;
<p>The =&gt; operator that you used in the ToString method is the <strong>lambda operator</strong>. You can use =&gt; to define a <strong>lambda expression</strong>, or an <u><em>anonymous function</em> defined within a single statement</u>. Lambda expressions look like this:</p>&#13;
<pre data-type="programlisting">    (input-parameters) =&gt; expression;</pre>&#13;
<p>There are two parts to a lambda expression:</p>&#13;
<ul>&#13;
<li><p>The <code>input-parameters</code> part is a list of parameters, just like you’d use when you declare a method. If there’s only one parameter, you can leave off the parentheses.</p></li>&#13;
<li><p>The <code>expression</code> is any C# expression: it can be an interpolated string, a statement that uses an operator, a method call—pretty much anything you would put in a statement.</p></li>&#13;
</ul>&#13;
<p>Lambda expressions may look a little weird at first, but they’re just another way of using the <strong><em>same familiar C# expressions</em></strong> that you’ve been using throughout the book—just like the Comic.ToString method, which works the same way whether or not you use a lambda expression.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg508.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p><strong>Yes! You can use lambda expressions to refactor many methods and properties.</strong></p>&#13;
<p>You’ve written a lot of methods throughout this book that contain just a single statement. You could refactor most of them to use lambda expressions instead. In many cases, that could make your code easier to read and understand. Lambdas give you options—you can decide when using them improves your code.</p>&#13;
</div></section>&#13;
<section data-pdf-bookmark="A lambda test drive" data-type="sect1"><div class="sect1" id="a_lambda_test_drive">&#13;
<h1>A lambda test drive</h1>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/coma.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>Let’s kick the tires on lambda expressions, which give us a whole new way to write methods, including ones that return values or take parameters.</p>&#13;
<ol>&#13;
<li><p><strong>Create a new console app</strong>. Add this Program class with the Main method:</p>&#13;
<pre data-type="programlisting">class Program&#13;
{&#13;
    static Random random = new Random();&#13;
    static double GetRandomDouble(int max)&#13;
    {&#13;
        return max * random.NextDouble();&#13;
    }&#13;
    static void PrintValue(double d)&#13;
    {&#13;
        Console.WriteLine($"The value is {d:0.0000}");&#13;
    }&#13;
    static void Main(string[] args)&#13;
    {&#13;
        var value = Program.GetRandomDouble(100);&#13;
        Program.PrintValue(value);&#13;
    }&#13;
}</pre>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg509-1.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>Run it a few times. Each time it prints a different random number, as in: <code>The value is 37.8709</code></p></li>&#13;
<li><p><strong>Refactor the GetRandomDouble and PrintValue methods</strong> using the =&gt; operator:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg509-2.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>Run your program again—it should print a different random number, just like before.</p>&#13;
<p>Before we do one more refactoring, <strong>hover over the random field</strong> and look at the IntelliSense pop-up:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg509-3.png"/>&#13;
<h6/>&#13;
</div></figure></li>&#13;
<li><p><strong>Modify the random field</strong> to use a lambda expression:</p>&#13;
<pre data-type="programlisting"><span style="color:#9D9EA0;">   static Random random <strong>=&gt;</strong> new Random();</span></pre>&#13;
<p>The program still runs the same way. Now <strong>hover over the random field</strong> again:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg509-4.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>Wait a minute—random isn’t a field anymore. Changing it into a lambda turned it into a property! That’s because <strong>lambda expressions always work like methods</strong>. So when random was a field, it got instantiated once when the class was constructed. When you changed the = to a =&gt; and converted it to a lambda, it became a method—which means <strong><em>a new instance of Random is created every time the property is accessed</em></strong>.</p></li>&#13;
</ol>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="brain_power-idd0024">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/brainpower.png"/></span> Brain Power</h5>&#13;
<p>Which of the versions of this code do you think is easiest to read?</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg510-2z.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
</div></aside>&#13;
</div></section>&#13;
<section data-pdf-bookmark="Refactor a clown with lambdas" data-type="sect1"><div class="sect1" id="refactor_a_clown_with_lambdas">&#13;
<h1>Refactor a clown with lambdas</h1>&#13;
<p><a data-primary="clowns" data-secondary="Fingers the clown" data-type="indexterm" id="idm46402340303368"/><a data-primary="expression-bodied member" data-type="indexterm" id="idm46402340302024"/><a data-primary="Implement interface (Visual Studio)" data-type="indexterm" id="idm46402340301176"/><a data-primary="methods" data-secondary="body" data-type="indexterm" id="idm46402340300328"/>Back in <a href="ch07.html#interfacescomma_castingcomma_and_quotati">#interfacescomma_castingcomma_and_quotati</a>, you created an IClown interface with two members:</p>&#13;
<p><strong><em>Do this!</em></strong></p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg509-5a.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>And you modified this class to implement that interface:</p>&#13;
<pre data-type="programlisting">class TallGuy {&#13;
    public string Name;&#13;
    public int Height;&#13;
&#13;
    public void TalkAboutYourself() {&#13;
        Console.WriteLine($"My name is {Name} and I’m {Height} inches tall.");&#13;
    }&#13;
}</pre>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="ide_tip_implement_interface">&#13;
<h5>IDE Tip: Implement interface</h5>&#13;
<p>When a class implements an interface, the Quick Actions menu’s <strong>“Implement interface”</strong> option tells the IDE to add any missing interface members.</p>&#13;
</div></aside>&#13;
<p>Let’s do that same thing again—but this time we’ll use lambdas. <strong>Create a new Console App</strong> <strong>project</strong> and add the IClown interface and TallGuy class. Then modify TallGuy to implement IClown:</p>&#13;
<pre data-type="programlisting">class TallGuy : IClown {</pre>&#13;
<p>Now open the Quick Actions menu and choose <strong>“Implement interface.”</strong> The IDE fills in all of the interface members, having them throw NotImplementedExceptions just like it does when you use Generate Method.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg510-2.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>Let’s refactor these methods so they do the same thing as before, but now use lambda expressions:</p>&#13;
<pre data-type="programlisting">    public string FunnyThingIHave <strong>=&gt;</strong> "big red shoes";&#13;
    public void Honk() =&gt; Console.WriteLine("Honk honk!");</pre>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg510-3.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>Now add the same Main method you used back in <a href="ch07.html#interfacescomma_castingcomma_and_quotati">#interfacescomma_castingcomma_and_quotati</a>:</p>&#13;
<pre data-type="programlisting"> TallGuy tallGuy = new TallGuy() { Height = 76, Name = "Jimmy" };&#13;
 tallGuy.TalkAboutYourself();&#13;
 Console.WriteLine($"The tall guy has {tallGuy.FunnyThingIHave}");&#13;
 tallGuy.Honk();</pre>&#13;
<p>Run your app. The TallGuy class works just like it did in <a href="ch07.html#interfacescomma_castingcomma_and_quotati">#interfacescomma_castingcomma_and_quotati</a>, but now that we’ve refactored its members to use lambda expressions it’s more compact.</p>&#13;
<p><strong><em>We think the new and improved TallGuy class is easier to read. Do you?</em></strong></p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg510-4.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="sharpen_your_pencil-idd0036">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/pencil.png"/></span> Sharpen your pencil</h5>&#13;
<p><a data-primary="exercises" data-secondary="Sharpen your pencil" data-tertiary="lambda expressions" data-type="indexterm" id="idm46402340273480"/><a data-primary="Sharpen Your Pencil exercises" data-secondary="lambda expressions" data-type="indexterm" id="idm46402340271976"/>Here are the NectarCollector class from the Beehive Management System project in <a href="ch06.html#inheritance_your_objectapostrophes_famil">#inheritance_your_objectapostrophes_famil</a> and the ScaryScary class from <a href="ch07.html#interfacescomma_castingcomma_and_quotati">#interfacescomma_castingcomma_and_quotati</a>. Your job is to <strong>refactor some of the members of these classes using the lambda operator</strong> (<code><strong>=&gt;)</strong></code>. Write down the refactored methods.</p>&#13;
<pre data-type="programlisting">class NectarCollector : Bee&#13;
{&#13;
    public const float NECTAR_COLLECTED_PER_SHIFT = 33.25f;&#13;
    public override float CostPerShift { get { return 1.95f; } }&#13;
    public NectarCollector() : base("Nectar Collector") { }&#13;
&#13;
    protected override void DoJob()&#13;
    {&#13;
        HoneyVault.CollectNectar(NECTAR_COLLECTED_PER_SHIFT);&#13;
    }&#13;
}</pre>&#13;
<p>Refactor the CostPerShift property as a lambda:</p>&#13;
<p>......................................................................</p>&#13;
<pre data-type="programlisting">class ScaryScary : FunnyFunny, IScaryClown {&#13;
   private int scaryThingCount;&#13;
   public ScaryScary(string funnyThing, int scaryThingCount) : base(funnyThing)&#13;
   {&#13;
      this.scaryThingCount = scaryThingCount;&#13;
   }&#13;
   public string ScaryThingIHave { get { return $"{scaryThingCount} spiders"; } }&#13;
   public void ScareLittleChildren()&#13;
   {&#13;
      Console.WriteLine($"Boo! Gotcha! Look at my {ScaryThingIHave}");&#13;
   }&#13;
}</pre>&#13;
<p>Refactor the ScaryThingIHave property as a lambda:</p>&#13;
<p>.....................................................................................</p>&#13;
<p>Refactor the ScareLittleChildren method as a lambda:</p>&#13;
<p>.....................................................................................</p>&#13;
</div></aside>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="sharpen_your_pencil_solution-idd020">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/Common.png"/></span> Sharpen your pencil Solution</h5>&#13;
<p>Here are the NectarCollector class from the Beehive Management System project in <a href="ch06.html#inheritance_your_objectapostrophes_famil">#inheritance_your_objectapostrophes_famil</a> and the ScaryScary class from <a href="ch07.html#interfacescomma_castingcomma_and_quotati">#interfacescomma_castingcomma_and_quotati</a>. Your job is to <strong>refactor some of the members of these classes using the lambda operator (<code>=&gt;)</code></strong>. Write down the refactored methods.</p>&#13;
<p>Refactor the CostPerShift property as a lambda:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg512-1.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>Refactor the ScaryThingIHave property as a lambda:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg512-2.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>Refactor the ScareLittleChildren method as a lambda:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg512-3.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
</div></aside>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="there_are_no_dumb_questions-idd0032">&#13;
<h5>there are no Dumb Questions</h5>&#13;
<p><strong>Q: Go back to the Test Drive, where you modified the random field. You said that wasn’t a “true refactoring”—can you explain what you meant by that?</strong></p>&#13;
<p><strong>A:</strong> Sure. When you refactor code, you’re modifying its <em>structure</em> without changing its <em>behavior</em>. When you converted the PrintValue and GetRandomDouble methods into lambda expressions, they still worked exactly the same way—you changed their structure, but that change didn’t affect their behavior.</p>&#13;
<p>But when you changed the equals sign (=) to a lambda operator (=&gt;) in the random field declaration, you changed the way that it behaves. A field is like a variable—you declare it once, and then you reuse it. So when random was a field, a new Random instance was created as soon as the program started, and a reference to that instance was stored in the random field.</p>&#13;
<p>But when you use a lambda expression, you’re always creating a method. So when you changed the random field to this:</p>&#13;
<pre data-type="programlisting">static Random random =&gt; new Random();</pre>&#13;
<p>the C# compiler no longer saw a field. Instead, it saw a property. This should make sense—you learned in <a href="ch05.html#encapsulation_keep_your_privateshellippr">#encapsulation_keep_your_privateshellippr</a> about how properties are called like fields, but are really methods.</p>&#13;
<p>And you confirmed this when you hovered over the field:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg512.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>The IDE is telling you random is a now property by showing you that it has a get accessor <code>{ get; }</code>.</p>&#13;
</div></aside>&#13;
<blockquote>&#13;
<p><strong>You can use the =&gt; operator to create a property with a get accessor that executes a lambda expression.</strong></p>&#13;
</blockquote>&#13;
</div></section>&#13;
<section data-pdf-bookmark="Use the ?: operator to make your lambdas make choices" data-type="sect1"><div class="sect1" id="use_the_question_mark_operator_to_make_y">&#13;
<h1>Use the ?: operator to make your lambdas make choices</h1>&#13;
<p><a data-primary="conditional operator" data-type="indexterm" id="idm46402340240008"/>What  if you want your lambdas to do... more? It would be great if they could make decisions...and that’s where the <strong>conditional operator</strong> (which some people call the <strong>ternary operator</strong>) comes in. It works like this:</p>&#13;
<pre data-type="programlisting">    condition ? consequent : alternative;</pre>&#13;
<p>which may look a little weird at first, so let’s have a look at an example. First of all, the ?: operator <u>isn’t</u> unique to lambdas—you can use it anywhere. Take this <code>if</code> statement from the AbilityScoreCalculator class in <a href="ch04.html#types_and_references_getting_the_referen">#types_and_references_getting_the_referen</a>:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg513-1.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>Notice how we set Score equal to the results of the ?: expression. The ?: expression <strong>returns a value</strong>: it checks the <em>condition</em> (added &lt; Minimum), and then it either returns the <em>consequent</em> (Minimum) or the <em>alternative</em> (added).</p>&#13;
<p>When you have a method that looks like that <code>if/else</code> statement, you can <strong>use ?:</strong> <strong>to refactor it as a lambda</strong>. For example, take this method from the PaintballGun class in <a href="ch05.html#encapsulation_keep_your_privateshellippr">#encapsulation_keep_your_privateshellippr</a>:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg513-2.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>Let’s rewrite that as a more concise lambda expression:</p>&#13;
<p>Notice the slight change—in the <code>if/else</code> version, the BallsLoaded property was set inside the then- and else-statements. We changed this to use a conditional operator that checked balls against MAGAZINE_SIZE and returned the correct value, and used that return value to set the BallsLoaded property.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="relax-idd0004">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/common-12.png"/></span> Relax</h5>&#13;
<p><strong>There’s an easy way to remember how the conditional operator works.</strong></p>&#13;
<p>A lot of people have trouble remembering the order of the question mark and colon in the ?: ternary operator. Luckily, there’s an easy way to remember it.</p>&#13;
<p>The conditional operator is like asking a question, and you always ask a question <em>before</em> you find out the answer. So just ask yourself:</p>&#13;
<pre data-type="programlisting">is this condition true ? yes : no</pre>&#13;
<p>and you’ll know that the ? appears before the : in your expression.</p>&#13;
<p>And here’s a fun fact—we learned this tip from Microsoft’s great documentation page for the ?: operator: <a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/operators/conditional-operator">https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/operators/conditional-operator</a>.</p>&#13;
</div></aside>&#13;
</div></section>&#13;
<section data-pdf-bookmark="Lambda expressions and LINQ" data-type="sect1"><div class="sect1" id="lambda_expressions_and_linq">&#13;
<h1>Lambda expressions and LINQ</h1>&#13;
<p><a data-primary="Func parameter" data-type="indexterm" id="idm46402340213400"/><a data-primary="LINQ (Language Integrated Query)" data-secondary="lambda expressions and" data-type="indexterm" id="idm46402340211592"/>Add this small LINQ query to any C# app, then hover over the <code>select</code> keyword in the code:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg514-1.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>The IDE pops up a tooltip window just like it does <strong><em>when you hover over a method.</em></strong> Let’s take a closer look at the first line, which shows the method declaration:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg514-2.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>We can learn a few things from that method declaration:</p>&#13;
<ul>&#13;
<li><p>The IEnumerable&lt;int&gt;.Select method returns an IEnumerable&lt;int&gt;.</p></li>&#13;
<li><p>It takes a single parameter of type Func&lt;int, int&gt;.</p></li>&#13;
</ul>&#13;
<section data-pdf-bookmark="Use lambda expressions with methods that take a Func parameter" data-type="sect2"><div class="sect2" id="use_lambda_expressions_with_methods_that">&#13;
<h2>Use lambda expressions with methods that take a Func parameter</h2>&#13;
<p>When a method takes a Func&lt;int, int&gt; parameter, you can <strong>call it with a lambda expression</strong> that takes an int parameter and returns an int value. So you could refactor the select query like this:</p>&#13;
<pre data-type="programlisting"><span style="color:#9D9EA0;">        var array = new[] { 1, 2, 3, 4 };</span>&#13;
<span style="color:#9D9EA0;">        var result</span> = array.Select(i =&gt; i * 2);</pre>&#13;
<p>Go ahead—try that yourself in a console app. Add a foreach statement to print the output:</p>&#13;
<pre data-type="programlisting">foreach (var i in result) Console.WriteLine(i);</pre>&#13;
<p>When you print the results of the refactored query, you’ll get  the sequence { 2, 4, 6, 8 }—exactly the same result as you got with the LINQ query syntax before you refactored it.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="relax-idd0005">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/common-12.png"/></span> Relax</h5>&#13;
<p><strong>Any time you see a Func in a LINQ method, it just means you can use a lambda.</strong></p>&#13;
<p>You’ll learn a lot more about Func in the <strong>downloadable chapter on events and delegates</strong>, which is available as a PDF on our GitHub page. For now, when you use a LINQ method parameter with the type Func&lt;TSource, TResult&gt; it means you can call the method by passing it a lambda with a parameter of type TSource that returns type TResult.</p>&#13;
</div></aside>&#13;
</div></section>&#13;
</div></section>&#13;
<section data-pdf-bookmark="LINQ queries can be written as chained LINQ methods" data-type="sect1"><div class="sect1" id="linq_queries_can_be_written_as_chained_l">&#13;
<h1>LINQ queries can be written as chained LINQ methods</h1>&#13;
<p><a data-primary="LINQ (Language Integrated Query)" data-secondary="queries" data-type="indexterm" id="idm46402340190472"/><a data-primary="OrderBy method" data-type="indexterm" id="idm46402340189144"/><a data-primary="Where method" data-type="indexterm" id="idm46402340188264"/>Take this LINQ query from earlier and <strong>add it to an app</strong> so we can explore a few more LINQ methods:</p>&#13;
<pre data-type="programlisting">       int[] values = new int[] { 0, 12, 44, 36, 92, 54, 13, 8 };&#13;
       IEnumerable&lt;int&gt; result =&#13;
                  from v in values&#13;
                  where v &lt; 37&#13;
                  orderby -v&#13;
                  select v;</pre>&#13;
<section data-pdf-bookmark="The OrderBy LINQ method sorts a sequence" data-type="sect2"><div class="sect2" id="the_orderby_linq_method_sorts_a_sequence">&#13;
<h2>The OrderBy LINQ method sorts a sequence</h2>&#13;
<p>Hover over the <code><strong>orderby</strong></code> keyword and take a look at its parameter:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg515-1.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>When you use an <code>orderby</code> clause in a LINQ query, it calls a LINQ OrderBy method that sorts the sequence. In this case, we can pass it a lambda expression with an int parameter that <strong>returns the sort key</strong>, or any value (which must implement IComparer) that it can use to sort the results.</p>&#13;
</div></section>&#13;
<section data-pdf-bookmark="The Where LINQ method pulls out a subset of a sequence" data-type="sect2"><div class="sect2" id="the_where_linq_method_pulls_out_a_subset">&#13;
<h2>The Where LINQ method pulls out a subset of a sequence</h2>&#13;
<p>Now hover over the <code><strong>where</strong></code> keyword in the LINQ query:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg515-2.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>The <code>where</code> clause in a LINQ query calls a LINQ Where method that can use a lambda that returns a Boolean. <strong><em>The Where method calls that lambda for each element in the sequence</em></strong>. If the lambda returns true, the element is included in the results. If the lambda returns false, the element is removed.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="mini_exercise">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/exercise.png"/></span> MiNi Exercise</h5>&#13;
<p><strong>Here’s a lambda challenge for you!</strong> Can you figure out how to refactor this LINQ query into a set of chained LINQ methods? Start with <code>result</code>, then chain the Where and OrderBy methods to produce the same sequence.</p>&#13;
<pre data-type="programlisting">IEnumerable&lt;int&gt; result =&#13;
            from v in values&#13;
            where v &lt; 37&#13;
            orderby -v&#13;
            select v;</pre>&#13;
</div></aside>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="linq_methods_up_close">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/zoom.png"/></span> LINQ Methods Up Close</h5>&#13;
<p><a data-primary="LINQ (Language Integrated Query)" data-secondary="methods" data-type="indexterm" id="idm46402340165240"/><a data-primary="methods" data-secondary="LINQ" data-type="indexterm" id="idm46402340164008"/><strong>LINQ queries can be rewritten as a series of chained LINQ methods—and many of those methods can use lambda expressions to determine the sequence that they produce.</strong></p>&#13;
<p>Here’s the miniexercise solution—the LINQ query could be refactored like this:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg516-1.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>Let’s take a closer look at how the LINQ query is turned into chained methods:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg516-2.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p><strong>Use the OrderByDescending method where you’d use the descending keyword in a LINQ query</strong></p>&#13;
<p>Remember how you used the <code>descending</code> keyword to change the orderby clause in the query? There’s an equivalent LINQ method, OrderByDescending, that does exactly the same thing:</p>&#13;
<pre data-type="programlisting">var result = values.Where(v =&gt; v &lt; 37).OrderByDescending(v =&gt; v);</pre>&#13;
<p>Notice how we’re using the lambda expression v =&gt; v—that’s a lambda that will always return whatever is passed to it (sometimes referred to an <em>identity function</em>). So, OrderByDescending(v =&gt; v) reverses a sequence.</p>&#13;
<p><strong>Use the GroupBy method to create group queries from chained methods</strong></p>&#13;
<p>We saw this group query earlier in the chapter:</p>&#13;
<pre data-type="programlisting">var grouped =&#13;
    from card in deck&#13;
    group card by card.Suit into suitGroup&#13;
    orderby suitGroup.Key descending&#13;
    select suitGroup;</pre>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><strong>Should you use LINQ declarative query syntax or chained methods? They both accomplish the same thing. Sometimes one way leads to clearer code, sometimes the other way does, so it’s valuable to know how to use both.</strong></p>&#13;
</div>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg516-3.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>Hover over group and you’ll see that it calls the LINQ GroupBy method, which returns the same type we saw earlier in the chapter. You can use a lambda to group by the card’s suit: <code>card =&gt; card.Suit</code></p>&#13;
<p>And then another lambda to order the groups by key: <code>group =&gt; group.Key</code></p>&#13;
<p>Here’s the LINQ query refactored into chained GroupBy and OrderByDescending methods:</p>&#13;
<pre data-type="programlisting">var grouped =&#13;
     deck.GroupBy(card =&gt; card.Suit)&#13;
     .OrderByDescending(group =&gt; group.Key);</pre>&#13;
<p>Try going back to the app earlier in the chapter where you used that query and replace it with the chained methods.</p>&#13;
<p>You’ll see exactly the same output. It’s up to you to decide which version of your code is clearer and easier to read.</p>&#13;
</div></aside>&#13;
</div></section>&#13;
</div></section>&#13;
<section data-pdf-bookmark="Use the =&gt; operator to create switch expressions" data-type="sect1"><div class="sect1" id="use_the_equalsgreater_than_operator_to">&#13;
<h1>Use the <code>=&gt;</code> operator to create switch expressions</h1>&#13;
<p><a data-primary="switch expressions" data-type="indexterm" id="idm46402340144424"/>You’ve been using <code>switch</code> statements since <a href="ch06.html#inheritance_your_objectapostrophes_famil">#inheritance_your_objectapostrophes_famil</a> to check a variable against several options. It’s a really useful tool... but have you noticed its limitations? For example, try adding a case that tests against a variable:</p>&#13;
<pre data-type="programlisting">   case myVariable:</pre>&#13;
<p>You’ll get a C# compiler error: <em>A constant value is expected.</em> That’s because you can only use constant values—like literals and variables defined with the <code>const</code> keyword—in the <code>switch</code> statements that you’ve been using.</p>&#13;
<p>But that all changes with the <code>=&gt;</code> operator, which lets you create <strong>switch expressions</strong>. They’re similar to the <code>switch</code> statements that you’ve been using, but they’re <em>expressions</em> that return a value. A switch expression starts with a value to check and the <code>switch</code> keyword followed by a series of <em>switch arms</em> in curly brackets separated by commas. Each switch arm uses the =&gt; operator to check the value against an expression. If the first arm doesn’t match, it moves on to the next one, returning the value for the matching arm.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg517-1.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>Let’s say you’re working on a card game that needs to assign a certain score based on suit, where spades are worth 6, hearts are worth 4, and other cards are worth 2. You could write a <code>switch</code> statement like this:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg517-2.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>The whole goal of this <code>switch</code> statement is to use the cases to set the <code>score</code> variable—and a lot of our <code>switch</code> statements work that way. We can use the =&gt; operator to create a switch expression that does the same thing:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg517-3.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="sharpen_your_pencil-idd0037">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/pencil.png"/></span> Sharpen your pencil</h5>&#13;
<p><a data-primary="exercises" data-secondary="Sharpen your pencil" data-tertiary="lambda expressions" data-type="indexterm" id="idm46402340122648"/><a data-primary="Sharpen Your Pencil exercises" data-secondary="lambda expressions" data-type="indexterm" id="idm46402340121096"/></p>&#13;
<p>This console app uses the Suit, Value, and Deck classes that you used earlier in the chapter and writes six lines to the console. Your job is to <strong>write down the output of the program</strong>. When you’re done, add the program to a console app to check your answer.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg518.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>Write down the output of the program. <strong>We won’t give you a solution</strong>—add the code to a console app for the answer.</p>&#13;
<p>.................................................................................................</p>&#13;
<p>.................................................................................................</p>&#13;
<p>.................................................................................................</p>&#13;
<p>.................................................................................................</p>&#13;
<p>.................................................................................................</p>&#13;
<p>.................................................................................................</p>&#13;
<p><strong>This is a <u><em>serious</em></u> lambda challenge! There’s a lot going on here—you’re using lambda expressions, a switch expression, LINQ methods, enum casting, chained methods, and more. Really take your time and figure out how this code works before writing down your solution, and <u>then</u> run the program. If your solution didn’t match the output, it’s a great opportunity to sleuth out why it worked differently than you expected.</strong></p>&#13;
</div></aside>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="exercise-idd0031">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/exercise.png"/></span> Exercise</h5>&#13;
<p><a data-primary="exercises" data-secondary="Sharpen your pencil" data-tertiary="lambda expressions" data-type="indexterm" id="idm46402340110520"/><a data-primary="exercises" data-secondary="unit testing" data-type="indexterm" id="idm46402340106200"/>Use everything you’ve learned about lambda expressions, switch expressions, and LINQ methods to refactor the ComicAnalyzer class and Main method, using your unit tests to make sure your code still works exactly the way you expect it to.</p>&#13;
<p><strong>Replace the LINQ queries in ComicAnalyzer</strong></p>&#13;
<p>ComicAnalyzer has two LINQ queries:</p>&#13;
<ul>&#13;
<li><p>The GroupComicsByPrice method has a LINQ query that uses the <code>group</code> keyword to group comics by price.</p></li>&#13;
<li><p>The GetReviews method has a LINQ query that uses the <code>join</code> keyword to join a sequence of Comic objects to a dictionary of issue prices.</p></li>&#13;
</ul>&#13;
<p>Modify the LINQ queries in these methods to use the LINQ OrderBy, GroupBy, Select, and Join methods. There’s one catch: <strong><em>we haven’t shown you the Join method yet!</em></strong> But we showed you examples of how to use the IDE to explore LINQ methods. The Join method is a little more complex—but we’ll help you break it down. It takes four parameters:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg519.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>Look closely at the “on” and “equals” parts of the LINQ query to come up with the first two lambdas. The Join will be the last method in the chain. <em>Here’s a hint</em>—the last parameter’s lambda starts like this: <code>(comic, review) =&gt;</code></p>&#13;
<p>Once both unit tests pass, then you’re done refactoring the ComicAnalyzer class.</p>&#13;
<p><strong>Replace the switch statement in the Main method with a switch expression</strong></p>&#13;
<p>The Main method has a <code>switch</code> statement that calls private methods and assigns their return values to the <code>done</code> variable. Replace this with a switch expression with three switch arms. You can test it by running the app—if you can press the correct key and see the right output, you’re done.</p>&#13;
</div></aside>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="behind_the_scenes-idd0003">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/icon.png"/></span> Behind the Scenes</h5>&#13;
<p><strong>This exercise is about learning to use unit tests to <strong><em>safely</em></strong> refactor your code</strong></p>&#13;
<p><em>Refactoring can be messy, even nerve-wracking business. You’re taking code that works and making changes to improve its structure, readability, reusability. When you’re modifying your code, it’s really easy to accidentally mess it up so it doesn’t quite work right anymore—and sometimes the bugs you introduce can be subtle and difficult to track down, or even detect. That’s where unit tests can help. One of the most important ways that developers use unit tests is to make refactoring a much safer activity. Here’s how it works:</em></p>&#13;
<ul>&#13;
<li><p><em>Before you start refactoring, write tests that make sure your code works—like the tests you added earlier in the chapter to validate the ComicAnalyzer class.</em></p></li>&#13;
<li><p><em>When you’re refactoring a class, just run the tests for that class as you make the changes. That gives you a much shorter feedback loop for developing—you can do your normal debugging, but it goes a lot faster because you’re executing the code in the class directly (rather than starting up your program and using its user interface to run the code that uses the class).</em></p></li>&#13;
<li><p><em>When you’re refactoring a method, you can even start by just running the specific test or tests that execute that method. Then, once it works, you can run the entire suite to make sure you didn’t break anything else.</em></p></li>&#13;
<li><p><em>If a test fails, don’t feel bad—that’s actually good news! It’s telling you something’s broken, and now you can fix it.</em></p></li>&#13;
</ul>&#13;
</div></aside>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="exercise_solution-idd0022">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/Common-1.png"/></span> Exercise Solution</h5>&#13;
<p>Use everything you’ve learned about lambda expressions, switch expressions, and LINQ methods to refactor the ComicAnalyzer class and Main method, using your unit tests to make sure your code still works exactly the way you expect it to.</p>&#13;
<p>Here are the refactored GroupComicsByPrice and GetReviews methods from the ComicAnalyzer class:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg520-1.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>Here’s the refactored Main method with a switch expression instead of a <code>switch</code> statement:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg520-2.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
</div></aside>&#13;
</div></section>&#13;
<section data-pdf-bookmark="Explore the Enumerable class" data-type="sect1"><div class="sect1" id="explore_the_enumerable_class">&#13;
<h1>Explore the Enumerable class</h1>&#13;
<p><a data-primary="Enumerable class" data-type="indexterm" id="idm46402340075368"/><a data-primary="IEnumerable interface" data-secondary="about" data-type="indexterm" id="idm46402340074408"/>We’ve been using sequences for a while. We know they work with <code>foreach</code> loops and LINQ. But what, exactly, makes sequences tick? Let’s take a deeper dive to find out. We’ll start with the <strong>Enumerable class</strong>—specifically, with its three static methods, Range, Empty, and Repeat. You already saw the Enumerable.Range method earlier in the chapter. Let’s use the IDE to discover how the other two methods work. Type <code><strong>Enumerable</strong></code>. and then hover over Range, Empty, and Repeat in the IntelliSense pop-up to see their declarations and comments.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg521.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<section data-pdf-bookmark="Enumerable.Empty creates an empty sequence of any type" data-type="sect2"><div class="sect2" id="enumerabledotempty_creates_an_empty_sequ">&#13;
<h2>Enumerable.Empty creates an empty sequence of any type</h2>&#13;
<p>Sometimes you need to pass an empty sequence to a method that takes an IEnumerable&lt;T&gt; (for example, in a unit test). The <strong>Enumerable.Empty method</strong> comes in handy in these cases:</p>&#13;
<pre data-type="programlisting">var emptyInts = Enumerable.Empty&lt;int&gt;(); <span style="color:#9D9EA0;">// an empty sequence of ints</span>&#13;
var emptyComics = Enumerable.Empty&lt;Comic&gt;(); <span style="color:#9D9EA0;">// an empty sequence of Comic references</span></pre>&#13;
</div></section>&#13;
<section data-pdf-bookmark="Enumerable.Repeat repeats a value a number of times" data-type="sect2"><div class="sect2" id="enumerabledotrepeat_repeats_a_value_a_nu">&#13;
<h2>Enumerable.Repeat repeats a value a number of times</h2>&#13;
<p>Let’s say you need a sequence of 100 3s, or 12 “yes” strings, or 83 identical anonymous objects. You’d be surprised at how often that happens! You can use the <strong>Enumerable.Repeat method</strong> for this—it returns a sequence of repeated values:</p>&#13;
<pre data-type="programlisting">var oneHundredThrees = Enumerable.Repeat(3, 100);&#13;
var twelveYesStrings = Enumerable.Repeat("yes", 12);&#13;
var eightyThreeObjects = Enumerable.Repeat(&#13;
    new { cost = 12.94M, sign = "ONE WAY", isTall = false }, 83);</pre>&#13;
</div></section>&#13;
<section data-pdf-bookmark="So what exactly is an IEnumerable&lt;T&gt;?" data-type="sect2"><div class="sect2" id="so_what_exactly_is_an_ienumerableless_th">&#13;
<h2>So what exactly is an IEnumerable&lt;T&gt;?</h2>&#13;
<p>We’ve been using IEnumerable&lt;T&gt; for a while now. We haven’t really answered the question of what an enumerable sequence <em>actually is</em>. A really effective way to understand something is to build it ourselves, so let’s finish the chapter by building some sequences from the ground up.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="brain_power-idd0025">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/brainpower.png"/></span> Brain Power</h5>&#13;
<p>If you had to design an IEnumerable&lt;T&gt; interface yourself, what members would you put in it?</p>&#13;
</div></aside>&#13;
</div></section>&#13;
</div></section>&#13;
<section data-pdf-bookmark="Create an enumerable sequence by hand" data-type="sect1"><div class="sect1" id="create_an_enumerable_sequence_by_hand">&#13;
<h1>Create an enumerable sequence by hand</h1>&#13;
<p><a data-primary="enumerable sequences" data-type="indexterm" id="idm46402340053464"/>Let’s say we have some sports:</p>&#13;
<pre data-type="programlisting">   enum Sport { Football, Baseball, Basketball, Hockey, Boxing, Rugby, Fencing }</pre>&#13;
<p>Obviously, we could create a new List&lt;Sport&gt; and use a collection initializer to populate it. But for the sake of exploring how sequences work, we’ll build one manually. Let’s create a new class called ManualSportSequence and make it implement the IEnumerable&lt;Sport&gt; interface. It just has two members that return an IEnumerator:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg522-1.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>OK, so what’s an IEnumerator? It’s an interface that lets you enumerate a sequence, moving through each item in the sequence one after another. It has a property, Current, which returns the current item being enumerated. Its MoveNext method moves to the next element in the sequence, returning false if the sequence has run out. After MoveNext is called, Current returns that next element. Finally, the Reset method resets the sequence back to the beginning. Once you have those methods, you have an enumerable sequence.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg522-2.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>So let’s implement an IEnumerator&lt;Sport&gt;:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg522-3.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>And that’s all we need to create our own IEnumerable. Go ahead—give it a try. <strong>Create a new console app</strong>, add ManualSportSequence and ManualSportEnumerator, and then enumerate the sequence in a <code>foreach</code> loop:</p>&#13;
<pre data-type="programlisting">    var sports = new ManualSportSequence();&#13;
    foreach (var sport in sports)&#13;
        Console.WriteLine(sport);</pre>&#13;
</div></section>&#13;
<section data-pdf-bookmark="Use yield return to create your own sequences" data-type="sect1"><div class="sect1" id="use_yield_return_to_create_your_own_sequ">&#13;
<h1>Use <u>yield return</u> to create your own sequences</h1>&#13;
<p><a data-primary="debugger" data-secondary="yield return statement" data-type="indexterm" id="idm46402340047784"/><a data-primary="yield return statement" data-type="indexterm" id="idm46402340038344"/>C# gives you a much easier way to create enumerable sequences: the <code><strong>yield return statement</strong></code>. The <code>yield return</code> statement is a kind of all-in-one automatic enumerator creator. A good way to understand it is to see an example. Let’s use a <strong>multiproject solution</strong>, just to give you a little more practice with that.</p>&#13;
<p><strong>Add a new Console App project to your solution</strong>—this is just like what you did when you added the MSTest project earlier in the chapter, except this time instead of choosing the project type MSTest choose the same Console App project type that you’ve been using for most of the projects in the book. Then right-click on the project under the solution and <strong>choose “Set as startup project.”</strong> Now when you launch the debugger in the IDE, it will run the new project. You can also right-click on any project in the solution and run or debug it.</p>&#13;
<p>Here’s the code for the new console app:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg523-1.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>Run the app—it prints four lines: <code>apples</code>, <code>oranges</code>, <code>bananas</code>, and <code>unicorns</code>. So how does that work?</p>&#13;
<section data-pdf-bookmark="Use the debugger to explore yield return" data-type="sect2"><div class="sect2" id="use_the_debugger_to_explore_yield_return">&#13;
<h2>Use the debugger to explore yield return</h2>&#13;
<p>Set a breakpoint on the first line of the Main method and launch the debugger. Then use <strong>Step Into</strong> (F11 / <img alt="Images" src="assets/pg523-2a.png"/>) to debug the code line by line, right into the iterator:</p>&#13;
<ul>&#13;
<li><p>Step into the code, and keep stepping into it until you reach the first line of the SimpleEnumerable method.</p></li>&#13;
<li><p>Step into that line again. It acts just like a <code>return</code> statement, returning control back to the statement that called it—in this case, back to the <code>foreach</code> statement, which calls Console.WriteLine to write <code>apples</code>.</p></li>&#13;
<li><p>Step two more times. Your app will jump back into the SimpleEnumerable method, but <strong><em>it skips the first statement in the method</em></strong> and goes right to the second line:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg523-2.png"/>&#13;
<h6/>&#13;
</div></figure></li>&#13;
<li><p>Keep stepping. The app returns to the <code>foreach</code> loop, then back to the <strong><em>third line</em></strong> of the method, then returns to the <code>foreach</code> loop, and goes back to the <strong><em>fourth line</em></strong> of the method.</p></li>&#13;
</ul>&#13;
<p>So <code>yield return</code> makes a method <strong>return an enumerable sequence</strong> by returning the next element in the sequence each time it’s called, and keeping track of where it returned from so it can pick up where it left off.</p>&#13;
</div></section>&#13;
</div></section>&#13;
<section data-pdf-bookmark="Use yield return to refactor ManualSportSequence" data-type="sect1"><div class="sect1" id="use_yield_return_to_refactor_manualsport">&#13;
<h1>Use yield return to refactor ManualSportSequence</h1>&#13;
<p><a data-primary="[ ] (square brackets)" data-type="indexterm" id="idm46402340012632"/><a data-primary="arrays" data-secondary="using [ ] to return object from" data-type="indexterm" id="idm46402340013832"/><a data-primary="collections" data-secondary="compared with sequences" data-type="indexterm" id="idm46402340011448"/><a data-primary="dictionaries" data-secondary="using [ ] to return object from" data-type="indexterm" id="idm46402340010360"/><a data-primary="index" data-type="indexterm" id="idm46402340009288"/><a data-primary="lists" data-secondary="using [ ] to return object from" data-type="indexterm" id="idm46402340008456"/><a data-primary="sequences, compared with collections" data-type="indexterm" id="idm46402340007400"/><a data-primary="yield return statement" data-type="indexterm" id="idm46402340006520"/>You can create your own IEnumerable&lt;T&gt; by <strong>using <code>yield return</code> to implement the GetEnumerator method</strong>. For example, here’s a BetterSportSequence class that does exactly the same thing as ManualSportSequence did. This version is much more compact because it uses <code>yield return</code> in its GetEnumerator implementation:</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg524.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p>Go ahead and <strong>add a new Console App project to your solution</strong>. Add this new BetterSportSequence class, and modify the Main method to create an instance of it and enumerate the sequence.</p>&#13;
<section data-pdf-bookmark="Add an indexer to BetterSportSequence" data-type="sect2"><div class="sect2" id="add_an_indexer_to_bettersportsequence">&#13;
<h2>Add an indexer to BetterSportSequence</h2>&#13;
<p>You’ve seen that you can use <code>yield return</code> in a method to create an IEnumerator&lt;T&gt;. You can also use it to create a class that implements IEnumerable&lt;T&gt;. One advantage of creating a separate class for your sequence is that you can add an <strong>indexer</strong>. You’ve already used indexers—any time you use brackets <code>[]</code> to retrieve an object from a list, array, or dictionary (like <code>myList[3]</code> or <code>myDictionary["Steve"]</code>), you’re using an indexer. An indexer is just a method. It looks a lot like a property, except it’s got a single named parameter.</p>&#13;
<p>The IDE has an <strong><em>especially useful code snippet</em></strong> to help you add your indexer. Type <code><strong>indexer</strong></code> followed by two tabs, and the IDE will add the skeleton of an indexer for you automatically.</p>&#13;
<p>Here’s an indexer for the SportCollection class:</p>&#13;
<pre data-type="programlisting">    public Sport this[int index] {&#13;
        get =&gt; (Sport)index;&#13;
    }</pre>&#13;
<p>Calling the indexer with <code>[3]</code> returns the value <code>Hockey</code>:</p>&#13;
<pre data-type="programlisting">    var sequence = new BetterSportSequence();&#13;
    Console.WriteLine(sequence[3]);</pre>&#13;
<p>Take a close look when you use the snippet to create the indexer—it lets you set the type. You can define an indexer that takes different types, including strings and even objects. While our indexer only has a getter, you can also include a setter (just like the ones you’ve used to set items in a List).</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="watch_itexclamation_mark-idd0011">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/watchit.png"/></span> Watch it!</h5>&#13;
<p><strong>Sequences are <u>not</u> collections.</strong></p>&#13;
<p><em>Try creating a class that implements ICollection&lt;int&gt; and use the Quick Actions menu to implement its members. You’ll see that a collection not only has to implement the IEnumerable&lt;T&gt; methods, but it also needs additional properties (including Count) and methods (including Add and Clear). That’s how you know a collection does a different job than an enumerable sequence.</em></p>&#13;
</div></aside>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="exercise-idd0032">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/exercise.png"/></span> Exercise</h5>&#13;
<p><a data-primary="IEnumerator interface" data-type="indexterm" id="idm46402339984520"/>Create an enumerable class that, when enumerated, returns a sequence of ints that contains all of the powers of 2, starting at 0 and ending with the largest power of 2 that can fit inside an int.</p>&#13;
<p>Use <code><strong>yield return</strong></code> <b>to create a sequence of powers of 2</b></p>&#13;
<p>Create a class called PowersOfTwo that implements IEnumerable&lt;int&gt;. It should have a <code>for</code> loop that starts at 0 and uses <code>yield return</code> to return a sequence that contains each power of 2.</p>&#13;
<p>The app should write the following output to the console: <code>1 2 4 8 16 32 64 128 256 512 1024 2048 4096 8192 16384 32768 65536 131072 262144 524288 1048576 2097152 4194304 8388608 16777216 33554432 67108864 134217728 268435456 536870912 1073741824</code></p>&#13;
<p><strong>Return the desired sequence of values</strong></p>&#13;
<p>You’ll use methods from the static System.Math class in your app to:</p>&#13;
<ul>&#13;
<li><p>Compute a specific power of 2: <code><strong>Math.Pow(power, 2)</strong></code></p></li>&#13;
<li><p>Find the maximum power of 2 that can fit inside an int: <code><strong>Math.Round(Math.Log(int.MaxValue, 2))</strong></code></p></li>&#13;
</ul>&#13;
</div></aside>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="there_are_no_dumb_questions-idd0033">&#13;
<h5>there are no Dumb Questions</h5>&#13;
<p><strong>Q: I think I get what’s going on with <code><strong>yield return</strong></code>, but can you explain again exactly why it jumps right into the middle of a method?</strong></p>&#13;
<p><strong>A:</strong> When you use <code>yield return</code> to create an enumerable sequence, it does something that you haven’t seen anywhere else in C#. Normally when your method hits a <code>return</code> statement, it causes your program to execute the statement right after the one that called the method. It does the same thing when it’s enumerating a sequence created with <code>yield return</code>—with one difference: it remembers the last <code>yield return</code> statement it executed in the method. Then when it moves to the next item in the sequence, instead of starting at the beginning of the method your program executes the next statement after the most recent <code>yield return</code> that was called. That’s why you can build a method that returns an IEnumerable&lt;T&gt; with just a series of <code>yield return</code> statements.</p>&#13;
<p><strong>Q: When I added a class that implemented IEnumerable&lt;T&gt;, I had to add a MoveNext method and Current property. When I used yield return, how was I able to implement that interface without having to implement those two members?</strong></p>&#13;
<p><strong>A:</strong> When the compiler sees a method with a <code>yield return</code> statement that returns an IEnumerable&lt;T&gt;, it automatically adds the MoveNext method and Current property. When it executes, the first <code>yield return</code> that it encounters causes it to return the first value to the <code>foreach</code> loop. When the <code>foreach</code> loop continues (by calling the MoveNext method), it resumes execution with the statement immediately after the last <code>yield return</code> that it executed. Its MoveNext method returns false when the enumerator is positioned after the last element in the collection. This may be a little hard to follow on paper, but it’s much easier to follow if you load it into the debugger—which is why the first thing we had you do was step through a simple sequence that uses <code>yield return</code>.</p>&#13;
</div></aside>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="exercise_solution-idd0023">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/Common-1.png"/></span> Exercise Solution</h5>&#13;
<p><a data-primary="exercises" data-secondary="enumerable classes" data-type="indexterm" id="idm46402339960040"/>Create an enumerable class that, when enumerated, returns a sequence of ints that contains all of the powers of 2, starting at 0 and ending with the largest power of 2 that can fit inside an int.</p>&#13;
<pre data-type="programlisting">class PowersOfTwo : IEnumerable&lt;int&gt; {&#13;
  public IEnumerator&lt;int&gt; GetEnumerator() {&#13;
    var maxPower = Math.Round(Math.Log(int.MaxValue, 2));&#13;
    for (int power = 0; power &lt; maxPower; power++)&#13;
      yield return (int)Math.Pow(2, power);&#13;
  }&#13;
&#13;
  IEnumerator IEnumerable.GetEnumerator() =&gt; GetEnumerator();&#13;
&#13;
}&#13;
&#13;
class Program {&#13;
  static void Main(string[] args) {&#13;
    foreach (int i in new PowersOfTwo())&#13;
      Console.Write($" {i}");&#13;
  }&#13;
}</pre>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Don’t forget your using directives:</p>&#13;
<pre data-type="programlisting">using System;&#13;
using System.Linq;&#13;
using System.Collections;&#13;
using System.Collections.Generic;</pre>&#13;
</div>&#13;
</div></aside>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="bullet_points-idd0022">&#13;
<h5>Bullet Points</h5>&#13;
<ul>&#13;
<li><p><strong>Unit tests</strong> are automated tests that help you make sure your code does what it’s supposed to do, and help you <strong>safely refactor</strong> your code.</p></li>&#13;
<li><p>MSTest is a <strong>unit test framework</strong>, or a set of classes that give you the tools to write unit tests. Visual Studio has tools to execute and see the results of unit tests.</p></li>&#13;
<li><p>Unit tests use <strong>assertions</strong> to validate specific behaviors.</p></li>&#13;
<li><p>The <code><strong>internal</strong></code> <strong>keyword</strong> makes classes in one project accessible to another project in a multiproject build.</p></li>&#13;
<li><p>Add unit tests to handle edge cases and weird data to make your code more <strong>robust.</strong></p></li>&#13;
<li><p>Use the lambda operator =&gt; to define <strong>lambda expressions</strong>, or anonymous functions defined within a single statement that looks like this: <code>(input-parameters) =&gt; expression;</code></p></li>&#13;
<li><p>When a class implements an interface, the “<strong>Implement interface” option</strong> in the Quick Actions menu tells the IDE to add any missing interface members.</p></li>&#13;
<li><p><code>orderby</code> and <code>where</code> clauses in LINQ queries can be rewritten using the <strong>OrderBy and Where</strong> LINQ methods.</p></li>&#13;
<li><p>You can use the =&gt; operator to <strong>turn a field into a property</strong> with a get accessor that executes a lambda expression.</p></li>&#13;
<li><p>The <strong>?: operator</strong> (called the conditional or ternary operator) lets you create a single expression that executes an if/else condition.</p></li>&#13;
<li><p>LINQ methods that take a <strong>Func&lt;T1, T2&gt; parameter</strong> can be called with a lambda that takes a T1 parameter and returns a T2 value.</p></li>&#13;
<li><p>Use the =&gt; operator to create <strong>switch expressions</strong>, which are like <code>switch</code> statements that return a value.</p></li>&#13;
<li><p>The Enumerable class has static <strong>Range, Empty, and Repeat methods</strong> to help you create enumerable sequences.</p></li>&#13;
<li><p>Use <code><strong>yield return statements</strong></code> to create methods that return enumerable sequences.</p></li>&#13;
<li><p>When a method executes a <code>yield return</code>, it returns the next value in the sequence. The next time the method is called, it <strong>resumes execution</strong> at the next statement after the last <code>yield return</code> that was executed.</p></li>&#13;
</ul>&#13;
</div></aside>&#13;
</div></section>&#13;
</div></section>&#13;
<section data-pdf-bookmark="Collectioncross" data-type="sect1"><div class="sect1" id="collectioncross">&#13;
<h1>Collectioncross</h1>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg527.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p><a href="http://EclipseCrossword.com">EclipseCrossword.com</a></p>&#13;
<p><strong>Across</strong></p>&#13;
<p>1. Use the var keyword to declare an _____ typed variable</p>&#13;
<p>7. A collection _____ combines the declaration with items to add</p>&#13;
<p>9. What you’re trying to make your code when you have lots of tests for weird data and edge cases</p>&#13;
<p>11. LINQ method to return the last elements in a sequence</p>&#13;
<p>12. A last-in, first-out (LIFO) collection</p>&#13;
<p>18. LINQ method to return the first elements in a sequence</p>&#13;
<p>19. A method that has multiple constructors with different parameters</p>&#13;
<p>20. The type of parameter that tells you that you can use a lambda</p>&#13;
<p>21. What you take advantage of when you upcast an entire list</p>&#13;
<p>22. What you’re using when you call myArray[3]</p>&#13;
<p>25. What T gets replaced with when you see &lt;T&gt; in a class or interface definition</p>&#13;
<p>32. The keyword you use to create an anonymous object</p>&#13;
<p>33. A data type that only allows certain values</p>&#13;
<p>34. The kind of collection that can store any type</p>&#13;
<p>35. The interface that all sequences implement</p>&#13;
<p>36. Another name for the ?: conditional operator</p>&#13;
<p><strong>Down</strong></p>&#13;
<p>1. If you want to sort a List, its members need to implement this</p>&#13;
<p>2. A collection class for storing items in order</p>&#13;
<p>3. A collection that stores keys and values</p>&#13;
<p>4. What you pass to List.Sort to tell it how to sort its items</p>&#13;
<p><strong>Down</strong></p>&#13;
<p>5. What goes in the parentheses: ( _____ ) =&gt; expression;</p>&#13;
<p>6. You can’t use the var keyword to declare one of these</p>&#13;
<p>8. The access modifier for a class that can’t be accessed by another project in a multiproject solution</p>&#13;
<p>10. The kind of expression the =&gt; operator creates</p>&#13;
<p>13. LINQ method to append the elements from one sequence to the end of another</p>&#13;
<p>14. Every collection has this method to put a new element into it</p>&#13;
<p>15. What you can do with methods in a class that return the type of that class</p>&#13;
<p>16. What kind of type you’re looking at when the IDE tells you this: <code>’a’ is a new string Color, int Height</code></p>&#13;
<p>17. An object’s namespace followed by a period followed by the class is a fully _____ class name</p>&#13;
<p>23. The kind of evaluation that means a LINQ query isn’t run until its results are accessed</p>&#13;
<p>24. The clause in a LINQ query that sorts the results</p>&#13;
<p>26. Type of variable created by the from clause in a LINQ query</p>&#13;
<p>27. The Enumerable method that returns a sequence with many copies of the same element</p>&#13;
<p>28. The clause in a LINQ query that determines which elements in the input to use</p>&#13;
<p>29. A LINQ query that merges data from two sequences</p>&#13;
<p>30. A first-in, first-out (FIFO) collection</p>&#13;
<p>31. The keyword a switch statement has that a switch expression doesn’t</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="downloadable_exercise_go_fish">&#13;
<h5><span class="inlineimage"><img alt="Images" src="assets/com25.png"/></span> Downloadable exercise: Go Fish</h5>&#13;
<p><a data-primary="exercises" data-secondary="test" data-type="indexterm" id="idm46402339905384"/><a data-primary="test-driven development" data-type="indexterm" id="idm46402339904072"/>In this next exercise you’ll build a Go Fish card game where you play against computer players.Unit testing will play an important part, because you’ll be doing <strong>test-driven development</strong>, a technique where you write your unit tests before you write the code that they test.</p>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg528-2.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
<p><strong>Go to the GitHub page for the book and download the project PDF:</strong></p>&#13;
<p><a href="https://github.com/head-first-csharp/fourth-edition">https://github.com/head-first-csharp/fourth-edition</a></p>&#13;
</div></aside>&#13;
</div></section>&#13;
<section data-pdf-bookmark="Collectioncross Solution" data-type="sect1"><div class="sect1" id="collectioncross_solution">&#13;
<h1>Collectioncross Solution</h1>&#13;
<figure class="informal"><div class="figure">&#13;
<img alt="Images" src="assets/pg528-3.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
</div></section>&#13;
</div></section></body></html>