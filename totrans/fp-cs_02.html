<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xml:lang="en"
      lang="en"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:epub="http://www.idpf.org/2007/ops">
<head>
<title>Functional Programming with C#</title>
<link rel="stylesheet" type="text/css" href="override_v1.css"/>
<link rel="stylesheet" type="text/css" href="epub.css"/>
</head>
<body>
<div id="book-content">
<div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 2. What Can We Do Already?"><div class="chapter" id="Chapter2_Beginning">
<h1><span class="label">Chapter 2. </span>What Can We Do Already?</h1>

<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45400885987520">
<h1>A Note for Early Release Readers</h1>
<p>With Early Release ebooks, you get books in their earliest form—the author’s raw and unedited content as they write—so you can take advantage of these technologies long before the official release of these titles.</p>

<p>This will be the second chapter of the final book. Please note that the GitHub repo will be made active later on.</p>

<p>If you have comments about how we might improve the content and/or examples in this book, or if you notice missing material within this chapter, please reach out to the editor at <a href="mailto:jleonard@oreilly.com">jleonard@oreilly.com</a>.</p>
</div></aside>

<p>Some of the code and concepts discussed in this chapter may seem trivial to some, but bear with me.  I don’t want to introduce too much too soon.  More experienced developers might like to skip ahead to Chapter 3, in which I talk about the more recent developments in C# for Functional progammers, or Chapter 4 where I demonstrate some novel ways to use features you might already be familiar with to achive some Functional features.</p>

<p>In this chapter, I’m going to look at the Functional Programming features that are possible in just about every C# codebase in use in production today.  I’m going to assume at least .NET Framework 3.5, and with some minor alterations, all of the code samples provided in this chapter will work in that environment.  Even if you work in a more recent version of .NET, but are unfamiliar with Functional Programming, I still recommend reading this chapter, as it should give you a decent starting point in programming with the Functional Paradigm.</p>

<p>Those of you familiar already with Functional code, and just want to see what’s available in the latest versions of .NET, it might be best to skip ahead to the next chapter.</p>






<section data-type="sect1" data-pdf-bookmark="Getting Started"><div class="sect1" id="idm45400885982512">
<h1>Getting Started</h1>

<p>Functional Programming is easy, really it is!  Despite what many people think, it’s easier to learn than Object-Oriented progrmanning.  There are fewer concepts to learn, and actually less to get your head around.</p>

<p>If you don’t believe me, try explaining Polymorphism to a non-technical member of your family!  Those of us that are comfortable with Object Orientation have often been doing it so long that we’ve forgotten how hard it may have been to get our heads around it at the beginning.</p>

<p>Functional programming isn’t hard to understand at all, just different.  I’ve spoken to plenty of students coming out of university that embrace it with enthusiasm.  So, if <em>they</em> can manage it…​</p>

<p>The myth does seem to persist though, that to get into Functional Programming, there’s a whole load of stuff that needs learning first.  What if I told you though, that if you’ve been doing C# for any length of time, you’ve already most likely been writing Functional code for a while?  Let me show you what I mean…​</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Your First Functional Code"><div class="sect1" id="idm45400885978928">
<h1>Your First Functional Code</h1>

<p>Before we start with some functional code, let’s look at a bit of non-functional.  A style you most likely learned somewhere very near the beginning of your C# career.</p>








<section data-type="sect2" data-pdf-bookmark="A Non-Functional Film Query"><div class="sect2" id="idm45400885977424">
<h2>A Non-Functional Film Query</h2>

<p>In my quick, made-up example, I’m getting a list of all films from my imaginary data store and creating a new list, copied from the first, but only those items in the Action genre<sup><a data-type="noteref" id="idm45400885975216-marker" href="ch02.html#idm45400885975216">1</a></sup></p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="n">IEnumerable</code><code class="p">&lt;</code><code class="n">Film</code><code class="p">&gt;</code> <code class="n">GetFilmsByGenre</code><code class="p">(</code><code class="kt">string</code> <code class="n">genre</code><code class="p">)</code>
<code class="p">{</code>
 <code class="kt">var</code> <code class="n">allFilms</code> <code class="p">=</code> <code class="n">GetAllFilms</code><code class="p">();</code>
 <code class="kt">var</code> <code class="n">chosenFilms</code> <code class="p">=</code> <code class="k">new</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">Film</code><code class="p">&gt;();</code>

 <code class="k">foreach</code> <code class="p">(</code><code class="kt">var</code> <code class="n">f</code> <code class="k">in</code> <code class="n">allFilms</code><code class="p">)</code>
 <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="n">f</code><code class="p">.</code><code class="n">Genre</code> <code class="p">==</code> <code class="n">genre</code><code class="p">)</code>
  <code class="p">{</code>
      <code class="n">chosenFilms</code><code class="p">.</code><code class="n">Add</code><code class="p">((</code><code class="n">f</code><code class="p">));</code>
  <code class="p">}</code>
 <code class="p">}</code>

 <code class="k">return</code> <code class="n">chosenFilms</code><code class="p">;</code>

<code class="p">}</code>

<code class="kt">var</code> <code class="n">actionFilms</code> <code class="p">=</code> <code class="n">GetFilmsByGenre</code><code class="p">(</code><code class="s">"Action"</code><code class="p">);</code></pre>

<p>What’s wrong with this code?  At the very least, it’s not very elegant.  That’s a lot we’ve written to do something fairly simple.</p>

<p>We’ve also instantiated a new object that’s going to stay in scope for as long as this function is running.  If there’s nothing more to the whole function than this, then there’s not much to worry about. But, what if this were just a short excerpt from a very long function?  In that instance, the allFilms and actionFilms variables would both remain in scope, and thus in memory all that time, even if they aren’t in use.</p>

<p>There may not necessarily be copies of all of the data held within the item that’s being replicated, depending on whether it’s a class, a struct or whatever else.  At the very least though, there’s a duplicate set of references being held unnecessarily in memory for as long as both items are in scope.  That’s still more memory than we strictly need to hold.</p>

<p>We’re also forcing the order of operations.  We’ve specified when to loop, when to add, etc.  Both where and when each step should be carried out.  If there were any intermediate steps in the data transformations to be carried out, we’d be specifying them too, and holding them in yet more potentially long-life variables.</p>

<p>I could solve a few problems with a <code>yield</code> return like this:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="n">IEnumerable</code><code class="p">&lt;</code><code class="n">Film</code><code class="p">&gt;</code> <code class="n">GetFilmsByGenre</code><code class="p">(</code><code class="kt">string</code> <code class="n">genre</code><code class="p">)</code>
<code class="p">{</code>
 <code class="kt">var</code> <code class="n">allFilms</code> <code class="p">=</code> <code class="n">GetAllFilms</code><code class="p">();</code>

 <code class="k">foreach</code> <code class="p">(</code><code class="kt">var</code> <code class="n">f</code> <code class="k">in</code> <code class="n">allFilms</code><code class="p">)</code>
 <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="n">f</code><code class="p">.</code><code class="n">Genre</code> <code class="p">==</code> <code class="n">genre</code><code class="p">)</code>
  <code class="p">{</code>
      <code class="k">yield</code> <code class="k">return</code> <code class="n">f</code><code class="p">;</code>
  <code class="p">}</code>
 <code class="p">}</code>
<code class="p">}</code>

<code class="kt">var</code> <code class="n">actionFilms</code> <code class="p">=</code> <code class="n">GetFilmsByGenre</code><code class="p">(</code><code class="s">"Action"</code><code class="p">);</code></pre>

<p>This hasn’t done more than shave a few lines off, however.</p>

<p>What if there were a more optimal order of operations than the one we’ve decided on?  What if a later bit of code actually meant that we don’t end up returning the contents of actionFilms?  We’d have done the work unnecessarily.</p>

<p>This is the eternal problem of procedural code.  Everything has to be spelled out.  One of our major aims with Functional Programming is to move away from all that.  Stop being so specific about every little thing.  Relax a little, and embrace declaritive code.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="A Functional Film Query"><div class="sect2" id="idm45400885976800">
<h2>A Functional Film Query</h2>

<p>So, what would that code sample above look like written in a Functional style?  I’d hope many of you might already guess at how you would re-write it.</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="n">IEnumerable</code><code class="p">&lt;</code><code class="n">Film</code><code class="p">&gt;</code> <code class="n">GetFilmsByGenre</code><code class="p">(</code><code class="n">IEnumerable</code><code class="p">&lt;</code><code class="n">Film</code><code class="p">&gt;</code> <code class="n">source</code><code class="p">,</code> <code class="kt">string</code> <code class="n">genre</code><code class="p">)</code> <code class="p">=&gt;</code>
 <code class="n">source</code><code class="p">.</code><code class="n">Where</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="n">x</code><code class="p">.</code><code class="n">Genre</code> <code class="p">==</code> <code class="n">genre</code><code class="p">);</code>

 <code class="kt">var</code> <code class="n">allFilms</code> <code class="p">=</code> <code class="n">GetAllFilms</code><code class="p">();</code>
 <code class="kt">var</code> <code class="n">actionFilms</code> <code class="p">=</code> <code class="n">GetFilmsByGenre</code><code class="p">(</code><code class="n">allFilms</code><code class="p">,</code> <code class="s">"Action"</code><code class="p">);</code></pre>

<p>If anyone at this point is saying “isn’t that just LINQ?”, then yes. Yes, it is.  I’ll let you all in on a little secret - LINQ follows the Functional paradigm.</p>

<p>Just quickly, for anyone that’s not yet familiar with the awesomeness of LINQ.  It’s a library that’s been part of C# since the early days, and provides a rich set of functions for filtering, altering and extending collections of data.  Functions like <code>Select</code>, <code>Where</code> and <code>All</code> are from LINQ and commonly used around the world.</p>

<p>Think back for a moment to the list of features of Functional Programming, and see how many LINQ implements…​</p>

<ul>
<li>
<p>Higher-order Functions - The lambda expressions passed to LINQ functions are all functions, being passed in as parameter variables.</p>
</li>
<li>
<p>Immutability - LINQ doesn’t change the source array, it returns a new <code>Enumerable</code> based on the old one.</p>
</li>
<li>
<p>Expressions instead of Statements - We’ve eliminated the use of a <code>ForEach</code> and an <code>If</code></p>
</li>
<li>
<p>Referential Transparency - The Lambda Expression I’ve written here does actually conform to Referential Transparency (I.e. “no side effects”), though there’s nothing enforcing that.  I could easily have referenced a string variable outside the Lambda.  By requiring that the source data be passed in as a parameter, I’m also making it easier to test without requiring the creation &amp; setup of a Mock of some kind to represent the data store connection.  Everything the function needs is provided by its own parameters.</p>
</li>
</ul>

<p>The iteration could well be done by recursion too, for all I know, but I have no idea what the source code of the Where function looks like.  In the absence of evidence to the contrary, I’m just going to go on believing that it does.</p>

<p>This tiny little one-line code sample is a perfect example of the Functional approach in many ways.  We’re passing around functions to perform operations against a collection of data, creating a new collection based on the old one.</p>

<p>What we’ve ended up with by following the Functional paradigm is something more concise, easier to read and therefore far easier to maintain.</p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Results-Oriented Programming"><div class="sect1" id="idm45400887092832">
<h1>Results-Oriented Programming</h1>

<p>A common feature of Functional code is that it focuses much more heavily on the end result, rather than on the process of getting there.  An entirely Procedural method of building a complex object would be to instantiate it empty at the beginning of the code block, then fill in each property as we go along.</p>

<p>Something like this:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="kt">var</code> <code class="n">sourceData</code> <code class="p">=</code> <code class="n">GetSourceData</code><code class="p">();</code>
<code class="kt">var</code> <code class="n">obj</code> <code class="p">=</code> <code class="k">new</code> <code class="n">ComplexCustomObject</code><code class="p">();</code>

<code class="n">obj</code><code class="p">.</code><code class="n">PropertyA</code> <code class="p">=</code> <code class="n">sourceData</code><code class="p">.</code><code class="n">Something</code> <code class="p">+</code> <code class="n">sourceData</code><code class="p">.</code><code class="n">SomethingElse</code><code class="p">;</code>
<code class="n">obj</code><code class="p">.</code><code class="n">PropertyB</code> <code class="p">=</code> <code class="n">sourceData</code><code class="p">.</code><code class="n">Ping</code> <code class="p">*</code> <code class="n">sourceData</code><code class="p">.</code><code class="n">Pong</code><code class="p">;</code>

<code class="k">if</code><code class="p">(</code><code class="n">sourceData</code><code class="p">.</code><code class="n">AlternateTuesday</code><code class="p">)</code>
<code class="p">{</code>
  <code class="n">obj</code><code class="p">.</code><code class="n">PropertyC</code> <code class="p">=</code> <code class="n">sourceData</code><code class="p">.</code><code class="n">CaptainKirk</code><code class="p">;</code>
  <code class="n">obj</code><code class="p">.</code><code class="n">PropertyD</code> <code class="p">=</code> <code class="n">sourceData</code><code class="p">.</code><code class="n">MrSpock</code><code class="p">;</code>
<code class="p">}</code>
<code class="k">else</code>
<code class="p">{</code>
   <code class="n">obj</code><code class="p">.</code><code class="n">PropertyC</code> <code class="p">=</code> <code class="n">sourceData</code><code class="p">.</code><code class="n">CaptainPicard</code><code class="p">;</code>
   <code class="n">obj</code><code class="p">.</code><code class="n">PropertyD</code> <code class="p">=</code> <code class="n">sourceData</code><code class="p">.</code><code class="n">NumberOne</code><code class="p">;</code>
<code class="p">}</code>

<code class="k">return</code> <code class="n">obj</code><code class="p">;</code></pre>

<p>The problem with this approach is that it’s very open to abuse.  This silly little imaginary codeblock I’ve created here is short and easy to maintain.  What often happens with production code however, is that the code can end up becoming incredibly long, with multiple data sources that all have to be pre-processed, joined, re-processed, etc.  You can end up with long blocks of If-statements nested in If-statements, to the point that the code starts resembling the shape of a Family Tree.</p>

<p>For each nested If-statement, the complexity effectively doubles.  This is especially true if there are multiple return statements scattered around the codebase.  The risk increases of inadvertently ending up with a Null or some other unexpected value if the increasingtly complex codebase isn’t thought through in detail.  Functional Programming discourages structures like this, and isn’t prone to this level of complexity, or of the potential unexpected consequences.</p>

<p>In our code sample above, we have PropertyC and PropertyD defined in 2 different places.  It’s not too hard to work with here, but I’ve seen examples where the same property is defined in around half a dozen places across multiple classes and sub-classes<sup><a data-type="noteref" id="idm45400886839824-marker" href="ch02.html#idm45400886839824">2</a></sup>.</p>

<p>I don’t know whether you’ve ever had to work with code like this?  It’s happened to me an awful lot.</p>

<p>These sorts of large, unweildy codebases only ever get harder to work with over time.  With each addition, the actual speed at which the developers can do the work goes down, and the business can end up getting frustrated because they don’t understand why their “simple” update is taking so long.</p>

<p>Functional code should ideally be written into small, concise blocks, focusing entirely on the end product.  The expressions it prefers are modelled on mathematical working, so you really want to write it like small formulas, each precisely defining a value and all of the variables that make it up.  There shouldn’t be any hunting up and down the codebase to work out where a value comes from.</p>

<p>Something like this:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="n">function</code> <code class="n">ComplexCustomObject</code> <code class="nf">MakeObject</code><code class="p">(</code><code class="n">SourceData</code> <code class="n">source</code><code class="p">)</code> <code class="p">=&gt;</code>
    <code class="k">new</code> <code class="n">ComplexCustomObject</code>
    <code class="p">{</code>
       <code class="n">PropertyA</code> <code class="p">=</code> <code class="n">source</code><code class="p">.</code><code class="n">Something</code> <code class="p">+</code> <code class="n">source</code><code class="p">.</code><code class="n">SomethingElse</code><code class="p">,</code>
       <code class="n">PropertyB</code> <code class="p">=</code> <code class="n">source</code><code class="p">.</code><code class="n">Ping</code> <code class="p">*</code> <code class="n">source</code><code class="p">.</code><code class="n">Pong</code><code class="p">,</code>
       <code class="n">PropertyC</code> <code class="p">=</code> <code class="n">source</code><code class="p">.</code><code class="n">AlternateTuesday</code>
                     <code class="p">?</code> <code class="n">source</code><code class="p">.</code><code class="n">CaptainKirk</code>
                     <code class="p">:</code> <code class="n">source</code><code class="p">.</code><code class="n">CaptainPicard</code><code class="p">,</code>
       <code class="n">PropertyD</code> <code class="p">=</code> <code class="n">source</code><code class="p">.</code><code class="n">AlternateTuesday</code>
                     <code class="p">?</code> <code class="n">source</code><code class="p">.</code><code class="n">MrSpock</code><code class="p">,</code>
                     <code class="p">:</code> <code class="n">source</code><code class="p">.</code><code class="n">NumberOne</code>
    <code class="p">};</code></pre>

<p>I know I’m now repeating the AlternateTuesday flag, but it means that all of the variables that determine a returned property are defined in a single place.  It makes it much simpler to work with in the future.</p>

<p>In the event that a property is so complicated that it will either need multiple lines of code, or a series of Linq operations that takes up a lot of space, then I’d create a break-out function to contain that complex logic.  I’d still have my central, result-based return at the heart of it all, though.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="A few words about Enumerables"><div class="sect1" id="idm45400887092208">
<h1>A few words about Enumerables</h1>

<p>I sometimes think Enumerables are one of the most under-used and least understood features of C#.  An Enumerable is the most abstract representation of a collection of data - so abstract that it doesn’t contain any data itself, it’s actually just a description held in memory of how to go about getting the data.  An Enumerable doesn’t even know how many items there are available until it iterates through everything - all it knows is where the current item is, and how to iterate to the next.</p>

<p>This is called <em>Lazy Evaluation</em> or <em>deferred Execution</em>.  Being lazy is a good thing in development.  Don’t let anyone tell you otherwise<sup><a data-type="noteref" id="idm45400886206224-marker" href="ch02.html#idm45400886206224">3</a></sup>.</p>

<p>In fact, you can even write your own entire customised behaviour for an Enumerable if you wanted.  Under the surface, there’s an object called an Enumerator.  Interacting with that can be used to either get the current item, or iterate on to the next.  You can’t use it to determine the length of the list, and the iteration only works in a single direction.</p>

<p>Have a look at this code sample:</p>

<p>First a set of simple logging functions that pop a message in a List of strings:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="n">IList</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="n">c</code> <code class="p">=</code> <code class="k">new</code> <code class="n">List</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;();</code>


<code class="k">public</code> <code class="kt">int</code> <code class="nf">DoSomethingOne</code><code class="p">(</code><code class="kt">int</code> <code class="n">x</code><code class="p">)</code>
<code class="p">{</code>
	<code class="n">c</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code><code class="n">DateTime</code><code class="p">.</code><code class="n">Now</code> <code class="p">+</code> <code class="s">" - DoSomethingOne ("</code> <code class="p">+</code> <code class="n">x</code> <code class="p">+</code> <code class="s">")"</code><code class="p">);</code>
	<code class="k">return</code> <code class="n">x</code><code class="p">;</code>
<code class="p">}</code>

<code class="k">public</code> <code class="kt">int</code> <code class="nf">DoSomethingTwo</code><code class="p">(</code><code class="kt">int</code> <code class="n">x</code><code class="p">)</code>
<code class="p">{</code>
	<code class="n">c</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code><code class="n">DateTime</code><code class="p">.</code><code class="n">Now</code> <code class="p">+</code> <code class="s">" - DoSomethingTwo ("</code> <code class="p">+</code> <code class="n">x</code> <code class="p">+</code> <code class="s">")"</code><code class="p">);</code>
	<code class="k">return</code> <code class="n">x</code><code class="p">;</code>
<code class="p">}</code>

<code class="k">public</code> <code class="kt">int</code> <code class="nf">DoSomethingThree</code><code class="p">(</code><code class="kt">int</code> <code class="n">x</code><code class="p">)</code>
<code class="p">{</code>
	<code class="n">c</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code><code class="n">DateTime</code><code class="p">.</code><code class="n">Now</code> <code class="p">+</code> <code class="s">" - DoSomethingThree ("</code> <code class="p">+</code> <code class="n">x</code> <code class="p">+</code> <code class="s">")"</code><code class="p">);</code>
	<code class="k">return</code> <code class="n">x</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>Then a bit of code that calls each of those “DoSomething” functions in turn with different data.</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="kt">var</code> <code class="n">input</code> <code class="p">=</code> <code class="k">new</code><code class="p">[]</code>
<code class="p">{</code>
	<code class="m">75</code><code class="p">,</code>
	<code class="m">22</code><code class="p">,</code>
	<code class="m">36</code>
<code class="p">};</code>

<code class="kt">var</code> <code class="n">output</code> <code class="p">=</code> <code class="n">input</code><code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="n">DoSomethingOne</code><code class="p">(</code><code class="n">x</code><code class="p">))</code>
	 <code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="n">DoSomethingTwo</code><code class="p">(</code><code class="n">x</code><code class="p">))</code>
	 <code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="n">DoSomethingThree</code><code class="p">(</code><code class="n">x</code><code class="p">))</code>
	 <code class="p">.</code><code class="n">ToArray</code><code class="p">();</code></pre>

<p>What do you think the order of operations is?  You might think that the runtime would take the original input array, apply DoSomethingOne to all 3 elements to create a second array, then again with all three elements into DoSomethingTwo, and so on.</p>

<p>If I were to examine the content of that List of strings, I’d find something like this:</p>

<pre data-type="programlisting"> 18/08/1982 11:24:00 - DoSomethingOne(75)
 18/08/1982 11:24:01 - DoSomethingTwo(75)
 18/08/1982 11:24:02 - DoSomethingThree(75)
 18/08/1982 11:24:03 - DoSomethingOne(22)
 18/08/1982 11:24:04 - DoSomethingTwo(22)
 18/08/1982 11:24:05 - DoSomethingThree(22)
 18/08/1982 11:24:06 - DoSomethingOne(36)
 18/08/1982 11:24:07 - DoSomethingTwo(36)
 18/08/1982 11:24:08 - DoSomethingThree(36)</pre>

<p>It’s almost the exact same as you might get if you were running this through a <code>For</code>/<code>ForEach</code> loop, but we’ve effectively handed over control of the order of operations to the runtime.  We’re not concerned with the nitty-gritty of temporary holding variables, what goes where and when.  Instead we’re just describing the operations we want, and expecting a single answer back at the end.</p>

<p>It might not always look exactly like that, it depends on what the code that calls it looks like.  But the intent always remains, that Enumerables only actually produce their data at the precise moment it’s needed.  It doesn’t matter where they’re defined, it’s when they’re <em>used</em> that makes a difference.</p>

<p>Using Enumerables instead of solid arrays, we’ve actually managed to implement some of the behaviors we need to write Declarative code.</p>

<p>Incredibly, the log file I wrote above would still look the same if I were to re-write the code like this:</p>

<pre data-type="programlisting" data-code-language="csharp"> <code class="kt">var</code> <code class="n">input</code> <code class="p">=</code> <code class="k">new</code><code class="p">[]</code>
 <code class="p">{</code>
     <code class="m">1</code><code class="p">,</code>
     <code class="m">2</code><code class="p">,</code>
     <code class="m">3</code>
 <code class="p">};</code>

 <code class="kt">var</code> <code class="n">temp1</code> <code class="p">=</code> <code class="n">input</code><code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="n">DoSomethingOne</code><code class="p">(</code><code class="n">x</code><code class="p">));</code>
 <code class="kt">var</code> <code class="n">temp2</code> <code class="p">=</code> <code class="n">input</code><code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="n">DoSomethingTwo</code><code class="p">(</code><code class="n">x</code><code class="p">));</code>
 <code class="kt">var</code> <code class="n">finalAnswer</code> <code class="p">=</code> <code class="n">input</code><code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="n">DoSomethingThree</code><code class="p">(</code><code class="n">x</code><code class="p">));</code></pre>

<p>temp1, temp2 and finalAnswer are all Enumerables, and none of them will contain any data until iterated.</p>

<p>Here’s an experiment for you to try.  Write some code like this sample.  Don’t copy it exactly, maybe something simpler like a series of selects amending an integer value somehow.  Put a break point in and move the operation pointer on until final answer has been passed, then hover over finalAnswer in Visual Studio.  What you’ll most likely find is that it can’t display any data to you, even though the line has been passed.  That’s beause it hasn’t actually performed any of the operations yet.</p>

<p>Things would change if I did something like this:</p>

<pre data-type="programlisting" data-code-language="csharp"> <code class="kt">var</code> <code class="n">input</code> <code class="p">=</code> <code class="k">new</code><code class="p">[]</code>
 <code class="p">{</code>
     <code class="m">1</code><code class="p">,</code>
     <code class="m">2</code><code class="p">,</code>
     <code class="m">3</code>
 <code class="p">};</code>

 <code class="kt">var</code> <code class="n">temp1</code> <code class="p">=</code> <code class="n">input</code><code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="n">DoSomethingOne</code><code class="p">(</code><code class="n">x</code><code class="p">)).</code><code class="n">ToArray</code><code class="p">();</code>
 <code class="kt">var</code> <code class="n">temp2</code> <code class="p">=</code> <code class="n">input</code><code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="n">DoSomethingTwo</code><code class="p">(</code><code class="n">x</code><code class="p">)).</code><code class="n">ToArray</code><code class="p">();</code>
 <code class="kt">var</code> <code class="n">finalAnswer</code> <code class="p">=</code> <code class="n">input</code><code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="n">DoSomethingThree</code><code class="p">(</code><code class="n">x</code><code class="p">)).</code><code class="n">ToArray</code><code class="p">();</code></pre>

<p>Because I’m specifically now calling <code>ToArray()</code> to force an enumeration of each intermediate step, then we really will call DoSomethingOne for each item in input before moving onto the next stop.</p>

<p>The log file would look something like this now:</p>

<pre data-type="programlisting"> 18/08/1982 11:24:00 - DoSomethingOne(75)
 18/08/1982 11:24:01 - DoSomethingOne(22)
 18/08/1982 11:24:02 - DoSomethingOne(36)
 18/08/1982 11:24:03 - DoSomethingTwo(75)
 18/08/1982 11:24:04 - DoSomethingTwo(22)
 18/08/1982 11:24:05 - DoSomethingTwo(36)
 18/08/1982 11:24:06 - DoSomethingThree(75)
 18/08/1982 11:24:07 - DoSomethingThree(22)
 18/08/1982 11:24:08 - DoSomethingThree(36)</pre>

<p>For this reason, I nearly always advocate for waiting as long as possible before using <code>ToArray()</code> or <code>ToList()</code> <sup><a data-type="noteref" id="idm45400883250816-marker" href="ch02.html#idm45400883250816">4</a></sup>, because this way we can leave the operations unperformed for as long as possible.  And potentially even never performed if later logic prevents the enumeration from occurring at all.</p>

<p>There are some exceptions.  Either for performance, or for avoiding multiple iterations.  While the Enumerable remains un-enumerated it doesn’t have any data, but the operation itself remains in memory.  If you pile too many of them on top of each other - especially if you start performing recursive operations, then you might find that you fill up far too much memory and performance takes a hit, and possibly even end up with a stack overflow.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Prefer Expressions to Statements"><div class="sect1" id="idm45400886208160">
<h1>Prefer Expressions to Statements</h1>

<p>In the rest of this chapter, I’m going to give more examples of how Linq can be used more effectively to avoid the need to use statements like If, Where, For, etc. or to mutate state (i.e. change the value of a variable).</p>

<p>There will be cases that aren’t possible, or aren’t ideal.  But, that’s what the rest of this book is for.</p>








<section data-type="sect2" data-pdf-bookmark="The Humble Select"><div class="sect2" id="idm45400883200448">
<h2>The Humble Select</h2>

<p>If you’ve read this far in the book, you’re most likely aware of Select statements, and how to use them.  There are a few features though, that most people I speak to don’t seem to be aware of, and they’re all things that can be used to make our code a little more functional.</p>

<p>The first thing was something I’ve already shown in the previous section - you can chain them.  Either as a series of Select function calls - literally one after the other, or in a single code line; or else you can store the results of each Select in a different local variable.  Functionally these two approaches are identical.  It doesn’t even matter if you call ToArray after each one.  So long as you don’t modify any resulting arrays or the object contained within them, you’re following the Functional paradigm.</p>

<p>The important thing is to get away from is the Imperative practice of defining a List, looping through the source objects with a ForEach and then adding each new item to the List.  This is long-winded, harder to read, and honestly quite tedious.  Why do things the hard way?  Just use a nice, simple Select statement.</p>










<section data-type="sect3" data-pdf-bookmark="Passing working values via tuples"><div class="sect3" id="idm45400883198176">
<h3>Passing working values via tuples</h3>

<p>Tuples were introduced in C#7.  Nuget packages do exist to allow some of the older versions of C# to use them too.  They’re basically a way to throw together a quick-and-dirty collection of properties, without having to create and maintain a class.</p>

<p>If you’ve got a few properties you want to hold onto for a minute in one place, then dispose of immediately, Tuples are great for that.</p>

<p>If you have multiple objects you want to pass between Selects, or multiple items you want to pass in or out of one, then you can use a Tuple.</p>

<pre data-type="programlisting" data-code-language="csharp"> <code class="kt">var</code> <code class="n">filmIds</code> <code class="p">=</code> <code class="k">new</code><code class="p">[]</code>
 <code class="p">{</code>
     <code class="m">4665</code><code class="p">,</code>
     <code class="m">6718</code><code class="p">,</code>
     <code class="m">7101</code>
 <code class="p">};</code>

 <code class="kt">var</code> <code class="n">filmsWithCast</code> <code class="p">=</code> <code class="n">filmIds</code><code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="p">(</code>
     <code class="n">film</code><code class="p">:</code> <code class="n">GetFilm</code><code class="p">(</code><code class="n">x</code><code class="p">),</code>
     <code class="n">castList</code><code class="p">:</code> <code class="n">GetCastList</code><code class="p">(</code><code class="n">x</code><code class="p">)</code>
 <code class="p">));</code>

<code class="kt">var</code> <code class="n">renderedFilmDetails</code> <code class="p">=</code> <code class="n">filmsWithCast</code><code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code>
                <code class="err">@$</code><code class="s">"</code>
<code class="n">Title</code><code class="p">:</code> <code class="p">{</code><code class="n">x</code><code class="p">.</code><code class="n">film</code><code class="p">.</code><code class="n">Title</code><code class="p">}</code>
<code class="n">Director</code><code class="p">:</code> <code class="p">{</code><code class="n">x</code><code class="p">.</code><code class="n">film</code><code class="p">.</code><code class="n">Director</code><code class="p">}</code>
<code class="n">Cast</code><code class="p">:</code> <code class="p">{</code><code class="kt">string</code><code class="p">.</code><code class="n">Join</code><code class="p">(</code><code class="s">", "</code><code class="p">,</code> <code class="n">x</code><code class="p">.</code><code class="n">castList</code><code class="p">)}</code>
<code class="s">".Trim());</code></pre>

<p>In my example, above, I use a Tuple to pair up data from two look-up functions for each given film Id, meaning I can run a subsequent Select to simplify the pair of objects into a single return value.</p>
</div></section>










<section data-type="sect3" data-pdf-bookmark="Iterator value is required"><div class="sect3" id="idm45400883182048">
<h3>Iterator value is required</h3>

<p>Som what if you’re Select-ing an Enumerable into a new form, and you need the iterator as part of the transformation?  Something like this:</p>

<pre data-type="programlisting" data-code-language="csharp"> <code class="kt">var</code> <code class="n">films</code> <code class="p">=</code> <code class="n">GetAllFilmsForDirector</code><code class="p">(</code><code class="s">"Jean-Pierre Jeunet"</code><code class="p">)</code>
                                <code class="p">.</code><code class="n">OrderByDescending</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="n">x</code><code class="p">.</code><code class="n">BoxOfficeRevenue</code><code class="p">);</code>

 <code class="kt">var</code> <code class="n">i</code> <code class="p">=</code> <code class="m">1</code><code class="p">;</code>

 <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"The films of visionary French director"</code><code class="p">);</code>
 <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"Jean-Pierre Jeunet in descending order"</code>
 <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">" of financial success are as follows:"</code><code class="p">);</code>

 <code class="k">foreach</code> <code class="p">(</code><code class="kt">var</code> <code class="n">f</code> <code class="k">in</code> <code class="n">films</code><code class="p">)</code>
 <code class="p">{</code>
     <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"{i} - {f.Title}"</code><code class="p">);</code>
     <code class="n">i</code><code class="p">++;</code>
 <code class="p">}</code>

 <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"But his best by far is Amelie"</code><code class="p">);</code></pre>

<p>We can use a feature of Select statements that surprisingly few people know about - that it has an override that allows us access to the iterator as part of the Select.  All you have to do is provide a Lambda expression with 2 parameters, the second being an integer which represents the index position of the current item.</p>

<p>This is how our functional version of the code looks:</p>

<pre data-type="programlisting" data-code-language="csharp"> <code class="kt">var</code> <code class="n">films</code> <code class="p">=</code> <code class="n">GetAllFilmsForDirector</code><code class="p">(</code><code class="s">"Jean-Pierre Jeunet"</code><code class="p">)</code>
                           <code class="p">.</code><code class="n">OrderByDescending</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="n">x</code><code class="p">.</code><code class="n">BoxOfficeRevenue</code><code class="p">);</code>

 <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"The films of visionary French director"</code><code class="p">);</code>
 <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"Jean-Pierre Jeunet in descending order"</code>
 <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">" of financial success are as follows:"</code><code class="p">);</code>

 <code class="kt">var</code> <code class="n">formattedFilms</code> <code class="p">=</code> <code class="n">films</code><code class="p">.</code><code class="n">Select</code><code class="p">((</code><code class="n">x</code><code class="p">,</code> <code class="n">i</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="err">$</code><code class="s">"{i} - {x.Title}"</code><code class="p">);</code>
 <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="kt">string</code><code class="p">.</code><code class="n">Join</code><code class="p">(</code><code class="n">Environment</code><code class="p">.</code><code class="n">NewLine</code><code class="p">,</code> <code class="n">formattedFilms</code><code class="p">));</code>

 <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"But his best by far is Amelie"</code><code class="p">);</code></pre>

<p>Using these techniques, there’s nearly no circumstance that could exist where you need to use <code>ForEach</code> loop with a List.  Thanks to C#’s support for the Functional paradigm, there are nearly always Declaritive methods available to solve problems.</p>

<p>The two different methods of getting the “i” index position variable are a great example of Imperative vs Delarative code.  The Imperative, Object-Oriented method has the developer manually creating a variable to hold the value of i, and also explicitly set the place for the variable to be incremented.  The declaritive code isn’t concerned with where the variable is defined, or in how each index value is determined.</p>

<p>N.b - Notice that I used <code>string.Join</code> to link the strings together.  This is not only another one of those hidden gems of the C# language, but it’s also an example of Aggregation, that is - converting a list of things into a single thing.  That’s what we’ll walk through in the next few sections.</p>
</div></section>










<section data-type="sect3" data-pdf-bookmark="No Starting Array"><div class="sect3" id="idm45400882887888">
<h3>No Starting Array</h3>

<p>The last trick for getting the value of i for each iteration is great if there’s an array - or collection of some other kind - available in the first place.  What if there isn’t an array?  What if you need to arbitrarily iterate for a set number of times?</p>

<p>These are the situations - somewhat rare - where you need a good, old-fashioned <code>For</code> loop instead of a <code>ForEach</code>.  How do you create an array from nothing?</p>

<p>Your two best friends in this case are two static methods - <code>Enumerable.Range</code> and <code>Enumerable.Repeat</code>.</p>

<p>Range creates an array from a starting integer value, and requires you to tell it how many elements the array you want should have.  It then creates an array of integers based on those specifications.</p>

<p>For example:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="kt">var</code> <code class="n">a</code> <code class="p">=</code> <code class="n">Enumerable</code><code class="p">.</code><code class="n">Range</code><code class="p">(</code><code class="m">8</code><code class="p">,</code> <code class="m">5</code><code class="p">);</code>
<code class="kt">var</code> <code class="n">s</code> <code class="p">=</code> <code class="kt">string</code><code class="p">.</code><code class="n">Join</code><code class="p">(</code><code class="s">", "</code><code class="p">,</code> <code class="n">a</code><code class="p">);</code>
<code class="c1">// s = "8, 9, 10, 11, 12"</code>
<code class="c1">// That's 5 elements, each one higher than the last,</code>
<code class="c1">// starting with 8.</code></pre>

<p>Having whipped up an array, we can then apply LINQ operations to get our final result.  Let’s imagine I was preparing a description of the 9 times table for one of my daughters<sup><a data-type="noteref" id="idm45400882823232-marker" href="ch02.html#idm45400882823232">5</a></sup>.</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="kt">var</code> <code class="n">nineTimesTable</code> <code class="p">=</code> <code class="n">Enumerable</code><code class="p">.</code><code class="n">Range</code><code class="p">(</code><code class="m">1</code><code class="p">,</code><code class="m">10</code><code class="p">)</code>
 <code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="n">x</code> <code class="p">+</code> <code class="s">" times 9 is "</code> <code class="p">+</code> <code class="p">(</code><code class="n">x</code> <code class="p">*</code> <code class="m">9</code><code class="p">));</code>

<code class="kt">var</code> <code class="n">message</code> <code class="p">=</code> <code class="kt">string</code><code class="p">.</code><code class="n">Join</code><code class="p">(</code><code class="s">"\r\n"</code><code class="p">,</code> <code class="n">nineTimesTable</code><code class="p">);</code></pre>

<p>Here’s another example for you, what if I wanted to get all of the values from a grid of some kind, where an x and y value are required to get each value.  I’ll imagine there’s a grid repository of some kind that I can use to get values.</p>

<p>Imagining that the grid is a 5x5, this is how I’d get every value:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="kt">var</code> <code class="n">coords</code> <code class="p">=</code> <code class="n">Enumerable</code><code class="p">.</code><code class="n">Range</code><code class="p">(</code><code class="m">1</code><code class="p">,</code> <code class="m">5</code><code class="p">)</code>
	<code class="p">.</code><code class="n">SelectMany</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="n">Enumerable</code><code class="p">.</code><code class="n">Range</code><code class="p">(</code><code class="m">1</code><code class="p">,</code> <code class="m">5</code><code class="p">)</code>
		<code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">y</code> <code class="p">=&gt;</code> <code class="p">(</code><code class="n">X</code><code class="p">:</code> <code class="n">x</code><code class="p">,</code> <code class="n">Y</code><code class="p">:</code> <code class="n">y</code><code class="p">))</code>
<code class="p">);</code>

<code class="kt">var</code> <code class="n">values</code> <code class="p">=</code> <code class="n">coords</code><code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="k">this</code><code class="p">.</code><code class="n">gridRepo</code><code class="p">.</code><code class="n">GetVal</code><code class="p">(</code><code class="n">x</code><code class="p">.</code><code class="n">Item1</code><code class="p">,</code><code class="n">x</code><code class="p">.</code><code class="n">Item2</code><code class="p">);</code></pre>

<p>The first line here is generating an array of integers with the values <code>[1, 2, 3, 4, 5]</code>.  I then use another <code>Select</code> to convert each of these integers into another array using another call to <code>Enumerable.Range</code>.  This meant I now have an array of 5 elements, each of which was iteself an array of 5 integers.   Using a Select on that nested array, I converted each of those sub-elements into a tuple which took one value from the parent array (x) and one from the sub-array (y).  SelectMany is used to flatten the whole thing out to a simple list of all of the possible coordinates, which would look something like this: <code>(1, 1), (1, 2), (1, 3), (1, 4), (1, 5), (2, 1), (2, 2)</code>…​and so on.</p>

<p>Values can be obtained by Selecting this array of coordinates into a set of calls to the repository’s GetVal function, passing in the values of X and Y from the tuple of coordinates I created on the previous line.</p>

<p>Another situation we might be in is needing the same starting value in each case, but needing to transform it in different ways, depending on the position within the array.  This is where <code>Enumerable.Repeat</code> comes in.</p>

<p><code>Enumerable.Repeat</code> creates where each value is exactly the same, and you can specify exactly how many repeat elements you want.</p>

<p>You can’t use <code>Enumerable.Range</code> to count backwards.  What if we wanted to do the previous example, but start at (5,5) and move backwards to (1,1).  Here’s an example of how you’d do it:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="kt">var</code> <code class="n">gridCoords</code> <code class="p">=</code> <code class="n">Enumerable</code><code class="p">.</code><code class="n">Repeat</code><code class="p">(</code><code class="m">5</code><code class="p">,</code> <code class="m">5</code><code class="p">).</code><code class="n">Select</code><code class="p">((</code><code class="n">x</code><code class="p">,</code> <code class="n">i</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="n">x</code> <code class="p">-</code> <code class="n">i</code><code class="p">)</code>
	<code class="p">.</code><code class="n">SelectMany</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="n">Enumerable</code><code class="p">.</code><code class="n">Repeat</code><code class="p">(</code><code class="m">5</code><code class="p">,</code> <code class="m">5</code><code class="p">)</code>
		<code class="p">.</code><code class="n">Select</code><code class="p">((</code><code class="n">y</code><code class="p">,</code> <code class="n">i</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code> <code class="p">-</code> <code class="n">i</code><code class="p">))</code>
<code class="p">);</code>

<code class="kt">var</code> <code class="n">values</code> <code class="p">=</code> <code class="n">coords</code><code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="k">this</code><code class="p">.</code><code class="n">gridRepo</code><code class="p">.</code><code class="n">GetVal</code><code class="p">(</code><code class="n">x</code><code class="p">.</code><code class="n">Item1</code><code class="p">,</code><code class="n">x</code><code class="p">.</code><code class="n">Item2</code><code class="p">);</code></pre>

<p>This looks a lot more complicated, but it isn’t really.  What I’ve done is swap out the <code>Enumerable.Range</code> call for a 2-step operation.</p>

<p>First a call to <code>Enumerable.Repeat</code> which is repeating the integer value of 5 - 5 times.  This results in an array like this: <code>[5, 5, 5, 5, 5]</code>.</p>

<p>Having done that, I’m then selecting using the overloaded version of <code>Select</code> which includes the value of i, then deducting that i value from the current value in the array.  This means that in the first iteration, the return value is the current value i the array (5) minus the value of i (0 for the first iteration), this gives simply 5 back.  In the next iteration, the value of i is 1, so 5-1 means 4 is returned.  And so on.</p>

<p>At the end of it we get back an array that looks something like this: <code>(5, 5), (5, 4), (5, 3), (5, 2), (5, 1), (4, 5), (4, 4)</code> …​etc.</p>

<p>There are ways to take this further still, but for this chapter I’m sticking to the relatively simple cases, ones that don’t require hacking around with C#.  This is all out-of-the-box functionality that anyone can use right away.</p>
</div></section>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Many to One - The subtle art of Aggregation"><div class="sect2" id="idm45400882886976">
<h2>Many to One - The subtle art of Aggregation</h2>

<p>We’ve looked at loops for converting one thing into another, X items in → X new items out.  That sort’ve thing.  There’s another use case for loops that I’d like to cover - reducing many items into a single value.</p>

<p>This could be making a total count, calculating Averages, Means or other statistical data, or other more complex aggregations.</p>

<p>In Procedural code, we’d have a loop, a state tracking value and inside the loop we’d update the state constantly, based on each item from our array.  Here’s a very simple example of what I’m talking about:</p>

<pre data-type="programlisting" data-code-language="csharp"> <code class="kt">var</code> <code class="n">total</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code>
 <code class="k">foreach</code><code class="p">(</code><code class="kt">var</code> <code class="n">x</code> <code class="k">in</code> <code class="n">listOfIntegers</code><code class="p">)</code>
 <code class="p">{</code>
   <code class="n">total</code> <code class="p">+=</code> <code class="n">x</code><code class="p">;</code>
 <code class="p">}</code></pre>

<p>There’s actually an in-built Linq method for doing this:</p>

<pre data-type="programlisting" data-code-language="csharp"> <code class="kt">var</code> <code class="n">total</code> <code class="p">=</code> <code class="n">listOfIntegers</code><code class="p">.</code><code class="n">Sum</code><code class="p">();</code></pre>

<p>There really shouldn’t ever be a need to do this sort of operation “long-hand”.  Even if we’re creating the sum of a particular property from an array of Objects, Linq still has us covered:</p>

<pre data-type="programlisting" data-code-language="csharp"> <code class="kt">var</code> <code class="n">films</code> <code class="p">=</code> <code class="n">GetAllFilmsForDirector</code><code class="p">(</code><code class="s">"Alfred Hitchcock"</code><code class="p">);</code>
 <code class="kt">var</code> <code class="n">totalRevenue</code> <code class="p">=</code> <code class="n">films</code><code class="p">.</code><code class="n">Sum</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="n">x</code><code class="p">.</code><code class="n">BoxOfficeRevenue</code><code class="p">);</code></pre>

<p>There’s another function for calculating Means in the same manner called Average.  There’s nothing for calculating Median, so far as I’m aware.</p>

<p>I could calculate the Median with a quick bit of functional style code, however.  It would look like this:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="kt">var</code> <code class="n">numbers</code> <code class="p">=</code> <code class="k">new</code> <code class="p">[]</code> <code class="p">{</code>
    <code class="m">83</code><code class="p">,</code>
    <code class="m">27</code><code class="p">,</code>
    <code class="m">11</code><code class="p">,</code>
    <code class="m">98</code>
 <code class="p">};</code>

 <code class="kt">bool</code> <code class="nf">IsEvenNumber</code><code class="p">(</code><code class="kt">int</code> <code class="n">number</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="n">number</code> <code class="p">%</code> <code class="m">2</code> <code class="p">==</code> <code class="m">0</code><code class="p">;</code>

 <code class="kt">var</code> <code class="n">sortedList</code> <code class="p">=</code> <code class="n">numbers</code><code class="p">.</code><code class="n">OrderBy</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="n">x</code><code class="p">).</code><code class="n">ToArray</code><code class="p">();</code>
 <code class="kt">var</code> <code class="n">sortedListCount</code> <code class="p">=</code> <code class="n">sortedList</code><code class="p">.</code><code class="n">Count</code><code class="p">();</code>

 <code class="kt">var</code> <code class="n">median</code> <code class="p">=</code> <code class="n">IsEvenNumber</code><code class="p">(</code><code class="n">sortedList</code><code class="p">.</code><code class="n">Count</code><code class="p">())</code>
 				<code class="p">?</code> <code class="n">sortedList</code><code class="p">.</code><code class="n">Skip</code><code class="p">((</code><code class="n">sortedListCount</code><code class="p">/</code><code class="m">2</code><code class="p">)-</code><code class="m">1</code><code class="p">).</code><code class="n">Take</code><code class="p">(</code><code class="m">2</code><code class="p">).</code><code class="n">Average</code><code class="p">()</code>
				<code class="p">:</code> <code class="n">sortedList</code><code class="p">.</code><code class="n">Skip</code><code class="p">((</code><code class="n">sortedListCount</code><code class="p">)</code> <code class="p">/</code> <code class="m">2</code><code class="p">).</code><code class="n">First</code><code class="p">();</code>

<code class="c1">// median = 55.</code></pre>

<p>There are more complex aggregations that are required sometimes.  What if we wanted - for example - a sum of two different values from an Enumerable of complex objects?</p>

<p>Procedural code might look like this:</p>

<pre data-type="programlisting" data-code-language="csharp"> <code class="kt">var</code> <code class="n">films</code> <code class="p">=</code> <code class="n">GetAllFilmsForDirector</code><code class="p">(</code><code class="s">"Christopher Nolan"</code><code class="p">);</code>

 <code class="kt">var</code> <code class="n">totalBudget</code> <code class="p">=</code> <code class="m">0.0</code><code class="n">M</code><code class="p">;</code>
 <code class="kt">var</code> <code class="n">totalRevenue</code> <code class="p">=</code> <code class="m">0.0</code><code class="n">M</code><code class="p">;</code>

 <code class="k">foreach</code> <code class="p">(</code><code class="kt">var</code> <code class="n">f</code> <code class="k">in</code> <code class="n">films</code><code class="p">)</code>
 <code class="p">{</code>
     <code class="n">totalBudget</code> <code class="p">+=</code> <code class="n">f</code><code class="p">.</code><code class="n">Budget</code><code class="p">;</code>
     <code class="n">totalRevenue</code> <code class="p">+=</code> <code class="n">f</code><code class="p">.</code><code class="n">BoxOfficeRevenue</code><code class="p">;</code>
 <code class="p">}</code></pre>

<p>We could use two separate Sum function calls, but then we’d be iterating twice through the Enumerable, hardly an efficient way to get our information.  Instead, we can use another strangely little-known feature of Linq - the aggregate function.  This consists of the following components:</p>

<ul>
<li>
<p>Seed - a starting value for the final value.</p>
</li>
<li>
<p>An Aggregator function, this has two parameters - the current item from the Enumerable we’re aggregating down, and the current running total.</p>
</li>
</ul>

<p>The seed doesn’t have to be a primitive type, like an integer or whatever, it can just as easily be a complex object.  In order to re-write the code sample, above, in a Functional style, however, we just need a simple Tuple.</p>

<pre data-type="programlisting" data-code-language="csharp"> <code class="kt">var</code> <code class="n">films</code> <code class="p">=</code> <code class="n">GetAllFilmsForDirector</code><code class="p">(</code><code class="s">"Christopher Nolan"</code><code class="p">);</code>

 <code class="kt">var</code> <code class="p">(</code><code class="n">totalBudget</code><code class="p">,</code> <code class="n">totalRevenue</code><code class="p">)</code> <code class="p">=</code> <code class="n">films</code><code class="p">.</code><code class="n">Aggregate</code><code class="p">(</code>
	<code class="p">(</code><code class="n">Budget</code><code class="p">:</code> <code class="m">0.0</code><code class="n">M</code><code class="p">,</code> <code class="n">Revenue</code><code class="p">:</code> <code class="m">0.0</code><code class="n">M</code><code class="p">),</code>
	<code class="p">(</code><code class="n">runningTotals</code><code class="p">,</code> <code class="n">x</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="p">(</code>
			<code class="n">runningTotals</code><code class="p">.</code><code class="n">Budget</code> <code class="p">+</code> <code class="n">x</code><code class="p">.</code><code class="n">Budget</code><code class="p">,</code>
			<code class="n">runningTotals</code><code class="p">.</code><code class="n">Revenue</code> <code class="p">+</code> <code class="n">x</code><code class="p">.</code><code class="n">BoxOfficeRevenue</code>
		<code class="p">)</code>
<code class="p">);</code></pre>

<p>In the right place, Aggregate is an incredibly powerful feature of C#, and one worth taking the time to explore and understand properly.</p>

<p>It’s also an example of another concept important to Functional Programming - recursion.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Customised Iteration Behavior"><div class="sect2" id="idm45400882543328">
<h2>Customised Iteration Behavior</h2>

<p>Recursion sits at the back of a lot of Functional versions of Iteration.  For the benefit of anyone that doesn’t know, it’s a function that calls itself repeatedly until some condition or other is met.</p>

<p>It’s a very powerful technique, but has some limitations to bear in mind in C#.  The most important two being:</p>

<ul>
<li>
<p>If developed improperly, it can lead to infinite loops, which will literally run until the user terminates the application, or all available space on the stack is consumed.  As Treguard, the legendary Dungeon Master of the popular British Fantasy RPG gameshow <em>Knightmare</em> would put it: “Oooh, Nasty”<sup><a data-type="noteref" id="idm45400882090672-marker" href="ch02.html#idm45400882090672">6</a></sup>.</p>
</li>
<li>
<p>In C# they tend to be consume a lot of memory compared to other forms of iteration.  There are ways around this, but that’s a topic for another chapter.</p>
</li>
</ul>

<p>I have a lot more to say about recursion, and we’ll get to that shortly, but this for the purposes of this chapter, I’ll give the simplest example I can think of.</p>

<p>Let’s say that you want to iterate through an Enumerable but you don’t know how long for.  Let’s say you have a list of delta values for an integer (i.e. the amount to add or subtract each time) and you want to find out how many steps it is until you get from the starting value (whatever that might be) to 0.</p>

<p>You could quite easily get the final value with an Aggregate call, but we don’t want the final value.  We’re interested in all of the intermediate values, and we want to stop prematurely through the iteration.  This is a simple arithmetic operation, but if complex objects were involved in a real-world scenario, there might be a significant performance saving from the ability to terminate the process early.</p>

<p>In Procedural code, you’d probably write something like this:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="kt">var</code> <code class="n">deltas</code> <code class="p">=</code> <code class="n">GetDeltas</code><code class="p">().</code><code class="n">ToArray</code><code class="p">();</code>
<code class="kt">var</code> <code class="n">startingValue</code> <code class="p">=</code> <code class="m">10</code><code class="p">;</code>
<code class="kt">var</code> <code class="n">currentValue</code> <code class="p">=</code> <code class="n">startingValue</code><code class="p">;</code>
<code class="kt">var</code> <code class="n">i</code> <code class="p">=</code> <code class="p">-</code><code class="m">1</code><code class="p">;</code>

<code class="k">foreach</code><code class="p">(</code><code class="kt">var</code> <code class="n">d</code> <code class="k">in</code> <code class="n">deltas</code><code class="p">)</code>
<code class="p">{</code>
   <code class="k">if</code><code class="p">(</code><code class="n">currentValue</code> <code class="p">==</code> <code class="m">0</code><code class="p">)</code>
   <code class="p">{</code>
     <code class="k">break</code><code class="p">;</code>
   <code class="p">}</code>
   <code class="n">i</code><code class="p">++;</code>
   <code class="n">currentValue</code> <code class="p">=</code> <code class="n">startingValue</code> <code class="p">+</code> <code class="n">d</code><code class="p">;</code>

<code class="p">}</code>

<code class="k">return</code> <code class="n">i</code><code class="p">;</code></pre>

<p>In this example I’m returning -1 to say that the starting value is already the one we’re looking for, otherwise I’m returning the zero-based index of the array that resulted in 0 being reached.</p>

<p>This is how I’d do it recursively:</p>

<pre data-type="programlisting" data-code-language="csharp"> <code class="kt">var</code> <code class="n">deltas</code> <code class="p">=</code> <code class="n">GetDeltas</code><code class="p">().</code><code class="n">ToArray</code><code class="p">();</code>

 <code class="kt">int</code> <code class="nf">GetFirstPositionWithValueZero</code><code class="p">(</code><code class="kt">int</code> <code class="n">currentValue</code><code class="p">,</code> <code class="kt">int</code> <code class="n">i</code> <code class="p">=</code> <code class="p">-</code><code class="m">1</code><code class="p">)</code> <code class="p">=&gt;</code>
     <code class="n">currentValue</code> <code class="p">==</code> <code class="m">0</code>
         <code class="p">?</code> <code class="n">i</code>
         <code class="p">:</code> <code class="n">GetFirstPositionWithValueZero</code><code class="p">(</code><code class="n">currentValue</code> <code class="p">+</code> <code class="n">deltas</code><code class="p">[</code><code class="n">i</code><code class="p">],</code> <code class="n">i</code> <code class="p">+</code> <code class="m">1</code><code class="p">);</code>

 <code class="k">return</code> <code class="nf">GetFirstPositionWithValueZero</code><code class="p">(</code><code class="m">10</code><code class="p">);</code></pre>

<p>This is Functional now, but it’s not really ideal.  Nested functions have their place, but I don’t personally find the way it has to be used here as readable as the code could be.  Delightfully recursive, but I think it could be made clearer.</p>

<p>The other major problem is that this won’t scale up well if the list of deltas is large.  I’ll show you what I mean.</p>

<p>Let’s imagine there are only 3 values for the Deltas: 2, -12 &amp; 9.  In this case we’d expect our answer to come back as 1, because the second position (i.e. index=1) of the array resulted in a zero (10+2-12).  We would also expect that the 9 will never be evaluated.  That’s the efficiency saving we’re looking for from our code here.</p>

<p>What was actually happening with the recursive code, though.</p>

<p>First, it called GetFirstPositionWithValueZero with a current value of 10 (i.e. the starting value) and i was allowed to be the default of -1.</p>

<p>The body of the function is a ternary if statement.  If zero has been reached, return i, otherwise call the function again but with updated values for current and i.</p>

<p>This is what’ll happen with the first delta (i.e. i=0, i.e. 2), so GetFirstPositionWithValueZero is called again with the current value now updated to 12 and i as 0.</p>

<p>The new value is not 0, so the second call to GetFirstPositionWithValueZero will call itself again, this time with the current value updated with delta[1] and i incremented to 1.  delta[1] is -12, which would mean the third call results in a 0, which means that i can simply be returned.</p>

<p>Here’s the problem though…​</p>

<p>The third call got an answer, but the first two calls are still open in memory and stored on the stack.  The third call returns 1, which is passed up a level to the second call to GetFirstPositionWithValueZero, which now also returns 1, and so on…​ Until finally the original first call to GetFirstPositionWithValueZero returns the 1.</p>

<p>If you want to see that a little graphically, imagine it looking something like this:</p>

<pre data-type="programlisting">GetFirstPositionWithValueZero(10, -1)
   GetFirstPositionWithValueZero(12, 0)
      GetFirstPositionWithValueZero(0, 1)
      return 1;
   return 1;
return 1;</pre>

<p>That’s fine with 3 items in our array, but what if there are hundreds!</p>

<p>Recursion, as I’ve said, is a powerful tool, but it comes with a cost in C#.  Purer Functional languages (including F#) have a feature called <em>Tail Call Optimised Recursion</em> which allows the use of recursion without this memory usage problem.</p>

<p>Tail Recursion is an important concept, and one I’m going to return to later in a whole chapter dedicated to it, so I’m not going to dwell on it in any further detail here.</p>

<p>As it stands, out-of-the-box C# doesn’t permit Tail Recursion, even though it’s available in the .NET Common Language Runtime (CLR).  There are a few tricks we can try to make it available to us, but they’re a little too complex for this chapter, so I’ll talk about them at a later juncture.</p>

<p>For now, consider recursion as it’s described here, and keep in mind that you might want to be careful where and when you use it.</p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Immutability"><div class="sect1" id="idm45400882093152">
<h1>Immutability</h1>

<p>There’s more to Functional Programming in C# than just Linq.  Another important feature I’d like to discuss is Immutability (i.e. a variable may not change value once declared).  To what extent is it possible in C#?</p>

<p>Firstly, there are some newer developments with regards to Immutability in C# 8 and upwards.  See the next chapter for that.  For this chapter, I’m restricting myself to what is true of just about any version of .NET.</p>

<p>To begin, let’s consider this little C# snippet:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">ClassA</code>
<code class="p">{</code>
  <code class="k">public</code> <code class="kt">string</code> <code class="n">PropA</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
  <code class="k">public</code> <code class="kt">int</code> <code class="n">PropB</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
  <code class="k">public</code> <code class="n">DateTime</code> <code class="n">PropC</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
  <code class="k">public</code> <code class="n">IEnumerable</code><code class="p">&lt;</code><code class="kt">double</code><code class="p">&gt;</code> <code class="n">PropD</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
  <code class="k">public</code> <code class="n">IList</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="n">PropE</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code></pre>

<p>Is this immutable?  It very much is not.  Any of those properties can be replaced with new values via the setter.  The IList also provides a set of functions that allows its underlying array to be added to or removed from.</p>

<p>We could make the setters private, meaning we’d have to instantiate the class via a detailed contructor:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">ClassA</code>
<code class="p">{</code>
  <code class="k">public</code> <code class="kt">string</code> <code class="n">PropA</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">private</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
  <code class="k">public</code> <code class="kt">int</code> <code class="n">PropB</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">private</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
  <code class="k">public</code> <code class="n">DateTime</code> <code class="n">PropC</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">private</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
  <code class="k">public</code> <code class="n">IEnumerable</code><code class="p">&lt;</code><code class="kt">double</code><code class="p">&gt;</code> <code class="n">PropD</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">private</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
  <code class="k">public</code> <code class="n">IList</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="n">PropE</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">private</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

  <code class="k">public</code> <code class="nf">ClassA</code><code class="p">(</code><code class="kt">string</code> <code class="n">propA</code><code class="p">,</code> <code class="kt">int</code> <code class="n">propB</code><code class="p">,</code> <code class="n">DateTime</code> <code class="n">propC</code><code class="p">,</code> <code class="n">IEnumerable</code><code class="p">&lt;</code><code class="kt">double</code><code class="p">&gt;</code> <code class="n">propD</code><code class="p">,</code> <code class="n">IList</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="n">propE</code><code class="p">)</code>
  <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="n">PropA</code> <code class="p">=</code> <code class="n">propA</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="n">PropB</code> <code class="p">=</code> <code class="n">propB</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="n">PropC</code> <code class="p">=</code> <code class="n">propC</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="n">PropD</code> <code class="p">=</code> <code class="n">propD</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="n">PropE</code> <code class="p">=</code> <code class="n">propE</code><code class="p">;</code>
  <code class="p">}</code>

<code class="p">}</code></pre>

<p>Is it immutable now?  No, honestly it’s not.  It’s true that you can’t outright replace any of the properties with new objects outside ClassA, which is great.  The properties can be replaced inside the class, but the developer can ensure that no such code is ever added.  You should hopefully have some sort of code review system to ensure that, as well.</p>

<p>PropA and PropC are fine - strings and DateTime are both immutable in C#. The int value of PropB is fine too - ints don’t have anything you can change except its value.</p>

<p>There are still several problems, however.</p>

<p>PropE is a List, which can still have values added, removed and replaced, even though we can’t replace the entire object.  If we didn’t actually need to hold a mutable copy of PropE, we could easily replace it with an IEnumerable or IReadOnlyList.</p>

<p>The <code>IEnumerable&lt;double&gt;</code> value of PropD seems fine at first glance, but what if it was passed to the constructor as a <code>List&lt;double</code> which is still referenced by that type in the outside world?  It would still be possible to alter its contents that way.</p>

<p>There’s also the possibility of introducing something like this:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">ClassA</code>
<code class="p">{</code>
  <code class="k">public</code> <code class="kt">string</code> <code class="n">PropA</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">private</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
  <code class="k">public</code> <code class="kt">int</code> <code class="n">PropB</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">private</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
  <code class="k">public</code> <code class="n">DateTime</code> <code class="n">PropC</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">private</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
  <code class="k">public</code> <code class="n">IEnumerable</code><code class="p">&lt;</code><code class="kt">double</code><code class="p">&gt;</code> <code class="n">PropD</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">private</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
  <code class="k">public</code> <code class="n">IList</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="n">PropE</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">private</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
  <code class="k">public</code> <code class="n">SubClassB</code> <code class="n">PropF</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">private</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

  <code class="k">public</code> <code class="nf">ClassA</code><code class="p">(</code><code class="kt">string</code> <code class="n">propA</code><code class="p">,</code> <code class="kt">int</code> <code class="n">propB</code><code class="p">,</code> <code class="n">DateTime</code> <code class="n">propC</code><code class="p">,</code> <code class="n">IEnumerable</code><code class="p">&lt;</code><code class="kt">double</code><code class="p">&gt;</code> <code class="n">propD</code><code class="p">,</code> <code class="n">IList</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="n">propE</code><code class="p">,</code> <code class="n">SubClassB</code> <code class="n">propF</code><code class="p">)</code>
  <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="n">PropA</code> <code class="p">=</code> <code class="n">propA</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="n">PropB</code> <code class="p">=</code> <code class="n">propB</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="n">PropC</code> <code class="p">=</code> <code class="n">propC</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="n">PropD</code> <code class="p">=</code> <code class="n">propD</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="n">PropE</code> <code class="p">=</code> <code class="n">propE</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="n">PropF</code> <code class="p">=</code> <code class="n">propF</code>
  <code class="p">}</code>

<code class="p">}</code></pre>

<p>All properties of PropF are also potentially going to be mutable - unless this same structure with private setters is followed there too.</p>

<p>What about classes from outside your codebase?  What about Microsoft classes, or those from a 3rd party Nuget package?  There’s no way to enforce immutability.</p>

<p>Unfortunately there simply isn’t any way to enforce universal immutability, not even in the most recent versions of C#.  I would assume that for backwards compatibility reasons, there is never going to be.</p>

<p>It would be lovely to have a native C# method of ensuring immutability by default, but there isn’t one - and isn’t ever likely to be for reasons of backwards compatibility.  My own solution is that when coding, I simply <em>pretend</em> that Immutability exists in the project, and never change any object.  There’s nothing in  C# that provides any level of enforcement whatsoever, so you’d simply have to make a decision for yourself, or within your team, to act as if it does.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Putting it all Together - a Complete Functional Flow"><div class="sect1" id="idm45400881915184">
<h1>Putting it all Together - a Complete Functional Flow</h1>

<p>I’ve talked a lot about some simple techniques you can use to make your code more functional right away.  Now, I’d like to show a complete, if minute, application written to demonstrate an end-to-end functional process.</p>

<p>I’m going to write a very simple CSV parser.  In my example, I want to read in the complete text of a CSV file containing data about the first few series of Doctor Who<sup><a data-type="noteref" id="idm45400881422624-marker" href="ch02.html#idm45400881422624">7</a></sup>.  I want to read the data, parse it into a Plain Old C# Object (POCO, i.e. a class containing only data and no logic) and then aggregate it into a report which counts the number of episodes, and the number of episodes known to be lost for each season.  <sup><a data-type="noteref" id="idm45400881421904-marker" href="ch02.html#idm45400881421904">8</a></sup>.  I’m simplifying CSV parsing for the purposes of this example.  I’m not worrying about quotes around string fields, commas in field values or any values requiring additional parsing.  There are 3rd party libraries for all of that!  I’m just proving a point.</p>

<p>This complete process represents a nice, typical functional flow.  Take a single item, break it up into a list, apply list operations, then aggregate back down into a single value again.</p>

<p>This is the structure of my CSV file:</p>

<ul>
<li>
<p>[0] - Season Number.  Integer value between 1 and 39.  I’m running the risk of dating this book now, but there are 39 seasons to date.</p>
</li>
<li>
<p>[1] - Story Name - a string field I don’t care about</p>
</li>
<li>
<p>[2] - Writer - ditto</p>
</li>
<li>
<p>[3] - Director - ditto</p>
</li>
<li>
<p>[4] - Number of Episodes - in Doctor Who, all stories comprise between 1 and 14 episodes.  Until 1989, all stories were multi-part serials.</p>
</li>
<li>
<p>[5] - Number of Missing Episodes - the number of episodes of this serial not known to exist.  Any non-zero number is too many for me, but such is life.</p>
</li>
</ul>

<p>I want to end up with a report that has just these fields:</p>

<ul>
<li>
<p>Season Number</p>
</li>
<li>
<p>Total Episodes</p>
</li>
<li>
<p>Total Missing Episodes</p>
</li>
<li>
<p>Percentage Missing</p>
</li>
</ul>

<p>Let’s crack on with some code…​.</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="kt">var</code> <code class="n">text</code> <code class="p">=</code> <code class="n">File</code><code class="p">.</code><code class="n">ReadAllText</code><code class="p">(</code><code class="n">filePath</code><code class="p">);</code>

<code class="c1">// Split the string containing the whole contents of the</code>
<code class="c1">// file into an array where each line of the original file</code>
<code class="c1">// (i.e. each record) is an array element</code>
<code class="kt">var</code> <code class="n">splitLines</code> <code class="p">=</code> <code class="n">text</code><code class="p">.</code><code class="n">Split</code><code class="p">(</code><code class="n">Environment</code><code class="p">.</code><code class="n">NewLine</code><code class="p">);</code>

<code class="c1">// Split each line into an array of fields, splitting the</code>
<code class="c1">// source array by the ',' character.  Convert to Array</code>
<code class="c1">// for each access.</code>
<code class="kt">var</code> <code class="n">splitLinesAndFields</code> <code class="p">=</code> <code class="n">splitLines</code><code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="n">x</code><code class="p">.</code><code class="n">Split</code><code class="p">(</code><code class="s">","</code><code class="p">).</code><code class="n">ToArray</code><code class="p">());</code>

<code class="c1">// Convert each string array of fields into a data class.</code>
<code class="c1">// parse any non-string fields into the correct type.</code>
<code class="c1">// Not strictly necessary, based on the final aggregation</code>
<code class="c1">// that follows, but I believe in leaving behind easily</code>
<code class="c1">// extendible code</code>
<code class="kt">var</code> <code class="n">parsedData</code> <code class="p">=</code> <code class="n">splitLinesAndFields</code><code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="k">new</code> <code class="n">Story</code>
<code class="p">{</code>
   <code class="n">SeasonNumber</code> <code class="p">=</code> <code class="kt">int</code><code class="p">.</code><code class="n">Parse</code><code class="p">(</code><code class="n">x</code><code class="p">[</code><code class="m">0</code><code class="p">]),</code>
   <code class="n">StoryName</code> <code class="p">=</code> <code class="n">x</code><code class="p">[</code><code class="m">1</code><code class="p">],</code>
   <code class="n">Writer</code> <code class="p">=</code> <code class="n">x</code><code class="p">[</code><code class="m">2</code><code class="p">],</code>
   <code class="n">Director</code> <code class="p">=</code> <code class="n">x</code><code class="p">[</code><code class="m">3</code><code class="p">],</code>
   <code class="n">NumberOfEpisodes</code> <code class="p">=</code> <code class="kt">int</code><code class="p">.</code><code class="n">Parse</code><code class="p">(</code><code class="n">x</code><code class="p">[</code><code class="m">4</code><code class="p">]),</code>
   <code class="n">NumberOfMissingEpisodes</code> <code class="p">=</code> <code class="kt">int</code><code class="p">.</code><code class="n">Parse</code><code class="p">(</code><code class="n">x</code><code class="p">[</code><code class="m">5</code><code class="p">])</code>
<code class="p">});</code>

<code class="c1">// group by SeasonNumber, this gives us an array of Story</code>
<code class="c1">// objects for each season of the TV series</code>
<code class="kt">var</code> <code class="n">groupedBySeason</code> <code class="p">=</code> <code class="n">parsedData</code><code class="p">.</code><code class="n">GroupBy</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="n">SeasonNumber</code><code class="p">);</code>

<code class="c1">// Use a 3 field Tuple as the aggregate state:</code>
<code class="c1">// S (int) = the season number.  Not required for</code>
<code class="c1">//                the aggregation, but we need a way</code>
<code class="c1">//                to pin each set of aggregated totals</code>
<code class="c1">//                to a season</code>
<code class="c1">// NumEps (int) = the total number of episodes in all</code>
<code class="c1">//                serials in the season</code>
<code class="c1">// NumMisEps (int) = The total number of missing episodes</code>
<code class="c1">//                from the season</code>
<code class="kt">var</code> <code class="n">aggregatedReportLines</code> <code class="p">=</code> <code class="n">groupedBySeason</code><code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code>
    <code class="n">x</code><code class="p">.</code><code class="n">Aggregate</code><code class="p">((</code><code class="n">S</code><code class="p">:</code> <code class="n">x</code><code class="p">.</code><code class="n">Key</code><code class="p">,</code> <code class="n">NumEps</code><code class="p">:</code> <code class="m">0</code><code class="p">,</code> <code class="n">NumMisEps</code><code class="p">:</code> <code class="m">0</code><code class="p">),</code>
      <code class="p">(</code><code class="n">acc</code><code class="p">,</code> <code class="n">val</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="p">(</code><code class="n">acc</code><code class="p">.</code><code class="n">S</code><code class="p">,</code>
                       <code class="n">acc</code><code class="p">.</code><code class="n">NumEps</code> <code class="p">+</code> <code class="n">val</code><code class="p">.</code><code class="n">NumberOfEpisodes</code><code class="p">,</code>
                        <code class="n">acc</code><code class="p">.</code><code class="n">NumMisEps</code> <code class="p">+</code> <code class="n">val</code><code class="p">.</code><code class="n">NumberOfMissingEpisodes</code><code class="p">)</code>
    <code class="p">)</code>
<code class="p">);</code>

<code class="c1">// convert the Tuple-based results set to a proper</code>
<code class="c1">// object and add in the calculated field PercentageMissing</code>
<code class="c1">// not strictly necessary, but makes for more readable</code>
<code class="c1">// and extendible code</code>
<code class="kt">var</code> <code class="n">report</code> <code class="p">=</code> <code class="n">aggregatedReportLines</code><code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="k">new</code> <code class="n">ReportLine</code>
<code class="p">{</code>
   <code class="n">SeasonNumber</code> <code class="p">=</code> <code class="n">x</code><code class="p">.</code><code class="n">S</code><code class="p">,</code>
   <code class="n">NumberOfEpisodes</code> <code class="p">=</code> <code class="n">x</code><code class="p">.</code><code class="n">NumEps</code><code class="p">,</code>
   <code class="n">NumberOfMIssingEpisodes</code> <code class="p">=</code> <code class="n">x</code><code class="p">.</code><code class="n">NumMisEps</code><code class="p">,</code>
   <code class="n">PercentageMissing</code> <code class="p">=</code> <code class="p">(</code><code class="n">x</code><code class="p">.</code><code class="n">NumMisEps</code><code class="p">/</code><code class="n">x</code><code class="p">.</code><code class="n">NumEps</code><code class="p">)*</code><code class="m">100</code>
<code class="p">});</code>

<code class="c1">// format the report lines to a list of strings</code>
<code class="kt">var</code> <code class="n">reportTextLines</code> <code class="p">=</code> <code class="n">report</code><code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="err">$</code><code class="s">"{x.SeasonNumber}\t {x.NumberOfEpisodes}\t"</code> <code class="p">+</code>
<code class="err">$</code><code class="s">"{x.NumberofMissingEpisodes}\t{x.PercentageMissing}"</code><code class="p">);</code>

<code class="c1">// join the lines into a large single string with New Line</code>
<code class="c1">// characters between each line</code>
<code class="kt">var</code> <code class="n">reportBody</code> <code class="p">=</code> <code class="kt">string</code><code class="p">.</code><code class="n">Join</code><code class="p">(</code><code class="n">Environment</code><code class="p">.</code><code class="n">NewLine</code><code class="p">,</code> <code class="n">reportTextLines</code><code class="p">);</code>
<code class="kt">var</code> <code class="n">reportHeader</code> <code class="p">=</code> <code class="s">"Season\tNo Episodes\tNo MissingEps\tPercentage Missing"</code><code class="p">;</code>

<code class="c1">// the final report consists of the header, a new line, then the reportbody</code>
<code class="kt">var</code> <code class="n">finalReport</code> <code class="p">=</code> <code class="err">$</code><code class="s">"{reportHeader}{Environment.NewLine}{reportTextLines}"</code><code class="p">;</code></pre>

<p>In case you’re curious, the results would look something like this (the “\t” characters are tabs, which make it a bit more readable):</p>

<pre data-type="programlisting">Season   No Episodes   No Missing Eps   Percentage Missing,
1         42               9                  21.4
2         39               2                  5.1
3         45               28                 62.2
4         43               33                 76.7
5         40               18                 45
6         44               8                  18.2
7         25               0                  0
8         25               0                  0
9         26               0                  0

...</pre>

<p>Note, I could have made the code sample more concise and written just about all of this together in one long, continuous fluent expression like this:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="kt">var</code> <code class="n">reportTextLines</code> <code class="p">=</code> <code class="n">File</code><code class="p">.</code><code class="n">ReadAllText</code><code class="p">(</code><code class="n">filePath</code><code class="p">)</code>
                      <code class="p">.</code><code class="n">Split</code><code class="p">(</code><code class="n">Environment</code><code class="p">.</code><code class="n">NewLine</code><code class="p">)</code>
                      <code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="n">x</code><code class="p">.</code><code class="n">Split</code><code class="p">(</code><code class="s">","</code><code class="p">).</code><code class="n">ToArray</code><code class="p">())</code>
                      <code class="p">.</code><code class="n">GroupBy</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="n">x</code><code class="p">[</code><code class="m">0</code><code class="p">])</code>
                      <code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code>
    <code class="n">x</code><code class="p">.</code><code class="n">Aggregate</code><code class="p">((</code><code class="n">S</code><code class="p">:</code> <code class="n">x</code><code class="p">.</code><code class="n">Key</code><code class="p">,</code> <code class="n">NumEps</code><code class="p">:</code> <code class="m">0</code><code class="p">,</code> <code class="n">NumMisEps</code><code class="p">:</code> <code class="m">0</code><code class="p">),</code>
      <code class="p">(</code><code class="n">acc</code><code class="p">,</code> <code class="n">val</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="p">(</code><code class="n">acc</code><code class="p">.</code><code class="n">S</code><code class="p">,</code>
                       <code class="n">acc</code><code class="p">.</code><code class="n">NumEps</code> <code class="p">+</code> <code class="kt">int</code><code class="p">.</code><code class="n">Parse</code><code class="p">(</code><code class="n">va</code><code class="p">[</code><code class="m">4</code><code class="p">]),</code>
                        <code class="n">acc</code><code class="p">.</code><code class="n">NumMisEps</code> <code class="p">+</code> <code class="kt">int</code><code class="p">.</code><code class="n">Parse</code><code class="p">(</code><code class="n">val</code><code class="p">[</code><code class="m">5</code><code class="p">]))</code>
    <code class="p">)</code>
<code class="p">)</code>
<code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="err">$</code><code class="s">"{x.S}, {x.NumEps},{x.NumMisEps},{(x.NumMisEps/x.NumEps)*100}"</code><code class="p">);</code>


<code class="kt">var</code> <code class="n">reportBody</code> <code class="p">=</code> <code class="kt">string</code><code class="p">.</code><code class="n">Join</code><code class="p">(</code><code class="n">Environment</code><code class="p">.</code><code class="n">NewLine</code><code class="p">,</code> <code class="n">reportTextLines</code><code class="p">);</code>
<code class="kt">var</code> <code class="n">reportHeader</code> <code class="p">=</code> <code class="s">"Season,No Episodes,No MissingEps,Percentage Missing"</code><code class="p">;</code>

<code class="kt">var</code> <code class="n">finalReport</code> <code class="p">=</code> <code class="err">$</code><code class="s">"{reportHeader}{Environment.NewLine}{reportHeader}"</code><code class="p">;</code></pre>

<p>There’s nothing wrong with that sort of approach, but I like splitting it out into individual lines for a couple of reasons:</p>

<ul>
<li>
<p>The variable names provide some insight into what your code is doing.   We’re sort’ve semi-enforcing a form of code commenting.</p>
</li>
<li>
<p>It’s possible to inspect the intermediate variables, to see what’s in them at each step.  This makes debugging easier, because like I said in the previous chapter - it’s like being able to look back on your working in a mathematics answer, to see which step it was that you went wrong on.</p>
</li>
</ul>

<p>There isn’t any ultimate functional difference, nothing that would be noticed by the end user, so which style you adopt is more a matter of personal taste.  Write in whatever way it seems best to you.  Do try and keep it readable, and easy for everyone to follow, though.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Taking it Further - Develop Your Functional Skills"><div class="sect1" id="idm45400881423984">
<h1>Taking it Further - Develop Your Functional Skills</h1>

<p>Here’s a challenge for you.  If some or all of the techniques described to you here were new, then go off and have fun with them for a bit.</p>

<p>Challenge yourself to writing code with the following rules:</p>

<ul>
<li>
<p>Treat all variables as immutable - do not change any variable value once set.  Basically treat everything as if it were a constant.</p>
</li>
<li>
<p>None of the following statements are permitted - <code>If</code>, <code>For</code>, <code>ForEach</code>, <code>While</code>.  <code>If</code> is acceptable only in a Ternary expression - i.e. the single-line expression in the style: someBoolean ? valueOne : valueTwo.</p>
</li>
<li>
<p>Where possible write as many functions as small, concise arrow functions (a.k.a. Lambda Expressions).</p>
</li>
</ul>

<p>Either do this as part of your production code, or else go out and look for a code challenge site, something like <a href="https://adventofcode.com/">The Advent of Code (https://adventofcode.com)</a> or <a href="https://projecteuler.net/">Project Euler (https://projecteuler.net)</a>.  Something you can get your teeth into.</p>

<p>If you don’t want to go through the bother of creating an entire solution for these exercises in Visual Studio, there’s always LINQPad (<a href="https://www.linqpad.net/" class="bare"><em class="hyperlink">https://www.linqpad.net/</em></a>) for a quick and easy way to rattle off some C# code.</p>

<p>After you’ve got the hang of this, you’ll be ready to move onto the next step.  I hope you’re having fun so far!</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Summary"><div class="sect1" id="idm45400880856384">
<h1>Summary</h1>

<p>In this chapter, we looked at a variety of simple Linq-based techniques for writing Functional-style code immediately in any C# codebase using at least .NET Framework 3.5, because these features are ever-green and have been in place for all of those years in every subsequent version of .NET without needing to be updated or replaced.</p>

<p>We discussed the more advanced features of Select statements, some of the less well-known features of Linq and methods for Aggregating and Recursion.</p>

<p>In the next chapter, I’ll look at some of the most recent developments in C# that can be used in more up-to-date codebases.</p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="idm45400885975216"><sup><a href="ch02.html#idm45400885975216-marker">1</a></sup> I’m more of an SF (or Sci-fi, if you prefer) fan, truth be told.</p><p data-type="footnote" id="idm45400886839824"><sup><a href="ch02.html#idm45400886839824-marker">2</a></sup> And in one example, a couple of definitions were also outside the codebase in Database Stored Procedures</p><p data-type="footnote" id="idm45400886206224"><sup><a href="ch02.html#idm45400886206224-marker">3</a></sup> Except your employer.  They pay your bills.  They hopefully send you birthday cards once a year too, if they’re nice.</p><p data-type="footnote" id="idm45400883250816"><sup><a href="ch02.html#idm45400883250816-marker">4</a></sup> As a Functional programmer, and a believer in exposing the most abstract interface possible, I literally <strong>never</strong> use <code>ToList()</code>.  Only ever <code>ToArray()</code>, even if <code>ToList</code> is every so slightly faster.</p><p data-type="footnote" id="idm45400882823232"><sup><a href="ch02.html#idm45400882823232-marker">5</a></sup> No, Sophie.  It’s not good enough to just use your fingers!</p><p data-type="footnote" id="idm45400882090672"><sup><a href="ch02.html#idm45400882090672-marker">6</a></sup> Check out the man himself <a href="https://www.youtube.com/watch?v=OISR3al5Bnk">here (https://www.youtube.com/watch?v=OISR3al5Bnk)</a></p><p data-type="footnote" id="idm45400881422624"><sup><a href="ch02.html#idm45400881422624-marker">7</a></sup> For those of you unacquainted, this is a British SF series that has been running on-and-off since 1963.  It is, in my own opinion, the greatest TV series ever made.  I’m not taking any arguments on that</p><p data-type="footnote" id="idm45400881421904"><sup><a href="ch02.html#idm45400881421904-marker">8</a></sup> Sad to say, the BBC junked many episodes of the series in the 1970s.  If you have any of those, please do hand them back.</p></div></div></section></div>
</div>
</body>
</html>