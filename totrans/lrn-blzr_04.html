<html><head></head><body><section data-pdf-bookmark="Chapter 3. &#x200B;&#x200B;Componentizing" data-type="chapter" epub:type="chapter"><div class="chapter" id="chapter-three">
<h1><span class="label">Chapter 3. </span>​​Componentizing</h1>


<p>Our app has lifted off and taken flight—hooray! We’re going to continue our adventure of learning Blazor by scrutinizing code. In this chapter, you’ll learn how to author Blazor components and various data-binding approaches. Now that you’re familiar with how the app starts, we’ll evaluate the default route of the app. This just so happens to serve the <em>Index.razor</em> file, which is the home screen for the app. You’ll learn how to limit what a user has access to by protecting components with declarative attributes and security-semantic hierarchies. You’ll see native JavaScript <code>geolocation</code> services in use with JavaScript interop. As part of this chapter, you’ll also learn about some of the peripheral services and supporting architecture that the Blazor app relies on, such as the “Have I Been Pwned” service and Open Weather Map APIs.</p>






<section data-pdf-bookmark="Design with the User in Mind" data-type="sect1"><div class="sect1" id="idm46365035439136">
<h1>Design with the User in Mind</h1>

<p>All graphical-based applications have users, but not all applications prioritize the needs of their users. More often than not, apps use your information to drive advertisements or sell your information to other companies. These apps view <em>you</em> (the user) as a sales opportunity or a data point.</p>

<p>The Learning Blazor app was designed with its users in mind. As such, it authenticates the user’s identity to determine what actions the app takes (for more information, see <a data-type="xref" href="#identity-and-authentication">“Identity and Authentication”</a>).</p>

<p>When users log in to the app, meaning, once <a data-primary="authentication" data-secondary="Azure AD B2C" data-type="indexterm" id="idm46365035435456"/><a data-primary="Azure Active Directory (AD) business-to-consumer (B2C)" data-type="indexterm" id="idm46365035434608"/><a data-primary="authentication" data-secondary="JWT (JSON Web Token)" data-type="indexterm" id="idm46365035434000"/><a data-primary="JWT (JSON Web Token)" data-type="indexterm" id="idm46365035433152"/><a data-primary="JSON Web Token (JWT)" data-type="indexterm" id="idm46365035432544"/>the web server has authenticated a user with the Azure AD B2C tenant, a JSON Web Token (JWT; or just bearer token) is returned. The app redirects to a third-party site and prompts for credentials. The UX for the model <a data-primary="UX" data-secondary="model app" data-type="indexterm" id="idm46365035431808"/>app renders as depicted in <a data-type="xref" href="#azure-ad-b2c-signin-screen">Figure 3-1</a>.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="identity-and-authentication">
<h5>Identity and Authentication</h5>
<p><em>Identity</em> is a unique representation of a <a data-primary="identity" data-type="indexterm" id="idm46365035428288"/>user within a computer system. For example, an email address, user identifier, phone number, and the user’s name could all be a collection of attributes used to uniquely identify a single user.</p>

<p><em>Authentication</em> is the act of <a data-primary="authentication" data-type="indexterm" id="idm46365035426912"/><a data-primary="identity" data-secondary="authentication" data-type="indexterm" id="idm46365035426304"/>requesting a trusted third-party entity to validate an individual’s identity. For example, when a user attempts to log in to an app, an authentication provider can be used to verify their claimed identity.</p>

<p class="fix_tracking_2"><em>Authorization</em> is a related concept that will be <a data-primary="authorization" data-type="indexterm" id="idm46365035424224"/>discussed in <a data-type="xref" href="#authorization">“Authorization”</a>.</p>
</div></aside>

<figure><div class="figure" id="azure-ad-b2c-signin-screen">
<img alt="Azure Active Directory (AAD) business-to-consumer (B2C) sign-in screen" src="assets/lblz_0301.png"/>
<h6><span class="label">Figure 3-1. </span>Azure AD B2C sign-in screen</h6>
</div></figure>

<p>The authentication token flows through <a data-primary="authentication" data-secondary="tokens" data-type="indexterm" id="idm46365035420624"/><a data-primary="key/value pairs (KVPs)" data-secondary="claims" data-type="indexterm" id="idm46365035419360"/><a data-primary="claims" data-secondary="key/value pairs (KVPs)" data-type="indexterm" id="idm46365035418512"/>peripheral services and resources as needed. For example, this token could be represented as a client browser cookie when used with the Web.Client project. Wherever this token resides, whether in the server or on the client-side app, the authenticated users’ information is represented as a collection of key/value pairs (KVPs), which are referred to as <em>claims</em>. A user is represented as a <code>Claim⁠s​Principal</code> object. <code>ClaimsPrincipal</code> has an <code>Identity</code> property, which is <a data-primary="ClaimsPrinciple object" data-type="indexterm" id="idm46365035416000"/>available at runtime with a <code>ClaimsIdentity</code> instance. When a service requires authentication and a request provides a valid authentication token, the requested claims are provided. At this time, we can <a data-primary="claims" data-type="indexterm" id="idm46365035414880"/>demand various attributes (or claims) that a user agrees to share with our application. The log-in UX from the Blazor app is customizable, and you’ll learn more about that in <a data-type="xref" href="ch04.html#chapter-four">Chapter 4</a>.</p>

<p>Our app uses these claims to uniquely <a data-primary="claims" data-secondary="authenticated users" data-type="indexterm" id="idm46365035413280"/>identify an authenticated user. The claims are part of the bearer token and are passed to various services that the app relies on. The claims flow into the “Pwned” service, thus enabling an automated data-breach detection mechanism on the user’s behalf from their email.</p>








<section data-pdf-bookmark="Leveraging “Pwned” Functionality" data-type="sect2"><div class="sect2" id="have-i-been-pwned">
<h2>Leveraging “Pwned” Functionality</h2>

<p>One of the functionalities of <a data-primary="Pwned functionality" data-type="indexterm" id="pwfy"/>the Learning Blazor <a data-primary="Learning Blazor app" data-secondary="Pwned functionality" data-type="indexterm" id="lgzpw"/>app is Pwned functionality, which tells the user if their email has been compromised. This functionality draws from the <a href="https://oreil.ly/Lzlvw">“Have I Been Pwned” API</a> by Troy Hunt. He is one of the most renowned security experts <a data-primary="Hunt, Troy" data-type="indexterm" id="idm46365035406912"/>in the world, and he’s been collecting data breaches for years. He spends time aggregating, normalizing, and persisting all of this data into a service called “Have I Been Pwned” (or HIBP for short). This service exposes the ability to check whether or not a given email address has ever existed within a data breach—at the time of writing there were nearly 11.5 billion records. This number will certainly continue to grow. The consuming components and client services of this API are detailed in <a data-type="xref" href="ch05.html#chapter-five">Chapter 5</a>.</p>

<p>The HIBP API exposes three primary categories:</p>
<dl>
<dt>Breaches</dt>
<dd>
<p>Aggregated data breach information <a data-primary="HIBP (Have I Been Pwned) API" data-secondary="breaches" data-type="indexterm" id="idm46365035403680"/><a data-primary="Have I Been Pwned API" data-see="HIBP API" data-type="indexterm" id="idm46365035402768"/><a data-primary="breaches, Have I Been Pwned (HIBP) API" data-type="indexterm" id="idm46365035401824"/>for security-compromised accounts</p>
</dd>
<dt>Passwords</dt>
<dd>
<p>A massive collection <a data-primary="HIBP (Have I Been Pwned) API" data-secondary="passwords" data-type="indexterm" id="idm46365035399776"/><a data-primary="passwords" data-secondary="HIBP API" data-type="indexterm" id="idm46365035398800"/>of hashed passwords that have appeared in data breaches, meaning they’re compromised</p>
</dd>
<dt>Pastes</dt>
<dd>
<p>Information that has <a data-primary="HIBP (Have I Been Pwned) API" data-secondary="pastes" data-type="indexterm" id="idm46365035396448"/><a data-primary="pastes, HIBP API" data-type="indexterm" id="idm46365035395472"/>been published to a publicly facing website designed to share content</p>
</dd>
</dl>

<p>The Learning Blazor application is also dependent on the <a href="https://oreil.ly/KHvnn">pwned-client open source project on GitHub</a>, which is a .NET HTTP client library for accessing the HIBP API programmatically with C#.</p>

<p>This library comes DI-ready; all the consumer needs is an API key and the <a href="https://oreil.ly/X48Vq">NuGet package</a>.</p>

<p>The pwned-client library exposes <a data-primary="pwned-client library" data-type="indexterm" id="idm46365035391536"/>the ability for consumers to configure their API key through well-known configurations. For example, if you wanted to use an environment variable, you’d name it <code>HibpOptions__ApiKey</code>. The double underscore (<code>__</code>) is used as a cross-platform alternative to delimiting name segments with <code>:</code>, which wouldn’t work in Linux. The <code>HibpOptions__ApiKey</code> environment variable would map to the libraries’ strongly typed <code>HibpOptions.ApiKey</code> property value.</p>

<p>To add all of the services to the <a data-primary="DI (dependency injection)" data-secondary="container, services" data-type="indexterm" id="idm46365035388128"/>DI container (<code>IServiceCollection</code>), call one of the <code>AddPwnedServices</code> overload extension methods:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="c1">// Pass an IConfiguration section that maps</code>
<code class="c1">// to an object that has configured an ApiKey.</code>
<code class="n">services</code><code class="p">.</code><code class="n">AddPwnedServices</code><code class="p">(</code>
    <code class="n">_configuration</code><code class="p">.</code><code class="n">GetSection</code><code class="p">(</code><code class="n">nameof</code><code class="p">(</code><code class="n">HibpOptions</code><code class="p">))</code>
<code class="p">);</code></pre>

<p>This first <code>AddPwnedServices</code> overload uses an <code>IConfiguration _configuration</code> and asks for the <code>"HibpOptions"</code> section. ASP.NET Core has many configuration providers, including JSON, XML, environment variables, Azure Key Vault, and so on. The <code>IConfiguration</code> object can <a data-primary="IConfiguration object" data-type="indexterm" id="idm46365035360240"/>represent all of them. If using environment variables, for example, it would map that configuration section to the <a data-primary="HibpOptions" data-type="indexterm" id="idm46365035359248"/>libraries’ dependent <code>HibpOptions</code>. Likewise, the JSON provider is capable of pulling in configuration from JSON files <a data-primary="appsettings.json" data-type="indexterm" id="idm46365035358032"/>such as <em>appsettings.json</em>:</p>

<pre data-code-language="json" data-type="programlisting"><code class="p">{</code>
  <code class="nt">"Logging"</code><code class="p">:</code> <code class="p">{</code>
    <code class="nt">"LogLevel"</code><code class="p">:</code> <code class="p">{</code>
      <code class="nt">"Default"</code><code class="p">:</code> <code class="s2">"Information"</code><code class="p">,</code>
      <code class="nt">"Microsoft"</code><code class="p">:</code> <code class="s2">"Warning"</code><code class="p">,</code>
      <code class="nt">"Microsoft.Hosting.Lifetime"</code><code class="p">:</code> <code class="s2">"Information"</code>
    <code class="p">}</code>
  <code class="p">},</code>
  <code class="nt">"AllowedHosts"</code><code class="p">:</code> <code class="s2">"*"</code><code class="p">,</code>
  <code class="nt">"HibpOptions"</code><code class="p">:</code> <code class="p">{</code> <a class="co" href="#callout___componentizing_CO1-1" id="co___componentizing_CO1-1"><img alt="1" src="assets/1.png"/></a>
    <code class="nt">"ApiKey"</code><code class="p">:</code> <code class="s2">"&lt;YourApiKey&gt;"</code><code class="p">,</code>
    <code class="nt">"UserAgent"</code><code class="p">:</code> <code class="s2">"&lt;YourUserAgent&gt;"</code>
  <code class="p">}</code>
<code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co___componentizing_CO1-1" id="callout___componentizing_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>In this example file, the <code>"HibpOptions"</code> object would map to the <code>HibpOptions</code> type in the library.</p></dd>
</dl>

<p>Alternatively, you can assign the <a data-primary="lambda expressions" data-type="indexterm" id="idm46365031972784"/>options directly with a lambda expression:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="c1">// Provide a lambda expression that assigns the ApiKey directly.</code>
<code class="n">services</code><code class="p">.</code><code class="n">AddPwnedServices</code><code class="p">(</code><code class="n">options</code> <code class="p">=&gt;</code>
<code class="p">{</code>
    <code class="n">options</code><code class="p">.</code><code class="n">ApiKey</code> <code class="p">=</code>
        <code class="n">Environment</code><code class="p">.</code><code class="n">GetEnvironmentVariable</code><code class="p">(</code>
            <code class="s">"HAVE_I_BEEN_PWNED_API_KEY"</code><code class="p">);</code>
<code class="p">});</code></pre>

<p>This <code>AddPwnedServices</code> overload allows you to specify the API key and other options inline. After the services have been registered and the proper configurations have been set, the code can use DI for any available abstractions. There are several clients <a data-primary="HIBP (Have I Been Pwned) API" data-secondary="clients" data-type="indexterm" id="idm46365030039008"/>to use, each with a specific context:</p>
<dl>
<dt><code>IPwnedBreachesClient</code></dt>
<dd>
<p>A client to access <a data-primary="IPwnedBreachesClient" data-type="indexterm" id="idm46365030035296"/>the Breaches API</p>
</dd>
<dt><code>IPwnedPasswordsClient</code></dt>
<dd>
<p>A client to access <a data-primary="IPwnedPasswordsClient" data-type="indexterm" id="idm46365030032992"/>the Passwords API</p>
</dd>
<dt><code>IPwnedPastesClient</code></dt>
<dd>
<p>A client to access <a data-primary="IPwnedPastesClient" data-type="indexterm" id="idm46365030030688"/>the Pastes API</p>
</dd>
<dt><code>IPwnedClient</code></dt>
<dd>
<p>A client to access all the APIs <a data-primary="IPwnedClient" data-type="indexterm" id="idm46365030016096"/>and aggregates all other clients into a single client for convenience</p>
</dd>
</dl>

<p>If you’d like to run the sample application locally, you’ll optionally provide several API keys for various services. For example, to get the “Have I Been Pwned” API key, you can <a href="https://oreil.ly/XOKoX">sign up on their site</a>. This specific API key isn’t free; if you’d rather <em>not</em> sign up for the API, you can use the following API key to enable a demo mode:</p>

<pre data-code-language="json" data-type="programlisting"><code class="nt">"HibpOptions"</code><code class="p">:</code> <code class="p">{</code>
    <code class="nt">"ApiKey"</code><code class="p">:</code> <code class="s2">"demo"</code>
<code class="p">}</code></pre>

<p>This could be configured in the <em>appsettings.json</em> file of the Web.Client project.</p>

<p>With .NET 6, minimalism-first is widely emphasized, and for good reason. The idea is to start small and allow the code to grow with your needs. Minimal APIs focus on simplicity, ease of use, extensibility, <a data-primary="Pwned functionality" data-startref="pwfy" data-type="indexterm" id="idm46365029972064"/><a data-primary="Learning Blazor app" data-secondary="Pwned functionality" data-startref="lgzpw" data-type="indexterm" id="idm46365029971088"/>and, for lack of a better word, minimalism.</p>
</div></section>













<section data-pdf-bookmark="“Have I Been Pwned” Client Services" data-type="sect2"><div class="sect2" id="idm46365030011344">
<h2>“Have I Been Pwned” Client Services</h2>

<p class="pagebreak-after">Let’s look at the .NET 6 Minimal API project that <a data-primary="HIBP (Have I Been Pwned) API" data-secondary="client services" data-type="indexterm" id="hbpsv"/><a data-primary="Learning Blazor app" data-secondary="HIBP API, client services" data-type="indexterm" id="lgzcv"/><a data-primary="Web.PwnedApi.csproj" data-type="indexterm" id="wpapj"/>serves as the  Web.PwnedApi of the Learning Blazor app, the <em>Web.PwnedApi.csproj</em> file:</p>

<pre class="less_space" data-code-language="xml" data-type="programlisting"><code class="nt">&lt;Project</code> <code class="na">Sdk=</code><code class="s">"Microsoft.NET.Sdk.Web"</code><code class="nt">&gt;</code>
  <code class="nt">&lt;PropertyGroup</code><code class="nt">&gt;</code>
    <code class="nt">&lt;RootNamespace</code><code class="nt">&gt;</code><code>Learning.Blazor.PwnedApi</code><code class="nt">&lt;/RootNamespace&gt;</code>
    <code class="nt">&lt;TargetFramework</code><code class="nt">&gt;</code><code>net6.0</code><code class="nt">&lt;/TargetFramework&gt;</code> <a class="co" href="#callout___componentizing_CO2-1" id="co___componentizing_CO2-1"><img alt="1" src="assets/1.png"/></a>
    <code class="nt">&lt;Nullable</code><code class="nt">&gt;</code><code>enable</code><code class="nt">&lt;/Nullable&gt;</code>
    <code class="nt">&lt;ImplicitUsings</code><code class="nt">&gt;</code><code>enable</code><code class="nt">&lt;/ImplicitUsings&gt;</code>
  <code class="nt">&lt;/PropertyGroup&gt;</code>

  <code class="nt">&lt;ItemGroup</code><code class="nt">&gt;</code> <a class="co" href="#callout___componentizing_CO2-2" id="co___componentizing_CO2-2"><img alt="2" src="assets/2.png"/></a>
    <code class="nt">&lt;PackageReference</code> <code class="na">Version=</code><code class="s">"2.0.0"</code>
        <code class="na">Include=</code><code class="s">"HaveIBeenPwned.Client"</code> <code class="nt">/&gt;</code>
    <code class="nt">&lt;PackageReference</code> <code class="na">Version=</code><code class="s">"2.0.0"</code>
        <code class="na">Include=</code><code class="s">"HaveIBeenPwned.Client.PollyExtensions"</code> <code class="nt">/&gt;</code>
    <code class="nt">&lt;PackageReference</code> <code class="na">Version=</code><code class="s">"6.0.0"</code>
        <code class="na">Include=</code><code class="s">"Microsoft.AspNetCore.Authentication.JwtBearer"</code><code class="nt">/&gt;</code>
    <code class="nt">&lt;PackageReference</code> <code class="na">Version=</code><code class="s">"6.0.0"</code>
        <code class="na">Include=</code><code class="s">"Microsoft.AspNetCore.Authentication.OpenIdConnect"</code> <code class="nt">/&gt;</code>
    <code class="nt">&lt;PackageReference</code> <code class="na">Version=</code><code class="s">"1.21.0"</code>
        <code class="na">Include=</code><code class="s">"Microsoft.Identity.Web"</code> <code class="nt">/&gt;</code>
  <code class="nt">&lt;/ItemGroup&gt;</code>

  <code class="nt">&lt;ItemGroup</code><code class="nt">&gt;</code> <a class="co" href="#callout___componentizing_CO2-3" id="co___componentizing_CO2-3"><img alt="3" src="assets/3.png"/></a>
    <code class="nt">&lt;ProjectReference</code>
        <code class="na">Include=</code><code class="s">"..\Web.Extensions\Web.Extensions.csproj"</code> <code class="nt">/&gt;</code>
    <code class="nt">&lt;ProjectReference</code>
        <code class="na">Include=</code><code class="s">"..\Web.Http.Extensions\Web.Http.Extensions.csproj"</code> <code class="nt">/&gt;</code>
  <code class="nt">&lt;/ItemGroup&gt;</code>

<code class="nt">&lt;/Project&gt;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co___componentizing_CO2-1" id="callout___componentizing_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The project is targeting the <code>net.6.0</code> target framework moniker (TFM).</p></dd>
<dt><a class="co" href="#co___componentizing_CO2-2" id="callout___componentizing_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>There are several package references for framework-provided and third-party libraries.</p></dd>
<dt><a class="co" href="#co___componentizing_CO2-3" id="callout___componentizing_CO2-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>There are several project references for local dependencies.</p></dd>
</dl>

<p>The project’s root namespace is <a data-primary="Learning.Blazor.PwnedApi namespace" data-type="indexterm" id="idm46365029871984"/><a data-primary="namespaces" data-secondary="Learning.Blazor.PwnedApi" data-type="indexterm" id="idm46365029871312"/>defined as <code>Learning.Blazor.PwnedApi</code>, and it targets the <code>net6.0</code> TFM. Since we’re targeting .NET 6, we can enable the <code>ImplicitUsings</code> feature; this means that by default there is a set of <code>usings</code> implicitly available in all of the project’s C# files. This is an added convenience, as these implicitly added namespaces are common. The project also defines <code>Nullable</code> as being enabled. This means that we can define nullable reference types, and the C# compiler platform (Roslyn) will provide warnings where there is the potential for <code>null</code> values, through definite assignment flow analysis.</p>

<p>The project adds many package references. One package of particular interest is <code>HaveIBeenPwned.Client</code>. This is <a data-primary="HaveIBeenPwned.Client" data-type="indexterm" id="idm46365029820896"/>the package that exposes the “Have I Been Pwned” HTTP client functionality. The project also <a data-primary="TFM (target frame moniker)" data-type="indexterm" id="idm46365029820048"/><a data-primary="target frame moniker (TFM)" data-type="indexterm" id="idm46365029819440"/>defines authentication and identity packages, which are used to help protect the exposed APIs.</p>

<p>The project defines two project <a data-primary="Web.Extensions project" data-type="indexterm" id="idm46365029818208"/><a data-primary="Web.Http.Extensions project" data-type="indexterm" id="idm46365029817600"/><a data-primary="Web.PwnedApi.csproj" data-startref="wpapj" data-type="indexterm" id="idm46365029816992"/>references, Web.Extensions and Web.Http.Extensions. These projects provide shared utilitarian functionality. The extensions project is based on the <a data-primary="CLR (common language runtime)" data-type="indexterm" id="idm46365029816016"/><a data-primary="common language runtime (CLR)" data-type="indexterm" id="idm46365029815408"/>common language runtime (CLR) types, whereas the HTTP extensions project is specific to providing a shared transient fault error handling policy.</p>

<p>The <em>Program.cs</em> is a C# top-level program, and it looks <a data-primary="Program.cs" data-type="indexterm" id="idm46365029813904"/>like the following:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">builder</code> <code class="p">=</code> <code class="n">WebApplication</code><code class="p">.</code><code class="n">CreateBuilder</code><code class="p">(</code><code class="n">args</code><code class="p">)</code><code class="p">.</code><code class="n">AddPwnedEndpoints</code><code class="p">(</code><code class="p">)</code><code class="p">;</code> <a class="co" href="#callout___componentizing_CO3-1" id="co___componentizing_CO3-1"><img alt="1" src="assets/1.png"/></a>
<code class="k">await</code> <code class="k">using</code> <code class="nn">var</code> <code class="n">app</code> <code class="p">=</code> <code class="n">builder</code><code class="p">.</code><code class="n">Build</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="n">MapPwnedEndpoints</code><code class="p">(</code><code class="p">)</code><code class="p">;</code> <a class="co" href="#callout___componentizing_CO3-2" id="co___componentizing_CO3-2"><img alt="2" src="assets/2.png"/></a>
<code class="k">await</code> <code class="n">app</code><code class="p">.</code><code class="n">RunAsync</code><code class="p">(</code><code class="p">)</code><code class="p">;</code> <a class="co" href="#callout___componentizing_CO3-3" id="co___componentizing_CO3-3"><img alt="3" src="assets/3.png"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co___componentizing_CO3-1" id="callout___componentizing_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>builder</code> is created and endpoints added.</p></dd>
<dt><a class="co" href="#co___componentizing_CO3-2" id="callout___componentizing_CO3-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>builder</code> is built and its endpoints are mapped, resulting in an <code>app</code> object.</p></dd>
<dt><a class="co" href="#co___componentizing_CO3-3" id="callout___componentizing_CO3-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>app</code> object is run.</p></dd>
</dl>

<p>The code starts by creating a <code>builder</code> instance of type <code>WebApplicationBuilder</code>, which <a data-primary="builder pattern" data-type="indexterm" id="idm46365029727376"/><a data-primary="WebApplicationsBuilder" data-type="indexterm" id="idm46365029726768"/>exposes the <em>builder pattern</em> (as described in <a data-type="xref" href="ch06.html#builder-pattern">“Builder Pattern”</a>) for our web app. From the call to <code>CreateBuilder</code>, the code calls <code>AddPwnedEndpoints</code>. This is an extension method on the <code>WebApplicationBuilder</code> type that adds all the desired endpoints. <code>args</code> used to call <code>CreateBuilder</code> are implicitly available and represent the command-line args given to initiate running the application. These are available for all C# top-level programs. With the <code>builder</code>, we have access to several key members:</p>

<ul>
<li>
<p>The <code>Services</code> property is our <code>IServiceCollection</code>; we can register services for DI with this.</p>
</li>
<li>
<p>The <code>Configuration</code> property is a <code>ConfigurationManager</code>, which is an implementation of <code>IConfiguration</code>.</p>
</li>
<li>
<p>The <code>Environment</code> property provides information about the hosting environment itself.</p>
</li>
</ul>

<p>Next, <code>builder.Build()</code> is called. This returns a <code>WebApplication</code> type, and from this <a data-primary="builder.Build()" data-type="indexterm" id="idm46365029716304"/>returned object another call is chained to <code>MapPwnedEndpoints</code>. This is yet another extension method, which encapsulates the logic for mapping the added endpoints to the <code>WebApplication</code> that it extends. The <code>WebApplication</code> type is an implementation of the <code>IAsyncDisposable</code> interface. As such, the code can asynchronously <code>await using</code> the <code>app</code> instance. This is the proper way to ensure that the <code>app</code> will be disposed of when it’s done running.</p>

<p>Finally, the code calls <code>await app.RunAsync();</code>. This runs the application and returns a <code>Task</code> that completes when the app is shut down.</p>

<p>While this Minimal API project has a <code>Program</code> file with a meager three lines of code, there is a fair amount that’s going on here. This API is exposing a very important piece of app functionality: the ability to evaluate whether a user’s email has been part of a data breach. This information is hugely helpful to users, and it needs to be properly protected. The API itself requires an authenticated <a data-primary="WebApplicationBuilderExtensions.cs" data-type="indexterm" id="wbald"/><a data-primary="Azure Active Directory (AD) business-to-consumer (B2C)" data-type="indexterm" id="idm46365029710240"/>user with a specific Azure AD B2C scope. Consider the <em>WebApplicationBuilderExtensions.cs</em> C# file:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code> <code class="nn">Learning.Blazor.PwnedApi</code><code class="p">;</code>

<code class="k">static</code> <code class="k">class</code> <code class="nc">WebApplicationBuilderExtensions</code>
<code class="p">{</code>
    <code class="k">internal</code> <code class="k">static</code> <code class="n">WebApplicationBuilder</code> <code class="nf">AddPwnedEndpoints</code><code class="p">(</code>
       <code class="k">this</code> <code class="n">WebApplicationBuilder</code> <code class="n">builder</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">ArgumentNullException</code><code class="p">.</code><code class="n">ThrowIfNull</code><code class="p">(</code><code class="n">builder</code><code class="p">)</code><code class="p">;</code> <a class="co" href="#callout___componentizing_CO4-1" id="co___componentizing_CO4-1"><img alt="1" src="assets/1.png"/></a>

        <code class="kt">var</code> <code class="n">webClientOrigin</code> <code class="p">=</code> <code class="n">builder</code><code class="p">.</code><code class="n">Configuration</code><code class="p">[</code><code class="s">"WebClientOrigin"</code><code class="p">]</code><code class="p">;</code> <a class="co" href="#callout___componentizing_CO4-2" id="co___componentizing_CO4-2"><img alt="2" src="assets/2.png"/></a>
        <code class="n">builder</code><code class="p">.</code><code class="n">Services</code><code class="p">.</code><code class="n">AddCors</code><code class="p">(</code>
            <code class="n">options</code> <code class="p">=</code><code class="p">&gt;</code>
                <code class="n">options</code><code class="p">.</code><code class="n">AddDefaultPolicy</code><code class="p">(</code>
                    <code class="n">policy</code> <code class="p">=</code><code class="p">&gt;</code>
                        <code class="n">policy</code><code class="p">.</code><code class="n">WithOrigins</code><code class="p">(</code>
                                <code class="n">webClientOrigin</code><code class="p">,</code> <code class="s">"https://localhost:5001"</code><code class="p">)</code>
                            <code class="p">.</code><code class="n">AllowAnyHeader</code><code class="p">(</code><code class="p">)</code>
                            <code class="p">.</code><code class="n">AllowAnyMethod</code><code class="p">(</code><code class="p">)</code>
                            <code class="p">.</code><code class="n">AllowCredentials</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code class="p">;</code>

        <code class="n">builder</code><code class="p">.</code><code class="n">Services</code><code class="p">.</code><code class="n">AddAuthentication</code><code class="p">(</code> <a class="co" href="#callout___componentizing_CO4-3" id="co___componentizing_CO4-3"><img alt="3" src="assets/3.png"/></a>
            <code class="n">JwtBearerDefaults</code><code class="p">.</code><code class="n">AuthenticationScheme</code><code class="p">)</code>
            <code class="p">.</code><code class="n">AddMicrosoftIdentityWebApi</code><code class="p">(</code>
                <code class="n">builder</code><code class="p">.</code><code class="n">Configuration</code><code class="p">.</code><code class="n">GetSection</code><code class="p">(</code><code class="s">"AzureAdB2C"</code><code class="p">)</code><code class="p">)</code><code class="p">;</code>

        <code class="n">builder</code><code class="p">.</code><code class="n">Services</code><code class="p">.</code><code class="n">Configure</code><code class="p">&lt;</code><code class="n">JwtBearerOptions</code><code class="p">&gt;</code><code class="p">(</code> <a class="co" href="#callout___componentizing_CO4-4" id="co___componentizing_CO4-4"><img alt="4" src="assets/4.png"/></a>
            <code class="n">JwtBearerDefaults</code><code class="p">.</code><code class="n">AuthenticationScheme</code><code class="p">,</code>
            <code class="n">options</code> <code class="p">=</code><code class="p">&gt;</code>
                <code class="n">options</code><code class="p">.</code><code class="n">TokenValidationParameters</code><code class="p">.</code><code class="n">NameClaimType</code> <code class="p">=</code> <code class="s">"name"</code><code class="p">)</code><code class="p">;</code>

        <code class="n">builder</code><code class="p">.</code><code class="n">Services</code><code class="p">.</code><code class="n">AddPwnedServices</code><code class="p">(</code> <a class="co" href="#callout___componentizing_CO4-5" id="co___componentizing_CO4-5"><img alt="5" src="assets/5.png"/></a>
            <code class="n">builder</code><code class="p">.</code><code class="n">Configuration</code><code class="p">.</code><code class="n">GetSection</code><code class="p">(</code><code class="n">nameof</code><code class="p">(</code><code class="n">HibpOptions</code><code class="p">)</code><code class="p">)</code><code class="p">,</code>
            <code class="n">HttpClientBuilderRetryPolicyExtensions</code><code class="p">.</code><code class="n">GetDefaultRetryPolicy</code><code class="p">)</code><code class="p">;</code>

        <code class="n">builder</code><code class="p">.</code><code class="n">Services</code><code class="p">.</code><code class="n">AddSingleton</code><code class="p">&lt;</code><code class="n">PwnedServices</code><code class="p">&gt;</code><code class="p">(</code><code class="p">)</code><code class="p">;</code>

        <code class="k">return</code> <code class="n">builder</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>
<dl class="calloutlist pagebreak-before less_space">
<dt><a class="co" href="#co___componentizing_CO4-1" id="callout___componentizing_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The extension defensively checks that the <code>builder</code> is not null.</p></dd>
<dt><a class="co" href="#co___componentizing_CO4-2" id="callout___componentizing_CO4-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>WebClientOrigin</code> configuration value is extracted.</p></dd>
<dt><a class="co" href="#co___componentizing_CO4-3" id="callout___componentizing_CO4-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p><code>builder</code> is configured to use JWT bearer authentication.</p></dd>
<dt><a class="co" href="#co___componentizing_CO4-4" id="callout___componentizing_CO4-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The JWT bearer name claim type is set to <code>name</code>.</p></dd>
<dt><a class="co" href="#co___componentizing_CO4-5" id="callout___componentizing_CO4-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>A call to <code>AddPwnedServices</code> is made, which adds the required services.</p></dd>
</dl>

<p>.NET 6 introduced a new API on the <code>ArgumentNullException</code> type that will <code>throw</code> if a given parameter is <code>null</code>. This API is <code>void</code> returning, so it’s not fluent, but it can still save a few lines of code.</p>

<p>Given the <code>builder.Configuration</code> instance, the <a data-primary="builder.Configuration" data-type="indexterm" id="idm46365029429280"/>code expects a value for the <code>"WebClientOrigin"</code> key. This is the origin of the client Blazor application, and it’s used to configure cross-origin resource <a data-primary="CORS (cross-origin resource sharing)" data-type="indexterm" id="idm46365029428032"/><a data-primary="cross-origin resource sharing" data-see="CORS" data-type="indexterm" id="idm46365029427424"/>sharing, or, simply, CORS. CORS is a policy that enables different origins to share resources, i.e., one origin can request resources from another. By default, browsers enforce the “same-origin” policy as a standard to ensure the browser can make API calls to a different origin. Because the Pwned API is hosted on a different origin than the Blazor client application, it must configure CORS and specify the allowable client origins.</p>

<p>The Azure AD B2C tenant is <a data-primary="Azure Active Directory (AD) business-to-consumer (B2C)" data-type="indexterm" id="idm46365029426064"/><a data-primary="AzureAdB2C" data-type="indexterm" id="idm46365029425456"/>configured. The <code>"AzureAdB2C"</code> section from the <em>app​settings.json</em> file is bound, which sets the instance, client identifier, domain, scopes, and policy ID.</p>

<p><code>JwtBearerOptions</code> is configured, specifying the <code>"name"</code> claim as the name claim type for token validation. This controls <a data-primary="JwtBearerOptions" data-type="indexterm" id="idm46365029422752"/>the behavior of the bearer authentication handler. The <em>JwtBearer</em> in the option’s name signifies that these options are for the JWT bearer settings. JWT stands for JSON Web Token, and these tokens represent an internet standard for authentication. ASP.NET Core uses these tokens to materialize the <code>ClaimsPrincipal</code> instance per-authenticated request.</p>

<p>The <code>AddPwnedServices</code> extension method <a data-primary="AddPwnedServices extension method" data-type="indexterm" id="idm46365029420032"/><a data-primary="methods" data-secondary="AddPwnedServices extension method" data-type="indexterm" id="idm46365029419328"/>is called, given the configuration’s <code>"Hib⁠p​Options"</code> section and the default HTTP retry policy. This project relies on the Web.Http.Extensions project. These extensions expose a common set of HTTP-based retry logic, relying on the Polly library. Following this pattern, the entire app shares a common transient fault handling policy to help keep everything running smoothly. Additionally, <code>PwnedServices</code> is added to <a data-primary="WebApplicationBuilderExtensions.cs" data-startref="wbald" data-type="indexterm" id="idm46365029417488"/>DI as a singleton.</p>

<p>The next extension method to evaluate after <code>AddPwnedEndpoints</code> is <code>MapPwned​End⁠points</code>. This <a data-primary="MapPwnedEndpoints extension method" data-type="indexterm" id="idm46365029414944"/><a data-primary="methods" data-secondary="MapPwnedEndpoints extension method" data-type="indexterm" id="idm46365029414240"/><a data-primary="WebApplicationExtensions.cs" data-type="indexterm" id="wbapss"/>happens in the <em>WebApplicationExtensions.cs</em> C# file in the Web​.Pwne⁠dApi project:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code> <code class="nn">Learning.Blazor.PwnedApi</code><code class="p">;</code>

<code class="k">static</code> <code class="k">class</code> <code class="nc">WebApplicationExtensions</code>
<code class="p">{</code>
    <code class="c1">/// &lt;summary&gt;
</code>    <code class="c1">/// Maps "pwned breach data" endpoints and "pwned passwords"
</code>    <code class="c1">/// endpoints, with Minimal APIs.
</code>    <code class="c1">/// &lt;/summary&gt;
</code>    <code class="c1">/// &lt;param name="app"&gt;The current &lt;see cref="WebApplication"/&gt;
</code>    <code class="c1">/// instance to map on.&lt;/param&gt;
</code>    <code class="c1">/// &lt;returns&gt;The given &lt;paramref name="app"/&gt; as a fluent API.&lt;/returns&gt;
</code>    <code class="c1">/// &lt;exception cref="ArgumentNullException"&gt;When &lt;paramref name="app"/&gt;
</code>    <code class="c1">/// is &lt;c&gt;null&lt;/c&gt;.&lt;/exception&gt;
</code>    <code class="k">internal</code> <code class="k">static</code> <code class="n">WebApplication</code> <code class="nf">MapPwnedEndpoints</code><code class="p">(</code><code class="k">this</code> <code class="n">WebApplication</code> <code class="n">app</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">ArgumentNullException</code><code class="p">.</code><code class="n">ThrowIfNull</code><code class="p">(</code><code class="n">app</code><code class="p">)</code><code class="p">;</code>

        <code class="n">app</code><code class="p">.</code><code class="n">UseHttpsRedirection</code><code class="p">(</code><code class="p">)</code><code class="p">;</code> <a class="co" href="#callout___componentizing_CO5-1" id="co___componentizing_CO5-1"><img alt="1" src="assets/1.png"/></a>
        <code class="n">app</code><code class="p">.</code><code class="n">UseCors</code><code class="p">(</code><code class="p">)</code><code class="p">;</code>
        <code class="n">app</code><code class="p">.</code><code class="n">UseAuthentication</code><code class="p">(</code><code class="p">)</code><code class="p">;</code>
        <code class="n">app</code><code class="p">.</code><code class="n">UseAuthorization</code><code class="p">(</code><code class="p">)</code><code class="p">;</code>

        <code class="n">app</code><code class="p">.</code><code class="n">MapBreachEndpoints</code><code class="p">(</code><code class="p">)</code><code class="p">;</code> <a class="co" href="#callout___componentizing_CO5-2" id="co___componentizing_CO5-2"><img alt="2" src="assets/2.png"/></a>
        <code class="n">app</code><code class="p">.</code><code class="n">MapPwnedPasswordsEndpoints</code><code class="p">(</code><code class="p">)</code><code class="p">;</code>

        <code class="k">return</code> <code class="n">app</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">internal</code> <code class="k">static</code> <code class="n">WebApplication</code> <code class="nf">MapBreachEndpoints</code><code class="p">(</code> <a class="co" href="#callout___componentizing_CO5-3" id="co___componentizing_CO5-3"><img alt="3" src="assets/3.png"/></a>
        <code class="k">this</code> <code class="n">WebApplication</code> <code class="n">app</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="c1">// Map "have i been pwned" breaches.
</code>        <code class="n">app</code><code class="p">.</code><code class="n">MapGet</code><code class="p">(</code><code class="s">"api/pwned/breaches/{email}"</code><code class="p">,</code>
            <code class="n">GetBreachHeadersForAccountAsync</code><code class="p">)</code><code class="p">;</code>
        <code class="n">app</code><code class="p">.</code><code class="n">MapGet</code><code class="p">(</code><code class="s">"api/pwned/breach/{name}"</code><code class="p">,</code>
            <code class="n">GetBreachAsync</code><code class="p">)</code><code class="p">;</code>

        <code class="k">return</code> <code class="n">app</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">internal</code> <code class="k">static</code> <code class="n">WebApplication</code> <code class="nf">MapPwnedPasswordsEndpoints</code><code class="p">(</code> <a class="co" href="#callout___componentizing_CO5-4" id="co___componentizing_CO5-4"><img alt="4" src="assets/4.png"/></a>
        <code class="k">this</code> <code class="n">WebApplication</code> <code class="n">app</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="c1">// Map "have i been pwned" passwords.
</code>        <code class="n">app</code><code class="p">.</code><code class="n">MapGet</code><code class="p">(</code><code class="s">"api/pwned/passwords/{password}"</code><code class="p">,</code>
            <code class="n">GetPwnedPasswordAsync</code><code class="p">)</code><code class="p">;</code>

        <code class="k">return</code> <code class="n">app</code><code class="p">;</code>
    <code class="p">}</code>
<code class="na">
    [Authorize, RequiredScope("User.ApiAccess"), EnableCors]</code> <a class="co" href="#callout___componentizing_CO5-5" id="co___componentizing_CO5-5"><img alt="5" src="assets/5.png"/></a>
    <code class="k">internal</code> <code class="k">static</code> <code class="k">async</code> <code class="n">Task</code><code class="p">&lt;</code><code class="n">IResult</code><code class="p">&gt;</code> <code class="n">GetBreachHeadersForAccountAsync</code><code class="p">(</code>
<code class="na">        [FromRoute]</code> <code class="kt">string</code> <code class="n">email</code><code class="p">,</code>
        <code class="n">PwnedServices</code> <code class="n">pwnedServices</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="kt">var</code> <code class="n">breaches</code> <code class="p">=</code> <code class="k">await</code> <code class="n">pwnedServices</code><code class="p">.</code><code class="n">GetBreachHeadersAsync</code><code class="p">(</code><code class="n">email</code><code class="p">)</code><code class="p">;</code>
        <code class="k">return</code> <code class="n">Results</code><code class="p">.</code><code class="n">Json</code><code class="p">(</code><code class="n">breaches</code><code class="p">,</code> <code class="n">DefaultJsonSerialization</code><code class="p">.</code><code class="n">Options</code><code class="p">)</code><code class="p">;</code>
    <code class="p">}</code>
<code class="na">
    [Authorize, RequiredScope("User.ApiAccess"), EnableCors]</code>
    <code class="k">internal</code> <code class="k">static</code> <code class="k">async</code> <code class="n">Task</code><code class="p">&lt;</code><code class="n">IResult</code><code class="p">&gt;</code> <code class="n">GetBreachAsync</code><code class="p">(</code>
<code class="na">        [FromRoute]</code> <code class="kt">string</code> <code class="n">name</code><code class="p">,</code>
        <code class="n">PwnedServices</code> <code class="n">pwnedServices</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="kt">var</code> <code class="n">breach</code> <code class="p">=</code> <code class="k">await</code> <code class="n">pwnedServices</code><code class="p">.</code><code class="n">GetBreachDetailsAsync</code><code class="p">(</code><code class="n">name</code><code class="p">)</code><code class="p">;</code>
        <code class="k">return</code> <code class="n">Results</code><code class="p">.</code><code class="n">Json</code><code class="p">(</code><code class="n">breach</code><code class="p">,</code> <code class="n">DefaultJsonSerialization</code><code class="p">.</code><code class="n">Options</code><code class="p">)</code><code class="p">;</code>
    <code class="p">}</code>
<code class="na">
    [Authorize, RequiredScope("User.ApiAccess"), EnableCors]</code> <a class="co" href="#callout___componentizing_CO5-6" id="co___componentizing_CO5-6"><img alt="6" src="assets/6.png"/></a>
    <code class="k">internal</code> <code class="k">static</code> <code class="k">async</code> <code class="n">Task</code><code class="p">&lt;</code><code class="n">IResult</code><code class="p">&gt;</code> <code class="n">GetPwnedPasswordAsync</code><code class="p">(</code>
<code class="na">        [FromRoute]</code> <code class="kt">string</code> <code class="n">password</code><code class="p">,</code>
        <code class="n">IPwnedPasswordsClient</code> <code class="n">pwnedPasswordsClient</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="kt">var</code> <code class="n">pwnedPassword</code> <code class="p">=</code>
            <code class="k">await</code> <code class="n">pwnedPasswordsClient</code><code class="p">.</code><code class="n">GetPwnedPasswordAsync</code><code class="p">(</code><code class="n">password</code><code class="p">)</code><code class="p">;</code>
        <code class="k">return</code> <code class="n">Results</code><code class="p">.</code><code class="n">Json</code><code class="p">(</code><code class="n">pwnedPassword</code><code class="p">,</code> <code class="n">DefaultJsonSerialization</code><code class="p">.</code><code class="n">Options</code><code class="p">)</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co___componentizing_CO5-1" id="callout___componentizing_CO5-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>After ensuring that <code>app</code> is not null, some common middleware is added.</p></dd>
<dt><a class="co" href="#co___componentizing_CO5-2" id="callout___componentizing_CO5-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Both <code>Breach</code> and <code>PwnedPasswords</code> endpoints are mapped.</p></dd>
<dt><a class="co" href="#co___componentizing_CO5-3" id="callout___componentizing_CO5-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Relying on the framework-provided <code>MapGet</code>, two endpoints are mapped to two handlers.</p></dd>
<dt><a class="co" href="#co___componentizing_CO5-4" id="callout___componentizing_CO5-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Again, endpoints are mapped to handlers, this time for <code>PwnedPasswords</code>.</p></dd>
<dt><a class="co" href="#co___componentizing_CO5-5" id="callout___componentizing_CO5-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>The handler method can use framework-provided attributes and DI.</p></dd>
<dt><a class="co" href="#co___componentizing_CO5-6" id="callout___componentizing_CO5-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>Each handler is isolated and declarative.</p></dd>
</dl>

<p>The code uses HTTPS <a data-primary="HTTPS redirection" data-type="indexterm" id="idm46365028983264"/><a data-primary="CORS (cross-origin resource sharing)" data-secondary="authentication" data-type="indexterm" id="idm46365028982528"/><a data-primary="authorization" data-secondary="middleware" data-type="indexterm" id="idm46365028981616"/><a data-primary="authentication" data-secondary="CORS" data-type="indexterm" id="idm46365028980672"/>redirection, CORS, authentication, and authorization middleware. This middleware is commonplace with ASP.NET Core web app development and is part of the framework.</p>

<p>The <code>app</code> maps breach endpoints <a data-primary="breach endpoints" data-type="indexterm" id="idm46365028978416"/><a data-primary="endpoints" data-secondary="breach endpoints" data-type="indexterm" id="idm46365028977680"/><a data-primary="passwords" data-secondary="endpoints" data-type="indexterm" id="idm46365028976736"/><a data-primary="endpoints" data-secondary="passwords" data-type="indexterm" id="idm46365028975792"/>and Pwned <code>passwords</code> endpoints. These are entirely custom endpoints, defined within extension methods. After these methods are called, the <code>app</code> is returned, which fulfills a fluent API. This is what enabled the <code>Program</code> to chain calls after <code>builder.Build()</code>.</p>

<p>The <code>MapBreachEndpoints</code> method maps <a data-primary="MapBreachEndpoints method" data-type="indexterm" id="idm46365028971904"/><a data-primary="methods" data-secondary="MapBreachEndpoints" data-type="indexterm" id="idm46365028971200"/>two patterns and their corresponding 
<span class="keep-together"><code>Delegate handler</code></span> before returning. Each endpoint has a route pattern, which starts with <code>"api/pwned"</code>. These endpoints have placeholders for route parameters. These <a data-primary="endpoints" data-secondary="route handlers" data-type="indexterm" id="idm46365028968928"/>mapped endpoint route handlers are executed only when the framework determines the request has a matching route pattern; for example, an authenticated user could do the following:</p>

<ul>
<li>
<p>Request <code>https://example-domain.com/api/pwned/breaches/test@email.org</code> and run the <code>GetBreachHeadersForAccountAsync</code> delegate</p>
</li>
<li>
<p>Request <code>https://example-domain.com/api/pwned/breach/linkedin</code> and run the <code>GetBreachAsync</code> delegate</p>
</li>
</ul>

<p>The <code>MapPwnedPasswordsEndpoints</code> method maps the <a data-primary="endpoints" data-secondary="passwords" data-tertiary="mapping" data-type="indexterm" id="idm46365028931712"/><a data-primary="passwords" data-secondary="endpoints" data-tertiary="mapping" data-type="indexterm" id="idm46365028930752"/><a data-primary="MapPwnedPasswordsEndpoints method" data-type="indexterm" id="idm46365028929664"/><a data-primary="methods" data-secondary="MapPwnedPasswordsEndpoints" data-type="indexterm" id="idm46365028929056"/>password’s endpoint to the <code>GetPwnedPasswordAsync</code> handler.</p>

<p>The <code>GetBreachHeadersForAccountAsync</code> method <a data-primary="GetBreachHeadersForAccountAsync method" data-type="indexterm" id="idm46365028926704"/><a data-primary="methods" data-secondary="GetBreachHeadersForAccountAsync" data-type="indexterm" id="idm46365028926096"/>is an <code>async Task&lt;IResult&gt;</code> returning method. It declares an <code>Authorize</code> attribute, which protects this handler from unauthorized requests. Furthermore, it declares a <code>RequiredScope</code> of <code>"User.ApiAccess"</code>, which is the scope defined in the Azure AD B2C tenant. In other words, this handler (or API, for that matter) will be accessible only to an authenticated user from our Azure AD B2C tenant who has this specific scope. Users of the Learning Blazor application will have this scope, therefore, they can access this API. The method declares the <code>EnableCors</code> attribute, which ensures that this handler uses the configured CORS policy. Besides all of that, this method is like any other C# method. It requires a few parameters:</p>
<dl>
<dt><code>[FromRoute] string email</code></dt>
<dd>
<p>The <code>FromRoute</code> attribute on the parameter tells the framework that the parameter is to be provided from the <code>{email}</code> placeholder in the route pattern.</p>
</dd>
<dt><code>PwnedServices pwnedServices</code></dt>
<dd>
<p>The service instance is injected from DI, and the breach headers are asynchronously requested given the <code>email</code>. <code>breaches</code> are returned as JSON.</p>
</dd>
</dl>

<p>The <code>GetPwnedPasswordAsync</code> method is <a data-primary="methods" data-secondary="GetPwnedPasswordAsync" data-type="indexterm" id="idm46365028917728"/><a data-primary="GetPwnedPasswordAsync method" data-type="indexterm" id="idm46365028916880"/>much like the previous, except it expects a <code>password</code> from the route and the <code>IPwnedPasswordsClient</code> instance from the DI container.</p>

<p>Through the lens of our application, it’s helpful to the users to make this information readily available. When the user performs their login, we’ll check the HIBP API and report back. As a user, I can trust that the app will do its intended work and I don’t have to manually check or wait for an email. As I use the app, it’s helping me by making information immediately available, which would otherwise be inconvenient to dig up. The Learning Blazor application does rely on the <code>HaveIBeenPwned.Client</code> NuGet package <a data-primary="HIBP (Have I Been Pwned) API" data-secondary="client services" data-startref="hbpsv" data-type="indexterm" id="idm46365028914608"/><a data-primary="Learning Blazor app" data-secondary="HIBP API, client services" data-startref="lgzcv" data-type="indexterm" id="idm46365028913520"/><a data-primary="WebApplicationExtensions.cs" data-startref="wbapss" data-type="indexterm" id="idm46365028912432"/>and exposes it through its Web Pwned API project.</p>
</div></section>













<section data-pdf-bookmark="Restricting Access to Resources" data-type="sect2"><div class="sect2" id="idm46365030010432">
<h2>Restricting Access to Resources</h2>

<p>If you recall, our markup thus far <a data-primary="resources" data-secondary="access restriction" data-type="indexterm" id="rsccrt"/><a data-primary="Learning Blazor app" data-secondary="resources, access restriction" data-type="indexterm" id="lgzrcc"/>made use of the <code>Authorize</code> framework-provided component to protect various client rendering of custom components. We can 
<span class="keep-together">continue</span> to selectively use this approach to restrict access to functionality in your app. This is known as <em>authorization</em>.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="authorization">
<h5>Authorization</h5>
<p><em>Authorization</em> is the act of <a data-primary="authorization" data-type="indexterm" id="idm46365028904544"/>using additional user-available information to determine what a user has access to. For example, imagine that Carol is an authenticated user of the app and part of the Administrators group or role. She would likely have unlimited access to resources, while someone else with a lesser role would have restricted access.</p>

<p>This is distinct from <em>identity</em> and <em>authentication</em>, defined in <a data-type="xref" href="#identity-and-authentication">“Identity and Authentication”</a>.</p>
</div></aside>

<p>In the case of the sample application, the <em>Index.razor</em> markup file uses authorization to hide the routes when the app doesn’t have an authenticated user:</p>

<pre data-code-language="html" data-type="programlisting"><code>@page "/" </code><a class="co" href="#callout___componentizing_CO6-1" id="co___componentizing_CO6-1"><img alt="1" src="assets/1.png"/></a><code>
@inherits LocalizableComponentBase</code><code class="p">&lt;</code><code class="nt">Index</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">PageTitle</code><code class="p">&gt;</code> <a class="co" href="#callout___componentizing_CO6-2" id="co___componentizing_CO6-2"><img alt="2" src="assets/2.png"/></a><code>
    @Localizer["Home"]
</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">PageTitle</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">AuthorizeView</code><code class="p">&gt;</code> <a class="co" href="#callout___componentizing_CO6-3" id="co___componentizing_CO6-3"><img alt="3" src="assets/3.png"/></a>
    <code class="p">&lt;</code><code class="nt">NotAuthorized</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">RedirectToLogin</code> <code class="p">/</code><code class="p">&gt;</code> <a class="co" href="#callout___componentizing_CO6-4" id="co___componentizing_CO6-4"><img alt="4" src="assets/4.png"/></a>
    <code class="p">&lt;</code><code class="p">/</code><code class="nt">NotAuthorized</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">Authorized</code><code class="p">&gt;</code> <a class="co" href="#callout___componentizing_CO6-5" id="co___componentizing_CO6-5"><img alt="5" src="assets/5.png"/></a>
        <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"index"</code> <code class="na">class</code><code class="o">=</code><code class="s">"tile is-ancestor"</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"tile is-vertical is-centered is-7"</code><code class="p">&gt;</code>
                <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"tile"</code><code class="p">&gt;</code>
                    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"tile is-parent"</code><code class="p">&gt;</code>
                        <code class="p">&lt;</code><code class="nt">IntroductionComponent</code> <code class="p">/</code><code class="p">&gt;</code>
                    <code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code>
                    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"tile is-parent"</code><code class="p">&gt;</code>
                        <code class="p">&lt;</code><code class="nt">JokeComponent</code> <code class="p">/</code><code class="p">&gt;</code>
                    <code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code>
                <code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code>
                <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"tile is-parent"</code><code class="p">&gt;</code>
                    <code class="p">&lt;</code><code class="nt">WeatherComponent</code> <code class="p">/</code><code class="p">&gt;</code>
                <code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="p">/</code><code class="nt">Authorized</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="p">/</code><code class="nt">AuthorizeView</code><code class="p">&gt;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co___componentizing_CO6-1" id="callout___componentizing_CO6-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The default page is the <code>Index</code> page, at the root of the application.</p></dd>
<dt><a class="co" href="#co___componentizing_CO6-2" id="callout___componentizing_CO6-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>PageTitle</code> component is used to display the page title.</p></dd>
<dt><a class="co" href="#co___componentizing_CO6-3" id="callout___componentizing_CO6-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>AuthorizeView</code> component is used to conditionally display the page content.</p></dd>
<dt><a class="co" href="#co___componentizing_CO6-4" id="callout___componentizing_CO6-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p><code>NotAuthorized</code> will redirect to the login page.</p></dd>
<dt><a class="co" href="#co___componentizing_CO6-5" id="callout___componentizing_CO6-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p><code>Authorized</code> will display <code>IntroductionComponent</code>, <code>JokeComponent</code>, and <code>WeatherComponent</code>.</p></dd>
</dl>

<p>This is the first time <a data-primary="@page directive" data-primary-sortas="page directive" data-type="indexterm" id="idm46365028706752"/><a data-primary="directives" data-secondary="@page" data-type="indexterm" id="idm46365028705776"/><a data-primary="templates" data-secondary="@page directive" data-type="indexterm" id="idm46365028704800"/>seeing the <code>@page</code> directive. This is how you template your apps’ navigation and client-side routing. Each component within a Blazor app that defines a page will serve as a user-navigable route. The routes are defined as a C# string. This literal is a value used to define the route templates, route parameters, and route constraints.</p>

<p><code>PageTitle</code> is a framework-provided component <a data-primary="PageTitle component" data-type="indexterm" id="idm46365028702608"/>that allows for the dynamic updating of the page’s <code>head &gt; title</code>, its HTML DOM <code>&lt;title&gt;</code> element. This is the value that will display in the browser tab UI.</p>

<p>The <code>AuthorizeView</code> template component <a data-primary="AuthorizeView component" data-type="indexterm" id="idm46365028700080"/>exposes the <code>NotAuthorized</code> and 
<span class="keep-together"><code>Authorized</code></span> render fragments. These are templates specific to the state of the current user in context.</p>

<p>When the user is not authorized, we’ll redirect the user. We’ve already discussed the ability to redirect an unauthenticated user using the <code>RedirectToLogin</code> component. See <a data-type="xref" href="ch02.html#redirect-to-login">“Redirect to login when unauthenticated”</a>.</p>

<p>When there is an authenticated user, they’ll see three tiles. The first tile is a simple “thank you” message for you, the user of the app and consumer of my book! It renders the custom <code>IntroductionComponent</code>. The second tile is the joke component. It’s backed by an aggregate joke service that randomly attempts to provide developer humor from multiple sources. The last tile spans the entire row under the intro and joke components, and it displays <code>WeatherComponent</code>. We’ll discuss each of these various custom Blazor component implementations and their <a data-primary="resources" data-secondary="access restriction" data-startref="rsccrt" data-type="indexterm" id="idm46365028694784"/><a data-primary="Learning Blazor app" data-secondary="resources, access restricting" data-startref="lgzrcc" data-type="indexterm" id="idm46365028693536"/>varying degrees of data binding and event handling.</p>
</div></section>





</div></section>













<section data-pdf-bookmark="The Introduction Component Says “Hi”" data-type="sect1"><div class="sect1" id="idm46365035438544">
<h1>The Introduction Component Says “Hi”</h1>

<p>The next component of the Learning <a data-primary="IntroductionComponent" data-type="indexterm" id="intcp"/><a data-primary="Learning Blazor app" data-secondary="IntroductionComponent" data-type="indexterm" id="lgzicp"/>Blazor app is the <code>IntroductionComponent</code> that says “Hi” to those who visit the app, as shown in <a data-type="xref" href="#intro-light">Figure 3-2</a>.</p>

<figure><div class="figure" id="intro-light">
<img alt="" src="assets/lblz_0302.png"/>
<h6><span class="label">Figure 3-2. </span>An example rendering of the <code>IntroductionComponent</code></h6>
</div></figure>

<p>Have a look <a data-primary="Components/IntroductionComponent.razor.cs" data-type="indexterm" id="idm46365028684240"/>at the <em>Components/IntroductionComponent.razor.cs</em> C# file of the Web.Client project:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">using</code> <code class="nn">Microsoft.Extensions.Localization</code><code class="p">;</code> <a class="co" href="#callout___componentizing_CO7-1" id="co___componentizing_CO7-1"><img alt="1" src="assets/1.png"/></a>

<code class="k">namespace</code> <code class="nn">Learning.Blazor.Components</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">partial</code> <code class="k">class</code> <code class="nc">IntroductionComponent</code>
    <code class="p">{</code>
        <code class="k">private</code> <code class="n">LocalizedString</code> <code class="n">_intro</code> <code class="p">=</code><code class="p">&gt;</code> <code class="n">Localizer</code><code class="p">[</code><code class="s">"ThankYou"</code><code class="p">]</code><code class="p">;</code> <a class="co" href="#callout___componentizing_CO7-2" id="co___componentizing_CO7-2"><img alt="2" src="assets/2.png"/></a>
    <code class="p">}</code>
<code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co___componentizing_CO7-1" id="callout___componentizing_CO7-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The component is <code>using Microsoft.Extensions.Localization</code>.</p></dd>
<dt><a class="co" href="#co___componentizing_CO7-2" id="callout___componentizing_CO7-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>It defines a single property.</p></dd>
</dl>

<p><code>class</code> makes use of the <code>LocalizedString</code> type, which is a locale-specific <code>string</code>. This comes from the <code>Microsoft.Extensions.Localization</code> namespace.</p>

<p class="pagebreak-after"><code>class</code> defines a single field named <code>_intro</code>, which is expressed as a call to the 
<span class="keep-together"><code>Localizer</code></span> given the <code>"ThankYou"</code> key. This key identifies the resource to resolve from the localizer instance. In Blazor WebAssembly, localized resources <a data-primary="localized resources" data-type="indexterm" id="idm46365028611136"/>such as those found in <em>.resx</em> files are available using the <code>IStringLocalizer</code> framework-provided type. The <code>Localizer</code> type, however, is a custom type named <code>CoalescingString​Local⁠izer</code>. This type is covered in more detail in <a data-type="xref" href="ch05.html#chapter-five">Chapter 5</a>.</p>

<p>The <code>Localizer</code> member comes from the <code>LocalizableComponentBase</code> type. This is a subclass for a lot of our <a data-primary="IntroductionComponent.razor" data-type="indexterm" id="idm46365028606624"/>components. Now, let’s look at the <em>Introduction​Compo⁠nent.razor</em> markup file:</p>

<pre data-code-language="html" data-type="programlisting"><code>@inherits LocalizableComponentBase</code><code class="p">&lt;</code><code class="nt">IntroductionComponent</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">article</code> <code class="na">class</code><code class="o">=</code><code class="s">"blazor-tile-container"</code><code class="p">&gt;</code> <a class="co" href="#callout___componentizing_CO8-1" id="co___componentizing_CO8-1"><img alt="1" src="assets/1.png"/></a>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"gradient-bg welcome-gradient"</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"icon-overlay heart-svg"</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"blaze-content"</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">p</code> <code class="na">class</code><code class="o">=</code><code class="s">"title is-family-monospace"</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">span</code> <code class="na">class</code><code class="o">=</code><code class="s">"wave"</code><code class="p">&gt;</code><code class="ni">&amp;#x1F44B;</code><code class="ni">&amp;#x1F3FD;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">span</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">span</code> <code class="na">class</code><code class="o">=</code><code class="s">"has-text-light"</code><code class="p">&gt;</code><code>
                @Localizer["Hi"] </code><a class="co" href="#callout___componentizing_CO8-2" id="co___componentizing_CO8-2"><img alt="2" src="assets/2.png"/></a>
            <code class="p">&lt;</code><code class="p">/</code><code class="nt">span</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="p">/</code><code class="nt">p</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">AdditiveSpeechComponent</code> <code class="na">Message</code><code class="o">=</code><code class="s">@_intro.Value</code> <code class="p">/</code><code class="p">&gt;</code> <a class="co" href="#callout___componentizing_CO8-3" id="co___componentizing_CO8-3"><img alt="3" src="assets/3.png"/></a>
        <code class="p">&lt;</code><code class="nt">p</code> <code class="na">class</code><code class="o">=</code><code class="s">"has-text-black is-family-monospace welcome-text is-size-5"</code><code class="p">&gt;</code><code>
            @_intro </code><a class="co" href="#callout___componentizing_CO8-4" id="co___componentizing_CO8-4"><img alt="4" src="assets/4.png"/></a>
        <code class="p">&lt;</code><code class="p">/</code><code class="nt">p</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="p">/</code><code class="nt">article</code><code class="p">&gt;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co___componentizing_CO8-1" id="callout___componentizing_CO8-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The component is a beautifully styled <code>&lt;article&gt;</code> element.</p></dd>
<dt><a class="co" href="#co___componentizing_CO8-2" id="callout___componentizing_CO8-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>There is a localized greeting message.</p></dd>
<dt><a class="co" href="#co___componentizing_CO8-3" id="callout___componentizing_CO8-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p><code>_intro</code> has its value bound to the <code>Message</code> property of <code>AdditiveSpeech​Compo⁠nent</code>.</p></dd>
<dt><a class="co" href="#co___componentizing_CO8-4" id="callout___componentizing_CO8-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The <code>_intro</code> value is also rendered as text within the <code>&lt;p&gt;</code> element.</p></dd>
</dl>

<p>The HTML markup, for the most part, is pure HTML. If you look it over, you should notice only a few Blazor bits.</p>

<p>The Razor code context <a data-primary="Razor" data-secondary="code context" data-type="indexterm" id="idm46365028443952"/>switches from raw HTML to accessing the <code>Localizer</code> instance in the <code>class</code>. I wanted to demonstrate that you can use fields in the <code>class</code>, or access other members to achieve one-way data binding. The localized message corresponding to the <code>"Hi"</code> key is bound after the waving emoji hand. The greeting message is “Hi, I’m David.”</p>

<p>There is a custom <code>AdditiveSpeechComponent</code> that <a data-primary="AdditiveSpeechComponent" data-type="indexterm" id="idm46365028439936"/>has a <code>Message</code> parameter bound to <code>_intro.Value</code>. This component will render a button in the top-right corner of the tile. This button, when clicked, will read the given <code>Message</code> value to the user. The <code>AdditiveSpeechComponent</code> component is covered in detail in the next chapter.</p>

<p>The <code>_intro</code> localized resource value is splatted into the <code>&lt;p&gt;</code> element.</p>

<p>The localized resource files, by <a data-primary="localized resources" data-type="indexterm" id="idm46365028435648"/><a data-primary="resources" data-secondary="localized resource files" data-type="indexterm" id="idm46365028434944"/><a data-primary="IntroductionComponent.razor.en.resx" data-type="indexterm" id="idm46365028434032"/>convention, have names that align with the file they’re localizing. For example, the <em>Introduction​Component.razor.cs</em> file has an <em>Introduction​Component.razor.en.resx</em> XML file. The following is a trimmed-down example of what its contents would look like:</p>

<pre data-code-language="xml" data-type="programlisting"><code class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</code>
<code class="nt">&lt;root&gt;</code>
  <code class="nt">&lt;data</code> <code class="na">name=</code><code class="s">"Hi"</code> <code class="na">xml:space=</code><code class="s">"preserve"</code><code class="nt">&gt;</code>
    <code class="nt">&lt;value&gt;</code>Hi, I'm David<code class="nt">&lt;/value&gt;</code>
  <code class="nt">&lt;/data&gt;</code>
  <code class="nt">&lt;data</code> <code class="na">name=</code><code class="s">"ThankYou"</code> <code class="na">xml:space=</code><code class="s">"preserve"</code><code class="nt">&gt;</code>
    <code class="nt">&lt;value&gt;</code>
        I'm honored, humbled, and thrilled to invite you
        on a tour of my "Learning Blazor: Build Single-Page Apps
        with WebAssembly and C#" book.
    <code class="nt">&lt;/value&gt;</code>
  <code class="nt">&lt;/data&gt;</code>
<code class="nt">&lt;/root&gt;</code></pre>

<p>Within a top-level <code>root</code> node, there <a data-primary="root node" data-type="indexterm" id="idm46365028408272"/><a data-primary="data nodes" data-type="indexterm" id="idm46365028407664"/>are <code>data</code> nodes. Each <code>data</code> node has a <code>name</code> attribute, and the name is the key used to retrieve the resource’s <code>value</code>. There can be any number of <code>data</code> nodes. This example file is in English, while other languages would use their specific locale identifier in the file name. For example, a French resource file would be named <em>IntroductionComponent.razor.fr.resx</em>, and it would contain the same <code>root &gt; data [name]</code> structure, but its <code>value</code> nodes would have French translations instead. The same is true for any locale the app intends to provide resources for.</p>

<p>The introduction component shows one-way data binding and localized content. Let’s extend these two concepts a <a data-primary="IntroductionComponent" data-startref="intcp" data-type="indexterm" id="idm46365028401808"/><a data-primary="Learning Blazor app" data-secondary="IntroductionComponent" data-startref="lgzicp" data-type="indexterm" id="idm46365028400832"/>bit further and explore <code>JokeComponent</code>.</p>
</div></section>













<section data-pdf-bookmark="The Joke Component and Services" data-type="sect1"><div class="sect1" id="idm46365028691456">
<h1>The Joke Component and Services</h1>

<p>The joke component of the Learning Blazor app displays a random joke. The joke component will render a spinner while it’s busy <a data-primary="JokeComponent" data-type="indexterm" id="jclza"/><a data-primary="Learning Blazor app" data-secondary="JokeComponent" data-type="indexterm" id="lgzjkp"/>fetching a random joke from the endpoint. When the joke is retrieved successfully, it will render with a random joke similar to that shown in <a data-type="xref" href="#jokes-light">Figure 3-3</a>.</p>
<div data-type="tip"><h6>Tip</h6>
<p>I love the Internet Chuck Norris Database (icndb). I use it a lot for programming demos. Not only <a data-primary="Internet Chuck Norris Database (icndb)" data-type="indexterm" id="idm46365028393200"/><a data-primary="icndb (Internet Chuck Norris Database)" data-type="indexterm" id="idm46365028392528"/>does it provide nerdy humor, but I like its simplicity. It makes for a compelling story. Likewise, jokes often find their way into my household. Being a father of three sons, I know that my boys love hearing “dad jokes,” and what makes them happy brings me joy.</p>
</div>

<figure><div class="figure" id="jokes-light">
<img alt="" src="assets/lblz_0303.png"/>
<h6><span class="label">Figure 3-3. </span>An example rendering of the <code>JokeComponent</code></h6>
</div></figure>

<p>This component makes an HTTP request to <a data-primary="api/jokes endpoint" data-type="indexterm" id="idm46365028388592"/><a data-primary="endpoints" data-secondary="api/jokes" data-type="indexterm" id="idm46365028361888"/>the <code>api/jokes</code> Web API endpoint. The joke object itself is shared with both the Web API endpoint and the client-side code. This helps to ensure that there aren’t any misalignments with the data structure, which could cause serialization errors or missing data. Consider the <em>Joke​Compo⁠nent.razor</em> markup <a data-primary="JokeComponent.razor" data-type="indexterm" id="jkcp"/><a data-primary="Learning Blazor app" data-secondary="JokeComponent.razor" data-type="indexterm" id="idm46365028359296"/>file:</p>

<pre data-code-language="html" data-type="programlisting"><code>@inject IJokeFactory JokeFactory </code><a class="co" href="#callout___componentizing_CO9-1" id="co___componentizing_CO9-1"><img alt="1" src="assets/1.png"/></a><code>
@inject ILogger</code><code class="p">&lt;</code><code class="nt">JokeComponent</code><code class="p">&gt;</code><code> Logger
@inject IStringLocalizer</code><code class="p">&lt;</code><code class="nt">JokeComponent</code><code class="p">&gt;</code><code> Localizer

</code><code class="p">&lt;</code><code class="nt">article</code> <code class="na">class</code><code class="o">=</code><code class="s">"blazor-tile-container"</code><code class="p">&gt;</code> <a class="co" href="#callout___componentizing_CO9-2" id="co___componentizing_CO9-2"><img alt="2" src="assets/2.png"/></a>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"gradient-bg jokes-gradient"</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"icon-overlay circle-svg"</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"blaze-content"</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">p</code> <code class="na">class</code><code class="o">=</code><code class="s">"title"</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">span</code> <code class="na">class</code><code class="o">=</code><code class="s">"is-emoji"</code><code class="p">&gt;</code><code class="ni">&amp;#x1F913;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">span</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">span</code> <code class="na">class</code><code class="o">=</code><code class="s">"has-text-light"</code><code class="p">&gt;</code><code>@Localizer["Jokes"]</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">span</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="p">/</code><code class="nt">p</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">AdditiveSpeechComponent</code> <code class="na">Message</code><code class="o">=</code><code class="s">@_jokeText</code> <code class="p">/</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"content"</code><code class="p">&gt;</code><code>
            @if (_isLoadingJoke) </code><a class="co" href="#callout___componentizing_CO9-3" id="co___componentizing_CO9-3"><img alt="3" src="assets/3.png"/></a><code>
            {
                </code><code class="p">&lt;</code><code class="nt">SpinnerComponent</code> <code class="p">/</code><code class="p">&gt;</code><code>
            }
            else if (_jokeText is not null)
            {
                </code><code class="p">&lt;</code><code class="nt">blockquote</code> <code class="na">class</code><code class="o">=</code><code class="s">"has-text-black"</code><code class="p">&gt;</code>
                    <code class="p">&lt;</code><code class="nt">span</code> <code class="na">class</code><code class="o">=</code><code class="s">"pb-4"</code><code class="p">&gt;</code><code>@_jokeText</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">span</code><code class="p">&gt;</code>
                    <code class="p">&lt;</code><code class="nt">br</code><code class="p">&gt;</code><code>
                    @if (_sourceDetails is { Site: not null })
                    {
                        </code><code class="p">&lt;</code><code class="nt">cite</code><code class="p">&gt;</code>
                            <code class="ni">&amp;mdash;</code><code>
                            @{
                                var (site, source) = _sourceDetails.Value;
                            }
                            </code><code class="p">&lt;</code><code class="nt">a</code> <code class="na">href</code><code class="o">=</code><code class="s">"@(site.ToString())"</code> <code class="na">target</code><code class="o">=</code><code class="s">"_blank"</code><code class="p">&gt;</code><code>
                                @(source.ToString())
                            </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">a</code><code class="p">&gt;</code>
                        <code class="p">&lt;</code><code class="p">/</code><code class="nt">cite</code><code class="p">&gt;</code><code>
                    }
                </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">blockquote</code><code class="p">&gt;</code><code>
            }
        </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="p">/</code><code class="nt">article</code><code class="p">&gt;</code><code>

@code { </code><a class="co" href="#callout___componentizing_CO9-4" id="co___componentizing_CO9-4"><img alt="4" src="assets/4.png"/></a><code>
    private string? _jokeText = null;
    private JokeSourceDetails? _sourceDetails;
    private bool _isLoadingJoke = false;

    protected override Task OnInitializedAsync() =&gt;
        RefreshJokeAsync();

    private async Task RefreshJokeAsync() </code><a class="co" href="#callout___componentizing_CO9-5" id="co___componentizing_CO9-5"><img alt="5" src="assets/5.png"/></a><code>
    {
        _isLoadingJoke = true;

        try
        {
            (_jokeText, _sourceDetails) =
                await JokeFactory.GetRandomJokeAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, ex.Message);
        }
        finally
        {
            _isLoadingJoke = false;
        }
    }
}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co___componentizing_CO9-1" id="callout___componentizing_CO9-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p><code>IJokeFactory</code> is injected into the component.</p></dd>
<dt><a class="co" href="#co___componentizing_CO9-2" id="callout___componentizing_CO9-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Like its counterpart components on the <code>Index</code> page, <code>JokeComponent</code> renders a styled <code>article</code> element.</p></dd>
<dt><a class="co" href="#co___componentizing_CO9-3" id="callout___componentizing_CO9-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>When loading, a spinner is displayed.</p></dd>
<dt><a class="co" href="#co___componentizing_CO9-4" id="callout___componentizing_CO9-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The <code>@code</code> directive is used to specify the code block.</p></dd>
<dt><a class="co" href="#co___componentizing_CO9-5" id="callout___componentizing_CO9-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>The <code>RefreshJokeAsync</code> method is called to fetch a new joke.</p></dd>
</dl>

<p>The <code>JokeComponent</code> markup starts like most other components, by declaring various directives. <code>JokeComponent</code> has the framework inject an <code>IJokeFactory</code>, <code>ILogger&lt;JokeComponent&gt;</code>, and <code>IStringLocalizer&lt;JokeComponent&gt;</code>. Any service that is registered in the DI container is a valid <code>@inject</code> directive target type. This component makes use of these specific services.</p>

<p>The HTML markup is a bit more verbose than the introduction component. Component complexity is something you should evaluate and be aware of. It’s a good rule of thumb to limit a component to a single responsibility. The responsibility of the joke component is to render a joke in HTML. The markup is similar to the introduction component, providing an emoji and localized title, as well as an <code>AdditiveSpeech​Com⁠ponent</code> that’s bound to the <code>_jokeText</code> variable.</p>

<p>The content markup for this joke component is conditional, and the use of <code>@if, else if, else, and @switch</code> expressions are supported control structures. This has been a part of <a data-primary="Razor" data-secondary="syntax" data-type="indexterm" id="idm46365028117200"/>the Razor syntax since the beginning. When the value of <code>_isLoadingJoke</code> evaluates as <code>true</code>, a stylized <code>SpinnerComponent</code> markup is rendered. <code>Spinner​Compo⁠nent</code> is custom too, and it’s a tiny bit of common HTML. Otherwise, when <code>_joke​Text is not null</code>, the random joke text is rendered as a <code>blockquote</code>.</p>

<p>The joke component uses an <code>@code { ... }</code> directive rather than the shadowed component approach. It’s important to understand that as a developer, you have options. More often than not, I prefer to not use <code>@code</code> directives. To me, it’s cleaner to keep them in separate files. I like seeing a C# class, and it feels a bit more natural to me that way. But if you’re a developer coming from the JavaScript SPA world, it might feel more natural to have the files together. The point is that the only way to determine the best approach is to gain a consensus from your team, much like other stylistic developer decisions.</p>

<p>The <code>RefreshJokeAsync</code> method <a data-primary="OnInitializedAsync lifecycle method" data-type="indexterm" id="idm46365028111072"/><a data-primary="methods" data-secondary="OnInitializedAsync" data-type="indexterm" id="idm46365028110368"/><a data-primary="RefreshJokeAsync method" data-type="indexterm" id="idm46365028109424"/><a data-primary="methods" data-secondary="RefreshJokeAsync" data-type="indexterm" id="idm46365028108752"/>is called by the <code>OnInitializedAsync</code> lifecycle method. This means that as part of the component’s initialization, the fetching of a joke will occur asynchronously. The method starts by setting the <code>_isLoadingJoke</code> bit to <code>true</code>; this will cause the spinner markup to be rendered—but only temporarily. The method body tries to ask the <code>IJokeFactory</code> instance to get a <code>JokeResponse</code> object. When there is a valid <code>response</code>, it’s deconstructed into a tuple assignment that sets the <code>_jokeText</code> and <code>_sourceDetails</code> fields. These are then rendered as the contents of the joke itself.</p>

<p class="pagebreak-after">The endpoints that power these jokes aggregate several third-party APIs together. The various joke endpoints have different data structures, and there are services in place <a data-primary="JokeComponent.razor" data-startref="jkcp" data-type="indexterm" id="idm46365028104096"/>to converge them into a single endpoint that our Blazor client code consumes.</p>








<section class="less_space" data-pdf-bookmark="Aggregating Joke Services—Laughter Ensues" data-type="sect2"><div class="sect2" id="idm46365028102864">
<h2>Aggregating Joke Services—Laughter Ensues</h2>

<p>No application is useful without meaningful data. Our app will have client-specific weather, random nerdy jokes, real-time web functionality, chat, notifications, a live Twitter stream, on-demand HIBP security features, and more. This is going to be fun! But what does this mean for Blazor? Before diving into the weeds with Blazor frontend development, we should set a few more expectations about the services and data driving this application—our backend development.</p>

<p>Blazor apps are free to retrieve and use data from any number of other platforms, services, or web applications. Many good architectures exist, with many possible solutions for any given problem domain. After all, knowing when to use which pattern or practice is part of being successful. You should try to identify the flow of data and basic requirements, where data comes from, and how to access this data. Does this data change frequently, is the data used to calculate other points of interest, and is the data dynamic or static? These are the better questions to be asking yourself. The answer is almost always “It depends.”</p>

<p>Let’s take a look at how the joke service library provides random jokes:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code> <code class="nn">Learning.Blazor.JokeServices</code><code class="p">;</code>

<code class="k">internal</code> <code class="k">interface</code> <code class="n">IJokeService</code>
<code class="p">{</code>
    <code class="n">JokeSourceDetails</code> <code class="n">SourceDetails</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="p">}</code>

    <code class="n">Task</code><code class="p">&lt;</code><code class="kt">string?</code><code class="p">&gt;</code> <code class="n">GetJokeAsync</code><code class="p">();</code>
<code class="p">}</code></pre>

<p>Before C# 10, <code>namespace</code> declarations wrapped their containing types in curly brackets. With C# 10, you can use file-scoped namespace, which enhances the readability by removing a level of indentation in the code. I like this feature; even though it’s a bit subtle, it does reduce noise when reading the code.</p>

<p><code>IJokeService</code> is an <code>internal interface</code> type, which <a data-primary="internal interface types" data-type="indexterm" id="idm46365028073248"/>exposes a read-only <code>JokeSour⁠ce​Details</code> property and the ability to request a joke asynchronously. The <code>internal</code> access modifier means that the joke service is not exposed outside of the declaring assembly.</p>

<p>The <code>GetJokeAsync</code> method is parameterless and returns a <code>Task&lt;string?&gt;</code>. The <code>?</code> on the <code>string</code> type declaration identifies that the returned <code>string</code> could be <code>null</code> (the default value of the C# reference type <code>string</code>).</p>

<p>We have three different third-party joke web services, all of which are free. The shapes of the joke responses vary by provider, as do the URLs. We have three separate configurations, endpoints, and joke <a data-primary="IJokeService implementation" data-type="indexterm" id="idm46365028067472"/>models that we have to represent.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46365028043632">
<h5>A Word on Asynchronous Code</h5>
<p>When making network calls, which are considered I/O-bound work, it’s advisable to program using the <code>async</code> and <code>await</code> keywords with C#. This approach is known as the <em>task-based asynchronous pattern</em> (TAP), primarily <a data-primary="TAP (task-based asynchronous pattern)" data-type="indexterm" id="idm46365028041008"/><a data-primary="task-based asynchronous pattern (TAP)" data-type="indexterm" id="idm46365028040400"/><a data-primary="async keyword" data-type="indexterm" id="idm46365028039792"/><a data-primary="await keyword" data-type="indexterm" id="idm46365028039184"/><a data-primary="asynchronous code" data-type="indexterm" id="idm46365028038544"/>because the types that represent an asynchronous operation are “task-like” and often modeled as <code>Task</code> objects. While this can add overhead in situations where your app is not truly performing async work, it does allow apps to be more responsive. A responsive app is defined by the characteristics of having the ability to respond to many concurrent users at the same time; async (suspended execution, synchronization, and continuation) programming makes this possible. From a consumer perspective, a responsive app is defined by its exemplary characteristic of having nonblocking calls. Using this pattern, the server can handle more concurrent users, but from the user’s perspective it’s about their experience, and they’re not blocked while the system is processing.</p>
</div></aside>

<p>The first <code>IJokeService</code> implementation is the <code>ProgrammingJokeService</code>:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code> <code class="nn">Learning.Blazor.JokeServices</code><code class="p">;</code>

<code class="k">internal</code> <code class="k">class</code> <code class="nc">ProgrammingJokeService</code> <code class="p">:</code> <code class="n">IJokeService</code> <a class="co" href="#callout___componentizing_CO10-1" id="co___componentizing_CO10-1"><img alt="1" src="assets/1.png"/></a>
<code class="p">{</code>
    <code class="k">private</code> <code class="k">readonly</code> <code class="n">HttpClient</code> <code class="n">_httpClient</code><code class="p">;</code>
    <code class="k">private</code> <code class="k">readonly</code> <code class="n">ILogger</code><code class="p">&lt;</code><code class="n">ProgrammingJokeService</code><code class="p">&gt;</code> <code class="n">_logger</code><code class="p">;</code>

    <code class="k">public</code> <code class="nf">ProgrammingJokeService</code><code class="p">(</code> <a class="co" href="#callout___componentizing_CO10-2" id="co___componentizing_CO10-2"><img alt="2" src="assets/2.png"/></a>
        <code class="n">HttpClient</code> <code class="n">httpClient</code><code class="p">,</code>
        <code class="n">ILogger</code><code class="p">&lt;</code><code class="n">ProgrammingJokeService</code><code class="p">&gt;</code> <code class="n">logger</code><code class="p">)</code> <code class="p">=</code><code class="p">&gt;</code>
        <code class="p">(</code><code class="n">_httpClient</code><code class="p">,</code> <code class="n">_logger</code><code class="p">)</code> <code class="p">=</code> <code class="p">(</code><code class="n">httpClient</code><code class="p">,</code> <code class="n">logger</code><code class="p">)</code><code class="p">;</code>

    <code class="n">JokeSourceDetails</code> <code class="n">IJokeService</code><code class="p">.</code><code class="n">SourceDetails</code> <code class="p">=</code><code class="p">&gt;</code> <a class="co" href="#callout___componentizing_CO10-3" id="co___componentizing_CO10-3"><img alt="3" src="assets/3.png"/></a>
        <code class="k">new</code><code class="p">(</code><code class="n">JokeSource</code><code class="p">.</code><code class="n">RandomProgrammingJokeApi</code><code class="p">,</code>
            <code class="k">new</code> <code class="nf">Uri</code><code class="p">(</code><code class="s">"https://karljoke.herokuapp.com/"</code><code class="p">)</code><code class="p">)</code><code class="p">;</code>

    <code class="k">async</code> <code class="n">Task</code><code class="p">&lt;</code><code class="kt">string?</code><code class="p">&gt;</code> <code class="n">IJokeService</code><code class="p">.</code><code class="n">GetJokeAsync</code><code class="p">(</code><code class="p">)</code> <a class="co" href="#callout___componentizing_CO10-4" id="co___componentizing_CO10-4"><img alt="4" src="assets/4.png"/></a>
    <code class="p">{</code>
        <code class="k">try</code>
        <code class="p">{</code>
            <code class="c1">// An array with a single joke is returned
</code>            <code class="kt">var</code> <code class="n">jokes</code> <code class="p">=</code> <code class="k">await</code> <code class="n">_httpClient</code><code class="p">.</code><code class="n">GetFromJsonAsync</code><code class="p">&lt;</code><code class="n">ProgrammingJoke</code><code class="p">[</code><code class="p">]</code><code class="p">&gt;</code><code class="p">(</code>
                <code class="s">"https://karljoke.herokuapp.com/jokes/programming/random"</code><code class="p">,</code>
                <code class="n">DefaultJsonSerialization</code><code class="p">.</code><code class="n">Options</code><code class="p">)</code><code class="p">;</code>

            <code class="k">return</code> <code class="n">jokes</code><code class="p">?</code><code class="p">[</code><code class="m">0</code><code class="p">]</code><code class="p">.</code><code class="n">Text</code><code class="p">;</code>
        <code class="p">}</code>
        <code class="k">catch</code> <code class="p">(</code><code class="n">Exception</code> <code class="n">ex</code><code class="p">)</code>
        <code class="p">{</code>
            <code class="n">_logger</code><code class="p">.</code><code class="n">LogError</code><code class="p">(</code><code class="s">"Error getting something fun to say: {Error}"</code><code class="p">,</code> <code class="n">ex</code><code class="p">)</code><code class="p">;</code>
        <code class="p">}</code>

        <code class="k">return</code> <code class="k">null</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co___componentizing_CO10-1" id="callout___componentizing_CO10-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>ProgrammingJokeService</code> class implements the <code>IJokeService</code> interface.</p></dd>
<dt><a class="co" href="#co___componentizing_CO10-2" id="callout___componentizing_CO10-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>HttpClient</code> and <code>ILogger&lt;T&gt;</code> instances are injected into the constructor.</p></dd>
<dt><a class="co" href="#co___componentizing_CO10-3" id="callout___componentizing_CO10-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>SourceDetails</code> property provides information about the source of the joke.</p></dd>
<dt><a class="co" href="#co___componentizing_CO10-4" id="callout___componentizing_CO10-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The <code>GetJokeAsync</code> method returns a <code>Task&lt;string?&gt;</code> that resolves to a joke or <code>null</code> if no joke could be retrieved.</p></dd>
</dl>

<p>This service starts <a data-primary="namespaces" data-secondary="declaration" data-type="indexterm" id="idm46365027850496"/>with its namespace declaration followed by an <code>internal class</code> implementation of <code>IJokeService</code>.</p>

<p>The class requires two parameters, an <code>HttpClient</code> and an <code>ILogger&lt;ProgrammingJokeService&gt;</code> logger instance. These two parameters are assigned using a tuple literal and its immediate deconstruction into the field assignments. This allows for a single line and an expression-bodied constructor. This is just a boilerplate DI approach. The fields are safely typed as <code>private readonly</code> so that consumers in the <code>class</code> will not be permitted to mistakenly assign over their values. That is the responsibility of the DI container.</p>

<p>The programming joke service declaratively expresses its representation of the 
<span class="keep-together"><code>SourceDetails</code></span> member through an implicit target-type <code>new</code> expression. We instantiate an instance of <code>JokeSourceDetails</code> given the <code>enum</code> value of the underlying API type <code>JokeSource.RandomProgrammingJokeApi</code> and the joke URL in a .NET <code>Uri</code> object.</p>

<p>The actual implementation of <code>GetJokeAsync</code> starts by opening with a <code>try</code> and <code>catch</code> block. <code>_httpClient</code> is used to make an HTTP GET request from the given <code>reques⁠t​Uri</code> and default JSON serialization options. In the event of an error, <code>Exception</code> details are logged and <code>null</code> is returned. When there is no error, in other words, “the happy path,” the response from the request is deserialized into a <code>ProgrammingJoke</code> array object. When there are jokes, the first joke’s text is returned. If this is <code>null</code>, that is fine too since we’ll let the consumers handle that. We’ll need to indicate it to them—again, it’s a <code>string?</code>. I call <a data-primary="nullable types" data-type="indexterm" id="idm46365027778240"/><a data-primary="types, nullable" data-type="indexterm" id="idm46365027777504"/>nullable types “questionable.” For example, given a <code>string?</code>, you should be asking yourself if this is <code>null</code> and should guard for that appropriately. I’ll often <a data-primary="questionable string" data-type="indexterm" id="idm46365027775904"/>refer to this type of pattern as a <em>questionable string</em>.</p>

<p>The other two service implementations follow the same pattern, and it becomes clear that we’ll need a way to aggregate these as they represent multiple implementations of the same interface. When .NET encounters multiple services registered for the same type, they are wrapped in <code>IEnumerable&lt;TService&gt;</code> where <code>TService</code> is one of the given implementations.</p>

<p>Let’s continue by looking at the other two <code>IJokeService</code> implementations. Consider the <a data-primary="DadJokeService" data-type="indexterm" id="idm46365027772672"/>following <code>DadJokeService</code> implementation:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code> <code class="nn">Learning.Blazor.JokeServices</code><code class="p">;</code>

<code class="k">internal</code> <code class="k">class</code> <code class="nc">DadJokeService</code> <code class="p">:</code> <code class="n">IJokeService</code>
<code class="p">{</code>
    <code class="k">private</code> <code class="k">readonly</code> <code class="n">HttpClient</code> <code class="n">_httpClient</code><code class="p">;</code>
    <code class="k">private</code> <code class="k">readonly</code> <code class="n">ILogger</code><code class="p">&lt;</code><code class="n">DadJokeService</code><code class="p">&gt;</code> <code class="n">_logger</code><code class="p">;</code>

    <code class="k">public</code> <code class="nf">DadJokeService</code><code class="p">(</code>
        <code class="n">IHttpClient</code> <code class="n">httpClient</code><code class="p">,</code>
        <code class="n">ILogger</code><code class="p">&lt;</code><code class="n">DadJokeService</code><code class="p">&gt;</code> <code class="n">logger</code><code class="p">)</code> <code class="p">=&gt;</code>
        <code class="p">(</code><code class="n">_httpClient</code><code class="p">,</code> <code class="n">_logger</code><code class="p">)</code> <code class="p">=</code> <code class="p">(</code><code class="n">httpClient</code><code class="p">,</code> <code class="n">logger</code><code class="p">);</code>

    <code class="n">JokeSourceDetails</code> <code class="n">IJokeService</code><code class="p">.</code><code class="n">SourceDetails</code> <code class="p">=&gt;</code>
        <code class="k">new</code><code class="p">(</code><code class="n">JokeSource</code><code class="p">.</code><code class="n">ICanHazDadJoke</code><code class="p">,</code>
            <code class="k">new</code> <code class="nf">Uri</code><code class="p">(</code><code class="s">"https://icanhazdadjoke.com/"</code><code class="p">));</code>

    <code class="k">async</code> <code class="n">Task</code><code class="p">&lt;</code><code class="kt">string?</code><code class="p">&gt;</code> <code class="n">IJokeService</code><code class="p">.</code><code class="n">GetJokeAsync</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="k">try</code>
        <code class="p">{</code>
            <code class="k">return</code> <code class="k">await</code> <code class="n">_httpClient</code><code class="p">.</code><code class="n">GetStringAsync</code><code class="p">(</code>
                <code class="s">"https://icanhazdadjoke.com/"</code><code class="p">);</code>
        <code class="p">}</code>
        <code class="k">catch</code> <code class="p">(</code><code class="n">Exception</code> <code class="n">ex</code><code class="p">)</code>
        <code class="p">{</code>
            <code class="n">_logger</code><code class="p">.</code><code class="n">LogError</code><code class="p">(</code>
                <code class="s">"Error getting something fun to say: {Error}"</code><code class="p">,</code> <code class="n">ex</code><code class="p">);</code>
        <code class="p">}</code>

        <code class="k">return</code> <code class="k">null</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>And the <code>ChuckNorrisJokeService</code> <a data-primary="ChuckNorrisJokeService" data-type="indexterm" id="idm46365027725472"/>implementation:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code> <code class="nn">Learning.Blazor.JokeServices</code><code class="p">;</code>

<code class="k">internal</code> <code class="k">class</code> <code class="nc">ChuckNorrisJokeService</code> <code class="p">:</code> <code class="n">IJokeService</code>
<code class="p">{</code>
    <code class="k">private</code> <code class="k">readonly</code> <code class="n">ILogger</code><code class="p">&lt;</code><code class="n">ChuckNorrisJokeService</code><code class="p">&gt;</code> <code class="n">_logger</code><code class="p">;</code>
    <code class="k">private</code> <code class="k">static</code> <code class="k">readonly</code> <code class="n">AsyncLazy</code><code class="p">&lt;</code><code class="n">ChuckNorrisJoke</code><code class="p">[]?&gt;</code> <code class="n">s_embeddedJokes</code> <code class="p">=</code>
        <code class="k">new</code><code class="p">(</code><code class="k">async</code> <code class="p">()</code> <code class="p">=&gt;</code>
        <code class="p">{</code>
            <code class="kt">var</code> <code class="n">@namespace</code> <code class="p">=</code> <code class="k">typeof</code><code class="p">(</code><code class="n">ChuckNorrisJokeService</code><code class="p">).</code><code class="n">Namespace</code><code class="p">;</code>
            <code class="kt">var</code> <code class="n">resource</code> <code class="p">=</code> <code class="err">$</code><code class="s">"{@namespace}.Data.icndb-nerdy-jokes.json"</code><code class="p">;</code>

            <code class="kt">var</code> <code class="n">json</code> <code class="p">=</code> <code class="k">await</code> <code class="n">ReadResourceFileAsync</code><code class="p">(</code><code class="n">resource</code><code class="p">);</code>
            <code class="kt">var</code> <code class="n">jokes</code> <code class="p">=</code> <code class="n">json</code><code class="p">.</code><code class="n">FromJson</code><code class="p">&lt;</code><code class="n">ChuckNorrisJoke</code><code class="p">[]&gt;();</code>

            <code class="k">return</code> <code class="n">jokes</code><code class="p">;</code>
        <code class="p">});</code>

    <code class="k">public</code> <code class="nf">ChuckNorrisJokeService</code><code class="p">(</code>
        <code class="n">ILogger</code><code class="p">&lt;</code><code class="n">ChuckNorrisJokeService</code><code class="p">&gt;</code> <code class="n">logger</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="n">_logger</code> <code class="p">=</code> <code class="n">logger</code><code class="p">;</code>

    <code class="n">JokeSourceDetails</code> <code class="n">IJokeService</code><code class="p">.</code><code class="n">SourceDetails</code> <code class="p">=&gt;</code>
        <code class="k">new</code><code class="p">(</code><code class="n">JokeSource</code><code class="p">.</code><code class="n">InternetChuckNorrisDatabase</code><code class="p">,</code>
            <code class="k">new</code> <code class="nf">Uri</code><code class="p">(</code><code class="s">"https://www.icndb.com/"</code><code class="p">));</code>

    <code class="k">async</code> <code class="n">Task</code><code class="p">&lt;</code><code class="kt">string?</code><code class="p">&gt;</code> <code class="n">IJokeService</code><code class="p">.</code><code class="n">GetJokeAsync</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="k">try</code>
        <code class="p">{</code>
            <code class="kt">var</code> <code class="n">jokes</code> <code class="p">=</code> <code class="k">await</code> <code class="n">s_embeddedJokes</code><code class="p">;</code>
            <code class="k">if</code> <code class="p">(</code><code class="n">jokes</code> <code class="k">is</code> <code class="p">{</code> <code class="n">Length</code><code class="p">:</code> <code class="p">&gt;</code> <code class="m">0</code> <code class="p">})</code>
            <code class="p">{</code>
                <code class="kt">var</code> <code class="n">randomIndex</code> <code class="p">=</code> <code class="n">Random</code><code class="p">.</code><code class="n">Shared</code><code class="p">.</code><code class="n">Next</code><code class="p">(</code><code class="n">jokes</code><code class="p">.</code><code class="n">Length</code><code class="p">);</code>
                <code class="kt">var</code> <code class="n">random</code> <code class="p">=</code> <code class="n">jokes</code><code class="p">[</code><code class="n">randomIndex</code><code class="p">];</code>

                <code class="k">return</code> <code class="n">random</code><code class="p">.</code><code class="n">Joke</code><code class="p">;</code>
            <code class="p">}</code>

            <code class="k">return</code> <code class="k">null</code><code class="p">;</code>
        <code class="p">}</code>
        <code class="k">catch</code> <code class="p">(</code><code class="n">Exception</code> <code class="n">ex</code><code class="p">)</code>
        <code class="p">{</code>
            <code class="n">_logger</code><code class="p">.</code><code class="n">LogError</code><code class="p">(</code>
                <code class="s">"Error getting something fun to say: {Error}"</code><code class="p">,</code> <code class="n">ex</code><code class="p">);</code>
        <code class="p">}</code>

        <code class="k">return</code> <code class="k">null</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">private</code> <code class="k">static</code> <code class="k">async</code> <code class="n">Task</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="n">ReadResourceFileAsync</code><code class="p">(</code><code class="kt">string</code> <code class="n">fileName</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">using</code> <code class="nn">var</code> <code class="n">stream</code> <code class="p">=</code>
            <code class="n">Assembly</code><code class="p">.</code><code class="n">GetExecutingAssembly</code><code class="p">()</code>
                <code class="p">.</code><code class="n">GetManifestResourceStream</code><code class="p">(</code><code class="n">fileName</code><code class="p">);</code>
        <code class="k">using</code> <code class="nn">var</code> <code class="n">reader</code> <code class="p">=</code> <code class="k">new</code> <code class="n">StreamReader</code><code class="p">(</code><code class="n">stream</code><code class="p">!);</code>
        <code class="k">return</code> <code class="k">await</code> <code class="n">reader</code><code class="p">.</code><code class="n">ReadToEndAsync</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>To handle the multiple <code>IJokeService</code> implementations, we’ll create a factory that will aggregate jokes—returning the first successful random implementation’s joke:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code> <code class="nn">Learning.Blazor.JokeServices</code><code class="p">;</code>

<code class="k">public</code> <code class="k">interface</code> <code class="n">IJokeFactory</code>
<code class="p">{</code>
    <code class="n">Task</code><code class="p">&lt;(</code><code class="kt">string</code><code class="p">,</code> <code class="n">JokeSourceDetails</code><code class="p">)&gt;</code> <code class="n">GetRandomJokeAsync</code><code class="p">();</code>
<code class="p">}</code></pre>

<p>This interface defines a single task-based async method that by its name indicates it gets a random joke. The return type is a <code>Task&lt;(string, JokeSourceDetails)&gt;</code>, where the generic type constraint on <code>Task</code> is a tuple of <code>string</code> and <code>JokeSource​De⁠tails</code>. <code>JokeSourceDetails</code> is shaped as follows:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">using</code> <code class="nn">System</code><code class="p">;</code>

<code class="k">namespace</code> <code class="nn">Learning.Blazor.Models</code><code class="p">;</code>

<code class="k">public</code> <code class="n">record</code> <code class="nf">JokeSourceDetails</code><code class="p">(</code>
    <code class="n">JokeSource</code> <code class="n">Source</code><code class="p">,</code>
    <code class="n">Uri</code> <code class="n">Site</code><code class="p">);</code></pre>

<p>In C#, positional records are an amazing type. First of all, they’re immutable. Instances can be cloned using the <code>with</code> syntax, where property values are overridden into the copied object. You also get automatic equality and value-based comparison semantics. They’re declarative and succinct to write. Let’s take a look at the joke factory next:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code> <code class="nn">Learning.Blazor.JokeServices</code><code class="p">;</code>

<code class="k">internal</code> <code class="k">class</code> <code class="nc">AggregateJokeFactory</code> <code class="p">:</code> <code class="n">IJokeFactory</code>
<code class="p">{</code>
    <code class="k">const</code> <code class="kt">string</code> <code class="n">NotFunny</code> <code class="p">=</code> <code class="s">@"Did you hear the one about a joke service that "</code> <code class="p">+</code>
        <code class="s">@"failed to get jokes?"</code> <code class="p">+</code>
        <code class="s">"It's not very funny..."</code><code class="p">;</code>

    <code class="k">private</code> <code class="k">readonly</code> <code class="n">IList</code><code class="p">&lt;</code><code class="n">IJokeService</code><code class="p">&gt;</code> <code class="n">_jokeServices</code><code class="p">;</code>

    <code class="k">public</code> <code class="nf">AggregateJokeFactory</code><code class="p">(</code> <a class="co" href="#callout___componentizing_CO11-1" id="co___componentizing_CO11-1"><img alt="1" src="assets/1.png"/></a>
        <code class="n">IEnumerable</code><code class="p">&lt;</code><code class="n">IJokeService</code><code class="p">&gt;</code> <code class="n">jokeServices</code><code class="p">)</code> <code class="p">=</code><code class="p">&gt;</code>
        <code class="n">_jokeServices</code> <code class="p">=</code> <code class="n">jokeServices</code><code class="p">;</code>

    <code class="k">async</code> <code class="n">Task</code><code class="p">&lt;</code><code class="p">(</code><code class="kt">string</code><code class="p">,</code> <code class="n">JokeSourceDetails</code><code class="p">)</code><code class="p">&gt;</code> <code class="n">IJokeFactory</code><code class="p">.</code><code class="n">GetRandomJokeAsync</code><code class="p">(</code><code class="p">)</code> <a class="co" href="#callout___componentizing_CO11-2" id="co___componentizing_CO11-2"><img alt="2" src="assets/2.png"/></a>
    <code class="p">{</code>
        <code class="kt">string?</code> <code class="n">joke</code> <code class="p">=</code> <code class="k">null</code><code class="p">;</code>
        <code class="n">JokeSourceDetails</code> <code class="n">sourceDetails</code> <code class="p">=</code> <code class="k">default</code><code class="p">;</code>

        <code class="k">foreach</code> <code class="p">(</code><code class="kt">var</code> <code class="n">service</code> <code class="k">in</code> <code class="n">_jokeServices</code><code class="p">.</code><code class="n">RandomOrder</code><code class="p">(</code><code class="p">)</code><code class="p">)</code>
        <code class="p">{</code>
            <code class="n">joke</code> <code class="p">=</code> <code class="k">await</code> <code class="n">service</code><code class="p">.</code><code class="n">GetJokeAsync</code><code class="p">(</code><code class="p">)</code><code class="p">;</code>
            <code class="n">sourceDetails</code> <code class="p">=</code> <code class="n">service</code><code class="p">.</code><code class="n">SourceDetails</code><code class="p">;</code>

            <code class="k">if</code> <code class="p">(</code><code class="n">joke</code> <code class="k">is</code> <code class="n">not</code> <code class="k">null</code> <code class="p">&amp;</code><code class="p">&amp;</code> <code class="n">sourceDetails</code> <code class="p">!</code><code class="p">=</code> <code class="k">default</code><code class="p">)</code>
            <code class="p">{</code>
                <code class="k">break</code><code class="p">;</code>
            <code class="p">}</code>
        <code class="p">}</code>

        <code class="k">return</code> <code class="p">(</code>
            <code class="n">joke</code> <code class="p">?</code><code class="p">?</code> <code class="n">NotFunny</code><code class="p">,</code>
            <code class="n">sourceDetails</code><code class="p">)</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co___componentizing_CO11-1" id="callout___componentizing_CO11-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The constructor accepts a collection of <code>IJokeService</code> implementations.</p></dd>
<dt><a class="co" href="#co___componentizing_CO11-2" id="callout___componentizing_CO11-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The method body of <code>GetRandomJokeAsync</code> uses the <code>RandomOrder</code> function.</p></dd>
</dl>

<p>The <code>IJokeFactory</code> implementation is named appropriately as <code>AggregateJoke​Fac⁠tory</code> with its constructor (<code>.ctor</code>) accepting <code>IEnumerable&lt;IJokeService&gt;</code>. These are the joke services: <em>dad joke service</em>, <em>random programming joke API service</em>, and <em>internet Chuck Norris database service</em>. These values were provided by the .NET DI container.</p>

<p>The method body of <code>GetRandomJokeAsync</code> is leveraging an <a data-primary="RandomOrder extension method" data-type="indexterm" id="idm46365027029760"/><a data-primary="methods" data-secondary="RandomOrder extension method" data-type="indexterm" id="idm46365027029056"/>extension method named <code>RandomOrder</code> on the <code>IEnumerable&lt;T&gt;</code> type. This pattern relies on a fallback pattern in which services are attempted until one is capable of providing a joke. If no implementation is capable of providing a joke, the method default values, in this case, return <code>null</code>. The extension method for random is <a data-primary="EnumerableExtensions.cs" data-type="indexterm" id="enext"/>defined in the <em>Enumerable​Exten⁠sions.cs</em> C# file in the <code>Learning.Blazor.Extensions</code> namespace:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code> <code class="nn">Learning.Blazor.Extensions</code><code class="p">;</code>

<code class="k">public</code> <code class="k">static</code> <code class="k">class</code> <code class="nc">EnumerableExtensions</code>
<code class="p">{</code>
    <code class="k">static</code> <code class="k">readonly</code> <code class="n">Random</code> <code class="n">s_random</code> <code class="p">=</code> <code class="n">Random</code><code class="p">.</code><code class="n">Shared</code><code class="p">;</code> <a class="co" href="#callout___componentizing_CO12-1" id="co___componentizing_CO12-1"><img alt="1" src="assets/1.png"/></a>

    <code class="k">public</code> <code class="k">static</code> <code class="n">IEnumerable</code><code class="p">&lt;</code><code class="n">T</code><code class="p">&gt;</code> <code class="n">RandomOrder</code><code class="p">&lt;</code><code class="n">T</code><code class="p">&gt;</code><code class="p">(</code><code class="k">this</code> <code class="n">IList</code><code class="p">&lt;</code><code class="n">T</code><code class="p">&gt;</code> <code class="n">incoming</code><code class="p">)</code> <a class="co" href="#callout___componentizing_CO12-2" id="co___componentizing_CO12-2"><img alt="2" src="assets/2.png"/></a>
    <code class="p">{</code>
        <code class="kt">var</code> <code class="n">used</code> <code class="p">=</code> <code class="k">new</code> <code class="n">HashSet</code><code class="p">&lt;</code><code class="kt">int</code><code class="p">&gt;</code><code class="p">(</code><code class="p">)</code><code class="p">;</code>
        <code class="kt">var</code> <code class="n">count</code> <code class="p">=</code> <code class="n">incoming</code><code class="p">.</code><code class="n">Count</code><code class="p">;</code>

        <code class="k">while</code> <code class="p">(</code><code class="n">used</code><code class="p">.</code><code class="n">Count</code> <code class="p">!</code><code class="p">=</code> <code class="n">count</code><code class="p">)</code>
        <code class="p">{</code>
            <code class="kt">var</code> <code class="n">index</code> <code class="p">=</code> <code class="n">s_random</code><code class="p">.</code><code class="n">Next</code><code class="p">(</code><code class="n">incoming</code><code class="p">.</code><code class="n">Count</code><code class="p">)</code><code class="p">;</code>
            <code class="k">if</code> <code class="p">(</code><code class="p">!</code><code class="n">used</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code><code class="n">index</code><code class="p">)</code><code class="p">)</code>
            <code class="p">{</code>
                <code class="k">continue</code><code class="p">;</code>
            <code class="p">}</code>

            <code class="k">yield</code> <code class="k">return</code> <code class="n">incoming</code><code class="p">[</code><code class="n">index</code><code class="p">]</code><code class="p">;</code>
        <code class="p">}</code>

        <code class="k">yield</code> <code class="k">break</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>
<dl class="calloutlist pagebreak-before less_space">
<dt><a class="co" href="#co___componentizing_CO12-1" id="callout___componentizing_CO12-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The framework-provided <code>Random</code> type.</p></dd>
<dt><a class="co" href="#co___componentizing_CO12-2" id="callout___componentizing_CO12-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The algorithm for randomizing the order is O(1) time, meaning its computation time is constant regardless of the size of the collection.</p></dd>
</dl>

<p>The framework-provided <a href="https://oreil.ly/sYped"><code>Random.Shared</code> instance</a> <a data-primary="Random.Shared instance" data-type="indexterm" id="idm46365026840048"/>represents a pseudorandom number generator, which is an algorithm that produces a sequence of numbers that meet basic statistical requirements for randomness.</p>

<p>The random element function works on the <code>incoming</code> collection instance. From the <code>AggregateJokeFactory</code> instance we pseudorandomly determined, we’ll await its invocation of the <code>GetJokeAsync</code> method. If the joke returned is <code>null</code>, we’ll coalesce to <code>"There is nothing funny about this."</code> We then return a tuple <a data-primary="EnumerableExtensions.cs" data-startref="enext" data-type="indexterm" id="idm46365026836336"/>with the <code>string</code> joke and the corresponding service’s source details.</p>
</div></section>













<section data-pdf-bookmark="DI from Library Authors" data-type="sect2"><div class="sect2" id="dependency-injection-for-authors">
<h2>DI from Library Authors</h2>

<p>The last part of the joke services library involves the fact that all of our joke services are DI-friendly, and we can add <a data-primary="IServiceCollection extension method" data-type="indexterm" id="idm46365026782960"/><a data-primary="methods" data-secondary="IServiceCollection extension method" data-type="indexterm" id="idm46365026782352"/>an extension method on <code>IServiceCollection</code> that registers them with the DI container. This is a common tactic that I’ll follow for all libraries that are intended for consumption. Consumers will call <code>AddJokeServices</code> to register all abstractions with DI. They can start requiring these services for <code>.ctor</code> injection in classes or with Blazor components through the property injection. The <code>InjectAttribute</code> and the <code>@inject</code> directive allow for <a data-primary="InjectAttribute" data-type="indexterm" id="idm46365026779456"/><a data-primary="@inject directive" data-primary-sortas="inject directive" data-type="indexterm" id="idm46365026778848"/><a data-primary="directives" data-secondary="@inject" data-type="indexterm" id="idm46365026778000"/>services to be injected into components through their C# properties.</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code> <code class="nn">Learning.Blazor.Extensions</code><code class="p">;</code> <a class="co" href="#callout___componentizing_CO13-1" id="co___componentizing_CO13-1"><img alt="1" src="assets/1.png"/></a>

<code class="k">public</code> <code class="k">static</code> <code class="k">class</code> <code class="nc">ServiceCollectionExtensions</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">static</code> <code class="n">IServiceCollection</code> <code class="nf">AddJokeServices</code><code class="p">(</code>
        <code class="k">this</code> <code class="n">IServiceCollection</code> <code class="n">services</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">ArgumentNullException</code><code class="p">.</code><code class="n">ThrowIfNull</code><code class="p">(</code><code class="n">nameof</code><code class="p">(</code><code class="n">services</code><code class="p">)</code><code class="p">)</code><code class="p">;</code>

        <code class="n">services</code><code class="p">.</code><code class="n">AddScoped</code><code class="p">&lt;</code><code class="n">IJokeService</code><code class="p">,</code> <code class="n">ProgrammingJokeService</code><code class="p">&gt;</code><code class="p">(</code><code class="p">)</code><code class="p">;</code> <a class="co" href="#callout___componentizing_CO13-2" id="co___componentizing_CO13-2"><img alt="2" src="assets/2.png"/></a>
        <code class="n">services</code><code class="p">.</code><code class="n">AddScoped</code><code class="p">&lt;</code><code class="n">IJokeService</code><code class="p">,</code> <code class="n">DadJokeService</code><code class="p">&gt;</code><code class="p">(</code><code class="p">)</code><code class="p">;</code>
        <code class="n">services</code><code class="p">.</code><code class="n">AddScoped</code><code class="p">&lt;</code><code class="n">IJokeService</code><code class="p">,</code> <code class="n">ChuckNorrisJokeService</code><code class="p">&gt;</code><code class="p">(</code><code class="p">)</code><code class="p">;</code>

        <code class="n">services</code><code class="p">.</code><code class="n">AddHttpClient</code><code class="p">&lt;</code><code class="n">ProgrammingJokeService</code><code class="p">&gt;</code><code class="p">(</code><code class="p">)</code> <a class="co" href="#callout___componentizing_CO13-3" id="co___componentizing_CO13-3"><img alt="3" src="assets/3.png"/></a>
            <code class="p">.</code><code class="n">AddDefaultTransientHttpErrorPolicy</code><code class="p">(</code><code class="p">)</code><code class="p">;</code>
        <code class="n">services</code><code class="p">.</code><code class="n">AddHttpClient</code><code class="p">&lt;</code><code class="n">DadJokeService</code><code class="p">&gt;</code><code class="p">(</code><code class="p">)</code>
            <code class="p">.</code><code class="n">AddDefaultTransientHttpErrorPolicy</code><code class="p">(</code><code class="p">)</code><code class="p">;</code>

        <code class="n">services</code><code class="p">.</code><code class="n">AddScoped</code><code class="p">&lt;</code><code class="n">IJokeFactory</code><code class="p">,</code> <code class="n">AggregateJokeFactory</code><code class="p">&gt;</code><code class="p">(</code><code class="p">)</code><code class="p">;</code> <a class="co" href="#callout___componentizing_CO13-4" id="co___componentizing_CO13-4"><img alt="4" src="assets/4.png"/></a>

        <code class="k">return</code> <code class="n">services</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co___componentizing_CO13-1" id="callout___componentizing_CO13-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The class is <code>using</code> the <code>Learning.Blazor.Http.Extensions</code> namespace.</p></dd>
<dt><a class="co" href="#co___componentizing_CO13-2" id="callout___componentizing_CO13-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>All three service implementations are added to the <code>services</code> collection.</p></dd>
<dt><a class="co" href="#co___componentizing_CO13-3" id="callout___componentizing_CO13-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Each implementation has its corresponding <code>HttpClient</code>.</p></dd>
<dt><a class="co" href="#co___componentizing_CO13-4" id="callout___componentizing_CO13-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>Collectively, each implementation is exposed through <code>AggregateJokeFactory</code>.</p></dd>
</dl>

<p>The <code>Learning.Blazor.Http.Extensions</code> namespace <a data-primary="namespaces" data-secondary="Learning.Blazor.Http.Extensions" data-type="indexterm" id="idm46365026590976"/><a data-primary="Learning.Blazor.Http.Extensions namespace" data-type="indexterm" id="idm46365026590128"/>represents a shared library, which contains default, transient fault-handling policies. A reasonable set of defaults is shared throughout all projects in the solution that use an <code>HttpClient</code>. These shared fault-handling policies impose an exponential backoff pattern that helps to automatically retry intermittent HTTP request failures. They generate sleep durations that exponentially backoff, in a jittered manner, making sure to mitigate any correlations. Examples include 850ms, 1455ms, and 3060ms. This is possible using the <code>Polly.Contrib.WaitAndRetry</code> library and its <code>Backoff.Decorrelated​Jit⁠terBack⁠offV2</code> 
<span class="keep-together">implementation.</span></p>

<p>Calling <code>AddJokesServices</code> registers all of the corresponding joke services into the DI container. Once registered in the DI container, consumers can require the <code>IJokeFactory</code> service and the implementation will be provided. All of this functionality is exposed to the Web.Client. The <code>JokeComponent</code> uses the <code>IJokeFactory.GetRandomJokeAsync</code> method. The client code will execute on the client browser, using each service to make HTTP calls to some external endpoints as needed.</p>

<p>We’ve covered <code>IntroductionComponent</code> and <code>JokeComponent</code>. In the next section, we’re going to look at a gradually more complex example. I’ll show you how to make a call to an Azure Function that is co-hosted with the Azure Static Web App. This Azure Function is implemented in the Web.Functions project.</p>
<div data-type="tip"><h6>Tip</h6>
<p>Azure Functions are a serverless <a data-primary="JokeComponent" data-startref="jclza" data-type="indexterm" id="idm46365026583424"/><a data-primary="Learning Blazor app" data-secondary="JokeComponent" data-startref="lgzjkp" data-type="indexterm" id="idm46365026582448"/>solution (similar to that of AWS Lambda). They are a great way to build scalable, reliable, and secure applications using Azure PaaS (platform as a service). For more information, see Microsoft’s <a href="https://oreil.ly/bJr70">“Introduction to Azure Functions” documentation</a>.</p>
</div>
</div></section>





</div></section>













<section data-pdf-bookmark="Forecasting Local Weather" data-type="sect1"><div class="sect1" id="idm46365028398512">
<h1>Forecasting Local Weather</h1>

<p>The custom components that we’ve covered thus <a data-primary="WeatherComponent" data-type="indexterm" id="wtcpt"/><a data-primary="WeatherCurrentComponent" data-type="indexterm" id="idm46365026576608"/><a data-primary="WeatherDailyComponent" data-type="indexterm" id="idm46365026575936"/>far started a bit more basic. 
<span class="keep-together"><code>IntroductionComponent</code></span> has a single localized text field that it renders. <code>Joke​Compo⁠nent</code> then demonstrated how to fetch data from an HTTP endpoint with conditional control structures and loading indicators. <code>WeatherComponent</code> is a parent component to <code>WeatherCurrentComponent</code> and <code>WeatherDailyComponent</code>. Collectively, these components display the users’ local current weather and immediate forecast for the week, as shown in <a data-type="xref" href="#weather-dark">Figure 3-4</a>.</p>

<figure><div class="figure" id="weather-dark">
<img alt="" src="assets/lblz_0304.png"/>
<h6><span class="label">Figure 3-4. </span>An example rendering of the <code>WeatherComponent</code></h6>
</div></figure>

<p>All of the weather data is available for free from the <a href="https://oreil.ly/lg5RK">Open Weather Map API</a>. <code>WeatherComponent</code> relies on an <code>HttpClient</code> instance to retrieve weather data. In this component, we’ll also cover how to use two-way JavaScript interop. Let’s <a data-primary="WeatherComponent.razor" data-type="indexterm" id="wtcpz"/>look at the <em>WeatherComponent.razor</em> markup:</p>

<pre data-code-language="html" data-type="programlisting"><code>@inherits LocalizableComponentBase</code><code class="p">&lt;</code><code class="nt">WeatherComponent</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">article</code> <code class="na">class</code><code class="o">=</code><code class="s">"blazor-tile-container"</code><code class="p">&gt;</code> <a class="co" href="#callout___componentizing_CO14-1" id="co___componentizing_CO14-1"><img alt="1" src="assets/1.png"/></a>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"gradient-bg weather-gradient"</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"icon-overlay zap-svg"</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"blaze-content"</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">p</code> <code class="na">class</code><code class="o">=</code><code class="s">"title"</code> <code class="na">translate</code><code class="o">=</code><code class="s">"no"</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">span</code> <code class="na">class</code><code class="o">=</code><code class="s">"is-emoji"</code><code class="p">&gt;</code><code class="ni">&amp;#x1F525;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">span</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">span</code> <code class="na">class</code><code class="o">=</code><code class="s">"has-text-light"</code><code class="p">&gt;</code><code> Blazor @Localizer["Weather"]</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">span</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="p">/</code><code class="nt">p</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">AdditiveSpeechComponent</code> <code class="na">Message</code><code class="o">=</code><code class="s">@_model?.Message</code> <code class="p">/</code><code class="p">&gt;</code> <a class="co" href="#callout___componentizing_CO14-2" id="co___componentizing_CO14-2"><img alt="2" src="assets/2.png"/></a>
        <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"columns has-text-centered"</code><code class="p">&gt;</code><code>
        @switch (_state) </code><a class="co" href="#callout___componentizing_CO14-3" id="co___componentizing_CO14-3"><img alt="3" src="assets/3.png"/></a><code>
        {
            case ComponentState.Loaded: </code><a class="co" href="#callout___componentizing_CO14-4" id="co___componentizing_CO14-4"><img alt="4" src="assets/4.png"/></a><code>

            var weather = _model!;
            </code><code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"column is-one-third"</code><code class="p">&gt;</code>
                <code class="p">&lt;</code><code class="nt">WeatherCurrentComponent</code> <code class="na">Weather</code><code class="o">=</code><code class="s">weather</code>
                    <code class="na">Localizer</code><code class="o">=</code><code class="s">Localizer</code> <code class="p">/</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"column"</code><code class="p">&gt;</code>
                <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"level"</code><code class="p">&gt;</code><code>
                @foreach (DailyWeather daily in weather.DailyWeather)
                {
                    </code><code class="p">&lt;</code><code class="nt">WeatherDailyComponent</code> <code class="na">Daily</code><code class="o">=</code><code class="s">"daily"</code>
                        <code class="na">GetDailyImagePath</code><code class="o">=</code><code class="s">weather.GetDailyImagePath</code>
                        <code class="na">GetDailyHigh</code><code class="o">=</code><code class="s">weather.GetDailyHigh</code>
                        <code class="na">GetDailyLow</code><code class="o">=</code><code class="s">weather.GetDailyLow</code> <code class="p">/</code><code class="p">&gt;</code><code>
                }
                </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code><code>

            break;
            case ComponentState.Loading:
            </code><code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"column is-full"</code><code class="p">&gt;</code> <a class="co" href="#callout___componentizing_CO14-5" id="co___componentizing_CO14-5"><img alt="5" src="assets/5.png"/></a>
                <code class="p">&lt;</code><code class="nt">SpinnerComponent</code> <code class="p">/</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code><code>

            break;
            default:
            </code><code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"column is-full"</code><code class="p">&gt;</code> <a class="co" href="#callout___componentizing_CO14-6" id="co___componentizing_CO14-6"><img alt="6" src="assets/6.png"/></a><code>
                @Localizer["WeatherUnavailable"]
            </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code><code>

            break;
        }
        </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="p">/</code><code class="nt">article</code><code class="p">&gt;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co___componentizing_CO14-1" id="callout___componentizing_CO14-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The outermost <code>article</code> element is styled as a tile.</p></dd>
<dt><a class="co" href="#co___componentizing_CO14-2" id="callout___componentizing_CO14-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The weather tile, like the other two tiles, also makes use of <code>AdditiveSpeech​Compo⁠nent</code>.</p></dd>
<dt><a class="co" href="#co___componentizing_CO14-3" id="callout___componentizing_CO14-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>In addition to simple <code>@if</code> control structures, you can also use <code>@switch</code> control structures.</p></dd>
<dt><a class="co" href="#co___componentizing_CO14-4" id="callout___componentizing_CO14-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>When loaded, the weather tile displays the current weather and the forecast for the week.</p></dd>
<dt><a class="co" href="#co___componentizing_CO14-5" id="callout___componentizing_CO14-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>When the component is loading, <code>SpinnerComponent</code> is shown.</p></dd>
<dt><a class="co" href="#co___componentizing_CO14-6" id="callout___componentizing_CO14-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>The <code>default</code> case renders a localized message that tells the user that weather is unavailable.</p></dd>
</dl>

<p>This component’s markup is similar to the other two tiles, <code>IntroductionComponent</code> and <code>JokeComponent</code>. <code>WeatherComponent</code> is a parent component of two other components: <code>WeatherCurrentComponent</code> and <code>WeatherDailyComponent</code>. Its title is “Blazor Weather,” and the word <em>weather</em> is localized.</p>

<p>The weather tile, like the other two tiles, also makes use of <code>AdditiveSpeech​Compo⁠nent</code>. When rendered, a speech button is visible in the top-righthand corner of its parent element. <code>AdditiveSpeechComponent</code> is covered in detail in <a data-type="xref" href="ch04.html#native-speech-synthesis">“Native Speech Synthesis”</a>.</p>

<p>The <code>@switch</code> control structure is <a data-primary="@switch control structure" data-primary-sortas="switch control structure" data-type="indexterm" id="idm46365026278800"/>rather nice in markup. The weather component uses a custom component <code>_state</code> variable to help track the state of the component. The possible states are unknown, loading, loaded, or error.</p>

<p>When the component is loaded, the current weather (<code>WeatherCurrentComponent</code>) and daily weather forecast (<code>WeatherDailyComponent</code>) are rendered. The parent component relies on a nullable <code>_model</code> type; the <code>_model</code> is not <code>null</code> when in a loaded state, and we can tell the compiler that we’re certain of that by using the null-forgiving operator <code>!</code>. The class-scoped <code>_model</code> variable is assigned to a local-scoped <code>weather</code> variable. This variable is assigned to its child components’ <code>WeatherCurrentComponent</code> and <code>WeatherDailyComponent</code> through either helper method delegation or parameter assignment.</p>

<p>When the component is <a data-primary="SpinnerComponent" data-type="indexterm" id="idm46365026271888"/>loading, <code>SpinnerComponent</code> is shown. The <code>default</code> case renders a localized message that tells the user that the weather is unavailable. This should happen <a data-primary="WeatherComponent.razor" data-startref="wtcpz" data-type="indexterm" id="idm46365026270032"/>only in the event of an error.</p>

<p>The weather component markup references the current weather (<code>WeatherCurrent​Com⁠ponent</code>) and daily weather forecast (<code>WeatherDailyComponent</code>) components. These two components do not make use of component shadowing and are purely for templates. Each component defines an <code>@code { ... }</code> directive with several <code>Parameter</code> properties. They do not require logic or functionality; as such, they’re just markup <a data-primary="WeatherCurrentComponent.razor" data-type="indexterm" id="wcrrp"/>bound to given values. This is the <em>WeatherCurrentComponent.razor</em> markup file:</p>

<pre data-code-language="html" data-type="programlisting">@using Learning.Blazor.Localization;

<code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"box dotnet-box-border is-alpha-bg-50"</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">article</code> <code class="na">class</code><code class="o">=</code><code class="s">"media"</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"media-left"</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">figure</code> <code class="na">class</code><code class="o">=</code><code class="s">"image is-128x128"</code><code class="p">&gt;</code>
                <code class="p">&lt;</code><code class="nt">img</code> <code class="na">src</code><code class="o">=</code><code class="s">@(Weather.ImagePath)</code>
                    <code class="na">class</code><code class="o">=</code><code class="s">"has-img-shadow"</code>
                    <code class="na">alt</code><code class="o">=</code><code class="s">"@Localizer["</code><code class="na">CurrentWeatherVisual</code><code class="err">"]"</code><code class="p">&gt;</code>
            <code class="p">&lt;/</code><code class="nt">figure</code><code class="p">&gt;</code>
        <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"media-content"</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"content has-text-right has-text-light"</code><code class="p">&gt;</code>
                <code class="p">&lt;</code><code class="nt">div</code><code class="p">&gt;</code>
                    <code class="p">&lt;</code><code class="nt">span</code> <code class="na">class</code><code class="o">=</code><code class="s">"title has-text-light"</code><code class="p">&gt;</code>
                        @Weather.Temperature
                    <code class="p">&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
                    <code class="p">&lt;</code><code class="nt">span</code> <code class="na">class</code><code class="o">=</code><code class="s">"heading"</code><code class="p">&gt;</code>
                        <code class="p">&lt;</code><code class="nt">i</code> <code class="na">class</code><code class="o">=</code><code class="s">"fas fa-arrow-up"</code><code class="p">&gt;&lt;/</code><code class="nt">i</code><code class="p">&gt;</code>
                        @(Weather.HighTemp) |
                        <code class="p">&lt;</code><code class="nt">i</code> <code class="na">class</code><code class="o">=</code><code class="s">"fas fa-arrow-down"</code><code class="p">&gt;&lt;/</code><code class="nt">i</code><code class="p">&gt;</code>
                        @(Weather.LowTemp)
                    <code class="p">&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
                    <code class="p">&lt;</code><code class="nt">span</code> <code class="na">class</code><code class="o">=</code><code class="s">"heading"</code><code class="p">&gt;</code>
                        @Weather.Description
                    <code class="p">&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
                    <code class="p">&lt;</code><code class="nt">span</code> <code class="na">class</code><code class="o">=</code><code class="s">"heading"</code><code class="p">&gt;</code>
                        <code class="p">&lt;</code><code class="nt">i</code> <code class="na">class</code><code class="o">=</code><code class="s">"fas fa-wind"</code><code class="p">&gt;&lt;/</code><code class="nt">i</code><code class="p">&gt;</code>
                        @Weather.WindSpeed
                        <code class="p">&lt;</code><code class="nt">sup</code><code class="p">&gt;</code>
                        @(Localizer[Weather.WindDegree.PositionalCardinal])
                        <code class="p">&lt;/</code><code class="nt">sup</code><code class="p">&gt;</code>
                    <code class="p">&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
                <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
            <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
        <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">article</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"has-text-centered has-text-light"</code><code class="p">&gt;</code>
        @($"{Weather.City}, {Weather.State} ({Weather.Country})")
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>

@code {
    [Parameter]
    public WeatherComponentModel Weather
    {
        get;
        set;
    } = null!;

    [Parameter]
    public CoalescingStringLocalizer<code class="p">&lt;</code><code class="nt">WeatherComponent</code><code class="p">&gt;</code> Localizer
    {
        get;
        set;
    } = null!;
}</pre>

<p><code>WeatherCurrentComponent</code> renders the image <a data-primary="WeatherCurrentComponent.razor" data-startref="wcrrp" data-type="indexterm" id="idm46365026260176"/>that corresponds to the current weather, such as clouds, or rain clouds, or perhaps even an image of the sun to represent a beautiful day. It also displays the temperature, high and low temperatures, a description of the weather, the wind <a data-primary="WeatherDailyComponent.razor" data-type="indexterm" id="welp"/>speed and direction, as well as the city and state. For example, let’s look at the <em>WeatherDailyComponent.razor</em> markup file:</p>

<pre data-code-language="html" data-type="programlisting"><code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"level-item has-text-centered has-text-light"</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">p</code> <code class="na">class</code><code class="o">=</code><code class="s">"heading is-size-6 is-underlined"</code><code class="p">&gt;</code>
            @Daily.DateTime.ToString("ddd")
        <code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">p</code> <code class="na">class</code><code class="o">=</code><code class="s">"title"</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">figure</code> <code class="na">class</code><code class="o">=</code><code class="s">"image is-64x64"</code><code class="p">&gt;</code>
                <code class="p">&lt;</code><code class="nt">img</code> <code class="na">src</code><code class="o">=</code><code class="s">@GetDailyImagePath?.Invoke(Daily)</code>
                    <code class="na">class</code><code class="o">=</code><code class="s">"has-img-shadow"</code>
                    <code class="na">alt</code><code class="o">=</code><code class="s">"@Daily.Weather[0].Description"</code><code class="p">&gt;</code>
            <code class="p">&lt;/</code><code class="nt">figure</code><code class="p">&gt;</code>
        <code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">p</code> <code class="na">class</code><code class="o">=</code><code class="s">"heading"</code><code class="p">&gt;</code>@Daily.Weather[0].Main<code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">p</code> <code class="na">class</code><code class="o">=</code><code class="s">"heading has-text-weight-bold"</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">i</code> <code class="na">class</code><code class="o">=</code><code class="s">"fas fa-arrow-up"</code><code class="p">&gt;&lt;/</code><code class="nt">i</code><code class="p">&gt;</code>
            @GetDailyHigh?.Invoke(Daily)
        <code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">p</code> <code class="na">class</code><code class="o">=</code><code class="s">"heading has-text-weight-bold"</code><code class="p">&gt;</code>
            <code class="p">&lt;</code><code class="nt">i</code> <code class="na">class</code><code class="o">=</code><code class="s">"fas fa-arrow-down"</code><code class="p">&gt;&lt;/</code><code class="nt">i</code><code class="p">&gt;</code>
            @GetDailyLow?.Invoke(Daily)
        <code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>

@code {
    [Parameter]
    public DailyWeather Daily { get; set; } = null!;

    [Parameter]
    public Func<code class="p">&lt;</code><code class="nt">DailyWeather</code><code class="err">,</code> <code class="na">string</code><code class="p">&gt;</code>? GetDailyImagePath { get; set; }

    [Parameter]
    public Func<code class="p">&lt;</code><code class="nt">DailyWeather</code><code class="err">,</code> <code class="na">string</code><code class="p">&gt;</code>? GetDailyHigh { get; set; }

    [Parameter]
    public Func<code class="p">&lt;</code><code class="nt">DailyWeather</code><code class="err">,</code> <code class="na">string</code><code class="p">&gt;</code>? GetDailyLow { get; set; }
}</pre>

<p><code>WeatherDailyComponent</code> uses delegates as parameters for some of its data-binding needs. It renders the day for <a data-primary="WeatherDailyComponent.razor" data-startref="welp" data-type="indexterm" id="idm46365025933296"/>the forecast and an icon for the forecasted weather, along with the description and highs and lows.</p>

<p><code>WeatherComponent</code> relies on several services and refreshes the weather automatically using a timer, which we will look at next. This component shows a lot of powerful functionality. Now that you’ve <a data-primary="WeatherComponent.razor.cs" data-type="indexterm" id="whpnz"/>explored the markup, consider the shadowed component C# file, <em>WeatherComponent.razor.cs</em> (<a data-type="xref" href="#weather-component">Example 3-1</a>).</p>
<div data-type="example" id="weather-component">
<h5><span class="label">Example 3-1. </span>Web.Client/Components/WeatherComponent.razor.cs</h5>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code> <code class="nn">Learning.Blazor.Components</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">sealed</code> <code class="k">partial</code> <code class="k">class</code> <code class="nc">WeatherComponent</code> <code class="p">:</code> <code class="n">IDisposable</code>
    <code class="p">{</code>
        <code class="k">private</code> <code class="n">Coordinates</code> <code class="n">_coordinates</code> <code class="p">=</code> <code class="k">null</code><code class="p">!</code><code class="p">;</code> <a class="co" href="#callout___componentizing_CO15-1" id="co___componentizing_CO15-1"><img alt="1" src="assets/1.png"/></a>
        <code class="k">private</code> <code class="n">GeoCode</code><code class="p">?</code> <code class="n">_geoCode</code> <code class="p">=</code> <code class="k">null</code><code class="p">!</code><code class="p">;</code>
        <code class="k">private</code> <code class="n">WeatherComponentModel</code><code class="p">&lt;</code><code class="n">WeatherComponent</code><code class="p">&gt;</code><code class="p">?</code> <code class="n">_model</code> <code class="p">=</code> <code class="k">null</code><code class="p">!</code><code class="p">;</code>
        <code class="k">private</code> <code class="n">ComponentState</code> <code class="n">_state</code> <code class="p">=</code> <code class="n">ComponentState</code><code class="p">.</code><code class="n">Loading</code><code class="p">;</code>
        <code class="k">private</code> <code class="kt">bool</code> <code class="n">_isActive</code> <code class="p">=</code> <code class="k">false</code><code class="p">;</code>

        <code class="k">private</code> <code class="k">readonly</code> <code class="n">CancellationTokenSource</code> <code class="n">_cancellation</code> <code class="p">=</code> <code class="k">new</code><code class="p">(</code><code class="p">)</code><code class="p">;</code>
        <code class="k">private</code> <code class="k">readonly</code> <code class="n">PeriodicTimer</code> <code class="n">_timer</code> <code class="p">=</code> <code class="k">new</code><code class="p">(</code><code class="n">TimeSpan</code><code class="p">.</code><code class="n">FromMinutes</code><code class="p">(</code><code class="m">10</code><code class="p">)</code><code class="p">)</code><code class="p">;</code>
<code class="na">
        [Inject]</code>
        <code class="k">public</code> <code class="n">IWeatherStringFormatterService</code><code class="p">&lt;</code><code class="n">WeatherComponent</code><code class="p">&gt;</code> <code class="n">Formatter</code>
        <code class="p">{</code>
            <code class="k">get</code><code class="p">;</code>
            <code class="k">set</code><code class="p">;</code>
        <code class="p">}</code> <code class="p">=</code> <code class="k">null</code><code class="p">!</code><code class="p">;</code>
<code class="na">
        [Inject]</code>
        <code class="k">public</code> <code class="n">HttpClient</code> <code class="n">Http</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code> <code class="p">=</code> <code class="k">null</code><code class="p">!</code><code class="p">;</code>
<code class="na">
        [Inject]</code>
        <code class="k">public</code> <code class="n">GeoLocationService</code> <code class="n">GeoLocationService</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code> <code class="p">=</code> <code class="k">null</code><code class="p">!</code><code class="p">;</code>

        <code class="k">protected</code> <code class="k">override</code> <code class="n">Task</code> <code class="nf">OnInitializedAsync</code><code class="p">(</code><code class="p">)</code> <code class="p">=</code><code class="p">&gt;</code>
            <code class="n">TryGetClientCoordinatesAsync</code><code class="p">(</code><code class="p">)</code><code class="p">;</code>

        <code class="k">private</code> <code class="k">async</code> <code class="n">Task</code> <code class="nf">TryGetClientCoordinatesAsync</code><code class="p">(</code><code class="p">)</code> <code class="p">=</code><code class="p">&gt;</code> <a class="co" href="#callout___componentizing_CO15-2" id="co___componentizing_CO15-2"><img alt="2" src="assets/2.png"/></a>
            <code class="k">await</code> <code class="n">JavaScript</code><code class="p">.</code><code class="n">GetCoordinatesAsync</code><code class="p">(</code>
                <code class="k">this</code><code class="p">,</code>
                <code class="n">nameof</code><code class="p">(</code><code class="n">OnCoordinatesPermittedAsync</code><code class="p">)</code><code class="p">,</code>
                <code class="n">nameof</code><code class="p">(</code><code class="n">OnErrorRequestingCoordinatesAsync</code><code class="p">)</code><code class="p">)</code><code class="p">;</code>
<code class="na">
        [JSInvokable]</code> <a class="co" href="#callout___componentizing_CO15-3" id="co___componentizing_CO15-3"><img alt="3" src="assets/3.png"/></a>
        <code class="k">public</code> <code class="k">async</code> <code class="n">Task</code> <code class="nf">OnCoordinatesPermittedAsync</code><code class="p">(</code>
            <code class="kt">decimal</code> <code class="n">longitude</code><code class="p">,</code> <code class="kt">decimal</code> <code class="n">latitude</code><code class="p">)</code>
        <code class="p">{</code>
            <code class="n">_isGeoLocationPermissionGranted</code> <code class="p">=</code> <code class="k">true</code><code class="p">;</code>
            <code class="n">_coordinates</code> <code class="p">=</code> <code class="k">new</code><code class="p">(</code><code class="n">latitude</code><code class="p">,</code> <code class="n">longitude</code><code class="p">)</code><code class="p">;</code>
            <code class="k">if</code> <code class="p">(</code><code class="n">_isActive</code><code class="p">)</code> <code class="k">return</code><code class="p">;</code>

            <code class="k">do</code>
            <code class="p">{</code>
                <code class="n">_isActive</code> <code class="p">=</code> <code class="k">true</code><code class="p">;</code>

                <code class="k">try</code>
                <code class="p">{</code>
                    <code class="kt">var</code> <code class="n">lang</code> <code class="p">=</code> <code class="n">Culture</code><code class="p">.</code><code class="n">CurrentCulture</code><code class="p">.</code><code class="n">TwoLetterISOLanguageName</code><code class="p">;</code>
                    <code class="kt">var</code> <code class="n">unit</code> <code class="p">=</code> <code class="n">Culture</code><code class="p">.</code><code class="n">MeasurementSystem</code><code class="p">;</code>

                    <code class="kt">var</code> <code class="n">weatherLanguages</code> <code class="p">=</code>
                        <code class="k">await</code> <code class="n">Http</code><code class="p">.</code><code class="n">GetFromJsonAsync</code><code class="p">&lt;</code><code class="n">WeatherLanguage</code><code class="p">[</code><code class="p">]</code><code class="p">&gt;</code><code class="p">(</code>
                            <code class="s">"api/weather/languages"</code><code class="p">,</code>
                            <code class="n">WeatherLanguagesJsonSerializerContext</code>
                                <code class="p">.</code><code class="n">DefaultTypeInfo</code><code class="p">)</code><code class="p">;</code>

                    <code class="kt">var</code> <code class="n">requestLanguage</code> <code class="p">=</code>
                        <code class="n">weatherLanguages</code>
                            <code class="p">?</code><code class="p">.</code><code class="n">FirstOrDefault</code><code class="p">(</code>
                                <code class="n">language</code> <code class="p">=</code><code class="p">&gt;</code> <code class="n">language</code><code class="p">.</code><code class="n">AzureCultureId</code> <code class="p">=</code><code class="p">=</code> <code class="n">lang</code><code class="p">)</code>
                            <code class="p">?</code><code class="p">.</code><code class="n">WeatherLanguageId</code>
                        <code class="p">?</code><code class="p">?</code> <code class="s">"en"</code><code class="p">;</code>

                    <code class="n">WeatherRequest</code> <code class="n">weatherRequest</code> <code class="p">=</code> <code class="k">new</code><code class="p">(</code><code class="p">)</code>
                    <code class="p">{</code>
                        <code class="n">Language</code> <code class="p">=</code> <code class="n">requestLanguage</code><code class="p">,</code>
                        <code class="n">Latitude</code> <code class="p">=</code> <code class="n">latitude</code><code class="p">,</code>
                        <code class="n">Longitude</code> <code class="p">=</code> <code class="n">longitude</code><code class="p">,</code>
                        <code class="n">Units</code> <code class="p">=</code> <code class="p">(</code><code class="kt">int</code><code class="p">)</code><code class="n">unit</code>
                    <code class="p">}</code><code class="p">;</code>

                    <code class="k">using</code> <code class="nn">var</code> <code class="n">response</code> <code class="p">=</code>
                        <code class="k">await</code> <code class="n">Http</code><code class="p">.</code><code class="n">PostAsJsonAsync</code><code class="p">(</code><code class="s">"api/weather/latest"</code><code class="p">,</code>
                            <code class="n">weatherRequest</code><code class="p">,</code>
                            <code class="n">DefaultJsonSerialization</code><code class="p">.</code><code class="n">Options</code><code class="p">)</code><code class="p">;</code>

                    <code class="kt">var</code> <code class="n">weatherDetails</code> <code class="p">=</code>
                        <code class="k">await</code> <code class="n">response</code><code class="p">.</code><code class="n">Content</code><code class="p">.</code><code class="n">ReadFromJsonAsync</code><code class="p">&lt;</code><code class="n">WeatherDetails</code><code class="p">&gt;</code><code class="p">(</code>
                            <code class="n">DefaultJsonSerialization</code><code class="p">.</code><code class="n">Options</code><code class="p">)</code><code class="p">;</code>

                    <code class="k">await</code> <code class="nf">GetGeoCodeAsync</code><code class="p">(</code>
                        <code class="n">longitude</code><code class="p">,</code> <code class="n">latitude</code><code class="p">,</code> <code class="n">requestLanguage</code><code class="p">)</code><code class="p">;</code>

                    <code class="k">if</code> <code class="p">(</code><code class="n">weatherDetails</code> <code class="k">is</code> <code class="n">not</code> <code class="k">null</code> <code class="p">&amp;</code><code class="p">&amp;</code> <code class="n">_geoCode</code> <code class="k">is</code> <code class="n">not</code> <code class="k">null</code><code class="p">)</code>
                    <code class="p">{</code>
                        <code class="n">_model</code> <code class="p">=</code> <code class="k">new</code> <code class="n">WeatherComponentModel</code><code class="p">(</code>
                            <code class="n">weatherDetails</code><code class="p">,</code> <code class="n">_geoCode</code><code class="p">,</code> <code class="n">Formatter</code><code class="p">)</code><code class="p">;</code>
                        <code class="n">_state</code> <code class="p">=</code> <code class="n">ComponentState</code><code class="p">.</code><code class="n">Loaded</code><code class="p">;</code>
                    <code class="p">}</code>
                    <code class="k">else</code>
                    <code class="p">{</code>
                        <code class="n">_state</code> <code class="p">=</code> <code class="n">ComponentState</code><code class="p">.</code><code class="n">Error</code><code class="p">;</code>
                    <code class="p">}</code>
                <code class="p">}</code>
                <code class="k">catch</code> <code class="p">(</code><code class="n">Exception</code> <code class="n">ex</code><code class="p">)</code>
                <code class="p">{</code>
                    <code class="n">Logger</code><code class="p">.</code><code class="n">LogError</code><code class="p">(</code><code class="n">ex</code><code class="p">,</code> <code class="n">ex</code><code class="p">.</code><code class="n">Message</code><code class="p">)</code><code class="p">;</code>
                    <code class="n">_state</code> <code class="p">=</code> <code class="n">ComponentState</code><code class="p">.</code><code class="n">Error</code><code class="p">;</code>
                <code class="p">}</code>
                <code class="k">finally</code>
                <code class="p">{</code>
                    <code class="k">await</code> <code class="nf">InvokeAsync</code><code class="p">(</code><code class="n">StateHasChanged</code><code class="p">)</code><code class="p">;</code>
                <code class="p">}</code>
            <code class="p">}</code>
            <code class="k">while</code> <code class="p">(</code><code class="k">await</code> <code class="n">_timer</code><code class="p">.</code><code class="n">WaitForNextTickAsync</code><code class="p">(</code><code class="n">_cancellation</code><code class="p">.</code><code class="n">Token</code><code class="p">)</code><code class="p">)</code><code class="p">;</code>
        <code class="p">}</code>

        <code class="k">private</code> <code class="k">async</code> <code class="n">Task</code> <code class="nf">GetGeoCodeAsync</code><code class="p">(</code>
            <code class="kt">decimal</code> <code class="n">longitude</code><code class="p">,</code> <code class="kt">decimal</code> <code class="n">latitude</code><code class="p">,</code> <code class="kt">string</code> <code class="n">requestLanguage</code><code class="p">)</code>
        <code class="p">{</code>
            <code class="k">if</code> <code class="p">(</code><code class="n">_geoCode</code> <code class="k">is</code> <code class="k">null</code><code class="p">)</code>
            <code class="p">{</code>
                <code class="n">GeoCodeRequest</code> <code class="n">geoCodeRequest</code> <code class="p">=</code> <code class="k">new</code><code class="p">(</code><code class="p">)</code>
                <code class="p">{</code>
                    <code class="n">Language</code> <code class="p">=</code> <code class="n">requestLanguage</code><code class="p">,</code>
                    <code class="n">Latitude</code> <code class="p">=</code> <code class="n">latitude</code><code class="p">,</code>
                    <code class="n">Longitude</code> <code class="p">=</code> <code class="n">longitude</code><code class="p">,</code>
                <code class="p">}</code><code class="p">;</code>

                <code class="n">_geoCode</code> <code class="p">=</code>
                    <code class="k">await</code> <code class="n">GeoLocationService</code><code class="p">.</code><code class="n">GetGeoCodeAsync</code><code class="p">(</code><code class="n">geoCodeRequest</code><code class="p">)</code><code class="p">;</code>
            <code class="p">}</code>
        <code class="p">}</code>
<code class="na">
        [JSInvokable]</code> <a class="co" href="#callout___componentizing_CO15-4" id="co___componentizing_CO15-4"><img alt="4" src="assets/4.png"/></a>
        <code class="k">public</code> <code class="k">async</code> <code class="n">Task</code> <code class="nf">OnErrorRequestingCoordinatesAsync</code><code class="p">(</code>
            <code class="kt">int</code> <code class="n">code</code><code class="p">,</code> <code class="kt">string</code> <code class="n">message</code><code class="p">)</code>
        <code class="p">{</code>
            <code class="n">Logger</code><code class="p">.</code><code class="n">LogWarning</code><code class="p">(</code>
                <code class="s">"The user did not grant permission to geolocation:"</code> <code class="p">+</code>
                <code class="s">"({Code}) {Msg}"</code><code class="p">,</code>
                <code class="n">code</code><code class="p">,</code> <code class="n">message</code><code class="p">)</code><code class="p">;</code>

            <code class="c1">// 1 is PERMISSION_DENIED, error codes greater than 1
</code>            <code class="c1">// are unrelated errors.
</code>            <code class="k">if</code> <code class="p">(</code><code class="n">code</code> <code class="p">&gt;</code> <code class="m">1</code><code class="p">)</code>
            <code class="p">{</code>
                <code class="n">_isGeoLocationPermissionGranted</code> <code class="p">=</code> <code class="k">false</code><code class="p">;</code>
            <code class="p">}</code>
            <code class="n">_state</code> <code class="p">=</code> <code class="n">ComponentState</code><code class="p">.</code><code class="n">Error</code><code class="p">;</code>

            <code class="k">await</code> <code class="nf">InvokeAsync</code><code class="p">(</code><code class="n">StateHasChanged</code><code class="p">)</code><code class="p">;</code>
        <code class="p">}</code>

        <code class="k">void</code> <code class="n">IDisposable</code><code class="p">.</code><code class="n">Dispose</code><code class="p">(</code><code class="p">)</code> <a class="co" href="#callout___componentizing_CO15-5" id="co___componentizing_CO15-5"><img alt="5" src="assets/5.png"/></a>
        <code class="p">{</code>
            <code class="n">_cancellation</code><code class="p">.</code><code class="n">Cancel</code><code class="p">(</code><code class="p">)</code><code class="p">;</code>
            <code class="n">_cancellation</code><code class="p">.</code><code class="n">Dispose</code><code class="p">(</code><code class="p">)</code><code class="p">;</code>
            <code class="n">_timer</code><code class="p">.</code><code class="n">Dispose</code><code class="p">(</code><code class="p">)</code><code class="p">;</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" href="#co___componentizing_CO15-1" id="callout___componentizing_CO15-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>There are several fields and properties that <code>WeatherComponent</code> manages.</p></dd>
<dt><a class="co" href="#co___componentizing_CO15-2" id="callout___componentizing_CO15-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>When the component is initialized, a call to <code>TryGetClientCoordinatesAsync</code> is made.</p></dd>
<dt><a class="co" href="#co___componentizing_CO15-3" id="callout___componentizing_CO15-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>OnCoordinatesPermittedAsync</code> method is called when the user grants permission to geolocation.</p></dd>
<dt><a class="co" href="#co___componentizing_CO15-4" id="callout___componentizing_CO15-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The <code>OnErrorRequestingCoordinatesAsync</code> method is called when the user does not grant permission to geolocation.</p></dd>
<dt><a class="co" href="#co___componentizing_CO15-5" id="callout___componentizing_CO15-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>The <code>Dispose</code> method performs cleanup of the <code>CancellationTokenSource</code> and <code>PeriodicTimer</code> objects.</p></dd>
</dl>

<p>The weather component relies on the <a data-primary="GeoCode object" data-secondary="weather component and" data-type="indexterm" id="idm46365024503072"/>browser’s geolocation, which is natively guarded and requires the user to grant permission. The component has several field variables used to hold this information if the user permits it. The <code>Coordinates</code> object <a data-primary="Coordinates object" data-type="indexterm" id="idm46365024501424"/>is a C# positional record type with latitude and longitude properties. The <code>GeoCode</code> object <a data-primary="GeoCode object" data-type="indexterm" id="idm46365024719952"/>contains the city, country, and other similar information. It is instantiated from an HTTP call to the <a href="https://oreil.ly/9AtzC">Big Data Cloud API</a>. This call is conditional and occurs only when the user grants access to the browser’s geolocation service. In addition to these variables, there’s a component model and state. There is also <code>PeriodicTimer</code>. <code>Period⁠ic​Timer</code> was introduced with .NET 6, and it <a data-primary="PeriodicTimer" data-type="indexterm" id="idm46365024717456"/>provides a lightweight asynchronous timer. It is configured to tick every 10 minutes. The component requests that the DI container inject a formatter, HTTP client, and 
<span class="keep-together">geolocation service.</span></p>

<p>When the component is initialized, a call to <code>TryGetClientCoordinatesAsync</code> is awaited. This method is expressed as a call to <code>JavaScript.GetCoordinatesAsync</code> given <code>this</code> and two method names. This is a JavaScript interop call from .NET, and the corresponding extension method is explained in the next section. Just know that calling <code>TryGetClientCoordinatesAsync</code> will result in one of two methods being called, either the <code>OnCoordinatesPermittedAsync</code> method or the <code>OnErrorRequestingCoordinatesAsync</code> method.</p>

<p>When the user grants permission to the app (or if they have already at one point in time), the <code>OnCoordinatesPermittedAsync</code> method is called and given the geo-location represented as a <em>latitude</em> and <em>longitude</em> pair. This method is invoked from JavaScript, so it needs to be decorated with the <code>JSInvokable</code> attribute. When called, the <code>longitude</code> and <code>latitude</code> values will be provided with valid values. These values are then used to instantiate the component’s <code>_coordinates</code> object. At this point, the method tries to make a series of HTTP calls, sequentially relying on the previous request. The weather service API allows for a set number of languages that it supports. We need to use the current browser’s language, which is represented by their preferred ISO 639-1 two-letter language code. With the language code, we can also now infer a default unit of measure for the temperature, either <code>Metric</code> °C (degrees Celsius) or <code>Imperial</code> °F (degrees Fahrenheit). We need to read what languages the weather API supports, so a call to the <code>api/weather/languages</code> HTTP endpoint is made. This returns a collection of <code>WeatherLanguage</code> objects. The <code>api/weather/latest</code> HTTP endpoint returns a <code>WeatherDetails</code> object, which is then used to instantiate the weather component’s <code>_model</code>. Around the same time that this is happening, the <code>_geoCode</code> object is being fetched from the <code>GeoLocationService.GetGeoCodeAsync</code>.</p>

<p>When there are errors, they’re logged to the browser’s console, and the <code>_state</code> is set to <code>Error</code>, causing the markup to render that the weather service is unavailable. All of these changes are then communicated back to the component by 
<span class="keep-together">calling</span> 
<span class="keep-together"><code>StateHasChanged</code></span>. The UI will rerender when applicable. All of this code is wrapped in a <code>do</code>/<code>while</code> construct. <code>while</code> is conditional on <code>_timer</code> and <code>_cancella⁠tion​.Token</code>. This is the pattern to use when you need to periodically update values. It occurs only once from the callback; after that each invocation is controlled and protected by <code>PeriodicTimer</code>, which coalesces multiple ticks into a single tick between calls to its <code>WaitForNextTickAsync</code> method.</p>

<p>The <code>OnErrorRequestingCoordinatesAsync</code> method is only called when the user disables or later denies location permissions by changing the browser’s setting to blocked. When the user makes these changes, the browser will prompt the user to refresh the web app. The native browser permissions API will change the app’s ability to render weather. This callback method and the <code>OnCoordinatesPermittedAsync</code> methods are mutually exclusive and will fire only once from the client. The refresh will, however, trigger a reevaluation of the location permissions API.</p>

<p>The weather component demonstrates how to perform <a data-primary="conditional rendering of UI elements" data-type="indexterm" id="idm46365024539584"/><a data-primary="UI, conditional rendering" data-type="indexterm" id="idm46365024538928"/>conditional rendering of various UI elements with Blazor data binding, from showing the user a <code>Spinner​Compo⁠nent</code> that indicates loading, to an error message that encourages the user to enable the location permissions, to customized weather for your shared location. All of this happens asynchronously, using DI and powerful C# 10 features on a periodic timer automatically. The periodic timer implements its <code>IDisposable.Dispose</code> functionality through the weather component, so as <a data-primary="WeatherComponent.razor.cs" data-startref="whpnz" data-type="indexterm" id="idm46365024537200"/>the component is being cleaned up, so too are the timer’s resources.</p>

<p>From the C# code, you will have noticed the <code>JavaScript.GetCoordinatesAsync</code> method. The arrival of these coordinates is what initiates the whole process. You will see a trend that I’m trying to convey here; specifically, I want all JavaScript interop functions to be encapsulated into extension methods. This will allow for easier unit and integration testing. For <a data-primary="JSRuntimeExtensions.cs" data-type="indexterm" id="jsrxs"/>more information on testing, see <a data-type="xref" href="ch09.html#chapter-nine">Chapter 9</a>. Consider the <em>JSRuntimeExtensions.cs</em> C# file:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">using</code> <code class="nn">Microsoft.JSInterop</code><code class="p">;</code> <a class="co" href="#callout___componentizing_CO16-1" id="co___componentizing_CO16-1"><img alt="1" src="assets/1.png"/></a>

<code class="k">namespace</code> <code class="nn">Learning.Blazor.Extensions</code><code class="p">;</code>

<code class="k">internal</code> <code class="k">static</code> <code class="k">class</code> <code class="nc">JSRuntimeExtensions</code>
<code class="p">{</code>
    <code class="k">internal</code> <code class="k">static</code> <code class="n">ValueTask</code> <code class="n">GetCoordinatesAsync</code><code class="p">&lt;</code><code class="n">T</code><code class="p">&gt;</code><code class="p">(</code> <a class="co" href="#callout___componentizing_CO16-2" id="co___componentizing_CO16-2"><img alt="2" src="assets/2.png"/></a>
        <code class="k">this</code> <code class="n">IJSRuntime</code> <code class="n">jsRuntime</code><code class="p">,</code>
        <code class="n">T</code> <code class="n">dotnetObj</code><code class="p">,</code>
        <code class="kt">string</code> <code class="n">successMethodName</code><code class="p">,</code>
        <code class="kt">string</code> <code class="n">errorMethodName</code><code class="p">)</code> <code class="k">where</code> <code class="n">T</code> <code class="p">:</code> <code class="k">class</code> <code class="p">=</code><code class="p">&gt;</code> <a class="co" href="#callout___componentizing_CO16-3" id="co___componentizing_CO16-3"><img alt="3" src="assets/3.png"/></a>
        <code class="n">jsRuntime</code><code class="p">.</code><code class="n">InvokeVoidAsync</code><code class="p">(</code>
            <code class="s">"app.getClientCoordinates"</code><code class="p">,</code>
            <code class="n">DotNetObjectReference</code><code class="p">.</code><code class="n">Create</code><code class="p">(</code><code class="n">dotnetObj</code><code class="p">)</code><code class="p">,</code> <a class="co" href="#callout___componentizing_CO16-4" id="co___componentizing_CO16-4"><img alt="4" src="assets/4.png"/></a>
            <code class="n">successMethodName</code><code class="p">,</code>
            <code class="n">errorMethodName</code><code class="p">)</code><code class="p">;</code>

    <code class="c1">// Additional methods omitted for brevity.
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co___componentizing_CO16-1" id="callout___componentizing_CO16-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>JSRuntimeExtensions</code> class relies on the <code>Microsoft.JSInterop.IJSRuntime</code> type.</p></dd>
<dt><a class="co" href="#co___componentizing_CO16-2" id="callout___componentizing_CO16-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p><code>GetCoordinatesAsync</code> extends the <code>IJSRuntime</code> interface.</p></dd>
<dt><a class="co" href="#co___componentizing_CO16-3" id="callout___componentizing_CO16-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>Any component can call this extension method and pass itself as the generic-type parameter.</p></dd>
<dt><a class="co" href="#co___componentizing_CO16-4" id="callout___componentizing_CO16-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p><code>DotNetObjectReference</code> is created from the given <code>dotnetObj</code> and passed to the interop call.</p></dd>
</dl>

<p><code>Microsoft.JSInterop</code> is a framework-provided namespace. There are many useful types that you should get used to using:</p>
<dl>
<dt><code>DotNetObjectReference&lt;TValue&gt;</code></dt>
<dd>
<p>Wraps a JS interop argument, indicating that the value should not be serialized as JSON but instead should be passed as a reference. This reference is then used by JavaScript to call methods on the .NET object it wraps.</p>
</dd>
<dt><code>IJSRuntime</code></dt>
<dd>
<p>Represents an <a data-primary="IJSRuntime" data-type="indexterm" id="idm46365024898272"/>instance of a JavaScript runtime to which calls may be dispatched. This is common to both Blazor Server and Blazor WebAssembly, and it exposes only asynchronous APIs.</p>
</dd>
<dt><code>IJSInProcessRuntime</code></dt>
<dd>
<p>Represents an instance of a <a data-primary="IJSInProcessRuntime" data-type="indexterm" id="idm46365024896000"/>JavaScript runtime to which calls may be dispatched. This is specific to Blazor WebAssembly because the process is shared, unlike Blazor Server. This interface inherits the <code>IJSRuntime</code> and adds a single synchronous <code>TResult Invoke&lt;TResult&gt;</code> method.</p>
</dd>
<dt><code>IJSUnmarshalledRuntime</code></dt>
<dd>
<p>Represents an <a data-primary="IJSUnmarshalledRuntime" data-type="indexterm" id="idm46365024375360"/>instance of a JavaScript runtime to which calls may be dispatched without JSON marshaling. Currently, it is supported only on WebAssembly and for security reasons, will never be supported for .NET code that runs on the server. This is an advanced mechanism that should be used only in performance-critical scenarios.</p>
</dd>
</dl>

<p>The class extends the <code>IJSRuntime</code> type, and the <code>GetCoordinatesAsync</code> method returns <code>ValueTask</code> and accepts a single generic-type parameter <code>T</code>. The method requires the <code>T</code> instance and two method names for success and error callbacks. These method names are used from JavaScript to know what methods to invoke.</p>

<p>The generic type parameter <code>T</code> is constrained to a <code>class</code>; any component instance will suffice. The method body is an expression-bodied definition and lacks the <code>async</code> and <code>await</code> keywords. They are <em>not</em> necessary here because this extension method simply describes the intended asynchronous operation. Using the given <code>jsRuntime</code> instance that this method extends, it calls <code>InvokeVoidAsync</code>. This is not to be confused with “async void”; while the name is a bit confusing, it’s trying to convey that this JavaScript interop method doesn’t expect a result to be returned. The corresponding JavaScript function that is invoked is <code>app.getClientCoordinates</code>.</p>

<p><code>DotNetObjectReference.Create(dotnetObj)</code> wraps <code>dotnetObj</code>, and it is what’s passed as a reference to the JavaScript call. Blazor’s JavaScript bidirectional interop support relies on <code>DotNetObjectReference</code> and maintains a special understanding of these types. <code>successMethodName</code> and <code>errorMethodName</code> are actual <a data-primary="JSRuntimeExtensions.cs" data-startref="jsrxs" data-type="indexterm" id="idm46365024879104"/>method names on the <code>dotnetObj</code> instance with the <code>JSInvokable</code> attribute.</p>

<p>After looking through the Razor markup, the <a data-primary="app.js" data-type="indexterm" id="idm46365024876896"/>shadowed component C#, and the extension method functionality, let’s follow the call through to JavaScript. Consider the <em>app.js</em> JavaScript file:</p>

<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">getClientCoordinates</code> <code class="o">=</code> <a class="co" href="#callout___componentizing_CO17-1" id="co___componentizing_CO17-1"><img alt="1" src="assets/1.png"/></a>
    <code class="p">(</code><code class="nx">dotnetObj</code><code class="p">,</code> <code class="nx">successMethodName</code><code class="p">,</code> <code class="nx">errorMethodName</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">navigator</code> <code class="o">&amp;&amp;</code> <code class="nx">navigator</code><code class="p">.</code><code class="nx">geolocation</code><code class="p">)</code> <code class="p">{</code> <a class="co" href="#callout___componentizing_CO17-2" id="co___componentizing_CO17-2"><img alt="2" src="assets/2.png"/></a>
            <code class="nx">navigator</code><code class="p">.</code><code class="nx">geolocation</code><code class="p">.</code><code class="nx">getCurrentPosition</code><code class="p">(</code>
                <code class="p">(</code><code class="nx">position</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code> <a class="co" href="#callout___componentizing_CO17-3" id="co___componentizing_CO17-3"><img alt="3" src="assets/3.png"/></a>
                    <code class="kr">const</code> <code class="p">{</code> <code class="nx">longitude</code><code class="p">,</code> <code class="nx">latitude</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">position</code><code class="p">.</code><code class="nx">coords</code><code class="p">;</code>
                    <code class="nx">dotnetObj</code><code class="p">.</code><code class="nx">invokeMethodAsync</code><code class="p">(</code>
                        <code class="nx">successMethodName</code><code class="p">,</code> <code class="nx">longitude</code><code class="p">,</code> <code class="nx">latitude</code><code class="p">)</code><code class="p">;</code>
                <code class="p">}</code><code class="p">,</code>
                <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code> <a class="co" href="#callout___componentizing_CO17-4" id="co___componentizing_CO17-4"><img alt="4" src="assets/4.png"/></a>
                    <code class="kr">const</code> <code class="p">{</code> <code class="nx">code</code><code class="p">,</code> <code class="nx">message</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">error</code><code class="p">;</code>
                    <code class="nx">dotnetObj</code><code class="p">.</code><code class="nx">invokeMethodAsync</code><code class="p">(</code>
                        <code class="nx">errorMethodName</code><code class="p">,</code> <code class="nx">code</code><code class="p">,</code> <code class="nx">message</code><code class="p">)</code><code class="p">;</code>
                <code class="p">}</code><code class="p">)</code><code class="p">;</code>
        <code class="p">}</code>
    <code class="p">}</code><code class="p">;</code>

<code class="nb">window</code><code class="p">.</code><code class="nx">app</code> <code class="o">=</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">assign</code><code class="p">(</code><code class="p">{</code><code class="p">}</code><code class="p">,</code> <code class="nb">window</code><code class="p">.</code><code class="nx">app</code><code class="p">,</code> <code class="p">{</code> <a class="co" href="#callout___componentizing_CO17-5" id="co___componentizing_CO17-5"><img alt="5" src="assets/5.png"/></a>
    <code class="nx">getClientCoordinates</code><code class="p">,</code>
    <code class="c1">// omitted for brevity...
</code><code class="p">}</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co___componentizing_CO17-1" id="callout___componentizing_CO17-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>getClientCoordinates</code> function accepts a few parameters.</p></dd>
<dt><a class="co" href="#co___componentizing_CO17-2" id="callout___componentizing_CO17-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>If the browser supports the <code>geolocation</code> API, the <code>getCurrentPosition</code> method is called.</p></dd>
<dt><a class="co" href="#co___componentizing_CO17-3" id="callout___componentizing_CO17-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>When a <code>position</code> is available, the object reference has its success method invoked.</p></dd>
<dt><a class="co" href="#co___componentizing_CO17-4" id="callout___componentizing_CO17-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>When an error occurs, the object reference has its error method invoked.</p></dd>
<dt><a class="co" href="#co___componentizing_CO17-5" id="callout___componentizing_CO17-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>The <code>window.app</code> object is created (or updated) to include <code>getClient​Coordi⁠nates</code>.</p></dd>
</dl>

<p>The JavaScript file defines a <code>const</code> function named <code>getClientCoordinates</code>, which declares a method signature expecting a <code>dotnetObj</code>, <code>successMethodName</code>, and <code>errorMethodName</code>.</p>

<p>The function starts by asking if the browser’s <code>navigator</code> and <code>navigator​.geo⁠loca⁠tion</code> are truthy. If they are, a call to <code>getCurrentPosition</code> is invoked. This function is protected by the browser’s location permissions. If the user has not provided permission, they are prompted. If they deny this permission, the API will never call the successful callback.</p>

<p>When the user has already permitted access to the location services, this method will immediately call the first callback with a valid <code>position</code>. The <code>position</code> object has the <code>latitude</code> and <code>longitude</code> coordinates. From these coordinates, and the reference to <code>dotnetObj</code> with the given <code>successMethodName</code>, it calls back into the .NET code from JavaScript. This will call the <code>WeatherComponent.OnCoordinatesPermitte⁠d​Async</code> method passing the coordinates.</p>

<p>If there is an error for any reason, the second registered callback is invoked given the <code>error</code> object. The <code>error</code> object has an error <code>code</code> value and a <code>message</code>. The possible error <code>code</code> values are as follows:</p>
<dl>
<dt><code>1</code>: <code>PERMISSION_DENIED</code></dt>
<dd>
<p>When the page didn’t have permission to acquire <code>geolocation</code> information</p>
</dd>
<dt><code>2</code>: <code>POSITION_UNAVAILABLE</code></dt>
<dd>
<p>When an internal error occurs trying to acquire <code>geolocation</code> information</p>
</dd>
<dt><code>3</code>: <code>TIMEOUT</code></dt>
<dd>
<p>When the allowed time to acquire <code>geolocation</code> information was reached before acquiring it</p>
</dd>
</dl>

<p>Now that the <code>getClientCoordinates</code> function is fully defined, it’s added the <code>app</code> object on the <code>window</code> scope. If there are multiple JavaScript files defined in your apps that use the same object name on <code>window</code>, you can use the JavaScript spread operator to append the new functions into the existing object without overwriting it completely.</p>

<p>Assuming that you grant permissions to the app <a data-primary="WeatherComponent" data-startref="wtcpt" data-type="indexterm" id="idm46365024836192"/>when prompted, the markup will render the component on the user’s screen.</p>
</div></section>













<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm46365024834832">
<h1>Summary</h1>

<p>In this chapter, the app took flight and you learned how to put the user first by using the authenticated user information to better personalize the user’s experience with our app. When user-centric content was rendering, the user is prompted to allow 
<span class="keep-together"><code>geolocation</code></span> services (native to the browser) to use their coordinates. Using this personal information, the user’s local current weather and weather forecasts are displayed. You learned how to render component variables through various control structures, such as <code>@if</code> and <code>@switch</code> component expressions. We saw how to use services within a component, such as service libraries, and how to make HTTP calls using the <code>HttpClient</code> type. You learned a pattern to periodically update values automatically using <code>PeriodicTimer</code> from .NET. In addition to all of this, you also learned how to use the browser’s native <code>geolocation</code> service from Blazor with two-way JavaScript interop. The app greets the user with a message, a bit of laughter (or eye rolls if the jokes are bad enough), and a personalized weather forecast.</p>

<p>In the next chapter, you’ll learn how client services are registered for DI. You’ll learn how to customize the various authorizing states through component customization and Blazor render fragmentation. I’ll take you through another JavaScript interop scenario where you’ll learn how to convince the browser to utter a custom message with native speech synthesis. In the next chapter, you also learn how components communicate with events.</p>
</div></section>







</div></section></body></html>