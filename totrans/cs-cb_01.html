<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" class="pagenumrestart" data-pdf-bookmark="Chapter 1. Constructing Types and Apps"><div class="chapter" id="constructing_apps_and_types">
<h1><span class="label">Chapter 1. </span>Constructing Types and Apps</h1>


<p><a data-type="indexterm" data-primary="types" data-secondary="constructing" id="ix_ch01-asciidoc0"/>One of the first things we do as developers is design, organize, and create new types. This chapter helps with these tasks by offering several useful recipes for setting up the project, managing object lifetime, and establishing patterns.</p>






<section data-type="sect1" class="notoc orm:non-recipe" data-pdf-bookmark="Establishing Architecture"><div class="sect1" id="idm45678812306128">
<h1>Establishing Architecture</h1>

<p><a data-type="indexterm" data-primary="types" data-secondary="establishing architecture for" id="idm45678812304496"/>When you’re first setting up a project, you have to think about the overall architecture.<a data-type="indexterm" data-primary="separation of concerns" id="idm45678812303216"/> There’s a concept called <em>separation of concerns</em> wherein each part of an application has a specific purpose (e.g., the UI layer interacts with users, a business logic layer manages rules, and a data layer interacts with a data source). Each layer has a purpose or responsibilities and contains the code to perform its operations.</p>

<p>In addition to promoting more loosely coupled code, separation of concerns makes it easier for developers to work with that code because it’s easier to find where a certain operation occurs. This makes it easier to add new features and maintain existing code. The benefits of this are higher quality applications and more productive work. It pays to get started right, which is why we have <a data-type="xref" href="#designing_application_layers">Recipe 1.5</a>.</p>

<p>Related to loosely coupling code, there’s inversion of control (IoC), which helps decouple code and promotes testability. <a data-type="xref" href="#removing_explicit_dependencies">Recipe 1.2</a> explains how this works. When we look at ensuring quality, in <a data-type="xref" href="ch03.xhtml#ensuring_quality">Chapter 3</a>, you’ll see how IoC fits in to unit testing.</p>
</div></section>













<section data-type="sect1" class="notoc orm:non-recipe" data-pdf-bookmark="Applying Patterns"><div class="sect1" id="idm45678812364496">
<h1>Applying Patterns</h1>

<p><a data-type="indexterm" data-primary="types" data-secondary="applying patterns" id="idm45678812362880"/>A lot of the code we write is Transaction Script, where the user interacts with a UI and the code performs some type of create, read, update, or delete (CRUD) operation in the database and returns the result. Other times, we have complex interactions between objects that are difficult to organize. We need other patterns to solve these hard problems.</p>

<p>This chapter presents a few useful patterns in a rather informal manner. The idea is that you’ll have some code to rename and adapt to your purposes and a rationale on when a given pattern would be useful. As you read through each pattern, try to think about other code you’ve written or other situations where that pattern would have simplified the code.</p>

<p>If you run into the problem of having different APIs to different systems and needing to switch between them, you’ll be interested in reading <a data-type="xref" href="#making-classes-adapt">Recipe 1.8</a>. It shows how to build a single interface to solve this problem.</p>
</div></section>













<section data-type="sect1" class="notoc orm:non-recipe" data-pdf-bookmark="Managing Object Lifetime"><div class="sect1" id="idm45678812359120">
<h1>Managing Object Lifetime</h1>

<p><a data-type="indexterm" data-primary="types" data-secondary="managing object lifetime" id="idm45678812357456"/>Other important tasks we perform relate to object lifetime—that is, instantiating objects in memory, holding objects in memory for processing, and the subsequent release of that memory when the object is no longer needed. Recipes <a href="#delegating_object_creation_to_a_class">1.3</a> and <a href="#delegating_object_creation_to_a_method">1.4</a> show a couple of nice factory patterns that let you decouple object creation from code. This fits in with the IoC concepts mentioned previously.</p>

<p>One way to manage object creation is through a fluid interface, where you can include optional settings (via methods) and validate before object construction.</p>

<p>Another important object-lifetime consideration is disposal. Think about the drawbacks of excessive resource consumption, including memory use, file locks, and any other object that holds operating system resources. These problems often result in application crashes and are difficult to detect and fix. Performing proper resource cleanup is so important that it’s the first recipe we’ll cover in the book.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="1.1 Managing Object End-of-Lifetime"><div class="sect1" id="managing_object_lifetime">
<h1>1.1 Managing Object End-of-Lifetime</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678812351568">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="dispose pattern" data-secondary="end-of-lifetime management" id="ix_ch01-asciidoc1"/><a data-type="indexterm" data-primary="end-of-lifetime management" id="ix_ch01-asciidoc2"/><a data-type="indexterm" data-primary="lifetime management" id="ix_ch01-asciidoc3"/><a data-type="indexterm" data-primary="objects" data-secondary="end-of-lifetime management" id="ix_ch01-asciidoc4"/><a data-type="indexterm" data-primary="types" data-secondary="managing object end-of lifetime" id="ix_ch01-asciidoc5"/>Your application is crashing because of excessive resource usage.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678812344304">
<h2>Solution</h2>

<p>Here’s the object with the original problem:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">using</code> <code class="nn">System</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">System.IO</code><code class="p">;</code>

<code class="k">public</code> <code class="k">class</code> <code class="nc">DeploymentProcess</code>
<code class="p">{</code>
    <code class="n">StreamWriter</code> <code class="n">report</code> <code class="p">=</code> <code class="k">new</code> <code class="n">StreamWriter</code><code class="p">(</code><code class="s">"DeploymentReport.txt"</code><code class="p">);</code>

    <code class="k">public</code> <code class="kt">bool</code> <code class="nf">CheckStatus</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">report</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"{DateTime.Now} Application Deployed."</code><code class="p">);</code>

        <code class="k">return</code> <code class="k">true</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>And here’s how to fix the problem:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">using</code> <code class="nn">System</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">System.IO</code><code class="p">;</code>

<code class="k">public</code> <code class="k">class</code> <code class="nc">DeploymentProcess</code> <code class="p">:</code> <code class="n">IDisposable</code>
<code class="p">{</code>
    <code class="kt">bool</code> <code class="n">disposed</code><code class="p">;</code>

    <code class="k">readonly</code> <code class="n">StreamWriter</code> <code class="n">report</code> <code class="p">=</code> <code class="k">new</code> <code class="n">StreamWriter</code><code class="p">(</code><code class="s">"DeploymentReport.txt"</code><code class="p">);</code>

    <code class="k">public</code> <code class="kt">bool</code> <code class="nf">CheckStatus</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">report</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"{DateTime.Now} Application Deployed."</code><code class="p">);</code>

        <code class="k">return</code> <code class="k">true</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">protected</code> <code class="k">virtual</code> <code class="k">void</code> <code class="nf">Dispose</code><code class="p">(</code><code class="kt">bool</code> <code class="n">disposing</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">if</code> <code class="p">(!</code><code class="n">disposed</code><code class="p">)</code>
        <code class="p">{</code>
            <code class="k">if</code> <code class="p">(</code><code class="n">disposing</code><code class="p">)</code>
            <code class="p">{</code>
                <code class="c1">// disposal of purely managed resources goes here</code>
            <code class="p">}</code>

            <code class="n">report</code><code class="p">?.</code><code class="n">Close</code><code class="p">();</code>
            <code class="n">disposed</code> <code class="p">=</code> <code class="k">true</code><code class="p">;</code>
        <code class="p">}</code>
    <code class="p">}</code>

    <code class="p">~</code><code class="n">DeploymentProcess</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">Dispose</code><code class="p">(</code><code class="n">disposing</code><code class="p">:</code> <code class="k">false</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">void</code> <code class="nf">Dispose</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">Dispose</code><code class="p">(</code><code class="n">disposing</code><code class="p">:</code> <code class="k">true</code><code class="p">);</code>
        <code class="n">GC</code><code class="p">.</code><code class="n">SuppressFinalize</code><code class="p">(</code><code class="k">this</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>This is the <code>Main</code> method, using this object:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">(</code><code class="kt">string</code><code class="p">[]</code> <code class="n">args</code><code class="p">)</code>
<code class="p">{</code>
    <code class="k">using</code> <code class="p">(</code><code class="kt">var</code> <code class="n">deployer</code> <code class="p">=</code> <code class="k">new</code> <code class="n">DeploymentProcess</code><code class="p">())</code>
    <code class="p">{</code>
        <code class="n">deployer</code><code class="p">.</code><code class="n">CheckStatus</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678812177552">
<h2>Discussion</h2>

<p>The problem in this code was with the <code>StreamWriter report</code>. Whenever you’re using some type of resource, such as the <code>report</code> file reference, you need to release (or dispose) that resource. The specific problem here occurs because the app, through the <code>StreamWriter</code>, requested a file handle from the Windows OS. This app owns that file handle, and Windows expects the owning app to release the handle. If your app closes without releasing that handle, Windows prevents all applications, including subsequent running of your app, from accessing that file. In the worst case, everything crashes in a hard-to-find scenario that involves multiple people over a number of hours debugging a critical production problem. This occurs because Windows believes that file is still in use.</p>

<p>The solution is to implement the dispose pattern, which involves adding code that makes it easy to release resources. The solution code implements the <code>IDisposable</code> interface. <code>IDisposable</code> only specifies the <code>Dispose()</code> method, without parameters, and there’s more to be done than just adding that method, including another <code>Dispose</code> method overload that keeps track of what type of disposal to do and an optional <span class="keep-together">finalizer</span>.</p>

<p>Complicating the implementation is a field and parameter that control disposal logic: <code>disposed</code> and <code>disposing</code>. The <code>disposed</code> field ensures that this object gets disposed only one time. Inside the <code>Dispose(bool)</code> method, there’s an <code>if</code> statement, ensuring that if <code>disposed</code> is <code>true</code> (the object has been disposed), then it won’t execute any disposal logic. The first time through <code>Dispose(bool)</code>, disposed will be <code>false</code> and the code in the <code>if</code> block will execute. Make sure that you also set <code>disposed</code> to <code>true</code> to ensure this code doesn’t run anymore—the consequences of not doing so bring exposure to unpredictable errors like an <code>ObjectDisposedException</code>.</p>

<p>The <code>disposing</code> parameter tells <code>Dispose(bool)</code> how it’s being called. Notice that <span class="keep-together"><code>Dispose()</code></span> (without parameters) and the finalizer call <code>Dispose(bool)</code>. When <code>Dispose()</code> calls <code>Dispose(bool)</code>, <code>disposing</code> is <code>true</code>. This makes it easy for calling code, if written properly, to instantiate <code>DeploymentProcess</code> in a <code>using</code> statement or wrap it in the <code>finally</code> block of a <code>try/finally</code>.</p>

<p>The finalizer calls <code>Dispose(bool)</code> with <code>disposing</code> set to <code>false</code>, meaning that it isn’t being run by calling application code. The <code>Dispose(bool)</code> method uses the <code>disposing</code> value to determine whether it should release managed resources. Unmanaged resources are released regardless of whether <code>Dispose()</code> or the finalizer calls <span class="keep-together"><code>Dispose(bool)</code></span>.</p>

<p>Let’s clarify what is happening with the finalizer. The .NET CLR garbage collector (GC) executes an object’s finalizer when it cleans that object from memory. The GC can make multiple passes over objects, calling finalizers being one of the last things it does. Managed objects are instantiated and managed by the .NET CLR, and you don’t have control over when they’re released, which could potentially result in out-of-order releases. You have to check the disposing value to prevent an <code>Object​Dispose⁠d​Exception</code> in case the dependent object was disposed by the GC first.</p>

<p>What the finalizer gives you is a way to clean up unmanaged resources. An unmanaged resource, such as the file handle that <code>StreamWriter</code> obtained, doesn’t belong to the .NET CLR; it belongs to the Windows OS. There are situations where developers might need to explicitly call into a Win32/64 dynamic link library (DLL) to get a handle to an OS or third-party device. The reason you need the finalizer is that if your object doesn’t get disposed properly, there’s no other way to release that handle, which could crash your system for the same reason we need to release managed objects. So, the finalizer is a just-in-case mechanism to ensure the code that needs to release the unmanaged resource will execute.</p>

<p>A lot of applications don’t have objects that use unmanaged resources. In that case, don’t even add the finalizer. Having the finalizer adds overhead to the object because the GC has to do accounting to recognize objects that do have finalizers and call them in a multi-pass collection. Omitting the finalizer avoids this.</p>

<p>On a related note, remember to call <code>GC.SuppressFinalize</code> in the <code>Dispose()</code> method. This is another optimization telling the GC to not call the finalizer for this object, because all resources—managed and unmanaged—are released when the application calls <code>IDisposable.Dispose()</code>.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Generally, you should always call <code>GC.SuppressFinalize</code> in <span class="keep-together"><code>Dispose()</code></span>, even if the class doesn’t have a finalizer. That said, there are some nuances that you might be interested in. If a class is both <code>sealed</code> and doesn’t have a finalizer, you can safely omit the call to <code>GC.SuppressFinalize</code>. However, classes that aren’t <code>sealed</code> could potentially be inherited by another class that does include a finalizer. In this case, calling <code>GC.SuppressFinalize</code> protects against improper implementations.</p>

<p>For classes without finalizers, <code>GC.SuppressFinalize</code> has no effect. If you chose to leave out the call to <code>GC.SuppressFinalize</code> and the class has a finalizer, the CLR will call that finalizer.</p>
</div>

<p>The <code>Main</code> method shows how to properly use the <code>DeploymentProcess</code> object. It instantiates and wraps the object in a <code>using</code> statement. The object exists in memory until the <code>using</code> statement block ends. At that time, the program calls the <code>Dispose()</code> method.<a data-type="indexterm" data-startref="ix_ch01-asciidoc5" id="idm45678812090256"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc4" id="idm45678812089520"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc3" id="idm45678812088848"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc2" id="idm45678812088176"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc1" id="idm45678812087504"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="1.2 Removing Explicit Dependencies"><div class="sect1" id="removing_explicit_dependencies">
<h1>1.2 Removing Explicit Dependencies</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678812085504">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="dependencies, removing explicit" id="ix_ch01-asciidoc6"/><a data-type="indexterm" data-primary="explicit dependencies, removing" id="ix_ch01-asciidoc7"/><a data-type="indexterm" data-primary="tightly coupled applications, removing explicit dependencies from" id="ix_ch01-asciidoc8"/><a data-type="indexterm" data-primary="types" data-secondary="removing explicit dependencies" id="ix_ch01-asciidoc9"/>Your application is tightly coupled and difficult to maintain.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678812079776">
<h2>Solution</h2>

<p>Define the types you need:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">DeploymentArtifacts</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">void</code> <code class="nf">Validate</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">System</code><code class="p">.</code><code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"Validating..."</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="k">public</code> <code class="k">class</code> <code class="nc">DeploymentRepository</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">void</code> <code class="nf">SaveStatus</code><code class="p">(</code><code class="kt">string</code> <code class="n">status</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">System</code><code class="p">.</code><code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"Saving status..."</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="k">interface</code> <code class="n">IDeploymentService</code>
<code class="p">{</code>
    <code class="k">void</code> <code class="nf">PerformValidation</code><code class="p">();</code>
<code class="p">}</code>

<code class="k">public</code> <code class="k">class</code> <code class="nc">DeploymentService</code> <code class="p">:</code> <code class="n">IDeploymentService</code>
<code class="p">{</code>
    <code class="k">readonly</code> <code class="n">DeploymentArtifacts</code> <code class="n">artifacts</code><code class="p">;</code>
    <code class="k">readonly</code> <code class="n">DeploymentRepository</code> <code class="n">repository</code><code class="p">;</code>

    <code class="k">public</code> <code class="nf">DeploymentService</code><code class="p">(</code>
        <code class="n">DeploymentArtifacts</code> <code class="n">artifacts</code><code class="p">,</code>
        <code class="n">DeploymentRepository</code> <code class="n">repository</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="n">artifacts</code> <code class="p">=</code> <code class="n">artifacts</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="n">repository</code> <code class="p">=</code> <code class="n">repository</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">void</code> <code class="nf">PerformValidation</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">artifacts</code><code class="p">.</code><code class="n">Validate</code><code class="p">();</code>
        <code class="n">repository</code><code class="p">.</code><code class="n">SaveStatus</code><code class="p">(</code><code class="s">"status"</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>And start the application like this:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">using</code> <code class="nn">Microsoft.Extensions.DependencyInjection</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">System</code><code class="p">;</code>

<code class="k">class</code> <code class="nc">Program</code>
<code class="p">{</code>
    <code class="k">readonly</code> <code class="n">IDeploymentService</code> <code class="n">service</code><code class="p">;</code>

    <code class="k">public</code> <code class="nf">Program</code><code class="p">(</code><code class="n">IDeploymentService</code> <code class="n">service</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="n">service</code> <code class="p">=</code> <code class="n">service</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="kt">var</code> <code class="n">services</code> <code class="p">=</code> <code class="k">new</code> <code class="n">ServiceCollection</code><code class="p">();</code>

        <code class="n">services</code><code class="p">.</code><code class="n">AddTransient</code><code class="p">&lt;</code><code class="n">DeploymentArtifacts</code><code class="p">&gt;();</code>
        <code class="n">services</code><code class="p">.</code><code class="n">AddTransient</code><code class="p">&lt;</code><code class="n">DeploymentRepository</code><code class="p">&gt;();</code>
        <code class="n">services</code><code class="p">.</code><code class="n">AddTransient</code><code class="p">&lt;</code><code class="n">IDeploymentService</code><code class="p">,</code> <code class="n">DeploymentService</code><code class="p">&gt;();</code>

        <code class="n">ServiceProvider</code> <code class="n">serviceProvider</code> <code class="p">=</code>
            <code class="n">services</code><code class="p">.</code><code class="n">BuildServiceProvider</code><code class="p">();</code>

        <code class="n">IDeploymentService</code> <code class="n">deploymentService</code> <code class="p">=</code>
            <code class="n">serviceProvider</code><code class="p">.</code><code class="n">GetRequiredService</code><code class="p">&lt;</code><code class="n">IDeploymentService</code><code class="p">&gt;();</code>

        <code class="kt">var</code> <code class="n">program</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Program</code><code class="p">(</code><code class="n">deploymentService</code><code class="p">);</code>

        <code class="n">program</code><code class="p">.</code><code class="n">StartDeployment</code><code class="p">();</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">void</code> <code class="nf">StartDeployment</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">service</code><code class="p">.</code><code class="n">PerformValidation</code><code class="p">();</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"Validation complete - continuing..."</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678811897360">
<h2>Discussion</h2>

<p><a data-type="indexterm" data-primary="tightly coupled (term)" id="idm45678811568576"/>The term <em>tightly coupled</em> often means that one piece of code is overburdened with the responsibility of instantiating the types (dependencies) it uses. This requires the code to know how to construct, manage lifetime, and contain logic for dependencies. This distracts from the purpose of the code in solving the problem that it exists for. It duplicates instantiation of dependencies in different classes. This makes the code brittle because changes in dependency interfaces affect all other code that needs to instantiate that dependency. Additionally, code that instantiates its dependencies makes it difficult, if not impossible, to perform proper unit testing.</p>

<p><a data-type="indexterm" data-primary="dependency injection" id="idm45678811566496"/>The solution is dependency injection, which is a technique to define dependency type instantiation in one place and expose a service that other types can use to obtain instances of those dependencies. There are a couple of ways to perform dependency injection: service locator and inversion of control (IoC). Which to use and when is an active debate; let’s avoid venturing into theoretical territory. <a data-type="indexterm" data-primary="inversion of control (IoC)" data-secondary="when removing explicit dependencies" id="ix_ch01-asciidoc10"/>To keep things simple, this solution uses IoC, which is a common and straightforward approach.</p>

<p>The specific solution requires that you have types that rely on other dependency types, configure type constructors to accept dependencies, reference a library to help manage the IoC container, and use the container to declare how to instantiate types. The following paragraphs explain how this works. <a data-type="xref" href="#ioc_sequence">Figure 1-1</a> shows the relationship of objects and sequence of IoC operations for the solution.</p>

<figure><div id="ioc_sequence" class="figure">
<img src="Images/cscb_0101.png" alt="IoC for the Solution" width="600" height="450"/>
<h6><span class="label">Figure 1-1. </span>IoC for the solution</h6>
</div></figure>

<p>The solution is a utility to help manage a deployment process, validating whether the deployment process is configured properly. It has a <code>DeploymentService</code> class that runs the process. Notice that the <code>DeploymentService</code> constructor accepts the classes  <code>DeploymentArtifacts</code> and <code>DeploymentRepository</code>. <code>DeploymentService</code> does not instantiate these classes—rather, they are injected.</p>

<p>To inject these classes, you can use an IoC container, which is a library that helps to automatically instantiate types and to automatically instantiate and provide instances of dependency types. The IoC container in the solution, as shown in the <code>using</code> declaration, is the <code>Microsoft.Extensions.DependencyInjection</code> namespace, which you can reference as the NuGet package by the same name.</p>

<p>While we want to inject all dependencies for every type in the application, you must still instantiate the IoC container directly, which is why the <code>Main</code> method instantiates <code>ServiceCollection</code> as services. Then use the <code>services</code> instance to add all of the dependencies, including <code>DeploymentService</code>.</p>

<p>The IoC container can help manage the lifetime of objects. This solution uses <span class="keep-together"><code>AddTransient</code></span>, which means that the container should create a new instance every time its type is requested. A couple of other examples of managing object lifetime are <span class="keep-together"><code>AddSingleton</code></span>, which instantiates an object only one time and passes that one instance to all objects, and <code>AddScoped</code>, which gives more control over the lifetime of the object. In ASP.NET, <code>AddScoped</code> is set to the current request. Over time, you’ll want to think more about what the lifetime of your objects should be and investigate these options in more depth. For now, it’s simple to get started with <code>AddTransient</code>.</p>

<p>The call to <code>BuildServiceProvider</code> converts <code>services</code>, a <code>ServiceCollection</code>, into a <code>ServiceProvider</code>. The term <em>IoC container</em> refers to this <code>ServiceProvider</code> instance—it instantiates and locates types to be injected.</p>

<p>You can see the container in action, calling <code>GetRequiredService</code> to return an instance implementing <code>IDeploymentService</code>. Going back to the <code>ServiceCollection</code>, notice that there’s an <code>AddTransient</code> associating the <code>DeploymentService</code> class with the <code>IDeploymentService</code> interface. This means that <code>GetRequiredService</code> will return an instance of <code>DeploymentService</code>.</p>

<p>Finally, <code>Main</code> instantiates <code>Program</code>, with the new <code>DeploymentService</code> instance.</p>

<p>Going back to the constructor for <code>DeploymentService</code>, you can see that it expects to be called with instances for <code>DeploymentArtifacts</code> and <code>DeploymentRepository</code>. Because we used the IoC container to instantiate <code>DeploymentService</code>, the IoC container also knows how to instantiate its dependencies, which were also added to the <code>ServiceCollection</code>, with calls to <code>AddTransient</code>. This solution only used three types; you can build object dependency graphs much deeper than this.</p>

<p>Also, notice how the <code>DeploymentService</code> constructor saves the injected instances in <code>readonly</code> fields, making them available for use by <code>DeploymentService</code> members.</p>

<p>The beauty of IoC is that instantiation only happens in one place, and you don’t have to code all of that in your constructors or in members that need a new instance of a dependency. This makes your code more loosely coupled and maintainable. It also opens the opportunity for higher quality by making the type more unit testable<a data-type="indexterm" data-startref="ix_ch01-asciidoc10" id="idm45678811534448"/>.<a data-type="indexterm" data-startref="ix_ch01-asciidoc9" id="idm45678811533616"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc8" id="idm45678811532912"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc7" id="idm45678811532240"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc6" id="idm45678811531568"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45678811896768">
<h2>See Also</h2>

<p><a data-type="xref" data-xrefstyle="rec-num-title" href="ch03.xhtml#writing_a_unit_test">Recipe 3.1, “Writing a Unit Test”</a></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="1.3 Delegating Object Creation to a Class"><div class="sect1" id="delegating_object_creation_to_a_class">
<h1>1.3 Delegating Object Creation to a Class</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678811526832">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="class" data-secondary="delegating object creation to" id="ix_ch01-asciidoc11"/><a data-type="indexterm" data-primary="delegation" data-secondary="delegating object creation to a class" id="ix_ch01-asciidoc12"/><a data-type="indexterm" data-primary="inversion of control (IoC)" data-secondary="when delegating object creation to a class" id="ix_ch01-asciidoc13"/><a data-type="indexterm" data-primary="objects" data-secondary="delegating to a class" id="ix_ch01-asciidoc14"/><a data-type="indexterm" data-primary="types" data-secondary="delegating object creation to a class" id="ix_ch01-asciidoc15"/>You’re using IoC, the type you’re trying to instantiate doesn’t have an interface, and you have complex construction requirements.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678811518832">
<h2>Solution</h2>

<p>We want to instantiate this class:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">using</code> <code class="nn">System</code><code class="p">;</code>

<code class="k">public</code> <code class="k">class</code> <code class="nc">ThirdPartyDeploymentService</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">void</code> <code class="nf">Validate</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"Validated"</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>We’ll use this class for IoC:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">interface</code> <code class="n">IValidatorFactory</code>
<code class="p">{</code>
    <code class="n">ThirdPartyDeploymentService</code> <code class="nf">CreateDeploymentService</code><code class="p">();</code>
<code class="p">}</code></pre>

<p>And here’s the <code>IValidatorFactory</code> implementation:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">ValidatorFactory</code> <code class="p">:</code> <code class="n">IValidatorFactory</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="n">ThirdPartyDeploymentService</code> <code class="nf">CreateDeploymentService</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="k">new</code> <code class="nf">ThirdPartyDeploymentService</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>Then instantiate the factory like this:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">Program</code>
<code class="p">{</code>
    <code class="k">readonly</code> <code class="n">ThirdPartyDeploymentService</code> <code class="n">service</code><code class="p">;</code>

    <code class="k">public</code> <code class="nf">Program</code><code class="p">(</code><code class="n">IValidatorFactory</code> <code class="n">factory</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">service</code> <code class="p">=</code> <code class="n">factory</code><code class="p">.</code><code class="n">CreateDeploymentService</code><code class="p">();</code>
    <code class="p">}</code>

    <code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="kt">var</code> <code class="n">factory</code> <code class="p">=</code> <code class="k">new</code> <code class="n">ValidatorFactory</code><code class="p">();</code>
        <code class="kt">var</code> <code class="n">program</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Program</code><code class="p">(</code><code class="n">factory</code><code class="p">);</code>
        <code class="n">program</code><code class="p">.</code><code class="n">PerformValidation</code><code class="p">();</code>
    <code class="p">}</code>

    <code class="k">void</code> <code class="nf">PerformValidation</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">service</code><code class="p">.</code><code class="n">Validate</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678811419488">
<h2>Discussion</h2>

<p>As discussed in <a data-type="xref" href="#removing_explicit_dependencies">Recipe 1.2</a>, IoC is a best practice because it decouples dependencies, making code easier to maintain, more adaptable, and easier to test. The problem is that there are exceptions and situations that cause difficulties with the best of plans. One of these problems occurs when trying to use a third-party API without an <span class="keep-together">interface</span>.</p>

<p>The solution shows a <code>ThirdPartyDeploymentService</code> class. You can see the code and what it does. In reality, even if you can read the code through reflection or disassembler, it doesn’t help because you can’t add your interface. Even if <code>ThirdPartyDeploymentService</code> were open source, you would have to weigh the decision to fork the library for your own modifications—the trade-off being that your modifications are brittle in the face of new features and maintenance to the original open source library. An example is the <code>System.Net.HttpClient</code> class in the .NET Framework, which doesn’t have an interface. Ultimately, you’ll need to evaluate the situation and make a decision that works for you, but the <a data-type="indexterm" data-primary="factory class" id="idm45678811298576"/>factory class described here can be an effective work-around.</p>

<p>To see how a factory class works, observe the <code>IValidatorFactory</code> interface. This is the interface we’ll use for IoC. Next, examine how the <code>ValidatorFactory</code> class implements the <code>IValidatorFactory</code> interface. Its <code>CreateDeploymentService</code> instantiates and returns the <code>ThirdPartyDeploymentService</code>. This is what a factory does: it creates objects for us.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>This is related to the proxy pattern. The <code>ValidatorFactory</code> <span class="keep-together">controls</span> access to a <code>ThirdPartyDeploymentService</code> instance. However, rather than returning an object to control access to members of <code>ThirdPartyDeploymentService</code>, <code>CreateDeploymentService</code> returns a direct <code>ThirdPartyDeploymentService</code> instance.</p>
</div>

<p>To simplify this example, the code doesn’t use an IoC container—though it would be normal to use factories alongside IoC. Instead, the <code>Main</code> method instantiates <span class="keep-together"><code>ValidatorFactory</code></span> and passes that instance to the <code>Program</code> constructor, which is the important part of this example.</p>

<p>Examine how the constructor takes the <code>IValidatorFactory</code> reference and calls <code>Cre⁠ate​DeploymentService</code>. Now we’ve been able to inject the dependency and maintain the loose coupling we sought.</p>

<p>Another benefit is that since the <code>ThirdPartyDeploymentService</code> is instantiated in the factory class, you can make any future changes to class instantiation without affecting consuming code.<a data-type="indexterm" data-startref="ix_ch01-asciidoc15" id="idm45678811286208"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc14" id="idm45678811285536"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc13" id="idm45678811284864"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc12" id="idm45678811284192"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc11" id="idm45678811283520"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45678811282720">
<h2>See Also</h2>

<p><a data-type="xref" data-xrefstyle="rec-num-title" href="#removing_explicit_dependencies">Recipe 1.2, “Removing Explicit Dependencies”</a></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="1.4 Delegating Object Creation to a Method"><div class="sect1" id="delegating_object_creation_to_a_method">
<h1>1.4 Delegating Object Creation to a Method</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678811278672">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="delegation" data-secondary="delegating object creation to a method" id="ix_ch01-asciidoc16"/><a data-type="indexterm" data-primary="methods" data-secondary="delegating object creation to" id="ix_ch01-asciidoc17"/><a data-type="indexterm" data-primary="objects" data-secondary="delegating to a method" id="ix_ch01-asciidoc18"/><a data-type="indexterm" data-primary="plug-in frameworks, delegating object creation to a method for" id="ix_ch01-asciidoc19"/><a data-type="indexterm" data-primary="types" data-secondary="delegating object creation to a method" id="ix_ch01-asciidoc20"/>You want a plug-in framework and need to structure object instantiation someplace other than application logic.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678811271056">
<h2>Solution</h2>

<p>Here’s the abstract base class with the object creation contract:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">abstract</code> <code class="k">class</code> <code class="nc">DeploymentManagementBase</code>
<code class="p">{</code>
    <code class="n">IDeploymentPlugin</code> <code class="n">deploymentService</code><code class="p">;</code>

    <code class="k">protected</code> <code class="k">abstract</code> <code class="n">IDeploymentPlugin</code> <code class="nf">CreateDeploymentService</code><code class="p">();</code>

    <code class="k">public</code> <code class="kt">bool</code> <code class="nf">Validate</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="k">if</code> <code class="p">(</code><code class="n">deploymentService</code> <code class="p">==</code> <code class="k">null</code><code class="p">)</code>
            <code class="n">deploymentService</code> <code class="p">=</code> <code class="n">CreateDeploymentService</code><code class="p">();</code>

        <code class="k">return</code> <code class="n">deploymentService</code><code class="p">.</code><code class="n">Validate</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>These are a couple of classes that instantiate associated plug-in classes:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">DeploymentManager1</code> <code class="p">:</code> <code class="n">DeploymentManagementBase</code>
<code class="p">{</code>
    <code class="k">protected</code> <code class="k">override</code> <code class="n">IDeploymentPlugin</code> <code class="nf">CreateDeploymentService</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="k">new</code> <code class="nf">DeploymentPlugin1</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="k">public</code> <code class="k">class</code> <code class="nc">DeploymentManager2</code> <code class="p">:</code> <code class="n">DeploymentManagementBase</code>
<code class="p">{</code>
    <code class="k">protected</code> <code class="k">override</code> <code class="n">IDeploymentPlugin</code> <code class="nf">CreateDeploymentService</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="k">new</code> <code class="nf">DeploymentPlugin2</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>The plug-in classes implement the <code>IDeploymentPlugin</code> interface:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">interface</code> <code class="n">IDeploymentPlugin</code>
<code class="p">{</code>
    <code class="kt">bool</code> <code class="nf">Validate</code><code class="p">();</code>
<code class="p">}</code></pre>

<p>And here are the plug-in classes being instantiated:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">DeploymentPlugin1</code> <code class="p">:</code> <code class="n">IDeploymentPlugin</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">bool</code> <code class="nf">Validate</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"Validated Plugin 1"</code><code class="p">);</code>
        <code class="k">return</code> <code class="k">true</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="k">public</code> <code class="k">class</code> <code class="nc">DeploymentPlugin2</code> <code class="p">:</code> <code class="n">IDeploymentPlugin</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">bool</code> <code class="nf">Validate</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"Validated Plugin 2"</code><code class="p">);</code>
        <code class="k">return</code> <code class="k">true</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>Finally, here’s how it all fits together:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">class</code> <code class="nc">Program</code>
<code class="p">{</code>
    <code class="k">readonly</code> <code class="n">DeploymentManagementBase</code><code class="p">[]</code> <code class="n">deploymentManagers</code><code class="p">;</code>

    <code class="k">public</code> <code class="nf">Program</code><code class="p">(</code><code class="n">DeploymentManagementBase</code><code class="p">[]</code> <code class="n">deploymentManagers</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="n">deploymentManagers</code> <code class="p">=</code> <code class="n">deploymentManagers</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">static</code> <code class="n">DeploymentManagementBase</code><code class="p">[]</code> <code class="nf">GetPlugins</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="k">new</code> <code class="n">DeploymentManagementBase</code><code class="p">[]</code>
        <code class="p">{</code>
            <code class="k">new</code> <code class="nf">DeploymentManager1</code><code class="p">(),</code>
            <code class="k">new</code> <code class="nf">DeploymentManager2</code><code class="p">()</code>
        <code class="p">};</code>
    <code class="p">}</code>

    <code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">DeploymentManagementBase</code><code class="p">[]</code> <code class="n">deploymentManagers</code> <code class="p">=</code> <code class="n">GetPlugins</code><code class="p">();</code>

        <code class="kt">var</code> <code class="n">program</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Program</code><code class="p">(</code><code class="n">deploymentManagers</code><code class="p">);</code>

        <code class="n">program</code><code class="p">.</code><code class="n">Run</code><code class="p">();</code>
    <code class="p">}</code>

    <code class="k">void</code> <code class="nf">Run</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="k">foreach</code> <code class="p">(</code><code class="kt">var</code> <code class="n">manager</code> <code class="k">in</code> <code class="n">deploymentManagers</code><code class="p">)</code>
            <code class="n">manager</code><code class="p">.</code><code class="n">Validate</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678811270464">
<h2>Discussion</h2>

<p>Plug-in systems are all around us. Excel can consume and emit different document types, Adobe works with multiple image types, and Visual Studio Code has numerous extensions. These are all plug-in systems, and whether the only plug-ins available are via vendor or third party, they all leverage the same concept—the code must be able to adapt to handling a new abstract object type.</p>

<p>While the previous examples are ubiquitous in our daily lives, many developers won’t be building those types of systems. That said, the plug-in model is a powerful opportunity for making our applications extensible. Application integration is a frequent use case where your application needs to consume documents from customers, other departments, or other businesses. Sure, web services and other types of APIs are popular, but needing to consume an Excel spreadsheet is normal. As soon as you do that, someone has data in a different format, like CSV, JSON, tab delimited, and more. Another side of the story is the frequent need to export data in a format that multiple users need to consume.</p>

<p>In this spirit, the solution demonstrates a situation where a plug-in system allows an application to add support for new deployment types. This is a typical situation where you’ve built the system to handle the deployment artifacts that you know about, but the system is so useful that everyone else wants to add their own deployment logic, which you never knew about when original requirements were written.</p>

<p>In the solution, each of the <code>DeploymentManagers</code> implement the abstract base class, <code>DeploymentManagementBase</code>. <code>DeploymentManagementBase</code> orchestrates the logic, and the derived <code>DeploymentManager</code> classes are simply factories for their associated <span class="keep-together">plugins</span>. Notice that <code>DeploymentManagementBase</code> uses polymorphism to let derived classes instantiate their respective plug-in classes.</p>
<div data-type="tip"><h6>Tip</h6>
<p>If this is getting a little complex, you might want to review Recipes <a data-type="xref" data-xrefstyle="select:labelnumber" href="#removing_explicit_dependencies">1.2</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="#delegating_object_creation_to_a_class">1.3</a>. This is one level of abstraction above that.</p>
</div>

<p>The solution shows two classes that implement the <code>IDeploymentPlugin</code> interface. The <code>DeploymentManagementBase</code> class consumes the <code>IDeploymentPlugin</code> interface, delegating calls to its methods to the plug-in classes that implement that interface. Notice how <code>Validate</code> calls <code>Validate</code> on the <code>IDeploymentPlugin</code> instance.</p>

<p>The <code>Program</code> has no knowledge of the plug-in classes. It operates on instances of <code>DeploymentManagementBase</code>, as demonstrated where <code>Main</code> calls <code>GetPlugins</code> and receives an array of <code>DeploymentManagementBase</code> instances. <code>Program</code> doesn’t care about the plug-ins. For demo simplicity, <code>GetPlugins</code> is a method in <code>Program</code> but could be another class with a mechanism for selecting which plug-ins to use. Notice in the <code>Run</code> method how it iterates through <code>DeploymentManagementBase</code> instances.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Making <code>DeploymentManagementBase</code> implement an interface might make IoC more consistent if you’re using interfaces everywhere else. That said, an abstract base class can often work for most IoC containers, mocking, and unit testing tools.</p>
</div>

<p>To recap, the <code>DeploymentManagementBase</code> encapsulates all functionality and delegates work to plug-in classes. The code that makes the plug-in are the deployment managers, plug-in interface, and plug-in classes. The consuming code only works with a <span class="keep-together">collection</span> of <code>DeploymentManagementBase</code> and is blissfully unaware of the specific plug-in implementations.</p>

<p>Here’s where the power comes in. Whenever you or any third party you allow wants to extend the system for a new type of deployment, they do this:</p>
<ol>
<li>
<p>Create a new <code>DeploymentPlugin</code> class that implements your <code>IDeploymentPlugin</code> interface.</p>
</li>
<li>
<p>Create a new <code>DeploymentManagement</code> class that derives from <code>DeploymentManagementBase</code>.</p>
</li>
<li>
<p>Implement the <code>DeploymentManagement.CreateDeploymentService</code> method to instantiate and return the new <code>DeploymentPlugin</code>.</p>
</li>

</ol>

<p>Finally, the <code>GetPlugins</code> method, or some other logic of your choosing, would add that new code to its collections of plug-ins to operate on<a data-type="indexterm" data-startref="ix_ch01-asciidoc20" id="idm45678810860992"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc19" id="idm45678810860288"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc18" id="idm45678810859616"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc17" id="idm45678810858944"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc16" id="idm45678810858272"/>.<a data-type="indexterm" data-startref="ix_ch01-asciidoc0" id="idm45678810857472"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45678811022016">
<h2>See Also</h2>

<p><a data-type="xref" data-xrefstyle="rec-num-title" href="#removing_explicit_dependencies">Recipe 1.2, “Removing Explicit Dependencies”</a></p>

<p><a data-type="xref" data-xrefstyle="rec-num-title" href="#delegating_object_creation_to_a_class">Recipe 1.3, “Delegating Object Creation to a Class”</a></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="1.5 Designing Application Layers"><div class="sect1" id="designing_application_layers">
<h1>1.5 Designing Application Layers</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678810851312">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="applications" data-secondary="designing application layers" id="ix_ch01-asciidoc21"/><a data-type="indexterm" data-primary="layers, designing" id="ix_ch01-asciidoc22"/>You’re setting up a new application and are unsure of how to structure the project.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678810847472">
<h2>Solution</h2>

<p>Here’s a data access layer class:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">GreetingRepository</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="nf">GetNewGreeting</code><code class="p">()</code> <code class="p">=&gt;</code> <code class="s">"Welcome!"</code><code class="p">;</code>

    <code class="k">public</code> <code class="kt">string</code> <code class="nf">GetVisitGreeting</code><code class="p">()</code> <code class="p">=&gt;</code> <code class="s">"Welcome back!"</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>Here’s a business logic layer class:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">Greeting</code>
<code class="p">{</code>
    <code class="n">GreetingRepository</code> <code class="n">greetRep</code> <code class="p">=</code> <code class="k">new</code> <code class="n">GreetingRepository</code><code class="p">();</code>

    <code class="k">public</code> <code class="kt">string</code> <code class="nf">GetGreeting</code><code class="p">(</code><code class="kt">bool</code> <code class="n">isNew</code><code class="p">)</code> <code class="p">=&gt;</code>
        <code class="n">isNew</code> <code class="p">?</code> <code class="n">greetRep</code><code class="p">.</code><code class="n">GetNewGreeting</code><code class="p">()</code> <code class="p">:</code> <code class="n">greetRep</code><code class="p">.</code><code class="n">GetVisitGreeting</code><code class="p">();</code>
<code class="p">}</code></pre>

<p>These two classes are part of the UI layer:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">SignIn</code>
<code class="p">{</code>
    <code class="n">Greeting</code> <code class="n">greeting</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Greeting</code><code class="p">();</code>

    <code class="k">public</code> <code class="k">void</code> <code class="nf">Greet</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">Write</code><code class="p">(</code><code class="s">"Is this your first visit? (true/false): "</code><code class="p">);</code>
        <code class="kt">string</code> <code class="n">newResponse</code> <code class="p">=</code> <code class="n">Console</code><code class="p">.</code><code class="n">ReadLine</code><code class="p">();</code>

        <code class="kt">bool</code><code class="p">.</code><code class="n">TryParse</code><code class="p">(</code><code class="n">newResponse</code><code class="p">,</code> <code class="k">out</code> <code class="kt">bool</code> <code class="n">isNew</code><code class="p">);</code>

        <code class="kt">string</code> <code class="n">greetResponse</code> <code class="p">=</code> <code class="n">greeting</code><code class="p">.</code><code class="n">GetGreeting</code><code class="p">(</code><code class="n">isNew</code><code class="p">);</code>

        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"\n*\n* {greetResponse} \n*\n"</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="k">public</code> <code class="k">class</code> <code class="nc">Menu</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">void</code> <code class="nf">Show</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code>
            <code class="s">"*------*\n"</code> <code class="p">+</code>
            <code class="s">"* Menu *\n"</code> <code class="p">+</code>
            <code class="s">"*------*\n"</code> <code class="p">+</code>
            <code class="s">"\n"</code> <code class="p">+</code>
            <code class="s">"1. ...\n"</code> <code class="p">+</code>
            <code class="s">"2. ...\n"</code> <code class="p">+</code>
            <code class="s">"3. ...\n"</code> <code class="p">+</code>
            <code class="s">"\n"</code> <code class="p">+</code>
            <code class="s">"Choose: "</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>This is the application entry point (part of the UI layer):</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">class</code> <code class="nc">Program</code>
<code class="p">{</code>
    <code class="n">SignIn</code> <code class="n">signIn</code> <code class="p">=</code> <code class="k">new</code> <code class="n">SignIn</code><code class="p">();</code>
    <code class="n">Menu</code> <code class="n">menu</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Menu</code><code class="p">();</code>

    <code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="k">new</code> <code class="nf">Program</code><code class="p">().</code><code class="n">Start</code><code class="p">();</code>
    <code class="p">}</code>

    <code class="k">void</code> <code class="nf">Start</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">signIn</code><code class="p">.</code><code class="n">Greet</code><code class="p">();</code>
        <code class="n">menu</code><code class="p">.</code><code class="n">Show</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678810600048">
<h2>Discussion</h2>

<p>There are endless ways to set up and plan the structure of new projects, with some approaches better than others. Rather than viewing this discussion as a definitive conclusion, think of it as a few options with trade-offs that help you think about your own approach.</p>

<p><a data-type="indexterm" data-primary="Big Ball of Mud (BBoM) antipattern" id="idm45678810527152"/>The antipattern here is Big Ball of Mud (BBoM) architecture. BBoM is where a developer opens a single project and starts adding all the code at the same layer in the application. While this approach might help knock out a quick prototype, it has severe complications in the long run. Over time most apps need new features and maintenance to fix bugs. What happens is that the code begins to run together and there’s often much duplication, <a data-type="indexterm" data-primary="spaghetti code" id="idm45678810525840"/>commonly referred to as <em>spaghetti code</em>. Seriously, no one wants to maintain code like this, and you should avoid it.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>When under time pressure, it’s easy to think that creating a quick prototype might be an acceptable use of time. However, resist this urge. The cost of maintenance on a BBoM prototype project is high. The time required to work with spaghetti code to add a new feature or fix a bug quickly wipes out any perceived up-front gains from a sloppy prototype. Because of duplication, fixing a bug in one place leaves the same bug in other parts of the application. This means not only that a developer has to fix the bug multiple times but that the entire life cycle of QA, deployment, customer discovery, help desk service, and management wastes time on what would be multiple unnecessary cycles. The content in this section helps you avoid this antipattern.</p>
</div>

<p><a data-type="indexterm" data-primary="separation of concerns" id="idm45678810522464"/>The primary concept to grasp here is separation of concerns. You’ll often hear this simplified as a layered architecture where you have UI, business logic, and data layers, with each section named for the type of code placed in that layer. This section uses the layered approach with the goal of showing how to achieve separation of concerns and associated benefits.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Sometimes the idea of a layered architecture makes people think they must route application communication through the layers or that certain operations are restricted to their layer. This isn’t quite true or practical. For example, business logic can be found in different layers, such as rules for validating user input in the UI layer as well as logic for how to process a certain request. Another example of exceptions to communication patterns is when a user needs to select a set of operations on a form—there isn’t any business logic involved and the UI layer can request the list of items from the data layer directly. What we want is separation of concerns to enhance the maintainability of the code; any dogmatic/idealistic restrictions that don’t make sense run counter to that goal.</p>
</div>

<p>The solution starts with a data access layer, <code>GreetingRepository</code>. This simulates the repository pattern, which is an abstraction so that calling code doesn’t need to think about how to retrieve the data. Ideally, creating a separate data project promises an additional benefit of reusing that data access layer in another project that needs access to the same data. Sometimes you get reuse and other times you don’t, though you always get the benefits of reducing duplication and knowing where the data access logic resides.</p>

<p>The business logic layer has a <code>Greeting</code> class. Notice how it uses the <code>isNew</code> parameter to determine which method of <code>GreetingRepository</code> to call. Anytime you find yourself needing to write logic for how to handle a user request, consider putting that code in another class that is considered part of the business logic layer. If you already have code like this, refactor it out into a separate object named for the type of logic it needs to handle.</p>

<p>Finally, there’s the UI layer, which is composed of the <code>SignIn</code> and <code>Menu</code> classes. These classes handle the interaction with the user, yet they delegate any logic to the business logic layer. <code>Program</code> might be considered part of the UI layer, though it’s only orchestrating interaction/navigation between other UI layer classes and doesn’t perform UI operations itself.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The way I wrote the solution was so you would see the definition of a class before it was used. However, when actually doing the design, you might start with the UI layer and then work down through business logic and data access.</p>
</div>

<p>There are a couple of dimensions to separation of concerns in this code. <code>Greeting​Re⁠pository</code> is only concerned with data, and <code>Greeting</code> data in particular. For example, if the app needed data to show in a <code>Menu</code>, you would need another class called <code>MenuRepository</code> that did CRUD operations on <code>Menu</code> data. <code>Greeting</code> only handles business logic for <code>Greeting</code> data. If a <code>Menu</code> had its own business logic, you might consider a separate business logic layer class for that, but only if it made sense. As you can see in the UI layer, <code>SignIn</code> only handles interaction with the user for signing into the app, and <code>Menu</code> only handles interaction with the user for displaying and choosing what they want to do. The beauty is that now you or anyone else can easily go into the application and find the code concerning the subject you need to address.</p>

<p>Figures <a data-type="xref" data-xrefstyle="select:labelnumber" href="#simple_app">1-2</a>, <a data-type="xref" data-xrefstyle="select:labelnumber" href="#separate_data">1-3</a>, and <a data-type="xref" data-xrefstyle="select:labelnumber" href="#enterprise_layout">1-4</a> show how you might structure each layer into a Visual Studio solution. <a data-type="xref" href="#simple_app">Figure 1-2</a> is for a very simple app, like a utility that is unlikely to have many features. In this case, it’s OK to keep the layers in the same project because there isn’t a lot of code and anything extra doesn’t have tangible benefit.</p>

<figure class="width-40"><div id="simple_app" class="figure">
<img src="Images/cscb_0102.png" alt="Project Layout for a Simple App" width="395" height="363"/>
<h6><span class="label">Figure 1-2. </span>Project layout for a simple app</h6>
</div></figure>

<p><a data-type="xref" href="#separate_data">Figure 1-3</a> shows how you might structure a project that’s a little larger and will grow over time, which I’ll loosely call midsize for the sake of discussion. Notice that it has a separate data access layer. The purpose of that is potential reuse. Some projects offer different UIs for different customers. For example, there might be a chatbot or mobile app that accesses the data for users but a web app for administrators. Having the data access layer as a separate project makes this possible. Notice how <code>SystemApp.Console</code> has an assembly reference to <code>SystemApp.Data</code>.</p>

<figure><div id="separate_data" class="figure">
<img src="Images/cscb_0103.png" alt=" Project Layout to Separate UI and Data Layers" width="497" height="656"/>
<h6><span class="label">Figure 1-3. </span>Project layout to separate UI and data layers</h6>
</div></figure>

<p>For larger enterprise apps, you’ll want to break the layers apart, as shown in <a data-type="xref" href="#enterprise_layout">Figure 1-4</a>. The problem to solve here is that you want a cleaner break between sections of code to encourage loose coupling. Large applications often become complex and hard to manage unless you control the architecture in a way that encourages best practices.</p>

<figure><div id="enterprise_layout" class="figure">
<img src="Images/cscb_0104.png" alt="Project Layout for Separation of Concerns" width="541" height="745"/>
<h6><span class="label">Figure 1-4. </span>Project layout for separation of concerns</h6>
</div></figure>

<p>For the enterprise scenario, this example is small. However, imagine the complexity of a growing application. As you add new business logic, you’ll begin finding code that gets reused. Also, you’ll naturally have some code that can stand on its own, like a service layer for accessing an external API. The opportunity here is to have a reusable library that might be useful in other applications. Therefore, you’ll want to refactor anything reusable into its own project. On a growing project, you can rarely anticipate every aspect or feature that an app will support, and watching for these changes and refactoring will help to keep your code, project, and architecture healthier.<a data-type="indexterm" data-startref="ix_ch01-asciidoc22" id="idm45678810490464"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc21" id="idm45678810489760"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="1.6 Returning Multiple Values from a Method"><div class="sect1" id="idm45678810528416">
<h1>1.6 Returning Multiple Values from a Method</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678810488112">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="methods" data-secondary="returning multiple values from" id="ix_ch01-asciidoc23"/><a data-type="indexterm" data-primary="tuples" data-secondary="returning multiple values from a method" id="ix_ch01-asciidoc24"/><a data-type="indexterm" data-primary="types" data-secondary="returning multiple values from a method" id="ix_ch01-asciidoc25"/><a data-type="indexterm" data-primary="values, returning from a method" id="ix_ch01-asciidoc26"/>You need to return multiple values from a method, and using classic approaches such as <code>out</code> parameters or returning a custom type doesn’t feel intuitive.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678810481120">
<h2>Solution</h2>

<p><code>ValidationStatus</code> has a deconstructor:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">ValidationStatus</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">bool</code> <code class="n">Deployment</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
    <code class="k">public</code> <code class="kt">bool</code> <code class="n">SmokeTest</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
    <code class="k">public</code> <code class="kt">bool</code> <code class="n">Artifacts</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="k">void</code> <code class="nf">Deconstruct</code><code class="p">(</code>
        <code class="k">out</code> <code class="kt">bool</code> <code class="n">isPreviousDeploymentComplete</code><code class="p">,</code>
        <code class="k">out</code> <code class="kt">bool</code> <code class="n">isSmokeTestComplete</code><code class="p">,</code>
        <code class="k">out</code> <code class="kt">bool</code> <code class="n">areArtifactsReady</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">isPreviousDeploymentComplete</code> <code class="p">=</code> <code class="n">Deployment</code><code class="p">;</code>
        <code class="n">isSmokeTestComplete</code> <code class="p">=</code> <code class="n">SmokeTest</code><code class="p">;</code>
        <code class="n">areArtifactsReady</code> <code class="p">=</code> <code class="n">Artifacts</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>The <code>DeploymentService</code> shows how to return a tuple:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">DeploymentService</code>
<code class="p">{</code>
    <code class="k">public</code>
    <code class="p">(</code><code class="kt">bool</code> <code class="n">deployment</code><code class="p">,</code> <code class="kt">bool</code> <code class="n">smokeTest</code><code class="p">,</code> <code class="kt">bool</code> <code class="n">artifacts</code><code class="p">)</code>
    <code class="n">PrepareDeployment</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">ValidationStatus</code> <code class="n">status</code> <code class="p">=</code> <code class="n">Validate</code><code class="p">();</code>

        <code class="p">(</code><code class="kt">bool</code> <code class="n">deployment</code><code class="p">,</code> <code class="kt">bool</code> <code class="n">smokeTest</code><code class="p">,</code> <code class="kt">bool</code> <code class="n">artifacts</code><code class="p">)</code> <code class="p">=</code> <code class="n">status</code><code class="p">;</code>

        <code class="k">return</code> <code class="p">(</code><code class="n">deployment</code><code class="p">,</code> <code class="n">smokeTest</code><code class="p">,</code> <code class="n">artifacts</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="n">ValidationStatus</code> <code class="nf">Validate</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="k">new</code> <code class="n">ValidationStatus</code>
        <code class="p">{</code>
            <code class="n">Deployment</code> <code class="p">=</code> <code class="k">true</code><code class="p">,</code>
            <code class="n">SmokeTest</code> <code class="p">=</code> <code class="k">true</code><code class="p">,</code>
            <code class="n">Artifacts</code> <code class="p">=</code> <code class="k">true</code>
        <code class="p">};</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>And here’s how to consume the returned tuple:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">class</code> <code class="nc">Program</code>
<code class="p">{</code>
    <code class="k">readonly</code> <code class="n">DeploymentService</code> <code class="n">deployment</code> <code class="p">=</code> <code class="k">new</code> <code class="n">DeploymentService</code><code class="p">();</code>
    <code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">(</code><code class="kt">string</code><code class="p">[]</code> <code class="n">args</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">new</code> <code class="nf">Program</code><code class="p">().</code><code class="n">Start</code><code class="p">();</code>
    <code class="p">}</code>

    <code class="k">void</code> <code class="nf">Start</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="p">(</code><code class="kt">bool</code> <code class="n">deployed</code><code class="p">,</code> <code class="kt">bool</code> <code class="n">smokeTest</code><code class="p">,</code> <code class="kt">bool</code> <code class="n">artifacts</code><code class="p">)</code> <code class="p">=</code>
            <code class="n">deployment</code><code class="p">.</code><code class="n">PrepareDeployment</code><code class="p">();</code>

        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code>
            <code class="err">$</code><code class="s">"\nDeployment Status:\n\n"</code> <code class="p">+</code>
            <code class="err">$</code><code class="s">"Is Previous Deployment Complete? {deployed}\n"</code> <code class="p">+</code>
            <code class="err">$</code><code class="s">"Is Previous Smoke Test Complete? {smokeTest}\n"</code> <code class="p">+</code>
            <code class="err">$</code><code class="s">"Are artifacts for this deployment ready? {artifacts}\n\n"</code> <code class="p">+</code>
            <code class="err">$</code><code class="s">"Can deploy: {deployed &amp;&amp; smokeTest &amp;&amp; artifacts}"</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678810258624">
<h2>Discussion</h2>

<p>Historically, the typical way to return multiple values from a method was to create a custom type or add multiple <code>out</code> parameters. It always felt wasteful to create a custom type that would only be used one time for the purpose of returning values. The other option, to use multiple <code>out</code> parameters, felt clunky too. Using a tuple is more elegant. A <em>tuple</em> is a value type that lets you group data into a single object without declaring a separate type.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The tuple type described in this section was a new feature of C# 7.0. It aliases the .NET <code>ValueTuple</code>, which is a mutable value type whose members are fields. In contrast, the .NET Framework has a <code>Tuple</code> class, which is an immutable reference type whose members are properties. Both <code>ValueTuple</code> and <code>Tuple</code> named members <code>Item1</code>, <code>Item2</code>, …, <code>ItemN</code>; in contrast, you’re free to provide more meaningful names for C# tuple members.</p>

<p>If using a version of .NET prior to 4.7, you must explicitly reference the <code>System.ValueTuple</code> NuGet package.</p>
</div>

<p>The solution shows a couple of different aspects of tuples, deconstruction, and how to return a tuple from a method. The <code>ValidationStatus</code> class has a <code>Deconstruct</code> method and C# uses that to produce a tuple from an instance of the class. This class wasn’t strictly necessary for this example, but it does demonstrate an interesting way of converting a class to a tuple.</p>

<p>The <code>DeploymentService</code> class shows how to return a tuple. Notice that the return type of the <code>PrepareDeployment</code> method is a tuple. The property names in the tuple return type are optional, though meaningful variable names could make the code easier to read.</p>

<p>The code calls <code>Validate</code>, which returns an instance of <code>ValidationStatus</code>. The next line, assigning status to the tuple, uses the deconstructor to return a tuple instance. <code>PrepareDeployment</code> uses those values to return a new tuple to the caller.</p>

<p>The solution implementation of <code>PrepareDeployment</code> shows the mechanics of working with tuples, which is useful for learning, though not very elegant. In practice, it would be cleaner to return <code>status</code> from the method because the deconstructor will run implicitly.</p>

<p>The <code>Start</code> method, in <code>Program</code>, shows how to call <code>PrepareDeployment</code> and consume the tuple it returns.<a data-type="indexterm" data-startref="ix_ch01-asciidoc26" id="idm45678810136976"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc25" id="idm45678810136272"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc24" id="idm45678810135600"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc23" id="idm45678810134928"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="1.7 Converting from Legacy to Strongly Typed Classes"><div class="sect1" id="idm45678810134128">
<h1>1.7 Converting from Legacy to Strongly Typed Classes</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678810133088">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="class" data-secondary="converting from legacy to strongly typed classes" id="ix_ch01-asciidoc27"/><a data-type="indexterm" data-primary="legacy type, converting to strongly typed classes" id="ix_ch01-asciidoc28"/><a data-type="indexterm" data-primary="strongly typed classes" id="ix_ch01-asciidoc29"/><a data-type="indexterm" data-primary="types" data-secondary="converting from legacy to strongly typed classes" id="ix_ch01-asciidoc30"/>You have a legacy type that operates on values of type <code>object</code> and need to modernize to a strongly typed implementation.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678810126608">
<h2>Solution</h2>

<p>Here’s a <code>Deployment</code> class that we’ll be using:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">Deployment</code>
<code class="p">{</code>
    <code class="kt">string</code> <code class="n">config</code><code class="p">;</code>

    <code class="k">public</code> <code class="nf">Deployment</code><code class="p">(</code><code class="kt">string</code> <code class="n">config</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="n">config</code> <code class="p">=</code> <code class="n">config</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="kt">bool</code> <code class="nf">PerformHealthCheck</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code>
            <code class="err">$</code><code class="s">"Performed health check for config {config}."</code><code class="p">);</code>
        <code class="k">return</code> <code class="k">true</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>And here’s a legacy <code>CircularQueue</code> collection:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">CircularQueue</code>
<code class="p">{</code>
    <code class="kt">int</code> <code class="n">current</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code>
    <code class="kt">int</code> <code class="n">last</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code>
    <code class="kt">object</code><code class="p">[]</code> <code class="n">items</code><code class="p">;</code>

    <code class="k">public</code> <code class="nf">CircularQueue</code><code class="p">(</code><code class="kt">int</code> <code class="n">size</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">items</code> <code class="p">=</code> <code class="k">new</code> <code class="kt">object</code><code class="p">[</code><code class="n">size</code><code class="p">];</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">void</code> <code class="nf">Add</code><code class="p">(</code><code class="kt">object</code> <code class="n">obj</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">if</code> <code class="p">(</code><code class="n">last</code> <code class="p">&gt;=</code> <code class="n">items</code><code class="p">.</code><code class="n">Length</code><code class="p">)</code>
            <code class="k">throw</code> <code class="k">new</code> <code class="nf">IndexOutOfRangeException</code><code class="p">();</code>

        <code class="n">items</code><code class="p">[</code><code class="n">last</code><code class="p">++]</code> <code class="p">=</code> <code class="n">obj</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="kt">object</code> <code class="nf">Next</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">current</code> <code class="p">%=</code> <code class="n">last</code><code class="p">;</code>
        <code class="kt">object</code> <code class="n">item</code> <code class="p">=</code> <code class="n">items</code><code class="p">[</code><code class="n">current</code><code class="p">];</code>
        <code class="n">current</code><code class="p">++;</code>

        <code class="k">return</code> <code class="n">item</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>This code shows how to use the legacy collection:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">HealthChecksObjects</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">void</code> <code class="nf">PerformHealthChecks</code><code class="p">(</code><code class="kt">int</code> <code class="n">cycles</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">CircularQueue</code> <code class="n">checks</code> <code class="p">=</code> <code class="n">Configure</code><code class="p">();</code>

        <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code> <code class="n">i</code> <code class="p">&lt;</code> <code class="n">cycles</code><code class="p">;</code> <code class="n">i</code><code class="p">++)</code>
        <code class="p">{</code>
            <code class="n">Deployment</code> <code class="n">deployment</code> <code class="p">=</code> <code class="p">(</code><code class="n">Deployment</code><code class="p">)</code><code class="n">checks</code><code class="p">.</code><code class="n">Next</code><code class="p">();</code>
            <code class="n">deployment</code><code class="p">.</code><code class="n">PerformHealthCheck</code><code class="p">();</code>
        <code class="p">}</code>
    <code class="p">}</code>

    <code class="k">private</code> <code class="n">CircularQueue</code> <code class="nf">Configure</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="kt">var</code> <code class="n">queue</code> <code class="p">=</code> <code class="k">new</code> <code class="n">CircularQueue</code><code class="p">(</code><code class="m">5</code><code class="p">);</code>

        <code class="n">queue</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code><code class="k">new</code> <code class="n">Deployment</code><code class="p">(</code><code class="s">"a"</code><code class="p">));</code>
        <code class="n">queue</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code><code class="k">new</code> <code class="n">Deployment</code><code class="p">(</code><code class="s">"b"</code><code class="p">));</code>
        <code class="n">queue</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code><code class="k">new</code> <code class="n">Deployment</code><code class="p">(</code><code class="s">"c"</code><code class="p">));</code>

        <code class="k">return</code> <code class="n">queue</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>Next, here’s the legacy collection refactored as a generic collection:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">CircularQueue</code><code class="p">&lt;</code><code class="n">T</code><code class="p">&gt;</code>
<code class="p">{</code>
    <code class="kt">int</code> <code class="n">current</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code>
    <code class="kt">int</code> <code class="n">last</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code>
    <code class="n">T</code><code class="p">[]</code> <code class="n">items</code><code class="p">;</code>

    <code class="k">public</code> <code class="nf">CircularQueue</code><code class="p">(</code><code class="kt">int</code> <code class="n">size</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">items</code> <code class="p">=</code> <code class="k">new</code> <code class="n">T</code><code class="p">[</code><code class="n">size</code><code class="p">];</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">void</code> <code class="nf">Add</code><code class="p">(</code><code class="n">T</code> <code class="n">obj</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">if</code> <code class="p">(</code><code class="n">last</code> <code class="p">&gt;=</code> <code class="n">items</code><code class="p">.</code><code class="n">Length</code><code class="p">)</code>
            <code class="k">throw</code> <code class="k">new</code> <code class="nf">IndexOutOfRangeException</code><code class="p">();</code>

        <code class="n">items</code><code class="p">[</code><code class="n">last</code><code class="p">++]</code> <code class="p">=</code> <code class="n">obj</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="n">T</code> <code class="nf">Next</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">current</code> <code class="p">%=</code> <code class="n">last</code><code class="p">;</code>
        <code class="n">T</code> <code class="n">item</code> <code class="p">=</code> <code class="n">items</code><code class="p">[</code><code class="n">current</code><code class="p">];</code>
        <code class="n">current</code><code class="p">++;</code>

        <code class="k">return</code> <code class="n">item</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>With code that shows how to use the new generic collection:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">HealthChecksGeneric</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">void</code> <code class="nf">PerformHealthChecks</code><code class="p">(</code><code class="kt">int</code> <code class="n">cycles</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">CircularQueue</code><code class="p">&lt;</code><code class="n">Deployment</code><code class="p">&gt;</code> <code class="n">checks</code> <code class="p">=</code> <code class="n">Configure</code><code class="p">();</code>

        <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code> <code class="n">i</code> <code class="p">&lt;</code> <code class="n">cycles</code><code class="p">;</code> <code class="n">i</code><code class="p">++)</code>
        <code class="p">{</code>
            <code class="n">Deployment</code> <code class="n">deployment</code> <code class="p">=</code> <code class="n">checks</code><code class="p">.</code><code class="n">Next</code><code class="p">();</code>
            <code class="n">deployment</code><code class="p">.</code><code class="n">PerformHealthCheck</code><code class="p">();</code>
        <code class="p">}</code>
    <code class="p">}</code>

    <code class="k">private</code> <code class="n">CircularQueue</code><code class="p">&lt;</code><code class="n">Deployment</code><code class="p">&gt;</code> <code class="n">Configure</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="kt">var</code> <code class="n">queue</code> <code class="p">=</code> <code class="k">new</code> <code class="n">CircularQueue</code><code class="p">&lt;</code><code class="n">Deployment</code><code class="p">&gt;(</code><code class="m">5</code><code class="p">);</code>

        <code class="n">queue</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code><code class="k">new</code> <code class="n">Deployment</code><code class="p">(</code><code class="s">"a"</code><code class="p">));</code>
        <code class="n">queue</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code><code class="k">new</code> <code class="n">Deployment</code><code class="p">(</code><code class="s">"b"</code><code class="p">));</code>
        <code class="n">queue</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code><code class="k">new</code> <code class="n">Deployment</code><code class="p">(</code><code class="s">"c"</code><code class="p">));</code>

        <code class="k">return</code> <code class="n">queue</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>Here’s demo code to show both collections in action:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">class</code> <code class="nc">Program</code>
<code class="p">{</code>
    <code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">(</code><code class="kt">string</code><code class="p">[]</code> <code class="n">args</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">new</code> <code class="nf">HealthChecksObjects</code><code class="p">().</code><code class="n">PerformHealthChecks</code><code class="p">(</code><code class="m">5</code><code class="p">);</code>
        <code class="k">new</code> <code class="nf">HealthChecksGeneric</code><code class="p">().</code><code class="n">PerformHealthChecks</code><code class="p">(</code><code class="m">5</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678810125984">
<h2>Discussion</h2>

<p>The first version of C# didn’t have generics. Instead, we had a <code>System.Collections</code> namespace with collections like <code>Dictionary</code>, <code>List</code>, and <code>Stack</code> that operated on instances of type <code>object</code>. If the instances in the collection were reference types, the conversion performance to/from object was negligible. However, if you wanted to manage a collection of value types, the boxing/unboxing performance penalty became more excruciating the larger the collection got or the more operations <span class="keep-together">performed</span>.</p>

<p>Microsoft had always intended to add generics, and they finally arrived in C# 2. However, in the meantime, there was a ton of nongeneric code written. Imagine all of the new object-based collections that developers needed to write on their own for things like sets, priority queues, and tree data structures. Add to that types like delegates, which were the primary means of method reference and async communication and operated on objects. There’s a long list of nongeneric code that’s been written, and chances are that you’ll encounter some of it as you progress through your career.</p>

<p>As C# developers, we appreciate the benefits of strongly typed code, making it easier to find and fix compile-time errors, making an application more maintainable, and improving quality. For this reason, you might have a strong desire to refactor a given piece of nongeneric code so that it too is strongly typed with generics.</p>

<p>The process is basically this: whenever you see type <code>object</code>, convert it to generic.</p>

<p>The solution shows a <code>Deployment</code> object that performs a health check on a deployed artifact. Since we have multiple artifacts, we also need to hold multiple <code>Deployment</code> instances in a collection. The collection is a (partially implemented) circular queue, and there’s a <code>HealthCheck</code> class that loops through the queue and periodically performs a health check with the next <code>Deployment</code> instance.</p>

<p><code>HealthCheckObject</code> operates on old nongeneric code and <code>HealthCheckGeneric</code> operates on new generic code. The difference between the two is that the <code>HealthCheck​Ob⁠ject</code> <code>Configure</code> method instantiates a nongeneric <code>CircularQueue</code>, and the <code>HealthCheckGeneric</code> <code>Configure</code> method instantiates a generic <code>CircularQueue&lt;T&gt;</code>. Our primary task is to convert <code>CircularQueue</code> to <code>CircularQueue&lt;T&gt;</code>.</p>

<p>Since we’re working with a collection, the first task is to add the type parameter to the class, <code>CircularQueue&lt;T&gt;</code>. Then look for anywhere the code uses the <code>object</code> type and convert that to the class type parameter, <code>T</code>:</p>
<ol>
<li>
<p>Convert the <code>object items[]</code> field to <code>T items[]</code>.</p>
</li>
<li>
<p>In the constructor, instantiate a new <code>T[]</code> instead of <code>object[]</code>.</p>
</li>
<li>
<p>Change the <code>Add</code> parameter from <code>object</code> to <code>T</code>.</p>
</li>
<li>
<p>Change the <code>Next</code> return type from <code>object</code> to <code>T</code>.</p>
</li>
<li>
<p>In <code>Next</code>, change the <code>object item</code> variable to <code>T item</code>.</p>
</li>

</ol>

<p>After changing <code>object</code> types to <code>T</code>, you have a new strongly typed generic collection.</p>

<p>The <code>Program</code> class demonstrates how both of these collections work.<a data-type="indexterm" data-startref="ix_ch01-asciidoc30" id="idm45678809414560"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc29" id="idm45678809413856"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc28" id="idm45678809413184"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc27" id="idm45678809412512"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="1.8 Making Classes Adapt to Your Interface"><div class="sect1" id="making-classes-adapt">
<h1>1.8 Making Classes Adapt to Your Interface</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678809410240">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="adapter class" id="ix_ch01-asciidoc31"/><a data-type="indexterm" data-primary="applications" data-secondary="making classes adapt to your interface" id="ix_ch01-asciidoc32"/><a data-type="indexterm" data-primary="class" data-secondary="making classes adapt to your interface" id="ix_ch01-asciidoc33"/><a data-type="indexterm" data-primary="interfaces" data-secondary="making classes adapt to your interface" id="ix_ch01-asciidoc34"/>You have a third-party library with similar functionality as your code, but it doesn’t have the same interface.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678809403808">
<h2>Solution</h2>

<p>This is the interface we want to work with:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">interface</code> <code class="n">IDeploymentService</code>
<code class="p">{</code>
    <code class="k">void</code> <code class="nf">Validate</code><code class="p">();</code>
<code class="p">}</code></pre>

<p>Here are a couple of classes that implement that interface:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">DeploymentService1</code> <code class="p">:</code> <code class="n">IDeploymentService</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">void</code> <code class="nf">Validate</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"Deployment Service 1 Validated"</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="k">public</code> <code class="k">class</code> <code class="nc">DeploymentService2</code> <code class="p">:</code> <code class="n">IDeploymentService</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">void</code> <code class="nf">Validate</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"Deployment Service 2 Validated"</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>Here’s a third-party class that doesn’t implement <code>IDeploymentService</code>:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">ThirdPartyDeploymentService</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">void</code> <code class="nf">PerformValidation</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"3rd Party Deployment Service 1 Validated"</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>This is the adapter that implements <code>IDeploymentService</code>:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">ThirdPartyDeploymentAdapter</code> <code class="p">:</code> <code class="n">IDeploymentService</code>
<code class="p">{</code>
    <code class="n">ThirdPartyDeploymentService</code> <code class="n">service</code> <code class="p">=</code> <code class="k">new</code> <code class="n">ThirdPartyDeploymentService</code><code class="p">();</code>

    <code class="k">public</code> <code class="k">void</code> <code class="nf">Validate</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">service</code><code class="p">.</code><code class="n">PerformValidation</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>This code shows how to include the third-party service by using the adapter:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">class</code> <code class="nc">Program</code>
<code class="p">{</code>
    <code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">(</code><code class="kt">string</code><code class="p">[]</code> <code class="n">args</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">new</code> <code class="nf">Program</code><code class="p">().</code><code class="n">Start</code><code class="p">();</code>
    <code class="p">}</code>

    <code class="k">void</code> <code class="nf">Start</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">List</code><code class="p">&lt;</code><code class="n">IDeploymentService</code><code class="p">&gt;</code> <code class="n">services</code> <code class="p">=</code> <code class="n">Configure</code><code class="p">();</code>

        <code class="k">foreach</code> <code class="p">(</code><code class="kt">var</code> <code class="n">svc</code> <code class="k">in</code> <code class="n">services</code><code class="p">)</code>
            <code class="n">svc</code><code class="p">.</code><code class="n">Validate</code><code class="p">();</code>
    <code class="p">}</code>

    <code class="n">List</code><code class="p">&lt;</code><code class="n">IDeploymentService</code><code class="p">&gt;</code> <code class="n">Configure</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="k">new</code> <code class="n">List</code><code class="p">&lt;</code><code class="n">IDeploymentService</code><code class="p">&gt;</code>
        <code class="p">{</code>
            <code class="k">new</code> <code class="nf">DeploymentService1</code><code class="p">(),</code>
            <code class="k">new</code> <code class="nf">DeploymentService2</code><code class="p">(),</code>
            <code class="k">new</code> <code class="nf">ThirdPartyDeploymentAdapter</code><code class="p">()</code>
        <code class="p">};</code>
    <code class="p">}</code>
<code class="p">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678809403216">
<h2>Discussion</h2>

<p>An adapter is a class that wraps another class but exposes the functionality of the wrapped class with the interface you need.</p>

<p>There are various situations where the need for an adapter class comes into play. What if you have a group of objects that implement an interface and want to use a third-party class that doesn’t match the interface that your code works with? What if your code is written for a third-party API, like a payment service, and you know you want to eventually switch to a different provider with a different API? What if you need to use native code via Platform Invocation Services (P/Invoke) or Component Object Model (COM) interop and didn’t want the details of that interface to bleed into your code? These scenarios are all good candidates for considering an adapter.</p>

<p>The solution has <code>DeploymentService</code> classes that implement <code>IDeploymentService</code>. You can see in the <code>Program</code> <code>Start</code> method that it only operates on instances that implement <code>IDeploymentService</code>.</p>

<p>Sometime later, you encounter the need to integrate <code>ThirdPartyDeploymentService</code> into the app. However, it doesn’t implement <code>IDeploymentService</code>, and you don’t have the code for <code>ThirdPartyDeploymentService</code>.</p>

<p>The <code>ThirdPartyDeploymentAdapter</code> class solves the problem. It implements the <span class="keep-together"><code>IDeploymentService</code></span> interface and instantiates its own copy of <code>ThirdPartyDeploymentService</code>, and the <code>Validate</code> method delegates the call to <code>ThirdPartyDeploymentService</code>. Notice that the <code>Program</code> <code>Configure</code> method adds an instance of <code>ThirdPartyDeploymentAdapter</code> to the collection that <code>Start</code> operates on.</p>

<p>This was a demo to show you how to design an adapter. In practice, the <code>Perform​Vali⁠dation</code> method of <code>ThirdPartyDeploymentService</code> likely has different parameters and a different return type. The <code>ThirdPartyDeploymentAdapter</code> <code>Validate</code> method will be responsible for preparing arguments and reshaping return values to ensure they conform to the proper <code>IDeploymentService</code> interface.<a data-type="indexterm" data-startref="ix_ch01-asciidoc34" id="idm45678809084160"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc33" id="idm45678809083424"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc32" id="idm45678809082752"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc31" id="idm45678809082080"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="1.9 Designing a Custom Exception"><div class="sect1" id="designing_a_custom_exception">
<h1>1.9 Designing a Custom Exception</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678809080016">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="custom exception type" id="ix_ch01-asciidoc35"/><a data-type="indexterm" data-primary="exception handling" data-secondary="designing a custom exception" id="ix_ch01-asciidoc36"/><a data-type="indexterm" data-primary="types" data-secondary="designing a custom exception" id="ix_ch01-asciidoc37"/>The .NET Framework library doesn’t have an exception type that fits your <span class="keep-together">requirements</span>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678809074336">
<h2>Solution</h2>

<p>This is a custom exception:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="na">[Serializable]</code>
<code class="k">public</code> <code class="k">class</code> <code class="nc">DeploymentValidationException</code> <code class="p">:</code> <code class="n">Exception</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="nf">DeploymentValidationException</code><code class="p">()</code> <code class="p">:</code>
        <code class="k">this</code><code class="p">(</code><code class="s">"Validation Failed!"</code><code class="p">,</code> <code class="k">null</code><code class="p">,</code> <code class="n">ValidationFailureReason</code><code class="p">.</code><code class="n">Unknown</code><code class="p">)</code>
    <code class="p">{</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="nf">DeploymentValidationException</code><code class="p">(</code>
        <code class="kt">string</code> <code class="n">message</code><code class="p">)</code> <code class="p">:</code>
        <code class="k">this</code><code class="p">(</code><code class="n">message</code><code class="p">,</code> <code class="k">null</code><code class="p">,</code> <code class="n">ValidationFailureReason</code><code class="p">.</code><code class="n">Unknown</code><code class="p">)</code>
    <code class="p">{</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="nf">DeploymentValidationException</code><code class="p">(</code>
        <code class="kt">string</code> <code class="n">message</code><code class="p">,</code> <code class="n">Exception</code> <code class="n">innerException</code><code class="p">)</code> <code class="p">:</code>
        <code class="k">this</code><code class="p">(</code><code class="n">message</code><code class="p">,</code> <code class="n">innerException</code><code class="p">,</code> <code class="n">ValidationFailureReason</code><code class="p">.</code><code class="n">Unknown</code><code class="p">)</code>
    <code class="p">{</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="nf">DeploymentValidationException</code><code class="p">(</code>
        <code class="kt">string</code> <code class="n">message</code><code class="p">,</code> <code class="n">ValidationFailureReason</code> <code class="n">reason</code><code class="p">)</code> <code class="p">:</code>
        <code class="k">this</code><code class="p">(</code><code class="n">message</code><code class="p">,</code> <code class="k">null</code><code class="p">,</code> <code class="n">reason</code><code class="p">)</code>
    <code class="p">{</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="nf">DeploymentValidationException</code><code class="p">(</code>
        <code class="kt">string</code> <code class="n">message</code><code class="p">,</code>
        <code class="n">Exception</code> <code class="n">innerException</code><code class="p">,</code>
        <code class="n">ValidationFailureReason</code> <code class="n">reason</code><code class="p">)</code> <code class="p">:</code>
        <code class="k">base</code><code class="p">(</code><code class="n">message</code><code class="p">,</code> <code class="n">innerException</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">Reason</code> <code class="p">=</code> <code class="n">reason</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="n">ValidationFailureReason</code> <code class="n">Reason</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>

    <code class="k">public</code> <code class="k">override</code> <code class="kt">string</code> <code class="nf">ToString</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="k">return</code>
            <code class="k">base</code><code class="p">.</code><code class="n">ToString</code><code class="p">()</code> <code class="p">+</code>
            <code class="err">$</code><code class="s">" - Reason: {Reason} "</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>And this is an enum type for a property on that exception:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">enum</code> <code class="n">ValidationFailureReason</code>
<code class="p">{</code>
    <code class="n">Unknown</code><code class="p">,</code>
    <code class="n">PreviousDeploymentFailed</code><code class="p">,</code>
    <code class="n">SmokeTestFailed</code><code class="p">,</code>
    <code class="n">MissingArtifacts</code>
<code class="p">}</code></pre>

<p>This code shows how to throw the custom exception:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">DeploymentService</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">void</code> <code class="nf">Validate</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="k">throw</code> <code class="k">new</code> <code class="nf">DeploymentValidationException</code><code class="p">(</code>
            <code class="s">"Smoke test failed - check with qa@example.com."</code><code class="p">,</code>
            <code class="n">ValidationFailureReason</code><code class="p">.</code><code class="n">SmokeTestFailed</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>And this code catches the custom exception:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">class</code> <code class="nc">Program</code>
<code class="p">{</code>
    <code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="k">try</code>
        <code class="p">{</code>
            <code class="k">new</code> <code class="nf">DeploymentService</code><code class="p">().</code><code class="n">Validate</code><code class="p">();</code>
        <code class="p">}</code>
        <code class="k">catch</code> <code class="p">(</code><code class="n">DeploymentValidationException</code> <code class="n">ex</code><code class="p">)</code>
        <code class="p">{</code>
            <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code>
                <code class="err">$</code><code class="s">"Message: {ex.Message}\n"</code> <code class="p">+</code>
                <code class="err">$</code><code class="s">"Reason: {ex.Reason}\n"</code> <code class="p">+</code>
                <code class="err">$</code><code class="s">"Full Description: \n {ex}"</code><code class="p">);</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678808814768">
<h2>Discussion</h2>

<p>The beautiful thing about C# exceptions are that they’re strongly typed. When your code catches them, you can write specific handling logic for just that type of exception. The .NET Framework has a few exceptions, like <code>ArgumentNullException</code>, that get some reuse (you can throw yourself) in the average code base, but often you’ll need to throw an exception with the semantics and data that gives a developer a fairer chance of figuring out why a method couldn’t complete its intended purpose.</p>

<p>The exception in the solution is <code>DeploymentValidationException</code>, which indicates a problem related to the deployment process during the validation phase. It derives from <code>Exception</code>. Depending on how extensive your custom exception framework is, you could create your own base exception for a hierarchy and classify a derived exception tree from that. The benefit is that you would have flexibility in catch blocks to catch more general or specific exceptions as necessary. That said, if you only need a couple of custom exceptions, the extra design work of an exception hierarchy might be overkill.</p>

<p>The first three constructors mirror the <code>Exception</code> class options for message and inner exception. You’ll also want custom constructors for instantiating with your custom data.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>In the past, there’s been discussion of whether a custom exception should derive from <code>Exception</code> or <code>ApplicationException</code>, where <code>Exception</code> was for .NET-type hierarchies and <code>ApplicationException</code> was for custom exception hierarchies. However, the distinction blurred over time with some .NET Framework types deriving from both with no apparent consistency or reason. So, deriving from <code>Exception</code> seems to be fine these days.</p>
</div>

<p><code>DeploymentValidationException</code> has a property, of the enum type <code>Validation​Fai⁠lureReason</code>. Besides having semantics unique to the reason for throwing an exception, another purpose of a custom exception is to include important information for exception handling and/or debugging.</p>

<p>Overriding <code>ToString</code> is also a good idea. Logging frameworks might just receive the <code>Exception</code> reference, resulting in a call to <code>ToString</code>. As in this example, you’ll want to ensure your custom data gets included in the string output. This ensures people can read the full state of the exception, along with the stack trace.</p>

<p>The <code>Program</code> <code>Main</code> method demonstrates how nice it is to be able to handle the specific type, rather than another type that might not fit or the general <code>Exception</code> class.<a data-type="indexterm" data-startref="ix_ch01-asciidoc37" id="idm45678808705408"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc36" id="idm45678808704672"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc35" id="idm45678808704000"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="1.10 Constructing Objects with Complex Configuration"><div class="sect1" id="constructing_objects_with_complex_configuration">
<h1>1.10 Constructing Objects with Complex Configuration</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45678808701680">
<h2>Problem</h2>

<p><a data-type="indexterm" data-primary="objects" data-secondary="with complex configuration" data-secondary-sortas="complex" id="ix_ch01-asciidoc38"/><a data-type="indexterm" data-primary="types" data-secondary="constructing objects with complex configuration" id="ix_ch01-asciidoc39"/>You need to build a new type with complex configuration options without an unnecessary expansion of constructors.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45678808697168">
<h2>Solution</h2>

<p>Here’s the <code>DeploymentService</code> class we want to build:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">DeploymentService</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">int</code> <code class="n">StartDelay</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code> <code class="p">=</code> <code class="m">2000</code><code class="p">;</code>
    <code class="k">public</code> <code class="kt">int</code> <code class="n">ErrorRetries</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code> <code class="p">=</code> <code class="m">5</code><code class="p">;</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">ReportFormat</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code> <code class="p">=</code> <code class="s">"pdf"</code><code class="p">;</code>

    <code class="k">public</code> <code class="k">void</code> <code class="nf">Start</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code>
            <code class="err">$</code><code class="s">"Deployment started with:\n"</code> <code class="p">+</code>
            <code class="err">$</code><code class="s">"    Start Delay:   {StartDelay}\n"</code> <code class="p">+</code>
            <code class="err">$</code><code class="s">"    Error Retries: {ErrorRetries}\n"</code> <code class="p">+</code>
            <code class="err">$</code><code class="s">"    Report Format: {ReportFormat}"</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>This is the class that builds the <code>DeploymentService</code> instance:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">public</code> <code class="k">class</code> <code class="nc">DeploymentBuilder</code>
<code class="p">{</code>
    <code class="n">DeploymentService</code> <code class="n">service</code> <code class="p">=</code> <code class="k">new</code> <code class="n">DeploymentService</code><code class="p">();</code>

    <code class="k">public</code> <code class="n">DeploymentBuilder</code> <code class="nf">SetStartDelay</code><code class="p">(</code><code class="kt">int</code> <code class="n">delay</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">service</code><code class="p">.</code><code class="n">StartDelay</code> <code class="p">=</code> <code class="n">delay</code><code class="p">;</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="n">DeploymentBuilder</code> <code class="nf">SetErrorRetries</code><code class="p">(</code><code class="kt">int</code> <code class="n">retries</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">service</code><code class="p">.</code><code class="n">ErrorRetries</code> <code class="p">=</code> <code class="n">retries</code><code class="p">;</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="n">DeploymentBuilder</code> <code class="nf">SetReportFormat</code><code class="p">(</code><code class="kt">string</code> <code class="n">format</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">service</code><code class="p">.</code><code class="n">ReportFormat</code> <code class="p">=</code> <code class="n">format</code><code class="p">;</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="n">DeploymentService</code> <code class="nf">Build</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="n">service</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>Here’s how to use the <code>DeploymentBuilder</code> class:</p>

<pre data-type="programlisting" data-code-language="csharp"><code class="k">class</code> <code class="nc">Program</code>
<code class="p">{</code>
    <code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">DeploymentService</code> <code class="n">service</code> <code class="p">=</code>
            <code class="k">new</code> <code class="nf">DeploymentBuilder</code><code class="p">()</code>
                <code class="p">.</code><code class="n">SetStartDelay</code><code class="p">(</code><code class="m">3000</code><code class="p">)</code>
                <code class="p">.</code><code class="n">SetErrorRetries</code><code class="p">(</code><code class="m">3</code><code class="p">)</code>
                <code class="p">.</code><code class="n">SetReportFormat</code><code class="p">(</code><code class="s">"html"</code><code class="p">)</code>
                <code class="p">.</code><code class="n">Build</code><code class="p">();</code>

        <code class="n">service</code><code class="p">.</code><code class="n">Start</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">}</code></pre>
</div></section>













<section data-type="sect2" class="pagebreak-before less_space" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45678804075728">
<h2>Discussion</h2>

<p>In <a data-type="xref" href="#designing_a_custom_exception">Recipe 1.9</a>, the <code>DeploymentValidationException</code> class has multiple constructors. Normally, this isn’t a problem. The first three constructors are a typical convention for exception classes. Subsequent constructors add new parameters for initializing new fields.</p>

<p>However, what if the class you were designing had a lot of options and there was a strong possibility that new features would require new options? Further, developers will want to pick and choose what options to configure the class with. Imagine the exponential explosion of new constructors for every new option added to the class. In such a scenario, constructors are practically useless. The builder pattern can solve this problem.</p>

<p>An example of an object that implements the builder pattern is the ASP.NET <code>ConfigSettings</code>. Another is the <code>ServiceCollection</code> from <a data-type="xref" href="#removing_explicit_dependencies">Recipe 1.2</a>—the code isn’t entirely written in a fluid manner, but it could be because it follows the builder pattern.</p>

<p>The Solution has a <code>DeploymentService</code> class, which is what we want to build. Its properties have default values in case a developer doesn’t configure a given value. In general terms, the class that the builder creates will also have other methods and members for its intended purpose.</p>

<p>The <code>DeploymentBuilder</code> class implements the builder pattern. Notice that all of the methods, except for <code>Build</code>, return the same instance (<code>this</code>) of the same type, <code>DeploymentBuilder</code>. They also use the parameter to configure the <code>DeploymentService</code> field that was instantiated with the <code>DeploymentBuilder</code> instance. The <code>Build</code> method returns the <code>DeploymentService</code> instance.</p>

<p>How the configuration and instantiation occur are implementation details of the <code>DeploymentBuilder</code> that you can vary as needed. You can also accept any parameter type you need and perform the configuration. Also, you can collect configuration data and only instantiate the target class when the <code>Build</code> method runs. Another advantage is that the order in which parameters are set is irrelevant. You have all the flexibility to design the internals of the builder for what makes sense to you.</p>

<p>Finally, notice how the <code>Main</code> method instantiates <code>DeploymentBuilder</code>, uses its fluent interface for configuration, and calls <code>Build</code> to return the <code>DeploymentService</code> instance. This example used every method, but that wasn’t required because you have the option to use some, none, or all.<a data-type="indexterm" data-startref="ix_ch01-asciidoc39" id="idm45678804022832"/><a data-type="indexterm" data-startref="ix_ch01-asciidoc38" id="idm45678804022224"/><a data-type="indexterm" data-primary="data" data-secondary="manipulating" data-see="manipulating data" id="idm45678804021616"/><a data-type="indexterm" data-primary="DLR" data-see="dynamic language runtime" id="idm45678804020400"/><a data-type="indexterm" data-primary="programming asynchronously" data-see="asynchronous programming" id="idm45678804019488"/><a data-type="indexterm" data-primary="queries" data-see="LINQ, querying with" id="idm45678804018560"/><a data-type="indexterm" data-primary="simplifying code" data-see="code simplification" id="idm45678804017616"/><a data-type="indexterm" data-primary="textual data" data-see="strings" id="idm45678804016672"/><a data-type="indexterm" data-primary="troubleshooting" data-see="exception entries" id="idm45678804015728"/><a data-type="indexterm" data-primary="validation" data-see="parameter validation" id="idm45678804014784"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45678804013840">
<h2>See Also</h2>

<p><a data-type="xref" data-xrefstyle="rec-num-title" href="#removing_explicit_dependencies">Recipe 1.2, “Removing Explicit Dependencies”</a></p>

<p><a data-type="xref" data-xrefstyle="rec-num-title" href="#designing_a_custom_exception">Recipe 1.9, “Designing a Custom Exception”</a></p>
</div></section>





</div></section>







</div></section></div></body></html>