<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 3. Types" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch_types">
<h1><span class="label">Chapter 3. </span>Types</h1>
<p><a data-primary="types" data-seealso="specific types" data-type="indexterm" id="ix_ch03-asciidoc0"/>C# does not limit us to the built-in data types shown in <a data-type="xref" href="ch02.xhtml#ch_basic_coding">Chapter 2</a>. You can define your own types. In fact, you have no choice: if you want to write code at all, C# requires that code to be inside a type. Everything we write, and any functionality we consume from the .NET runtime libraries (or any other .NET library), will belong to a type.</p>
<p>C# recognizes multiple kinds of types. I’ll begin with the most important.</p>
<section data-pdf-bookmark="Classes" data-type="sect1"><div class="sect1" id="classes-id00004">
<h1>Classes</h1>
<p><a data-primary="classes" data-type="indexterm" id="ix_ch03-asciidoc1"/><a data-primary="types" data-secondary="classes" data-type="indexterm" id="ix_ch03-asciidoc2"/><a data-primary="private members" data-type="indexterm" id="ch03-privmembr"/><a data-primary="public types" data-type="indexterm" id="ch03-privmembr2"/>Most of the types you work with in C# will be <em>classes</em>. A class can contain both code and data, and it can choose to make some of its features publicly available while keeping others accessible only to code within the class. <a data-primary="encapsulation" data-type="indexterm" id="idm45884854637408"/>So classes offer a mechanism for <em>encapsulation</em>—they can define a clear public programming interface for other people to use while keeping internal implementation details inaccessible.</p>
<p>If you’re familiar with object-oriented languages, this will all seem very ordinary. If you’re not, then you might want to read a more introductory-level book first, because this book is not meant to teach programming. I’ll just describe the details specific to C# classes.</p>
<p>I’ve already shown examples of classes in earlier chapters, but let’s look at the structure in more detail. <a data-type="xref" href="#simple_class">Example 3-1</a> shows a simple class. (See the sidebar <a data-type="xref" href="#naming_conventions">“Naming Conventions”</a> for information about names for types and their members.)</p>
<div data-type="example" id="simple_class">
<h5><span class="label">Example 3-1. </span>A simple class</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">class</code> <code class="nc">Counter</code>
<code class="p">{</code>
    <code class="k">private</code> <code class="kt">int</code> <code class="n">_count</code><code class="p">;</code>

    <code class="k">public</code> <code class="kt">int</code> <code class="nf">GetNextValue</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">_count</code> <code class="p">+=</code> <code class="m">1</code><code class="p">;</code>
        <code class="k">return</code> <code class="n">_count</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>Class definitions always contain the <code>class</code> keyword followed by the name of the class. C# does not require the name to match the containing file, nor does it limit you to having one class in a file. That said, most C# projects make the class and filenames match by convention. In any case, class names must follow the basic rules described in <a data-type="xref" href="ch02.xhtml#ch_basic_coding">Chapter 2</a> for identifiers such as variables; e.g., they cannot start with a number.</p>
<p>The first line of <a data-type="xref" href="#simple_class">Example 3-1</a> contains an additional keyword: <code>public</code>. <a data-primary="accessibility" data-secondary="class definitions and" data-type="indexterm" id="idm45884854613184"/>Class definitions can optionally specify <em>accessibility</em>, which determines what other code is allowed to use the class. <a data-primary="internal types" data-type="indexterm" id="idm45884854611664"/>Ordinary classes have just two choices here: <code>public</code> and <code>internal</code>, with the latter being the default. (As I’ll show later, you can nest classes inside other types, and nested classes have a slightly wider range of accessibility options.) An internal class is available for use only within the component that defines it. So if you are writing a class library, you are free to define classes that exist purely as part of your library’s implementation: by marking them as <code>internal</code>, you prevent the rest of the world from using them.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>You can choose to make your internal types visible to selected external components. Microsoft sometimes does this with its libraries. The runtime libraries are spread across numerous DLLs, each of which defines many internal types, but some internal features are used by other DLLs in the library. This is made possible by annotating a component with the <code>[assembly: Int⁠ern⁠als​Vis⁠ibl⁠eTo("<em>name</em>")]</code> attribute, specifying the name of the component with which you wish to share. (<a data-type="xref" href="ch14.xhtml#ch_attributes">Chapter 14</a> describes this in more detail.) For example, you might want to make every class in your application visible to a test project so that you can write unit tests for code that you don’t intend to make publicly available.</p>
</div>
<p>The <code>Counter</code> class in <a data-type="xref" href="#simple_class">Example 3-1</a> has chosen to be <code>public</code>, but that doesn’t mean it has to make everything accessible. It defines two members—a field called <code>_count</code> that holds an <code>int</code> and a method called <code>GetNextValue</code> that operates on the information in that field. (The CLR will automatically initialize this field to 0 when a <code>Counter</code> is created.) As you can see, both of these members have accessibility qualifiers too. As is very common with object-oriented programming, this class has chosen to make the data member private, exposing public functionality through a method.</p>
<p>Accessibility modifiers are optional for members, just as they are for classes, and again, they default to the most restrictive option available: <code>private</code>, in this case. So I could have left off the <code>private</code> keyword in <a data-type="xref" href="#simple_class">Example 3-1</a> without changing the meaning, but I prefer to be explicit. (If you leave it unspecified, people reading your code may wonder whether the omission was deliberate or accidental.)</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="naming_conventions">
<h5>Naming Conventions</h5>
<p><a data-primary="classes" data-secondary="naming conventions" data-type="indexterm" id="idm45884854564416"/><a data-primary="naming conventions" data-type="indexterm" id="idm45884854563440"/>Microsoft defines a set of conventions for publicly visible identifiers, which it (mostly) conforms to in its class libraries, and I usually follow them in my examples. <a data-primary="code analyzers" data-type="indexterm" id="idm45884854562448"/>The .NET SDK incorporates a code analyzer that can help enforce these conventions. It is enabled by default. If you just want to read a description of the rules, they’re part of the <a href="https://oreil.ly/Ol2OS">design guidelines for .NET class libraries</a>.</p>
<p><a data-primary="Pascal casing" data-type="indexterm" id="idm45884854560704"/>In these conventions, the first letter of a class name is capitalized, and if the name contains multiple words, each new word also starts with a capital letter. (For historical reasons, this convention is called <em>Pascal casing</em>, or sometimes <em>PascalCasing</em> as a self-referential example.) Although it’s legal in C# for identifiers to contain underscores, the conventions don’t allow them in class names. Methods also use Pascal casing, as do properties. Fields are rarely public, but when they are, they use the same casing.</p>
<p>Method parameters use a different convention known as <em>camelCasing</em>, in which uppercase letters are used at the start of all but the first word. The name refers to the way this convention produces one or more humps in the middle of the word.</p>
<p>The class library design guidelines remain silent regarding implementation details. (The original purpose of these rules was to ensure a consistent feel across the whole public API of the .NET runtime libraries.) So these rules say nothing about how private fields are named. I’ve used an underscore prefix in <a data-type="xref" href="#simple_class">Example 3-1</a> because I like fields to look different from local variables. This makes it easy to see what sort of data my code is working with, and it can also help to avoid situations where method parameter names clash with field names. (Microsoft often uses this same convention for instance fields in the .NET runtime libraries, along with <code>s_</code> and <code>t_</code> prefixes for static and thread-local fields.) <a data-primary="this reference" data-type="indexterm" id="idm45884854555296"/>Some people find this convention ugly and prefer not to distinguish fields visibly but might choose to always access members through the <code>this</code> reference (described later) so that the distinction between variable and field access is still clear.</p>
</div></aside>
<p>Fields hold data. They are a kind of variable, but unlike a local variable, whose scope and lifetime is determined by its containing method, a field is tied to its containing type. <a data-type="xref" href="#simple_class">Example 3-1</a> is able to refer to the <code>_count</code> field by its unqualified name because fields are in scope within their defining class. But what about the lifetime? We know that each invocation of a method gets its own set of local variables. How many sets of a class’s fields are there? There are a couple of possibilities, depending on how you define the field, and in this case, it’s one per instance. <a data-type="xref" href="#using_a_custom_class">Example 3-2</a> uses the <code>Counter</code> class from <a data-type="xref" href="#simple_class">Example 3-1</a> to illustrate this.</p>
<div data-type="example" id="using_a_custom_class">
<h5><span class="label">Example 3-2. </span>Using a custom class</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">c1</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Counter</code><code class="p">();</code>
<code class="kt">var</code> <code class="n">c2</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Counter</code><code class="p">();</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"c1: "</code> <code class="p">+</code> <code class="n">c1</code><code class="p">.</code><code class="n">GetNextValue</code><code class="p">());</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"c1: "</code> <code class="p">+</code> <code class="n">c1</code><code class="p">.</code><code class="n">GetNextValue</code><code class="p">());</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"c1: "</code> <code class="p">+</code> <code class="n">c1</code><code class="p">.</code><code class="n">GetNextValue</code><code class="p">());</code>

<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"c2: "</code> <code class="p">+</code> <code class="n">c2</code><code class="p">.</code><code class="n">GetNextValue</code><code class="p">());</code>

<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"c1: "</code> <code class="p">+</code> <code class="n">c1</code><code class="p">.</code><code class="n">GetNextValue</code><code class="p">());</code></pre></div>
<p>This uses the <code>new</code> operator to create new instances of my class. Since I use <code>new</code> twice, I get two <code>Counter</code> objects, and each has its own <code>_count</code> field. So we get two independent counts, as the program’s output shows:</p>
<pre data-type="programlisting">c1: 1
c1: 2
c1: 3
c2: 1
c1: 4</pre>
<p>As you’d expect, it begins counting up, and then a new sequence starts at 1 when we switch to the second counter. But when we go back to the first counter, it carries on from where it left off. This demonstrates that each instance has its own <code>_count</code>. But what if we don’t want that? Sometimes you will want to keep track of information that doesn’t relate to any single object.</p>
<section data-pdf-bookmark="Static Members" data-type="sect2"><div class="sect2" id="static_members">
<h2>Static Members</h2>
<p><a data-primary="classes" data-secondary="static members" data-type="indexterm" id="ix_ch03-asciidoc3"/><a data-primary="static members" data-type="indexterm" id="ix_ch03-asciidoc4"/>The <code>static</code> keyword lets us declare that a member is not associated with any particular instance of the class. <a data-type="xref" href="#class_with_static_members">Example 3-3</a> shows a modified version of the <code>Counter</code> class from <a data-type="xref" href="#simple_class">Example 3-1</a>. I’ve added two new members, both static, for tracking and reporting counts across all instances.</p>
<div data-type="example" id="class_with_static_members">
<h5><span class="label">Example 3-3. </span>Class with static members</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code><code> </code><code class="k">class</code><code> </code><code class="nc">Counter</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">private</code><code> </code><code class="kt">int</code><code> </code><code class="n">_count</code><code class="p">;</code><code>
</code><code>    </code><strong><code class="k">private</code><code> </code><code class="k">static</code><code> </code><code class="kt">int</code><code> </code><code class="n">_totalCount</code><code class="p">;</code></strong><code>
</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="kt">int</code><code> </code><code class="nf">GetNextValue</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="n">_count</code><code> </code><code class="p">+</code><code class="p">=</code><code> </code><code class="m">1</code><code class="p">;</code><code>
</code><code>        </code><strong><code class="n">_totalCount</code><code> </code><code class="p">+</code><code class="p">=</code><code> </code><code class="m">1</code><code class="p">;</code></strong><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">_count</code><code class="p">;</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code>
</code><code>    </code><strong><code class="k">public</code><code> </code><code class="k">static</code><code> </code><code class="kt">int</code><code> </code><code class="n">TotalCount</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">_totalCount</code><code class="p">;</code></strong><code>
</code><code class="p">}</code></pre></div>
<p><code>TotalCount</code> reports the count, but it doesn’t do any work—it just returns a value that the class keeps up to date, and as I’ll explain in <a data-type="xref" href="#properties">“Properties”</a>, this makes it an ideal candidate for being a property rather than a method. The static field <code>_totalCount</code> keeps track of the total number of calls to <code>GetNextValue</code>, unlike the nonstatic <code>_count</code>, which just tracks calls to the current instance.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><a data-primary="=&gt; syntax" data-secondary="TotalCount property" data-type="indexterm" id="idm45884854375824"/>The <code>=&gt;</code> syntax in the <code>TotalCount</code> property lets us define the property with a single expression—in this case, whenever code reads the <code>Counter.TotalCount</code> property, the result will be the value of the <code>_totalCount</code> field. As we’ll see later, there are ways to write more complex properties, but this is a common approach for simple, read-only properties.</p>
</div>
<p>Notice that I’m free to use that static field inside <code>GetNextValue</code> in exactly the same way as I use the nonstatic <code>_count</code>. The difference in behavior is clear if I add the line of code shown in <a data-type="xref" href="#using_a_static_property">Example 3-4</a> to the end of the code in <a data-type="xref" href="#using_a_custom_class">Example 3-2</a>.</p>
<div data-type="example" id="using_a_static_property">
<h5><span class="label">Example 3-4. </span>Using a static property</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">Counter</code><code class="p">.</code><code class="n">TotalCount</code><code class="p">);</code></pre></div>
<p>This line displays 5, the sum of the two counts. To access a static member, I just write <code><em>ClassName</em>.<em>MemberName</em></code>. In fact, <a data-type="xref" href="#using_a_static_property">Example 3-4</a> uses two static members—as well as my class’s <code>TotalCount</code> property, it uses the <code>Console</code> class’s static <code>WriteLine</code> method.</p>
<p>Because I’ve declared <code>TotalCount</code> as a static property, the code it contains has access only to other static members. If it tried to use the nonstatic <code>_count</code> field or call the nonstatic <code>GetNextValue</code> method, the compiler would complain. Replacing <code>_totalCount</code> with <code>_count</code> in the <code>TotalCount</code> property results in this error:</p>
<pre data-type="programlisting">error CS0120: An object reference is required for the non-static field, method,
 or property Counter._count'</pre>
<p>Since nonstatic fields are associated with a particular instance of a class, C# needs to know which instance to use. With a nonstatic method or property, that’ll be whichever instance the method or property itself was invoked on. So in <a data-type="xref" href="#using_a_custom_class">Example 3-2</a>, I wrote either <code>c1.GetNextValue()</code> or <code>c2.GetNextValue()</code> to choose which of my two objects to use. C# passed the reference stored in either <code>c1</code> or <code>c2</code>, respectively, as an implicit hidden first argument. <a data-primary="this reference" data-type="indexterm" id="idm45884854312768"/>You can get hold of that reference from code inside a class by using the <code>this</code> keyword. <a data-type="xref" href="#this_keyword">Example 3-5</a> shows an alternative way we could have written the first line of <code>GetNextValue</code> from <a data-type="xref" href="#class_with_static_members">Example 3-3</a>, indicating explicitly that we believe <code>_count</code> is a member of the instance on which the <code>GetNextValue</code> method was invoked.</p>
<div data-type="example" id="this_keyword">
<h5><span class="label">Example 3-5. </span>The <code>this</code> keyword</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">this</code><code class="p">.</code><code class="n">_count</code> <code class="p">+=</code> <code class="m">1</code><code class="p">;</code></pre></div>
<p>Explicit member access through <code>this</code> is sometimes necessary due to name collisions. Although all the members of a class are in scope for any code in the same class, the code in a method does not share a <em>declaration space</em> with the class. Remember from <a data-type="xref" href="ch02.xhtml#ch_basic_coding">Chapter 2</a> that a declaration space is a region of code in which a single name must not refer to two different entities, and since methods do not share theirs with the containing class, you are allowed to declare local variables and method parameters that have the same name as class members. This can easily happen if you don’t use a convention such as an underscore prefix for field names. You don’t get an error in this case—locals and parameters just hide the class members. But you can still get at the class members by qualifying access with <code>this</code>.</p>
<p>Static methods don’t get to use the <code>this</code> keyword, because they are not associated with any particular instance.<a data-startref="ix_ch03-asciidoc4" data-type="indexterm" id="idm45884854303040"/><a data-startref="ix_ch03-asciidoc3" data-type="indexterm" id="idm45884854275744"/><a data-startref="ch03-privmembr" data-type="indexterm" id="idm45884854275072"/><a data-startref="ch03-privmembr2" data-type="indexterm" id="idm45884854274400"/></p>
</div></section>
<section data-pdf-bookmark="Static Classes" data-type="sect2"><div class="sect2" id="static_classes">
<h2>Static Classes</h2>
<p><a data-primary="classes" data-secondary="static classes" data-type="indexterm" id="idm45884854271936"/><a data-primary="static classes" data-type="indexterm" id="idm45884854270960"/>Some classes only provide static members. There are several examples in the <code>Sys⁠tem.​Thr⁠ead⁠ing</code> namespace, which contains various classes that offer multithreading utilities. For example, the <code>Interlocked</code> class provides atomic, lock-free, read-modify-write operations; the <code>LazyInitializer</code> class provides helper methods for performing deferred initialization in a way that guarantees to avoid double initialization in multithreaded environments. These classes provide services only through static methods. It makes no sense to create instances of these types, because there’s no useful per-instance information they could hold.</p>
<p>You can declare that your class is intended to be used this way by putting the <code>static</code> keyword in front of the <code>class</code> keyword. This compiles the class in a way that prevents instances of it from being constructed. Anyone attempting to construct instances of a class designed to be used this way clearly doesn’t understand what it does, so the compiler error will be a useful prod in the direction of the documentation.</p>
<p>You can declare that you want to be able to invoke static methods on certain classes without naming the class every time. This can be useful if you are writing code that makes heavy use of the static methods supplied by a particular type. (This isn’t limited to static classes, by the way. You can use this technique with any class that has static members, but it is likely to be most useful with classes whose members are all static.) <a data-primary="Math class" data-type="indexterm" id="idm45884854266656"/><a data-type="xref" href="#using_static_members_normally">Example 3-6</a> uses a static method (<code>Sin</code>) and a static property (<code>PI</code>) of the <code>Math</code> class (in the <code>System</code> namespace). It also uses the <code>Console</code> class’s static <code>WriteLine</code> method. (I’m showing the entire source file in this and the next example because the <code>using</code> directives are particularly important. The first example doesn’t need a <code>using System;</code> because default implicit global usings make this available everywhere.)</p>
<div data-type="example" id="using_static_members_normally">
<h5><span class="label">Example 3-6. </span>Using static members normally</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">static</code> <code class="k">class</code> <code class="nc">Normal</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">static</code> <code class="k">void</code> <code class="nf">UseStatics</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">Math</code><code class="p">.</code><code class="n">Sin</code><code class="p">(</code><code class="n">Math</code><code class="p">.</code><code class="n">PI</code> <code class="p">/</code> <code class="m">4</code><code class="p">));</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<p><a data-type="xref" href="#using_static_members_without_explicit_qu">Example 3-7</a> is exactly equivalent, but the line that invokes the three static members does not qualify any of them with their defining class’s name.</p>
<div data-type="example" id="using_static_members_without_explicit_qu">
<h5><span class="label">Example 3-7. </span>Using static members without explicit qualification</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">using</code> <code class="nn">static</code> <code class="n">System</code><code class="p">.</code><code class="n">Console</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">static</code> <code class="n">System</code><code class="p">.</code><code class="n">Math</code><code class="p">;</code>

<code class="k">public</code> <code class="k">static</code> <code class="k">class</code> <code class="nc">WithoutQualification</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">static</code> <code class="k">void</code> <code class="nf">UseStatics</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">WriteLine</code><code class="p">(</code><code class="n">Sin</code><code class="p">(</code><code class="n">PI</code> <code class="p">/</code> <code class="m">4</code><code class="p">));</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>To utilize this less verbose alternative, you must declare which classes you want to use in this way with <code>using static</code> directives. Whereas <code>using</code> directives normally specify a namespace, enabling types in that namespace to be used without qualification, <code>using static</code> directives specify a class, enabling its static members to be used without qualification. <a data-primary="C# 10.0" data-secondary="using static directives" data-type="indexterm" id="idm45884854125472"/>By the way, as you saw in <a data-type="xref" href="ch01.xhtml#ch_introducing_csharp">Chapter 1</a>, C# 10.0 lets you add the <code>global</code> keyword to <code>using</code> directives. That works for <code>using static</code> directives too, so if you want, say, the <code>Math</code> type’s static members to be available without qualification in any file in your project, you can write <code>global using static System.Math;</code> in just one file, and it will apply to all of them.</p>
</div></section>
</div></section>
<section data-pdf-bookmark="Records" data-type="sect1"><div class="sect1" id="record_types">
<h1>Records</h1>
<p><a data-primary="record types" data-secondary="about" data-type="indexterm" id="ix_ch03-asciidoc60"/><a data-primary="types" data-secondary="records" data-type="indexterm" id="ix_ch03-asciidoc61"/>Although encapsulation is a powerful tool for managing complexity in software development, it can sometimes be useful to have types that just hold information. We might want to represent a message sent over a network, or a row from a table in a database, for example. Types designed for this are sometimes referred to as <em>POD types</em>, where POD stands for plain old data. We might try to do this by writing a class containing nothing but public fields, as <a data-type="xref" href="#pod_all_public_fields">Example 3-8</a> shows.</p>
<div data-type="example" id="pod_all_public_fields">
<h5><span class="label">Example 3-8. </span>Plain old data, using public fields</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">class</code> <code class="nc">Person</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">string?</code> <code class="n">Name</code><code class="p">;</code>
    <code class="k">public</code> <code class="kt">string?</code> <code class="n">FavoriteColor</code><code class="p">;</code>
<code class="p">}</code></pre></div>
<p>Some developers will recoil in horror at the lack of encapsulation here. There’s nothing to stop anyone from reaching into a <code>Person</code> instance and just changing the fields—oh, the humanity! In a type that was doing anything more than just holding some data, that could indeed cause problems. The type’s methods might contain code that relies on those fields being used in particular ways, and the problem with making fields public is that anything could change them, making it hard to know what state they will be in. But this type has no code—its only job is to hold some data, so this won’t be the end of the world. That said, this example has created a problem: these fields contain strings, but I’ve had to put a <code>?</code> after the type name. This signifies the fact that these fields might contain the special value <code>null</code>. If I don’t add those <code>?</code> qualifiers, the compiler will issue a warning telling me that I’ve done nothing to ensure that these fields are suitably initialized, and so I shouldn’t go around claiming that they are definitely going to contain strings. If I wanted to require that these fields always have non-null values, I’d need to take control of how the type is initialized, which I can do by writing a <em>constructor</em>. I’ll be describing these in more detail later in the chapter, but <a data-type="xref" href="#ctor_enforcing_field_initialization">Example 3-9</a> shows a simple example that ensures that the fields are initialized, enabling us to remove the <code>?</code> qualifiers.</p>
<div data-type="example" id="ctor_enforcing_field_initialization">
<h5><span class="label">Example 3-9. </span>Enforcing initialization of fields with a constructor</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">class</code> <code class="nc">Person</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Name</code><code class="p">;</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">FavoriteColor</code><code class="p">;</code>

    <code class="k">public</code> <code class="nf">Person</code><code class="p">(</code><code class="kt">string</code> <code class="n">name</code><code class="p">,</code> <code class="kt">string</code> <code class="n">favoriteColor</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="n">Name</code> <code class="p">=</code> <code class="n">name</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="n">FavoriteColor</code> <code class="p">=</code> <code class="n">favoriteColor</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>This is now looking rather verbose. Record types offer a much simpler way to write a plain old data type, as <a data-type="xref" href="#record_type_enforcing_initialization">Example 3-10</a> shows.</p>
<div data-type="example" id="record_type_enforcing_initialization">
<h5><span class="label">Example 3-10. </span>A record type with positional syntax</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="n">record</code> <code class="nf">Person</code><code class="p">(</code><code class="kt">string</code> <code class="n">Name</code><code class="p">,</code> <code class="kt">string</code> <code class="n">FavoriteColor</code><code class="p">);</code></pre></div>
<p><a data-type="xref" href="#using_a_record_type">Example 3-11</a> shows how we can use this record type. If we have a variable referring to a <code>Person</code>, like the <code>p</code> argument in the <code>ShowPerson</code> method, we can write <code>p.Name</code> and <code>p.FavoriteColor</code> to access the data it contains, just as we would if <code>Person</code> were defined as in Examples <a data-type="xref" data-xrefstyle="select:labelnumber" href="#pod_all_public_fields">3-8</a> or <a data-type="xref" data-xrefstyle="select:labelnumber" href="#ctor_enforcing_field_initialization">3-9</a>. (My record type isn’t exactly equivalent. Those earlier examples both define public fields, but <a data-type="xref" href="#using_a_record_type">Example 3-11</a> is better aligned with normal .NET practice, because it defines <code>Name</code> and <code>FavoriteColor</code> as properties. I’ll be describing properties in more detail later in this chapter.) As you can see, we create instances of record types with the <code>new</code> keyword, just as we do with a class. When a record type is defined in the way <a data-type="xref" href="#record_type_enforcing_initialization">Example 3-10</a> shows, we have to pass in all of the properties to the constructor, and in the right order. This way of defining a record is called the <em>positional syntax</em>.</p>
<div data-type="example" id="using_a_record_type">
<h5><span class="label">Example 3-11. </span>Using a record type</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">void</code> <code class="nf">ShowPerson</code><code class="p">(</code><code class="n">Person</code> <code class="n">p</code><code class="p">)</code>
<code class="p">{</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"{p.Name}'s favorite color is {p.FavoriteColor}"</code><code class="p">);</code>
<code class="p">}</code>

<code class="kt">var</code> <code class="n">ian</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Person</code><code class="p">(</code><code class="s">"Ian"</code><code class="p">,</code> <code class="s">"Blue"</code><code class="p">);</code>
<code class="kt">var</code> <code class="n">deborah</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Person</code><code class="p">(</code><code class="s">"Deborah"</code><code class="p">,</code> <code class="s">"Green"</code><code class="p">);</code>
<code class="n">ShowPerson</code><code class="p">(</code><code class="n">ian</code><code class="p">);</code>
<code class="n">ShowPerson</code><code class="p">(</code><code class="n">deborah</code><code class="p">);</code></pre></div>
<p>When you use the syntax in <a data-type="xref" href="#record_type_enforcing_initialization">Example 3-10</a>, the resulting record type is immutable: if you wrote code that tried to modify either of the properties of an existing <code>Person</code>, the compiler would report an error. Immutable data types can make it much easier to analyze code, especially multithreaded code, because you can count on them not to change under your feet. This is one of the reasons strings are immutable in .NET. However, before record types were introduced, immutable custom types have typically been inconvenient to work with in C#. For example, if you need to produce some new value that is a modified version of an existing value, you can be in for a lot of tedious work. Whereas the built-in <code>string</code> type provides numerous methods for producing new strings built out of existing strings (e.g., substrings, or conversions to lower- or uppercase), you’re on your own when you write a class.</p>
<p>For example, suppose you are writing an application in which you’ve defined a data type representing the state of someone’s payment account at a particular moment in time. If you define this as an immutable type, then when processing a new transaction, you will need to make a copy that’s identical except for the current balance. Historically, doing this in C# meant you ended up needing to write code to copy over any unchanged data when creating the new instance. The main purpose of record types is to make it much easier to define and use immutable data types, so they offer an easy way to create a copy of an existing instance but with certain properties modified. As <a data-type="xref" href="#modified_copy_of_record_type">Example 3-12</a> shows, you can write <code>with</code> after a record expression, followed by a brace-delimited list of the properties you’d like to change.</p>
<div data-type="example" id="modified_copy_of_record_type">
<h5><span class="label">Example 3-12. </span>Making a modified copy of an immutable record</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">startingRecord</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Person</code><code class="p">(</code><code class="s">"Ian"</code><code class="p">,</code> <code class="s">"Blue"</code><code class="p">);</code>
<code class="kt">var</code> <code class="n">modifiedCopy</code> <code class="p">=</code> <code class="n">startingRecord</code> <code class="n">with</code>
<code class="p">{</code>
    <code class="n">FavoriteColor</code> <code class="p">=</code> <code class="s">"Green"</code>
<code class="p">};</code></pre></div>
<p>In this particular case, our type has only two properties, so this isn’t dramatically better than just writing <code>new Person(startingRecord.Name, "Green")</code>. However, for records with larger numbers of properties, this syntax is much more convenient than rebuilding the whole thing every time.</p>
<p>While records make it much easier to create and use immutable data types, they don’t have to be immutable. <a data-type="xref" href="#mutable_record_type">Example 3-13</a> shows a <code>Person</code> record in which the properties can be modified after construction. (The <code>{ get; set; }</code> syntax indicates that these are auto-implemented properties. I’ll be describing them in more detail later, but they are essentially just simple read/write properties.)</p>
<div data-type="example" id="mutable_record_type">
<h5><span class="label">Example 3-13. </span>A record type with modifiable properties</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="n">record</code> <code class="n">Person</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="nf">Person</code><code class="p">(</code><code class="kt">string</code> <code class="n">name</code><code class="p">,</code> <code class="kt">string</code> <code class="n">favoriteColor</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="n">Name</code> <code class="p">=</code> <code class="n">name</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="n">FavoriteColor</code> <code class="p">=</code> <code class="n">favoriteColor</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="kt">string</code> <code class="n">Name</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">FavoriteColor</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>At this point, we’re very nearly back to what we had in <a data-type="xref" href="#ctor_enforcing_field_initialization">Example 3-9</a>, with the only difference being that <code>Name</code> and <code>FavoriteColor</code> are now properties instead of fields. We could just replace the <code>record</code> keyword in this example with <code>class</code> and it would still compile. So what exactly changes when we make this a <code>record</code>?</p>
<p><a data-primary="ToString method" data-type="indexterm" id="idm45884853761264"/>Although the primary purpose of records is to make it easy to build immutable data types, the <code>record</code> keyword also adds a couple of useful features. In addition to the <code>with</code> syntax for building modified copies, records get built-in support for equality testing and a <code>ToString</code> implementation that reports all of the property values. The equality testing enables you to use the <code>==</code> operator to compare two records, and as long as all their properties have the same values, they are considered to be equal. The same functionality is available through the <code>Equals</code> method. All types provide an <code>Equals</code> method (which I’ll describe in more detail later), and records arrange for this method to provide value-based comparison. You might wonder why record types are special in this regard—wouldn’t <code>Equals</code> work the same way for all types? Not so. Look at <a data-type="xref" href="#comparing_instances">Example 3-14</a>.</p>
<div data-type="example" id="comparing_instances">
<h5><span class="label">Example 3-14. </span>Comparing two instances of a type</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">p1</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Person</code><code class="p">(</code><code class="s">"Ian"</code><code class="p">,</code> <code class="s">"Blue"</code><code class="p">);</code>
<code class="kt">var</code> <code class="n">p2</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Person</code><code class="p">(</code><code class="s">"Ian"</code><code class="p">,</code> <code class="s">"Blue"</code><code class="p">);</code>
<code class="k">if</code> <code class="p">(</code><code class="n">p1</code> <code class="p">==</code> <code class="n">p2</code><code class="p">)</code>
<code class="p">{</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"Equal"</code><code class="p">);</code>
<code class="p">}</code></pre></div>
<p>If you run this against any of the <code>Person</code> types defined in earlier examples as a <code>record</code> type, it will display the text <code>Equal</code>. However, if you were to use the definition of <code>Person</code> in <a data-type="xref" href="#ctor_enforcing_field_initialization">Example 3-9</a> (which defines it as a <code>class</code>), this will not display that message. Even though all the properties have the same value, <code>Equals</code> will report that they are not equal in that case. That’s because the default comparison behavior for classes is identity based: two variables are equal only if they refer to the very same object. When variables refer to two different objects, then even if those objects are of exactly the same type and have all the same property and field values, they are still distinct, and <code>Equals</code> reflects that. You can change this behavior when you write a class, but you have to write your own <code>Equals</code> method. With <code>record</code>, the compiler generates that for you.</p>
<p>The other behavior <code>record</code> gives you is a specialized <code>ToString</code> implementation. All types in .NET offer a <code>ToString</code> method, and you can call this either directly or through some mechanism that invokes it implicitly, such as string interpolation. In types that don’t provide their own <code>ToString</code>, the default implementation just returns the type name, so if you call <code>ToString</code> on the class defined in <a data-type="xref" href="#ctor_enforcing_field_initialization">Example 3-9</a>, it will always return <code>"Person"</code>, no matter what value the members have. Types are free to supply their own <code>ToString</code>, and the compiler does this for you for any record type. So if you call <code>ToString</code> on either of the <code>Person</code> instances created in <a data-type="xref" href="#comparing_instances">Example 3-14</a>, it will return <code>"Person { Name = Ian, FavoriteColor = Blue }"</code>.</p>
<p>You can define records with properties whose types are also record types. <a data-type="xref" href="#nested_records">Example 3-15</a> defines a <code>Person</code> record type, and also a <code>Relation</code> record type to indicate some way in which two people are related.</p>
<div data-type="example" id="nested_records">
<h5><span class="label">Example 3-15. </span>Nested record types</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="n">record</code> <code class="nf">Person</code><code class="p">(</code><code class="kt">string</code> <code class="n">Name</code><code class="p">,</code> <code class="kt">string</code> <code class="n">FavoriteColor</code><code class="p">);</code>
<code class="k">public</code> <code class="n">record</code> <code class="nf">Relation</code><code class="p">(</code><code class="n">Person</code> <code class="n">Subject</code><code class="p">,</code> <code class="n">Person</code> <code class="n">Other</code><code class="p">,</code> <code class="kt">string</code> <code class="n">RelationshipType</code><code class="p">);</code></pre></div>
<p>When you have this sort of composite structure—records within records—both <code>Equals</code> and <code>ToString</code> traverse into nested records. <a data-type="xref" href="#using_nested_records">Example 3-16</a> demonstrates this.</p>
<div data-type="example" id="using_nested_records">
<h5><span class="label">Example 3-16. </span>Using nested record types</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">ian</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Person</code><code class="p">(</code><code class="s">"Ian"</code><code class="p">,</code> <code class="s">"Blue"</code><code class="p">);</code>
<code class="kt">var</code> <code class="n">gina</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Person</code><code class="p">(</code><code class="s">"Gina"</code><code class="p">,</code> <code class="s">"Green"</code><code class="p">);</code>
<code class="kt">var</code> <code class="n">ian2</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Person</code><code class="p">(</code><code class="s">"Ian"</code><code class="p">,</code> <code class="s">"Blue"</code><code class="p">);</code>
<code class="kt">var</code> <code class="n">gina2</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Person</code><code class="p">(</code><code class="s">"Gina"</code><code class="p">,</code> <code class="s">"Green"</code><code class="p">);</code>
<code class="kt">var</code> <code class="n">r1</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Relation</code><code class="p">(</code><code class="n">ian</code><code class="p">,</code> <code class="n">gina</code><code class="p">,</code> <code class="s">"Sister"</code><code class="p">);</code>
<code class="kt">var</code> <code class="n">r2</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Relation</code><code class="p">(</code><code class="n">gina</code><code class="p">,</code> <code class="n">ian</code><code class="p">,</code> <code class="s">"Brother"</code><code class="p">);</code>
<code class="kt">var</code> <code class="n">r3</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Relation</code><code class="p">(</code><code class="n">ian2</code><code class="p">,</code> <code class="n">gina2</code><code class="p">,</code> <code class="s">"Sister"</code><code class="p">);</code>

<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">r1</code><code class="p">);</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">r2</code><code class="p">);</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">r3</code><code class="p">);</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">r1</code> <code class="p">==</code> <code class="n">r2</code><code class="p">);</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">r1</code> <code class="p">==</code> <code class="n">r3</code><code class="p">);</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">r2</code> <code class="p">==</code> <code class="n">r3</code><code class="p">);</code></pre></div>
<p>Running this produces the following output (with lines split up to fit on the page):</p>
<pre data-type="programlisting">Relation { Subject = Person { Name = Ian, FavoriteColor = Blue },
 Other = Person { Name = Gina, FavoriteColor = Green },
 RelationshipType = Sister }
Relation { Subject = Person { Name = Gina, FavoriteColor = Green },
 Other = Person { Name = Ian, FavoriteColor = Blue },
 RelationshipType = Brother }
Relation { Subject = Person { Name = Ian, FavoriteColor = Blue },
 Other = Person { Name = Gina, FavoriteColor = Green },
 RelationshipType = Sister }
False
True
False</pre>
<p>As you can see, the <code>Relation</code> type’s <code>ToString</code> has shown all of the properties of each of its nested <code>Person</code> records (and also the <code>RelationshipType</code> property, which is just a plain <code>string</code>). Likewise, the comparison logic works for nested records. Nothing special is happening here—a record type compares each property in turn by calling <code>Equals</code> on its value for that property, passing in the corresponding property from the record with which it is being compared. So when it happens to reach a record-type property, it calls its <code>Equals</code> method just as it would any other property, at which point that record type’s own <code>Equals</code> implementation will execute, comparing each nested property in turn.</p>
<p>None of the <code>record</code> keyword features I’ve described do anything you couldn’t have done by hand. It would be tedious but uncomplicated to write equivalent implementations of <code>ToString</code> and <code>Equals</code> by hand. (The compiler also provides implementations of the <code>==</code> and <code>!=</code> operators and methods called <code>GetHashCode</code> and <code>Deconstruct</code> that I’ll be describing later. But you could write all of those by hand too.) And as far as the .NET runtime is concerned, there’s nothing special about record types—it just sees them as ordinary classes.</p>
<p>Record types are a language-level feature. The C# compiler generates these types in such a way that it can recognize when types in external libraries were declared as records,<sup><a data-type="noteref" href="ch03.xhtml#idm45884853473568" id="idm45884853473568-marker">1</a></sup> but they are essentially just classes for which the compiler generates a few extra members. In fact, you can be explicit about this by declaring the type as <code>record class</code> instead of just <code>record</code>—these two syntaxes are equivalent.<a data-startref="ix_ch03-asciidoc60" data-type="indexterm" id="idm45884853416400"/><a data-startref="ix_ch03-asciidoc61" data-type="indexterm" id="idm45884853415696"/></p>
</div></section>
<section data-pdf-bookmark="References and Nulls" data-type="sect1"><div class="sect1" id="reference_types">
<h1>References and Nulls</h1>
<p><a data-primary="types" data-secondary="references and nulls" data-type="indexterm" id="ix_ch03-asciidoc62"/><a data-primary="classes" data-secondary="reference types" data-type="indexterm" id="ix_ch03-asciidoc5"/><a data-primary="reference types" data-type="indexterm" id="ix_ch03-asciidoc6"/>Any type defined with <a data-primary="class keyword, reference types and" data-type="indexterm" id="idm45884853409200"/>the <code>class</code> keyword will be a <em>reference type</em> (as will any type declared as <code>record</code>, or the equivalent <code>record class</code>). A variable of any reference type will not contain the data that makes up an instance of the type; instead, it can contain a <em>reference</em> to an instance of the type. Consequently, assignments don’t copy the object; they just copy the reference. <a data-type="xref" href="#copying_references">Example 3-17</a> contains almost the same code as <a data-type="xref" href="#using_a_custom_class">Example 3-2</a>, except instead of using the <code>new</code> keyword to initialize the <code>c2</code> variable, it initializes it with a copy of <code>c1</code>.</p>
<div class="less_space pagebreak-before" data-type="example" id="copying_references">
<h5><span class="label">Example 3-17. </span>Copying references</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">Counter</code><code> </code><code class="n">c1</code><code> </code><code class="p">=</code><code> </code><code class="k">new</code><code> </code><code class="n">Counter</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><strong><code class="kt">var</code><code> </code><code class="n">c2</code><code> </code><code class="p">=</code><code> </code><code class="n">c1</code><code class="p">;</code></strong><code>
</code><code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"c1: "</code><code> </code><code class="p">+</code><code> </code><code class="n">c1</code><code class="p">.</code><code class="n">GetNextValue</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"c1: "</code><code> </code><code class="p">+</code><code> </code><code class="n">c1</code><code class="p">.</code><code class="n">GetNextValue</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"c1: "</code><code> </code><code class="p">+</code><code> </code><code class="n">c1</code><code class="p">.</code><code class="n">GetNextValue</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"c2: "</code><code> </code><code class="p">+</code><code> </code><code class="n">c2</code><code class="p">.</code><code class="n">GetNextValue</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"c1: "</code><code> </code><code class="p">+</code><code> </code><code class="n">c1</code><code class="p">.</code><code class="n">GetNextValue</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code></pre></div>
<p>Because this example uses <code>new</code> just once, there is only one <code>Counter</code> instance, and the two variables both refer to this same instance. So we get different output:</p>
<pre data-type="programlisting">c1: 1
c1: 2
c1: 3
c2: 4
c1: 5</pre>
<p>It’s not just locals that do this—if you use a reference type for any other kind of variable, such as a field or property, assignment works the same way, copying the reference and not the whole object. This is the defining characteristic of a reference type, and it is different from the behavior we saw with the built-in numeric types in <a data-type="xref" href="ch02.xhtml#ch_basic_coding">Chapter 2</a>. With those, each variable contains a value, not a reference to a value, so assignment necessarily involves copying the value. (This value-copying behavior is not available for most reference types—see the next sidebar, <a href="#copying_instances">“Copying Instances”</a>.)</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="copying_instances">
<h5>Copying Instances</h5>
<p><a data-primary="class instances, copying" data-type="indexterm" id="idm45884853318336"/><a data-primary="copying" data-secondary="class instances" data-type="indexterm" id="idm45884853317568"/><a data-primary="instances, copying" data-type="indexterm" id="idm45884853316624"/>Some C-family languages define a standard way to make a copy of an object. For example, in C++ you can write a copy constructor, and you can overload the assignment operator; the language has rules for how these are applied when duplicating an object. In C#, some types can be copied, such as the built-in numeric types. <a data-primary="structs" data-secondary="copying" data-type="indexterm" id="idm45884853315824"/>Later in this chapter you’ll see how to define a <em>struct</em>, which is a custom value type, and these can always be copied. There is no way to customize this process for value types: assignment just copies all the fields, and if any fields are of reference type, this just copies the reference. This is sometimes called a <em>shallow</em> copy, because it copies only the contents of the struct; it does not make copies of any of the things the struct refers to.  Records can always be copied through the <code>with</code> syntax. The compiler enables this by generating a constructor that performs a shallow copy in any <code>record</code> or <code>record class</code>, although when I come to describe <em>constructors</em> I’ll show how you can customize this.</p>
<p>Although certain types get special copying behavior, there is no general mechanism for making a copy of a class instance. <a data-primary="ICloneable interface" data-type="indexterm" id="idm45884853272608"/>The runtime libraries define <code>ICloneable</code>, an interface for duplicating objects, but this is not widely supported. It’s a problematic API, because it doesn’t specify how to handle objects with references to other objects. Should a clone also duplicate the objects to which it refers (a deep copy) or just copy the references (a shallow copy)? In practice, classes that wish to allow themselves to be copied often just provide an ad hoc method for the job, rather than conforming to any pattern.</p>
</div></aside>
<p>We can write code that detects whether two references refer to the same thing. <a data-type="xref" href="#comparing_references">Example 3-18</a> arranges for three variables to refer to two counters with the same count, and then compares their identities. <a data-primary="== (equal)" data-type="indexterm" id="idm45884853269616"/>By default, the <code>==</code> operator does exactly this sort of object identity comparison when its operands are reference types. However, types are allowed to redefine the <code>==</code> operator. The <code>string</code> type changes <code>==</code> to perform value comparisons, so if you pass two distinct string objects as the operands of <code>==</code>, the result will be true if they contain identical text. <a data-primary="ReferenceEquals method" data-type="indexterm" id="idm45884853266560"/>If you want to force comparison of object identity, you can use the static <code>object.ReferenceEquals</code> method.</p>
<div data-type="example" id="comparing_references">
<h5><span class="label">Example 3-18. </span>Comparing references</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">c1</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Counter</code><code class="p">();</code>
<code class="n">c1</code><code class="p">.</code><code class="n">GetNextValue</code><code class="p">();</code>
<code class="n">Counter</code> <code class="n">c2</code> <code class="p">=</code> <code class="n">c1</code><code class="p">;</code>
<code class="kt">var</code> <code class="n">c3</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Counter</code><code class="p">();</code>
<code class="n">c3</code><code class="p">.</code><code class="n">GetNextValue</code><code class="p">();</code>

<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">c1</code><code class="p">.</code><code class="n">Count</code><code class="p">);</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">c2</code><code class="p">.</code><code class="n">Count</code><code class="p">);</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">c3</code><code class="p">.</code><code class="n">Count</code><code class="p">);</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">c1</code> <code class="p">==</code> <code class="n">c2</code><code class="p">);</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">c1</code> <code class="p">==</code> <code class="n">c3</code><code class="p">);</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">c2</code> <code class="p">==</code> <code class="n">c3</code><code class="p">);</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="kt">object</code><code class="p">.</code><code class="n">ReferenceEquals</code><code class="p">(</code><code class="n">c1</code><code class="p">,</code> <code class="n">c2</code><code class="p">));</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="kt">object</code><code class="p">.</code><code class="n">ReferenceEquals</code><code class="p">(</code><code class="n">c1</code><code class="p">,</code> <code class="n">c3</code><code class="p">));</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="kt">object</code><code class="p">.</code><code class="n">ReferenceEquals</code><code class="p">(</code><code class="n">c2</code><code class="p">,</code> <code class="n">c3</code><code class="p">));</code></pre></div>
<p>The first three lines of output confirm that all three variables refer to counters with the same count:</p>
<pre data-type="programlisting">1
1
1
True
False
False
True
False
False</pre>
<p>It also illustrates that while they all have the same count, only <code>c1</code> and <code>c2</code> are considered to be the same thing. That’s because we assigned <code>c1</code> into <code>c2</code>, meaning that <code>c1</code> and <code>c2</code> will both refer to the same object, which is why the first comparison succeeds. But <code>c3</code> refers to a different object entirely (even though it happens to have the same value), which is why the second comparison fails. (I’ve used both the <code>==</code> and <code>object.ReferenceEquals</code> comparisons here to illustrate that they do the same thing in this case, because <code>Counter</code> has not defined a custom meaning for <code>==</code>.)</p>
<p>We could try the same thing with <code>int</code> instead of a <code>Counter</code>, as <a data-type="xref" href="#comparing_values">Example 3-19</a> shows. (This initializes the variables in a slightly idiosyncratic way in order to resemble <a data-type="xref" href="#comparing_references">Example 3-18</a> as closely as possible.)</p>
<div data-type="example" id="comparing_values">
<h5><span class="label">Example 3-19. </span>Comparing values</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">int</code> <code class="n">c1</code> <code class="p">=</code> <code class="k">new</code> <code class="kt">int</code><code class="p">();</code>
<code class="n">c1</code><code class="p">++;</code>
<code class="kt">int</code> <code class="n">c2</code> <code class="p">=</code> <code class="n">c1</code><code class="p">;</code>
<code class="kt">int</code> <code class="n">c3</code> <code class="p">=</code> <code class="k">new</code> <code class="kt">int</code><code class="p">();</code>
<code class="n">c3</code><code class="p">++;</code>

<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">c1</code><code class="p">);</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">c2</code><code class="p">);</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">c3</code><code class="p">);</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">c1</code> <code class="p">==</code> <code class="n">c2</code><code class="p">);</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">c1</code> <code class="p">==</code> <code class="n">c3</code><code class="p">);</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">c2</code> <code class="p">==</code> <code class="n">c3</code><code class="p">);</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="kt">object</code><code class="p">.</code><code class="n">ReferenceEquals</code><code class="p">(</code><code class="n">c1</code><code class="p">,</code> <code class="n">c2</code><code class="p">));</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="kt">object</code><code class="p">.</code><code class="n">ReferenceEquals</code><code class="p">(</code><code class="n">c1</code><code class="p">,</code> <code class="n">c3</code><code class="p">));</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="kt">object</code><code class="p">.</code><code class="n">ReferenceEquals</code><code class="p">(</code><code class="n">c2</code><code class="p">,</code> <code class="n">c3</code><code class="p">));</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="kt">object</code><code class="p">.</code><code class="n">ReferenceEquals</code><code class="p">(</code><code class="n">c1</code><code class="p">,</code> <code class="n">c1</code><code class="p">));</code></pre></div>
<p>As before, we can see that all three variables have the same value:</p>
<pre data-type="programlisting">1
1
1
True
True
True
False
False
False
False</pre>
<p>This also illustrates that the <code>int</code> type defines a special meaning for <code>==</code>. With <code>int</code>, this operator compares the values, so those three comparisons succeed. But <code>obj⁠ect.​Ref⁠ere⁠nce⁠Equ⁠als</code> never succeeds for value types—in fact, I’ve added an extra, fourth comparison here, where I compare <code>c1</code> with itself, and even that fails! That surprising result occurs because it’s not meaningful to perform a reference comparison with <code>int</code>—it’s not a reference type. The compiler has to perform implicit conversions from <code>int</code> to <code>object</code> for the last four lines of <a data-type="xref" href="#comparing_values">Example 3-19</a>: it has wrapped each argument to <code>object.ReferenceEquals</code> in something called a <em>box</em>, which we’ll be looking at in <a data-type="xref" href="ch07.xhtml#ch_object_lifetime">Chapter 7</a>. Each argument gets a distinct box, which is why even the final comparison fails.</p>
<p><a data-primary="nulls" data-type="indexterm" id="ix_ch03-asciidoc63"/>There’s another difference between reference types and types like <code>int</code>. By default, any reference type variable can contain a special value, <code>null</code>, meaning that the variable does not refer to any object at all. You cannot assign this value into any of the built-in numeric types (although see the next sidebar, <a href="#nullableless_thantgreater_than">“Nullable&lt;T&gt;”</a>).</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="nullableless_thantgreater_than">
<h5>Nullable&lt;T&gt;</h5>
<p><a data-primary="Nullable&lt;T&gt; type" data-type="indexterm" id="idm45884852922720"/>.NET defines a wrapper type called <code>Nullable&lt;T&gt;</code>, which adds nullability to value types. Although an <code>int</code> variable cannot hold <code>null</code>, a <code>Nullable&lt;int&gt;</code> can. The angle brackets after the type name indicate that this is a generic type—you can plug various different types into that <code>T</code> placeholder—and I’ll talk about those more in <a data-type="xref" href="ch04.xhtml#ch_generics">Chapter 4</a>.</p>
<p>The compiler provides special handling for <code>Nullable&lt;T&gt;</code>. It lets you use a more compact syntax, so you can write <code>int?</code> instead. When nullable numerics appear inside arithmetic expressions, the compiler treats them differently than normal values. For example, if you write <code>a + b</code>, where <code>a</code> and <code>b</code> are both <code>int?</code>, the result is an <code>int?</code> that will be <code>null</code> if either operand was <code>null</code>, and will otherwise contain the sum of the values. This also works if only one of the operands is an <code>int?</code> and the other is an ordinary <code>int</code>.</p>
<p>While you can set an <code>int?</code> to <code>null</code>, it’s not a reference type. It’s more like a combination of an <code>int</code> and a <code>bool</code>. (Although, as I’ll describe in <a data-type="xref" href="ch07.xhtml#ch_object_lifetime">Chapter 7</a>, the CLR performs some tricks with <code>Nullable&lt;T&gt;</code> that sometimes makes it look more like a reference type than a value type.)</p>
<p><a data-primary="? (nullable values)" data-type="indexterm" id="idm45884852909808"/>If you use the null-conditional operators described in <a data-type="xref" href="ch02.xhtml#ch_basic_coding">Chapter 2</a> (<code>?.</code> and <code>?[<em>index</em>]</code>) to access members with a value type, the resulting expression will be of the nullable version of that type. For example, if <code>str</code> is a variable of type <code>string?</code>, the expression <code>str?.Length</code> has type <code>Nullable&lt;int&gt;</code> (or if you prefer, <code>int?</code>) because <code>Length</code> is of type <code>int</code>, but the use of a null-conditional operator means the expression could evaluate to <code>null</code>.</p>
</div></aside>
<section class="less_space pagebreak-before" data-pdf-bookmark="Banishing Null with Non-Nullable References" data-type="sect2"><div class="sect2" id="idm45884852909344">
<h2>Banishing Null with Non-Nullable References</h2>
<p><a data-primary="non-nullable references" data-type="indexterm" id="ix_ch03-asciidoc7"/>The widespread availability of null references in programming languages dates back to 1965, when computer scientist Tony Hoare added them to the highly influential ALGOL language. He has since apologized for this invention, which he described as his “billion-dollar mistake.” The possibility that a reference type variable might contain <code>null</code> makes it hard to know whether it’s safe to attempt to perform an action with that variable. (C# programs will throw a <code>NullReferenceException</code> if you attempt this, which will typically crash your program. <a data-type="xref" href="ch08.xhtml#ch_exceptions">Chapter 8</a> discusses exceptions.) Some modern programming languages avoid the practice of allowing references to be nullable by default, offering instead some system for optional values through an explicit opt-in mechanism in the type system. In fact, as you’ve seen with <code>Nullable&lt;T&gt;</code>, this is already the case for built-in numeric types (and also, as we’ll see, any custom value types that you define), but until recently, nullability has not been optional for all reference type variables.</p>
<p>C# 8.0 introduced a significant new feature to the language that extends the type system to make a distinction between references that may be null and ones that must not be. <a data-primary="C# 10.0" data-secondary="nullable references" data-type="indexterm" id="idm45884852896848"/>Before C# 10.0, this feature was disabled by default, but now when you create a new project, it will be enabled. <a data-primary="nullable references feature" data-type="indexterm" id="idm45884852895616"/>The feature’s name is <em>nullable references</em>, which seems odd, because references have been able to contain <code>null</code> since C# 1.0. However, this name refers to the fact that with this feature enabled, nullability becomes an opt-in feature: a reference will never contain <code>null</code> unless it is explicitly defined as a nullable reference. At least, that’s the theory.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>Enabling the type system to distinguish between nullable and non-nullable references was always going to be a tricky thing to retrofit to a language almost two decades into its life. So the reality is that C# cannot always guarantee that a non-nullable reference will never contain a <code>null</code>. However, it can make the guarantee if certain constraints hold, and more generally it will significantly reduce the chances of encountering a <code>NullReferenceException</code> even in cases where it cannot absolutely rule this out.</p>
</div>
<p>Enabling non-nullability is a radical change, which is why the feature was, until recently, switched off until you enabled it explicitly. (Even now, the change with C# 10.0 is that newly created <em>.csproj</em> files include the setting that turns this feature on. Without that setting, the feature continues to be off by default.) Switching it on can have a dramatic impact on existing code, so it is possible to control the feature at a fine-grained level to enable a gradual transition between the old world and the new nullable-references-aware world.</p>
<p><a data-primary="nullable annotation context" data-type="indexterm" id="idm45884852890272"/><a data-primary="nullable warning context" data-type="indexterm" id="idm45884852889408"/>C# provides two dimensions of control, which it calls the <em>nullable annotation context</em> and the <em>nullable warning context</em>. Each line of code in a C# program is associated with one of each kind of context. The default is that all your code is in a <em>disabled</em> nullable annotation context and a <em>disabled</em> nullable warning context. You can change these defaults at a project level (and a newly created C# 10.0 project will do that). You can also use the <code>#nullable</code> directive to change either of the nullable annotation contexts at a more fine-grained level—a different one every line if you want. So how do these two contexts work?</p>
<p>The nullable annotation context determines whether we get to declare the nullability of a particular variable that uses a reference type. (I’m using C#’s broader definition of <em>variable</em> here, which includes not just local variables but also fields, parameters, and properties.) In a disabled annotation context (the default), we cannot express this, and all references are implicitly nullable. The official categorization describes these as <em>oblivious</em> to nullability, distinguishing them from references you have deliberately annotated as being nullable. However, in an enabled annotation context, we get to choose. <a data-type="xref" href="#specifying_nullability">Example 3-20</a> shows how.</p>
<div data-type="example" id="specifying_nullability">
<h5><span class="label">Example 3-20. </span>Specifying nullability</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">string</code> <code class="n">cannotBeNull</code> <code class="p">=</code> <code class="s">"Text"</code><code class="p">;</code>
<code class="kt">string?</code> <code class="n">mayBeNull</code> <code class="p">=</code> <code class="k">null</code><code class="p">;</code></pre></div>
<p>This mirrors the syntax for nullability of built-in numeric types and custom value types. If you just write the type name, that denotes something non-nullable. <a data-primary="? (nullable references)" data-type="indexterm" id="idm45884852878528"/>If you want it to be nullable, you append a <code>?</code>.</p>
<p>The most important point to notice here is that in an enabled nullable annotation context, the old syntax gets the new behavior, and if you want the old behavior, you need to use the new syntax. This means that if you take existing code originally written without any awareness of nullability, and you put it into an enabled annotation context, <em>all</em> reference type variables are now effectively annotated as being non-nullable, the opposite of how the compiler treated the exact same code before.</p>
<p><a data-primary="#nullable enable directives" data-primary-sortas="nullable enable directives" data-type="indexterm" id="idm45884852876192"/><a data-primary="#nullable restore directives" data-primary-sortas="nullable restore directives" data-type="indexterm" id="idm45884852850864"/>The most direct way to put code into an enabled nullable annotation context is with a <code>#nullable enable annotations</code> directive. You can put this at the top of a source file to enable it for the whole file, or you can use it more locally, followed by a <code>#nullable restore annotations</code> to put back the project-wide default. On its own this will produce no visible change. The compiler won’t act on these annotations if the nullable warning context is disabled, and it is disabled by default. You can enable it locally with <code>#nullable enable warnings</code> (and <code>#nullable restore warnings</code> reverts to the project-wide default). You can control the project-wide defaults in the <em>.csproj</em> file by adding a <code>&lt;Nullable&gt;</code> property. <a data-type="xref" href="#enabling_nullable_warnings_in_csproj">Example 3-21</a> sets the defaults to an enabled nullable warning context and an enabled nullable annotation context. <a data-primary="dotnet command line tool" data-secondary="dotnet new" data-type="indexterm" id="idm45884852840448"/>You will find a setting like this in any newly created C# 10.0 project (whether created from Visual Studio or using the <code>dotnet new</code> at the command line).</p>
<div data-type="example" id="enabling_nullable_warnings_in_csproj">
<h5><span class="label">Example 3-21. </span>Specifying enabled nullable warning and annotation contexts as the project-wide default</h5>
<pre data-code-language="xml" data-type="programlisting"><code class="nt">&lt;PropertyGroup&gt;</code>
  <code class="nt">&lt;Nullable&gt;</code>enable<code class="nt">&lt;/Nullable&gt;</code>
<code class="nt">&lt;/PropertyGroup&gt;</code></pre></div>
<p>This means that all code will be in an enabled nullable warning context and also in an enabled nullable annotation context unless it explicitly opts out. Other project-wide settings are <code>disable</code> (which has the same effect as not setting <code>&lt;Nullable&gt;</code> at all), 
<span class="keep-together"><code>warnings</code></span> (enables warnings but not annotations), and <code>annotations</code> (enables annotations but not warnings).</p>
<p><a data-primary="#nullable disable directives" data-primary-sortas="nullable disable directives" data-type="indexterm" id="idm45884837269104"/>If you’ve specified an enabled annotation context at the project level, you can use <code>#nullable disable annotations</code> to opt out in individual files. Likewise, if you’ve specified an enabled warning context at the project level, you can opt out with <code>#nullable disable warnings</code>.</p>
<p>We have all this fine-grained control to make it easier to enable non-nullability for existing code. If you just fully enable the feature for an entire project in one step, you’re likely to encounter a lot of warnings. In practice, it may make more sense to put all code in the project in an enabled warning context but not to enable annotations anywhere to begin with. Since all of your references will be deemed <em>oblivious</em> to nullability checking, the only warnings you’ll see will relate to use of libraries. And any warnings at this stage are quite likely to be indicative of potential problems, e.g., missing tests for null. Once you’ve addressed these, you can start to move your own code into an enabled annotation context one file at a time (or in even smaller chunks if you prefer), making any necessary changes.</p>
<p>Over time, the goal would be to get all the code to the point where you can fully enable non-nullable support at the project level. And for newly created projects, it is usually best to have nullable references enabled from the start so that you can prevent problematic null handling ever getting into your code—that’s why new projects have this feature enabled.</p>
<p>What does the compiler do for us in code where we’ve fully enabled non-nullability support? We get two main things. First, the compiler uses rules similar to the definite assignment rules to ensure that we don’t attempt to dereference a variable without first checking to see whether it’s null. <a data-type="xref" href="#dereferencing_nullable_reference">Example 3-22</a> shows some cases the compiler will accept and some that would cause warnings in an enabled nullable warning context, assuming that <code>mayBeNull</code> was declared in an enabled nullable annotation context as being nullable.</p>
<div data-type="example" id="dereferencing_nullable_reference">
<h5><span class="label">Example 3-22. </span>Dereferencing a nullable reference</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">if</code> <code class="p">(</code><code class="n">mayBeNull</code> <code class="k">is</code> <code class="n">not</code> <code class="k">null</code><code class="p">)</code>
<code class="p">{</code>
    <code class="c1">// Allowed because we can only get here if mayBeNull is not null</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">mayBeNull</code><code class="p">.</code><code class="n">Length</code><code class="p">);</code>
<code class="p">}</code>

<code class="c1">// Allowed because it checks for null and handles it</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">mayBeNull</code><code class="p">?.</code><code class="n">Length</code> <code class="p">??</code> <code class="m">0</code><code class="p">);</code>

<code class="c1">// The compiler will warn about this in an enabled nullable warning context</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">mayBeNull</code><code class="p">.</code><code class="n">Length</code><code class="p">);</code></pre></div>
<p>Second, in addition to checking whether dereferencing (use of <code>.</code> to access a member) is safe, the compiler will also warn you when you’ve attempted to assign a reference that might be null into something that requires a non-nullable reference, or if you pass one as an argument to a method when the corresponding parameter is declared as non-nullable.</p>
<p>Sometimes, you’ll run into a roadblock on the path to moving all your code into fully enabled nullability contexts. Perhaps you depend on some component that is unlikely to be upgraded with nullability annotations in the foreseeable future, or perhaps there’s a scenario in which C#’s conservative safety rules incorrectly decide that some code is not safe. What can you do in these cases? You wouldn’t want to disable warnings for the entire project, and it would be irritating to have to leave the code peppered with <code>#nullable</code> directives. And while you can prevent warnings by adding explicit checks for <code>null</code>, this is undesirable in cases where you are confident that they are unnecessary. There is an alternative: you can tell the C# compiler that you know something it doesn’t. If you have a reference that the compiler presumes could be null but that you have good reason to believe will never be null, you can tell the compiler this by using the <a data-primary="! (null forgiving operator)" data-type="indexterm" id="idm45884836712864"/><a data-primary="dammit operator" data-type="indexterm" id="idm45884835835792"/><a data-primary="null forgiving operator" data-type="indexterm" id="idm45884855466816"/><em>null forgiving operator</em>, which you can see near the end of the second line of <a data-type="xref" href="#null_forgiving_operator">Example 3-23</a>. It is sometimes known informally as the <em>dammit operator</em>, because being an exclamation mark makes it look like a slightly exasperated kind of assertion.</p>
<div data-type="example" id="null_forgiving_operator">
<h5><span class="label">Example 3-23. </span>The null forgiving operator</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">string?</code> <code class="n">referenceFromLegacyComponent</code> <code class="p">=</code> <code class="n">legacy</code><code class="p">.</code><code class="n">GetReferenceWeKnowWontBeNull</code><code class="p">();</code>
<code class="kt">string</code> <code class="n">nonNullableReferenceFromLegacyComponent</code> <code class="p">=</code> <code class="n">referenceFromLegacyComponent</code><code class="p">!;</code></pre></div>
<p>You can use the null forgiving operator in any enabled nullable annotation context. It has the effect of converting a nullable reference to a non-nullable reference. You can then go on to dereference that non-nullable reference or otherwise use it in places where a nullable reference would not be allowed without causing any <span class="keep-together">compiler warnings.</span></p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>The null forgiving operator does not check its input. If you apply this in a scenario where the value turns out to be null at runtime, it will not detect this. Instead, you will get a runtime error at the point where you try to use the reference.</p>
</div>
<p>While the null forgiving operator can be useful at the boundary between nullable-aware code and old code that you don’t control, there’s another way to let the compiler know when an apparently nullable expression will not in fact be null: nullable attributes. .NET defines several attributes that you can use to annotate code to describe when it will or won’t return null values. Consider the code in <a data-type="xref" href="#nullability_try_pattern">Example 3-24</a>. If you do not enable the nullable reference type features, this works fine, but if you turn them on, you will get a warning. (This uses a dictionary, a collection type that is described in detail in <a data-type="xref" href="ch05.xhtml#ch_collections">Chapter 5</a>.)</p>
<div data-type="example" id="nullability_try_pattern">
<h5><span class="label">Example 3-24. </span>Nullability and the Try pattern—before nullable reference types</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">static</code> <code class="kt">string</code> <code class="nf">Get</code><code class="p">(</code><code class="n">IDictionary</code><code class="p">&lt;</code><code class="kt">int</code><code class="p">,</code> <code class="kt">string</code><code class="p">&gt;</code> <code class="n">d</code><code class="p">)</code>
<code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">d</code><code class="p">.</code><code class="n">TryGetValue</code><code class="p">(</code><code class="m">42</code><code class="p">,</code> <code class="k">out</code> <code class="kt">string</code> <code class="n">s</code><code class="p">))</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="n">s</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">return</code> <code class="s">"Not found"</code><code class="p">;</code>
<code class="p">}</code></pre></div>
<p>With nullability fully enabled, the compiler will complain at the <code>out string s</code>. It will tell you, correctly, that <code>TryGetValue</code> might pass a <code>null</code> through that <code>out</code> argument. (This kind of argument is discussed later; it provides a way to return additional values besides the function’s main return value.) This function checks whether the dictionary contains an entry with the specified key. If it does, it will return <code>true</code> and put the relevant value into the <code>out</code> argument, but if not, it returns <code>false</code> and sets that <code>out</code> argument to <code>null</code>. We can modify our code to reflect this fact by putting a <code>?</code> after the <code>out string</code>. <a data-type="xref" href="#try_pattern_nullable_aware">Example 3-25</a> shows this modification.</p>
<div data-type="example" id="try_pattern_nullable_aware">
<h5><span class="label">Example 3-25. </span>Nullable-aware use of the Try pattern</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">static</code> <code class="kt">string</code> <code class="nf">Get</code><code class="p">(</code><code class="n">IDictionary</code><code class="p">&lt;</code><code class="kt">int</code><code class="p">,</code> <code class="kt">string</code><code class="p">&gt;</code> <code class="n">d</code><code class="p">)</code>
<code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">d</code><code class="p">.</code><code class="n">TryGetValue</code><code class="p">(</code><code class="m">42</code><code class="p">,</code> <code class="k">out</code> <code class="kt">string?</code> <code class="n">s</code><code class="p">))</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="n">s</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">return</code> <code class="s">"Not found"</code><code class="p">;</code>
<code class="p">}</code></pre></div>
<p>You might expect this to cause a new problem. Our <code>Get</code> method returns a <code>string</code>, not a <code>string?</code>, so how can that <code>return s</code> be correct? We just modified our code to indicate that <code>s</code> might be null, so won’t the compiler complain when we try to return this possibly null value from a method that declares that it won’t return <code>null</code>? But in fact this compiles. The compiler accepts this because it knows that <code>TryGetValue</code> will only set that <code>out</code> argument to <code>null</code> if it returns <code>false</code>. That means that the compiler knows that although the <code>s</code> variable’s type is <code>string?</code>, it will not be <code>null</code> inside the body of the <code>if</code> statement. It knows this thanks to a nullable attribute applied to the <code>TryGetValue</code> method’s definition. (Attributes are described in <a data-type="xref" href="ch14.xhtml#ch_attributes">Chapter 14</a>.) <a data-type="xref" href="#nullable_attribute">Example 3-26</a> shows the attribute in the method’s declaration. (This method is part of a generic type, which is why we see <code>TKey</code> and <code>TValue</code> here and not the <code>int</code> and <code>string</code> types I used in my examples. <a data-type="xref" href="ch04.xhtml#ch_generics">Chapter 4</a> discusses this kind of method in detail. In the examples at hand, <code>TKey</code> and <code>TValue</code> are, in effect, <code>int</code> and <code>string</code>.)</p>
<div data-type="example" id="nullable_attribute">
<h5><span class="label">Example 3-26. </span>A nullable attribute</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="kt">bool</code> <code class="nf">TryGetValue</code><code class="p">(</code><code class="n">TKey</code> <code class="n">key</code><code class="p">,</code> <code class="p">[</code><code class="n">MaybeNullWhen</code><code class="p">(</code><code class="k">false</code><code class="p">)]</code> <code class="k">out</code> <code class="n">TValue</code> <code class="k">value</code><code class="p">)</code></pre></div>
<p>This annotation is how C# knows that the value might be <code>null</code> if <code>TryGetValue</code> returns <code>false</code> but won’t be if it returns <code>true</code>. Without this attribute, <a data-type="xref" href="#nullability_try_pattern">Example 3-24</a> would have compiled successfully even with nullable warnings enabled, because by writing <code>IDictionary&lt;int, string&gt;</code> (and not <code>IDictionary&lt;int, string?&gt;</code>) I am indicating that my dictionary does not permit null values. So normally, C# will assume that when a method returns a value from the dictionary, it will also produce a <code>string</code>. But <code>TryGetValue</code> sometimes has no value to return, which is why it needs this annotation. <a data-primary="nullable attributes" data-type="indexterm" id="idm45884833264128"/><a data-type="xref" href="#nullable_attributes">Table 3-1</a> describes the various attributes you can apply to give the C# compiler more information about what may or may not be <code>null</code>.</p>
<table id="nullable_attributes">
<caption><span class="label">Table 3-1. </span>Nullable attributes</caption>
<thead>
<tr>
<th><strong>Type</strong></th>
<th><strong>Usage</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><p><code>AllowNull</code></p></td>
<td><p>Code is allowed to supply <code>null</code> even when the type is non-nullable.</p></td>
</tr>
<tr>
<td><p><code>DisallowNull</code></p></td>
<td><p>Code must not supply <code>null</code> even when the type is nullable.</p></td>
</tr>
<tr>
<td><p><code>MaybeNull</code></p></td>
<td><p>Code should be prepared for this to return the <code>null</code> value even when the type is non-nullable.</p></td>
</tr>
<tr>
<td><p><code>MaybeNullWhen</code></p></td>
<td><p>Used only with <code>out</code> or <code>ref</code> parameters; the output may be <code>null</code> if the method returns the specified <code>bool</code> value.</p></td>
</tr>
<tr>
<td><p><code>NotNull</code></p></td>
<td><p>Used with parameters. If the method returns without error, the argument was not <code>null</code>. (With <code>out</code> or <code>ref</code> parameters, this typically means the method makes sure to set them; with an inbound-only parameter, this implies the method checks the value and only returns without error if it was not <code>null</code>.)</p></td>
</tr>
<tr>
<td><p><code>NotNullWhen</code></p></td>
<td><p>Used only with <code>out</code> or <code>ref</code> parameters; the output may not be <code>null</code> if the method returns the specified <code>bool</code> value.</p></td>
</tr>
<tr>
<td><p><code>NotNullIfNotNull</code></p></td>
<td><p>If you pass a non-null value as the argument for the parameter that this attribute names, the value returned by this attribute’s target will not be <code>null</code>.</p></td>
</tr>
</tbody>
</table>
<p>These attributes have been applied where appropriate to most of the .NET runtime libraries to reduce the friction involved in adopting nullable references.</p>
<p>Moving code into enabled nullable warning and annotation contexts can provide a significant boost to code quality. Many developers who migrate existing codebases often uncover some latent bugs in the process, thanks to the additional checks the compiler performs. However, it is not perfect. There are two holes worth being aware of, caused by the fact that nullability was not baked into the type system from the start. The first is that legacy code introduces blind spots—even if all your code is in an enabled nullable annotation context, if it uses APIs that are not, references it obtains from those will be oblivious to nullability. If you need to use the null forgiving operator to keep the compiler happy, there’s always the possibility that you are mistaken, at which point you’ll end up with a <code>null</code> in what is supposed to be a non-nullable variable. The second is more vexing in that you can hit it in brand-new code, even if you fully enabled this feature from the start: certain storage locations in .NET have their memory filled with zero values when they are initialized. If these locations are of a reference type, they will end up starting out with a <code>null</code> value, and there’s currently no way that the C# compiler can enforce their non-nullability. Arrays have this issue. Look at <a data-type="xref" href="#nullable_arrays">Example 3-27</a>.</p>
<div data-type="example" id="nullable_arrays">
<h5><span class="label">Example 3-27. </span>Arrays and nullability</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">nullableStrings</code> <code class="p">=</code> <code class="k">new</code> <code class="kt">string?</code><code class="p">[</code><code class="m">10</code><code class="p">];</code>
<code class="kt">var</code> <code class="n">nonNullableStrings</code> <code class="p">=</code> <code class="k">new</code> <code class="kt">string</code><code class="p">[</code><code class="m">10</code><code class="p">];</code></pre></div>
<p>This code declares two arrays of strings. The first uses <code>string?</code>, so it allows nullable references. The second does not. However, in .NET you have to create arrays before you can put anything in them, and a newly created array’s memory is always zero-initialized. This means that our <code>nonNullableStrings</code> array will start life full of nulls. There is no way to avoid this because of how arrays work in .NET. One way to mitigate this problem is to avoid using arrays directly. If you use <code>List&lt;string&gt;</code> instead (see <a data-type="xref" href="ch05.xhtml#ch_collections">Chapter 5</a>), it will contain only items that you have added—unlike an array, a <code>List&lt;T&gt;</code> does not provide a way to initialize it with empty slots. But you can’t always substitute a <code>List&lt;T&gt;</code> for an array. Sometimes you will simply need to take care that you initialize all the elements in an array.</p>
<p>A similar problem exists with fields in value types, which are described in the following section. If they have reference type fields, there are situations in which you cannot prevent them from being initialized to <code>null</code>. So the nullable references feature is not perfect. It is nonetheless very useful. Teams that have made the necessary changes to existing projects to use it have reported that this process tends to uncover many previously undiscovered bugs. It is an important tool for improving the quality of your code.</p>
<p>Although non-nullable references diminish one of the distinctions between reference types and built-in numeric types, important differences remain. A variable of type <code>int</code> is not a reference to an <code>int</code>. It contains the value of the <code>int</code>—there is no indirection. In some languages, this choice between reference-like and value-like behavior is determined by the way in which you use a type, but in C#, it is a fixed feature of the type. Any particular type is either a reference type or a <em>value type</em>. The built-in numeric types are all value types, as is <code>bool</code>, whereas a <code>class</code> is always a reference type. But this is not a distinction between built-in and custom types.<a data-startref="ix_ch03-asciidoc63" data-type="indexterm" id="idm45884833184336"/><a data-startref="ix_ch03-asciidoc7" data-type="indexterm" id="idm45884833183632"/> You can write custom value types<a data-startref="ix_ch03-asciidoc62" data-type="indexterm" id="idm45884833182832"/><a data-startref="ix_ch03-asciidoc6" data-type="indexterm" id="idm45884833182160"/><a data-startref="ix_ch03-asciidoc5" data-type="indexterm" id="idm45884833181488"/>.<a data-startref="ix_ch03-asciidoc2" data-type="indexterm" id="idm45884833180688"/><a data-startref="ix_ch03-asciidoc1" data-type="indexterm" id="idm45884833179984"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Structs" data-type="sect1"><div class="sect1" id="structs">
<h1>Structs</h1>
<p><a data-primary="structs" data-type="indexterm" id="ix_ch03-asciidoc8"/><a data-primary="types" data-secondary="structs" data-type="indexterm" id="ix_ch03-asciidoc9"/>Sometimes it will be appropriate for a custom type to get the same value-like behavior as the built-in value types. The most obvious example would be a custom numeric type. Although the CLR offers various intrinsic numeric types, some kinds of calculations require a bit more structure than these provide. For example, many scientific and engineering calculations work with complex numbers. The runtime does not define an intrinsic representation for these, but the runtime libraries support them with the <code>Complex</code> type. It would be unhelpful if a numeric type such as this behaved significantly differently from the built-in types. Fortunately, it doesn’t, because it is a value type. The way to write a custom value type is to use the <code>struct</code> keyword instead of <code>class</code>.</p>
<p><a data-primary="classes" data-secondary="structs and" data-type="indexterm" id="idm45884833174032"/>A struct can have most of the same features as a class; it can contain methods, fields, properties, constructors, and any of the other member types supported by classes (described in <a data-type="xref" href="#members">“Members”</a>), and we can use the same accessibility keywords, such as <code>public</code> and <code>internal</code>. There are a few restrictions, but with the simple <code>Counter</code> type I wrote earlier, I <em>could</em> just replace the <code>class</code> keyword with <code>struct</code>. However, this would not be a useful transformation. Remember, one of the main distinctions between reference types (classes) and value types is that the former have identity: it might be useful for me to create multiple <code>Counter</code> objects so that I can count different kinds of things. But with value types (either the built-in ones or custom structs), the assumption is that they can be copied freely. If I have an instance of the <code>int</code> type (e.g., 4) and I store that in several fields, there’s no expectation that this value has a life of its own: one instance of the number 4 is indistinguishable from another. The variables that hold values have their own identities and lifetimes, but the values that they hold do not. This is different from how reference types work: not only do the variables that refer to them have identities and lifetimes, the objects they refer to have their own identities and lifetimes independent of any particular variable.</p>
<p>If I add one to the <code>int</code> value 4, the result is a completely different <code>int</code> value. If I call <code>GetNextValue()</code> on a <code>Counter</code>, its count goes up by one, but it remains the same <code>Counter</code> instance. So although replacing <code>class</code> with <code>struct</code> in <a data-type="xref" href="#class_with_static_members">Example 3-3</a> would compile, we really don’t want our <code>Counter</code> type to become a struct. <a data-type="xref" href="#simple_struct">Example 3-28</a> shows a better candidate.</p>
<div data-type="example" id="simple_struct">
<h5><span class="label">Example 3-28. </span>A simple struct</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">struct</code> <code class="nc">Point</code>
<code class="p">{</code>
    <code class="k">private</code> <code class="kt">double</code> <code class="n">_x</code><code class="p">;</code>
    <code class="k">private</code> <code class="kt">double</code> <code class="n">_y</code><code class="p">;</code>
    <code class="k">public</code> <code class="nf">Point</code><code class="p">(</code><code class="kt">double</code> <code class="n">x</code><code class="p">,</code> <code class="kt">double</code> <code class="n">y</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">_x</code> <code class="p">=</code> <code class="n">x</code><code class="p">;</code>
        <code class="n">_y</code> <code class="p">=</code> <code class="n">y</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="kt">double</code> <code class="n">X</code> <code class="p">=&gt;</code> <code class="n">_x</code><code class="p">;</code>
    <code class="k">public</code> <code class="kt">double</code> <code class="n">Y</code> <code class="p">=&gt;</code> <code class="n">_y</code><code class="p">;</code>
<code class="p">}</code></pre></div>
<p>This represents a point in two-dimensional space. And while it’s certainly possible to imagine wanting the ability to represent particular points with their own identity (in which case we’d want a <code>class</code>), it’s perfectly reasonable to want to have a value-like type representing a point’s location.</p>
<p>Although <a data-type="xref" href="#simple_struct">Example 3-28</a> is OK as far as it goes, it’s common for values to support comparison. <a data-primary="== (equal)" data-type="indexterm" id="idm45884833092784"/>As mentioned earlier, C# defines a default meaning for the <code>==</code> operator for reference types: it is equivalent to <code>object.ReferenceEquals</code>, which compares identities. That’s not meaningful for value types, so C# does not automatically support <code>==</code> for a <code>struct</code>. You are not strictly required to provide a definition, but the built-in value types all do, so if we’re trying to make a type with similar characteristics to those, we should do this. <a data-primary="!= (not equal)" data-type="indexterm" id="idm45884833090192"/>If you add an <code>==</code> operator on its own, the compiler will inform you that you are required to define a matching <code>!=</code> operator. You might think C# would define <code>!=</code> as the inverse of <code>==</code>, since they appear to mean the opposite. However, some types will return <code>false</code> for both operators for certain pairs of operands, so C# requires us to define both independently. As <a data-type="xref" href="#support_custom_comparison">Example 3-29</a> shows, to define a custom meaning for an operator, we use the <code>operator</code> keyword followed by the operator we’d like to customize. This example defines the behavior for <code>==</code> and <code>!=</code>, which are very straightforward for our simple type. (Since all of the new methods in this example do nothing more than returning the value of a single expression, I’ve implemented them using the <code>=&gt;</code> syntax, just as I’ve done with various properties in preceding examples.)<a data-primary="IEquatable&lt;T&gt; interface" data-type="indexterm" id="idm45884833045792"/></p>
<div data-type="example" id="support_custom_comparison">
<h5><span class="label">Example 3-29. </span>Support custom comparison</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">struct</code> <code class="nc">Point</code> <code class="p">:</code> <code class="n">IEquatable</code><code class="p">&lt;</code><code class="n">Point</code><code class="p">&gt;</code>
<code class="p">{</code>
    <code class="k">private</code> <code class="kt">double</code> <code class="n">_x</code><code class="p">;</code>
    <code class="k">private</code> <code class="kt">double</code> <code class="n">_y</code><code class="p">;</code>
    <code class="k">public</code> <code class="nf">Point</code><code class="p">(</code><code class="kt">double</code> <code class="n">x</code><code class="p">,</code> <code class="kt">double</code> <code class="n">y</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">_x</code> <code class="p">=</code> <code class="n">x</code><code class="p">;</code>
        <code class="n">_y</code> <code class="p">=</code> <code class="n">y</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="kt">double</code> <code class="n">X</code> <code class="p">=&gt;</code> <code class="n">_x</code><code class="p">;</code>
    <code class="k">public</code> <code class="kt">double</code> <code class="n">Y</code> <code class="p">=&gt;</code> <code class="n">_y</code><code class="p">;</code>

    <code class="k">public</code> <code class="k">override</code> <code class="kt">bool</code> <code class="nf">Equals</code><code class="p">(</code><code class="kt">object?</code> <code class="n">o</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="n">o</code> <code class="k">is</code> <code class="n">Point</code> <code class="n">p</code> <code class="p">&amp;&amp;</code> <code class="k">this</code><code class="p">.</code><code class="n">Equals</code><code class="p">(</code><code class="n">p</code><code class="p">);</code>
    <code class="k">public</code> <code class="kt">bool</code> <code class="nf">Equals</code><code class="p">(</code><code class="n">Point</code> <code class="n">o</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="k">this</code><code class="p">.</code><code class="n">X</code> <code class="p">==</code> <code class="n">o</code><code class="p">.</code><code class="n">X</code> <code class="p">&amp;&amp;</code> <code class="k">this</code><code class="p">.</code><code class="n">Y</code> <code class="p">==</code> <code class="n">o</code><code class="p">.</code><code class="n">Y</code><code class="p">;</code>
    <code class="k">public</code> <code class="k">override</code> <code class="kt">int</code> <code class="nf">GetHashCode</code><code class="p">()</code> <code class="p">=&gt;</code> <code class="n">HashCode</code><code class="p">.</code><code class="n">Combine</code><code class="p">(</code><code class="n">X</code><code class="p">,</code> <code class="n">Y</code><code class="p">);</code>

    <code class="k">public</code> <code class="k">static</code> <code class="kt">bool</code> <code class="k">operator</code> <code class="p">==(</code><code class="n">Point</code> <code class="n">a</code><code class="p">,</code> <code class="n">Point</code> <code class="n">b</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="n">a</code><code class="p">.</code><code class="n">Equals</code><code class="p">(</code><code class="n">b</code><code class="p">);</code>
    <code class="k">public</code> <code class="k">static</code> <code class="kt">bool</code> <code class="k">operator</code> <code class="p">!=(</code><code class="n">Point</code> <code class="n">a</code><code class="p">,</code> <code class="n">Point</code> <code class="n">b</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="p">!(</code><code class="n">a</code> <code class="p">==</code> <code class="n">b</code><code class="p">);</code>
<code class="p">}</code></pre></div>
<p>If you just add the <code>==</code> and <code>!=</code> operators, you’ll find that the compiler generates warnings recommending that you define two methods called <code>Equals</code> and <a data-primary="GetHashCode method" data-type="indexterm" id="idm45884832896304"/><code>GetHashCode</code>. <code>Equals</code> is a standard method available on all .NET types, and if you have defined a custom meaning for <code>==</code>, you should ensure that <code>Equals</code> does the same thing. <a data-type="xref" href="#support_custom_comparison">Example 3-29</a> does this, and as you can see, it contains the same logic as the <code>==</code> operator, but it has to do some extra work. The <code>Equals</code> method permits comparison with any type, so we first check to see if our <code>Point</code> is being compared with another <code>Point</code>. I’ve used a declaration pattern to perform this check and also to get the incoming <code>obj</code> argument into a variable of type <code>Point</code> in the case where the pattern matches. In fact it implements two versions of <code>Equals</code>: the standard method that accepts any <code>object</code> and a more specialized one that allows comparison only with other <code>Point</code> values. This allows for more efficient comparisons by avoiding boxing (which is described in <a data-type="xref" href="ch07.xhtml#ch_object_lifetime">Chapter 7</a>), and as is common practice when offering this second form of <code>Equals</code>, I’ve declared support for the <code>IEquatable&lt;Point&gt;</code> interface; I’ll be describing interfaces in <a data-type="xref" href="#interfaces">“Interfaces”</a>. <a data-type="xref" href="#support_custom_comparison">Example 3-29</a> also implements <code>GetHashCode</code>, which we’re required to do if we implement <code>Equals</code>. See the next sidebar, <a href="#gethashcode">“GetHashCode”</a>, 
<span class="keep-together">for details.</span></p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="gethashcode">
<h5>GetHashCode</h5>
<p>All .NET types have a <code>GetHashCode</code>  method. It returns an <code>int</code> that in some sense represents the value of your object. Some data structures and algorithms are designed to work with this sort of simplified, reduced version of an object’s value. A hash table, for example, can find a particular entry in a very large table very efficiently, as long as the type of value you’re searching for offers a good hash code implementation. Some of the collection classes described in <a data-type="xref" href="ch05.xhtml#ch_collections">Chapter 5</a> rely on this. The details of this sort of algorithm are beyond the scope of this book, but if you search the web for “hash table” you’ll find plenty of information.</p>
<p>A correct implementation of <code>GetHashCode</code> must meet two requirements. The first is that whatever number an instance returns as its hash code, that instance must continue to return the same code as long as its own value does not change. The second requirement is that two instances that have equal values according to their <code>Equals</code> methods must return the same hash code. Any type that fails to meet either of these requirements might cause code that uses its <code>GetHashCode</code> method to malfunction. The default implementation of <code>GetHashCode</code> for reference types meets the first requirement but makes no attempt to meet the second—pick any two objects that use the default implementation, and most of the time they’ll have different hash codes. That’s fine because the default reference type <code>Equals</code> implementation only ever returns true if you compare an object with itself, but this is why you need to override <code>GetHashCode</code> if you override <code>Equals</code>. Value types get default implementations of <code>GetHashCode</code> and <code>Equals</code> that meet both requirements. However, these can sometimes be slow, so you should normally write your own.</p>
<p>Ideally, objects that have different values should have different hash codes, but that’s not always possible—<code>GetHashCode</code> returns an <code>int</code>, which has a finite number of possible values. (4,294,967,296, to be precise.) If your data type offers more distinct values, then it’s clearly not possible for every conceivable value to produce a different hash code. For example, the 64-bit integer type, <code>long</code>, obviously supports more distinct values than <code>int</code>. If you call <code>GetHashCode</code> on a <code>long</code> with a value of 0, on .NET 6.0 it returns 0, and you’ll get the same hash code for a <code>long</code> with a value of 4,294,967,297. Duplicates like these are called <em>hash collisions</em>, and they are an unavoidable fact of life. Code that depends on hash codes just has to be able to deal with these.</p>
<p>The rules do not require the mapping from values to hash codes to be fixed forever—they only need to be consistent for the lifetime of the process. In fact, there are good reasons to be inconsistent. Criminals who attack online computer systems sometimes try to cause hash collisions. Collisions decrease the efficiency of hash-based algorithms, so an attack that attempts to overwhelm a server’s CPU will be more effective if it can induce collisions for values that it knows the server will use in hash-based lookups. Some types in the runtime libraries deliberately change the way they produce hashes each time you restart a program to avoid this problem.</p>
<p>Because hash collisions are unavoidable, the rules cannot forbid them, which means you could return the same value (e.g., 0) from <code>GetHashCode</code> every time, regardless of the instance’s actual value. Although not technically against the rules, it tends to produce lousy performance from hash tables and the like. Ideally, you will want to minimize hash collisions. That said, if you don’t expect anything to depend on your type’s hash code, there’s not much point in spending time carefully devising a hash function that produces well-distributed values. Sometimes a lazy approach, such as deferring to a single field, is OK. Or you could defer to the <code>HashCode.Combine</code> method like <a data-type="xref" href="#support_custom_comparison">Example 3-29</a> does.</p>
</div></aside>
<p>With the version of <code>Point</code> in <a data-type="xref" href="#support_custom_comparison">Example 3-29</a>, we can run a few tests. <a data-type="xref" href="#comparing_structs">Example 3-30</a> works similarly to Examples <a data-type="xref" data-xrefstyle="select:labelnumber" href="#comparing_references">3-18</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="#comparing_values">3-19</a>.<a data-primary="ReferenceEquals method" data-type="indexterm" id="idm45884832794400"/></p>
<div data-type="example" id="comparing_structs">
<h5><span class="label">Example 3-30. </span>Comparing struct instances</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">p1</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Point</code><code class="p">(</code><code class="m">40</code><code class="p">,</code> <code class="m">2</code><code class="p">);</code>
<code class="n">Point</code> <code class="n">p2</code> <code class="p">=</code> <code class="n">p1</code><code class="p">;</code>
<code class="kt">var</code> <code class="n">p3</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Point</code><code class="p">(</code><code class="m">40</code><code class="p">,</code> <code class="m">2</code><code class="p">);</code>

<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"{p1.X}, {p1.Y}"</code><code class="p">);</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"{p2.X}, {p2.Y}"</code><code class="p">);</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"{p3.X}, {p3.Y}"</code><code class="p">);</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">p1</code> <code class="p">==</code> <code class="n">p2</code><code class="p">);</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">p1</code> <code class="p">==</code> <code class="n">p3</code><code class="p">);</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">p2</code> <code class="p">==</code> <code class="n">p3</code><code class="p">);</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="kt">object</code><code class="p">.</code><code class="n">ReferenceEquals</code><code class="p">(</code><code class="n">p1</code><code class="p">,</code> <code class="n">p2</code><code class="p">));</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="kt">object</code><code class="p">.</code><code class="n">ReferenceEquals</code><code class="p">(</code><code class="n">p1</code><code class="p">,</code> <code class="n">p3</code><code class="p">));</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="kt">object</code><code class="p">.</code><code class="n">ReferenceEquals</code><code class="p">(</code><code class="n">p2</code><code class="p">,</code> <code class="n">p3</code><code class="p">));</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="kt">object</code><code class="p">.</code><code class="n">ReferenceEquals</code><code class="p">(</code><code class="n">p1</code><code class="p">,</code> <code class="n">p1</code><code class="p">));</code></pre></div>
<p>Running that code produces this output:</p>
<pre data-type="programlisting">40, 2
40, 2
40, 2
True
True
True
False
False
False
False</pre>
<p>All three instances have the same value. With <code>p2</code> that’s because I initialized it by assigning <code>p1</code> into it, and with <code>p3</code> I constructed it from scratch but with the same arguments. Then we have the first three comparisons, which, remember, use <code>==</code>. Since <a data-type="xref" href="#support_custom_comparison">Example 3-29</a> defines a custom implementation that compares values, all the comparisons succeed. And all the <code>object.ReferenceEquals</code> values fail, because this is a value type, just like <code>int</code>. In fact, this is the same behavior we saw with <a data-type="xref" href="#comparing_values">Example 3-19</a>, which used <code>int</code> instead of <code>Counter</code>. (Again, the compiler has generated implicit conversions here that produce boxes, which we will look at in <a data-type="xref" href="ch07.xhtml#ch_object_lifetime">Chapter 7</a>.) So we have achieved our goal of defining a type with similar behavior to built-in value types such as <code>int</code>.</p>
<section data-pdf-bookmark="When to Write a Value Type" data-type="sect2"><div class="sect2" id="when_to_write_a_value_type">
<h2>When to Write a Value Type</h2>
<p><a data-primary="structs" data-secondary="when to write a value type" data-type="indexterm" id="ix_ch03-asciidoc10"/><a data-primary="value type" data-secondary="when to write" data-type="indexterm" id="ix_ch03-asciidoc11"/>I’ve shown some of the differences in observable behavior between a reference type (<code>class</code> or <code>record</code>) and a <code>struct</code>, but although I argued why <code>Counter</code> was a poor candidate for being a <code>struct</code>, I’ve not fully explained what makes a good one. The short answer is that there are only two circumstances in which you should write a value type. First, if you need to represent something value-like, such as a number, a struct is likely to be ideal. Second, if you have determined that a struct has usefully better performance characteristics for the scenario in which you will use the type, a struct may not be ideal but might still be a good choice. But it’s worth understanding the pros and cons in more detail. And I will also address a surprisingly persistent myth about value types.</p>
<p>With reference types, an object is distinct from a variable that refers to it. This can be very useful, because we often use objects as models for real things with identities of their own. But this has some performance implications. An object’s lifetime is not necessarily directly related to the lifetime of a variable that refers to it. You can create a new object, store a reference to it in a local variable, and then later copy that reference to a static field. The method that originally created the object might then return, so the local variable that first referred to the object no longer exists, but the object needs to stay alive because it’s still possible to reach it by other means.</p>
<p>The CLR goes to considerable lengths to ensure that the memory an object occupies is not reclaimed prematurely but is eventually freed once the object is no longer in use. This is a fairly complex process (described in detail in <a data-type="xref" href="ch07.xhtml#ch_object_lifetime">Chapter 7</a>), and .NET applications can end up causing the CLR to consume a considerable amount of CPU time just tracking objects in order to work out when they fall out of use. Creating lots of objects increases this overhead. Adding complexity in certain ways can also increase the costs of object tracking—if a particular object remains alive only because it is reachable through some very convoluted path, the CLR may need to follow that path each time it tries to work out what memory is still in use. Each level of indirection you add generates extra work. A reference is by definition indirect, so every reference type variable creates work for the CLR.</p>
<p>Value types can often be handled in a much simpler way. For example, consider arrays. If you declare an array of some reference type, you end up with an array of references. This is very flexible—elements can be null if you want, and you’re also free to have multiple different elements all referring to the same item. But if what you actually need is a simple sequential collection of items, that flexibility is just overhead. A collection of 1,000 reference type instances requires 1,001 blocks of memory: one block to hold an array of references, and then 1,000 objects for those references to refer to. But with value types, a single block can hold all the values. This simplifies things for memory management purposes—either the array is still in use or it’s not, and there’s no need for the CLR to check the 1,000 individual elements separately.</p>
<p><a data-primary="fields" data-secondary="value types and" data-type="indexterm" id="idm45884832600416"/>It’s not just arrays that can benefit from this sort of efficiency. There’s also an advantage for fields. Consider a class that contains 10 fields, all of type <code>int</code>. The 40 bytes required to hold those fields’ values can live directly inside the memory allocated for an instance of the containing class. Compare that with 10 fields of some reference type. Although those references can be stored inside the object instance’s memory, the objects they refer to will be separate entities, so if the fields are all non-null and all refer to different objects, you’ll now have 11 blocks of memory—one for the instance that contains all the fields, and then one for each object those fields refer to. <a data-type="xref" href="#references_versus_values">Figure 3-1</a> illustrates these differences between references and values for both arrays and objects (with smaller examples, because the same principle applies even with a handful of instances).</p>
<p>Value types can also sometimes simplify lifetime handling. Often, the memory allocated for local variables can be freed as soon as a method returns (although, as we’ll see in <a data-type="xref" href="ch09.xhtml#ch_delegates_lambdas_events">Chapter 9</a>, anonymous functions mean that it’s not always that simple). This means the memory for local variables can often live on the stack, which typically has much lower overheads than the heap. For reference types, the memory for a variable is only part of the story—the object it refers to cannot be handled so easily, because that object may continue to be reachable by other paths after the method exits.</p>
<figure><div class="figure" id="references_versus_values">
<img alt="References versus values" height="463" src="assets/pc10_0301.png" width="600"/>
<h6><span class="label">Figure 3-1. </span>References versus values</h6>
</div></figure>
<p>In fact, the memory for a value may be reclaimed even before a method returns. New value instances often overwrite older instances. For example, C# can normally just use a single piece of memory to represent a variable, no matter how many different values you put in there. Creating a new instance of a value type doesn’t necessarily mean allocating more memory, whereas with reference types, a new instance means a new heap block. This is why it’s OK for each operation we perform with a value type—every integer addition or subtraction, for example—to produce a new instance.</p>
<p>One of the most persistent myths about value types says that values are allocated on the stack, unlike objects. It’s true that objects always live on the heap, but value types don’t always live on the stack,<sup><a data-type="noteref" href="ch03.xhtml#idm45884832593360" id="idm45884832593360-marker">2</a></sup> and even in the situations where they do, that’s an implementation detail, not a fundamental feature of C#. <a data-type="xref" href="#references_versus_values">Figure 3-1</a> shows two counterexamples. An <code>int</code> value inside an array of type <code>int[]</code> does not live on the stack; it lives inside the array’s heap block. Likewise, if a class declares a nonstatic <code>int</code> field, the value of that <code>int</code> lives inside the heap block for its containing object instance. And even local variables of value types don’t necessarily end up on the stack. For example, optimizations may make it possible for the value of a local variable to live entirely inside the CPU’s registers, rather than needing to go on the stack. And as you’ll see in Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch09.xhtml#ch_delegates_lambdas_events">9</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch17.xhtml#ch_asynchronous_language_features">17</a>, locals can sometimes live on the heap.</p>
<p>You might be tempted to summarize the preceding few paragraphs as “there are some complex details, but in essence, value types are more efficient.” But that would be a mistake. There are some situations in which value types are significantly more expensive. Remember that a defining feature of a value type is that values get copied on assignment. If the value type is big, that will be relatively expensive. For example, the runtime libraries define the <code>Guid</code> type to represent the 16-byte <em>globally unique identifiers</em> that crop up in lots of bits of Windows. This is a <code>struct</code>, so any assignment statement involving a <code>Guid</code> is asking to make a copy of a 16-byte data structure. This is likely to be more expensive than making a copy of a reference, because the CLR uses a pointer-based implementation for references; a pointer typically takes 4 or 8 bytes, but more importantly, it’ll be something that fits naturally into a single CPU register.</p>
<p>It’s not just assignment that causes values to be copied. Passing a value type argument to a method may require a copy. As it happens, with method invocation, it is actually possible to pass a reference to a value, although as we’ll see later, it’s a slightly limited kind of reference, and the restrictions it imposes are sometimes undesirable, so you may end up deciding that the cost of the copy is preferable. This is why Microsoft’s design guidelines suggest that you should not make a type a <code>struct</code> unless it “has an instance size under 16 bytes” (a guideline that the <code>Guid</code> type technically violates, being exactly 16 bytes in size). But this is not a hard-and-fast rule—it really depends on how you will be using it, and since more recent versions of C# provide more flexibility for using values types indirectly, it is increasingly common for performance-sensitive code to ignore this restriction and instead to take care to minimize copying.</p>
<p>Value types are not automatically going to be more efficient than reference types, so in most cases, your choice should be driven by the behavior you require. The most important question is this: Does the identity of an instance matter to you? In other words, is the distinction between one object and another object important? For our <code>Counter</code> example, the answer is yes: if we want something to keep count for us, it’s simplest if that counter is a distinct thing with its own identity. (Otherwise, our <code>Counter</code> type adds nothing beyond what <code>int</code> gives us.) But for our <code>Point</code> type, the answer is no, so it’s a reasonable candidate for being a value type.</p>
<p>An important and related question is: Does an instance of your type contain state that changes over time? Modifiable value types tend to be problematic, because it’s all too easy to end up working with some copy of a value and not the instance you meant to. (I’ll show an important example of this problem later, in <a data-type="xref" href="#properties_and_mutable_value_types">“Properties and mutable value types”</a>, and another when I describe <code>List&lt;T&gt;</code> in <a data-type="xref" href="ch05.xhtml#ch_collections">Chapter 5</a>.) So it’s usually a good idea for value types to be immutable. This doesn’t mean that variables of these types cannot be modified; it just means that to modify the variable, you must replace its contents entirely with a different value. For something simple like an <code>int</code>, this will seem like splitting hairs, but the distinction is important with structs that contain multiple fields, such as .NET’s <code>Complex</code> type, which represents numbers that combine a real and an imaginary component. You cannot change the <code>Real</code> or <code>Imaginary</code> property of an existing <code>Complex</code> instance, because the type is immutable. And the <code>Point</code> type shown earlier works the same way. If the value you’ve got isn’t the value you want, immutability just means you need to create a new value, because you can’t tweak the existing instance.</p>
<p>Immutability does not necessarily mean you should write a struct—the built-in <code>string</code> type is immutable, and that’s a class.<sup><a data-type="noteref" href="ch03.xhtml#fn19" id="fn19-marker">3</a></sup> However, because C# often does not need to allocate new memory to hold new instances of a value type, value types are able to support immutability more efficiently than classes in scenarios where you’re creating lots of new values (e.g., in a loop). Immutability is not an absolute requirement for structs—there are some unfortunate exceptions in .NET’s runtime libraries. But value types should normally be immutable, so a requirement for mutability is usually a good sign that you want a class rather than a struct.</p>
<p>A type should only be a struct if it represents something that is very clearly similar in nature to other things that are value types. (In most cases it should also be fairly small, because passing large types by value is expensive.) For example, in the runtime libraries, <code>Complex</code> is a struct, which is unsurprising because it’s a numeric type, and all of the built-in numeric types are value types. <code>TimeSpan</code> is also a value type, which makes sense because it’s effectively just a number that happens to represent a length of time. In the UI framework WPF, types used for simple geometric data such as <code>Point</code> and <code>Rect</code> are structs. But if in doubt, write a class.<a data-startref="ix_ch03-asciidoc11" data-type="indexterm" id="idm45884832571120"/><a data-startref="ix_ch03-asciidoc10" data-type="indexterm" id="idm45884832570416"/></p>
</div></section>
<section data-pdf-bookmark="Guaranteeing Immutability" data-type="sect2"><div class="sect2" id="idm45884832569616">
<h2>Guaranteeing Immutability</h2>
<p><a data-primary="immutability" data-secondary="of structs" data-type="indexterm" id="idm45884832568336"/><a data-primary="readonly keyword" data-type="indexterm" id="idm45884832567136"/><a data-primary="structs" data-secondary="guaranteeing immutability" data-type="indexterm" id="idm45884832566464"/>You can declare your intention to make a struct read-only by adding the <code>readonly</code> keyword in front of <code>struct</code>, as <a data-type="xref" href="#a_readonly_struct">Example 3-31</a> shows. This is similar to the <code>Point</code> type shown in <a data-type="xref" href="#simple_struct">Example 3-28</a>, but I’ve made a couple of other alterations. In addition to adding the <code>readonly</code> qualifier, I’ve also used read-only auto-properties to reduce the clutter—the compiler will generate code equivalent to the earlier example for these. I’ve also added a member function for reasons that will soon become clear. Like the earlier version, this has a constructor, and in this case that was mandatory: the constructor provides the only opportunity to supply values for a <code>Point</code>’s properties, so this type would be useless without one.</p>
<div data-type="example" id="a_readonly_struct">
<h5><span class="label">Example 3-31. </span>A read-only struct</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">readonly</code> <code class="k">struct</code> <code class="nc">Point</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="nf">Point</code><code class="p">(</code><code class="kt">double</code> <code class="n">x</code><code class="p">,</code> <code class="kt">double</code> <code class="n">y</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">X</code> <code class="p">=</code> <code class="n">x</code><code class="p">;</code>
        <code class="n">Y</code> <code class="p">=</code> <code class="n">y</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="kt">double</code> <code class="n">X</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="p">}</code>
    <code class="k">public</code> <code class="kt">double</code> <code class="n">Y</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="p">}</code>
    <code class="k">public</code> <code class="kt">double</code> <code class="nf">DistanceFromOrigin</code><code class="p">()</code> <code class="p">=&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">Sqrt</code><code class="p">(</code><code class="n">X</code> <code class="p">*</code> <code class="n">X</code> <code class="p">+</code> <code class="n">Y</code> <code class="p">*</code> <code class="n">Y</code><code class="p">);</code>
<code class="p">}</code></pre></div>
<p>Applying the <code>readonly</code> keyword to a <code>struct</code> has two effects. First, the C# compiler will keep you honest, preventing modification either from outside or from within. If you declare any fields, the compiler will generate an error unless these are also marked <code>readonly</code>. Similarly, if you try to define a settable auto-property (one with a <code>set;</code> as well as a <code>get;</code>), the compiler will produce an error.</p>
<p>Second, read-only structs enjoy certain optimizations. If in some other type you declare a <code>readonly</code> field (either directly or indirectly with a read-only auto-property) whose type is a <code>readonly struct</code>, the compiler may be able to avoid making a copy of the data when something uses that field. Consider the class in <a data-type="xref" href="#readonly_struct_in_readonly_property">Example 3-32</a>.</p>
<div data-type="example" id="readonly_struct_in_readonly_property">
<h5><span class="label">Example 3-32. </span>A read-only struct in a read-only property</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">class</code> <code class="nc">LocationData</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="nf">LocationData</code><code class="p">(</code><code class="kt">string</code> <code class="n">label</code><code class="p">,</code> <code class="n">Point</code> <code class="n">location</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">Label</code> <code class="p">=</code> <code class="n">label</code><code class="p">;</code>
        <code class="n">Location</code> <code class="p">=</code> <code class="n">location</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="kt">string</code> <code class="n">Label</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="p">}</code>
    <code class="k">public</code> <code class="n">Point</code> <code class="n">Location</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>Suppose you had a variable <code>r</code> containing a reference to a <code>LocationData</code>. What would happen if you wrote the expression <code>r.Location.DistanceFromOrigin()</code>? Logically, we’re asking <code>r.Location</code> to retrieve the <code>Point</code>, and since <code>Point</code> is a value type, that would entail making a copy of the value. Normally, C# will generate code that really does make a copy because it cannot in general know whether invoking some member of a <code>struct</code> will modify it. <a data-primary="defensive copies" data-type="indexterm" id="idm45884832410928"/>These are known as <em>defensive copies</em>, and they ensure that expressions like this can’t cause a nasty surprise such as changing the value of a property or field that appears to be read-only. However, since <code>Point</code> is a <code>readonly struct</code>, the compiler can know that it does not need to create a defensive copy here. In this case, it would be safe for either the C# compiler or the JIT compiler (or AoT code generator) to optimize this code by invoking <code>DistanceFromOrigin</code> directly on the value stored inside the <code>LocationData</code> without first making a copy.</p>
<div data-type="tip"><h6>Tip</h6>
<p>You are allowed to use a <code>readonly struct</code> in writable fields and properties if you want to. The <code>readonly</code> keyword guarantees only that any particular value of this type will not change. If you want to overwrite an existing value with a completely different value, that’s up to you.<a data-startref="ix_ch03-asciidoc9" data-type="indexterm" id="idm45884832373776"/><a data-startref="ix_ch03-asciidoc8" data-type="indexterm" id="idm45884832373072"/></p>
</div>
</div></section>
<section data-pdf-bookmark="Record Structs" data-type="sect2"><div class="sect2" id="idm45884832372144">
<h2>Record Structs</h2>
<p><a data-primary="C# 10.0" data-secondary="record structs" data-type="indexterm" id="idm45884832370832"/><a data-primary="record structs" data-type="indexterm" id="idm45884832369520"/><a data-primary="structs" data-secondary="record structs" data-type="indexterm" id="idm45884832368848"/>When you saw <a data-type="xref" href="#support_custom_comparison">Example 3-29</a>, you might have thought to yourself that this seems a lot like the kind of work that the compiler can do for us in a <code>record</code> type. Can we get it do the same work with a <code>struct</code>? Starting with C# 10.0, we can declare a <code>record struct</code> type, which adds the same comparison behavior that we get with a <code>class</code>-based record—the compiler would write <code>GetHashCode</code>  and both forms of the <code>Equals</code> methods for you, along with the <code>==</code> and <code>!=</code> operators.</p>
<p>Besides the usual differences between classes and value types already described, there are some other more subtle differences between <code>record</code> and <code>record struct</code> types. For example, because <code>struct</code> types have a way to declare explicitly that they are immutable (the <code>readonly</code> qualifier), when you use the positional syntax with a <code>record struct</code>, the compiler assumes that if you want a read-only type, you’ll say so by declaring it as <code>readonly record struct</code>. So although properties defined with the positional syntax are immutable on a <code>readonly record struct</code> (just as they are on a <code>record</code>), they are modifiable on a <code>record struct</code>. So whereas you cannot modify the <code>X</code> and <code>Y</code> properties of a <code>PointRecord</code> type in <a data-type="xref" href="#readonly_vs_mutable_records">Example 3-33</a> after construction, you could change the properties of a <code>PointStructRecord</code>. But <code>Poi⁠ntR⁠ead⁠on⁠ly​Str⁠uct⁠Rec⁠ord</code> gets immutable properties, just like <code>PointRecord</code>.</p>
<div data-type="example" id="readonly_vs_mutable_records">
<h5><span class="label">Example 3-33. </span>A read-only <code>record</code>, a mutable <code>record struct</code>, and a <code>readonly record struct</code></h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="n">record</code> <code class="nf">PointRecord</code><code class="p">(</code><code class="kt">int</code> <code class="n">X</code><code class="p">,</code> <code class="kt">int</code> <code class="n">Y</code><code class="p">);</code>
<code class="k">public</code> <code class="n">record</code> <code class="k">struct</code> <code class="nf">PointStructRecord</code><code class="p">(</code><code class="kt">int</code> <code class="n">X</code><code class="p">,</code> <code class="kt">int</code> <code class="n">Y</code><code class="p">);</code>
<code class="k">public</code> <code class="k">readonly</code> <code class="n">record</code> <code class="k">struct</code> <code class="nf">PointReadonlyStructRecord</code><code class="p">(</code><code class="kt">int</code> <code class="n">X</code><code class="p">,</code> <code class="kt">int</code> <code class="n">Y</code><code class="p">);</code></pre></div>
<p><code>record structs</code> also have some subtle differences around constructors, which I’ll describe in <a data-type="xref" href="#constructors">“Constructors”</a>.</p>
</div></section>
</div></section>
<section data-pdf-bookmark="Class, Structs, Records, or Tuples?" data-type="sect1"><div class="sect1" id="idm45884853414112">
<h1>Class, Structs, Records, or Tuples?</h1>
<p><a data-primary="types" data-secondary="choosing" data-type="indexterm" id="ix_ch03-asciidoc64"/>As you’ve now seen, C# offers many ways to define types. How should we choose between them? Suppose your code needs to work with a pair of coordinates representing a position in two-dimensional space? How should you represent this in C#?</p>
<p>The simplest possible answer would be to declare two variables of type <code>double</code>, one for each dimension. This certainly works, but your code will fail to capture something important: the two values are not two separate things. If your chosen type doesn’t represent the fact that these two numbers are a single entity, that will cause problems. It is inconvenient when you want to write methods that take a position as an argument—you end up needing two arguments. If you accidentally pass the X value from one coordinate pair and the Y value from a different one, the compiler will have no way of knowing this is wrong. Using two separate values is especially troublesome if you want a function to return a position, because C# methods can return only a single value.</p>
<p><a data-primary="tuples" data-secondary="when to use" data-type="indexterm" id="idm45884832318000"/>Tuples, which were described in <a data-type="xref" href="ch02.xhtml#ch_basic_coding">Chapter 2</a>, can solve the problems I just described because a single value can contain a pair of numbers: <code>(1.0, 2.0)</code>. While this is certainly an improvement, the problem with tuples is that they are unable to distinguish between different kinds of data that happen to have the same structure. This isn’t unique to tuples: built-in types have the same issue. A <code>double</code> representing a distance in feet has the same C# type as one representing a distance in meters, even though there is a significant difference in meaning. (NASA lost a space probe in 1999 due to confusion over values with identical types but different units.) But these problems go beyond mismatched units. Suppose you have a tuple <code>(X: 10.0, Y: 10.0)</code> representing the position of a rectangle in meters, and another, <code>(Width: 2.0, Height: 1.0)</code> representing its size, also in meters. The units are the same here, but position and size are quite different concepts, and yet these two tuples have exactly the same type. This can seem particularly surprising when the members of the tuples have different names—the first has <code>X</code> and <code>Y</code>, but the second has <code>Width</code> and <code>Height</code>. However, as you saw in the preceding chapter, these tuple member names are a fiction the C# compiler provides for our convenience. The real names are <code>Item1</code> and <code>Item2</code>.</p>
<p>Given the limitations of tuples, it may be more appropriate to ask: When would you ever want to use a tuple instead of a specialized type such as a record? I have found tuples very useful in private implementation details in places where there is little chance of the structural equivalence of conceptually unrelated tuple types causing a problem. For example, when using the <code>Dictionary&lt;TKey, TValue&gt;</code> container type described in <a data-type="xref" href="ch05.xhtml#ch_collections">Chapter 5</a>, it is sometimes useful for the dictionary key to be made up of more than one value. Tuples are ideal for this sort of compound key. They can also be useful when a method needs to return multiple related pieces of data in cases where defining a whole new type seems like overkill. For example, if the method is a private one called in only one or two places, is it really worth defining a whole type just to act as the return type of that one method?</p>
<p><a data-primary="record types" data-secondary="when to use" data-type="indexterm" id="idm45884832271216"/>Record types would work better than tuples for our structurally similar but conceptually different position and dimension examples: if we define <code>public record Position(double X, double Y)</code> and <code>public record Dimensions(double Width, double Height)</code>, we now have two distinct types to represent these two separate kinds of data. If we accidentally try to use positions when dimensions are required, the compiler will point out the mistake. Moreover, unlike the locally defined names we can give tuple members, the names of a record’s properties are real, so code using <code>Dimensions</code> will always to refer to its members as <code>Width</code> and <code>Height</code>. Record types automatically implement equality comparisons and hash codes, so they work just as well as tuples as compound keys in dictionaries. There are really only two reasons you might choose a tuple over a record. One is when you actually want the structural equivalence—there are some occasions where deliberately being a bit vague about types can provide extra flexibility that might justify the possible reduction in safety. And the second is in cases where defining a type seems like overkill (e.g., when using a compound key for a dictionary that is used only inside one method).</p>
<p>Since record types are full .NET types, they can contain more than just properties—they can contain any of the other member types described in the following section. Our <code>Dimensions</code> record type could include a method that calculates the area, for example. And we are free to choose between defining a reference type or a value type by using either <code>record</code> or <code>record struct</code>.</p>
<p><a data-primary="classes" data-secondary="when to use" data-type="indexterm" id="idm45884832266432"/><a data-primary="structs" data-secondary="when to use" data-type="indexterm" id="idm45884832265456"/>When would we use a class (or struct) instead of a record? One reason might be that you don’t want the equality logic. If your application has entities with their own identities—perhaps certain objects correspond to people or to particular devices—the value-based comparison logic generated for record types will be inappropriate, because two items can be distinct even if they happen to share the same characteristics. (Imagine objects representing shapes in a drawing program. If you clone a shape, you will have two identical objects, but it’s important that they are still considered different because the cloned item may then go on to be moved or otherwise modified.) So you might want to ask: does your type represent a thing, or does it just hold some information? If it represents some information, a record type is likely to be a good choice, but a class may well be a better bet for entities that represent some real entity, especially if instances of the type have behavior of their own. For example, when building a user interface, an interactive element such as a button would be better modeled as a <code>class</code> than a <code>record</code>. It’s not that a record type couldn’t be made to work—they can be made to do more or less anything ordinary classes and structs can do; it’s just that they are likely to be a less good fit.<a data-startref="ix_ch03-asciidoc64" data-type="indexterm" id="idm45884832262480"/></p>
</div></section>
<section data-pdf-bookmark="Members" data-type="sect1"><div class="sect1" id="members">
<h1>Members</h1>
<p><a data-primary="members" data-type="indexterm" id="ix_ch03-asciidoc12"/><a data-primary="types" data-secondary="members" data-type="indexterm" id="ix_ch03-asciidoc13"/>Whether you’re writing a class, a struct, or a record, there are several different kinds of members you can put in a custom type. We’ve seen examples of some already, but let’s take a closer and more comprehensive look.</p>
<section data-pdf-bookmark="Accessibility" data-type="sect2"><div class="sect2" id="member_accessibility">
<h2>Accessibility</h2>
<p><a data-primary="members" data-secondary="accessibility" data-type="indexterm" id="idm45884832255872"/><a data-primary="internal members" data-type="indexterm" id="idm45884832254672"/>You can specify the accessibility for most class and struct members. Just as a type can be <code>public</code> or <code>internal</code>, so can each member. Members may also be declared as <code>private</code>, making them accessible only to code inside the type, and this is the default accessibility. As we’ll see in <a data-type="xref" href="ch06.xhtml#ch_inheritance">Chapter 6</a>, inheritance adds three more accessibility levels for members: <code>protected</code>, <code>protected internal</code>, and <code>protected private</code>.</p>
</div></section>
<section data-pdf-bookmark="Fields" data-type="sect2"><div class="sect2" id="fields">
<h2>Fields</h2>
<p><a data-primary="fields" data-secondary="members and" data-type="indexterm" id="ix_ch03-asciidoc14"/><a data-primary="members" data-secondary="fields" data-type="indexterm" id="ix_ch03-asciidoc15"/>You’ve already seen that fields are named storage locations that hold either values or references depending on their type. By default, each instance of a type gets its own set of fields, but if you want a field to be singular, rather than having one per instance, you can use the <code>static</code> keyword. <a data-primary="readonly keyword" data-type="indexterm" id="idm45884832245296"/>You can also apply the <code>readonly</code> keyword to a field, which states that it can be set only during initialization and cannot change thereafter.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>The <code>readonly</code> keyword does not make any absolute guarantees. There are mechanisms by which it is possible to contrive a change in the value of a <code>readonly</code> field. The reflection mechanisms discussed in <a data-type="xref" href="ch13.xhtml#ch_reflection">Chapter 13</a> provide one way, and unsafe code, which lets you work directly with raw pointers, provides another. The compiler will prevent you from modifying a field accidentally, but with sufficient determination, you can bypass this protection. And even without such subterfuge, a <code>readonly</code> field is free to change during construction.</p>
</div>
<p><a data-primary="const field" data-type="indexterm" id="idm45884832240256"/>C# offers a keyword that seems, superficially, to be similar: you can define a <code>const</code> field. However, this is designed for a somewhat different purpose. A <code>readonly</code> field is initialized and then never changed, whereas a <code>const</code> field defines a value that is <span class="keep-together">invariably</span> the same. A <code>readonly</code> field is much more flexible: it can be of any type, and its value can be calculated at runtime, which means you can define either per-instance or <code>static</code> fields as <code>readonly</code>. A <code>const</code> field’s value is determined at compile time, which means it is defined at the class level (because there’s no way for individual instances to have different values). This also limits the available types. For most reference types, the only supported <code>const</code> value is <code>null</code>, so in practice, it’s normally only useful to use <code>const</code> with types intrinsically supported by the compiler. (Specifically, if you want to use values other than <code>null</code>, a <code>const</code>’s type must be one of the built-in numeric types, <code>bool</code>, <code>string</code>, or an enumeration type, as described later in this chapter.)</p>
<p>This makes a <code>const</code> field rather more limited than a <code>readonly</code> one, so you could reasonably ask: What’s the point? Well, although a <code>const</code> field is inflexible, it makes a strong statement about the unchanging nature of the value. For example, .NET’s <code>Math</code> class defines a <code>const</code> field of type <code>double</code> called <code>PI</code> that contains as close an approximation to the mathematical constant π as a <code>double</code> can represent. That’s a value that’s fixed forever—thus it is a constant in a very strong sense.</p>
<p>When it comes to less inherently constant values, you need to be a bit careful about <code>const</code> fields; the C# specification allows the compiler to assume that the value really will never change. Code that reads the value of a <code>readonly</code> field will fetch the value from the memory containing the field at runtime. But when you use a <code>const</code> field, the compiler can read the value at compile time and copy it into the IL as though it were a literal. So if you write a library component that declares a <code>const</code> field and you later change its value, this change will not necessarily be picked up by code using your library unless that code gets recompiled.</p>
<p>One of the benefits of a <code>const</code> field is that it is eligible for use in certain contexts in which a <code>readonly</code> field is not. For example, if you want to use a constant pattern (<a data-type="xref" href="ch02.xhtml#ch_basic_coding">Chapter 2</a> introduced patterns), perhaps in the label for a <code>case</code> in a <code>switch</code> statement, the value you specify has to be fixed at compile time. So a constant pattern cannot refer to a <code>readonly</code> field, but you can use a suitably typed <code>const</code> field. You can also use <code>const</code> fields in the expression defining the value of another <code>const</code> field (as long as you don’t introduce any circular references).</p>
<p>A <code>const</code> field is required to contain an expression defining its value, such as the one shown in <a data-type="xref" href="#const_field">Example 3-34</a>.</p>
<div data-type="example" id="const_field">
<h5><span class="label">Example 3-34. </span>A <code>const</code> field</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">const</code> <code class="kt">double</code> <code class="n">kilometersPerMile</code> <code class="p">=</code> <code class="m">1.609344</code><code class="p">;</code></pre></div>
<p><a data-primary="initializers" data-secondary="field" data-type="indexterm" id="idm45884832201104"/>While mandatory for a <code>const</code>, this initializer expression is optional for a class’s ordinary and <code>readonly</code><sup><a data-type="noteref" href="ch03.xhtml#idm45884832211984" id="idm45884832211984-marker">4</a></sup> fields. If you omit the initializing expression, the field will automatically be initialized to a default value. (That’s 0 for numeric values and the equivalents for other types—<code>false</code>, <code>null</code>, etc.)</p>
<p>Instance field initializers run as part of construction, i.e., when you use the <code>new</code> keyword (or some equivalent mechanism such as constructing an instance through reflection, as described in <a data-type="xref" href="ch13.xhtml#ch_reflection">Chapter 13</a>). This means you should be wary of using field initializers in value types. A <code>struct</code> can be initialized implicitly, in which case its instance fields are set to 0 (or <code>false</code>, etc.). Starting with C# 10.0, you can write instance field initializers in a <code>struct</code>, but these will only run if that <code>struct</code> is <em>explicitly</em> initialized. If you create an array whose elements are some value type with field initializers, all the fields of all the elements in the array will start out with values of 0; if you want the field initializers to run, you’ll need to write a loop that uses <code>new</code> to initialize each element in the array. Likewise when you use a <code>struct</code> type as a field, it will be zero-initialized, and its field initializers will run only if you explicitly initialize the field with the <code>new</code> keyword. (Instance field initializers in a <code>class</code> also run only when that <code>class</code> is constructed, but the big difference is that it’s not possible to get hold of an instance of a <code>class</code> without running one of its constructors.<sup><a data-type="noteref" href="ch03.xhtml#fn20" id="fn20-marker">5</a></sup> There are common situations in which you will be able to use a <code>struct</code> instance that was implicitly zero-initialized.) Initializers for noninstance fields (i.e., <code>const</code> and <code>static</code> fields) will always be executed for structs, though.</p>
<p>If you do supply an initializer expression for a non-<code>const</code> field, it does not need to be evaluable at compile time, so it can do runtime work such as calling methods or reading properties. Of course, this sort of code can have side effects, so it’s important to be aware of the order in which initializers run.</p>
<p>Nonstatic field initializers run for each instance you create, and they execute in the order in which they appear in the file, immediately before the constructor runs. Static field initializers execute no more than once, no matter how many instances of the type you create. They also execute in the order in which they are declared, but it’s harder to pin down exactly when they will run. If your class has no static constructor, C# guarantees to run field initializers before the first time a field in the class is accessed, but it doesn’t necessarily wait until the last minute—it retains the right to run field initializers as early as it likes. (The exact moment at which this happens has varied across releases of .NET.) But if a static constructor does exist, then things are slightly clearer: static field initializers run immediately before the static constructor runs, but that merely raises the questions: What’s a static constructor, and when does it run? So we had better take a look at constructors.<a data-startref="ix_ch03-asciidoc15" data-type="indexterm" id="idm45884832184880"/><a data-startref="ix_ch03-asciidoc14" data-type="indexterm" id="idm45884832184176"/></p>
</div></section>
<section data-pdf-bookmark="Constructors" data-type="sect2"><div class="sect2" id="constructors">
<h2>Constructors</h2>
<p><a data-primary="constructors" data-type="indexterm" id="ix_ch03-asciidoc16"/><a data-primary="members" data-secondary="constructors" data-type="indexterm" id="ix_ch03-asciidoc17"/>A newly created object may require some information to do its job. For example, the <code>Uri</code> class in the <code>System</code> namespace represents a <em>Uniform Resource Identifier</em> (URI) such as a URL. Since its entire purpose is to contain and provide information about a URI, there wouldn’t be much point in having a <code>Uri</code> object that didn’t know what its URI was. So it’s not actually possible to create one without providing a URI. If you try the code in <a data-type="xref" href="#error_failing_to_provide_a_uri_with_its">Example 3-35</a>, you’ll get a compiler error.</p>
<div data-type="example" id="error_failing_to_provide_a_uri_with_its">
<h5><span class="label">Example 3-35. </span>Error: failing to provide a <code>Uri</code> with its URI</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">Uri</code> <code class="n">oops</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Uri</code><code class="p">();</code>  <code class="c1">// Will not compile</code></pre></div>
<p>The <code>Uri</code> class defines several <em>constructors</em>, members that contain code that initializes a new instance of a type. If a particular class requires certain information to work, you can enforce this requirement through constructors. Creating an instance of a class almost always involves using a constructor at some point, so if the constructors you define all demand certain information, developers will have to provide that information if they want to use your class. So all of the <code>Uri</code> class’s constructors need to be given the URI in one form or another.</p>
<p>To define a constructor, you first specify the accessibility (<code>public</code>, <code>private</code>, <code>internal</code>, etc.) and then the name of the containing type. This is followed by a list of parameters in parentheses (which can be empty). <a data-type="xref" href="#class_with_one_constructor">Example 3-36</a> shows a class that defines a single constructor that requires two arguments: one of type <code>decimal</code> and one of type <code>string</code>. The argument list is followed by a block containing code. So constructors look a lot like methods but with the containing type name in place of the usual return type and method name.</p>
<div data-type="example" id="class_with_one_constructor">
<h5><span class="label">Example 3-36. </span>A class with one constructor</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">class</code> <code class="nc">Item</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="nf">Item</code><code class="p">(</code><code class="kt">decimal</code> <code class="n">price</code><code class="p">,</code> <code class="kt">string</code> <code class="n">name</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">_price</code> <code class="p">=</code> <code class="n">price</code><code class="p">;</code>
        <code class="n">_name</code> <code class="p">=</code> <code class="n">name</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="k">private</code> <code class="k">readonly</code> <code class="kt">decimal</code> <code class="n">_price</code><code class="p">;</code>
    <code class="k">private</code> <code class="k">readonly</code> <code class="kt">string</code> <code class="n">_name</code><code class="p">;</code>
<code class="p">}</code></pre></div>
<p>This constructor is pretty simple: it just copies its arguments to fields. A lot of constructors do no more than that. You’re free to put as much code in there as you like, but by convention, developers usually expect the constructor to do very little—its main job is to ensure that the object is in a valid initial state. That might involve checking the arguments and throwing an exception if there’s a problem, but not much else. You are likely to surprise developers who use your class if you write a constructor that does something nontrivial, such as adding data to a database or sending a message over the network.</p>
<p><a data-type="xref" href="#using_a_constructor">Example 3-37</a> shows how to use the constructor defined by <a data-type="xref" href="#class_with_one_constructor">Example 3-36</a>. We just use the <code>new</code> operator, passing in suitably typed values as arguments.</p>
<div data-type="example" id="using_a_constructor">
<h5><span class="label">Example 3-37. </span>Using a constructor</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">item1</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Item</code><code class="p">(</code><code class="m">9.99</code><code class="n">M</code><code class="p">,</code> <code class="s">"Hammer"</code><code class="p">);</code></pre></div>
<p>You can define multiple constructors, but it must be possible to distinguish between them: you cannot define two constructors that both take the same number of arguments of the same types, because there would be no way for the <code>new</code> keyword to know which one you meant.</p>
<p>Earlier, I showed how a record type can require certain properties to be present. <a data-type="xref" href="#record_type_generated_constructor">Example 3-38</a> shows a <code>record</code> similar to the <code>Item</code> class from <a data-type="xref" href="#class_with_one_constructor">Example 3-36</a> (although this makes the relevant data public). When you do this, you are in effect defining 
<span class="keep-together">a constructor.</span></p>
<div data-type="example" id="record_type_generated_constructor">
<h5><span class="label">Example 3-38. </span>Record type with compiler-generated constructors</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="n">record</code> <code class="nf">Item</code><code class="p">(</code><code class="kt">decimal</code> <code class="n">Price</code><code class="p">,</code> <code class="kt">string</code> <code class="n">Name</code><code class="p">);</code></pre></div>
<p>With this example, the compiler will emit a constructor taking a <code>decimal</code> and a <code>string</code> argument. The generated constructor will use those arguments to initialize the <code>Price</code> and <code>Name</code> properties. As you saw earlier in <a data-type="xref" href="#mutable_record_type">Example 3-13</a>, you’re free to supply your own constructor if you want to, but in cases where the compiler-generated one does what you need, it’s very convenient. This is not the only kind of constructor that the compiler can generate for you.</p>
<section data-pdf-bookmark="Default constructors and zero-argument constructors" data-type="sect3"><div class="sect3" id="idm45884831993584">
<h3>Default constructors and zero-argument constructors</h3>
<p><a data-primary="constructors" data-secondary="default" data-type="indexterm" id="ix_ch03-asciidoc18"/><a data-primary="constructors" data-secondary="zero-argument" data-type="indexterm" id="ix_ch03-asciidoc19"/><a data-primary="default constructors" data-type="indexterm" id="ix_ch03-asciidoc20"/><a data-primary="zero-argument constructors" data-type="indexterm" id="ix_ch03-asciidoc21"/>If you do not define any constructors at all, C# will provide a <em>default constructor</em> that is equivalent to an empty constructor that takes no arguments. And if you’re writing a struct, you’ll get that even if you do define other constructors.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Although the C# specification unambiguously defines a default constructor as one generated for you by the compiler, be aware that there’s another widely used meaning. You will often see the term <em>default constructor</em> used to mean any public, parameterless constructor, regardless of whether it was generated by the compiler. There’s some logic to this—when using a class, it’s not possible to tell the difference between a compiler-generated constructor and an explicit zero-argument constructor, so if the term <em>default constructor</em> is to mean anything useful from that perspective, it can mean only a public constructor that takes no arguments. However, that’s not how the C# specification defines the term.</p>
</div>
<p>The compiler-generated default constructor does nothing beyond the zero initialization of fields, which is the starting point for all new objects. However, there are some situations in which it is necessary to write your own parameterless constructor. You might need the constructor to execute some code. <a data-type="xref" href="#nonempty_zero-argument_constructor">Example 3-39</a> sets an <code>_id</code> field based on a static field that it increments for each new object to give each instance a distinct ID. This doesn’t require any arguments to be passed in, but it does involve running some code.</p>
<div data-type="example" id="nonempty_zero-argument_constructor">
<h5><span class="label">Example 3-39. </span>A nonempty zero-argument constructor</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">class</code> <code class="nc">ItemWithId</code>
<code class="p">{</code>
    <code class="k">private</code> <code class="k">static</code> <code class="kt">int</code> <code class="n">_lastId</code><code class="p">;</code>
    <code class="k">private</code> <code class="kt">int</code> <code class="n">_id</code><code class="p">;</code>

    <code class="k">public</code> <code class="nf">ItemWithId</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">_id</code> <code class="p">=</code> <code class="p">++</code><code class="n">_lastId</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>There is another way to achieve the same effect as <a data-type="xref" href="#nonempty_zero-argument_constructor">Example 3-39</a>. I could have written a static method called <code>GetNextId</code>, and then used that in the <code>_id</code> field initializer. Then I wouldn’t have needed to write this constructor. However, there is one advantage to putting code in the constructor: field initializers are not allowed to invoke the object’s own nonstatic methods but constructors are. That’s because the object is in an incomplete state during field initialization, so it may be dangerous to call its nonstatic methods—they may rely on fields having valid values. But an object is allowed to call its own nonstatic methods inside a constructor, because although the object’s still not fully built yet, it’s closer to completion, and so the dangers are reduced.</p>
<p>There are other reasons for writing your own zero-argument constructor. If you define at least one constructor for a class, this will disable the default constructor generation. If you need your class to provide parameterized construction, but you still want to offer a no-arguments constructor, you’ll need to write one, even if it’s empty. Alternatively, if you want to write a class whose only constructor is an empty, zero-argument one, but with a protection level other than the default of <code>public</code>—you might want to make it <code>private</code> so that only your code can create instances, for example—you would need to write the constructor explicitly even if it is empty so that you have somewhere to specify the protection level.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Some frameworks can use only classes that provide a public, zero-argument constructor. For example, if you build a UI with Windows Presentation Foundation (WPF), classes that can act as custom UI elements usually need such a constructor.</p>
</div>
<p>With structs, zero-argument constructors work slightly differently, because value types need to support implicit initialization. When a value type is used as a field of some other type, or the element type of an array, the memory that holds the value is part of the containing object, and when you create a new object or array, the CLR always fills its memory with zeros. This means that it is always possible to initialize a value without passing any constructor arguments. So whereas C# removes the default constructor for a class when you add a constructor that takes arguments, it does not do this for a struct (including <code>record struct</code> types)—even if it did hide it, you’d still be able to invoke this implicit initialization indirectly, e.g., by creating a one-element array of that type: <code>MyStruct s = (new MyStruct[1])[0];</code>. Since implicit initialization is always available for a struct, there would be no sense in the compiler hiding the corresponding constructor.</p>
<p><a data-primary="C# 10.0" data-secondary="zero-argument constructors" data-type="indexterm" id="idm45884831942192"/>Up until C# 10.0, you weren’t allowed to write a zero-argument constructor for a struct because there are so many scenarios in which that constructor would not run. (This is the same reason that structs didn’t use to support instance field initializers: it’s essentially the same issue because field initializers run as part of construction.) You can now write a zero-argument constructor for a struct, but as with field initializers, be aware that it will only run in cases where your code explicitly invokes the constructor. The CLR’s zero initialization is used in most cases.</p>
<p>There’s one more important compiler-generated constructor type to be aware of: when you write a <code>record</code> or <code>record class</code>, the compiler generates a constructor that gets used to create a duplicate whenever you use the <code>with</code> syntax shown back in <a data-type="xref" href="#modified_copy_of_record_type">Example 3-12</a>. (This is known as a <em>copy constructor</em>, although if you’re familiar with <span class="keep-together">C++</span>, don’t be misled: this is used only within <code>record</code> types and is not a general-purpose copy mechanism. C# has no support for using a copy constructor in an ordinary class.) It performs a shallow copy by default, much as you get when copying a <code>struct</code>, but if you want to, you can write your own implementation, as <a data-type="xref" href="#record_custom_copy_constructor">Example 3-40</a> shows.</p>
<div data-type="example" id="record_custom_copy_constructor">
<h5><span class="label">Example 3-40. </span>Record type with customized copy constructor</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="n">record</code> <code class="nf">ValueWithId</code><code class="p">(</code><code class="kt">int</code> <code class="n">Value</code><code class="p">,</code> <code class="kt">int</code> <code class="n">Id</code><code class="p">)</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="nf">ValueWithId</code><code class="p">(</code><code class="n">ValueWithId</code> <code class="n">source</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">Value</code> <code class="p">=</code> <code class="n">source</code><code class="p">.</code><code class="n">Value</code><code class="p">;</code>
        <code class="n">Id</code> <code class="p">=</code> <code class="n">source</code><code class="p">.</code><code class="n">Id</code> <code class="p">+</code> <code class="m">1</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>This prevents the compiler from generating the usual copy constructor. Yours will be used whenever the <code>with</code> syntax causes a copy of your type to be created.</p>
<p>The compiler does not generate a copy constructor for a <code>record struct</code>. There’s no need, because all <code>struct</code> types are inherently copyable. And although nothing stops you from writing a constructor similar to the one in <a data-type="xref" href="#record_custom_copy_constructor">Example 3-40</a> for a <code>record struct</code>, the compiler will not use it.<a data-startref="ix_ch03-asciidoc21" data-type="indexterm" id="idm45884831835808"/><a data-startref="ix_ch03-asciidoc20" data-type="indexterm" id="idm45884831835104"/><a data-startref="ix_ch03-asciidoc19" data-type="indexterm" id="idm45884831834432"/><a data-startref="ix_ch03-asciidoc18" data-type="indexterm" id="idm45884831833760"/></p>
</div></section>
<section data-pdf-bookmark="Chaining constructors" data-type="sect3"><div class="sect3" id="idm45884831992992">
<h3>Chaining constructors</h3>
<p><a data-primary="chaining constructors" data-type="indexterm" id="ix_ch03-asciidoc22"/><a data-primary="constructors" data-secondary="chaining" data-type="indexterm" id="ix_ch03-asciidoc23"/>If you write a type that offers several constructors, you may find that they have a certain amount in common—there are often initialization tasks that all constructors have to perform. The class in <a data-type="xref" href="#nonempty_zero-argument_constructor">Example 3-39</a> calculates a numeric identifier for each object in its constructor, and if it were to provide multiple constructors, they might all need to do that same work. Moving the work into a field initializer would be one way to solve that, but what if only some constructors wanted to do it? You might have work that was common to most constructors, but you might want to make an exception by having one constructor that allows the ID to be specified rather than calculated. The field initializer approach would no longer be appropriate, because you’d want individual constructors to be able to opt in or out. <a data-type="xref" href="#optional_chaining_of_constructors">Example 3-41</a> shows a modified version of the code from <a data-type="xref" href="#nonempty_zero-argument_constructor">Example 3-39</a>, defining two extra constructors.</p>
<div data-type="example" id="optional_chaining_of_constructors">
<h5><span class="label">Example 3-41. </span>Optional chaining of constructors</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code><code> </code><code class="k">class</code><code> </code><code class="nc">ItemWithId</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">private</code><code> </code><code class="k">static</code><code> </code><code class="kt">int</code><code> </code><code class="n">_lastId</code><code class="p">;</code><code>
</code><code>    </code><code class="k">private</code><code> </code><code class="kt">int</code><code> </code><code class="n">_id</code><code class="p">;</code><code>
</code><code>    </code><code class="k">private</code><code> </code><code class="kt">string?</code><code> </code><code class="n">_name</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="nf">ItemWithId</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="n">_id</code><code> </code><code class="p">=</code><code> </code><code class="p">+</code><code class="p">+</code><code class="n">_lastId</code><code class="p">;</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code>
</code><code>    </code><strong><code class="k">public</code><code> </code><code class="nf">ItemWithId</code><code class="p">(</code><code class="kt">string</code><code> </code><code class="n">name</code><code class="p">)</code></strong><code>
</code><code>        </code><strong><code class="p">:</code><code> </code><code class="k">this</code><code class="p">(</code><code class="p">)</code></strong><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="n">_name</code><code> </code><code class="p">=</code><code> </code><code class="n">name</code><code class="p">;</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="nf">ItemWithId</code><code class="p">(</code><code class="kt">string</code><code> </code><code class="n">name</code><code class="p">,</code><code> </code><code class="kt">int</code><code> </code><code class="n">id</code><code class="p">)</code><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="n">_name</code><code> </code><code class="p">=</code><code> </code><code class="n">name</code><code class="p">;</code><code>
</code><code>        </code><code class="n">_id</code><code> </code><code class="p">=</code><code> </code><code class="n">id</code><code class="p">;</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code class="p">}</code></pre></div>
<p>If you look at the second constructor in <a data-type="xref" href="#optional_chaining_of_constructors">Example 3-41</a>, its parameter list is followed by a colon and then <code>this()</code>, which invokes the first constructor. A constructor can invoke any other constructor that way. <a data-type="xref" href="#chained_constructor_arguments">Example 3-42</a> shows a different way to structure all three constructors, illustrating how to pass arguments.</p>
<div data-type="example" id="chained_constructor_arguments">
<h5><span class="label">Example 3-42. </span>Chained constructor arguments</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="nf">ItemWithId</code><code class="p">()</code>
    <code class="p">:</code> <code class="k">this</code><code class="p">(</code><code class="k">null</code><code class="p">)</code>
<code class="p">{</code>
<code class="p">}</code>

<code class="k">public</code> <code class="nf">ItemWithId</code><code class="p">(</code><code class="kt">string?</code> <code class="n">name</code><code class="p">)</code>
    <code class="p">:</code> <code class="k">this</code><code class="p">(</code><code class="n">name</code><code class="p">,</code> <code class="p">++</code><code class="n">_lastId</code><code class="p">)</code>
<code class="p">{</code>
<code class="p">}</code>

<code class="k">private</code> <code class="nf">ItemWithId</code><code class="p">(</code><code class="kt">string?</code> <code class="n">name</code><code class="p">,</code> <code class="kt">int</code> <code class="n">id</code><code class="p">)</code>
<code class="p">{</code>
    <code class="n">_name</code> <code class="p">=</code> <code class="n">name</code><code class="p">;</code>
    <code class="n">_id</code> <code class="p">=</code> <code class="n">id</code><code class="p">;</code>
<code class="p">}</code></pre></div>
<p>The two-argument constructor here is now the only one that actually does any work. The other constructors just pick suitable arguments for that main constructor. This is arguably a cleaner solution than the previous examples, because the work of initializing the fields is done in just one place, rather than having different constructors each performing their own smattering of field <span class="keep-together">initialization.</span></p>
<p>Notice that I’ve made the two-argument constructor in <a data-type="xref" href="#chained_constructor_arguments">Example 3-42</a> <code>private</code>. At first glance, it can look a bit odd to define a way of building an instance of a class and then make it inaccessible, but it makes perfect sense when chaining constructors. And there are other scenarios in which a private constructor might be useful—we might want to write a method that makes a clone of an existing <code>ItemWithId</code>, in which case that constructor would be useful, but by keeping it private, we retain control of exactly how new objects get created. It can sometimes even be useful to make all of a type’s constructors <code>private</code>, forcing users of the type to go through what’s sometimes called a <em>factory method</em> (a <code>static</code> method that creates an object) to get hold of an instance. There are two common reasons for doing this. One is if full initialization of the object requires additional work of a kind that is inadvisable in a constructor (e.g., if you need to do slow work that uses the asynchronous language features described in <a data-type="xref" href="ch17.xhtml#ch_asynchronous_language_features">Chapter 17</a>, you cannot put that code inside a constructor). Another is if you want to use inheritance (see <a data-type="xref" href="ch06.xhtml#ch_inheritance">Chapter 6</a>) to provide multiple variations on a type, but you want to be able to decide at runtime which particular type is returned.<a data-startref="ix_ch03-asciidoc23" data-type="indexterm" id="idm45884831658672"/><a data-startref="ix_ch03-asciidoc22" data-type="indexterm" id="idm45884831658000"/></p>
</div></section>
<section data-pdf-bookmark="Static constructors" data-type="sect3"><div class="sect3" id="static_constructors">
<h3>Static constructors</h3>
<p><a data-primary="constructors" data-secondary="static" data-type="indexterm" id="ix_ch03-asciidoc24"/><a data-primary="static constructors" data-type="indexterm" id="ix_ch03-asciidoc25"/>The constructors we’ve looked at so far run when a new instance of an object is created. Classes and structs can also define a static constructor. This runs at most once in the lifetime of the application. You do not invoke it explicitly—C# ensures that it runs automatically at some point before you first use the class. So, unlike an instance constructor, there’s no opportunity to pass arguments. Since static constructors cannot take arguments, there can be only one per class. Also, because these are never accessed explicitly, you do not declare any kind of accessibility for a static constructor. <a data-type="xref" href="#class_with_static_constructor">Example 3-43</a> shows a class with a static constructor.</p>
<div data-type="example" id="class_with_static_constructor">
<h5><span class="label">Example 3-43. </span>Class with static constructor</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">class</code> <code class="nc">Bar</code>
<code class="p">{</code>
    <code class="k">private</code> <code class="k">static</code> <code class="n">DateTime</code> <code class="n">_firstUsed</code><code class="p">;</code>
    <code class="k">static</code> <code class="nf">Bar</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"Bar's static constructor"</code><code class="p">);</code>
        <code class="n">_firstUsed</code> <code class="p">=</code> <code class="n">DateTime</code><code class="p">.</code><code class="n">Now</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<p><a data-primary="initializers" data-secondary="field" data-type="indexterm" id="idm45884831534304"/>Just as an instance constructor puts the instance into a useful initial state, the static constructor provides an opportunity to initialize any static fields.</p>
<p>By the way, you’re not obliged to ensure that a constructor (static or instance) initializes every field. When a new instance of a class is created, the instance fields are initially all set to 0 (or the equivalent, such as <code>false</code> or <code>null</code>). Likewise, a type’s static fields are all zeroed out before the class is first used. Unlike with local variables, you only need to initialize fields if you want to set them to something other than the default zero-like value.</p>
<p>Even then, you may not need a constructor. A field initializer may be sufficient. However, it’s useful to know exactly when constructors and field initializers run. I mentioned earlier that the behavior varies according to whether constructors are present, so now that we’ve looked at constructors in a bit more detail, I can finally show a more complete picture of initialization. (There will still be more to come—as <a data-type="xref" href="ch06.xhtml#ch_inheritance">Chapter 6</a> describes, inheritance adds another dimension.)</p>
<p>At runtime, a type’s static fields will first be set to 0 (or equivalent values). Next, the field initializers run in the order in which they are written in the source file. This ordering matters if one field’s initializer refers to another. In <a data-type="xref" href="#significant_ordering_of_static_fields">Example 3-44</a>, fields <code>a</code> and <code>c</code> both have the same initializer expression, but they end up with different values (1 and 42, respectively) due to the order in which initializers run.</p>
<div data-type="example" id="significant_ordering_of_static_fields">
<h5><span class="label">Example 3-44. </span>Significant ordering of static fields</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">private</code> <code class="k">static</code> <code class="kt">int</code> <code class="n">a</code> <code class="p">=</code> <code class="n">b</code> <code class="p">+</code> <code class="m">1</code><code class="p">;</code>
<code class="k">private</code> <code class="k">static</code> <code class="kt">int</code> <code class="n">b</code> <code class="p">=</code> <code class="m">41</code><code class="p">;</code>
<code class="k">private</code> <code class="k">static</code> <code class="kt">int</code> <code class="n">c</code> <code class="p">=</code> <code class="n">b</code> <code class="p">+</code> <code class="m">1</code><code class="p">;</code></pre></div>
<p>The exact moment at which static field initializers run depends on whether there’s a static constructor. As mentioned earlier, if there isn’t, then the timing is not defined—C# guarantees to run them no later than the first access to one of the type’s fields, but it reserves the right to run them arbitrarily early. The presence of a static constructor changes matters: in that case, the static field initializers run immediately before the constructor. So when does the constructor run? It will be triggered by one of two events, whichever occurs first: creating an instance or accessing any static member of the class.</p>
<p>For nonstatic fields, the story is similar: the fields are first all initialized to 0 (or equivalent values), and then field initializers run in the order in which they appear in the source file, and this happens before the constructor runs. The difference is that instance constructors are invoked explicitly, so it’s clear when this initialization occurs.</p>
<p>I’ve written a class called <code>InitializationTestClass</code> designed to illustrate this construction behavior, shown in <a data-type="xref" href="#initialization_order">Example 3-45</a>. The class has both static and nonstatic fields, all of which call a method, <code>GetValue</code>, in their initializers. That method always returns the same value, 1, but it prints out a message so we can see when it is called. The class also defines a no-arguments instance constructor and a static constructor, both of which print out messages.</p>
<div data-type="example" id="initialization_order">
<h5><span class="label">Example 3-45. </span>Initialization order</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">class</code> <code class="nc">InitializationTestClass</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="nf">InitializationTestClass</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"Constructor"</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">static</code> <code class="nf">InitializationTestClass</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"Static constructor"</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">static</code> <code class="kt">int</code> <code class="n">s1</code> <code class="p">=</code> <code class="n">GetValue</code><code class="p">(</code><code class="s">"Static field 1"</code><code class="p">);</code>
    <code class="k">public</code> <code class="kt">int</code> <code class="n">ns1</code> <code class="p">=</code> <code class="n">GetValue</code><code class="p">(</code><code class="s">"Non-static field 1"</code><code class="p">);</code>
    <code class="k">public</code> <code class="k">static</code> <code class="kt">int</code> <code class="n">s2</code> <code class="p">=</code> <code class="n">GetValue</code><code class="p">(</code><code class="s">"Static field 2"</code><code class="p">);</code>
    <code class="k">public</code> <code class="kt">int</code> <code class="n">ns2</code> <code class="p">=</code> <code class="n">GetValue</code><code class="p">(</code><code class="s">"Non-static field 2"</code><code class="p">);</code>

    <code class="k">private</code> <code class="k">static</code> <code class="kt">int</code> <code class="nf">GetValue</code><code class="p">(</code><code class="kt">string</code> <code class="n">message</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">message</code><code class="p">);</code>
        <code class="k">return</code> <code class="m">1</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">static</code> <code class="k">void</code> <code class="nf">Foo</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"Static method"</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="k">class</code> <code class="nc">Program</code>
<code class="p">{</code>
    <code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"Main"</code><code class="p">);</code>
        <code class="n">InitializationTestClass</code><code class="p">.</code><code class="n">Foo</code><code class="p">();</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"Constructing 1"</code><code class="p">);</code>
        <code class="kt">var</code> <code class="n">i</code> <code class="p">=</code> <code class="k">new</code> <code class="n">InitializationTestClass</code><code class="p">();</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"Constructing 2"</code><code class="p">);</code>
        <code class="n">i</code> <code class="p">=</code> <code class="k">new</code> <code class="n">InitializationTestClass</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>The <code>Main</code> method prints out a message, calls a static method defined by <code>Ini⁠tia⁠liz⁠ati⁠on​Tes⁠tCla⁠ss</code>, and then constructs a couple of instances. Running the program, I see the following output:</p>
<pre data-type="programlisting">Main
Static field 1
Static field 2
Static constructor
Static method
Constructing 1
Non-static field 1
Non-static field 2
Constructor
Constructing 2
Non-static field 1
Non-static field 2
Constructor</pre>
<p>Notice that both static field initializers and the static constructor run before the call to the static method (<code>Foo</code>) begins. The field initializers run before the static constructor, and as expected, they run in the order in which they appear in the source file. Because this class includes a static constructor, we know when static initialization will begin—it is triggered by the first use of that type, which in this example is when our <code>Main</code> method calls <code>InitializationTestClass.Foo</code>. You can see that it happens immediately before that point and no earlier, because our <code>Main</code> method manages to print out its first message before the static initialization occurs. If this example did not have a static constructor, and had only static field initializers, there would be no guarantee that static initialization would happen at the exact same point; the C# specification allows the initialization to happen earlier.</p>
<p>You need to be careful about what you do in code that runs during static initialization: it may run earlier than you expect. For example, suppose your program uses some sort of diagnostic logging mechanism, and you need to configure this when the program starts in order to enable logging of messages to the proper location. There’s always a possibility that code that runs during static initialization could execute before you’ve managed to do this, meaning that diagnostic logging will not yet be working correctly. That might make problems in this code hard to debug. Even when you narrow down C#’s options by supplying a static constructor, it’s relatively easy to run that earlier than you intended. Use of any static member of a class will trigger its initialization, and you can find yourself in a situation where your static constructor is kicked off by static field initializers in some other class that doesn’t have a static constructor—this could happen before your <code>Main</code> method even starts.</p>
<p>You could try to fix this by initializing the logging code in its own static initialization. Because C# guarantees to run initialization before the first use of a type, you might think that this would ensure that the logging initialization would complete before the static initialization of any code that uses the logging system. However, there’s a potential problem: C# guarantees only when it will <em>start</em> static initialization for any particular class. It doesn’t guarantee to wait for it to finish. It cannot make such a guarantee, because if it did, code such as the peculiarly British <a data-type="xref" href="#circular_static_dependencies">Example 3-46</a> would put it in an impossible situation.</p>
<div data-type="example" id="circular_static_dependencies">
<h5><span class="label">Example 3-46. </span>Circular static dependencies</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">class</code> <code class="nc">AfterYou</code>
<code class="p">{</code>
    <code class="k">static</code> <code class="nf">AfterYou</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"AfterYou static constructor starting"</code><code class="p">);</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"AfterYou: NoAfterYou.Value = "</code> <code class="p">+</code> <code class="n">NoAfterYou</code><code class="p">.</code><code class="n">Value</code><code class="p">);</code>
        <code class="n">Value</code> <code class="p">=</code> <code class="m">123</code><code class="p">;</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"AfterYou static constructor ending"</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">static</code> <code class="kt">int</code> <code class="n">Value</code> <code class="p">=</code> <code class="m">42</code><code class="p">;</code>
<code class="p">}</code>

<code class="k">public</code> <code class="k">class</code> <code class="nc">NoAfterYou</code>
<code class="p">{</code>
    <code class="k">static</code> <code class="nf">NoAfterYou</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"NoAfterYou static constructor starting"</code><code class="p">);</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"NoAfterYou: AfterYou.Value: = "</code> <code class="p">+</code> <code class="n">AfterYou</code><code class="p">.</code><code class="n">Value</code><code class="p">);</code>
        <code class="n">Value</code> <code class="p">=</code> <code class="m">456</code><code class="p">;</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"NoAfterYou static constructor ending"</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">static</code> <code class="kt">int</code> <code class="n">Value</code> <code class="p">=</code> <code class="m">42</code><code class="p">;</code>
<code class="p">}</code></pre></div>
<p>There is a circular relationship between the two types in this example: both have static constructors that attempt to use a static field defined by the other class. The behavior will depend on which of these two classes the program tries to use first. In a program that uses <code>AfterYou</code> first, I see the following output:</p>
<pre data-type="programlisting">AfterYou static constructor starting
NoAfterYou static constructor starting
NoAfterYou: AfterYou.Value: = 42
NoAfterYou static constructor ending
AfterYou: NoAfterYou.Value = 456
AfterYou static constructor ending</pre>
<p>As you’d expect, the static constructor for <code>AfterYou</code> runs first, because that’s the class my program is trying to use. It prints out its first message, but then it tries to use the <code>NoAfterYou.Value</code> field. That means the static initialization for <code>NoAfterYou</code> now has to start, so we see the first message from its static constructor. It then goes on to retrieve the <code>AfterYou.Value</code> field, even though the <code>AfterYou</code> static constructor hasn’t finished yet. (It retrieved the value set by the field initializer, 42, and not the value set by the static constructor, 123.) That’s allowed, because the ordering rules say only when static initialization is triggered, and they do not guarantee when it will finish. If they tried to guarantee complete initialization, this code would be unable to proceed—the <code>NoAfterYou</code> static constructor could not move forward, because the <code>AfterYou</code> static construction is not yet complete, but that couldn’t move forward, because it would be waiting for the <code>NoAfterYou</code> static initialization to finish.</p>
<p>The moral of this story is that you should not get too ambitious about what you try to achieve during static initialization. It can be hard to predict the exact order in which things will happen.</p>
<div data-type="tip"><h6>Tip</h6>
<p>The <code>Microsoft.Extensions.Hosting</code> NuGet package provides a much better way to handle initialization problems with its <code>HostBuilder</code> class. It is beyond the scope of this chapter, but it is well worth finding and exploring<a data-startref="ix_ch03-asciidoc25" data-type="indexterm" id="idm45884831110464"/><a data-startref="ix_ch03-asciidoc24" data-type="indexterm" id="idm45884831109856"/>.<a data-startref="ix_ch03-asciidoc17" data-type="indexterm" id="idm45884831109120"/><a data-startref="ix_ch03-asciidoc16" data-type="indexterm" id="idm45884831108448"/></p>
</div>
</div></section>
</div></section>
<section data-pdf-bookmark="Deconstructors" data-type="sect2"><div class="sect2" id="deconstructors">
<h2>Deconstructors</h2>
<p><a data-primary="Deconstruct member" data-type="indexterm" id="idm45884831105808"/><a data-primary="deconstructors" data-type="indexterm" id="idm45884831105104"/><a data-primary="members" data-secondary="deconstructors" data-type="indexterm" id="idm45884831104432"/>In <a data-type="xref" href="ch02.xhtml#ch_basic_coding">Chapter 2</a>, we saw how to deconstruct a tuple into its component parts, but deconstruction is not just for tuples. You can enable deconstruction for any type you write by adding a suitable <code>Deconstruct</code> member, as shown in <a data-type="xref" href="#enabling_deconstruction">Example 3-47</a>.</p>
<div data-type="example" id="enabling_deconstruction">
<h5><span class="label">Example 3-47. </span>Enabling deconstruction</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">readonly</code> <code class="k">struct</code> <code class="nc">Size</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="nf">Size</code><code class="p">(</code><code class="kt">double</code> <code class="n">w</code><code class="p">,</code> <code class="kt">double</code> <code class="n">h</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">W</code> <code class="p">=</code> <code class="n">w</code><code class="p">;</code>
        <code class="n">H</code> <code class="p">=</code> <code class="n">h</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">void</code> <code class="nf">Deconstruct</code><code class="p">(</code><code class="k">out</code> <code class="kt">double</code> <code class="n">w</code><code class="p">,</code> <code class="k">out</code> <code class="kt">double</code> <code class="n">h</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">w</code> <code class="p">=</code> <code class="n">W</code><code class="p">;</code>
        <code class="n">h</code> <code class="p">=</code> <code class="n">H</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="kt">double</code> <code class="n">W</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="p">}</code>
    <code class="k">public</code> <code class="kt">double</code> <code class="n">H</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>C# recognizes this convention of a method named <code>Deconstruct</code> with a list of <code>out</code> arguments (the next section will describe <code>out</code> in more detail) and enables you to use the same deconstruction syntax as you can with tuples. <a data-type="xref" href="#using_custom_deconstruction">Example 3-48</a> uses this to extract the component values of a <code>Size</code> to enable it to express succinctly the calculation it performs.</p>
<div data-type="example" id="using_custom_deconstruction">
<h5><span class="label">Example 3-48. </span>Using a custom deconstructor</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">static</code> <code class="kt">double</code> <code class="nf">DiagonalLength</code><code class="p">(</code><code class="n">Size</code> <code class="n">s</code><code class="p">)</code>
<code class="p">{</code>
    <code class="p">(</code><code class="kt">double</code> <code class="n">w</code><code class="p">,</code> <code class="kt">double</code> <code class="n">h</code><code class="p">)</code> <code class="p">=</code> <code class="n">s</code><code class="p">;</code>
    <code class="k">return</code> <code class="n">Math</code><code class="p">.</code><code class="n">Sqrt</code><code class="p">(</code><code class="n">w</code> <code class="p">*</code> <code class="n">w</code> <code class="p">+</code> <code class="n">h</code> <code class="p">*</code> <code class="n">h</code><code class="p">);</code>
<code class="p">}</code></pre></div>
<p>Types with a deconstructor can also use positional pattern matching. <a data-type="xref" href="ch02.xhtml#ch_basic_coding">Chapter 2</a> showed how you can use a syntax very similar to deconstruction in a pattern to match tuples. Any type with a custom deconstructor can use this same syntax. <a data-type="xref" href="#pattern_match_custom_deconstruction">Example 3-49</a> uses the <code>Size</code> type’s custom deconstructor to define various patterns for a <code>Size</code> in a switch expression.</p>
<div data-type="example" id="pattern_match_custom_deconstruction">
<h5><span class="label">Example 3-49. </span>Positional pattern using a custom deconstructor</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">static</code> <code class="kt">string</code> <code class="nf">DescribeSize</code><code class="p">(</code><code class="n">Size</code> <code class="n">s</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="n">s</code> <code class="k">switch</code>
<code class="p">{</code>
    <code class="p">(</code><code class="m">0</code><code class="p">,</code> <code class="m">0</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="s">"Empty"</code><code class="p">,</code>
    <code class="p">(</code><code class="m">0</code><code class="p">,</code> <code class="n">_</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="s">"Extremely narrow"</code><code class="p">,</code>
    <code class="p">(</code><code class="kt">double</code> <code class="n">w</code><code class="p">,</code> <code class="m">0</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="err">$</code><code class="s">"Extremely short, and this wide: {w}"</code><code class="p">,</code>
    <code class="n">_</code> <code class="p">=&gt;</code> <code class="s">"Normal"</code>
<code class="p">};</code></pre></div>
<p>Recall from <a data-type="xref" href="ch02.xhtml#ch_basic_coding">Chapter 2</a> that positional patterns are recursive: each position within the pattern contains a nested pattern. Since <code>Size</code> deconstructs into two elements, each positional pattern has two positions in which to put child patterns. <a data-type="xref" href="#pattern_match_custom_deconstruction">Example 3-49</a> variously uses constant patterns, a discard, and a declaration pattern.</p>
<p>To use a deconstructor in a pattern, C# needs to know the type to be deconstructed at compile time. This works in <a data-type="xref" href="#pattern_match_custom_deconstruction">Example 3-49</a> because the input to the switch expression is of type <code>Size</code>. If a positional pattern’s input is of type <code>object</code>, the compiler will presume that you’re trying to match a tuple instead, unless you explicitly name the type, as <a data-type="xref" href="#pattern_match_explicit_deconstructor">Example 3-50</a> does.</p>
<div data-type="example" id="pattern_match_explicit_deconstructor">
<h5><span class="label">Example 3-50. </span>Positional pattern with explicit type</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">static</code> <code class="kt">string</code> <code class="nf">Describe</code><code class="p">(</code><code class="kt">object</code> <code class="n">o</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="n">o</code> <code class="k">switch</code>
<code class="p">{</code>
    <code class="n">Size</code> <code class="p">(</code><code class="m">0</code><code class="p">,</code> <code class="m">0</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="s">"Empty"</code><code class="p">,</code>
    <code class="n">Size</code> <code class="p">(</code><code class="m">0</code><code class="p">,</code> <code class="n">_</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="s">"Extremely narrow"</code><code class="p">,</code>
    <code class="n">Size</code> <code class="p">(</code><code class="kt">double</code> <code class="n">w</code><code class="p">,</code> <code class="m">0</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="err">$</code><code class="s">"Extremely short, and this wide: {w}"</code><code class="p">,</code>
    <code class="n">Size</code> <code class="n">_</code> <code class="p">=&gt;</code> <code class="s">"Normal shape"</code><code class="p">,</code>
    <code class="n">_</code> <code class="p">=&gt;</code> <code class="s">"Not a shape"</code>
<code class="p">};</code></pre></div>
<p>If you write a <code>record</code> type (either class-based or a <code>record struct</code>) that uses the positional syntax, i.e., it requires certain properties to be supplied on initialization as <a data-type="xref" href="#record_struct_positional_syntax">Example 3-51</a> does, the compiler generates a <code>Deconstruct</code> method for you. So just as with a tuple, any <code>record</code> defined in this way is automatically deconstructable.</p>
<div data-type="example" id="record_struct_positional_syntax">
<h5><span class="label">Example 3-51. </span><code>record struct</code> using positional syntax</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">readonly</code> <code class="n">record</code> <code class="k">struct</code> <code class="nf">Size</code><code class="p">(</code><code class="kt">double</code> <code class="n">W</code><code class="p">,</code> <code class="kt">double</code> <code class="n">H</code><code class="p">);</code></pre></div>
<p>Although the compiler provides special handling for the <code>Deconstruct</code> member that these examples rely on, from the runtime’s perspective, this is just an ordinary method. So this would be a good time to look in more detail at methods.</p>
</div></section>
<section data-pdf-bookmark="Methods" data-type="sect2"><div class="sect2" id="methods">
<h2>Methods</h2>
<p><a data-primary="members" data-secondary="methods" data-type="indexterm" id="ix_ch03-asciidoc26"/><a data-primary="methods" data-seealso="specific methods" data-type="indexterm" id="ix_ch03-asciidoc27"/><em>Methods</em> are <a data-primary="methods" data-secondary="defined" data-type="indexterm" id="idm45884830719728"/>named bits of code that can optionally return a result and that may take arguments. <a data-primary="arguments" data-secondary="parameters versus" data-type="indexterm" id="idm45884830718592"/><a data-primary="parameters, arguments versus" data-type="indexterm" id="idm45884830717648"/>C# makes the fairly common distinction between <em>parameters</em> and <em>arguments</em>: a method defines a list of the inputs it expects—the parameters—and the code inside the method refers to these parameters by name. The values seen by the code could be different each time the method is invoked, and the term <em>argument</em> refers to the specific value supplied for a parameter in a particular invocation.</p>
<p>As you’ve already seen, when an accessibility specifier, such as <code>public</code> or <code>private</code>, is present, it appears at the start of the method declaration. The optional <code>static</code> keyword comes next, where present. <a data-primary="void keyword" data-type="indexterm" id="idm45884830713680"/>After that, the method declaration states the return type. As with many C-family languages, you can write methods that return nothing, and you indicate this by putting the <code>void</code> keyword in place of the return type. Inside the method, you use the <code>return</code> keyword followed by an expression to specify the value for the method to return. In the case of a <code>void</code> method, you can use the <code>return</code> keyword without an expression to terminate the method, although this is optional, because when execution reaches the end of a <code>void</code> method, it terminates automatically. You normally only use <code>return</code> in a <code>void</code> method if your code decides to exit early.</p>
<section data-pdf-bookmark="Passing arguments by reference" data-type="sect3"><div class="sect3" id="passing_arguments_by_reference">
<h3>Passing arguments by reference</h3>
<p><a data-primary="arguments" data-secondary="passing by reference" data-type="indexterm" id="ix_ch03-asciidoc28"/><a data-primary="methods" data-secondary="passing arguments by reference" data-type="indexterm" id="ix_ch03-asciidoc29"/>Methods can return only one item directly in C#. If you want to return multiple values, you can of course make that item a tuple. <a data-primary="out parameter" data-type="indexterm" id="ix_ch03-asciidoc30"/>Alternatively, you can designate parameters as being for output rather than input. <a data-type="xref" href="#returning_multiple_values_with_out">Example 3-52</a> returns two values, both produced by integer division. The main return value is the quotient, but it also returns the remainder through its final parameter, which has been annotated with the <code>out</code> keyword.</p>
<div data-type="example" id="returning_multiple_values_with_out">
<h5><span class="label">Example 3-52. </span>Returning multiple values with <code>out</code></h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">static</code> <code class="kt">int</code> <code class="nf">Divide</code><code class="p">(</code><code class="kt">int</code> <code class="n">x</code><code class="p">,</code> <code class="kt">int</code> <code class="n">y</code><code class="p">,</code> <code class="k">out</code> <code class="kt">int</code> <code class="n">remainder</code><code class="p">)</code>
<code class="p">{</code>
    <code class="n">remainder</code> <code class="p">=</code> <code class="n">x</code> <code class="p">%</code> <code class="n">y</code><code class="p">;</code>
    <code class="k">return</code> <code class="n">x</code> <code class="p">/</code> <code class="n">y</code><code class="p">;</code>
<code class="p">}</code></pre></div>
<p>Because tuples were only introduced in C# 7, whereas <code>out</code> parameters have been around since the start, <code>out</code> crops up a lot in class libraries in scenarios where tuples might have been simpler. <a data-primary="TryParse method" data-type="indexterm" id="idm45884830625136"/>For example, you’ll see lots of methods following a similar pattern to <code>int.TryParse</code>, in which the return type is a <code>bool</code> indicating success or failure, with the actual result being passed through an <code>out</code> parameter.</p>
<p><a data-type="xref" href="#out_parameter_into_new_variable">Example 3-53</a> shows one way to call a method with an <code>out</code> parameter. Instead of supplying an expression as we do with arguments for normal parameters, we’ve written the <code>out</code> keyword followed by a variable declaration. This introduces a new variable, which becomes the argument for this <code>out</code> parameter. So in this case, we end up with a new variable <code>r</code> initialized to 1 (the remainder of the division operation).</p>
<div data-type="example" id="out_parameter_into_new_variable">
<h5><span class="label">Example 3-53. </span>Putting an <code>out</code> parameter’s result into a new variable</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">int</code> <code class="n">q</code> <code class="p">=</code> <code class="n">Divide</code><code class="p">(</code><code class="m">10</code><code class="p">,</code> <code class="m">3</code><code class="p">,</code> <code class="k">out</code> <code class="kt">int</code> <code class="n">r</code><code class="p">);</code></pre></div>
<p>A variable declared in an <code>out</code> argument follows the usual scoping rules, so in <a data-type="xref" href="#out_parameter_into_new_variable">Example 3-53</a>, <code>r</code> will remain in scope for as long as <code>q</code>. Less obviously, <code>r</code> is available in the rest of the expression. <a data-type="xref" href="#use_out_result_in_expression">Example 3-54</a> uses this to attempt to parse some text as an integer, returning the parsed result if that succeeds and a fallback value of –1 if parsing fails.</p>
<div data-type="example" id="use_out_result_in_expression">
<h5><span class="label">Example 3-54. </span>Using an <code>out</code> parameter’s result in the same expression</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">int</code> <code class="k">value</code> <code class="p">=</code> <code class="kt">int</code><code class="p">.</code><code class="n">TryParse</code><code class="p">(</code><code class="n">text</code><code class="p">,</code> <code class="k">out</code> <code class="kt">int</code> <code class="n">x</code><code class="p">)</code> <code class="p">?</code> <code class="n">x</code> <code class="p">:</code> <code class="p">-</code><code class="m">1</code><code class="p">;</code></pre></div>
<p>When you pass an <code>out</code> argument, this works by passing a reference to the local variable. When <a data-type="xref" href="#out_parameter_into_new_variable">Example 3-53</a> calls <code>Divide</code>, and when that method assigns a value into <code>remainder</code>, it’s really assigning it into the caller’s <code>r</code> variable. This is an <code>int</code>, which is a value type, so it would not normally be passed by reference, and this kind of reference is limited compared to what you can do with a reference type.<sup><a data-type="noteref" href="ch03.xhtml#idm45884830549600" id="idm45884830549600-marker">6</a></sup> For example, you can’t declare a field in a class that can hold this kind of reference, because the local <code>r</code> variable will cease to exist when it goes out of scope, whereas an instance of a class can live indefinitely in a heap block. C# has to ensure that you cannot put a reference to a local variable in something that might outlive the variable it refers to.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p><a data-primary="async keyword" data-secondary="out arguments and" data-type="indexterm" id="idm45884830545168"/><a data-primary="asynchronous methods, out arguments and" data-type="indexterm" id="idm45884830544192"/>Methods annotated with the <code>async</code> keyword (described in <a data-type="xref" href="ch17.xhtml#ch_asynchronous_language_features">Chapter 17</a>) cannot have any <code>out</code> arguments. This is because asynchronous methods may implicitly return to their caller before they complete, continuing their execution some time later. This in turn means that the caller may also have returned before the <code>async</code> method runs again, in which case the variables passed by reference might no longer exist by the time the asynchronous code is ready to set them. The same restriction applies to anonymous functions (described in <a data-type="xref" href="ch09.xhtml#ch_delegates_lambdas_events">Chapter 9</a>). Both kinds of methods are allowed to pass <code>out</code> arguments into methods that they call, though.</p>
</div>
<p>You won’t always want to declare a new variable for each <code>out</code> argument. As <a data-type="xref" href="#existing_variable_as_out_argument">Example 3-55</a> shows, you can just write <code>out</code> followed by the name of an existing variable. (This was once the only way to use <code>out</code> arguments, so you’ll sometimes see code that declares a new variable in a separate statement immediately before using it as an <code>out</code> argument, even though the form shown in <a data-type="xref" href="#out_parameter_into_new_variable">Example 3-53</a> would be simpler.)</p>
<div data-type="example" id="existing_variable_as_out_argument">
<h5><span class="label">Example 3-55. </span>Putting an <code>out</code> parameter’s result into an existing variable</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">int</code> <code class="n">r</code><code class="p">,</code> <code class="n">q</code><code class="p">;</code>
<code class="n">q</code> <code class="p">=</code> <code class="n">Divide</code><code class="p">(</code><code class="m">10</code><code class="p">,</code> <code class="m">3</code><code class="p">,</code> <code class="k">out</code> <code class="n">r</code><code class="p">);</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"3: {q}, {r}"</code><code class="p">);</code>
<code class="n">q</code> <code class="p">=</code> <code class="n">Divide</code><code class="p">(</code><code class="m">10</code><code class="p">,</code> <code class="m">4</code><code class="p">,</code> <code class="k">out</code> <code class="n">r</code><code class="p">);</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"4: {q}, {r}"</code><code class="p">);</code></pre></div>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>When invoking a method with an <code>out</code> parameter, we are required to indicate explicitly that we are aware of how the method uses the argument. Regardless of whether we use an existing variable or declare a new one, we must use the <code>out</code> keyword at the call site as well as in the declaration.</p>
</div>
<p>Sometimes you will want to invoke a method that has an <code>out</code> argument that you have no use for—maybe you only need the main return value. As <a data-type="xref" href="#out_argument_discard">Example 3-56</a> shows, you can put just an underscore after the <code>out</code> keyword. This tells C# to discard the result.</p>
<div data-type="example" id="out_argument_discard">
<h5><span class="label">Example 3-56. </span>Discarding an <code>out</code> parameter’s result</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">int</code> <code class="n">q</code> <code class="p">=</code> <code class="n">Divide</code><code class="p">(</code><code class="m">10</code><code class="p">,</code> <code class="m">3</code><code class="p">,</code> <code class="k">out</code> <code class="n">_</code><code class="p">);</code></pre></div>
<div data-type="tip"><h6>Tip</h6>
<p><a data-primary="_ (underscore)" data-type="indexterm" id="idm45884830409296"/>You should avoid using <code>_</code> (a single underscore) as the name of something in C#, because it can prevent the compiler from interpreting it as a discard. If a local variable of this name is in scope, writing <code>out _</code> has, since C# 1.0, indicated that you want to assign an <code>out</code> result into that variable, so for backward compatibility, current versions of C# have to retain that behavior. You can only use this form of discard if there is no symbol named <code>_</code> in scope.</p>
</div>
<p>An <code>out</code> reference requires information to flow from the method back to the caller, so if you try to write a method that returns without assigning something into all of its <code>out</code> arguments, you’ll get a compiler error. C# uses the <em>definite assignment</em> rules mentioned in <a data-type="xref" href="ch02.xhtml#ch_basic_coding">Chapter 2</a> to check this. (This requirement does not apply if the method throws an exception instead of returning.) There’s a related keyword, <code>ref</code>, that has similar reference semantics but allows information to flow bidirectionally. With a <code>ref</code> argument, it’s as though the method has direct access to the variable the caller passed in—we can read its current value, as well as modify it. (The caller is obliged to ensure that variables passed with <code>ref</code> contain a value before making the call, so in this case, the method is not required to set it before returning.) If you call a method with a parameter annotated with <code>ref</code> instead of <code>out</code>, you have to make clear at the call site that you meant to pass a reference to a variable as the argument, as <a data-type="xref" href="#calling_a_method_with_a_ref_argument">Example 3-57</a> shows.<a data-startref="ix_ch03-asciidoc30" data-type="indexterm" id="idm45884830400064"/></p>
<div data-type="example" id="calling_a_method_with_a_ref_argument">
<h5><span class="label">Example 3-57. </span>Calling a method with a <code>ref</code> argument</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">long</code> <code class="n">x</code> <code class="p">=</code> <code class="m">41</code><code class="p">;</code>
<code class="n">Interlocked</code><code class="p">.</code><code class="n">Increment</code><code class="p">(</code><code class="k">ref</code> <code class="n">x</code><code class="p">);</code></pre></div>
<p><a data-primary="in keyword" data-type="indexterm" id="ix_ch03-asciidoc31"/>There’s a third way to add a level of indirection to an argument: you can apply the <code>in</code> keyword. Whereas <code>out</code> only enables information to flow out of the method, <code>in</code> only allows it to flow in. It’s like a <code>ref</code> argument but where the called method is not allowed to modify the variable the argument refers to. This may seem redundant: if there’s no way to pass information back through the argument, why pass it by reference? An <code>in int</code> argument doesn’t sound usefully different than an ordinary <code>int</code> argument. In fact, you wouldn’t use <code>in</code> with <code>int</code>. You only use it with relatively large types. As you know, value types are normally passed by value, meaning a copy has to be made when passing a value as an argument. The <code>in</code> keyword enables us to avoid this copy by passing a reference instead. In the past, people have sometimes used the <code>ref</code> keyword to avoid making copies of data, but this creates a risk that the method might modify the value when the caller might not want that. C# 7.2 introduced <code>in</code>, giving us the same in-only semantics we get when passing values the normal way but with the potential efficiency gains of not having to pass the whole value.</p>
<p>You should only use <code>in</code> for types that are larger than a pointer. This is why <code>in int</code> is not useful. An <code>int</code> is 32 bits long, so passing a reference to an <code>int</code> doesn’t save us anything. In a 32-bit process, that reference will be a 32-bit pointer, so we have saved nothing, and we end up with the slight extra inefficiency involved in using a value indirectly through a reference. In a 64-bit process, the reference will be a 64-bit pointer, so we’ve ended up having to pass more data into the method than we would have done if we had just passed the <code>int</code> directly! (Sometimes the CLR can inline the method and avoid the costs of creating the pointer, but this means that at best <code>in int</code> would cost the same as an <code>int</code>. And since <code>in</code> is purely about performance, that’s why <code>in</code> is not useful for small types such as <code>int</code>.)</p>
<p><a data-type="xref" href="#large_struct">Example 3-58</a> defines a fairly large value type. It contains four <code>double</code> values, each of which is 8 bytes in size, so each instance of this type occupies 32 bytes. The .NET design guidelines have always recommended avoiding making value types this large, and the main reason for this is that passing them as arguments is inefficient. Older versions of C# did not support this use of the <code>in</code> keyword, making this guideline more important, but now that <code>in</code> can reduce those costs, in some cases it might make sense to define a <code>struct</code> this large.</p>
<div data-type="example" id="large_struct">
<h5><span class="label">Example 3-58. </span>A large value type</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">readonly</code> <code class="n">record</code> <code class="k">struct</code> <code class="nf">Rect</code><code class="p">(</code><code class="kt">double</code> <code class="n">X</code><code class="p">,</code> <code class="kt">double</code> <code class="n">Y</code><code class="p">,</code> <code class="kt">double</code> <code class="n">Width</code><code class="p">,</code> <code class="kt">double</code> <code class="n">Height</code><code class="p">);</code></pre></div>
<p><a data-type="xref" href="#method_with_in_parameter">Example 3-59</a> shows a method that calculates the area of a rectangle represented by the <code>Rect</code> type defined in <a data-type="xref" href="#large_struct">Example 3-58</a>. We really wouldn’t want to have to copy all 32 bytes to call this very simple method, especially since it only uses half of the data in the <code>Rect</code>. Since this method annotates its parameter with <code>in</code>, no such copying will occur: the argument will be passed by reference, which in practice means that only a pointer needs to be passed—either 4 or 8 bytes, depending on whether the code is running in a 32-bit or a 64-bit process.</p>
<div data-type="example" id="method_with_in_parameter">
<h5><span class="label">Example 3-59. </span>A method with an <code>in</code> parameter</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">static</code> <code class="kt">double</code> <code class="nf">GetArea</code><code class="p">(</code><code class="k">in</code> <code class="n">Rect</code> <code class="n">r</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="n">r</code><code class="p">.</code><code class="n">Width</code> <code class="p">*</code> <code class="n">r</code><code class="p">.</code><code class="n">Height</code><code class="p">;</code></pre></div>
<p>You might expect that calling a method with <code>in</code> parameters would require the call site to indicate that it knows that the argument will be passed by reference by putting <code>in</code> in front of the argument, just like we need to write <code>out</code> or <code>ref</code> at the call site for the other two by-reference styles. And as <a data-type="xref" href="#passing_an_in_argument">Example 3-60</a> shows, you can do this, but it is optional. If you want to be explicit about the by-reference invocation, you can be, but unlike with <code>ref</code> and <code>out</code>, the compiler just passes the argument by reference anyway if you don’t add <code>in</code>.</p>
<div data-type="example" id="passing_an_in_argument">
<h5><span class="label">Example 3-60. </span>Calling a method with an <code>in</code> parameter</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">r</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Rect</code><code class="p">(</code><code class="m">10</code><code class="p">,</code> <code class="m">20</code><code class="p">,</code> <code class="m">100</code><code class="p">,</code> <code class="m">100</code><code class="p">);</code>
<code class="kt">double</code> <code class="n">area</code> <code class="p">=</code> <code class="n">GetArea</code><code class="p">(</code><code class="k">in</code> <code class="n">r</code><code class="p">);</code>
<code class="kt">double</code> <code class="n">area2</code> <code class="p">=</code> <code class="n">GetArea</code><code class="p">(</code><code class="n">r</code><code class="p">);</code></pre></div>
<p>The <code>in</code> keyword is optional at the call site because defining such a parameter as <code>in</code> is only a performance optimization that does not change the behavior, unlike <code>out</code> and <code>ref</code>. Microsoft wanted to make it possible for developers to introduce a source-level-compatible change in which an existing method is modified by adding <code>in</code> to a parameter. This is a breaking change at the binary level, but in scenarios where you can be sure people will in any case need to recompile (e.g., when all the code is under your control), it might be useful to introduce such a change for performance reasons. Of course, as with all such enhancements you should measure performance before and after the change to see if it has the intended effect.</p>
<p>Although the examples just shown work as intended, <code>in</code> sets a trap for the unwary. It works only because I marked the <code>struct</code> in <a data-type="xref" href="#large_struct">Example 3-58</a> as <code>readonly</code>. If instead of defining my own <code>Rect</code> I had used the very similar-looking <code>struct</code> with the same name from the <code>System.Windows</code> namespace (part of the WPF UI framework), <a data-type="xref" href="#passing_an_in_argument">Example 3-60</a> would not avoid the copy. It would have compiled and produced the correct results at runtime, but it would not offer any performance benefit. That’s because <code>System.Windows.Rect</code> is not read-only. <a data-primary="defensive copies" data-type="indexterm" id="idm45884830168256"/>Earlier, I discussed the defensive copies that C# makes when you use a <code>readonly</code> field containing a mutable value type. The same principle applies here, because an <code>in</code> argument is in effect read-only: code that passes arguments expects them not to be modified unless they are explicitly marked as <code>out</code> or <code>ref</code>. So the compiler must ensure that <code>in</code> arguments are not modified even though the method being called has a reference to the caller’s variable. When the type in question is already read-only, the compiler doesn’t have to do any extra work. But if it is a mutable value type, then if the method to which this argument was passed in turn invokes a method on that value, the compiler generates code that makes a copy and invokes the method on that, because it can’t know whether the method might modify the value. You might think that the compiler could enforce this by preventing the method with the <code>in</code> parameter from doing anything that might modify the value, but in practice that would mean stopping it from invoking any methods on the value—the compiler cannot in general determine whether any particular method call might modify the value. (And even if it doesn’t today, maybe it will in a future version of the library that defines the type.) Since properties are methods in disguise, this makes <code>in</code> arguments more or less useless when used with mutable types.</p>
<div data-type="tip"><h6>Tip</h6>
<p>You should use <code>in</code> only with <code>readonly</code> value types, because mutable value types can undo the performance benefits. (Mutable value types are typically a bad idea in any case.)</p>
</div>
<p>C# offers a feature that can loosen this constraint a little. It allows the <code>readonly</code> keyword to be applied to members so that they can declare that they will not modify the value of which they are a member. This makes it possible to avoid these defensive copies on mutable values.<a data-startref="ix_ch03-asciidoc31" data-type="indexterm" id="idm45884830161840"/></p>
<p><a data-primary="ref keyword" data-type="indexterm" id="idm45884830160880"/>You can use the <code>out</code> and <code>ref</code> keywords with reference types too. That may sound redundant, but it can be useful. It provides double indirection—the method receives a reference to a variable that holds a reference. When you pass a reference type argument to a method, that method gets access to whatever object you choose to pass it. While the method can use members of that object, it can’t normally replace it with a different object. But if you mark a reference type argument with <code>ref</code>, the method has access to your variable, so it could replace it with a reference to a completely different object.</p>
<p>It’s technically possible for constructors to have <code>out</code> and <code>ref</code> parameters too, although it’s unusual. Also, just to be clear, the <code>out</code> or <code>ref</code> qualifiers are part of the method or constructor signature. A caller can pass an <code>out</code> (or <code>ref</code>) argument if and only if the parameter was declared as <code>out</code> (or <code>ref</code>). Callers can’t decide unilaterally to pass an argument by reference to a method that does not expect it.<a data-startref="ix_ch03-asciidoc29" data-type="indexterm" id="idm45884830154288"/></p>
</div></section>
<section data-pdf-bookmark="Reference variables and return values" data-type="sect3"><div class="sect3" id="ref_locals_and_returns">
<h3>Reference variables and return values</h3>
<p><a data-primary="methods" data-secondary="reference variables and return values" data-type="indexterm" id="ix_ch03-asciidoc33"/><a data-primary="reference variables" data-type="indexterm" id="ix_ch03-asciidoc34"/><a data-primary="variables" data-secondary="reference variables and return values" data-type="indexterm" id="ix_ch03-asciidoc35"/>Now that you’ve seen various ways in which you can pass a method a reference to a value (or a reference to a reference), you might be wondering whether you can get hold of these references in other ways. You can, as <a data-type="xref" href="#ref_local">Example 3-61</a> shows, but there are some constraints.</p>
<div data-type="example" id="ref_local">
<h5><span class="label">Example 3-61. </span>A local <code>ref</code> variable</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">string</code> <code class="n">rose</code> <code class="p">=</code> <code class="k">null</code><code class="p">;</code>
<code class="k">ref</code> <code class="kt">string</code> <code class="n">rosaIndica</code> <code class="p">=</code> <code class="k">ref</code> <code class="n">rose</code><code class="p">;</code>
<code class="n">rosaIndica</code> <code class="p">=</code> <code class="s">"smell as sweet"</code><code class="p">;</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"A rose by any other name would {rose}"</code><code class="p">);</code></pre></div>
<p>This example declares a variable called <code>rose</code>. It then declares a new variable of type <code>ref string</code>. The <code>ref</code> here has exactly the same effect as it does on a method parameter: it indicates that this variable is a reference to some other variable. Since the code initializes it with <code>ref rose</code>, the variable <code>rosaIndica</code> is a reference to that <code>rose</code> variable. So when the code assigns a value into <code>rosaIndica</code>, that value goes into the <code>rose</code> variable that <code>rosaIndica</code> refers to. When the final line reads the value of the <code>rose</code> variable, it will see the value that was written by the preceding line.</p>
<p>So what are the constraints? C# has to ensure that you cannot put a reference to a local variable in something that might outlive the variable it refers to. So you cannot use this keyword on a field. Static fields live for as long as their defining type is loaded (typically until the process exits), and member fields of classes live on the heap enabling them to outlive any particular method call. (This is also true of most structs. It is not true of a <code>ref struct</code>, but even those do not currently support the <code>ref</code> keyword on a field.) And even in cases where you might think lifetime isn’t a problem (because the target of the reference is itself a field in an object, for example), it turns out that the runtime simply doesn’t support storing this kind of reference in a field, or as an element type in an array. More subtly, this also means you can’t use a <code>ref</code> local variable in a context where C# would store the variable in a class. That rules out their use in <code>async</code> methods and iterators and also prevents them being captured by anonymous functions (which are described in Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch17.xhtml#ch_asynchronous_language_features">17</a>, <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch05.xhtml#ch_collections">5</a>, and <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch09.xhtml#ch_delegates_lambdas_events">9</a>, respectively).</p>
<p>Although types cannot define fields with <code>ref</code>, they can define methods that return a <code>ref</code>-style reference (and since properties are methods in disguise, a property getter may also return a reference). As always, the C# compiler has to ensure that a reference cannot outlive the thing it refers to, so it will prevent use of this feature in cases where it cannot be certain that it can enforce this rule. <a data-type="xref" href="#ref_returns">Example 3-62</a> shows various uses of <code>ref</code> return types, some of which the compiler accepts, and some it does not.</p>
<div data-type="example" id="ref_returns">
<h5><span class="label">Example 3-62. </span>Valid and invalid uses of <code>ref</code> returns</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">class</code> <code class="nc">Referable</code>
<code class="p">{</code>
    <code class="k">private</code> <code class="kt">int</code> <code class="n">i</code><code class="p">;</code>
    <code class="k">private</code> <code class="kt">int</code><code class="p">[]</code> <code class="n">items</code> <code class="p">=</code> <code class="k">new</code> <code class="kt">int</code><code class="p">[</code><code class="m">10</code><code class="p">];</code>

    <code class="k">public</code> <code class="k">ref</code> <code class="kt">int</code> <code class="n">FieldRef</code> <code class="p">=&gt;</code> <code class="k">ref</code> <code class="n">i</code><code class="p">;</code>

    <code class="k">public</code> <code class="k">ref</code> <code class="kt">int</code> <code class="nf">GetArrayElementRef</code><code class="p">(</code><code class="kt">int</code> <code class="n">index</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="k">ref</code> <code class="n">items</code><code class="p">[</code><code class="n">index</code><code class="p">];</code>

    <code class="k">public</code> <code class="k">ref</code> <code class="kt">int</code> <code class="nf">GetBackSameRef</code><code class="p">(</code><code class="k">ref</code> <code class="kt">int</code> <code class="n">arg</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="k">ref</code> <code class="n">arg</code><code class="p">;</code>

    <code class="k">public</code> <code class="k">ref</code> <code class="kt">int</code> <code class="nf">WillNotCompile</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="kt">int</code> <code class="n">v</code> <code class="p">=</code> <code class="m">42</code><code class="p">;</code>
        <code class="k">return</code> <code class="k">ref</code> <code class="n">v</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">ref</code> <code class="kt">int</code> <code class="nf">WillAlsoNotCompile</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="kt">int</code> <code class="n">i</code> <code class="p">=</code> <code class="m">42</code><code class="p">;</code>
        <code class="k">return</code> <code class="k">ref</code> <code class="nf">GetBackSameRef</code><code class="p">(</code><code class="k">ref</code> <code class="n">i</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">ref</code> <code class="kt">int</code> <code class="nf">WillCompile</code><code class="p">(</code><code class="k">ref</code> <code class="kt">int</code> <code class="n">i</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="k">ref</code> <code class="nf">GetBackSameRef</code><code class="p">(</code><code class="k">ref</code> <code class="n">i</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>The methods that return a reference to an <code>int</code> that is a field, or an element in an array, are allowed, because <code>ref</code>-style references can always refer <em>to</em> items inside objects on the heap. (They just can’t live <em>in</em> them.) Heap objects can exist for as long as they are needed (and the garbage collector, discussed in <a data-type="xref" href="ch07.xhtml#ch_object_lifetime">Chapter 7</a>, is aware of these kinds of references and will ensure that heap objects with references pointing to their interiors are kept alive). A method can return any of its <code>ref</code> arguments, because the caller was already required to ensure that they remain valid for the duration of the call. However, a method cannot return a reference to one of its local variables, because in cases where those variables end up living on the stack, the stack frame will cease to exist when the method returns. It would be a problem if a method could return a reference to a variable in a now-defunct stack frame.</p>
<p>The rules get a little more subtle when it comes to returning a reference that was obtained from some other method. The final two methods in <a data-type="xref" href="#ref_returns">Example 3-62</a> both attempt to return the reference returned by <code>GetBackSameRef</code>. One works, and the other does not. The outcome makes sense: <code>WillAlsoNotCompile</code> needs to be rejected for the same reason <code>WillNotCompile</code> was: both attempt to return a reference to a local variable, and <code>WillAlsoNotCompile</code> is just trying to disguise this by going through another method, <code>GetBackSameRef</code>. In cases like these, the C# compiler makes the conservative assumption that any method that returns a <code>ref</code> and that also takes one or more <code>ref</code> arguments might choose to return a reference to one of those arguments. So the compiler disallows the call to <code>GetBackSameRef</code> in <code>WillAlsoNotCompile</code> on the grounds that it might return a reference to the same local variable that was passed in by reference. (And it happens to be right in this case. But it would reject any call of this form even if the method in question returned a reference to something else entirely.) But it allows <code>WillCompile</code> to return the <code>ref</code> returned by <code>GetBackSameRef</code> because in that case, the reference we pass in is one we would be allowed to return directly.</p>
<p>As with <code>in</code> arguments, the main reason for using <code>ref</code> returns is that they can enable greater runtime efficiency by avoiding copies. Instead of returning the entire value, methods of this kind can just return a pointer to the existing value. It also has the effect of enabling callers to modify whatever is referred to. For example, in <a data-type="xref" href="#ref_returns">Example 3-62</a>, I can assign a value into the <code>FieldRef</code> property, even though the property appears to be read-only. The absence of a setter doesn’t matter in this case because its type is <code>ref int</code>, which is valid as the target of an assignment. So by writing <code>r.FieldRef = 42;</code> (where <code>r</code> is of type <code>Referable</code>), I get to modify the <code>i</code> field. Likewise, the reference returned by <code>GetArrayElementRef</code> can be used to modify the relevant element in the array. If this is not your intention, you can make the return type <code>ref readonly</code> instead of just <code>ref</code>. In this case, the compiler will not allow the resulting reference to be used as the target of an assignment.</p>
<div data-type="tip"><h6>Tip</h6>
<p>You should only use <code>ref readonly</code> returns with a <code>readonly struct</code>, because otherwise you will run into the same defensive copy issues we saw earlier<a data-startref="ix_ch03-asciidoc35" data-type="indexterm" id="idm45884829890992"/>.<a data-startref="ix_ch03-asciidoc34" data-type="indexterm" id="idm45884829890160"/><a data-startref="ix_ch03-asciidoc33" data-type="indexterm" id="idm45884829889456"/><a data-startref="ix_ch03-asciidoc28" data-type="indexterm" id="idm45884829888784"/></p>
</div>
</div></section>
<section data-pdf-bookmark="Optional arguments" data-type="sect3"><div class="sect3" id="optional_arguments">
<h3>Optional arguments</h3>
<p><a data-primary="methods" data-secondary="optional arguments" data-type="indexterm" id="ix_ch03-asciidoc36"/>You can make non-<code>out</code>, non-<code>ref</code> arguments optional by defining default values. The method in <a data-type="xref" href="#method_with_optional_arguments">Example 3-63</a> specifies the values that the arguments should have if the caller doesn’t supply them.</p>
<div data-type="example" id="method_with_optional_arguments">
<h5><span class="label">Example 3-63. </span>A method with optional arguments</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">static</code> <code class="k">void</code> <code class="nf">Blame</code><code class="p">(</code><code class="kt">string</code> <code class="n">perpetrator</code> <code class="p">=</code> <code class="s">"the youth of today"</code><code class="p">,</code>
    <code class="kt">string</code> <code class="n">problem</code> <code class="p">=</code> <code class="s">"the downfall of society"</code><code class="p">)</code>
<code class="p">{</code>
     <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"I blame {perpetrator} for {problem}."</code><code class="p">);</code>
<code class="p">}</code></pre></div>
<p>This method can then be invoked with no arguments, one argument, or both arguments. <a data-type="xref" href="#omitting_one_argument">Example 3-64</a> just supplies the first, taking the default for the <code>problem</code> <span class="keep-together">argument.</span></p>
<div data-type="example" id="omitting_one_argument">
<h5><span class="label">Example 3-64. </span>Omitting one argument</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">Blame</code><code class="p">(</code><code class="s">"mischievous gnomes"</code><code class="p">);</code></pre></div>
<p>Normally, when invoking a method, you specify the arguments in order. However, what if you want to call the method in <a data-type="xref" href="#method_with_optional_arguments">Example 3-63</a>, but you want to provide a value only for the second argument, using the default value for the first? You can’t just leave the first argument empty—if you tried to write <code>Blame( , "everything")</code>, you’d get a compiler error. Instead, you can specify the name of the argument you’d like to supply, using the syntax shown in <a data-type="xref" href="#specifying_an_argument_name">Example 3-65</a>. C# will fill in the arguments you omit with the specified default values.</p>
<div data-type="example" id="specifying_an_argument_name">
<h5><span class="label">Example 3-65. </span>Specifying an argument name</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">Blame</code><code class="p">(</code><code class="n">problem</code><code class="p">:</code> <code class="s">"everything"</code><code class="p">);</code></pre></div>
<p>Obviously, you can omit arguments like this only when you’re invoking methods that define default argument values. However, you are free to specify argument names when invoking any method—sometimes it can be useful to do this even when you’re not omitting any arguments, because it can make it easier to see what the arguments are for when reading the code. This is particularly helpful if you’re faced with an API that takes arguments of type <code>bool</code> and it’s not immediately clear what they mean. <a data-type="xref" href="#not_naming_arguments">Example 3-66</a> constructs a <code>StreamReader</code> and a <code>StreamWriter</code> (described in <a data-type="xref" href="ch15.xhtml#ch_files_and_streams">Chapter 15</a>), each using constructors taking many arguments. It’s arguably clear enough what the <code>stream</code>, <code>filepath</code>, and the <code>Encoding.UTF8</code> arguments represent, but the others are likely to be something of a mystery to anyone reading the code, unless they happen to have committed all 13 <code>StreamReader</code> and 10 <code>StreamWriter</code> constructor overloads to memory. (The <em>using declaration</em> syntax shown here is described in <a data-type="xref" href="ch07.xhtml#ch_object_lifetime">Chapter 7</a>.)</p>
<div data-type="example" id="not_naming_arguments">
<h5><span class="label">Example 3-66. </span>Unclear arguments</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">using</code> <code class="nn">var</code> <code class="n">r</code> <code class="p">=</code> <code class="k">new</code> <code class="n">StreamReader</code><code class="p">(</code><code class="n">stream</code><code class="p">,</code> <code class="n">Encoding</code><code class="p">.</code><code class="n">UTF8</code><code class="p">,</code> <code class="k">true</code><code class="p">,</code> <code class="m">8192</code><code class="p">,</code> <code class="k">false</code><code class="p">);</code>
<code class="k">using</code> <code class="nn">var</code> <code class="n">w</code> <code class="p">=</code> <code class="k">new</code> <code class="n">StreamWriter</code><code class="p">(</code><code class="n">filepath</code><code class="p">,</code> <code class="k">true</code><code class="p">,</code> <code class="n">Encoding</code><code class="p">.</code><code class="n">UTF8</code><code class="p">);</code></pre></div>
<p>Although argument names are not required here, we can make it much easier to understand what the code does by including some anyway. As <a data-type="xref" href="#clarity_by_naming_arguments">Example 3-67</a> shows, we’re free just to name the  more cryptic ones, as long as we’re supplying arguments for all of the parameters.</p>
<div data-type="example" id="clarity_by_naming_arguments">
<h5><span class="label">Example 3-67. </span>Improving clarity by naming arguments</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">using</code> <code class="nn">var</code> <code class="n">r</code> <code class="p">=</code> <code class="k">new</code> <code class="n">StreamReader</code><code class="p">(</code><code class="n">stream</code><code class="p">,</code> <code class="n">Encoding</code><code class="p">.</code><code class="n">UTF8</code><code class="p">,</code>
  <code class="n">detectEncodingFromByteOrderMarks</code><code class="p">:</code> <code class="k">true</code><code class="p">,</code> <code class="n">bufferSize</code><code class="p">:</code> <code class="m">8192</code><code class="p">,</code> <code class="n">leaveOpen</code><code class="p">:</code> <code class="k">false</code><code class="p">);</code>
<code class="k">using</code> <code class="nn">var</code> <code class="n">w</code> <code class="p">=</code> <code class="k">new</code> <code class="n">StreamWriter</code><code class="p">(</code><code class="n">filepath</code><code class="p">,</code> <code class="n">append</code><code class="p">:</code> <code class="k">true</code><code class="p">,</code> <code class="n">Encoding</code><code class="p">.</code><code class="n">UTF8</code><code class="p">);</code></pre></div>
<p>It’s important to understand how C# implements default argument values because it has an impact on evolving library design. When you invoke a method without providing all the arguments, as <a data-type="xref" href="#specifying_an_argument_name">Example 3-65</a> does, the compiler generates code that passes a full set of arguments as normal. It effectively rewrites your code, adding back in the arguments you left out. The significance of this is that if you write a library that defines default argument values like this, you will run into problems if you ever change the defaults. Code that was compiled against the old version of the library will have copied the old defaults into the call sites and won’t pick up the new values unless it is recompiled.</p>
</div></section>
<section data-pdf-bookmark="Overloading" data-type="sect3"><div class="sect3" id="overloading">
<h3>Overloading</h3>
<p><a data-primary="overloading" data-type="indexterm" id="idm45884829614704"/>You will sometimes see an alternative mechanism used for allowing arguments to be omitted, which avoids baking default values into call sites: <em>overloading</em>. This is a slightly histrionic term for the rather mundane idea that a single name or symbol can be given multiple meanings. In fact, we already saw this technique with constructors—in <a data-type="xref" href="#chained_constructor_arguments">Example 3-42</a>, I defined one main constructor that did the real work, and then two other constructors that called into that one. We can use the same trick with methods, as <a data-type="xref" href="#overloaded_method">Example 3-68</a> shows.</p>
<div data-type="example" id="overloaded_method">
<h5><span class="label">Example 3-68. </span>Overloaded method</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">static</code> <code class="k">void</code> <code class="nf">Blame</code><code class="p">(</code><code class="kt">string</code> <code class="n">perpetrator</code><code class="p">,</code> <code class="kt">string</code> <code class="n">problem</code><code class="p">)</code>
<code class="p">{</code>
     <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"I blame {perpetrator} for {problem}."</code><code class="p">);</code>
<code class="p">}</code>

<code class="k">public</code> <code class="k">static</code> <code class="k">void</code> <code class="nf">Blame</code><code class="p">(</code><code class="kt">string</code> <code class="n">perpetrator</code><code class="p">)</code>
<code class="p">{</code>
    <code class="n">Blame</code><code class="p">(</code><code class="n">perpetrator</code><code class="p">,</code> <code class="s">"the downfall of society"</code><code class="p">);</code>
<code class="p">}</code>

<code class="k">public</code> <code class="k">static</code> <code class="k">void</code> <code class="nf">Blame</code><code class="p">()</code>
<code class="p">{</code>
    <code class="n">Blame</code><code class="p">(</code><code class="s">"the youth of today"</code><code class="p">,</code> <code class="s">"the downfall of society"</code><code class="p">);</code>
<code class="p">}</code></pre></div>
<p>In one sense, this is slightly less flexible than default argument values, because code calling the <code>Blame</code> method no longer has any way to specify a value for the <code>problem</code> argument while picking up the default <code>perpetrator</code> (although it would be easy enough to solve that by just adding a method with a different name). On the other hand, method overloading offers two potential advantages: it allows you to decide on the default values at runtime if necessary, and it also provides a way to make <code>out</code> and <code>ref</code> arguments optional. Those require references to local variables, so there’s no way to define a default value, but you can always provide overloads with and without those arguments if you need to. And you can use a mixture of the two techniques—you might rely mainly on optional arguments, using overloads only to enable <code>out</code> or <code>ref</code> arguments to be omitted.</p>
</div></section>
<section class="less_space pagebreak-before" data-pdf-bookmark="Variable argument count with the params keyword" data-type="sect3"><div class="sect3" id="variable_argument_count_with_the_params">
<h3>Variable argument count with the params keyword</h3>
<p><a data-primary="arguments" data-secondary="variable argument count with params keyword" data-type="indexterm" id="ix_ch03-asciidoc38"/><a data-primary="methods" data-secondary="variable argument count with params keyword" data-type="indexterm" id="ix_ch03-asciidoc39"/><a data-primary="params keyword" data-type="indexterm" id="ix_ch03-asciidoc40"/>Some methods need to be able to accept different amounts of data in different situations. Take the mechanism that I’ve used a few times in this book to display information. <a data-primary="$ (string interpolation)" data-type="indexterm" id="idm45884829514960"/>In most cases, I’ve passed a simple string to <code>Console.WriteLine</code>, and when I’ve wanted to format and display other pieces of information, I’ve used string interpolation to embed expressions in strings. <a data-primary="string.Format method" data-type="indexterm" id="idm45884829513808"/>However, as you may recall from <a data-type="xref" href="ch02.xhtml#ch_basic_coding">Chapter 2</a>, in cases where we want to embed a large number of expressions into a string, string interpolation can become unwieldy, and it might be preferable instead to use the older <code>string.Format</code> method, shown in <a data-type="xref" href="#string_formatting">Example 3-69</a>.</p>
<div data-type="example" id="string_formatting">
<h5><span class="label">Example 3-69. </span>String formatting</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">r</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Random</code><code class="p">();</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="kt">string</code><code class="p">.</code><code class="n">Format</code><code class="p">(</code>
    <code class="s">"{0}, {1}, {2}, {3}"</code><code class="p">,</code>
    <code class="n">r</code><code class="p">.</code><code class="n">Next</code><code class="p">(</code><code class="m">10</code><code class="p">),</code> <code class="n">r</code><code class="p">.</code><code class="n">Next</code><code class="p">(</code><code class="m">10</code><code class="p">),</code> <code class="n">r</code><code class="p">.</code><code class="n">Next</code><code class="p">(</code><code class="m">10</code><code class="p">),</code> <code class="n">r</code><code class="p">.</code><code class="n">Next</code><code class="p">(</code><code class="m">10</code><code class="p">)));</code></pre></div>
<p>If you look at the documentation for <code>string.Format</code>, you’ll see that it offers several overloads taking various numbers of arguments. The number of overloads has to be finite, but if you try it, you’ll find that this is nonetheless an open-ended arrangement. You can pass as many arguments as you like after the string, and the numbers in the placeholders can go as high as necessary to refer to these arguments. The final line of <a data-type="xref" href="#string_formatting">Example 3-69</a> passes four arguments after the string, and even though the <code>string</code> class does not define an overload accepting that many arguments, it works.</p>
<p>One particular overload of the <code>string.Format</code> method takes over once you pass more than a certain number of arguments after the string (more than three, as it happens). This overload just takes two arguments: a <code>string</code> and an <code>object[]</code> array. The code that the compiler creates to invoke the method builds an array to hold all the arguments after the string and passes that. So the final statement of <a data-type="xref" href="#string_formatting">Example 3-69</a> is effectively equivalent to the code in <a data-type="xref" href="#explicitly_passing_multiple_arguments_as">Example 3-70</a>. (<a data-type="xref" href="ch05.xhtml#ch_collections">Chapter 5</a> describes arrays.)</p>
<div data-type="example" id="explicitly_passing_multiple_arguments_as">
<h5><span class="label">Example 3-70. </span>Explicitly passing multiple arguments as an array</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="kt">string</code><code class="p">.</code><code class="n">Format</code><code class="p">(</code>
    <code class="s">"{0}, {1}, {2}, {3}"</code><code class="p">,</code>
    <code class="k">new</code> <code class="kt">object</code><code class="p">[]</code> <code class="p">{</code> <code class="n">r</code><code class="p">.</code><code class="n">Next</code><code class="p">(</code><code class="m">10</code><code class="p">),</code> <code class="n">r</code><code class="p">.</code><code class="n">Next</code><code class="p">(</code><code class="m">10</code><code class="p">),</code> <code class="n">r</code><code class="p">.</code><code class="n">Next</code><code class="p">(</code><code class="m">10</code><code class="p">),</code> <code class="n">r</code><code class="p">.</code><code class="n">Next</code><code class="p">(</code><code class="m">10</code><code class="p">)</code> <code class="p">}));</code></pre></div>
<p>The compiler will do this only with parameters that are annotated with the <code>params</code> keyword. <a data-type="xref" href="#params_keyword">Example 3-71</a> shows how the relevant <code>string.Format</code> method’s 
<span class="keep-together">declaration looks.</span></p>
<div data-type="example" id="params_keyword">
<h5><span class="label">Example 3-71. </span>The <code>params</code> keyword</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">static</code> <code class="kt">string</code> <code class="nf">Format</code><code class="p">(</code><code class="kt">string</code> <code class="n">format</code><code class="p">,</code> <code class="k">params</code> <code class="kt">object</code><code class="p">[]</code> <code class="n">args</code><code class="p">)</code></pre></div>
<p>The <code>params</code> keyword can appear only on a method’s final parameter, and that parameter type must be an array. In this case, it’s an <code>object[]</code>, meaning that we can pass objects of any type, but you can be more specific to limit what can be passed in.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>When a method is overloaded, the C# compiler looks for the method whose parameters best match the arguments supplied. It will consider using a method with a <code>params</code> argument only if a more specific match is not available.</p>
</div>
<p>You may be wondering why the <code>string</code> class bothers to offer overloads that accept one, two, or three <code>object</code> arguments. The presence of this <code>params</code> version seems to make those redundant—it lets you pass any number of arguments after the string, so what’s the point of the ones that take a specific number of arguments? Those overloads exist to make it possible to avoid allocating an array. That’s not to say that arrays are particularly expensive; they cost no more than any other object of the same size. However, allocating memory is not free. Every object you allocate will eventually have to be freed by the garbage collector (except for objects that hang around for the whole life of the program), so reducing the number of allocations is usually good for performance. Because of this, most APIs in the runtime libraries that accept a variable number of arguments through <code>params</code> also offer overloads that allow a small number of arguments to be passed without needing to allocate an array to hold them<a data-startref="ix_ch03-asciidoc40" data-type="indexterm" id="idm45884829335488"/>.<a data-startref="ix_ch03-asciidoc39" data-type="indexterm" id="idm45884829334656"/><a data-startref="ix_ch03-asciidoc38" data-type="indexterm" id="idm45884829333952"/><a data-startref="ix_ch03-asciidoc36" data-type="indexterm" id="idm45884829333280"/></p>
</div></section>
<section data-pdf-bookmark="Local functions" data-type="sect3"><div class="sect3" id="local_functions">
<h3>Local functions</h3>
<p><a data-primary="local functions" data-type="indexterm" id="ix_ch03-asciidoc41"/><a data-primary="methods" data-secondary="local functions" data-type="indexterm" id="ix_ch03-asciidoc42"/>You can define methods inside other methods. These are called <em>local functions</em>, and <a data-type="xref" href="#local_function">Example 3-72</a> defines two of them. (You can also put them inside other method-like features, such as constructors or property accessors.)</p>
<div data-type="example" id="local_function">
<h5><span class="label">Example 3-72. </span>Local functions</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">static</code> <code class="kt">double</code> <code class="nf">GetAverageDistanceFrom</code><code class="p">(</code>
    <code class="p">(</code><code class="kt">double</code> <code class="n">X</code><code class="p">,</code> <code class="kt">double</code> <code class="n">Y</code><code class="p">)</code> <code class="n">referencePoint</code><code class="p">,</code>
    <code class="p">(</code><code class="kt">double</code> <code class="n">X</code><code class="p">,</code> <code class="kt">double</code> <code class="n">Y</code><code class="p">)[]</code> <code class="n">points</code><code class="p">)</code>
<code class="p">{</code>
    <code class="kt">double</code> <code class="n">total</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code>
    <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code> <code class="n">i</code> <code class="p">&lt;</code> <code class="n">points</code><code class="p">.</code><code class="n">Length</code><code class="p">;</code> <code class="p">++</code><code class="n">i</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">total</code> <code class="p">+=</code> <code class="n">GetDistanceFromReference</code><code class="p">(</code><code class="n">points</code><code class="p">[</code><code class="n">i</code><code class="p">]);</code>
    <code class="p">}</code>
    <code class="k">return</code> <code class="n">total</code> <code class="p">/</code> <code class="n">points</code><code class="p">.</code><code class="n">Length</code><code class="p">;</code>

    <code class="kt">double</code> <code class="nf">GetDistanceFromReference</code><code class="p">((</code><code class="kt">double</code> <code class="n">X</code><code class="p">,</code> <code class="kt">double</code> <code class="n">Y</code><code class="p">)</code> <code class="n">p</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="nf">GetDistance</code><code class="p">(</code><code class="n">p</code><code class="p">,</code> <code class="n">referencePoint</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">static</code> <code class="kt">double</code> <code class="nf">GetDistance</code><code class="p">((</code><code class="kt">double</code> <code class="n">X</code><code class="p">,</code> <code class="kt">double</code> <code class="n">Y</code><code class="p">)</code> <code class="n">p1</code><code class="p">,</code> <code class="p">(</code><code class="kt">double</code> <code class="n">X</code><code class="p">,</code> <code class="kt">double</code> <code class="n">Y</code><code class="p">)</code> <code class="n">p2</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="kt">double</code> <code class="n">dx</code> <code class="p">=</code> <code class="n">p1</code><code class="p">.</code><code class="n">X</code> <code class="p">-</code> <code class="n">p2</code><code class="p">.</code><code class="n">X</code><code class="p">;</code>
        <code class="kt">double</code> <code class="n">dy</code> <code class="p">=</code> <code class="n">p1</code><code class="p">.</code><code class="n">Y</code> <code class="p">-</code> <code class="n">p2</code><code class="p">.</code><code class="n">Y</code><code class="p">;</code>
        <code class="k">return</code> <code class="n">Math</code><code class="p">.</code><code class="n">Sqrt</code><code class="p">(</code><code class="n">dx</code> <code class="p">*</code> <code class="n">dx</code> <code class="p">+</code> <code class="n">dy</code> <code class="p">*</code> <code class="n">dy</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>One reason for using local functions is that they can make the code easier to read by moving steps into named methods—it’s easier to see what’s happening when there’s a method call to <code>GetDistance</code> than it is if we just have the calculations inline. Be aware that there can be overheads, although in this particular example, when I run the Release build of this code on .NET 6.0, the JIT compiler is smart enough to inline both of the local calls here, so the two local functions vanish, and <code>Get⁠Ave⁠ra⁠ge​Dis⁠tan⁠ceF⁠rom</code> ends up being just one method. So we’ve paid no penalty here, but with more complex nested functions, the JIT compiler may decide not to inline. And when that happens, it’s useful to know how the C# compiler enables this code to work.</p>
<p>The <code>GetDistanceFromReference</code> method here takes a single tuple argument, but it uses the <code>referencePoint</code> variable defined by its containing method. For this to work, the C# compiler moves that variable into a generated <code>struct</code>, which it passes by reference to the <code>GetDistanceFromReference</code> method as a hidden argument. This is how a single local variable can be accessible to both methods. Since this generated <code>struct</code> is passed by reference, the <code>referencePoint</code> variable can still remain on the stack in this example. However, if you obtain a delegate referring to a local method, any variables shared in this way have to move into a <code>class</code> that lives on the garbage-collected heap, which will have higher overheads. (See Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch07.xhtml#ch_object_lifetime">7</a> and  <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch09.xhtml#ch_delegates_lambdas_events">9</a>  for more details.) If you want to avoid any such overheads, you can always just not share any variables between the inner and outer methods. You can tell the compiler that this is your intention by applying the <code>static</code> keyword to the local function, as <a data-type="xref" href="#local_function">Example 3-72</a> does with <code>GetDistance</code>. This will cause the compiler to report an error if the method attempts to use a variable from its containing method.</p>
<p>Besides providing a way to split methods up for readability, local functions are sometimes used to work around some limitations with iterators (see <a data-type="xref" href="ch05.xhtml#ch_collections">Chapter 5</a>) and <code>async</code> methods (<a data-type="xref" href="ch17.xhtml#ch_asynchronous_language_features">Chapter 17</a>). These are methods that might return partway through execution and then continue later, which means the compiler needs to arrange to store all of their local variables in an object living on the heap so that those variables can survive for as long as is required. This prevents these kinds of methods from declaring variables of certain types, such as reference variables, or <code>Span&lt;T&gt;</code> (described in <a data-type="xref" href="ch18.xhtml#ch_memory_efficiency">Chapter 18</a>). In cases where you need to use both <code>async</code> and <code>Span&lt;T&gt;</code>, it is common to move code using the latter into a local, non-<code>async</code> function that lives inside the <code>async</code> function. This enables the local function to use local variables with these constrained types.<a data-startref="ix_ch03-asciidoc42" data-type="indexterm" id="idm45884829078944"/><a data-startref="ix_ch03-asciidoc41" data-type="indexterm" id="idm45884829078240"/></p>
</div></section>
<section data-pdf-bookmark="Expression-bodied methods" data-type="sect3"><div class="sect3" id="expression_bodied_methods">
<h3>Expression-bodied methods</h3>
<p><a data-primary="expression-bodied methods" data-type="indexterm" id="idm45884829076160"/><a data-primary="methods" data-secondary="expression-bodied" data-type="indexterm" id="idm45884829075216"/>If you write a method simple enough to consist of nothing more than a single return statement, you can use a more concise syntax. <a data-type="xref" href="#expression_bodied_method">Example 3-73</a> shows an alternative way to write the <code>GetDistanceFromReference</code> method from <a data-type="xref" href="#local_function">Example 3-72</a>. (If you’re reading this book in order, you’ve probably noticed that I’ve already used this in a few other examples.) By the way, I can’t do this for <code>GetDistance</code> because that contains multiple statements.</p>
<div data-type="example" id="expression_bodied_method">
<h5><span class="label">Example 3-73. </span>An expression-bodied method</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">double</code> <code class="nf">GetDistanceFromReference</code><code class="p">((</code><code class="kt">double</code> <code class="n">X</code><code class="p">,</code> <code class="kt">double</code> <code class="n">Y</code><code class="p">)</code> <code class="n">p</code><code class="p">)</code>
    <code class="p">=&gt;</code> <code class="n">GetDistance</code><code class="p">(</code><code class="n">p</code><code class="p">,</code> <code class="n">referencePoint</code><code class="p">);</code></pre></div>
<p><a data-primary="=&gt; syntax" data-secondary="expression-bodied members" data-type="indexterm" id="idm45884829061488"/>Instead of a method body, you write <code>=&gt;</code> followed by the expression that would otherwise have followed the <code>return</code> keyword. This <code>=&gt;</code> syntax intentionally resembles the lambda syntax you can use for writing inline functions and building expression trees. These are discussed in <a data-type="xref" href="ch09.xhtml#ch_delegates_lambdas_events">Chapter 9</a>. But when using <code>=&gt;</code> to write an expression-bodied member, it’s just a convenient shorthand. The code works exactly as if you had written a full method containing just a <code>return</code> statement.</p>
</div></section>
<section data-pdf-bookmark="Extension methods" data-type="sect3"><div class="sect3" id="extension_methods">
<h3>Extension methods</h3>
<p><a data-primary="extension methods" data-type="indexterm" id="ix_ch03-asciidoc43"/><a data-primary="methods" data-secondary="extension" data-type="indexterm" id="ix_ch03-asciidoc44"/>C# lets you write methods that appear to be new members of existing types. <em>Extension methods</em>, as they are called, look like normal static methods but with the <code>this</code> keyword added before the first parameter. You are allowed to define extension methods only in a static class. <a data-type="xref" href="#extension_method">Example 3-74</a> adds a not especially useful extension method to the <code>string</code>, called <code>Show</code>.</p>
<div data-type="example" id="extension_method">
<h5><span class="label">Example 3-74. </span>An extension method</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code> <code class="nn">MyApplication</code><code class="p">;</code>

<code class="k">public</code> <code class="k">static</code> <code class="k">class</code> <code class="nc">StringExtensions</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">static</code> <code class="k">void</code> <code class="nf">Show</code><code class="p">(</code><code class="k">this</code> <code class="kt">string</code> <code class="n">s</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">s</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>I’ve shown the namespace declaration in this example because namespaces are significant: extension methods are available only if you’ve written a <code>using</code> directive for the namespace in which the extension is defined, or if the code you’re writing is defined in the same namespace. In code that does neither of these things, the <code>string</code> class will look normal and will not acquire the <code>Show</code> method defined by <a data-type="xref" href="#extension_method">Example 3-74</a>. <span class="keep-together">However,</span> code such as <a data-type="xref" href="#extension_method_available_due_to_namesp">Example 3-75</a>, which is defined in the same namespace as the extension method, will find that the method is available.</p>
<div data-type="example" id="extension_method_available_due_to_namesp">
<h5><span class="label">Example 3-75. </span>Extension method available due to namespace declaration</h5>
<pre data-code-language="csharp" data-type="programlisting"><strong><code class="k">namespace</code><code> </code><code class="nn">MyApplication</code><code class="p">;</code></strong><code>
</code><code>
</code><code class="k">internal</code><code> </code><code class="k">class</code><code> </code><code class="nc">Showy</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="k">static</code><code> </code><code class="k">void</code><code> </code><code class="nf">Greet</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><strong><code class="s">"Hello"</code><code class="p">.</code><code class="n">Show</code><code class="p">(</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code>    </code><code class="p">}</code><code>
</code><code class="p">}</code></pre></div>
<p>The code in <a data-type="xref" href="#extension_method_available_due_to_using">Example 3-76</a> is in a different namespace, but it also has access to the extension method, thanks to a <code>using</code> directive.</p>
<div data-type="example" id="extension_method_available_due_to_using">
<h5><span class="label">Example 3-76. </span>Extension method available due to <code>using</code> directive</h5>
<pre data-code-language="csharp" data-type="programlisting"><strong><code class="k">using</code><code> </code><code class="nn">MyApplication</code><code class="p">;</code></strong><code>
</code><code>
</code><code class="k">namespace</code><code> </code><code class="nn">Other</code><code class="p">;</code><code>
</code><code>
</code><code class="k">internal</code><code> </code><code class="k">class</code><code> </code><code class="nc">Vocal</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="k">static</code><code> </code><code class="k">void</code><code> </code><code class="nf">Hail</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="s">"Hello"</code><code class="p">.</code><code class="n">Show</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code class="p">}</code></pre></div>
<p>Extension methods are not really members of the class for which they are defined—the <code>string</code> class does not truly gain an extra method in these examples. It’s just an illusion maintained by the C# compiler, one that it keeps up even in situations where method invocation happens implicitly. This is particularly useful with C# features that require certain methods to be available. In <a data-type="xref" href="ch02.xhtml#ch_basic_coding">Chapter 2</a>, you saw that <code>foreach</code> loops depend on a <code>GetEnumerator</code> method. Many of the LINQ features we’ll look at in <a data-type="xref" href="ch10.xhtml#ch_linq">Chapter 10</a> also depend on certain methods being present, as do the asynchronous language features described in <a data-type="xref" href="ch17.xhtml#ch_asynchronous_language_features">Chapter 17</a>. In all cases, you can enable these language features for types that do not support them directly by writing suitable extension methods<a data-startref="ix_ch03-asciidoc44" data-type="indexterm" id="idm45884828861264"/><a data-startref="ix_ch03-asciidoc43" data-type="indexterm" id="idm45884828860592"/>.<a data-startref="ix_ch03-asciidoc27" data-type="indexterm" id="idm45884828859792"/><a data-startref="ix_ch03-asciidoc26" data-type="indexterm" id="idm45884828859088"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Properties" data-type="sect2"><div class="sect2" id="properties">
<h2>Properties</h2>
<p><a data-primary="members" data-secondary="properties" data-type="indexterm" id="ix_ch03-asciidoc45"/><a data-primary="properties" data-type="indexterm" id="ix_ch03-asciidoc46"/>Classes and structs can define <em>properties</em>, which are really just methods in disguise. To access a property, you use a syntax that looks like field access but ends up invoking a method. Properties can be useful for signaling intent. When something is exposed as a property, the implication is that it represents information about the object, rather than an operation the object performs, so reading a property is usually inexpensive and should have no significant side effects. Methods, on the other hand, are more likely to cause an object to do something.</p>
<p>Of course, since properties are just a kind of method, nothing enforces this. You are free to write a property that takes hours to run and makes significant changes to your application’s state whenever its value is read, but that would be a pretty lousy way to design code.</p>
<p><a data-primary="get (property accessor)" data-type="indexterm" id="idm45884828825040"/><a data-primary="set (property accessor)" data-type="indexterm" id="idm45884828824208"/>Properties typically provide a pair of methods: one to get the value and one to set it. <a data-type="xref" href="#class_with_simple_property">Example 3-77</a> shows a very common pattern: a property with <code>get</code> and <code>set</code> methods that provide access to a field. Why not just make the field public? That’s often frowned upon, because it makes it possible for external code to change an object’s state without the object knowing about it. It might be that in future revisions of the code, the object needs to do something—perhaps update the UI—every time the value changes. In any case, because properties contain code, they offer more flexibility than public fields. For example, you might want to store the data in a different format than is returned by the property, or you may even be able to implement a property that calculates its value from other properties. Another reason for using properties is simply that some systems require it—for example, some UI databinding systems are only prepared to consume properties. Also, some types do not support instance fields; later in this chapter, I’ll show how to define an abstract type using an <em>interface</em>, and interfaces can contain properties but not instance fields.</p>
<div data-type="example" id="class_with_simple_property">
<h5><span class="label">Example 3-77. </span>Class with simple property</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code><code> </code><code class="k">class</code><code> </code><code class="nc">HasProperty</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">private</code><code> </code><code class="kt">int</code><code> </code><code class="n">_x</code><code class="p">;</code><code>
</code><code>    </code><strong><code class="k">public</code><code> </code><code class="kt">int</code><code> </code><code class="n">X</code></strong><code>
</code><code>    </code><strong><code class="p">{</code></strong><code>
</code><code>        </code><strong><code class="k">get</code></strong><code>
</code><code>        </code><strong><code class="p">{</code></strong><code>
</code><code>            </code><strong><code class="k">return</code><code> </code><code class="n">_x</code><code class="p">;</code></strong><code>
</code><code>        </code><strong><code class="p">}</code></strong><code>
</code><code>        </code><strong><code class="k">set</code></strong><code>
</code><code>        </code><strong><code class="p">{</code></strong><code>
</code><code>            </code><strong><code class="n">_x</code><code> </code><code class="p">=</code><code> </code><code class="k">value</code><code class="p">;</code></strong><code>
</code><code>        </code><strong><code class="p">}</code></strong><code>
</code><code>    </code><strong><code class="p">}</code></strong><code>
</code><code class="p">}</code></pre></div>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Inside a <code>set</code> accessor, <code>value</code> has a special meaning. <a data-primary="contextual keywords" data-type="indexterm" id="idm45884828773392"/>It’s a <em>contextual keyword</em>—text that the language treats as a keyword in certain contexts. Outside of a property, you can use <code>value</code> as an identifier, but within a property, it represents the value that the caller wants to assign to the property.</p>
</div>
<p>In cases where the entire body of the <code>get</code> is just a return statement, or where the <code>set</code> is a single expression statement, you can use the <em>expression-bodied member</em> syntax shown in <a data-type="xref" href="#expression_bodied_accessors">Example 3-78</a>. (This is very similar to the method syntax shown in <a data-type="xref" href="#expression_bodied_method">Example 3-73</a>.)</p>
<div data-type="example" id="expression_bodied_accessors">
<h5><span class="label">Example 3-78. </span>Expression-bodied <code>get</code> and <code>set</code></h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">class</code> <code class="nc">HasProperty</code>
<code class="p">{</code>
    <code class="k">private</code> <code class="kt">int</code> <code class="n">_x</code><code class="p">;</code>
    <code class="k">public</code> <code class="kt">int</code> <code class="n">X</code>
    <code class="p">{</code>
        <code class="k">get</code> <code class="p">=&gt;</code> <code class="n">_x</code><code class="p">;</code>
        <code class="k">set</code> <code class="p">=&gt;</code> <code class="n">_x</code> <code class="p">=</code> <code class="k">value</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>The pattern in Examples <a data-type="xref" data-xrefstyle="select:labelnumber" href="#class_with_simple_property">3-77</a> and  <a data-type="xref" data-xrefstyle="select:labelnumber" href="#expression_bodied_accessors">3-78</a> is so common that C# can write most of it for you. <a data-type="xref" href="#auto-property">Example 3-79</a> is more or less equivalent—the compiler generates a field for us and produces <code>get</code> and <code>set</code> methods that retrieve and modify the value just like those in <a data-type="xref" href="#class_with_simple_property">Example 3-77</a>. The only difference is that code elsewhere in the same class can’t get directly at the field in <a data-type="xref" href="#auto-property">Example 3-79</a>, because the compiler hides it. <a data-primary="auto-properties" data-type="indexterm" id="idm45884828710592"/>The official name in the language specification for this is an <em>automatically implemented property</em>, but these are typically referred to as just <em>auto-properties</em>.</p>
<div data-type="example" id="auto-property">
<h5><span class="label">Example 3-79. </span>An auto-property</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">class</code> <code class="nc">HasProperty</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">int</code> <code class="n">X</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>Whether you use explicit or automatic properties, this is just a fancy syntax for a pair of methods. The <code>get</code> method returns a value of the property’s declared type—an <code>int</code>, in this case—while the setter takes a single argument of that type through the implicit <code>value</code> parameter. <a data-type="xref" href="#class_with_simple_property">Example 3-77</a> makes use of that argument to update the field. You’re not obliged to store the value in a field, of course. In fact, nothing even forces you to make the <code>get</code> and <code>set</code> methods related in any way—you could write a getter that returns random values and a setter that completely ignores the value you supply. However, just because you <em>can</em> doesn’t mean you <em>should</em>. In practice, anyone using your class will expect properties to remember the values they’ve been given, not least because in use, properties look just like fields, as <a data-type="xref" href="#using_a_property">Example 3-80</a> shows.</p>
<div data-type="example" id="using_a_property">
<h5><span class="label">Example 3-80. </span>Using a property</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">o</code> <code class="p">=</code> <code class="k">new</code> <code class="n">HasProperty</code><code class="p">();</code>
<code class="n">o</code><code class="p">.</code><code class="n">X</code> <code class="p">=</code> <code class="m">123</code><code class="p">;</code>
<code class="n">o</code><code class="p">.</code><code class="n">X</code> <code class="p">+=</code> <code class="m">432</code><code class="p">;</code>
<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">o</code><code class="p">.</code><code class="n">X</code><code class="p">);</code></pre></div>
<p>If you’re using the full syntax shown in <a data-type="xref" href="#class_with_simple_property">Example 3-77</a> to implement a property, or the expression-bodied form shown in <a data-type="xref" href="#expression_bodied_accessors">Example 3-78</a>, you can leave out either the <code>set</code> or the <code>get</code> to make a read-only or write-only property. Read-only properties can be useful for aspects of an object that are fixed for its lifetime, such as an identifier, or that are calculated from other properties. Write-only properties are less useful, although they can crop up in dependency injection systems. You can’t make a write-only property with the auto-property syntax shown in <a data-type="xref" href="#auto-property">Example 3-79</a>, because you wouldn’t be able to do anything useful with the value being set.</p>
<p>There are two variations on read-only properties. Sometimes it is useful to have a property that is publicly read-only but that your class is free to change. You can define a property where the getter is public but the setter is not (or vice versa for a write-only property). You can do this with either the full or the automatic syntax. <a data-type="xref" href="#auto-property_with_private_setter">Example 3-81</a> shows how this looks with the latter.</p>
<div data-type="example" id="auto-property_with_private_setter">
<h5><span class="label">Example 3-81. </span>Auto-property with private setter</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="kt">int</code> <code class="n">X</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">private</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code></pre></div>
<p>If you want your property to be read-only in the sense that its value never changes after construction, you can leave out the setter entirely when using the auto-property syntax, as <a data-type="xref" href="#auto-property_with_no_setter">Example 3-82</a> shows.</p>
<div data-type="example" id="auto-property_with_no_setter">
<h5><span class="label">Example 3-82. </span>Auto-property with no setter</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="kt">int</code> <code class="n">X</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="p">}</code></pre></div>
<p>With no setter and no directly accessible field, you may be wondering how you can set the value of such a property. The answer is that inside your object’s constructor, the property appears to be settable. (There isn’t really a setter if you omit the <code>set</code>—the compiler generates code that just sets the backing field directly when you “set” the property in the constructor.) A get-only auto-property is effectively equivalent to a <code>readonly</code> field wrapped with an ordinary get-only property. As with fields, you can also write an initializer to provide an initial value. <a data-type="xref" href="#initializing_an_auto-property_with_no_se">Example 3-83</a> uses both styles; if you use the constructor that takes no arguments, the property’s value will be 42, and if you use the other constructor, it will have whatever value you supply.</p>
<div data-type="example" id="initializing_an_auto-property_with_no_se">
<h5><span class="label">Example 3-83. </span>Initializing an auto-property with no setter</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">class</code> <code class="nc">WithAutos</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">int</code> <code class="n">X</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="p">}</code> <code class="p">=</code> <code class="m">42</code><code class="p">;</code>

    <code class="k">public</code> <code class="nf">WithAutos</code><code class="p">()</code>
    <code class="p">{</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="nf">WithAutos</code><code class="p">(</code><code class="kt">int</code> <code class="n">val</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">X</code> <code class="p">=</code> <code class="n">val</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>This initializer syntax works for read-write properties, by the way. You can also use it if you want to create a <code>record</code> type that uses the positional syntax but that wants the properties to be writable, as <a data-type="xref" href="#positional_record_with_writeable_properties">Example 3-84</a> shows. This is slightly unusual, since the features offered by record types are mainly intended to make it easier to define immutable data types. But mutability is supported, and it can be useful to require certain properties to be initialized even when they are writable, to avoid the nullable reference type system complaining that your non-nullable property might initially have a null value.</p>
<div data-type="example" id="positional_record_with_writeable_properties">
<h5><span class="label">Example 3-84. </span>Record requiring initial values but allowing later modification</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="n">record</code> <code class="nf">EnforcedInitButMutable</code><code class="p">(</code><code class="kt">string</code> <code class="n">Name</code><code class="p">,</code> <code class="kt">string</code> <code class="n">FavoriteColor</code><code class="p">)</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Name</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code> <code class="p">=</code> <code class="n">Name</code><code class="p">;</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">FavoriteColor</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code> <code class="p">=</code> <code class="n">FavoriteColor</code><code class="p">;</code>
<code class="p">}</code></pre></div>
<p>Since the positional syntax is ultimately just a way to define a constructor, you might be tempted in cases like <a data-type="xref" href="#positional_record_with_writeable_properties">Example 3-84</a> to use more conventionally cased names for the constructor arguments, e.g., <code>name</code> and <code>favoriteColor</code>. But the effect of that would be to create a record with four properties: <code>name</code>, <code>Name</code>, <code>favoriteColor</code>, and <code>FavoriteColor</code>. If you use the positional syntax, your record type will have all of the properties named in that syntax. It might look here like we’ve defined the same properties twice, but in fact the duplicate names are how C# knows that we are just saying we want something other than the normal generated properties here.</p>
<p>There’s a variation on the theme of read-only properties shown in <a data-type="xref" href="#auto-property_with_init_setter">Example 3-85</a>. In place of the <code>set</code>, we have the <code>init</code> keyword. (This is how properties generated in a record type due to the positional syntax look if you don’t customize them, by the way.)</p>
<div data-type="example" id="auto-property_with_init_setter">
<h5><span class="label">Example 3-85. </span>Class with auto-property with init-only setter</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">class</code> <code class="nc">WithInit</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">int</code> <code class="n">X</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="n">init</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>This is almost identical to a read-only property: it indicates that the property is not to be modified after the object is initialized. However, there’s one significant difference: the compiler generates a public setter when you use this syntax. It refuses to compile code that attempts to modify the property after the object has been initialized, so for most scenarios it behaves just like a read-only property, <a data-primary="object initializers" data-type="indexterm" id="idm45884828344640"/>but this enables one critical scenario: it lets you set the property in an <em>object initializer</em>. I’ll be describing object initializers in full later, but <a data-type="xref" href="#setting_init_only_property">Example 3-86</a> shows a simple example.</p>
<div data-type="example" id="setting_init_only_property">
<h5><span class="label">Example 3-86. </span>Setting an init-only property</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">x</code> <code class="p">=</code> <code class="k">new</code> <code class="n">WithInit</code>
<code class="p">{</code>
    <code class="n">X</code> <code class="p">=</code> <code class="m">42</code>
<code class="p">};</code></pre></div>
<p>This is the one extra place you can use an init-only property—besides this you can only set them in places where it would also be permissible to set a read-only property.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>The restrictions on init-only properties are enforced only by the compiler. From the CLR’s perspective, they are read-write properties, meaning that if you were to use this sort of property from some language that did not recognize this init-only feature (which was new in C# 9.0), or using indirect means such as reflection (see <a data-type="xref" href="ch13.xhtml#ch_reflection">Chapter 13</a>), it would be able to set the property at any time, not just during initialization.</p>
</div>
<p>Init-only properties provide a way to enable immutable <code>struct</code> types to use the same <code>with</code> syntax that is available to record types. <a data-type="xref" href="#a_readonly_struct_with_init_only_props">Example 3-87</a> shows another variation on the <code>Point</code> type used in various earlier examples, this time featuring init-only properties.</p>
<div data-type="example" id="a_readonly_struct_with_init_only_props">
<h5><span class="label">Example 3-87. </span>A <code>readonly struct</code> with init-only properties</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">readonly</code> <code class="k">struct</code> <code class="nc">Point</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="nf">Point</code><code class="p">(</code><code class="kt">double</code> <code class="n">x</code><code class="p">,</code> <code class="kt">double</code> <code class="n">y</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">X</code> <code class="p">=</code> <code class="n">x</code><code class="p">;</code>
        <code class="n">Y</code> <code class="p">=</code> <code class="n">y</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="kt">double</code> <code class="n">X</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="n">init</code><code class="p">;</code> <code class="p">}</code>
    <code class="k">public</code> <code class="kt">double</code> <code class="n">Y</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="n">init</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>This defines setters for the properties, which would normally not be allowed with a <code>readonly struct</code>, but because they can be set only during initialization, they don’t cause a problem here. And they enable code such as <a data-type="xref" href="#with_syntax_on_non_record_struct">Example 3-88</a>.</p>
<div data-type="example" id="with_syntax_on_non_record_struct">
<h5><span class="label">Example 3-88. </span>Using the <code>with</code> syntax on a nonrecord <code>readonly struct</code></h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">Point</code> <code class="n">p1</code> <code class="p">=</code> <code class="k">new</code><code class="p">(</code><code class="m">0</code><code class="p">,</code> <code class="m">10</code><code class="p">);</code>
<code class="n">Point</code> <code class="n">p2</code> <code class="p">=</code> <code class="n">p1</code> <code class="n">with</code> <code class="p">{</code> <code class="n">X</code> <code class="p">=</code> <code class="m">20</code> <code class="p">};</code></pre></div>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Since you can use the <code>with</code> syntax with a nonrecord <code>struct</code>, you might be wondering whether it also works for a nonrecord <code>class</code>. It doesn’t. The <code>with</code> keyword depends on the ability to create a copy of an existing instance. This is not a problem with <code>struct</code> types—their defining feature is that they can be copied. But there is no reliable general-purpose way to clone an instance of a <code>class</code>, so with reference types, <code>with</code> only works on records, because record types <em>are</em> reliably cloneable.</p>
</div>
<p>Sometimes it is useful to write a read-only property with a value calculated entirely in terms of other properties. For example, if you have written a type representing a vector with properties called <code>X</code> and <code>Y</code>, you could add a property that returns the magnitude of the vector, calculated from those other two properties, as shown in <a data-type="xref" href="#calculated_property">Example 3-89</a>.</p>
<div data-type="example" id="calculated_property">
<h5><span class="label">Example 3-89. </span>A calculated property</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="kt">double</code> <code class="n">Magnitude</code>
<code class="p">{</code>
    <code class="k">get</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="n">Math</code><code class="p">.</code><code class="n">Sqrt</code><code class="p">(</code><code class="n">X</code> <code class="p">*</code> <code class="n">X</code> <code class="p">+</code> <code class="n">Y</code> <code class="p">*</code> <code class="n">Y</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>There is a more compact way of writing this. We could use the expression-bodied syntax shown in <a data-type="xref" href="#expression_bodied_accessors">Example 3-78</a>, but for a read-only property, we can go one step further: you can put the <code>=&gt;</code> and expression directly after the property name. (This enables us to leave out the braces and the <code>get</code> keyword.) <a data-type="xref" href="#expression_bodied_readonly_property">Example 3-90</a> is exactly equivalent to <a data-type="xref" href="#calculated_property">Example 3-89</a>.</p>
<div data-type="example" id="expression_bodied_readonly_property">
<h5><span class="label">Example 3-90. </span>An expression-bodied read-only property</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="kt">double</code> <code class="n">Magnitude</code> <code class="p">=&gt;</code> <code class="n">Math</code><code class="p">.</code><code class="n">Sqrt</code><code class="p">(</code><code class="n">X</code> <code class="p">*</code> <code class="n">X</code> <code class="p">+</code> <code class="n">Y</code> <code class="p">*</code> <code class="n">Y</code><code class="p">);</code></pre></div>
<p>Speaking of read-only properties, there’s an important issue to be aware of involving properties, value types, and immutability.</p>
<section data-pdf-bookmark="Properties and mutable value types" data-type="sect3"><div class="sect3" id="properties_and_mutable_value_types">
<h3>Properties and mutable value types</h3>
<p><a data-primary="properties" data-secondary="mutable value types and" data-type="indexterm" id="ix_ch03-asciidoc47"/><a data-primary="value type" data-secondary="properties and mutable value types" data-type="indexterm" id="ix_ch03-asciidoc48"/>As I mentioned earlier, value types tend to be more straightforward if they’re immutable, but it’s not a requirement. One reason to avoid modifiable value types is that you can end up accidentally modifying a copy of the value rather than the one you meant, and this issue becomes apparent if you define a property that uses a mutable value type. <a data-primary="Point struct" data-type="indexterm" id="ix_ch03-asciidoc49"/>The <code>Point</code> struct in the <code>System.Windows</code> namespace is modifiable, so we can use it to illustrate the problem. <a data-type="xref" href="#property_using_a_mutable_value_type">Example 3-91</a> defines a <code>Location</code> property of this type.</p>
<div data-type="example" id="property_using_a_mutable_value_type">
<h5><span class="label">Example 3-91. </span>A property using a mutable value type</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">using</code> <code class="nn">System.Windows</code><code class="p">;</code>

<code class="k">public</code> <code class="k">class</code> <code class="nc">Item</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="n">Point</code> <code class="n">Location</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>The <code>Point</code> type defines read/write properties called <code>X</code> and <code>Y</code>, so given a variable of type <code>Point</code>, you can set these properties. However, if you try to set either of these properties via another property, the code will not compile. <a data-type="xref" href="#error_cannot_modify_a_property_of_a_valu">Example 3-92</a> tries this—it attempts to modify the <code>X</code> property of a <code>Point</code> retrieved from an <code>Item</code> object’s <code>Location</code> property.</p>
<div data-type="example" id="error_cannot_modify_a_property_of_a_valu">
<h5><span class="label">Example 3-92. </span>Error: cannot modify a property of a value type property</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">item</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Item</code><code class="p">();</code>
<code class="n">item</code><code class="p">.</code><code class="n">Location</code><code class="p">.</code><code class="n">X</code> <code class="p">=</code> <code class="m">123</code><code class="p">;</code>  <code class="c1">// Will not compile</code></pre></div>
<p>This example produces the following error:</p>
<pre data-type="programlisting">error CS1612: Cannot modify the return value of 'Item.Location' because it is
not a variable</pre>
<p>C# considers fields to be variables as well as local variables and method arguments, so if we were to modify <a data-type="xref" href="#property_using_a_mutable_value_type">Example 3-91</a> so that <code>Location</code> was a public field rather than a property, <a data-type="xref" href="#error_cannot_modify_a_property_of_a_valu">Example 3-92</a> would then compile and would work as expected. But why doesn’t it work with a property? Remember that properties are just methods, so <a data-type="xref" href="#property_using_a_mutable_value_type">Example 3-91</a> is more or less equivalent to <a data-type="xref" href="#replacing_a_property_with_methods">Example 3-93</a>.</p>
<div data-type="example" id="replacing_a_property_with_methods">
<h5><span class="label">Example 3-93. </span>Replacing a property with methods</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">using</code> <code class="nn">System.Windows</code><code class="p">;</code>

<code class="k">public</code> <code class="k">class</code> <code class="nc">Item</code>
<code class="p">{</code>
    <code class="k">private</code> <code class="n">Point</code> <code class="n">_location</code><code class="p">;</code>
    <code class="k">public</code> <code class="n">Point</code> <code class="nf">get_Location</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="n">_location</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="k">public</code> <code class="k">void</code> <code class="nf">set_Location</code><code class="p">(</code><code class="n">Point</code> <code class="k">value</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">_location</code> <code class="p">=</code> <code class="k">value</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>Since <code>Point</code> is a value type, <code>get_Location</code> returns a copy. You might be wondering if we could use the <code>ref</code> return feature described earlier. We certainly could with plain methods, but there are a couple of constraints to doing this with properties. First, you cannot define an auto-property with a <code>ref</code> type. Second, you cannot define a writable property with a <code>ref</code> type. However, you can define a read-only <code>ref</code> property, as <a data-type="xref" href="#ref_type_property">Example 3-94</a> shows.</p>
<div data-type="example" id="ref_type_property">
<h5><span class="label">Example 3-94. </span>A property returning a reference</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">using</code> <code class="nn">System.Windows</code><code class="p">;</code>

<code class="k">public</code> <code class="k">class</code> <code class="nc">Item</code>
<code class="p">{</code>
    <code class="k">private</code> <code class="n">Point</code> <code class="n">_location</code><code class="p">;</code>

    <code class="k">public</code> <code class="k">ref</code> <code class="n">Point</code> <code class="n">Location</code> <code class="p">=&gt;</code> <code class="k">ref</code> <code class="n">_location</code><code class="p">;</code>
<code class="p">}</code></pre></div>
<p>With this implementation of <code>Item</code>, the code in <a data-type="xref" href="#error_cannot_modify_a_property_of_a_valu">Example 3-92</a> now works fine. (Ironically, to make the property modifiable, we had to turn it into a read-only property.)</p>
<p>Before <code>ref</code> returns were added in C# 7.0, there was no way to make this work. All possible implementations of the property would end up returning a copy of the property value, so if the compiler did allow <a data-type="xref" href="#error_cannot_modify_a_property_of_a_valu">Example 3-92</a> to compile, we would be setting the <code>X</code> property on the copy returned by the property, and not the actual value in the <code>Item</code> object that the property represents. <a data-type="xref" href="#making_the_copy_explicit">Example 3-95</a> makes this explicit, and it will in fact compile—the compiler will let us shoot ourselves in the foot if we make it sufficiently clear that we really want to. And with this version of the code, it’s quite obvious that this will not modify the value in the <code>Item</code> object.</p>
<div data-type="example" id="making_the_copy_explicit">
<h5><span class="label">Example 3-95. </span>Making the copy explicit</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">item</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Item</code><code class="p">();</code>
<code class="n">Point</code> <code class="n">location</code> <code class="p">=</code> <code class="n">item</code><code class="p">.</code><code class="n">Location</code><code class="p">;</code>
<code class="n">location</code><code class="p">.</code><code class="n">X</code> <code class="p">=</code> <code class="m">123</code><code class="p">;</code></pre></div>
<p>However, with the property implementation in <a data-type="xref" href="#ref_type_property">Example 3-94</a>, the code in <a data-type="xref" href="#error_cannot_modify_a_property_of_a_valu">Example 3-92</a> does compile and ends up behaving like the code shown in <a data-type="xref" href="#making_the_ref_explicit">Example 3-96</a>. Here we can see that we’ve retrieved a reference to a <code>Point</code>, so when we set its <code>X</code> property, we’re acting on whatever that refers to (the <code>_location</code> field in the <code>Item</code> in this case), rather than a local copy.</p>
<div data-type="example" id="making_the_ref_explicit">
<h5><span class="label">Example 3-96. </span>Making the reference explicit</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">item</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Item</code><code class="p">();</code>
<code class="k">ref</code> <code class="n">Point</code> <code class="n">location</code> <code class="p">=</code> <code class="k">ref</code> <code class="n">item</code><code class="p">.</code><code class="n">Location</code><code class="p">;</code>
<code class="n">location</code><code class="p">.</code><code class="n">X</code> <code class="p">=</code> <code class="m">123</code><code class="p">;</code></pre></div>
<p>Thanks to fairly recent additions to the language, it’s possible to make it work, although there is arguably a loss of encapsulation here: the behavior is now more or less equivalent to defining a public field. It’s also easy to get it wrong. Fortunately, most value types are immutable, and this problem arises only with mutable value types.<a data-startref="ix_ch03-asciidoc49" data-type="indexterm" id="idm45884827746304"/></p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Immutability doesn’t exactly solve the problem—you still can’t write the code you might want to, such as <code>item.Location.X = 123</code>. But at least immutable structs don’t mislead you by making it look like you should be able to do that.</p>
</div>
<p>Since all properties are really just methods (typically in pairs), in theory they could accept more arguments in addition to the implicit <code>value</code> argument used by <code>set</code> methods. The CLR allows this, but C# does not support it except for one special kind of property: an indexer<a data-startref="ix_ch03-asciidoc48" data-type="indexterm" id="idm45884827742448"/><a data-startref="ix_ch03-asciidoc47" data-type="indexterm" id="idm45884827741744"/>.<a data-startref="ix_ch03-asciidoc46" data-type="indexterm" id="idm45884827740944"/><a data-startref="ix_ch03-asciidoc45" data-type="indexterm" id="idm45884827740240"/></p>
</div></section>
<section data-pdf-bookmark="Indexers" data-type="sect3"><div class="sect3" id="indexers">
<h3>Indexers</h3>
<p><a data-primary="[] (indexers)" data-type="indexterm" id="idm45884827738064"/><a data-primary="indexers" data-type="indexterm" id="idm45884827737136"/><a data-primary="members" data-secondary="indexers" data-type="indexterm" id="idm45884827736464"/><a data-primary="properties" data-secondary="indexers" data-type="indexterm" id="idm45884827735520"/>An <em>indexer</em> is a property that takes one or more arguments and is accessed with the same syntax as is used for arrays. This is useful when you’re writing a class that contains a collection of objects. <a data-type="xref" href="#using_an_indexer">Example 3-97</a> uses one of the collection classes provided by the runtime libraries, <code>List&lt;T&gt;</code>. It is essentially a variable-length array, and it feels like a native array thanks to its indexer, used on the second and third lines. (I’ll describe arrays and collection types in detail in <a data-type="xref" href="ch05.xhtml#ch_collections">Chapter 5</a>. And I’ll describe generic types, of which <code>List&lt;T&gt;</code> is an example, in <a data-type="xref" href="ch04.xhtml#ch_generics">Chapter 4</a>.)</p>
<div data-type="example" id="using_an_indexer">
<h5><span class="label">Example 3-97. </span>Using an indexer</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code><code> </code><code class="n">numbers</code><code> </code><code class="p">=</code><code> </code><code class="k">new</code><code> </code><code class="n">List</code><code class="p">&lt;</code><code class="kt">int</code><code class="p">&gt;</code><code> </code><code class="p">{</code><code> </code><code class="m">1</code><code class="p">,</code><code> </code><code class="m">2</code><code class="p">,</code><code> </code><code class="m">1</code><code class="p">,</code><code> </code><code class="m">4</code><code> </code><code class="p">}</code><code class="p">;</code><code>
</code><strong><code class="n">numbers</code><code class="p">[</code><code class="m">2</code><code class="p">]</code><code> </code><code class="p">+</code><code class="p">=</code><code> </code><code class="n">numbers</code><code class="p">[</code><code class="m">1</code><code class="p">]</code><code class="p">;</code></strong><code>
</code><strong><code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">numbers</code><code class="p">[</code><code class="m">0</code><code class="p">]</code><code class="p">)</code><code class="p">;</code></strong></pre></div>
<p><a data-primary="default property, indexers as" data-type="indexterm" id="idm45884827652960"/>From the CLR’s point of view, an indexer is a property much like any other, except that it has been designated as the <em>default property</em>. This concept is a holdover from the old COM-based versions of Visual Basic that got carried over into .NET, and that C# mostly ignores. Indexers are the only C# feature that treats default properties as being special. If a class designates a property as being the default one, and if the property accepts at least one argument, C# will let you use that property through the indexer syntax.</p>
<p>The syntax for declaring indexers is somewhat idiosyncratic. <a data-type="xref" href="#class_with_indexer">Example 3-98</a> shows a read-only indexer. You could add a <code>set</code> accessor to make it read/write, just like with any other property.<sup><a data-type="noteref" href="ch03.xhtml#idm45884827660912" id="idm45884827660912-marker">7</a></sup></p>
<div data-type="example" id="class_with_indexer">
<h5><span class="label">Example 3-98. </span>Class with indexer</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">class</code> <code class="nc">Indexed</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="k">this</code><code class="p">[</code><code class="kt">int</code> <code class="n">index</code><code class="p">]</code>
    <code class="p">{</code>
        <code class="k">get</code> <code class="p">=&gt;</code> <code class="n">index</code> <code class="p">&lt;</code> <code class="m">5</code> <code class="p">?</code> <code class="s">"Foo"</code> <code class="p">:</code> <code class="s">"bar"</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>C# supports multidimensional indexers. These are indexers with more than one parameter—since properties are really just methods, you can define indexers with any number of parameters. You are free to use any mixture of types for the parameters. Indexers also support overloading, so you can define any number of indexers, as long as each takes a distinct set of parameter types.</p>
<p><a data-primary="null-conditional operators" data-type="indexterm" id="idm45884827600544"/>As you may recall from <a data-type="xref" href="ch02.xhtml#ch_basic_coding">Chapter 2</a>, C# offers <em>null-conditional</em> operators. In that chapter, we saw this used to access properties and fields—e.g., <code>myString?.Length</code> will be of type <code>int?</code>—and its value will be <code>null</code> if <code>myString</code> is <code>null</code>, and the value of the <code>Length</code> property otherwise. There is one other form of null-conditional operator, which can be used with an indexer, shown in <a data-type="xref" href="#null_conditional_index_access">Example 3-99</a>.</p>
<div data-type="example" id="null_conditional_index_access">
<h5><span class="label">Example 3-99. </span>Null-conditional index access</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">string?</code> <code class="n">s</code> <code class="p">=</code> <code class="n">objectWithIndexer</code><code class="p">?[</code><code class="m">2</code><code class="p">];</code></pre></div>
<p>As with the null-conditional field or property access, this generates code that checks whether the lefthand part (<code>objectWithIndexer</code> in this case) is null. If it is, the whole expression evaluates to null; it only invokes the indexer if the lefthand part of the expression is not null. It is effectively equivalent to the code shown in <a data-type="xref" href="#code_equivalent_to_null_conditional_inde">Example 3-100</a>.</p>
<div data-type="example" id="code_equivalent_to_null_conditional_inde">
<h5><span class="label">Example 3-100. </span>Code equivalent to null-conditional index access</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">string?</code> <code class="n">s</code> <code class="p">=</code> <code class="n">objectWithIndexer</code> <code class="p">==</code> <code class="k">null</code> <code class="p">?</code> <code class="k">null</code> <code class="p">:</code> <code class="n">objectWithIndexer</code><code class="p">[</code><code class="m">2</code><code class="p">];</code></pre></div>
<p>This null-conditional index syntax also works with arrays.</p>
</div></section>
<section data-pdf-bookmark="Initializer syntax" data-type="sect3"><div class="sect3" id="initializer_syntax">
<h3>Initializer syntax</h3>
<p><a data-primary="initializer syntax" data-type="indexterm" id="idm45884827538656"/><a data-primary="members" data-secondary="initializer syntax" data-type="indexterm" id="idm45884827537952"/>You will often want to set certain properties when you create an object, because it might not be possible to supply all relevant information through constructor arguments. This is particularly common with objects that represent settings for controlling some operation. For example, the <code>ProcessStartInfo</code> type enables you to configure many different aspects of a newly created OS process. It has 16 properties, but you would typically only need to set a few of these in any particular scenario. Even if you assume that the name of the file to run should always be present, there are still 32,768 possible combinations of properties. You wouldn’t want to have a constructor for every one of those.</p>
<p>In practice, a class might offer constructors for a handful of particularly common combinations, but for everything else, you just set the properties after construction. C# offers a succinct way to create an object and set some of its properties in a single expression. <a data-primary="initializers" data-secondary="object" data-type="indexterm" id="idm45884827535664"/><a data-type="xref" href="#using_an_object_initializer">Example 3-101</a> uses this <em>object initializer</em> syntax. This also works with fields, although it’s relatively unusual to have writable public fields.</p>
<div data-type="example" id="using_an_object_initializer">
<h5><span class="label">Example 3-101. </span>Using an object initializer</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">Process</code><code class="p">.</code><code class="n">Start</code><code class="p">(</code><code class="k">new</code> <code class="n">ProcessStartInfo</code>
<code class="p">{</code>
    <code class="n">FileName</code> <code class="p">=</code> <code class="s">"cmd.exe"</code><code class="p">,</code>
    <code class="n">UseShellExecute</code> <code class="p">=</code> <code class="k">true</code><code class="p">,</code>
    <code class="n">WindowStyle</code> <code class="p">=</code> <code class="n">ProcessWindowStyle</code><code class="p">.</code><code class="n">Maximized</code><code class="p">,</code>
<code class="p">});</code></pre></div>
<p>You can supply constructor arguments too. <a data-type="xref" href="#using_an_object_initializer_with_ctor">Example 3-102</a> has the same effect as <a data-type="xref" href="#using_an_object_initializer">Example 3-101</a> but chooses to supply the filename as a constructor argument. (This is one of the few properties <code>ProcessStartInfo</code> lets you supply that way.)</p>
<div data-type="example" id="using_an_object_initializer_with_ctor">
<h5><span class="label">Example 3-102. </span>Using a constructor and an object initializer</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">Process</code><code class="p">.</code><code class="n">Start</code><code class="p">(</code><code class="k">new</code> <code class="n">ProcessStartInfo</code><code class="p">(</code><code class="s">"cmd.exe"</code><code class="p">)</code>
<code class="p">{</code>
    <code class="n">UseShellExecute</code> <code class="p">=</code> <code class="k">true</code><code class="p">,</code>
    <code class="n">WindowStyle</code> <code class="p">=</code> <code class="n">ProcessWindowStyle</code><code class="p">.</code><code class="n">Maximized</code><code class="p">,</code>
<code class="p">});</code></pre></div>
<p>The object initializer syntax can remove the need for a separate variable to refer to the object while you set the properties you need. As Examples <a data-type="xref" data-xrefstyle="select:labelnumber" href="#using_an_object_initializer">3-101</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="#using_an_object_initializer_with_ctor">3-102</a> show, you can pass an object initialized in this way directly as an argument to a method. More generally, this style of initialization can be contained entirely within a single expression. This is important in scenarios that use expression trees, which we’ll be looking at in <a data-type="xref" href="ch09.xhtml#ch_delegates_lambdas_events">Chapter 9</a>. Another important benefit of initializers is that they can use an <code>init</code> accessor—when a property defines an <code>init</code> accessor and if there are no constructor overloads available that can set that property, the object initializer syntax is the only mechanism available for setting that property.</p>
<p>There’s a variation on the object initializer syntax that enables you to supply values to an indexer in an object initializer. <a data-type="xref" href="#using_an_indexer_in_an_object_initialize">Example 3-103</a> uses this to initialize a dictionary. (<a data-type="xref" href="ch05.xhtml#ch_collections">Chapter 5</a> describes dictionaries and other collection types in detail.)</p>
<div data-type="example" id="using_an_indexer_in_an_object_initialize">
<h5><span class="label">Example 3-103. </span>Using an indexer in an object initializer</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">d</code> <code class="p">=</code> <code class="k">new</code> <code class="n">Dictionary</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="kt">int</code><code class="p">&gt;</code>
<code class="p">{</code>
<code class="na">    ["One"]</code> <code class="p">=</code> <code class="m">1</code><code class="p">,</code>
<code class="na">    ["Two"]</code> <code class="p">=</code> <code class="m">2</code><code class="p">,</code>
<code class="na">    ["Three"]</code> <code class="p">=</code> <code class="m">3</code>
<code class="p">};</code></pre></div>
</div></section>
</div></section>
<section data-pdf-bookmark="Operators" data-type="sect2"><div class="sect2" id="operators-section">
<h2>Operators</h2>
<p><a data-primary="members" data-secondary="operators" data-type="indexterm" id="ix_ch03-asciidoc50"/><a data-primary="operators" data-secondary="members  and" data-type="indexterm" id="ix_ch03-asciidoc51"/>Classes and structs can define customized meanings for operators. I showed some custom operators earlier: <a data-type="xref" href="#support_custom_comparison">Example 3-29</a> supplied definitions for <code>==</code> and <code>!=</code>. A class or struct can support almost all of the arithmetic, logical, and relational operators introduced in <a data-type="xref" href="ch02.xhtml#ch_basic_coding">Chapter 2</a>. Of the operators shown in Tables <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch02.xhtml#basic_arithmetic_operators">2-3</a>, <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch02.xhtml#binary_integer_operators">2-4</a>, <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch02.xhtml#operators_for_bool">2-5</a>, and <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch02.xhtml#relational_operators">2-6</a>, you can define custom meanings for all except the conditional AND (<code>&amp;&amp;</code>) and conditional OR (<code>||</code>) operators. Those operators are evaluated in terms of other operators, however, so by defining logical AND (<code>&amp;</code>), logical OR (<code>|</code>), and also the logical <code>true</code> and <code>false</code> operators (described shortly), you can control the way that <code>&amp;&amp;</code> and <code>||</code> work for your type, even though you cannot implement them directly.</p>
<p>All custom operator implementations follow a certain pattern. They look like static methods, but in the place where you’d normally expect the method name, you instead have the <code>operator</code> keyword followed by the operator for which you want to define a custom meaning. After that comes a parameter list, where the number of parameters is determined by the number of operands the operator requires. <a data-type="xref" href="#implementing_the_plus_operator">Example 3-104</a> shows how the binary <code>+</code> operator would look for the <code>Counter</code> class defined earlier in this chapter.</p>
<div data-type="example" id="implementing_the_plus_operator">
<h5><span class="label">Example 3-104. </span>Implementing the <code>+</code> operator</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">static</code> <code class="n">Counter</code> <code class="k">operator</code> <code class="p">+(</code><code class="n">Counter</code> <code class="n">x</code><code class="p">,</code> <code class="n">Counter</code> <code class="n">y</code><code class="p">)</code>
<code class="p">{</code>
    <code class="k">return</code> <code class="k">new</code> <code class="n">Counter</code> <code class="p">{</code> <code class="n">_count</code> <code class="p">=</code> <code class="n">x</code><code class="p">.</code><code class="n">_count</code> <code class="p">+</code> <code class="n">y</code><code class="p">.</code><code class="n">_count</code> <code class="p">};</code>
<code class="p">}</code></pre></div>
<p>Although the argument count must match the number of operands the operator requires, only one of the arguments has to be the same as the defining type. <a data-type="xref" href="#supporting_other_operand_types">Example 3-105</a> exploits this to allow the <code>Counter</code> class to be added to an <code>int</code>.</p>
<div data-type="example" id="supporting_other_operand_types">
<h5><span class="label">Example 3-105. </span>Supporting other operand types</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">static</code> <code class="n">Counter</code> <code class="k">operator</code> <code class="p">+(</code><code class="n">Counter</code> <code class="n">x</code><code class="p">,</code> <code class="kt">int</code> <code class="n">y</code><code class="p">)</code>
<code class="p">{</code>
    <code class="k">return</code> <code class="k">new</code> <code class="n">Counter</code> <code class="p">{</code> <code class="n">_count</code> <code class="p">=</code> <code class="n">x</code><code class="p">.</code><code class="n">_count</code> <code class="p">+</code> <code class="n">y</code> <code class="p">};</code>
<code class="p">}</code>

<code class="k">public</code> <code class="k">static</code> <code class="n">Counter</code> <code class="k">operator</code> <code class="p">+(</code><code class="kt">int</code> <code class="n">x</code><code class="p">,</code> <code class="n">Counter</code> <code class="n">y</code><code class="p">)</code>
<code class="p">{</code>
    <code class="k">return</code> <code class="k">new</code> <code class="n">Counter</code> <code class="p">{</code> <code class="n">_count</code> <code class="p">=</code> <code class="n">x</code> <code class="p">+</code> <code class="n">y</code><code class="p">.</code><code class="n">_count</code> <code class="p">};</code>
<code class="p">}</code></pre></div>
<p>C# requires certain operators to be defined in pairs. We already saw this with the <code>==</code> and <code>!=</code> operators—it is illegal to define one and not the other. Likewise, if you define the <code>&gt;</code> operator for your type, you must also define the <code>&lt;</code> operator, and vice versa. The same is true for <code>&gt;=</code> and <code>&lt;=</code>. (There’s one more pair, the <code>true</code> and <code>false</code> operators, but they’re slightly different; I’ll get to those shortly.)</p>
<p>When you overload an operator for which a compound assignment operator exists, you are in effect defining behavior for both. For example, if you define custom behavior for the <code>+</code> operator, the <code>+=</code> operator will automatically work too.</p>
<p>The <code>operator</code> keyword can also define custom conversions—methods that convert your type to or from some other type. For example, if we wanted to be able to convert <code>Counter</code> objects to and from <code>int</code>, we could add the two methods in <a data-type="xref" href="#conversion_operators">Example 3-106</a> to the class.</p>
<div data-type="example" id="conversion_operators">
<h5><span class="label">Example 3-106. </span>Conversion operators</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">static</code> <code class="k">explicit</code> <code class="k">operator</code> <code class="nf">int</code><code class="p">(</code><code class="n">Counter</code> <code class="k">value</code><code class="p">)</code>
<code class="p">{</code>
    <code class="k">return</code> <code class="k">value</code><code class="p">.</code><code class="n">_count</code><code class="p">;</code>
<code class="p">}</code>

<code class="k">public</code> <code class="k">static</code> <code class="k">explicit</code> <code class="k">operator</code> <code class="nf">Counter</code><code class="p">(</code><code class="kt">int</code> <code class="k">value</code><code class="p">)</code>
<code class="p">{</code>
    <code class="k">return</code> <code class="k">new</code> <code class="n">Counter</code> <code class="p">{</code> <code class="n">_count</code> <code class="p">=</code> <code class="k">value</code> <code class="p">};</code>
<code class="p">}</code></pre></div>
<p>I’ve used the <code>explicit</code> keyword here, which means that these conversions are accessed with the cast syntax, as <a data-type="xref" href="#using_explicit_conversion_operators">Example 3-107</a> shows.</p>
<div data-type="example" id="using_explicit_conversion_operators">
<h5><span class="label">Example 3-107. </span>Using explicit conversion operators</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">c</code> <code class="p">=</code> <code class="p">(</code><code class="n">Counter</code><code class="p">)</code> <code class="m">123</code><code class="p">;</code>
<code class="kt">var</code> <code class="n">v</code> <code class="p">=</code> <code class="p">(</code><code class="kt">int</code><code class="p">)</code> <code class="n">c</code><code class="p">;</code></pre></div>
<p><a data-primary="implicit conversions" data-secondary="operators" data-type="indexterm" id="idm45884827118016"/><a data-primary="conversions" data-secondary="explicit" data-type="indexterm" id="idm45884827116736"/>If you use the <code>implicit</code> keyword instead of <code>explicit</code>, your conversion will be able to happen without needing a cast. <a data-primary="conversions" data-secondary="implicit" data-type="indexterm" id="idm45884827067424"/>In <a data-type="xref" href="ch02.xhtml#ch_basic_coding">Chapter 2</a> we saw that some conversions happen implicitly: in certain situations, C# will automatically promote numeric types. For example, you can use an <code>int</code> where a <code>long</code> is expected, perhaps as an argument for a method or in an assignment. Conversion from <code>int</code> to <code>long</code> will always succeed and can never lose information, so the compiler will automatically generate code to perform the conversion without requiring an explicit cast. If you write <code>implicit</code> conversion operators, the C# compiler will silently use them in exactly the same way, enabling your custom type to be used in places where some other type was expected. (In fact, the C# specification defines numeric promotions such as conversion from <code>int</code> to <code>long</code> as built-in implicit conversions.)</p>
<p>Implicit conversion operators are something you shouldn’t need to write very often. You should do so only when you can meet the same standards as built-in 
<span class="keep-together">promotions:</span> the conversion must always be possible and should never throw an exception. Moreover, the conversion should be unsurprising—<code>implicit</code> conversions are a little sneaky in that they allow you to cause methods to be invoked in code that doesn’t look like it’s calling a method. So unless you’re intending to confuse other developers, you should write implicit conversions only where they seem to make unequivocal sense.</p>
<p><a data-primary="false operator" data-type="indexterm" id="idm45884827060352"/><a data-primary="true operator" data-type="indexterm" id="idm45884827059648"/>C# recognizes two more operators: <code>true</code> and <code>false</code>. If you define either of these, you are required to define both. These are a bit of an oddball pair, because although the C# specification defines them as unary operator overloads, they don’t correspond directly to any operator you can write in an expression. They come into play in two scenarios.</p>
<p>If you have not defined an implicit conversion to <code>bool</code>, but you have defined the <code>true</code> and <code>false</code> operators, C# will use the <code>true</code> operator if you use your type as the expression for an <code>if</code> statement or a <code>do</code> or <code>while</code> loop, or as the condition expression in a <code>for</code> loop. However, the compiler prefers the implicit <code>bool</code> operator, so this is not the main reason the <code>true</code> and <code>false</code> operators exist.</p>
<p>The main scenario for the <code>true</code> and <code>false</code> operators is to enable your custom type to be used as an operand of a conditional Boolean operator (either <code>&amp;&amp;</code> or <code>||</code>). Remember that these operators will evaluate their second operand only if the first outcome does not fully determine the result. If you want to customize the behavior of these operators, you cannot implement them directly. Instead, you must define the nonconditional versions of the operators (<code>&amp;</code> and <code>|</code>), and you must also define the <code>true</code> and <code>false</code> operators. When evaluating <code>&amp;&amp;</code>, C# will use your <code>false</code> operator on the first operand, and if that indicates that the first operand is false, then it will not bother to evaluate the second operand. If the first operand is not false, it will evaluate the second operand and then pass both into your custom <code>&amp;</code> operator. The <code>||</code> operator works in much the same way but with the <code>true</code> and <code>|</code> operators, respectively.</p>
<p>You may be wondering why we need special <code>true</code> and <code>false</code> operators—couldn’t we just define an implicit conversion to the <code>bool</code> type? In fact we can, and if we do that instead of providing <code>&amp;</code>, <code>|</code>, <code>true</code>, and <code>false</code>, C# will use that to implement <code>&amp;&amp;</code> and <code>||</code> for our type. However, some types may want to represent values that are neither true nor false—there may be a third value representing an unknown state. The <code>true</code> operator allows C# to ask the question “Is this definitely true?” and for the object to be able to answer “no” without implying that it’s definitely false. A conversion to <code>bool</code> does not support that.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The <code>true</code> and <code>false</code> operators have been present since the first version of C#, and their main application was to enable the implementation of types that support nullable Boolean values with similar semantics to those offered by many databases. The nullable type support added in C# 2.0 provides a better solution, so these operators are no longer particularly useful, but there are still some old parts of the runtime libraries that depend on them.</p>
</div>
<p>No other operators can be overloaded. For example, you cannot define custom meanings for the <code>.</code> operator used to access members of a method, or the conditional (<code>? :</code>) or null coalescing (<code>??</code>) operators.<a data-startref="ix_ch03-asciidoc51" data-type="indexterm" id="idm45884827013904"/><a data-startref="ix_ch03-asciidoc50" data-type="indexterm" id="idm45884827013168"/></p>
</div></section>
<section data-pdf-bookmark="Events" data-type="sect2"><div class="sect2" id="events">
<h2>Events</h2>
<p><a data-primary="classes" data-secondary="events and" data-type="indexterm" id="idm45884827011440"/><a data-primary="events" data-type="indexterm" id="idm45884827010464"/><a data-primary="members" data-secondary="events" data-type="indexterm" id="idm45884827009792"/><a data-primary="structs" data-secondary="events and" data-type="indexterm" id="idm45884827008848"/>Structs and classes can declare <em>events</em>. This kind of member enables a type to provide notifications when interesting things happen, using a subscription-based model. For example, a UI object representing a button might define a <code>Click</code> event, and you can write code that subscribes to that event.</p>
<p>Events depend on delegates, and since <a data-type="xref" href="ch09.xhtml#ch_delegates_lambdas_events">Chapter 9</a> is dedicated to these topics, I won’t go into any detail here. I’m mentioning them only because this section on type members would otherwise be incomplete.</p>
</div></section>
<section data-pdf-bookmark="Nested Types" data-type="sect2"><div class="sect2" id="nested_types">
<h2>Nested Types</h2>
<p><a data-primary="members" data-secondary="nested types" data-type="indexterm" id="idm45884827003712"/><a data-primary="nested types" data-type="indexterm" id="idm45884827002736"/><a data-primary="types" data-secondary="nested" data-type="indexterm" id="idm45884827002064"/>The final kind of member we can define in a class, a struct, or a record is a nested type. You can define nested classes, structs, or any of the other types described later in this chapter. A nested type can do anything its normal counterpart would do, but it gets a couple of additional features.</p>
<p>When a type is nested, you have more choices for accessibility. A type defined at global scope can be only <code>public</code> or <code>internal</code>—<code>private</code> would make no sense, because that makes something accessible only from within its containing type, and there is no containing type when you define something at global scope. But a nested type does have a containing type, so if you define a nested type and make it <code>private</code>, that type can be used only from inside the type within which it is nested. <a data-type="xref" href="#private_nested_class">Example 3-108</a> shows a private class.</p>
<div data-type="example" id="private_nested_class">
<h5><span class="label">Example 3-108. </span>A private nested class</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">internal</code><code> </code><code class="k">static</code><code> </code><code class="k">class</code><code> </code><code class="nc">FileSorter</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="k">static</code><code> </code><code class="kt">string</code><code class="p">[</code><code class="p">]</code><code> </code><code class="nf">GetByNameLength</code><code class="p">(</code><code class="kt">string</code><code> </code><code class="n">path</code><code class="p">)</code><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="kt">string</code><code class="p">[</code><code class="p">]</code><code> </code><code class="n">files</code><code> </code><code class="p">=</code><code> </code><code class="n">Directory</code><code class="p">.</code><code class="n">GetFiles</code><code class="p">(</code><code class="n">path</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="kt">var</code><code> </code><code class="n">comparer</code><code> </code><code class="p">=</code><code> </code><code class="k">new</code><code> </code><code class="n">LengthComparer</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="n">Array</code><code class="p">.</code><code class="n">Sort</code><code class="p">(</code><code class="n">files</code><code class="p">,</code><code> </code><code class="n">comparer</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">files</code><code class="p">;</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code>
</code><code>    </code><strong><code class="k">private</code><code> </code><code class="k">class</code><code> </code><code class="nc">LengthComparer</code><code> </code><code class="p">:</code><code> </code><code class="n">IComparer</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="k">public</code><code> </code><code class="kt">int</code><code> </code><code class="nf">Compare</code><code class="p">(</code><code class="kt">string?</code><code> </code><code class="n">x</code><code class="p">,</code><code> </code><code class="kt">string?</code><code> </code><code class="n">y</code><code class="p">)</code><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="kt">int</code><code> </code><code class="n">diff</code><code> </code><code class="p">=</code><code> </code><code class="p">(</code><code class="n">x</code><code class="p">?</code><code class="p">.</code><code class="n">Length</code><code> </code><code class="p">?</code><code class="p">?</code><code> </code><code class="m">0</code><code class="p">)</code><code> </code><code class="p">-</code><code> </code><code class="p">(</code><code class="n">y</code><code class="p">?</code><code class="p">.</code><code class="n">Length</code><code> </code><code class="p">?</code><code class="p">?</code><code> </code><code class="m">0</code><code class="p">)</code><code class="p">;</code><code>
</code><code>            </code><code class="k">return</code><code> </code><code class="n">diff</code><code> </code><code class="p">=</code><code class="p">=</code><code> </code><code class="m">0</code><code>
</code><code>                </code><code class="p">?</code><code> </code><code class="n">StringComparer</code><code class="p">.</code><code class="n">OrdinalIgnoreCase</code><code class="p">.</code><code class="n">Compare</code><code class="p">(</code><code class="n">x</code><code class="p">,</code><code> </code><code class="n">y</code><code class="p">)</code><code>
</code><code>                </code><code class="p">:</code><code> </code><code class="n">diff</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>    </code><code class="p">}</code></strong><code>
</code><code class="p">}</code></pre></div>
<p>Private classes can be useful in scenarios like this where you are using an API that requires an implementation of a particular interface, and either you don’t want to make that interface part of your type or, as in this case, you couldn’t even if you wanted to. (My <code>FileSorter</code> type is <code>static</code>, so I can’t create an instance of it to pass to <code>Array.Sort</code>.) In this case, I’m calling <code>Array.Sort</code> to sort a list of files by the lengths of their names. (This is not useful, but it looks nice.) I’m providing the custom sort order in the form of an object that implements the <code>IComparer&lt;string&gt;</code> interface. I’ll describe interfaces in detail in the next section, but this interface is just a description of what the <code>Array.Sort</code> method needs us to provide. I’ve written a custom class to implement this interface. This class is just an implementation detail of the rest of my code, so I don’t want to make it public. A nested private class is just what I need.</p>
<p>Code in a nested type is allowed to use nonpublic members of its containing type. However, an instance of a nested type does not automatically get a reference to an instance of its containing type. If you need nested instances to have a reference to their container, then you will need to declare a field to hold that and arrange for it to be initialized; this would work in exactly the same way as any object that wants to hold a reference to another object. Obviously, it’s an option only if the outer type is a reference type.<a data-startref="ix_ch03-asciidoc13" data-type="indexterm" id="idm45884826830032"/><a data-startref="ix_ch03-asciidoc12" data-type="indexterm" id="idm45884826829504"/></p>
<p>So far, we’ve looked only at classes, records, and structs, but there are some other ways to define custom types in C#. One of these is complicated enough to warrant getting its own chapter, but there are a couple of simpler ones that I’ll discuss here.</p>
</div></section>
</div></section>
<section data-pdf-bookmark="Interfaces" data-type="sect1"><div class="sect1" id="interfaces">
<h1>Interfaces</h1>
<p><a data-primary="interfaces" data-secondary="about" data-type="indexterm" id="ix_ch03-asciidoc52"/><a data-primary="types" data-secondary="interfaces" data-type="indexterm" id="ix_ch03-asciidoc53"/>C#’s <code>interface</code> keyword defines a programming interface. Interfaces are very often entirely devoid of implementation, although you can define default implementations for some or all methods. You can also define nested types and static fields. (Interfaces cannot define nonstatic fields, though.) Classes can choose to implement interfaces. If you write code that works in terms of an interface, it will be able to work with anything that implements that interface, instead of being limited to working with one particular type.</p>
<p>For example, the .NET runtime libraries include an interface called <code>IEnumerable&lt;T&gt;</code>, which defines a minimal set of members for representing sequences of values. (It’s a generic interface, so it can represent sequences of anything. For example, an <code>IE⁠num⁠era⁠ble​&lt;st⁠rin⁠g&gt;</code> is a sequence of strings. Generic types are discussed in <a data-type="xref" href="ch04.xhtml#ch_generics">Chapter 4</a>.) If a method has a parameter of type <code>IEnumerable&lt;string&gt;</code>, you can pass it a reference to an instance of any type that implements the interface, which means that a single method can work with arrays, various collection classes provided by the .NET runtime libraries, certain LINQ features, and many other things.</p>
<p>An interface declares methods, properties, and events, but it doesn’t have to define their bodies, as <a data-type="xref" href="#interface">Example 3-109</a> shows. Properties indicate whether getters and/or <span class="keep-together">setters</span> should be present, but we have semicolons in place of the bodies. An interface is effectively a list of the members that a type will need to provide if it wants to implement the interface. Be aware that on .NET Framework, these method-like members are the only kinds of members interfaces can have. I’ll discuss the additional member types available on .NET Core and .NET shortly, but the majority of interfaces you are likely to come across today only contain these kinds of members.</p>
<div data-type="example" id="interface">
<h5><span class="label">Example 3-109. </span>An interface</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">interface</code> <code class="n">IDoStuff</code>
<code class="p">{</code>
    <code class="kt">string</code> <code class="k">this</code><code class="p">[</code><code class="kt">int</code> <code class="n">i</code><code class="p">]</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
    <code class="kt">string</code> <code class="n">Name</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
    <code class="kt">int</code> <code class="n">Id</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="p">}</code>
    <code class="kt">int</code> <code class="nf">SomeMethod</code><code class="p">(</code><code class="kt">string</code> <code class="n">arg</code><code class="p">);</code>
    <code class="k">event</code> <code class="n">EventHandler</code><code class="p">?</code> <code class="n">Click</code><code class="p">;</code>
<code class="p">}</code></pre></div>
<p>Individual method-like members are not allowed accessibility modifiers—their accessibility is controlled at the level of the interface itself. (Like classes, interfaces are either <code>public</code> or <code>internal</code>, unless they are nested, in which case they can have any accessibility.) Interfaces cannot declare constructors—an interface only gets to say what services an object should supply once it has been constructed.</p>
<p>By the way, most interfaces in .NET follow the convention that their name starts with an uppercase <code>I</code> followed by one or more words in PascalCasing.</p>
<p>A class declares the interfaces that it implements in a list after a colon following the class name, as <a data-type="xref" href="#implementing_an_interface">Example 3-110</a> shows. It must provide implementations of all the members listed in the interface. You’ll get a compiler error if you leave any out. Record types can also implement interfaces, using a similar syntax. If the record type uses the positional syntax, the colon and interface list come after the positional parameter list.</p>
<div data-type="example" id="implementing_an_interface">
<h5><span class="label">Example 3-110. </span>Implementing an interface</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">class</code> <code class="nc">DoStuff</code> <code class="p">:</code> <code class="n">IDoStuff</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="k">this</code><code class="p">[</code><code class="kt">int</code> <code class="n">i</code><code class="p">]</code> <code class="p">{</code> <code class="k">get</code> <code class="p">{</code> <code class="k">return</code> <code class="n">i</code><code class="p">.</code><code class="n">ToString</code><code class="p">();</code> <code class="p">}</code> <code class="k">set</code> <code class="p">{</code> <code class="p">}</code> <code class="p">}</code>
    <code class="k">public</code> <code class="kt">string</code> <code class="n">Name</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="k">set</code><code class="p">;</code> <code class="p">}</code>
    <code class="p">...</code><code class="n">etc</code>
<code class="p">}</code></pre></div>
<p><a data-primary="public members" data-type="indexterm" id="idm45884826695216"/>When we implement an interface in C#, we typically define each of that interface’s methods as a public member of our class. However, sometimes you may want to avoid this. Occasionally, some API may require you to implement an interface that you feel pollutes the purity of your class’s API. Or, more prosaically, you may already have defined a member with the same name and signature as a member required by the interface, but that does something different from what the interface requires. Or worse, you may need to implement two different interfaces, both of which define members that have the same name and signature but require different behavior. <a data-primary="explicit implementation" data-type="indexterm" id="idm45884826672576"/>You can solve any of these problems with a technique called <em>explicit implementation</em> to define members that implement a member of a specific interface without being public. <a data-type="xref" href="#explicit_implementation_of_an_interface">Example 3-111</a> shows the syntax for this, with an implementation of one of the methods from the interface in <a data-type="xref" href="#interface">Example 3-109</a>. With explicit implementations, you do not specify the accessibility, and you prefix the member name with the interface name.</p>
<div data-type="example" id="explicit_implementation_of_an_interface">
<h5><span class="label">Example 3-111. </span>Explicit implementation of an interface member</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">int</code> <code class="n">IDoStuff</code><code class="p">.</code><code class="n">SomeMethod</code><code class="p">(</code><code class="kt">string</code> <code class="n">arg</code><code class="p">)</code>
<code class="p">{</code>
    <code class="p">...</code>
<code class="p">}</code></pre></div>
<p>When a type uses explicit interface implementation, those members cannot be used through a reference of the type itself. They become visible only when referring to an object through an expression of the interface’s type.</p>
<p>When a class implements an interface, it becomes implicitly convertible to that interface type. So you can pass any expression of type <code>DoStuff</code> from <a data-type="xref" href="#implementing_an_interface">Example 3-110</a> as a method argument of type <code>IDoStuff</code>, for example.</p>
<p>Interfaces are reference types. Despite this, you can implement interfaces on both classes and structs. However, you need to be careful when doing so with a struct, because when you get hold of an interface-typed reference to a struct, it will be a reference to a <em>box</em>, which is effectively an object that holds a copy of a struct in a way that can be referred to via a reference. We’ll look at boxing in <a data-type="xref" href="ch07.xhtml#ch_object_lifetime">Chapter 7</a>.</p>
<section data-pdf-bookmark="Default Interface Implementation" data-type="sect2"><div class="sect2" id="default_interface_implementation">
<h2>Default Interface Implementation</h2>
<p><a data-primary="default interface implementation" data-type="indexterm" id="ix_ch03-asciidoc54"/><a data-primary="interfaces" data-secondary="default implementation" data-type="indexterm" id="ix_ch03-asciidoc55"/>An interface definition can include some implementation details. This relatively new feature (added in C# 8.0) relies on runtime support, so it is only available in code that targets .NET Core 3.1 or later, or .NET Standard 2.1 or later, so you can’t use this on .NET Framework. But as long as you’re using a suitable runtime, your interface definition can supply static fields, nested types, and bodies for methods, property accessors, and the <code>add</code> and <code>remove</code> methods for events (which I will describe in <a data-type="xref" href="ch09.xhtml#ch_delegates_lambdas_events">Chapter 9</a>). <a data-type="xref" href="#interface_with_default_implementation">Example 3-112</a> shows this in use to define a default implementation of a property.</p>
<div data-type="example" id="interface_with_default_implementation">
<h5><span class="label">Example 3-112. </span>An interface with a default property implementation</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">interface</code> <code class="n">INamed</code>
<code class="p">{</code>
    <code class="kt">int</code> <code class="n">Id</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="p">}</code>
    <code class="kt">string</code> <code class="n">Name</code> <code class="p">=&gt;</code> <code class="err">$</code><code class="s">"{this.GetType()}: {this.Id}"</code><code class="p">;</code>
<code class="p">}</code></pre></div>
<p>If a class chooses to implement <code>INamed</code>, it will only be required to provide an implementation for this interface’s <code>Id</code> property. It can also supply a <code>Name</code> property if it wants to, but this is optional. If the class does not define its own <code>Name</code>, the definition from the interface will be used instead.</p>
<p>Default interface implementations provide a partial solution to a long-standing limitation of interfaces: if you define an interface that you then make available for other code to use (e.g., via a class library), adding new members to that interface could cause problems for existing code that uses it. Code that invokes methods on the interface won’t have a problem because it will be blissfully unaware that new members were added, but any class that implements your interface would, prior to C# 8.0, be broken if you were to add new members. A concrete class is required to supply all the members of an interface it implements, so if the interface gets new members, formerly complete implementations will now be incomplete. Unless you have some way of reaching out to everyone who has written types that implement your interface and getting them to add the missing members, you will cause them problems if they upgrade to the new version.</p>
<p>You might think that this would only be a problem if the authors of code that works with an interface deliberately upgraded to the library containing the updated interface, at which point they’d have an opportunity to fix the problem. However, library upgrades can sometimes be forced on code. If you write an application that uses multiple libraries, each of which was built against different versions of some common library, then at least one of those is going to end up getting a different version of that common library at runtime than the version it was compiled against. (The poster child for this is the Json.NET library for parsing JSON. It’s extremely widely used and has had many versions released, so it’s common for a single application to use multiple libraries, each with a dependency on a different version of Json.NET. Only one version is used at runtime, so they can’t all have their expectations met.) This means that even if you use schemes such as semantic versioning, in which breaking changes are always accompanied by a change to the component’s major version number, that might not be enough to avoid trouble: you might find yourself needing to use two components where one wants the v1.0 flavor of some interface, while another wants the v2.0 edition.</p>
<p>The upshot of this was that interfaces were essentially frozen: you couldn’t add new members over time, even across major version changes. But default interface implementations loosen this restriction: you can add a new member to an existing interface if you also provide a default implementation for it. That way, existing types that implemented the older version were able to supply a complete implementation of the updated definition, because they automatically pick up the default implementation of the newly added member without needing to be modified in any way. (There is a small fly in the ointment, making it still sometimes preferable to use the older solution to this problem, abstract base classes. <a data-type="xref" href="ch06.xhtml#ch_inheritance">Chapter 6</a> describes these issues. So although default interface implementation can provide a useful escape hatch, you should still avoid modifying published interfaces if at all possible.)</p>
<p>In addition to providing extra flexibility for backward compatibility, the default interface implementation feature adds three more capabilities: interfaces can now define constants, static fields, and types. <a data-type="xref" href="#interface_with_const_and_nested_type">Example 3-113</a> shows an interface that contains a nested constant and type.</p>
<div data-type="example" id="interface_with_const_and_nested_type">
<h5><span class="label">Example 3-113. </span>An interface with a <code>const</code> and a nested type</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">interface</code> <code class="n">IContainMultitudes</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">const</code> <code class="kt">string</code> <code class="n">TheMagicWord</code> <code class="p">=</code> <code class="s">"Please"</code><code class="p">;</code>

    <code class="k">public</code> <code class="k">enum</code> <code class="n">Outcome</code>
    <code class="p">{</code>
        <code class="n">Yes</code><code class="p">,</code>
        <code class="n">No</code>
    <code class="p">}</code>

    <code class="n">Outcome</code> <code class="nf">MayI</code><code class="p">(</code><code class="kt">string</code> <code class="n">request</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="n">request</code> <code class="p">==</code> <code class="n">TheMagicWord</code> <code class="p">?</code> <code class="n">Outcome</code><code class="p">.</code><code class="n">Yes</code> <code class="p">:</code> <code class="n">Outcome</code><code class="p">.</code><code class="n">No</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>With non-method-like members such as these, we need to specify the accessibility, because in some cases you may want to introduce these nested members purely for the benefit of default method implementations, in which case you’d want them to be <code>private</code>. In this case, I want the relevant members to be accessible to all, since they form part of the API defined by this interface, so I have marked them as <code>public</code>. You might be looking at that nested <code>Outcome</code> type and wondering what’s going on. Wonder no more<a data-startref="ix_ch03-asciidoc55" data-type="indexterm" id="idm45884826464512"/><a data-startref="ix_ch03-asciidoc54" data-type="indexterm" id="idm45884826463904"/>.<a data-startref="ix_ch03-asciidoc53" data-type="indexterm" id="idm45884826463168"/><a data-startref="ix_ch03-asciidoc52" data-type="indexterm" id="idm45884826462464"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Enums" data-type="sect1"><div class="sect1" id="enums">
<h1>Enums</h1>
<p><a data-primary="enums" data-type="indexterm" id="ix_ch03-asciidoc56"/><a data-primary="types" data-secondary="enums" data-type="indexterm" id="ix_ch03-asciidoc57"/>The <code>enum</code> keyword declares a very simple type that defines a set of named values. <a data-type="xref" href="#enum_with_mutually_exclusive_options">Example 3-114</a> shows an <code>enum</code> that defines a set of mutually exclusive choices. You could say that this <em>enumerates</em> the options, which is where the <code>enum</code> keyword gets its name.</p>
<div data-type="example" id="enum_with_mutually_exclusive_options">
<h5><span class="label">Example 3-114. </span>An <code>enum</code> with mutually exclusive options</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">enum</code> <code class="n">PorridgeTemperature</code>
<code class="p">{</code>
    <code class="n">TooHot</code><code class="p">,</code>
    <code class="n">TooCold</code><code class="p">,</code>
    <code class="n">JustRight</code>
<code class="p">}</code></pre></div>
<p>An <code>enum</code> can be used in most places you might use any other type—it could be the type of a local variable, a field, or a method parameter, for example. <a data-primary="switch statements" data-secondary="enums with" data-type="indexterm" id="idm45884826434112"/>But one of the most common ways to use an <code>enum</code> is in a <code>switch</code> statement, as <a data-type="xref" href="#switching_with_an_enum">Example 3-115</a> shows.</p>
<div data-type="example" id="switching_with_an_enum">
<h5><span class="label">Example 3-115. </span>Switching with an <code>enum</code></h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">switch</code> <code class="p">(</code><code class="n">porridge</code><code class="p">.</code><code class="n">Temperature</code><code class="p">)</code>
<code class="p">{</code>
<code class="k">case</code> <code class="n">PorridgeTemperature</code><code class="p">.</code><code class="n">TooHot</code><code class="p">:</code>
    <code class="n">GoOutsideForABit</code><code class="p">();</code>
    <code class="k">break</code><code class="p">;</code>

<code class="k">case</code> <code class="n">PorridgeTemperature</code><code class="p">.</code><code class="n">TooCold</code><code class="p">:</code>
    <code class="n">MicrowaveMyBreakfast</code><code class="p">();</code>
    <code class="k">break</code><code class="p">;</code>

<code class="k">case</code> <code class="n">PorridgeTemperature</code><code class="p">.</code><code class="n">JustRight</code><code class="p">:</code>
    <code class="n">NomNomNom</code><code class="p">();</code>
    <code class="k">break</code><code class="p">;</code>
<code class="p">}</code></pre></div>
<p>As this illustrates, to refer to enumeration members, you must qualify them with the type name. In fact, an <code>enum</code> is really just a fancy way of defining a load of <code>const</code> fields. The members are all just <code>int</code> values under the covers. You can even specify the values explicitly, as <a data-type="xref" href="#explicit_enum_values">Example 3-116</a> shows.</p>
<div data-type="example" id="explicit_enum_values">
<h5><span class="label">Example 3-116. </span>Explicit <code>enum</code> values</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="na">[System.Flags]</code>
<code class="k">public</code> <code class="k">enum</code> <code class="n">Ingredients</code>
<code class="p">{</code>
    <code class="n">Eggs</code>           <code class="p">=</code>        <code class="m">0</code><code class="n">b1</code><code class="p">,</code>
    <code class="n">Bacon</code>          <code class="p">=</code>       <code class="m">0</code><code class="n">b10</code><code class="p">,</code>
    <code class="n">Sausages</code>       <code class="p">=</code>      <code class="m">0</code><code class="n">b100</code><code class="p">,</code>
    <code class="n">Mushrooms</code>      <code class="p">=</code>     <code class="m">0</code><code class="n">b1000</code><code class="p">,</code>
    <code class="n">Tomato</code>         <code class="p">=</code>   <code class="m">0</code><code class="n">b1_0000</code><code class="p">,</code>
    <code class="n">BlackPudding</code>   <code class="p">=</code>  <code class="m">0</code><code class="n">b10_0000</code><code class="p">,</code>
    <code class="n">BakedBeans</code>     <code class="p">=</code> <code class="m">0</code><code class="n">b100_0000</code><code class="p">,</code>
    <code class="n">TheFullEnglish</code> <code class="p">=</code> <code class="m">0</code><code class="n">b111_1111</code>
<code class="p">}</code></pre></div>
<p>This example also shows an alternative way to use an <code>enum</code>. The options in <a data-type="xref" href="#explicit_enum_values">Example 3-116</a> are not mutually exclusive. I’ve used binary constants here, so you can see that each value corresponds to a particular bit position being set to 1. This makes it easy to combine them—<code>Eggs</code> and <code>Bacon</code> would be 3 (11 in binary), while <code>Eggs</code>, <code>Bacon</code>, <code>Sausages</code>, <code>BlackPudding</code>, and <code>BakedBeans</code> (my preferred combination) would be 103 (1100111 in binary, or 0x67 in hex).</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>When combining flag-based enumeration values, we normally use the bitwise OR operator. For example, you could write <code>Ing⁠red⁠ien⁠ts.​Eg⁠gs|⁠Ing⁠red⁠ien⁠ts.⁠Ba⁠con</code>. Not only is this significantly easier to read than using the numeric values, but it also works well with the search tools in IDEs—you can find all the places a particular symbol is used by right-clicking its definition and choosing Find All References or Go to References, respectively, from the context menu. You might come across code that uses <code>+</code> instead of <code>|</code>. This works for some combinations; however, <code>Ingredients.TheFullEnglish + Ingredients.Eggs</code> would be a value of 128, which does not correspond to anything, so it is safer to stick with <code>|</code>.</p>
</div>
<p><a data-primary="Flags attribute" data-type="indexterm" id="idm45884826258416"/>When you declare an <code>enum</code> that’s designed to be combined in this way, you’re supposed to annotate it with the <code>Flags</code> attribute, which is defined in the <code>System</code> namespace. (<a data-type="xref" href="ch14.xhtml#ch_attributes">Chapter 14</a> will describe attributes in detail.) <a data-type="xref" href="#explicit_enum_values">Example 3-116</a> does this, although in practice, it doesn’t matter greatly if you forget, because the C# compiler doesn’t care, and in fact, there are very few tools that pay any attention to it. <a data-primary="ToString method" data-type="indexterm" id="idm45884826254224"/>The main benefit is that if you call <code>ToString</code> on an <code>enum</code> value, it will notice when the <code>Flags</code> attribute is present. For this <code>Ingredients</code> type, <code>ToString</code> would convert the value of 3 to the string <code>Eggs, Bacon</code>, which is also how the debugger would show the value, whereas without the <code>Flags</code> attribute, it would be treated as an unrecognized value, and you would just get a string containing the digit <code>3</code>.</p>
<p>With this sort of flags-style enumeration, you can run out of bits fairly quickly. By default, <code>enum</code> uses <code>int</code> to represent the value, and with a sequence of mutually exclusive values, that’s usually sufficient. It would be a fairly complicated scenario that needed billions of different values in a single enumeration type. However, with 1 bit per flag, an <code>int</code> provides space for just 32 flags. Fortunately, you can get a little more breathing room, because you can specify a different underlying type—you can use any built-in integer type, meaning that you can go up to 64 bits. As <a data-type="xref" href="#six4-bit_enum">Example 3-117</a> shows, you can specify the underlying type after a colon following the <code>enum</code> type name.</p>
<div data-type="example" id="six4-bit_enum">
<h5><span class="label">Example 3-117. </span>64-bit <code>enum</code></h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="na">[Flags]</code>
<code class="k">public</code> <code class="k">enum</code> <code class="n">TooManyChoices</code> <code class="p">:</code> <code class="kt">long</code>
<code class="p">{</code>
    <code class="p">...</code>
<code class="p">}</code></pre></div>
<p>All <code>enum</code> types are value types, incidentally, like the built-in numeric types or any struct. But they are very limited. You cannot define any members other than the constant values—no methods or properties, for example.</p>
<p>Enumeration types can sometimes enhance the readability of code. A lot of APIs accept a <code>bool</code> to control some aspect of their behavior but might often have done better to use an <code>enum</code>. Consider the code in <a data-type="xref" href="#unhelpful_use_of_bool">Example 3-118</a>. It constructs a <code>StreamReader</code>, a class for working with data streams that contain text. The second constructor argument is a <code>bool</code>.</p>
<div data-type="example" id="unhelpful_use_of_bool">
<h5><span class="label">Example 3-118. </span>Unhelpful use of the <code>bool</code> type</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">using</code> <code class="nn">var</code> <code class="n">rdr</code> <code class="p">=</code> <code class="k">new</code> <code class="n">StreamReader</code><code class="p">(</code><code class="n">stream</code><code class="p">,</code> <code class="k">true</code><code class="p">);</code></pre></div>
<p>It’s not remotely obvious what that second argument does. If you happen to be familiar with <code>StreamReader</code>, you may know that this argument determines whether byte ordering in a multibyte text encoding should be set explicitly from the code or determined from a preamble at the start of the stream. (Using the named argument syntax would help here.) And if you’ve got a really good memory, you might even know which of those choices <code>true</code> happens to select. But most mere mortal 
<span class="keep-together">developers</span> will probably have to reach for IntelliSense or even the documentation to work out what that argument does. Compare that experience with <a data-type="xref" href="#clarity_with_an_enum">Example 3-119</a>, which shows a different type.</p>
<div data-type="example" id="clarity_with_an_enum">
<h5><span class="label">Example 3-119. </span>Clarity with an <code>enum</code></h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">using</code> <code class="nn">var</code> <code class="n">fs</code> <code class="p">=</code> <code class="k">new</code> <code class="n">FileStream</code><code class="p">(</code><code class="n">path</code><code class="p">,</code> <code class="n">FileMode</code><code class="p">.</code><code class="n">Append</code><code class="p">);</code></pre></div>
<p>This constructor’s second argument uses an enumeration type, which makes for rather less opaque code. It doesn’t take an eidetic memory to work out that this code intends to append data to an existing file.</p>
<p>As it happens, because this particular API has more than two options, it couldn’t use a <code>bool</code>. So <code>FileMode</code> really had to be an <code>enum</code>. But these examples illustrate that even in cases where you’re selecting between just two choices, it’s well worth considering defining an <code>enum</code> for the job so that it’s completely obvious which choice is being made when you look at the code.<a data-startref="ix_ch03-asciidoc57" data-type="indexterm" id="idm45884826153392"/><a data-startref="ix_ch03-asciidoc56" data-type="indexterm" id="idm45884826152688"/></p>
</div></section>
<section data-pdf-bookmark="Other Types" data-type="sect1"><div class="sect1" id="other_types">
<h1>Other Types</h1>
<p>We’re almost done with our survey of types and what goes in them. There’s one kind of type that I’ll not discuss until <a data-type="xref" href="ch09.xhtml#ch_delegates_lambdas_events">Chapter 9</a>: delegates. We use delegates when we need a reference to a function, but the details are somewhat involved.</p>
<p><a data-primary="pointers" data-type="indexterm" id="idm45884826149616"/>I’ve also not mentioned pointers. C# supports pointers that work in a pretty similar way to C-style pointers, complete with pointer arithmetic. (If you’re not familiar with these, they provide a reference to a particular location in memory.) These are a little weird, because they are slightly outside of the rest of the type system. For example, in <a data-type="xref" href="ch02.xhtml#ch_basic_coding">Chapter 2</a>, I mentioned that a variable of type <code>object</code> can refer to “almost anything.” The reason I had to qualify that is that pointers are one of the two exceptions—<code>object</code> can work with any C# data type except a pointer or a <code>ref struct</code>. (<a data-type="xref" href="ch18.xhtml#ch_memory_efficiency">Chapter 18</a> discusses the latter.)</p>
<p>But now we really are done. Some types in C# are special, including the fundamental types discussed in <a data-type="xref" href="ch02.xhtml#ch_basic_coding">Chapter 2</a> and the records, structs, interfaces, enums, delegates, and pointers just described, but everything else looks like a class. There are a few classes that get special handling in certain circumstances—notably attribute classes (<a data-type="xref" href="ch14.xhtml#ch_attributes">Chapter 14</a>) and exception classes (<a data-type="xref" href="ch08.xhtml#ch_exceptions">Chapter 8</a>)—but except for certain special scenarios, even those are otherwise completely normal classes. Even though we’ve seen all the kinds of types that C# supports, there’s one way to define a class that I’ve not shown yet.</p>
</div></section>
<section data-pdf-bookmark="Anonymous Types" data-type="sect1"><div class="sect1" id="anonymous_types">
<h1>Anonymous Types</h1>
<p><a data-primary="anonymous types" data-type="indexterm" id="ix_ch03-asciidoc58"/><a data-primary="types" data-secondary="anonymous" data-type="indexterm" id="ix_ch03-asciidoc59"/>C# offers two mechanisms for grouping a handful of values together. You’ve already seen tuples, which were described in <a data-type="xref" href="ch02.xhtml#ch_basic_coding">Chapter 2</a>. These were introduced in C# 7.0, but there is an alternative that has been available since C# 3.0: <a data-type="xref" href="#anonymous_type">Example 3-120</a> shows how to create an instance of an <em>anonymous type</em> and how to use it.</p>
<div data-type="example" id="anonymous_type">
<h5><span class="label">Example 3-120. </span>An anonymous type</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">x</code> <code class="p">=</code> <code class="k">new</code> <code class="p">{</code> <code class="n">Title</code> <code class="p">=</code> <code class="s">"Lord"</code><code class="p">,</code> <code class="n">Surname</code> <code class="p">=</code> <code class="s">"Voldemort"</code> <code class="p">};</code>

<code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"Welcome, {x.Title} {x.Surname}"</code><code class="p">);</code></pre></div>
<p>As you can see, we use the <code>new</code> keyword without specifying a type name. Instead, we just use the object initializer syntax. The C# compiler will provide a type that has one read-only property for each entry inside the initializer. So in <a data-type="xref" href="#anonymous_type">Example 3-120</a>, the variable <code>x</code> will refer to an object that has two properties, <code>Title</code> and <code>Surname</code>, both of type <code>string</code>. (You do not state the property types explicitly in an anonymous type. The compiler infers each property’s type from the initialization expression in the same way it does for the <code>var</code> keyword.) Since these are just normal properties, we can access them with the usual syntax, as the final line of the example shows.</p>
<div data-type="tip"><h6>Tip</h6>
<p>The <code>with</code> syntax available for record types and <code>struct</code> types also works with anonymous types. The reason <code>with</code> is not available for all reference types is the lack of a general, universal cloning mechanism, but that’s not a problem with anonymous types. They are always generated by the compiler, so the compiler knows exactly how to copy them.</p>
</div>
<p>The compiler generates a fairly ordinary class definition for each anonymous type. It is immutable, because all the properties are read-only. Much like a record, it overrides <code>Equals</code> so that you can compare instances by value, and it also provides a matching <code>GetHashCode</code> implementation. The only unusual thing about the generated class is that it’s not possible to refer to the type by name in C#. Running <a data-type="xref" href="#anonymous_type">Example 3-120</a> in the debugger, I find that the compiler has chosen the name <code>&lt;&gt;f__AnonymousType0'2</code>. <a data-primary="unspeakable names" data-type="indexterm" id="idm45884826083152"/>This is not a legal identifier in C# because of those angle brackets (<code>&lt;&gt;</code>) at the start. C# uses names like this whenever it wants to create something that is guaranteed not to collide with any identifiers you might use in your own code, or that it wants to prevent you from using directly. This sort of identifier is called, rather magnificently, an <em>unspeakable name</em>.</p>
<p>Because you cannot write the name of an anonymous type, a method cannot declare that it returns one, or that it requires one to be passed as an argument (unless you use an anonymous type as an inferred generic type argument, something we’ll see in <a data-type="xref" href="ch04.xhtml#ch_generics">Chapter 4</a>). Of course, an expression of type <code>object</code> can refer to an instance of an anonymous type, but only the method that defines the type can use its properties (unless you use the <code>dynamic</code> type described in <a data-type="xref" href="ch02.xhtml#ch_basic_coding">Chapter 2</a>). So anonymous types are of somewhat limited value. They were added to the language for LINQ’s benefit: they enable a query to select specific columns or properties from some source collection and also to define custom grouping criteria, as you’ll see in <a data-type="xref" href="ch10.xhtml#ch_linq">Chapter 10</a>.</p>
<p><a data-primary="tuples" data-type="indexterm" id="idm45884826077216"/>These limitations provide a clue as to why Microsoft felt the need to add tuples in C# 7.0 when the language already had a pretty similar-looking feature. However, if the inability to use anonymous types as parameters or return types was the only problem, an obvious solution might have been to introduce a syntax enabling them to be identified. The syntax for referring to tuples could arguably have worked—we can now write <code>(string Name, double Age)</code> to refer to a tuple type, but why introduce a whole new concept? Why not just use that syntax to name anonymous types? (Obviously we’d no longer be able to call them anonymous types, but at least we wouldn’t have ended up with two confusingly similar language features.) However, the lack of names isn’t the only problem with anonymous types.</p>
<p>As C# has been used in increasingly diverse applications, and across a broader range of hardware, efficiency has become more of a concern. In the database access <span class="keep-together">scenarios</span> for which anonymous types were originally introduced, the cost of object allocations would have been a relatively small part of the picture, but the basic concept—a small bundle of values—is potentially useful in a much wider range of scenarios, some of which are more performance sensitive. However, anonymous types are all reference types, and while in many cases that’s not a problem, it can rule them out in some hyper-performance-sensitive scenarios. Tuples, on the other hand, are all value types, making them viable even in code where you are attempting to minimize the number of allocations. (See <a data-type="xref" href="ch07.xhtml#ch_object_lifetime">Chapter 7</a> for more detail on memory management and garbage collection, and <a data-type="xref" href="ch18.xhtml#ch_memory_efficiency">Chapter 18</a> for information about some of the newer language features aimed at enabling more efficient memory usage.) Also, since tuples are all based on a set of generic types under the covers, they may end up reducing the runtime overhead required to keep track of loaded types: with anonymous types, you can end up with a lot more distinct types loaded. For related reasons, anonymous types would have problems with compatibility across component boundaries.</p>
<p>Does this mean that anonymous types are no longer of any use? In fact, they still offer some advantages. The most significant one is that you cannot use a tuple in a lambda expression that will be converted into an expression tree. This issue is described in detail in <a data-type="xref" href="ch09.xhtml#ch_delegates_lambdas_events">Chapter 9</a>, but the practical upshot is that you cannot use tuples in the kinds of LINQ queries mentioned earlier that anonymous types were added to support.</p>
<p><a data-primary="anonymous types" data-secondary="tuples versus" data-type="indexterm" id="idm45884826043376"/><a data-primary="tuples" data-secondary="anonymous types versus" data-type="indexterm" id="idm45884826042528"/>More subtle is the fact that with tuples, property names are a convenient fiction, whereas with anonymous types, they are real. This has two upshots. One regards equivalence: the tuples <code>(X: 10, Y:20)</code> and <code>(W:10, H:20)</code> are considered interchangeable, where any variable capable of holding one is capable of holding the other. That is not true for anonymous types: <code>new { X = 10, Y = 20 }</code> has a different type than <code>new { W = 10, H = 20 }</code>, and attempting to pass one to code that expects the other will cause a compiler error. This difference can make tuples more convenient, but it can also make them more error prone, because the compiler looks only at the shape of the data when asking whether you’re using the right type. Anonymous types can still enable errors: if you have two types with exactly the same property names and types but that are semantically different, there’s no way to express that with anonymous types. (In practice you’d probably just define two record types to deal with this.) The second upshot of anonymous types offering genuine properties is that you can pass them to code that inspects an object’s properties. Many reflection-driven features such as certain serialization frameworks, or UI framework databinding, depend on being able to discover properties at runtime through reflection (see <a data-type="xref" href="ch13.xhtml#ch_reflection">Chapter 13</a>). Anonymous types may work better with these frameworks than tuples, in which the properties’ real names are all things like <code>Item1</code>, <code>Item2</code>, etc.<a data-startref="ix_ch03-asciidoc59" data-type="indexterm" id="idm45884826038256"/><a data-startref="ix_ch03-asciidoc58" data-type="indexterm" id="idm45884826037520"/></p>
</div></section>
<section data-pdf-bookmark="Partial Types and Methods" data-type="sect1"><div class="sect1" id="partial_types_and_methods">
<h1>Partial Types and Methods</h1>
<p><a data-primary="partial type declaration" data-type="indexterm" id="idm45884826035488"/><a data-primary="types" data-secondary="partial types and methods" data-type="indexterm" id="idm45884826034880"/>There’s one last topic I want to discuss relating to types. C# supports what it calls a <em>partial type declaration</em>. This is a very simple concept: it means that the type declaration might span multiple files. If you add the <code>partial</code> keyword to a type declaration, C# will not complain if another file defines the same type—it will simply act as though all the members defined by the two files had appeared in a single declaration in one file.</p>
<p>This feature exists to make it easier to write code-generation tools. Various features in Visual Studio can generate bits of your class for you. This is particularly common with UIs. UI applications typically have markup that defines the layout and content of each part of the UI, and you can choose for certain UI elements to be accessible in your code. You usually achieve this by adding a field to a class associated with the markup file. To keep things simple, all the parts of the class that Visual Studio generates go in a separate file from the parts that you write. This means that the generated parts can be remade from scratch whenever needed without any risk of overwriting the code that you’ve written. Before partial types were introduced to C#, all the code for a class had to go in one file, and from time to time, code generation tools would get confused, leading to loss of code.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Partial classes are not limited to code-generation scenarios, so you can of course use this to split your own class definitions across multiple files. However, if you’ve written a class so large and complex that you feel the need to split it into multiple source files just to keep it manageable, that’s probably a sign that the class is too complex. A better response to this problem might be to change your design. However, it can be useful if you need to maintain code that is built in different ways for different target platforms: you can use partial classes to put target-specific parts in separate files.</p>
</div>
<p><a data-primary="partial methods" data-type="indexterm" id="idm45884826031024"/><a data-primary="methods" data-secondary="partial" data-type="indexterm" id="idm45884826030416"/>Partial methods are also designed for code-generation scenarios, but they are slightly more complex. They allow one file, typically a generated file, to declare a method, and for another file to implement the method. (Strictly speaking, the declaration and implementation are allowed to be in the same file, but they usually won’t be.) This may sound like the relationship between an interface and a class that implements that interface, but it’s not quite the same. With partial methods, the declaration and implementation are in the same class—they’re in different files only because the class has been split across multiple files.</p>
<p>If you do not provide an implementation of a partial method, then as long as the method definition does not specify any accessibility, has a <code>void</code> return type, and no <code>out</code> arguments, the compiler acts as though the method isn’t there at all, and any code that invokes the method is ignored at compile time. The main reason for this is to support code-generation mechanisms that are able to offer many kinds of notifications but where you want zero runtime overhead for notifications that you don’t need. Partial methods enable this by letting the code generator declare a partial method for each kind of notification it provides and to generate code that invokes all of these partial methods where necessary. All code relating to notifications for which you do not write a handler method will be stripped out at compile time.</p>
<p>It’s an idiosyncratic mechanism, but it was driven by frameworks that provide extremely fine-grained notifications and extension points. There are some more obvious runtime techniques you could use instead, such as interfaces, or features that I’ll cover in later chapters, such as callbacks or virtual methods. However, any of these would impose a relatively high cost for unused features. Unused partial methods get stripped out at compile time, reducing the cost of the bits you don’t use to nothing, which is a considerable improvement.</p>
<p><a data-primary="C# 9.0" data-primary-sortas="C# 09" data-secondary="partial methods" data-type="indexterm" id="idm45884826027328"/>Up until recently, partial methods were required not to specify their accessibility and not return any data. C# 9.0 relaxed this to support additional code-generation scenarios, in which a developer writes a partial method in the expectation that a code-generation tool will supply the implementation. When a partial method specifies the accessibility (even if it is <code>private</code> and returns no data), it is an error for the method not to be implemented.</p>
</div></section>
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="summary-id00007">
<h1>Summary</h1>
<p>You’ve now seen most of the kinds of types you can write in C# and the sorts of members they support. Classes are the most widely used, but structs are useful if you need value-like semantics for assignment and arguments; both support the same member types—namely, fields, constructors, methods, properties, indexers, events, custom operators, and nested types. Records provide a more convenient syntax for defining types that consist mostly of properties, especially if you want to be able to compare the values of such types. And while they do not have to be immutable, record types make it easier to define and work with immutable data. Interfaces are abstract, so at the instance level they support only methods, properties, indexers, and events. They can also provide static fields, nested types, and default implementations for other members. And enums are very limited, providing just a set of known values.<a data-startref="ix_ch03-asciidoc0" data-type="indexterm" id="idm45884826023840"/></p>
<p>There’s another feature of the C# type system that makes it possible to write very flexible types, called generic types. We’ll look at these in the next chapter.</p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="idm45884853473568"><sup><a href="ch03.xhtml#idm45884853473568-marker">1</a></sup> Specifically, it generates a method with a special name, <code>&lt;Clone&gt;$</code>. That name is an illegal identifier in C#, so this method is in effect hidden from your code, but you will be using it indirectly if you use the <code>with</code> syntax to build a modified copy of a record.</p><p data-type="footnote" id="idm45884832593360"><sup><a href="ch03.xhtml#idm45884832593360-marker">2</a></sup> There are certain exceptions, described in <a data-type="xref" href="ch18.xhtml#ch_memory_efficiency">Chapter 18</a>.</p><p data-type="footnote" id="fn19"><sup><a href="ch03.xhtml#fn19-marker">3</a></sup> You wouldn’t want it to be a value type, because strings can be large, so passing them by value would be expensive. In any case, it cannot be a struct, because strings vary in length. However, that’s not a factor you need to consider, because you can’t write your own variable-length data types in C#. Only strings and array types have variable size.</p><p data-type="footnote" id="idm45884832211984"><sup><a href="ch03.xhtml#idm45884832211984-marker">4</a></sup> If you omit the initializer for a <code>readonly</code> field, you should set it in the constructor or a property’s <code>init</code> accessor instead; otherwise it’s not very useful.</p><p data-type="footnote" id="fn20"><sup><a href="ch03.xhtml#fn20-marker">5</a></sup> There are two exceptions. If a class supports a CLR feature called <em>serialization</em>, objects of that type can be deserialized directly from a data stream, bypassing constructors. But even here, you can dictate what data is required. And there’s the <code>MemberwiseClone</code> method described in <a data-type="xref" href="ch06.xhtml#ch_inheritance">Chapter 6</a>.</p><p data-type="footnote" id="idm45884830549600"><sup><a href="ch03.xhtml#idm45884830549600-marker">6</a></sup> The CLR calls this kind of reference a <em>Managed Pointer</em>, to distinguish it from the kind of reference that refers to an object on the heap. Unfortunately, C#’s terminology is less clear: it calls both of these things <em>references</em>.</p><p data-type="footnote" id="idm45884827660912"><sup><a href="ch03.xhtml#idm45884827660912-marker">7</a></sup> Incidentally, the default property has a name, because all properties are required to. C# calls the indexer property <code>Item</code> and automatically adds the annotation indicating that it’s the default property. You won’t normally refer to an indexer by name, but the name is visible in some tools. The .NET documentation lists indexers under <code>Item</code>, even though it’s rare to use that name in code.</p></div></div></section></div></body></html>