<html><head></head><body><section data-pdf-bookmark="Chapter 6. Exemplifying Real-Time Web Functionality" data-type="chapter" epub:type="chapter"><div class="chapter" id="chapter-six">
<h1><span class="label">Chapter 6. </span>Exemplifying Real-Time Web Functionality</h1>


<p>No web user wants to hit refresh constantly for the latest information. They want everything right now, automatically. Real-time web functionality is very common, and most modern apps require it. Many apps rely on live data to provide pertinent information to their users as soon as it becomes available. In this chapter, you’ll learn how to implement real-time web functionality using ASP.NET Core SignalR (or just SignalR). You’ll <a data-primary="SignalR" data-type="indexterm" id="idm46365016863904"/><a data-primary="ASP.NET Core SignalR" data-see="SignalR" data-type="indexterm" id="idm46365016863200"/>then find out how to create a server-side (<code>Hub</code>) that will expose many live data points, such as real-time alerts and notifications, a messaging system for live-user interactions, and a joinable active Twitter stream. Finally, you’ll learn how to consume this data from our Blazor WebAssembly app, which will respond to and interact with these live data points in compelling ways.</p>






<section data-pdf-bookmark="Defining the Server-Side Events" data-type="sect1"><div class="sect1" id="idm46365016861552">
<h1>Defining the Server-Side Events</h1>

<p>For your Blazor app to have real-time web functionalities, you need a way for it to receive live data. That’s where SignalR comes in. Real-time browser-to-server protocols such as WebSockets or Server-Side Events can be complex to implement. SignalR provides an <a data-primary="events" data-secondary="server-side" data-type="indexterm" id="vtvd"/><a data-primary="server-side events" data-type="indexterm" id="svsvt"/><a data-primary="SignalR" data-secondary="server-side events" data-type="indexterm" id="sgrvd"/>abstraction layer over these protocols and reduces the complexity with a succinct API. To handle the many clients to a single server, SignalR introduces the hub as a proxy between the clients and the server. In a hub, you define methods that can be called directly from clients. Likewise, the server can call methods on any of the connected clients. With a hub, you can define methods from the client to the server or server to the client—this is a two-way (duplex) communication. There is also a cloud-ready implementation of SignalR, called <a href="https://oreil.ly/C8Vae">Azure SignalR Service</a>. This service removes the need to manage backplanes that handle scalability and client connectivity.</p>

<p>The point of doing this is to allow your app to have real-time alerts, a messaging system for live-user interactions, and a joinable active Twitter stream. SignalR makes all of this possible.</p>

<p>This concept of one machine calling <a data-primary="RPC (remote procedure call)" data-type="indexterm" id="idm46365016782560"/><a data-primary="remote procedure call" data-see="RPC" data-type="indexterm" id="idm46365016781888"/>into another is known as a <em>remote procedure call</em> (RPC). All communication to the server requires an authentication token. Without a valid authentication token, the connection will not be established or maintained. With a valid token, the communication between the Web.Client app and the HTTP endpoints that it relies on is going to establish an open line where messages can be sent and received unsolicited from either process over network boundaries in real time. The optimal scenario is when both processes negotiate and agree upon the usage of WebSockets as the communication transport.</p>








<section data-pdf-bookmark="Exposing Twitter Streams and Chat Functionality" data-type="sect2"><div class="sect2" id="idm46365016780304">
<h2>Exposing Twitter Streams and Chat Functionality</h2>

<p>The following examples highlight a <a data-primary="SignalR" data-secondary="Twitter streams" data-type="indexterm" id="idm46365016778064"/><a data-primary="SignalR" data-secondary="chats" data-type="indexterm" id="idm46365016777088"/><a data-primary="Twitter" data-secondary="SignalR" data-type="indexterm" id="idm46365016776144"/><a data-primary="chat" data-secondary="SignalR" data-type="indexterm" id="idm46365016775200"/><a data-primary="Learning Blazor app" data-secondary="Twitter streams" data-type="indexterm" id="idm46365016774256"/><a data-primary="Blazor WebAssembly" data-secondary="Twitter streams" data-type="indexterm" id="idm46365016773312"/><a data-primary="Blazor WebAssembly" data-secondary="chats" data-type="indexterm" id="idm46365016772368"/><a data-primary="Learning Blazor app" data-secondary="chats" data-type="indexterm" id="idm46365016771424"/>live stream of tweets and a presence-aware chat implementation, as shown in Figures <a data-type="xref" data-xrefstyle="select:labelnumber" href="#tweets-page">6-1</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="#chat-page-welcome">6-2</a>.</p>

<figure><div class="figure" id="tweets-page">
<img alt="" src="assets/lblz_0601.png"/>
<h6><span class="label">Figure 6-1. </span><code>Tweets</code> page rendering</h6>
</div></figure>

<figure><div class="figure" id="chat-page-welcome">
<img alt="" src="assets/lblz_0602.png"/>
<h6><span class="label">Figure 6-2. </span><code>Chat</code> page rendering</h6>
</div></figure>

<p>The Learning Blazor model app makes use of a single notification hub that manages all of the real-time functionality. In the model app, the Web.Api project contains the SignalR hub <a data-primary="SignalR" data-secondary="hub definition" data-type="indexterm" id="idm46365016762768"/>definition. It defines a single <code>NotificationHub</code> class, but there are three files in total. Each of these files represents a <code>partial</code> implementation of <a data-primary="NotificationHub object" data-type="indexterm" id="idm46365016760864"/><a data-primary="NotificationHub.cs" data-type="indexterm" id="nfhbc"/>the <code>NotificationHub</code> object. The domain-specific segments are encapsulated within their file, for example, the <em>NotificationHub.Chat.cs</em> and <em>NotificationHub.Tweets.cs</em>. Let’s examine the <em>NotificationHub.cs</em> C# file first:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code><code> </code><code class="nn">Learning.Blazor.Api.Hubs</code><code class="p">;</code><code>
</code><code class="na">
[Authorize, RequiredScope(new[]</code><code> </code><code class="p">{</code><code> </code><code class="s">"User.ApiAccess"</code><code> </code><code class="p">}</code><code class="p">)</code><code class="p">]</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO1-1" id="co_exemplifying_real_time_web_functionality_CO1-1"><img alt="1" src="assets/1.png"/></a><code>
</code><code class="k">public</code><code> </code><code class="k">partial</code><code> </code><code class="k">class</code><code> </code><code class="nc">NotificationHub</code><code> </code><code class="p">:</code><code> </code><code class="n">Hub</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">private</code><code> </code><code class="k">readonly</code><code> </code><code class="n">ITwitterService</code><code> </code><code class="n">_twitterService</code><code class="p">;</code><code>
</code><code>    </code><code class="k">private</code><code> </code><code class="k">readonly</code><code> </code><code class="n">IStringLocalizer</code><code class="p">&lt;</code><code class="n">Shared</code><code class="p">&gt;</code><code> </code><code class="n">_localizer</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">private</code><code> </code><code class="kt">string</code><code> </code><code class="n">_userName</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">Context</code><code class="p">.</code><code class="n">User</code><code class="p">?</code><code class="p">.</code><code class="n">Identity</code><code class="p">?</code><code class="p">.</code><code class="n">Name</code><code> </code><code class="p">?</code><code class="p">?</code><code> </code><code class="s">"Unknown"</code><code class="p">;</code><code>
</code><code>    </code><code class="k">private</code><code> </code><code class="kt">string</code><code class="p">[</code><code class="p">]</code><code class="p">?</code><code> </code><code class="n">_userEmail</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">Context</code><code class="p">.</code><code class="n">User</code><code class="p">?</code><code class="p">.</code><code class="n">GetEmailAddresses</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="nf">NotificationHub</code><code class="p">(</code><code>
</code><code>        </code><code class="n">ITwitterService</code><code> </code><code class="n">twitterService</code><code class="p">,</code><code>
</code><code>        </code><code class="n">IStringLocalizer</code><code class="p">&lt;</code><code class="n">Shared</code><code class="p">&gt;</code><code> </code><code class="n">localizer</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="p">(</code><code class="n">_twitterService</code><code class="p">,</code><code> </code><code class="n">_localizer</code><code class="p">)</code><code> </code><code class="p">=</code><code> </code><code class="p">(</code><code class="n">twitterService</code><code class="p">,</code><code> </code><code class="n">localizer</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="k">override</code><code> </code><code class="n">Task</code><code> </code><code class="nf">OnConnectedAsync</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO1-2" id="co_exemplifying_real_time_web_functionality_CO1-2"><img alt="2" src="assets/2.png"/></a><code>
</code><code>        </code><code class="n">Clients</code><code class="p">.</code><code class="n">All</code><code class="p">.</code><code class="n">SendAsync</code><code class="p">(</code><code>
</code><code>            </code><code class="n">HubServerEventNames</code><code class="p">.</code><code class="n">UserLoggedIn</code><code class="p">,</code><code>
</code><code>            </code><code class="n">Notification</code><code class="p">&lt;</code><code class="n">Actor</code><code class="p">&gt;</code><code class="p">.</code><code class="n">FromAlert</code><code class="p">(</code><code>
</code><code>                </code><code class="k">new</code><code class="p">(</code><code class="n">UserName</code><code class="p">:</code><code> </code><code class="n">_userName</code><code class="p">,</code><code>
</code><code>                    </code><code class="n">Emails</code><code class="p">:</code><code> </code><code class="n">_userEmail</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="k">override</code><code> </code><code class="n">Task</code><code> </code><code class="nf">OnDisconnectedAsync</code><code class="p">(</code><code class="n">Exception</code><code class="p">?</code><code> </code><code class="n">ex</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO1-3" id="co_exemplifying_real_time_web_functionality_CO1-3"><img alt="3" src="assets/3.png"/></a><code>
</code><code>        </code><code class="n">Clients</code><code class="p">.</code><code class="n">All</code><code class="p">.</code><code class="n">SendAsync</code><code class="p">(</code><code>
</code><code>            </code><code class="n">HubServerEventNames</code><code class="p">.</code><code class="n">UserLoggedOut</code><code class="p">,</code><code>
</code><code>            </code><code class="n">Notification</code><code class="p">&lt;</code><code class="n">Actor</code><code class="p">&gt;</code><code class="p">.</code><code class="n">FromAlert</code><code class="p">(</code><code>
</code><code>                </code><code class="k">new</code><code class="p">(</code><code class="n">UserName</code><code class="p">:</code><code> </code><code class="n">_userName</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist pagebreak-before less_space">
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO1-1" id="callout_exemplifying_real_time_web_functionality_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p><code>NotificationHub</code> is protected by the apps Azure AD B2C tenant.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO1-2" id="callout_exemplifying_real_time_web_functionality_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>override Task OnConnectedAsync</code> method is implemented as an expression that sends an event <code>HubServerEventNames.UserLoggedIn</code> to all the connected clients.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO1-3" id="callout_exemplifying_real_time_web_functionality_CO1-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>override Task OnDisconnectedAsync</code> method expects an error.</p></dd>
</dl>

<p>A valid authentication token must be <a data-primary="authentication" data-secondary="tokens" data-type="indexterm" id="idm46365016740112"/>provided from one of the configured third-party authentication providers, and the claims of the request must be a part of the <code>"User.ApiAccess"</code> scope. <code>NotificationHub</code> is a <a data-primary="Hub class" data-type="indexterm" id="idm46365016738208"/>descendant of the framework-provided <code>Hub</code> class. This is a requirement for a SignalR server: they must expose a hub endpoint. The primary functionality in this file is the constructor (<code>.ctor</code>) definition and the overrides for handling connection and disconnection events. The other hub partials are domain-specific. This class defines several fields:</p>
<dl>
<dt><code>ITwitterService _twitterService</code></dt>
<dd>
<p>This service relies on the <a href="https://oreil.ly/wcZVs"><code>TweetInvi</code> NuGet package</a>. It manages streaming Twitter APIs and <a data-primary="ITwitterService" data-type="indexterm" id="idm46365016447152"/>streams filtered on specific hashtags and handles.</p>
</dd>
<dt><code>IStringLocalizer&lt;Shared&gt; _localizer</code></dt>
<dd>
<p>The <code>Shared</code> class contains resources <a data-primary="Shared class" data-type="indexterm" id="idm46365016444336"/>for the <code>NotificationHub</code> that are localized. Certain generic messages are translated for the alert and notification system.</p>
</dd>
<dt><code>string _userName</code></dt>
<dd>
<p>The hub has a single user in context. This user is the representation of the deserialized tokens from the authentication connection—in other words, the user who is currently interacting with the hub.</p>
</dd>
<dt><code>string[]? _userEmail</code></dt>
<dd>
<p>The hub’s user also has one or more email addresses.</p>
</dd>
</dl>

<p>The event is a <code>Notification&lt;Actor&gt;</code>. The generic <a data-primary="NotificationHub.cs" data-startref="nfhbc" data-type="indexterm" id="idm46365016434656"/>notification object is a <code>record class</code> with a user name and an <a data-primary="notification object" data-type="indexterm" id="idm46365016433136"/>array of email addresses. These events are somewhat generic, so they can be shared by different interested parties on the client. There are some additional features the model app requires to provide a feature-rich chat room experience. You’ll learn a nice clean way to implement the “user is typing” indicator, create and share custom rooms, edit sent messages, and so on in this chapter. These same features can be reused in your Blazor apps by using similar code. Let’s explore the <em>NotificationHub.Chat.cs</em> C# file as it shows <a data-primary="NotificationHub.Chat.cs" data-type="indexterm" id="nfthc"/>the hub’s implementation of the chat functionality:</p>

<pre class="pagebreak-before" data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code><code> </code><code class="nn">Learning.Blazor.Api.Hubs</code><code class="p">;</code><code>
</code><code>
</code><code class="k">public</code><code> </code><code class="k">partial</code><code> </code><code class="k">class</code><code> </code><code class="nc">NotificationHub</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="n">Task</code><code> </code><code class="nf">ToggleUserTyping</code><code class="p">(</code><code class="kt">bool</code><code> </code><code class="n">isTyping</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO2-1" id="co_exemplifying_real_time_web_functionality_CO2-1"><img alt="1" src="assets/1.png"/></a><code>
</code><code>        </code><code class="n">Clients</code><code class="p">.</code><code class="n">Others</code><code class="p">.</code><code class="n">SendAsync</code><code class="p">(</code><code>
</code><code>            </code><code class="n">HubServerEventNames</code><code class="p">.</code><code class="n">UserTyping</code><code class="p">,</code><code>
</code><code>            </code><code class="n">Notification</code><code class="p">&lt;</code><code class="n">ActorAction</code><code class="p">&gt;</code><code class="p">.</code><code class="n">FromAlert</code><code class="p">(</code><code>
</code><code>                </code><code class="k">new</code><code class="p">(</code><code class="n">UserName</code><code class="p">:</code><code> </code><code class="n">_userName</code><code> </code><code class="p">?</code><code class="p">?</code><code> </code><code class="s">"Unknown"</code><code class="p">,</code><code>
</code><code>                    </code><code class="n">IsTyping</code><code class="p">:</code><code> </code><code class="n">isTyping</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="n">Task</code><code> </code><code class="nf">PostOrUpdateMessage</code><code class="p">(</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO2-2" id="co_exemplifying_real_time_web_functionality_CO2-2"><img alt="2" src="assets/2.png"/></a><code>
</code><code>        </code><code class="kt">string</code><code> </code><code class="n">room</code><code class="p">,</code><code> </code><code class="kt">string</code><code> </code><code class="n">message</code><code class="p">,</code><code> </code><code class="n">Guid</code><code class="p">?</code><code> </code><code class="n">id</code><code> </code><code class="p">=</code><code> </code><code class="k">default</code><code class="p">!</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">Clients</code><code class="p">.</code><code class="n">Groups</code><code class="p">(</code><code class="n">room</code><code class="p">)</code><code class="p">.</code><code class="n">SendAsync</code><code class="p">(</code><code>
</code><code>            </code><code class="n">HubServerEventNames</code><code class="p">.</code><code class="n">MessageReceived</code><code class="p">,</code><code>
</code><code>            </code><code class="n">Notification</code><code class="p">&lt;</code><code class="n">ActorMessage</code><code class="p">&gt;</code><code class="p">.</code><code class="n">FromChat</code><code class="p">(</code><code>
</code><code>                </code><code class="k">new</code><code class="p">(</code><code class="n">Id</code><code class="p">:</code><code> </code><code class="n">id</code><code> </code><code class="p">?</code><code class="p">?</code><code> </code><code class="n">Guid</code><code class="p">.</code><code class="n">NewGuid</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code>
</code><code>                   </code><code class="n">Text</code><code class="p">:</code><code> </code><code class="n">message</code><code class="p">,</code><code>
</code><code>                   </code><code class="n">UserName</code><code class="p">:</code><code> </code><code class="n">_userName</code><code> </code><code class="p">?</code><code class="p">?</code><code> </code><code class="s">"Unknown"</code><code class="p">,</code><code>
</code><code>                   </code><code class="n">IsEdit</code><code class="p">:</code><code> </code><code class="n">id</code><code class="p">.</code><code class="n">HasValue</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="k">async</code><code> </code><code class="n">Task</code><code> </code><code class="nf">JoinChat</code><code class="p">(</code><code class="kt">string</code><code> </code><code class="n">room</code><code class="p">)</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO2-3" id="co_exemplifying_real_time_web_functionality_CO2-3"><img alt="3" src="assets/3.png"/></a><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="k">await</code><code> </code><code class="n">Groups</code><code class="p">.</code><code class="n">AddToGroupAsync</code><code class="p">(</code><code class="n">Context</code><code class="p">.</code><code class="n">ConnectionId</code><code class="p">,</code><code> </code><code class="n">room</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="k">await</code><code> </code><code class="n">Clients</code><code class="p">.</code><code class="n">Caller</code><code class="p">.</code><code class="n">SendAsync</code><code class="p">(</code><code>
</code><code>            </code><code class="n">HubServerEventNames</code><code class="p">.</code><code class="n">MessageReceived</code><code class="p">,</code><code>
</code><code>            </code><code class="n">Notification</code><code class="p">&lt;</code><code class="n">ActorMessage</code><code class="p">&gt;</code><code class="p">.</code><code class="n">FromChat</code><code class="p">(</code><code>
</code><code>                </code><code class="k">new</code><code class="p">(</code><code class="n">Id</code><code class="p">:</code><code> </code><code class="n">Guid</code><code class="p">.</code><code class="n">NewGuid</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code>
</code><code>                    </code><code class="n">Text</code><code class="p">:</code><code> </code><code class="n">_localizer</code><code class="p">[</code><code class="s">"WelcomeToChatRoom"</code><code class="p">,</code><code> </code><code class="n">room</code><code class="p">]</code><code class="p">,</code><code>
</code><code>                    </code><code class="n">UserName</code><code class="p">:</code><code> </code><code class="n">UTF8</code><code class="p">.</code><code class="n">GetString</code><code class="p">(</code><code>
</code><code>                        </code><code class="k">new</code><code> </code><code class="kt">byte</code><code class="p">[</code><code class="p">]</code><code> </code><code class="p">{</code><code> </code><code class="m">240</code><code class="p">,</code><code> </code><code class="m">159</code><code class="p">,</code><code> </code><code class="m">145</code><code class="p">,</code><code> </code><code class="m">139</code><code> </code><code class="p">}</code><code class="p">)</code><code class="p">,</code><code>
</code><code>                    </code><code class="n">IsGreeting</code><code class="p">:</code><code> </code><code class="k">true</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="k">async</code><code> </code><code class="n">Task</code><code> </code><code class="nf">LeaveChat</code><code class="p">(</code><code class="kt">string</code><code> </code><code class="n">room</code><code class="p">)</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO2-4" id="co_exemplifying_real_time_web_functionality_CO2-4"><img alt="4" src="assets/4.png"/></a><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="k">await</code><code> </code><code class="n">Groups</code><code class="p">.</code><code class="n">RemoveFromGroupAsync</code><code class="p">(</code><code class="n">Context</code><code class="p">.</code><code class="n">ConnectionId</code><code class="p">,</code><code> </code><code class="n">room</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="k">await</code><code> </code><code class="n">Clients</code><code class="p">.</code><code class="n">Groups</code><code class="p">(</code><code class="n">room</code><code class="p">)</code><code class="p">.</code><code class="n">SendAsync</code><code class="p">(</code><code>
</code><code>            </code><code class="n">HubServerEventNames</code><code class="p">.</code><code class="n">MessageReceived</code><code class="p">,</code><code>
</code><code>            </code><code class="n">Notification</code><code class="p">&lt;</code><code class="n">ActorMessage</code><code class="p">&gt;</code><code class="p">.</code><code class="n">FromChat</code><code class="p">(</code><code>
</code><code>                </code><code class="k">new</code><code class="p">(</code><code class="n">Id</code><code class="p">:</code><code> </code><code class="n">Guid</code><code class="p">.</code><code class="n">NewGuid</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code>
</code><code>                    </code><code class="n">Text</code><code class="p">:</code><code> </code><code class="n">_localizer</code><code class="p">[</code><code class="s">"HasLeftTheChatRoom"</code><code class="p">,</code><code> </code><code class="n">_userName</code><code> </code><code class="p">?</code><code class="p">?</code><code> </code><code class="s">"?"</code><code class="p">]</code><code class="p">,</code><code>
</code><code>                    </code><code class="n">UserName</code><code class="p">:</code><code> </code><code class="n">UTF8</code><code class="p">.</code><code class="n">GetString</code><code class="p">(</code><code>
</code><code>                        </code><code class="k">new</code><code> </code><code class="kt">byte</code><code class="p">[</code><code class="p">]</code><code> </code><code class="p">{</code><code> </code><code class="m">240</code><code class="p">,</code><code> </code><code class="m">159</code><code class="p">,</code><code> </code><code class="m">164</code><code class="p">,</code><code> </code><code class="m">150</code><code> </code><code class="p">}</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist pagebreak-before less_space">
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO2-1" id="callout_exemplifying_real_time_web_functionality_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>ToggleUserTyping</code> method alters the state of a client chat user.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO2-2" id="callout_exemplifying_real_time_web_functionality_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>PostOrUpdateMessage</code> method posts a message to the chat room.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO2-3" id="callout_exemplifying_real_time_web_functionality_CO2-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>JoinChat</code> method adds the client to the chat room.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO2-4" id="callout_exemplifying_real_time_web_functionality_CO2-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The <code>LeaveChat</code> method removes the client from the chat room.</p></dd>
</dl>

<p>The <code>ToggleUserTyping</code> method accepts a <code>bool</code> value that <a data-primary="ToggleUserTyping method" data-type="indexterm" id="idm46365016646624"/><a data-primary="methods" data-secondary="ToggleUserTyping" data-type="indexterm" id="idm46365016680672"/>indicates if the contextual user’s connection is actively typing in the chat room. This signals the <code>HubServer​E⁠ventNames.UserTyping</code> event sending out a <code>Notification&lt;ActorAction&gt;</code> object that represents the user and their typing status as a message.</p>

<p>The <code>PostOrUpdateMessage</code> method defines <code>room</code> and <code>message</code> <code>string</code> parameters and an optional <code>id</code>. If the <code>id</code> is <code>null</code>, a new globally unique identifier (GUID) is assigned to <a data-primary="PostOrUpdateMessage method" data-type="indexterm" id="idm46365016279776"/><a data-primary="methods" data-secondary="PostOrUpdateMessage" data-type="indexterm" id="idm46365016279104"/>the message. The message contains the message text, the user who sent it, and whether the message is considered edited. This is used for both creating and updating user chat messages.</p>

<p>The <code>JoinChat</code> method <a data-primary="JoinChat method" data-type="indexterm" id="idm46365016007344"/><a data-primary="methods" data-secondary="JoinChat" data-type="indexterm" id="idm46365016006608"/>requires a <code>room</code>. When called, the current connection is added to either a new or existing SignalR group with the matching room name. The method then lets the current caller know that the <code>HubServerEventNames.MessageReceived</code> event has fired, sending a welcome message to the chat room. This event sends a 
<span class="keep-together"><code>Notification&lt;ActorMessage&gt;</code>.</span> All clients have access to this custom generic notification model; it’s part of the Web.Models project. This is perfect because the clients can share these models, and serialization just works. This is far different than your typical JavaScript development, where you’d struggle to maintain the ever-changing shapes of API objects.</p>

<p>The <code>LeaveChat</code> method is <a data-primary="LeaveChat method" data-type="indexterm" id="idm46365016002832"/><a data-primary="methods" data-secondary="LeaveChat" data-type="indexterm" id="idm46365016002096"/>the companion to the <code>JoinChat</code> functionality. This is intentional—you need a way to exit a <code>room</code> once you’ve joined it from the client. This happens in the <code>LeaveChat</code> method where <code>HubServerEventNames.MessageReceived</code> is sent from chat. The current contextual user’s connection to the SignalR hub instance removes them from the chat room. That specific group is sent an automated <a data-primary="NotificationHub.Chat.cs" data-startref="nfthc" data-type="indexterm" id="idm46365015999328"/>message with a bot user name and a localized message.</p>

<p>The chat functionality is taking shape. Imagine now that your app requires access to a live Twitter feed. The model app provides an example of how to do this too. With a requirement for Twitter-specific functionality that is communicated in real time, consider the <em>NotificationHub.Tweets.cs</em> C# file hub <a data-primary="NotificationHub.Tweets.cs" data-type="indexterm" id="ntfhtw"/>implementation:</p>

<pre class="widows_28" data-code-language="csharp" data-type="programlisting"><code class="k">public</code><code> </code><code class="k">partial</code><code> </code><code class="k">class</code><code> </code><code class="nc">NotificationHub</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="k">async</code><code> </code><code class="n">Task</code><code> </code><code class="nf">JoinTweets</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO3-1" id="co_exemplifying_real_time_web_functionality_CO3-1"><img alt="1" src="assets/1.png"/></a><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="k">await</code><code> </code><code class="n">Groups</code><code class="p">.</code><code class="n">AddToGroupAsync</code><code class="p">(</code><code>
</code><code>            </code><code class="n">Context</code><code class="p">.</code><code class="n">ConnectionId</code><code class="p">,</code><code>
</code><code>            </code><code class="n">HubGroupNames</code><code class="p">.</code><code class="n">Tweets</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="p">(</code><code class="n">_twitterService</code><code class="p">.</code><code class="n">CurrentStatus</code><code> </code><code class="k">is</code><code> </code><code class="n">StreamingStatus</code><code> </code><code class="n">status</code><code class="p">)</code><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="k">await</code><code> </code><code class="n">Clients</code><code class="p">.</code><code class="n">Caller</code><code class="p">.</code><code class="n">SendAsync</code><code class="p">(</code><code>
</code><code>                </code><code class="n">HubServerEventNames</code><code class="p">.</code><code class="n">StatusUpdated</code><code class="p">,</code><code>
</code><code>                </code><code class="n">Notification</code><code class="p">&lt;</code><code class="n">StreamingStatus</code><code class="p">&gt;</code><code class="p">.</code><code class="n">FromStatus</code><code class="p">(</code><code class="n">status</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="p">(</code><code class="n">_twitterService</code><code class="p">.</code><code class="n">LastFiftyTweets</code><code> </code><code class="k">is</code><code> </code><code class="p">{</code><code> </code><code class="n">Count</code><code class="p">:</code><code> </code><code class="p">&gt;</code><code> </code><code class="m">0</code><code> </code><code class="p">}</code><code class="p">)</code><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="k">await</code><code> </code><code class="n">Clients</code><code class="p">.</code><code class="n">Caller</code><code class="p">.</code><code class="n">SendAsync</code><code class="p">(</code><code>
</code><code>                </code><code class="n">HubServerEventNames</code><code class="p">.</code><code class="n">InitialTweetsLoaded</code><code class="p">,</code><code>
</code><code>                </code><code class="n">Notification</code><code class="p">&lt;</code><code class="n">List</code><code class="p">&lt;</code><code class="n">TweetContents</code><code class="p">&gt;</code><code class="p">&gt;</code><code class="p">.</code><code class="n">FromTweets</code><code class="p">(</code><code>
</code><code>                    </code><code class="n">_twitterService</code><code class="p">.</code><code class="n">LastFiftyTweets</code><code class="p">.</code><code class="n">ToList</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="n">Task</code><code> </code><code class="nf">LeaveTweets</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO3-2" id="co_exemplifying_real_time_web_functionality_CO3-2"><img alt="2" src="assets/2.png"/></a><code>
</code><code>        </code><code class="n">Groups</code><code class="p">.</code><code class="n">RemoveFromGroupAsync</code><code class="p">(</code><code>
</code><code>            </code><code class="n">Context</code><code class="p">.</code><code class="n">ConnectionId</code><code class="p">,</code><code>
</code><code>            </code><code class="n">HubGroupNames</code><code class="p">.</code><code class="n">Tweets</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="n">Task</code><code> </code><code class="nf">StartTweetStream</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO3-3" id="co_exemplifying_real_time_web_functionality_CO3-3"><img alt="3" src="assets/3.png"/></a><code>
</code><code>        </code><code class="n">_twitterService</code><code class="p">.</code><code class="n">StartTweetStreamAsync</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO3-1" id="callout_exemplifying_real_time_web_functionality_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>JoinTweets</code> method adds the client to the <code>Tweets</code> group.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO3-2" id="callout_exemplifying_real_time_web_functionality_CO3-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>LeaveTweets</code> method removes the client from the <code>Tweets</code> group.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO3-3" id="callout_exemplifying_real_time_web_functionality_CO3-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>StartTweetStream</code> method starts the tweet stream.</p></dd>
</dl>

<p>The RPCs in the tweets hub bring together the ability to join the tweet stream. When this fires, the current connection joins the <code>HubGroupNames.Tweets</code> group. The scoped <code>_twitterService</code> is asked a few questions, such as what the current streaming status is and if there are any tweets in memory:</p>

<ul class="pagebreak-after">
<li>
<p>When the current Twitter streaming status is not <code>null</code> and has a value, it’s assigned to <code>status</code> variables. This <code>status</code> flows to all connected clients, as they’re notified of the current Twitter <code>StreamingStatus</code>.</p>
</li>
<li>
<p>When there are tweets in memory, all connected clients are notified of the tweets as a <code>List&lt;TweetContents&gt;</code> collection.</p>
</li>
</ul>

<p>The <code>LeaveTweets</code> method removes the contextual connection from the <code>HubGroupNames.Tweets</code> group. The <code>StartTweetStream</code> is idempotent as it can be called multiple times without changing the state of the first successful call to start the tweet stream. This is represented as an asynchronous operation.</p>

<p>You’re probably starting to wonder <a data-primary="NotificationHub.Tweets.cs" data-startref="ntfhtw" data-type="indexterm" id="idm46365015920624"/>where the live tweets are coming from. We’ll cover that next when we look at the background service.</p>
</div></section>













<section data-pdf-bookmark="Writing Contextual RPC and Inner-Process Communication" data-type="sect2"><div class="sect2" id="idm46365016779360">
<h2>Writing Contextual RPC and Inner-Process Communication</h2>

<p>The Web.Api project of our <a data-primary="RPC (remote procedure call)" data-secondary="contextual" data-type="indexterm" id="rpcrtx"/><a data-primary="contextual RPC" data-type="indexterm" id="ctsrp"/><a data-primary="inner-process communication" data-type="indexterm" id="inpsmm"/>model app is responsible for exposing an HTTP API surface area, so it’s scoped to handle requests and provide responses. We’re going to explore <a data-primary="IHubContext" data-type="indexterm" id="idm46365015729776"/>how to use an <code>IHubContext</code>, which allows our background service to communicate <a data-primary="NotificationHub object" data-type="indexterm" id="idm46365015728560"/>with the <code>NotificationHub</code> implementation. Beyond that, the model app shows a SignalR <code>/notifications</code> endpoint, which is handled by the collective representation of all <code>partial NotificationHub class</code> implementations. As for the live-streaming aspect of this application, we rely on a Twitter service, but we need a way to listen for events. Within an ASP.NET Core app, you can use a <code>Background​Ser⁠vice</code>, which runs in the same process but outside the request and response pipeline. SignalR provides <a data-primary="SignalR" data-secondary="NotificationHub" data-type="indexterm" id="idm46365015725984"/>a mechanism to access <code>NotificationHub</code> through an <code>IHub​Context</code> interface. This <a data-primary="Web.Api server project" data-type="indexterm" id="wbpv"/>all comes together as shown <a data-primary="TwitterWorkerService.cs" data-type="indexterm" id="twwkv"/>in <a data-type="xref" href="#web-api-server">Figure 6-3</a>.</p>

<figure><div class="figure" id="web-api-server">
<img alt="" src="assets/lblz_0603.png"/>
<h6><span class="label">Figure 6-3. </span>The Web.Api server project</h6>
</div></figure>

<p>Let’s look at the <em>TwitterWorkerService.cs</em> C# file next:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code><code> </code><code class="nn">Learning.Blazor.Api.Services</code><code class="p">;</code><code>
</code><code>
</code><code class="k">public</code><code> </code><code class="k">sealed</code><code> </code><code class="k">class</code><code> </code><code class="nc">TwitterWorkerService</code><code> </code><code class="p">:</code><code> </code><code class="n">BackgroundService</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO4-1" id="co_exemplifying_real_time_web_functionality_CO4-1"><img alt="1" src="assets/1.png"/></a><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">private</code><code> </code><code class="k">readonly</code><code> </code><code class="n">ITwitterService</code><code> </code><code class="n">_twitterService</code><code class="p">;</code><code>
</code><code>    </code><code class="k">private</code><code> </code><code class="k">readonly</code><code> </code><code class="n">IHubContext</code><code class="p">&lt;</code><code class="n">NotificationHub</code><code class="p">&gt;</code><code> </code><code class="n">_hubContext</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="nf">TwitterWorkerService</code><code class="p">(</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO4-2" id="co_exemplifying_real_time_web_functionality_CO4-2"><img alt="2" src="assets/2.png"/></a><code>
</code><code>        </code><code class="n">ITwitterService</code><code> </code><code class="n">twitterService</code><code class="p">,</code><code>
</code><code>        </code><code class="n">IHubContext</code><code class="p">&lt;</code><code class="n">NotificationHub</code><code class="p">&gt;</code><code> </code><code class="n">hubContext</code><code class="p">)</code><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="p">(</code><code class="n">_twitterService</code><code class="p">,</code><code> </code><code class="n">_hubContext</code><code class="p">)</code><code> </code><code class="p">=</code><code> </code><code class="p">(</code><code class="n">twitterService</code><code class="p">,</code><code> </code><code class="n">hubContext</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="n">_twitterService</code><code class="p">.</code><code class="n">StatusUpdated</code><code> </code><code class="p">+</code><code class="p">=</code><code> </code><code class="n">OnStatusUpdated</code><code class="p">;</code><code>
</code><code>        </code><code class="n">_twitterService</code><code class="p">.</code><code class="n">TweetReceived</code><code> </code><code class="p">+</code><code class="p">=</code><code> </code><code class="n">OnTweetReceived</code><code class="p">;</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code>
</code><code>
</code><code>    </code><code class="k">protected</code><code> </code><code class="k">override</code><code> </code><code class="k">async</code><code> </code><code class="n">Task</code><code> </code><code class="nf">ExecuteAsync</code><code class="p">(</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO4-3" id="co_exemplifying_real_time_web_functionality_CO4-3"><img alt="3" src="assets/3.png"/></a><code>
</code><code>        </code><code class="n">CancellationToken</code><code> </code><code class="n">stoppingToken</code><code class="p">)</code><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="k">while</code><code> </code><code class="p">(</code><code class="p">!</code><code class="n">stoppingToken</code><code class="p">.</code><code class="n">IsCancellationRequested</code><code class="p">)</code><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="k">await</code><code> </code><code class="n">Task</code><code class="p">.</code><code class="n">Delay</code><code class="p">(</code><code class="n">TimeSpan</code><code class="p">.</code><code class="n">FromMinutes</code><code class="p">(</code><code class="m">1</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">stoppingToken</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code>
</code><code>    </code><code class="k">private</code><code> </code><code class="n">Task</code><code> </code><code class="nf">OnStatusUpdated</code><code class="p">(</code><code class="n">StreamingStatus</code><code> </code><code class="n">status</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO4-4" id="co_exemplifying_real_time_web_functionality_CO4-4"><img alt="4" src="assets/4.png"/></a><code>
</code><code>        </code><code class="n">_hubContext</code><code class="p">.</code><code class="n">Clients</code><code>
</code><code>            </code><code class="p">.</code><code class="n">Group</code><code class="p">(</code><code class="n">HubGroupNames</code><code class="p">.</code><code class="n">Tweets</code><code class="p">)</code><code>
</code><code>            </code><code class="p">.</code><code class="n">SendAsync</code><code class="p">(</code><code>
</code><code>                </code><code class="n">HubServerEventNames</code><code class="p">.</code><code class="n">StatusUpdated</code><code class="p">,</code><code>
</code><code>                </code><code class="n">Notification</code><code class="p">&lt;</code><code class="n">StreamingStatus</code><code class="p">&gt;</code><code class="p">.</code><code class="n">FromStatus</code><code class="p">(</code><code class="n">status</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">private</code><code> </code><code class="n">Task</code><code> </code><code class="nf">OnTweetReceived</code><code class="p">(</code><code class="n">TweetContents</code><code> </code><code class="n">tweet</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO4-5" id="co_exemplifying_real_time_web_functionality_CO4-5"><img alt="5" src="assets/5.png"/></a><code>
</code><code>        </code><code class="n">_hubContext</code><code class="p">.</code><code class="n">Clients</code><code>
</code><code>            </code><code class="p">.</code><code class="n">Group</code><code class="p">(</code><code class="n">HubGroupNames</code><code class="p">.</code><code class="n">Tweets</code><code class="p">)</code><code>
</code><code>            </code><code class="p">.</code><code class="n">SendAsync</code><code class="p">(</code><code>
</code><code>                </code><code class="n">HubServerEventNames</code><code class="p">.</code><code class="n">TweetReceived</code><code class="p">,</code><code>
</code><code>                </code><code class="n">Notification</code><code class="p">&lt;</code><code class="n">TweetContents</code><code class="p">&gt;</code><code class="p">.</code><code class="n">FromTweet</code><code class="p">(</code><code class="n">tweet</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO4-1" id="callout_exemplifying_real_time_web_functionality_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p><code>TwitterWorkerService</code> implements <code>BackgroundService</code>.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO4-2" id="callout_exemplifying_real_time_web_functionality_CO4-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The constructor takes the <code>ITwitterService</code> and <code>IHubContext</code> as parameters.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO4-3" id="callout_exemplifying_real_time_web_functionality_CO4-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>ExecuteAsync</code> method is the main entry point for the service.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO4-4" id="callout_exemplifying_real_time_web_functionality_CO4-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The <code>OnStatusUpdated</code> method is called when <code>_twitterService</code> fires the <code>StatusUpdated</code> event.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO4-5" id="callout_exemplifying_real_time_web_functionality_CO4-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p><code>OnTweetReceived</code> handles the <code>TweetReceived</code> event, notifying all clients in the <code>HubGroupNames.Tweets</code> group.</p></dd>
</dl>

<p><code>TwitterWorkerService</code> is a <a data-primary="BackgroundService" data-type="indexterm" id="idm46365015422064"/>descendant of <code>BackgroundService</code>. Background services are long-lived apps that execute in a loop but with access to the notification hub’s context, and they can send messages through their connected clients. This class defines two fields:</p>
<dl>
<dt><code>ITwitterService _twitterService</code></dt>
<dd>
<p>This is the same service that was used in the <code>NotificationHub</code> for in-memory streaming status and tweets. It can now handle events from the underlying <code>TweetInvi</code>’s filtered streams.</p>
</dd>
<dt><code>IHubContext&lt;NotificationHub&gt; _hubContext</code></dt>
<dd>
<p>This object is used to send messages out to connected clients of the SignalR server hub.</p>
</dd>
</dl>

<p>The <code>TwitterWorkerService</code> constructor declares the values as parameters. The DI framework will provide the service and hub context objects. They’re positionally assigned using an immediate deconstruction of a tuple literal from the <code>.ctor</code> parameters. <code>_twitterService</code> has its <code>StatusUpdated</code> and <code>TweetReceived</code> event handlers assigned. The Twitter service exposes an eventing mechanism and fires an event when a tweet is received. In C# you can subscribe a delegate to events that will serve as a callback. There is no need to unsubscribe from the events because the app will not stop unless the entire app is torn down. In that case, we’re not holding on to any unsubscribed events—the entire process is being terminated.</p>

<p>The <code>ExecuteAsync</code> method is implemented as a signal that the app can perform its task. This just spins, listening for the stopping token’s cancellation request. It just delays and listens in an asynchronous loop.</p>

<p>When the <code>_twitterService.OnStatusUpdated</code> event fires, an update on the current streaming status is sent to all subscribers. All contextual clients in the <code>HubGroupNames.Tweets</code> group are sent the <code>HubServerEventNames.StatusUpdated</code> event. The notification is <code>StreamingStatus</code>.</p>

<p>The <code>_twitterService.OnTweetReceived</code> event is handled when a new <code>Tweet​Con⁠tents tweet</code> object is received. These <code>tweet</code> contents are sent from the <code>Hub​ServerEventNames.TweetReceived</code> event.  They are also sent over to the same group named <code>HubGroupNames.Tweets</code>.</p>

<p>The server functionality is complete. With this, we can serve up a SignalR connection over a negotiated <code>/notifications</code> endpoint. Each client negotiates what protocol and transport they speak. A SignalR transport is the communication handler, such as WebSockets, Server-Sent Events, and Long Polling. There are various ways in which clients can talk to servers and vice versa. This usually follows a fallback convention of preferred defaults to less than preferred. The good <a data-primary="RPC (remote procedure call)" data-secondary="contextual" data-startref="rpcrtx" data-type="indexterm" id="idm46365015408384"/><a data-primary="contextual RPC" data-startref="ctsrp" data-type="indexterm" id="idm46365015407296"/><a data-primary="inner-process communication" data-startref="inpsmm" data-type="indexterm" id="idm46365015406448"/><a data-primary="TwitterWorkerService.cs" data-startref="twwkv" data-type="indexterm" id="idm46365015405600"/>news is that most modern browser environments support WebSockets, which are highly performant.</p>
</div></section>













<section data-pdf-bookmark="Configuring the Hub Endpoint" data-type="sect2"><div class="sect2" id="idm46365015919296">
<h2>Configuring the Hub Endpoint</h2>

<p>For the functionality of the hub to <a data-primary="hub endpoint, configuration" data-type="indexterm" id="bhdp"/><a data-primary="endpoints" data-secondary="hub, configuration" data-type="indexterm" id="dpbfg"/>be exposed as a consumable route, it has to configure how clients will communicate with it. There are a few things that need to be configured:</p>

<ul>
<li>
<p>The desired message and transport protocols (may require additional NuGet packages)</p>
</li>
<li>
<p>The mapping of <code>NotificationHub</code> <a data-primary="NotificationHub object" data-secondary="mapping to endpoint" data-type="indexterm" id="idm46365015398288"/>to the <code>/notifications</code> endpoint</p>
</li>
<li>
<p>The registration of <code>TwitterWorkerService</code> as <a data-primary="TwitterWorkerService as hosted service" data-type="indexterm" id="idm46365015395776"/>a hosted service (<code>Background​Ser⁠vice</code>)</p>
</li>
</ul>

<p>Since the Web.Api project targets the <code>net6.0</code> TFM and specifies <code>&lt;Project Sdk="Microsoft.NET.Sdk.Web"&gt;</code>, SignalR is implicitly referenced as part of the SDK’s meta-package. For an overview <a data-primary="SDKs (software development kits), .NET and" data-type="indexterm" id="idm46365015392912"/><a data-primary="software development kits (SDKs), .NET and" data-type="indexterm" id="idm46365015392304"/><a data-primary=".NET" data-primary-sortas="NET" data-secondary="SDKs (software development kits)" data-type="indexterm" id="idm46365015391696"/>of SDKs in .NET, see Microsoft’s <a href="https://oreil.ly/T4WRW">“.NET Project SDKs” documentation</a>. The default message protocol is JSON (text-based protocol), which is human-readable and convenient for debugging. However, it is far more efficient to use MessagePack, which is a binary protocol, and messages are usually half the size.</p>

<p>The <em>Web.Api.csproj</em> XML file includes the <a data-primary="Web.Api.csproj" data-type="indexterm" id="wbppj"/>following among other package references:</p>

<pre data-code-language="xml" data-type="programlisting"><code class="nt">&lt;Project</code><code> </code><code class="na">Sdk=</code><code class="s">"Microsoft.NET.Sdk.Web"</code><code class="nt">&gt;</code><code>

    </code><code class="nt">&lt;PropertyGroup</code><code class="nt">&gt;</code><code>
        </code><code class="nt">&lt;RootNamespace</code><code class="nt">&gt;</code><code>Learning.Blazor.Api</code><code class="nt">&lt;/RootNamespace&gt;</code><code>
        </code><code class="nt">&lt;TargetFramework</code><code class="nt">&gt;</code><code>net6.0</code><code class="nt">&lt;/TargetFramework&gt;</code><code>
        </code><code class="nt">&lt;Nullable</code><code class="nt">&gt;</code><code>enable</code><code class="nt">&lt;/Nullable&gt;</code><code>
        </code><code class="nt">&lt;ImplicitUsings</code><code class="nt">&gt;</code><code>true</code><code class="nt">&lt;/ImplicitUsings&gt;</code><code>
        </code><code class="nt">&lt;DockerDefaultTargetOS</code><code class="nt">&gt;</code><code>Linux</code><code class="nt">&lt;/DockerDefaultTargetOS&gt;</code><code>
        </code><code class="nt">&lt;DockerfileContext</code><code class="nt">&gt;</code><code>..\..</code><code class="nt">&lt;/DockerfileContext&gt;</code><code>
    </code><code class="nt">&lt;/PropertyGroup&gt;</code><code>

    </code><code class="nt">&lt;ItemGroup</code><code class="nt">&gt;</code><code>
        </code><code class="nt">&lt;PackageReference</code><code> </code><code class="na">Version=</code><code class="s">"6.0.1"</code><code>
            </code><code class="na">Include=</code><code class="s">"Microsoft.AspNetCore.SignalR.Protocols.MessagePack"</code><code> </code><code class="nt">/&gt;</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO5-1" id="co_exemplifying_real_time_web_functionality_CO5-1"><img alt="1" src="assets/1.png"/></a><code>
        </code><code class="cm">&lt;!-- Additional package references omitted for brevity --&gt;</code><code>
    </code><code class="nt">&lt;/ItemGroup&gt;</code><code>
    </code><code class="nt">&lt;ItemGroup</code><code class="nt">&gt;</code><code>
        </code><code class="cm">&lt;!--
            Project references omitted for brevity:
                Abstractions, Cosmos DB, Distributed Caching,
                Extensions, Http.Extensions, LogicAppServices, TwitterServices
        --&gt;</code><code>
    </code><code class="nt">&lt;/ItemGroup&gt;</code><code>

    </code><code class="cm">&lt;!-- Omitted for brevity --&gt;</code><code>
</code><code class="nt">&lt;/Project&gt;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO5-1" id="callout_exemplifying_real_time_web_functionality_CO5-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>Microsoft.AspNetCore.SignalR.Protocols.MessagePack</code> NuGet package reference is <a data-primary="Web.Api.csproj" data-startref="wbppj" data-type="indexterm" id="idm46365015338944"/>included.</p></dd>
</dl>

<p>This exposes the MessagePack binary <a data-primary="MessagePack protocol" data-type="indexterm" id="idm46365015337360"/>protocol. The client has to also configure MessagePack for this protocol to be used or it will fall back to the default text-based JSON protocol.</p>

<p>In the Web.Api project’s <code>Startup</code> class, we add SignalR and map the <code>NotificationHub</code> to the <code>"/notifications"</code> endpoint. Consider <a data-primary="Startup.cs" data-type="indexterm" id="idm46365015334480"/>the <em>Startup.cs</em> C# file:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code> <code class="nn">Learning.Blazor.Api</code><code class="p">;</code>

<code class="k">public</code> <code class="k">sealed</code> <code class="k">partial</code> <code class="k">class</code> <code class="nc">Startup</code>
<code class="p">{</code>
    <code class="k">readonly</code> <code class="n">IConfiguration</code> <code class="n">_configuration</code><code class="p">;</code>

    <code class="k">public</code> <code class="nf">Startup</code><code class="p">(</code><code class="n">IConfiguration</code> <code class="n">configuration</code><code class="p">)</code> <code class="p">=&gt;</code>
        <code class="n">_configuration</code> <code class="p">=</code> <code class="n">configuration</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>The <code>Startup</code> class is <code>partial</code>, and it defines only the <code>_configuration</code> field and the constructor that accepts the <a data-primary="startup" data-secondary="objects, methods" data-type="indexterm" id="idm46365015269760"/>configuration. By convention, a startup object has two methods:</p>
<dl>
<dt><code>ConfigureServices(IServiceCollection services)</code></dt>
<dd>
<p>This method <a data-primary="ConfigureServices(IServiceCollection services)" data-type="indexterm" id="idm46365015267088"/>is responsible for registering services on the service collection (commonly achieved with helper <code>Add{DomainService}</code> extension methods).</p>
</dd>
<dt><code>Configure(IApplicationBuilder app, IWebHostEnvironment env)</code></dt>
<dd>
<p>This method <a data-primary="Configure(IApplicationBuilder app, IWebHostEnvironment env)" data-type="indexterm" id="idm46365015238528"/>is responsible for configuring services for usage (commonly achieved with helper <code>Use{DomainService}</code> extension methods).</p>
</dd>
</dl>

<p>First, we add SignalR <a data-primary="SignalR" data-secondary="Startup.ConfigureServices.cs" data-type="indexterm" id="sgrsg"/><a data-primary="Startup.ConfigureServices.cs" data-type="indexterm" id="stpfg"/>in the <em>Startup.ConfigureServices.cs</em> C# file:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code><code> </code><code class="nn">Learning.Blazor.Api</code><code class="p">;</code><code>
</code><code>
</code><code class="k">public</code><code> </code><code class="k">sealed</code><code> </code><code class="k">partial</code><code> </code><code class="k">class</code><code> </code><code class="nc">Startup</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="k">void</code><code> </code><code class="nf">ConfigureServices</code><code class="p">(</code><code class="n">IServiceCollection</code><code> </code><code class="n">services</code><code class="p">)</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO6-1" id="co_exemplifying_real_time_web_functionality_CO6-1"><img alt="1" src="assets/1.png"/></a><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="n">services</code><code class="p">.</code><code class="n">AddAuthentication</code><code class="p">(</code><code class="n">JwtBearerDefaults</code><code class="p">.</code><code class="n">AuthenticationScheme</code><code class="p">)</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO6-2" id="co_exemplifying_real_time_web_functionality_CO6-2"><img alt="2" src="assets/2.png"/></a><code>
</code><code>            </code><code class="p">.</code><code class="n">AddMicrosoftIdentityWebApi</code><code class="p">(</code><code>
</code><code>                </code><code class="n">_configuration</code><code class="p">.</code><code class="n">GetSection</code><code class="p">(</code><code class="s">"AzureAdB2C"</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="n">services</code><code class="p">.</code><code class="n">Configure</code><code class="p">&lt;</code><code class="n">JwtBearerOptions</code><code class="p">&gt;</code><code class="p">(</code><code>
</code><code>            </code><code class="n">JwtBearerDefaults</code><code class="p">.</code><code class="n">AuthenticationScheme</code><code class="p">,</code><code>
</code><code>            </code><code class="n">options</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>            </code><code class="n">options</code><code class="p">.</code><code class="n">TokenValidationParameters</code><code class="p">.</code><code class="n">NameClaimType</code><code> </code><code class="p">=</code><code> </code><code class="s">"name"</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="n">services</code><code class="p">.</code><code class="n">AddApiServices</code><code class="p">(</code><code class="n">_configuration</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="kt">var</code><code> </code><code class="n">webClientOrigin</code><code> </code><code class="p">=</code><code> </code><code class="n">_configuration</code><code class="p">[</code><code class="s">"WebClientOrigin"</code><code class="p">]</code><code class="p">;</code><code>
</code><code>        </code><code class="n">services</code><code class="p">.</code><code class="n">AddCors</code><code class="p">(</code><code>
</code><code>            </code><code class="n">options</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">options</code><code class="p">.</code><code class="n">AddDefaultPolicy</code><code class="p">(</code><code>
</code><code>                </code><code class="n">builder</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">builder</code><code class="p">.</code><code class="n">WithOrigins</code><code class="p">(</code><code>
</code><code>                    </code><code class="s">"https://localhost:5001"</code><code class="p">,</code><code> </code><code class="n">webClientOrigin</code><code class="p">)</code><code>
</code><code>                    </code><code class="p">.</code><code class="n">AllowAnyMethod</code><code class="p">(</code><code class="p">)</code><code>
</code><code>                    </code><code class="p">.</code><code class="n">AllowAnyHeader</code><code class="p">(</code><code class="p">)</code><code>
</code><code>                    </code><code class="p">.</code><code class="n">AllowCredentials</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="n">services</code><code class="p">.</code><code class="n">AddControllers</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="n">services</code><code class="p">.</code><code class="n">AddSignalR</code><code class="p">(</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO6-3" id="co_exemplifying_real_time_web_functionality_CO6-3"><img alt="3" src="assets/3.png"/></a><code>
</code><code>            </code><code class="n">options</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">options</code><code class="p">.</code><code class="n">EnableDetailedErrors</code><code> </code><code class="p">=</code><code> </code><code class="k">true</code><code class="p">)</code><code>
</code><code>                </code><code class="p">.</code><code class="n">AddMessagePackProtocol</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO6-1" id="callout_exemplifying_real_time_web_functionality_CO6-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p><code>IServiceCollection</code> has services added to it.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO6-2" id="callout_exemplifying_real_time_web_functionality_CO6-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p><code>JwtBearerOptions</code> are configured.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO6-3" id="callout_exemplifying_real_time_web_functionality_CO6-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>SignalR</code> service is configured to show detailed <a data-primary="SignalR" data-secondary="Startup.ConfigureServices.cs" data-startref="sgrsg" data-type="indexterm" id="idm46365015013024"/>errors and adds <code>MessagePack</code>.</p></dd>
</dl>

<p>Authentication middleware is added, <a data-primary="authentication" data-secondary="middleware" data-type="indexterm" id="idm46365015010848"/>and this should look a bit familiar by now—it’s configured using the same Azure AD B2C tenant shown in previous chapters. It is configured to use the <code>"name"</code> as the name claim type. Since our Blazor WebAssembly app makes requests to different origins, our API needs to allow CORS.</p>

<p>SignalR is added, using the <code>.AddSignalR</code> extension <a data-primary="SignalR" data-secondary="AddSignalR extension method" data-type="indexterm" id="idm46365015008176"/><a data-primary="methods" data-secondary="AddSignalR extension method" data-type="indexterm" id="idm46365015007200"/>method. Chained fluently on this call is a call to <code>AddMessagePackProtocol</code>, and <a data-primary="AddMessagePackProtocol" data-type="indexterm" id="idm46365015005712"/><a data-primary="Startup.ConfigureServices.cs" data-startref="stpfg" data-type="indexterm" id="idm46365015004976"/>as the name signifies, this will add MessagePack as the desired SignalR message protocol.</p>

<p>After adding these services to the startup routine, now we can <a data-primary="Startup.Configure.cs" data-type="indexterm" id="srtcg"/>configure them. Let’s have a look at the <em>Startup.Configure.cs</em> C# file:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code><code> </code><code class="nn">Learning.Blazor.Api</code><code class="p">;</code><code>
</code><code>
</code><code class="k">public</code><code> </code><code class="k">sealed</code><code> </code><code class="k">partial</code><code> </code><code class="k">class</code><code> </code><code class="nc">Startup</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="k">void</code><code> </code><code class="nf">Configure</code><code class="p">(</code><code class="n">IApplicationBuilder</code><code> </code><code class="n">app</code><code class="p">,</code><code> </code><code class="n">IWebHostEnvironment</code><code> </code><code class="n">env</code><code class="p">)</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO7-1" id="co_exemplifying_real_time_web_functionality_CO7-1"><img alt="1" src="assets/1.png"/></a><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="p">(</code><code class="n">env</code><code class="p">.</code><code class="n">IsDevelopment</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="n">app</code><code class="p">.</code><code class="n">UseDeveloperExceptionPage</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>
</code><code>        </code><code class="n">app</code><code class="p">.</code><code class="n">UseHttpsRedirection</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="n">app</code><code class="p">.</code><code class="n">UseRouting</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="kt">var</code><code> </code><code class="n">webClientOrigin</code><code> </code><code class="p">=</code><code> </code><code class="n">_configuration</code><code class="p">[</code><code class="s">"WebClientOrigin"</code><code class="p">]</code><code class="p">;</code><code>
</code><code>        </code><code class="n">app</code><code class="p">.</code><code class="n">UseCors</code><code class="p">(</code><code class="n">options</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>            </code><code class="n">options</code><code class="p">.</code><code class="n">WithOrigins</code><code class="p">(</code><code>
</code><code>                    </code><code class="s">"https://localhost:5001"</code><code class="p">,</code><code> </code><code class="n">webClientOrigin</code><code class="p">)</code><code>
</code><code>                </code><code class="p">.</code><code class="n">AllowAnyHeader</code><code class="p">(</code><code class="p">)</code><code>
</code><code>                </code><code class="p">.</code><code class="n">AllowAnyMethod</code><code class="p">(</code><code class="p">)</code><code>
</code><code>                </code><code class="p">.</code><code class="n">AllowCredentials</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="kt">var</code><code> </code><code class="n">localizationOptions</code><code> </code><code class="p">=</code><code> </code><code class="k">new</code><code> </code><code class="n">RequestLocalizationOptions</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO7-2" id="co_exemplifying_real_time_web_functionality_CO7-2"><img alt="2" src="assets/2.png"/></a><code>
</code><code>            </code><code class="p">.</code><code class="n">SetDefaultCulture</code><code class="p">(</code><code class="n">Cultures</code><code class="p">.</code><code class="n">Default</code><code class="p">)</code><code>
</code><code>            </code><code class="p">.</code><code class="n">AddSupportedCultures</code><code class="p">(</code><code class="n">Cultures</code><code class="p">.</code><code class="n">Supported</code><code class="p">)</code><code>
</code><code>            </code><code class="p">.</code><code class="n">AddSupportedUICultures</code><code class="p">(</code><code class="n">Cultures</code><code class="p">.</code><code class="n">Supported</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="n">app</code><code class="p">.</code><code class="n">UseRequestLocalization</code><code class="p">(</code><code class="n">localizationOptions</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="n">app</code><code class="p">.</code><code class="n">UseAuthentication</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="n">app</code><code class="p">.</code><code class="n">UseAuthorization</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="n">app</code><code class="p">.</code><code class="n">UseResponseCaching</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="n">app</code><code class="p">.</code><code class="n">UseEndpoints</code><code class="p">(</code><code class="n">endpoints</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO7-3" id="co_exemplifying_real_time_web_functionality_CO7-3"><img alt="3" src="assets/3.png"/></a><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="n">endpoints</code><code class="p">.</code><code class="n">MapControllers</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>            </code><code class="n">endpoints</code><code class="p">.</code><code class="n">MapHub</code><code class="p">&lt;</code><code class="n">NotificationHub</code><code class="p">&gt;</code><code class="p">(</code><code class="s">"/notifications"</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO7-1" id="callout_exemplifying_real_time_web_functionality_CO7-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>Configure</code> method is a <a data-primary="Configure method" data-type="indexterm" id="idm46365014975488"/><a data-primary="methods" data-secondary="Configure" data-type="indexterm" id="idm46365014974752"/>convention of ASP.NET Core web apps. It configures services for DI.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO7-2" id="callout_exemplifying_real_time_web_functionality_CO7-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The Web.Api project <a data-primary="request localization" data-type="indexterm" id="idm46365014734144"/><a data-primary="localization" data-secondary="request localization" data-type="indexterm" id="idm46365014733408"/>supports request localization, which is similar to localization detailed in <a data-type="xref" href="ch05.html#chapter-five">Chapter 5</a> with translation resource files and the <code>IString​Local⁠izer&lt;T&gt;</code> abstraction.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO7-3" id="callout_exemplifying_real_time_web_functionality_CO7-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p><code>NotificationHub</code> is mapped to its endpoint.</p></dd>
</dl>

<p>The <code>Configure</code> functionality starts by conditionally using the developer exception page when the current runtime environment is configured as <code>"Development"</code>. HTTPs redirection is used, which enforces the <code>https://</code> scheme for the API. The use of routing enables endpoint middleware services. Next, the model app’s CORS that <a data-primary="Startup.Configure.cs" data-startref="srtcg" data-type="indexterm" id="idm46365014713440"/>was previously added is now being used.</p>

<p>In the previous chapter, we explored the concepts of localization. In the Web.Api project, we use a variation of <a data-primary="Web.Api server project" data-secondary="localization" data-type="indexterm" id="idm46365014711952"/><a data-primary="localization" data-secondary="Web.api project" data-type="indexterm" id="idm46365014711104"/>the same approach. While all resource files use the same mechanics in this project, the concept of localization from a Web API project requires a request-specific middleware that will automatically set the appropriate <code>Culture</code> based on the HTTP request itself. The configuration routine specifies the use of several more middleware services:</p>
<dl class="pagebreak-before less_space">
<dt><code>UseAuthentication</code></dt>
<dd>
<p>Uses the added Azure AD B2C <a data-primary="UseAuthentication" data-type="indexterm" id="idm46365014707728"/>tenant</p>
</dd>
<dt><code>UseAuthorization</code></dt>
<dd>
<p>Allows APIs to be decorated with <code>Authorize</code> attributes, <a data-primary="UseAuthorization" data-type="indexterm" id="idm46365014705328"/>which require an authenticated user</p>
</dd>
<dt><code>ResponseCaching</code></dt>
<dd>
<p>Allows APIs to declaratively specify caching behavior</p>
</dd>
</dl>

<p>The call to <code>UseEndpoints</code> is required for <a data-primary="SignalR" data-secondary="UseEndpoints" data-type="indexterm" id="idm46365014702416"/><a data-primary="UseEndpoints, SignalR and" data-type="indexterm" id="idm46365014701568"/>SignalR, as <code>NotificationHub</code> is mapped to the <code>"/notifications"</code> endpoint. With that in place, the project is ready to serve many connected clients concurrently.</p>

<p>In the next section, we will examine how <a data-primary="events" data-secondary="server-side" data-startref="vtvd" data-type="indexterm" id="idm46365014699568"/><a data-primary="server-side events" data-startref="svsvt" data-type="indexterm" id="idm46365014698480"/><a data-primary="SignalR" data-secondary="server-side events" data-startref="sgrvd" data-type="indexterm" id="idm46365014697632"/><a data-primary="Web.Api server project" data-startref="wbpv" data-type="indexterm" id="idm46365014696544"/><a data-primary="hub endpoint, configuration" data-startref="bhdp" data-type="indexterm" id="idm46365014695600"/><a data-primary="endpoints" data-secondary="hub, configuration" data-startref="dpbfg" data-type="indexterm" id="idm46365014694688"/>this data is ingested by the client app.</p>
</div></section>





</div></section>













<section data-pdf-bookmark="Consuming Real-Time Data on the Client" data-type="sect1"><div class="sect1" id="idm46365015403600">
<h1>Consuming Real-Time Data on the Client</h1>

<p>Getting back to the Web.Client project, the model app for this book uses real-time data in several components and pages. To avoid opening multiple connections to the server from a single client, a shared approach for the hub connection is used. Each client <a data-primary="SharedHubConnection class" data-type="indexterm" id="idm46365014692000"/>will have exactly one <code>SharedHubConnection</code> instance. The <code>SharedHub​Con⁠nection</code> class has several implementations, and it’s responsible for managing a single framework-provided <code>HubConnection</code> that is shared by several components. Before we can use a <code>HubConnection</code>, we must first configure the client to support this type. The <code>SharedHubConnection</code> class shares a single <code>HubConnection</code> instance, and it’s responsible for managing the connection in a thread-safe manner.</p>








<section data-pdf-bookmark="Configuring the Client" data-type="sect2"><div class="sect2" id="idm46365014688560">
<h2>Configuring the Client</h2>

<p>To configure SignalR on the client, our Web.Client <a data-primary="Web.Client project" data-secondary="client configuration" data-type="indexterm" id="idm46365014687168"/><a data-primary="real-time data" data-secondary="Web.Client project, client configuration" data-type="indexterm" id="idm46365014686192"/><a data-primary="NuGet package" data-type="indexterm" id="idm46365014685152"/>project has to include two NuGet package references:</p>
<ul>
<li>
<p><a href="https://oreil.ly/P1bXb"><code>Microsoft.AspNetCore.SignalR.Client</code></a></p>
</li>
<li>
<p class="fix_tracking"><span class="keep-together"><a href="https://oreil.ly/oZLi1"><code>Microsoft.AspNetCore.SignalR.Protocols.MessagePack</code></a></span></p>
</li>
</ul>

<p>In addition to these packages, the custom <code>SharedHubConnection</code> class was registered as a singleton with the client’s service provider, enabling it as a resolvable service through DI. This was initially discussed in <a data-type="xref" href="ch04.html#web-client-configure-services">“The Web.Client ConfigureServices Functionality”</a>. Only a single instance of this service will exist for the lifetime of the client app. This is an important detail as it shares a connection state with all of the consuming components and pages. Next, we’ll look at the <code>SharedHubConnection</code> implementation.</p>
</div></section>













<section data-pdf-bookmark="Sharing a Hub Connection" data-type="sect2"><div class="sect2" id="idm46365014678080">
<h2>Sharing a Hub Connection</h2>

<p>The <code>SharedHubConnection</code> class is used by any component or page within the client app that needs to talk to the SignalR server, regardless of whether the component needs to push data to the server or whether the client subscribes to server events or both. The <em>SharedHubConnection.cs</em> C# contains <a data-primary="SharedHubConnection.cs" data-type="indexterm" id="shbncs"/>the logic for sharing a single framework-provided <code>HubConnection</code>:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code><code> </code><code class="nn">Learning.Blazor</code><code class="p">;</code><code>
</code><code>
</code><code class="k">public</code><code> </code><code class="k">sealed</code><code> </code><code class="k">partial</code><code> </code><code class="k">class</code><code> </code><code class="nc">SharedHubConnection</code><code> </code><code class="p">:</code><code> </code><code class="n">IAsyncDisposable</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO8-1" id="co_exemplifying_real_time_web_functionality_CO8-1"><img alt="1" src="assets/1.png"/></a><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">private</code><code> </code><code class="k">readonly</code><code> </code><code class="n">IServiceProvider</code><code> </code><code class="n">_serviceProvider</code><code> </code><code class="p">=</code><code> </code><code class="k">null</code><code class="p">!</code><code class="p">;</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO8-2" id="co_exemplifying_real_time_web_functionality_CO8-2"><img alt="2" src="assets/2.png"/></a><code>
</code><code>    </code><code class="k">private</code><code> </code><code class="k">readonly</code><code> </code><code class="n">ILogger</code><code class="p">&lt;</code><code class="n">SharedHubConnection</code><code class="p">&gt;</code><code> </code><code class="n">_logger</code><code> </code><code class="p">=</code><code> </code><code class="k">null</code><code class="p">!</code><code class="p">;</code><code>
</code><code>    </code><code class="k">private</code><code> </code><code class="k">readonly</code><code> </code><code class="n">CultureService</code><code> </code><code class="n">_cultureService</code><code> </code><code class="p">=</code><code> </code><code class="k">null</code><code class="p">!</code><code class="p">;</code><code>
</code><code>    </code><code class="k">private</code><code> </code><code class="k">readonly</code><code> </code><code class="n">HubConnection</code><code> </code><code class="n">_hubConnection</code><code> </code><code class="p">=</code><code> </code><code class="k">null</code><code class="p">!</code><code class="p">;</code><code>
</code><code>    </code><code class="k">private</code><code> </code><code class="k">readonly</code><code> </code><code class="n">SemaphoreSlim</code><code> </code><code class="n">_lock</code><code> </code><code class="p">=</code><code> </code><code class="k">new</code><code class="p">(</code><code class="m">1</code><code class="p">,</code><code> </code><code class="m">1</code><code class="p">)</code><code class="p">;</code><code>
</code><code>    </code><code class="k">private</code><code> </code><code class="k">readonly</code><code> </code><code class="n">HashSet</code><code class="p">&lt;</code><code class="n">ComponentBase</code><code class="p">&gt;</code><code> </code><code class="n">_activeComponents</code><code> </code><code class="p">=</code><code> </code><code class="k">new</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="c1">/// &lt;summary&gt;
</code><code>    </code><code class="c1">/// Indicates the state of the &lt;see cref="HubConnection"/&gt; to the server.
</code><code>    </code><code class="c1">/// &lt;/summary&gt;
</code><code>    </code><code class="k">public</code><code> </code><code class="n">HubConnectionState</code><code> </code><code class="n">State</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">_hubConnection</code><code class="p">?</code><code class="p">.</code><code class="n">State</code><code> </code><code class="p">?</code><code class="p">?</code><code> </code><code class="n">HubConnectionState</code><code class="p">.</code><code class="n">Disconnected</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="nf">SharedHubConnection</code><code class="p">(</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO8-3" id="co_exemplifying_real_time_web_functionality_CO8-3"><img alt="3" src="assets/3.png"/></a><code>
</code><code>        </code><code class="n">IServiceProvider</code><code> </code><code class="n">serviceProvider</code><code class="p">,</code><code>
</code><code>        </code><code class="n">IOptions</code><code class="p">&lt;</code><code class="n">WebApiOptions</code><code class="p">&gt;</code><code> </code><code class="n">options</code><code class="p">,</code><code>
</code><code>        </code><code class="n">CultureService</code><code> </code><code class="n">cultureService</code><code class="p">,</code><code>
</code><code>        </code><code class="n">ILogger</code><code class="p">&lt;</code><code class="n">SharedHubConnection</code><code class="p">&gt;</code><code> </code><code class="n">logger</code><code class="p">)</code><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="p">(</code><code class="n">_serviceProvider</code><code class="p">,</code><code> </code><code class="n">_cultureService</code><code class="p">,</code><code> </code><code class="n">_logger</code><code class="p">)</code><code> </code><code class="p">=</code><code>
</code><code>            </code><code class="p">(</code><code class="n">serviceProvider</code><code class="p">,</code><code> </code><code class="n">cultureService</code><code class="p">,</code><code> </code><code class="n">logger</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="kt">var</code><code> </code><code class="n">notificationHub</code><code> </code><code class="p">=</code><code>
</code><code>            </code><code class="k">new</code><code> </code><code class="nf">Uri</code><code class="p">(</code><code class="err">$</code><code class="s">"{options.Value.WebApiServerUrl}/notifications"</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="n">_hubConnection</code><code> </code><code class="p">=</code><code> </code><code class="k">new</code><code> </code><code class="n">HubConnectionBuilder</code><code class="p">(</code><code class="p">)</code><code>
</code><code>            </code><code class="p">.</code><code class="n">WithUrl</code><code class="p">(</code><code class="n">notificationHub</code><code class="p">,</code><code>
</code><code>                 </code><code class="n">options</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>                 </code><code class="p">{</code><code>
</code><code>                     </code><code class="n">options</code><code class="p">.</code><code class="n">AccessTokenProvider</code><code> </code><code class="p">=</code><code> </code><code class="n">GetAccessTokenValueAsync</code><code class="p">;</code><code>
</code><code>                     </code><code class="n">options</code><code class="p">.</code><code class="n">Headers</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code><code>
</code><code>                         </code><code class="s">"Accept-Language"</code><code class="p">,</code><code>
</code><code>                         </code><code class="n">_cultureService</code><code class="p">.</code><code class="n">CurrentCulture</code><code>
</code><code>                             </code><code class="p">.</code><code class="n">TwoLetterISOLanguageName</code><code class="p">)</code><code class="p">;</code><code>
</code><code>                 </code><code class="p">}</code><code class="p">)</code><code>
</code><code>            </code><code class="p">.</code><code class="n">WithAutomaticReconnect</code><code class="p">(</code><code class="p">)</code><code>
</code><code>            </code><code class="p">.</code><code class="n">AddMessagePackProtocol</code><code class="p">(</code><code class="p">)</code><code>
</code><code>            </code><code class="p">.</code><code class="n">Build</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="n">_hubConnection</code><code class="p">.</code><code class="n">Closed</code><code> </code><code class="p">+</code><code class="p">=</code><code> </code><code class="n">OnHubConnectionClosedAsync</code><code class="p">;</code><code>
</code><code>        </code><code class="n">_hubConnection</code><code class="p">.</code><code class="n">Reconnected</code><code> </code><code class="p">+</code><code class="p">=</code><code> </code><code class="n">OnHubConnectionReconnectedAsync</code><code class="p">;</code><code>
</code><code>        </code><code class="n">_hubConnection</code><code class="p">.</code><code class="n">Reconnecting</code><code> </code><code class="p">+</code><code class="p">=</code><code> </code><code class="n">OnHubConnectionReconnectingAsync</code><code class="p">;</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code>
</code><code>    </code><code class="n">Task</code><code> </code><code class="nf">OnHubConnectionClosedAsync</code><code class="p">(</code><code class="n">Exception</code><code class="p">?</code><code> </code><code class="n">exception</code><code class="p">)</code><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="n">_logger</code><code class="p">.</code><code class="n">LogHubConnectionClosed</code><code class="p">(</code><code class="n">exception</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">Task</code><code class="p">.</code><code class="n">CompletedTask</code><code class="p">;</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code>
</code><code>    </code><code class="n">Task</code><code> </code><code class="nf">OnHubConnectionReconnectedAsync</code><code class="p">(</code><code class="kt">string?</code><code> </code><code class="n">message</code><code class="p">)</code><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="n">_logger</code><code class="p">.</code><code class="n">LogHubConnectionReconnected</code><code class="p">(</code><code class="n">message</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">Task</code><code class="p">.</code><code class="n">CompletedTask</code><code class="p">;</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code>
</code><code>    </code><code class="n">Task</code><code> </code><code class="nf">OnHubConnectionReconnectingAsync</code><code class="p">(</code><code class="n">Exception</code><code class="p">?</code><code> </code><code class="n">exception</code><code class="p">)</code><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="n">_logger</code><code class="p">.</code><code class="n">LogHubConnectionReconnecting</code><code class="p">(</code><code class="n">exception</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">Task</code><code class="p">.</code><code class="n">CompletedTask</code><code class="p">;</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code>
</code><code>    </code><code class="k">async</code><code> </code><code class="n">ValueTask</code><code> </code><code class="n">IAsyncDisposable</code><code class="p">.</code><code class="n">DisposeAsync</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO8-4" id="co_exemplifying_real_time_web_functionality_CO8-4"><img alt="4" src="assets/4.png"/></a><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="p">(</code><code class="n">_hubConnection</code><code> </code><code class="k">is</code><code> </code><code class="n">not</code><code> </code><code class="k">null</code><code class="p">)</code><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="n">_hubConnection</code><code class="p">.</code><code class="n">Closed</code><code> </code><code class="p">-</code><code class="p">=</code><code> </code><code class="n">OnHubConnectionClosedAsync</code><code class="p">;</code><code>
</code><code>            </code><code class="n">_hubConnection</code><code class="p">.</code><code class="n">Reconnected</code><code> </code><code class="p">-</code><code class="p">=</code><code> </code><code class="n">OnHubConnectionReconnectedAsync</code><code class="p">;</code><code>
</code><code>            </code><code class="n">_hubConnection</code><code class="p">.</code><code class="n">Reconnecting</code><code> </code><code class="p">-</code><code class="p">=</code><code> </code><code class="n">OnHubConnectionReconnectingAsync</code><code class="p">;</code><code>
</code><code>
</code><code>            </code><code class="k">await</code><code> </code><code class="n">_hubConnection</code><code class="p">.</code><code class="n">StopAsync</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>            </code><code class="k">await</code><code> </code><code class="n">_hubConnection</code><code class="p">.</code><code class="n">DisposeAsync</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>
</code><code>        </code><code class="n">_lock</code><code class="p">?</code><code class="p">.</code><code class="n">Dispose</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO8-1" id="callout_exemplifying_real_time_web_functionality_CO8-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p><code>SharedHubConnection</code> is a <code>sealed partial class</code>.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO8-2" id="callout_exemplifying_real_time_web_functionality_CO8-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p><code>SharedHubConnection</code> defines several fields that are used to help manage the shared hub connection.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO8-3" id="callout_exemplifying_real_time_web_functionality_CO8-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>SharedHubConnection</code> constructor initializes supporting fields from the defined parameters.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO8-4" id="callout_exemplifying_real_time_web_functionality_CO8-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p><code>SharedHubConnection</code> explicitly implements the <code>IAsyncDisposable.Dispose​A⁠sync</code> method.</p></dd>
</dl>

<p>First off, notice that <code>SharedHubConnection</code> is an implementation of the <code>IAsync​Dis⁠posable</code> interface. This enables the <code>SharedHubConnection</code> class to clean up any managed resources that need to be released asynchronously.</p>

<p>Then the class defines several fields that are <a data-primary="SharedHubConnection" data-secondary="fields" data-type="indexterm" id="idm46365014240560"/>initialized during construction (or inline). They’re described as follows:</p>
<dl>
<dt><code>IServiceProvider _serviceProvider</code></dt>
<dd>
<p>The service provider from the client app.</p>
</dd>
<dt><code>ILogger&lt;SharedHubConnection&gt; _logger</code></dt>
<dd>
<p>A logger instance specific to <code>SharedHubConnection</code>.</p>
</dd>
<dt><code>CultureService _cultureService</code></dt>
<dd>
<p>Used to populate the “Accept-Language” HTTP header for requests made from the hub connection.</p>
</dd>
<dt><code>HubConnection _hubConnection</code></dt>
<dd>
<p>The framework-provided representation of the client’s connection to the server’s hub.</p>
</dd>
<dt><code>SemaphoreSlim _lock</code></dt>
<dd>
<p>An asynchronous locking mechanism used for thread-safe concurrent access. This lock is used in <a data-primary="StartAsync method" data-type="indexterm" id="idm46365014381920"/><a data-primary="methods" data-secondary="StartAsync" data-type="indexterm" id="idm46365014381216"/>the shared <code>StartAsync</code> method command that is detailed later in this chapter.</p>
</dd>
</dl>

<p>The <code>_logger</code> field has access to several custom logging extension methods. These extension methods call into cached delegates created from the framework-provided <code>LoggerMessage.Define</code> factory methods. This is used as a performance optimization to avoid creating a new delegate each time a log message is logged.</p>

<p>The connection state is <a data-primary="SharedHubConnection" data-secondary="states" data-type="indexterm" id="idm46365014464736"/>represented by the underlying <code>HubConnection.State</code> as a calculated property named <code>State</code>. When <code>_hubConnection</code> is <code>null</code>, the state is shown as <code>Disconnected</code>.</p>

<p>Additional states include the following:</p>
<dl>
<dt><code>Connected</code></dt>
<dd>
<p>The client and server are connected.</p>
</dd>
<dt><code>Connecting</code></dt>
<dd>
<p>The connection is being established.</p>
</dd>
<dt><code>Reconnecting</code></dt>
<dd>
<p>The connection is being reconnected.</p>
</dd>
</dl>

<p class="pagebreak-before">Next, the <code>SharedHubConnection</code> constructor assigns several fields from the constructor’s parameters. From the client’s configured options object, the Web API server URL is used along with the <code>"/notifications"</code> route to instantiate the notification hub <code>Uri</code>. The <code>_hubConnection</code> field is instantiated using the builder pattern and the corresponding <code>HubConnectionBuilder</code> object.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="builder-pattern">
<h5>Builder Pattern</h5>
<p>The <em>builder pattern</em> is used to <a data-primary="builder pattern" data-type="indexterm" id="idm46365014226960"/><a data-primary="Build method" data-type="indexterm" id="idm46365014226224"/><a data-primary="methods" data-secondary="Build" data-type="indexterm" id="idm46365014225552"/>construct objects in a way that is more flexible than the traditional constructor pattern. Self-describing methods are strewn fluently together and called on a builder object. The consumer can construct (or <em>build</em>) the object by calling the <code>Build</code> method.</p>
</div></aside>

<p>The hub URL is used with the builder instance, and the hub connection has its options configured through the <code>WithUrl</code> method <a data-primary="WithUrl method overload" data-type="indexterm" id="idm46365014287904"/><a data-primary="methods" data-secondary="WithUrl method overload" data-type="indexterm" id="idm46365014287168"/>overload. <code>AccessTokenProvider</code> is assigned to a delegate used to get the contextual access token asynchronously. The default request HTTP headers are updated, adding the <code>"Accept-Language"</code> header with a value of the currently configured ISO two-letter language name. This ensures that the SignalR server connection knows to return the appropriately localized content to the connected client. The builder configures automatic reconnection and the MessagePack protocol just before calling <code>Build</code>.</p>

<p>Using the <code>_hubConnection</code> instance, the <code>Closed</code>, <code>Reconnected</code>, and <code>Reconnecting</code> events are subscribed to. The various connection states are communicated through these events. Their corresponding event handlers are all fairly similar. The app conditionally logs their occurrence.</p>

<p>Finally, the <code>DisposeAsync</code> functionality unsubscribes from the <code>_hubConnection</code> events and then cascades disposal <a data-primary="SharedHubConnection.cs" data-startref="shbncs" data-type="indexterm" id="idm46365014406448"/>of the connection and the locking mechanism used for synchronization.</p>










<section data-pdf-bookmark="Shared hub connection authentication" data-type="sect3"><div class="sect3" id="idm46365014405216">
<h3>Shared hub connection authentication</h3>

<p>The <code>SharedHubConnection</code> use is <code>partial</code>, and <a data-primary="SharedHubConnection" data-secondary="connection" data-tertiary="authentication" data-type="indexterm" id="shcntc"/><a data-primary="authentication" data-secondary="SharedHubConnection" data-type="indexterm" id="autsbc"/>there are several other implementations to consider. The <code>GetAccessTokenValueAsync</code> delegate was assigned when building the <code>_hubConnection</code> instance, and that <a data-primary="SharedHubConnection.Tokens.cs" data-type="indexterm" id="sbcks"/>functionality is implemented in the <em>SharedHubConnection.Tokens.cs</em> C# file:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code> <code class="nn">Learning.Blazor</code><code class="p">;</code>

<code class="k">public</code> <code class="k">sealed</code> <code class="k">partial</code> <code class="k">class</code> <code class="nc">SharedHubConnection</code>
<code class="p">{</code>
    <code class="k">private</code> <code class="k">async</code> <code class="n">Task</code><code class="p">&lt;</code><code class="kt">string?</code><code class="p">&gt;</code> <code class="n">GetAccessTokenValueAsync</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="k">using</code> <code class="p">(</code><code class="kt">var</code> <code class="n">scope</code> <code class="p">=</code> <code class="n">_serviceProvider</code><code class="p">.</code><code class="n">CreateScope</code><code class="p">())</code>
        <code class="p">{</code>
            <code class="kt">var</code> <code class="n">tokenProvider</code> <code class="p">=</code>
                <code class="n">scope</code><code class="p">.</code><code class="n">ServiceProvider</code>
                    <code class="p">.</code><code class="n">GetRequiredService</code><code class="p">&lt;</code><code class="n">IAccessTokenProvider</code><code class="p">&gt;();</code>
            <code class="kt">var</code> <code class="n">result</code> <code class="p">=</code>
                <code class="k">await</code> <code class="n">tokenProvider</code><code class="p">.</code><code class="n">RequestAccessToken</code><code class="p">();</code>

            <code class="k">if</code> <code class="p">(</code><code class="n">result</code><code class="p">.</code><code class="n">TryGetToken</code><code class="p">(</code><code class="k">out</code> <code class="kt">var</code> <code class="n">accessToken</code><code class="p">))</code>
            <code class="p">{</code>
                <code class="k">return</code> <code class="n">accessToken</code><code class="p">.</code><code class="n">Value</code><code class="p">;</code>
            <code class="p">}</code>

            <code class="n">_logger</code><code class="p">.</code><code class="n">LogUnableToGetAccessToken</code><code class="p">(</code>
                <code class="n">result</code><code class="p">.</code><code class="n">Status</code><code class="p">,</code> <code class="n">result</code><code class="p">.</code><code class="n">RedirectUrl</code><code class="p">);</code>

            <code class="k">return</code> <code class="k">null</code><code class="p">;</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>The <code>SharedHubConnection</code> class was registered as a <a data-primary="SharedHubConnection.Tokens.cs" data-startref="sbcks" data-type="indexterm" id="idm46365014180096"/>singleton, but the framework-provided <code>IAccessTokenProvider</code> is a scoped service. This is why the constructor couldn’t require <code>IAccessTokenProvider</code> directly; instead, it needs <code>IServiceProvider</code>. With the <code>_serviceProvider</code> instance, a call to <code>CreateScope</code> is used to create a scope in which we can resolve <code>IAccessTokenProvider</code>.</p>
<div data-type="tip"><h6>Tip</h6>
<p>Normally, you will not need to use <code>IServiceProvider</code> directly. The <code>SharedHubConnection</code> class is a singleton, and <code>IAccessToken​Pro⁠vider</code> is a scoped service. <code>IServiceProvider</code> is used to resolve 
<span class="keep-together"><code>IAccessTokenProvider</code></span> when the <code>SharedHubConnection</code> object starts communicating with a server.</p>
</div>

<p>With <code>tokenProvider</code>, we call <code>RequestAccessToken</code>. If the <code>result</code> has an access token, it is returned. If <code>GetAccessTokenValueAsync</code> is unable to get <code>accessToken</code>, it is logged, and <code>null</code> is returned. The access token is used to authenticate the connected Blazor client with the <a data-primary="SharedHubConnection" data-secondary="connection" data-startref="shcntc" data-tertiary="authentication" data-type="indexterm" id="idm46365014633344"/><a data-primary="authentication" data-secondary="SharedHubConnection" data-startref="autsbc" data-type="indexterm" id="idm46365014424432"/>server hub.</p>
</div></section>













<section data-pdf-bookmark="Shared hub connection initiation" data-type="sect3"><div class="sect3" id="idm46365014423088">
<h3>Shared hub connection initiation</h3>

<p>Due to the shared nature of this class, the <a data-primary="SharedHubConnection" data-secondary="connection" data-tertiary="initiation" data-type="indexterm" id="shcnit"/><a data-primary="SharedHubConnection.Commands.cs" data-type="indexterm" id="shccs"/>start functionality needs to be implemented in a thread-safe way. Any consumer can safely call <code>StartAsync</code> to initiate the connection from the client to the server. This happens in the <em>SharedHubConnection​.Com⁠mands.cs</em> C# file:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code><code> </code><code class="nn">Learning.Blazor</code><code class="p">;</code><code>
</code><code>
</code><code class="k">public</code><code> </code><code class="k">sealed</code><code> </code><code class="k">partial</code><code> </code><code class="k">class</code><code> </code><code class="nc">SharedHubConnection</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="k">async</code><code> </code><code class="n">Task</code><code> </code><code class="nf">StartAsync</code><code class="p">(</code><code class="n">CancellationToken</code><code> </code><code class="n">token</code><code> </code><code class="p">=</code><code> </code><code class="k">default</code><code class="p">)</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO9-1" id="co_exemplifying_real_time_web_functionality_CO9-1"><img alt="1" src="assets/1.png"/></a><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="k">await</code><code> </code><code class="n">_lock</code><code class="p">.</code><code class="n">WaitAsync</code><code class="p">(</code><code class="n">token</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="k">try</code><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="k">if</code><code> </code><code class="p">(</code><code class="n">State</code><code> </code><code class="k">is</code><code> </code><code class="n">HubConnectionState</code><code class="p">.</code><code class="n">Disconnected</code><code class="p">)</code><code>
</code><code>            </code><code class="p">{</code><code>
</code><code>                </code><code class="k">await</code><code> </code><code class="n">_hubConnection</code><code class="p">.</code><code class="n">StartAsync</code><code class="p">(</code><code class="n">token</code><code class="p">)</code><code class="p">;</code><code>
</code><code>            </code><code class="p">}</code><code>
</code><code>            </code><code class="k">else</code><code>
</code><code>            </code><code class="p">{</code><code>
</code><code>                </code><code class="n">_logger</code><code class="p">.</code><code class="n">LogUnableToStartHubConnection</code><code class="p">(</code><code class="n">State</code><code class="p">)</code><code class="p">;</code><code>
</code><code>            </code><code class="p">}</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>        </code><code class="k">finally</code><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="n">_lock</code><code class="p">.</code><code class="n">Release</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO9-1" id="callout_exemplifying_real_time_web_functionality_CO9-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>StartAsync</code> method defines an optional cancellation <code>token</code>.</p></dd>
</dl>

<p>When a call to <code>StartAsync</code> is <a data-primary="StartAsync method" data-type="indexterm" id="idm46365013836800"/><a data-primary="methods" data-secondary="StartAsync" data-type="indexterm" id="idm46365013836064"/>made, the <code>SemaphoreSlim _lock</code> variable has its <code>WaitAsync</code> method called, which completes when the semaphore is entered. This is an important detail because it alleviates the concerns of multiple components calling <code>StartAsync</code> concurrently by ensuring that all callers execute sequentially. In other words, imagine three components call <code>StartAsync</code> at the same time. This asynchronous locking mechanism ensures that the first component to enter and start <code>_hubConnection</code> is the only component that will call <code>_hubConnection.StartAsync</code>. The other two components will log that they were unable to start the connection to the server’s hub, as it was already <a data-primary="SharedHubConnection" data-secondary="connection" data-startref="shcnit" data-tertiary="initiation" data-type="indexterm" id="idm46365013832208"/><a data-primary="SharedHubConnection.Commands.cs" data-startref="shccs" data-type="indexterm" id="idm46365014500128"/>started.</p>
</div></section>













<section data-pdf-bookmark="Shared hub connection chat" data-type="sect3"><div class="sect3" id="idm46365014499088">
<h3>Shared hub connection chat</h3>

<p>Next, let’s look at how <code>SharedHubConnection</code> implements <a data-primary="SharedHubConnection" data-secondary="chat" data-type="indexterm" id="shcht"/><a data-primary="SharedHubConnection.Chat.cs" data-type="indexterm" id="shcct"/><a data-primary="chat" data-secondary="SharedHubConnection" data-type="indexterm" id="chtsh"/>the chat functionality. You can see how this is defined in the <em>SharedHubConnection.Chat.cs</em> C# file:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code><code> </code><code class="nn">Learning.Blazor</code><code class="p">;</code><code>
</code><code>
</code><code class="k">public</code><code> </code><code class="k">sealed</code><code> </code><code class="k">partial</code><code> </code><code class="k">class</code><code> </code><code class="nc">SharedHubConnection</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="c1">/// &lt;inheritdoc cref="HubClientMethodNames.JoinChat" /&gt;
</code><code>    </code><code class="k">public</code><code> </code><code class="n">Task</code><code> </code><code class="nf">JoinChatAsync</code><code class="p">(</code><code class="kt">string</code><code> </code><code class="n">room</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO10-1" id="co_exemplifying_real_time_web_functionality_CO10-1"><img alt="1" src="assets/1.png"/></a><code>
</code><code>        </code><code class="n">_hubConnection</code><code class="p">.</code><code class="n">InvokeAsync</code><code class="p">(</code><code>
</code><code>            </code><code class="n">methodName</code><code class="p">:</code><code> </code><code class="n">HubClientMethodNames</code><code class="p">.</code><code class="n">JoinChat</code><code class="p">,</code><code> </code><code class="n">room</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="c1">/// &lt;inheritdoc cref="HubClientMethodNames.LeaveChat" /&gt;
</code><code>    </code><code class="k">public</code><code> </code><code class="n">Task</code><code> </code><code class="nf">LeaveChatAsync</code><code class="p">(</code><code class="kt">string</code><code> </code><code class="n">room</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">_hubConnection</code><code class="p">.</code><code class="n">InvokeAsync</code><code class="p">(</code><code>
</code><code>            </code><code class="n">methodName</code><code class="p">:</code><code> </code><code class="n">HubClientMethodNames</code><code class="p">.</code><code class="n">LeaveChat</code><code class="p">,</code><code> </code><code class="n">room</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="c1">/// &lt;inheritdoc cref="HubClientMethodNames.PostOrUpdateMessage" /&gt;
</code><code>    </code><code class="k">public</code><code> </code><code class="n">Task</code><code> </code><code class="nf">PostOrUpdateMessageAsync</code><code class="p">(</code><code>
</code><code>        </code><code class="kt">string</code><code> </code><code class="n">room</code><code class="p">,</code><code> </code><code class="kt">string</code><code> </code><code class="n">message</code><code class="p">,</code><code> </code><code class="n">Guid</code><code class="p">?</code><code> </code><code class="n">id</code><code> </code><code class="p">=</code><code> </code><code class="k">default</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">_hubConnection</code><code class="p">.</code><code class="n">InvokeAsync</code><code class="p">(</code><code>
</code><code>            </code><code class="n">methodName</code><code class="p">:</code><code> </code><code class="n">HubClientMethodNames</code><code class="p">.</code><code class="n">PostOrUpdateMessage</code><code class="p">,</code><code>
</code><code>            </code><code class="n">room</code><code class="p">,</code><code> </code><code class="n">message</code><code class="p">,</code><code> </code><code class="n">id</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="c1">/// &lt;inheritdoc cref="HubClientMethodNames.ToggleUserTyping" /&gt;
</code><code>    </code><code class="k">public</code><code> </code><code class="n">Task</code><code> </code><code class="nf">ToggleUserTypingAsync</code><code class="p">(</code><code class="kt">bool</code><code> </code><code class="n">isTyping</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">_hubConnection</code><code class="p">.</code><code class="n">InvokeAsync</code><code class="p">(</code><code>
</code><code>            </code><code class="n">methodName</code><code class="p">:</code><code> </code><code class="n">HubClientMethodNames</code><code class="p">.</code><code class="n">ToggleUserTyping</code><code class="p">,</code><code> </code><code class="n">isTyping</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="c1">/// &lt;inheritdoc cref="HubServerEventNames.UserLoggedIn" /&gt;
</code><code>    </code><code class="k">public</code><code> </code><code class="n">IDisposable</code><code> </code><code class="nf">SubscribeToUserLoggedIn</code><code class="p">(</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO10-2" id="co_exemplifying_real_time_web_functionality_CO10-2"><img alt="2" src="assets/2.png"/></a><code>
</code><code>        </code><code class="n">Func</code><code class="p">&lt;</code><code class="n">Notification</code><code class="p">&lt;</code><code class="n">Actor</code><code class="p">&gt;</code><code class="p">,</code><code> </code><code class="n">Task</code><code class="p">&gt;</code><code> </code><code class="n">onUserLoggedIn</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">_hubConnection</code><code class="p">.</code><code class="n">On</code><code class="p">(</code><code>
</code><code>            </code><code class="n">methodName</code><code class="p">:</code><code> </code><code class="n">HubServerEventNames</code><code class="p">.</code><code class="n">UserLoggedIn</code><code class="p">,</code><code>
</code><code>            </code><code class="n">handler</code><code class="p">:</code><code> </code><code class="n">onUserLoggedIn</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="c1">/// &lt;inheritdoc cref="HubServerEventNames.UserLoggedOut" /&gt;
</code><code>    </code><code class="k">public</code><code> </code><code class="n">IDisposable</code><code> </code><code class="nf">SubscribeToUserLoggedOut</code><code class="p">(</code><code>
</code><code>        </code><code class="n">Func</code><code class="p">&lt;</code><code class="n">Notification</code><code class="p">&lt;</code><code class="n">Actor</code><code class="p">&gt;</code><code class="p">,</code><code> </code><code class="n">Task</code><code class="p">&gt;</code><code> </code><code class="n">onUserLoggedOut</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">_hubConnection</code><code class="p">.</code><code class="n">On</code><code class="p">(</code><code>
</code><code>            </code><code class="n">methodName</code><code class="p">:</code><code> </code><code class="n">HubServerEventNames</code><code class="p">.</code><code class="n">UserLoggedOut</code><code class="p">,</code><code>
</code><code>            </code><code class="n">handler</code><code class="p">:</code><code> </code><code class="n">onUserLoggedOut</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="c1">/// &lt;inheritdoc cref="HubServerEventNames.UserTyping" /&gt;
</code><code>    </code><code class="k">public</code><code> </code><code class="n">IDisposable</code><code> </code><code class="nf">SubscribeToUserTyping</code><code class="p">(</code><code>
</code><code>        </code><code class="n">Func</code><code class="p">&lt;</code><code class="n">Notification</code><code class="p">&lt;</code><code class="n">ActorAction</code><code class="p">&gt;</code><code class="p">,</code><code> </code><code class="n">Task</code><code class="p">&gt;</code><code> </code><code class="n">onUserTyping</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">_hubConnection</code><code class="p">.</code><code class="n">On</code><code class="p">(</code><code>
</code><code>            </code><code class="n">methodName</code><code class="p">:</code><code> </code><code class="n">HubServerEventNames</code><code class="p">.</code><code class="n">UserTyping</code><code class="p">,</code><code>
</code><code>            </code><code class="n">handler</code><code class="p">:</code><code> </code><code class="n">onUserTyping</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="c1">/// &lt;inheritdoc cref="HubServerEventNames.MessageReceived" /&gt;
</code><code>    </code><code class="k">public</code><code> </code><code class="n">IDisposable</code><code> </code><code class="nf">SubscribeToMessageReceived</code><code class="p">(</code><code>
</code><code>        </code><code class="n">Func</code><code class="p">&lt;</code><code class="n">Notification</code><code class="p">&lt;</code><code class="n">ActorMessage</code><code class="p">&gt;</code><code class="p">,</code><code> </code><code class="n">Task</code><code class="p">&gt;</code><code> </code><code class="n">onMessageReceived</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">_hubConnection</code><code class="p">.</code><code class="n">On</code><code class="p">(</code><code>
</code><code>            </code><code class="n">methodName</code><code class="p">:</code><code> </code><code class="n">HubServerEventNames</code><code class="p">.</code><code class="n">MessageReceived</code><code class="p">,</code><code>
</code><code>            </code><code class="n">handler</code><code class="p">:</code><code> </code><code class="n">onMessageReceived</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO10-1" id="callout_exemplifying_real_time_web_functionality_CO10-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>JoinChatAsync</code> method is an example of an operation that can be called from the client and invokes a method on the server.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO10-2" id="callout_exemplifying_real_time_web_functionality_CO10-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>SubscribeToUserLoggedIn</code> method is an example of an event that is fired from the server, and clients can listen by subscribing to them.</p></dd>
</dl>

<p class="pagebreak-before">The chat functionality relies on two shared helper classes:</p>
<dl>
<dt><code>HubClientMethodNames</code></dt>
<dd>
<p>Defines method names that are invocable from a connected client on the server</p>
</dd>
<dt><code>HubServerEventNames</code></dt>
<dd>
<p>Defines event names (and parameter details) from the SignalR hub that a client can subscribe to</p>
</dd>
</dl>

<p>The additional functionality is implemented using these classes. Each client method delegates out to a corresponding overload of the <code>_hubConnection.Invoke​A⁠sync</code> method, passing the appropriate method name and arguments. Meanwhile, each server event is subscribed from an assigned function that acts as its callback handler. This is possible using the appropriate <code>_hubConnection.On</code> overload. These subscriptions are represented as an <code>IDisposable</code> that is returned, and it’s the caller’s responsibility to unsubscribe by calling <code>Dispose</code> on any subscriptions it may have made. Consuming components will be able to join and leave chat rooms, post and update messages in said chat rooms, and share whether they’re currently typing. Likewise, these components will be able to receive notifications when another user is typing, <a data-primary="SharedHubConnection" data-secondary="chat" data-startref="shcht" data-type="indexterm" id="idm46365013326288"/><a data-primary="SharedHubConnection.Chat.cs" data-startref="shcct" data-type="indexterm" id="idm46365013325040"/><a data-primary="chat" data-secondary="SharedHubConnection" data-startref="chtsh" data-type="indexterm" id="idm46365013858960"/>when a user has logged in or out, and 
<span class="keep-together">when a message has been received.</span></p>
</div></section>













<section data-pdf-bookmark="Shared hub connection tweets" data-type="sect3"><div class="sect3" id="idm46365013857088">
<h3>Shared hub connection tweets</h3>

<p>The final bit of functionality that is <a data-primary="SharedHubConnection" data-secondary="tweets" data-type="indexterm" id="shtwt"/><a data-primary="SharedHubConnection.Tweets.cs" data-type="indexterm" id="shctw"/><a data-primary="Twitter" data-secondary="SharedHubConnection" data-type="indexterm" id="twsbh"/>implemented in this <code>SharedHubConnection</code> is tweet streaming, and it’s defined in the <em>SharedHubConnection.Tweets.cs</em> C# file:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code><code> </code><code class="nn">Learning.Blazor</code><code class="p">;</code><code>
</code><code>
</code><code class="k">public</code><code> </code><code class="k">sealed</code><code> </code><code class="k">partial</code><code> </code><code class="k">class</code><code> </code><code class="nc">SharedHubConnection</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="c1">/// &lt;inheritdoc cref="HubClientMethodNames.JoinTweets" /&gt;
</code><code>    </code><code class="k">public</code><code> </code><code class="n">Task</code><code> </code><code class="nf">JoinTweetsAsync</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO11-1" id="co_exemplifying_real_time_web_functionality_CO11-1"><img alt="1" src="assets/1.png"/></a><code>
</code><code>        </code><code class="n">_hubConnection</code><code class="p">.</code><code class="n">InvokeAsync</code><code class="p">(</code><code>
</code><code>            </code><code class="n">methodName</code><code class="p">:</code><code> </code><code class="n">HubClientMethodNames</code><code class="p">.</code><code class="n">JoinTweets</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="c1">/// &lt;inheritdoc cref="HubClientMethodNames.LeaveTweets" /&gt;
</code><code>    </code><code class="k">public</code><code> </code><code class="n">Task</code><code> </code><code class="nf">LeaveTweetsAsync</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">_hubConnection</code><code class="p">.</code><code class="n">InvokeAsync</code><code class="p">(</code><code>
</code><code>            </code><code class="n">methodName</code><code class="p">:</code><code> </code><code class="n">HubClientMethodNames</code><code class="p">.</code><code class="n">LeaveTweets</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="c1">/// &lt;inheritdoc cref="HubClientMethodNames.StartTweetStream" /&gt;
</code><code>    </code><code class="k">public</code><code> </code><code class="n">Task</code><code> </code><code class="nf">StartTweetStreamAsync</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">_hubConnection</code><code class="p">.</code><code class="n">InvokeAsync</code><code class="p">(</code><code>
</code><code>            </code><code class="n">methodName</code><code class="p">:</code><code> </code><code class="n">HubClientMethodNames</code><code class="p">.</code><code class="n">StartTweetStream</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="c1">/// &lt;inheritdoc cref="HubServerEventNames.StatusUpdated" /&gt;
</code><code>    </code><code class="k">public</code><code> </code><code class="n">IDisposable</code><code> </code><code class="nf">SubscribeToStatusUpdated</code><code class="p">(</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO11-2" id="co_exemplifying_real_time_web_functionality_CO11-2"><img alt="2" src="assets/2.png"/></a><code>
</code><code>        </code><code class="n">Func</code><code class="p">&lt;</code><code class="n">Notification</code><code class="p">&lt;</code><code class="n">StreamingStatus</code><code class="p">&gt;</code><code class="p">,</code><code> </code><code class="n">Task</code><code class="p">&gt;</code><code> </code><code class="n">onStatusUpdated</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">_hubConnection</code><code class="p">.</code><code class="n">On</code><code class="p">(</code><code>
</code><code>            </code><code class="n">methodName</code><code class="p">:</code><code> </code><code class="n">HubServerEventNames</code><code class="p">.</code><code class="n">StatusUpdated</code><code class="p">,</code><code>
</code><code>            </code><code class="n">handler</code><code class="p">:</code><code> </code><code class="n">onStatusUpdated</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="c1">/// &lt;inheritdoc cref="HubServerEventNames.TweetReceived" /&gt;
</code><code>    </code><code class="k">public</code><code> </code><code class="n">IDisposable</code><code> </code><code class="nf">SubscribeToTweetReceived</code><code class="p">(</code><code>
</code><code>        </code><code class="n">Func</code><code class="p">&lt;</code><code class="n">Notification</code><code class="p">&lt;</code><code class="n">TweetContents</code><code class="p">&gt;</code><code class="p">,</code><code> </code><code class="n">Task</code><code class="p">&gt;</code><code> </code><code class="n">onTweetReceived</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">_hubConnection</code><code class="p">.</code><code class="n">On</code><code class="p">(</code><code>
</code><code>            </code><code class="n">methodName</code><code class="p">:</code><code> </code><code class="n">HubServerEventNames</code><code class="p">.</code><code class="n">TweetReceived</code><code class="p">,</code><code>
</code><code>            </code><code class="n">handler</code><code class="p">:</code><code> </code><code class="n">onTweetReceived</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>    </code><code class="c1">/// &lt;inheritdoc cref="HubServerEventNames.InitialTweetsLoaded" /&gt;
</code><code>    </code><code class="k">public</code><code> </code><code class="n">IDisposable</code><code> </code><code class="nf">SubscribeToTweetsLoaded</code><code class="p">(</code><code>
</code><code>        </code><code class="n">Func</code><code class="p">&lt;</code><code class="n">Notification</code><code class="p">&lt;</code><code class="n">List</code><code class="p">&lt;</code><code class="n">TweetContents</code><code class="p">&gt;</code><code class="p">&gt;</code><code class="p">,</code><code> </code><code class="n">Task</code><code class="p">&gt;</code><code> </code><code class="n">onTweetsLoaded</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>        </code><code class="n">_hubConnection</code><code class="p">.</code><code class="n">On</code><code class="p">(</code><code>
</code><code>            </code><code class="n">methodName</code><code class="p">:</code><code> </code><code class="n">HubServerEventNames</code><code class="p">.</code><code class="n">InitialTweetsLoaded</code><code class="p">,</code><code>
</code><code>            </code><code class="n">handler</code><code class="p">:</code><code> </code><code class="n">onTweetsLoaded</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO11-1" id="callout_exemplifying_real_time_web_functionality_CO11-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <em>Tweet</em> implementation relies on <code>HubClientMethodNames</code> to invoke hub connection methods, given their name and arguments.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO11-2" id="callout_exemplifying_real_time_web_functionality_CO11-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Similarly, <code>HubServerEventNames</code> are used to subscribe to named events from the server, given a handler.</p></dd>
</dl>

<p>By encapsulating the logic for each domain-specific feature, the corresponding 
<span class="keep-together"><code>partial</code></span> implementations of <code>SharedHubConnection</code> expose more meaningful methods to the consumers. The framework-provided <code>HubConnection</code>, while used internally within this class, is abstracted away. Instead, by using <code>SharedHubConnection</code>, a consumer can <a data-primary="SharedHubConnection" data-secondary="tweets" data-startref="shtwt" data-type="indexterm" id="idm46365013153312"/><a data-primary="SharedHubConnection.Tweets.cs" data-startref="shctw" data-type="indexterm" id="idm46365013152032"/><a data-primary="Twitter" data-secondary="SharedHubConnection" data-startref="twsbh" data-type="indexterm" id="idm46365013151120"/>call more explicitly named and meaningful methods.</p>
</div></section>



</div></section>













<section data-pdf-bookmark="Consuming Real-Time Data in Components" data-type="sect2"><div class="sect2" id="idm46365014677104">
<h2>Consuming Real-Time Data in Components</h2>

<p>The only thing that is left to do is <a data-primary="SharedHubConnection" data-secondary="real-time data, components and" data-type="indexterm" id="shcrtc"/><a data-primary="real-time data" data-secondary="SharedHubConnection" data-type="indexterm" id="rttshb"/>to consume the shared hub connection where it’s needed in the consuming components. Each domain-specific feature, whether it’s a small component or a page, will rely on <code>SharedHubConnection</code> to provide the necessary functionality.</p>

<p>The SignalR real-time data <a data-primary="SignalR" data-secondary="real-time data" data-type="indexterm" id="sgrrt"/><a data-primary="real-time data" data-secondary="SignalR and" data-type="indexterm" id="rtdsr"/>powers three of our model app’s components: 
<span class="keep-together"><code>NotificationComponent</code>,</span> <code>Tweets</code>, and <code>Chat</code> pages. The notification system is capable of receiving notifications for the following events:</p>

<ul>
<li>
<p>When a user logs in or out of the app</p>
</li>
<li>
<p>When there’s an important weather alert for your current location, such as a severe weather warning</p>
</li>
<li>
<p>If your email address has been part of a data breach (this refers to the “Have I Been Pwned” functionality of the app), as shown in <a data-type="xref" href="#pwned-notification">Figure 6-4</a></p>
</li>
</ul>

<figure><div class="figure" id="pwned-notification">
<img alt="" src="assets/lblz_0604.png"/>
<h6><span class="label">Figure 6-4. </span>A pwned notification</h6>
</div></figure>

<p>All notifications are dismissible, but only some <a data-primary="notifications, actionable" data-type="indexterm" id="idm46365013094016"/>are actionable. For example, a notification that informs you as to whether you’ve been part of a data breach provides a link. If you decide to follow the link, it will take you to the <code>/pwned</code> subroute in the app that will show you all of the data breaches your email is part of.</p>

<p>The app has a <code>Tweets</code> page dedicated to live Twitter content that’s streamed in real time. We’re going to focus in depth on one of the consuming components. With that knowledge, you will be able to review the others yourself. Let’s take a look at the chat functionality.</p>

<p>The <code>Chat</code> component <a data-primary="@page directive" data-primary-sortas="page directive" data-type="indexterm" id="idm46365013090864"/><a data-primary="directives" data-secondary="@page" data-type="indexterm" id="idm46365013090016"/>defines the <code>@page</code> directive, which means it’s a <em>page</em>. It’s navigable at <a data-primary="Chat.razor" data-type="indexterm" id="ctrzr"/>the <code>/chat</code> route. Consider the <em>Chat.razor</em> file:</p>

<pre data-code-language="html" data-type="programlisting"><code>@page "/chat/{room?}" </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO12-1" id="co_exemplifying_real_time_web_functionality_CO12-1"><img alt="1" src="assets/1.png"/></a><code>
@attribute [Authorize]
@inherits LocalizableComponentBase</code><code class="p">&lt;</code><code class="nt">Chat</code><code class="p">&gt;</code><code>

</code><code class="p">&lt;</code><code class="nt">PageTitle</code><code class="p">&gt;</code><code>
    @Localizer["Chat"]
</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">PageTitle</code><code class="p">&gt;</code><code>

</code><code class="p">&lt;</code><code class="nt">AuthorizeView</code><code class="p">&gt;</code><code>
    @if (User is { Identity: { } } user)
    {
        </code><code class="p">&lt;</code><code class="nt">div</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"is-hidden"</code><code class="p">&gt;</code><code>@user.Identity.Name</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code><code>
    }
</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">AuthorizeView</code><code class="p">&gt;</code><code>

    </code><code class="p">&lt;</code><code class="nt">div</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"columns"</code><code class="p">&gt;</code><code>
        </code><code class="p">&lt;</code><code class="nt">section</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"column is-10 is-offset-1"</code><code class="p">&gt;</code><code>
            </code><code class="p">&lt;</code><code class="nt">div</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"field has-addons"</code><code class="p">&gt;</code><code>
                </code><code class="p">&lt;</code><code class="nt">div</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"control is-fullwidth has-icons-left"</code><code class="p">&gt;</code><code>
                    </code><code class="p">&lt;</code><code class="nt">input</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"input is-large"</code><code> </code><code class="na">spellcheck</code><code class="o">=</code><code class="s">"true"</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO12-2" id="co_exemplifying_real_time_web_functionality_CO12-2"><img alt="2" src="assets/2.png"/></a><code>
                       </code><code class="na">type</code><code class="o">=</code><code class="s">"text"</code><code> </code><code class="na">placeholder</code><code class="o">=</code><code class="s">@Localizer["ChatMessage"]</code><code>
                       </code><code class="err">@</code><code class="na">ref</code><code class="o">=</code><code class="s">"_messageInput"</code><code>
                       </code><code class="err">@</code><code class="na">bind-value</code><code class="o">=</code><code class="s">"@_message"</code><code>
                       </code><code class="err">@</code><code class="na">oninput</code><code class="o">=</code><code class="s">"@InitiateDebounceUserIsTypingAsync"</code><code>
                       </code><code class="err">@</code><code class="na">onkeyup</code><code class="o">=</code><code class="s">"@OnKeyUpAsync"</code><code>
                       </code><code class="na">autocomplete</code><code class="o">=</code><code class="s">"off"</code><code class="p">&gt;</code><code>
                    </code><code class="p">&lt;</code><code class="nt">span</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"icon is-small is-left"</code><code class="p">&gt;</code><code>
                        </code><code class="p">&lt;</code><code class="nt">i</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"fas"</code><code class="p">&gt;</code><code class="ni">&amp;#x1F4AD;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">i</code><code class="p">&gt;</code><code>
                    </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">span</code><code class="p">&gt;</code><code>
                </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code><code>
                </code><code class="p">&lt;</code><code class="nt">div</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"control"</code><code class="p">&gt;</code><code>
                    </code><code class="p">&lt;</code><code class="nt">a</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"button is-info is-large"</code><code>
                        </code><code class="err">@</code><code class="na">onclick</code><code class="o">=</code><code class="s">"@SendMessageAsync"</code><code class="p">&gt;</code><code>
                        @Localizer["Send"]
                    </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">a</code><code class="p">&gt;</code><code>
                </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code><code>
            </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code><code>

            </code><code class="p">&lt;</code><code class="nt">article</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"panel is-info has-dotnet-scrollbar"</code><code class="p">&gt;</code><code>
                </code><code class="p">&lt;</code><code class="nt">p</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"panel-heading has-text-left"</code><code class="p">&gt;</code><code>
                    </code><code class="p">&lt;</code><code class="nt">span</code><code class="p">&gt;</code><code>
                        @Localizer["Messages"]
                    </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">span</code><code class="p">&gt;</code><code>
                    </code><code class="p">&lt;</code><code class="nt">span</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"is-pulled-right"</code><code class="p">&gt;</code><code>
                    @if (TryGetUsersTypingText(out var text)) </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO12-3" id="co_exemplifying_real_time_web_functionality_CO12-3"><img alt="3" src="assets/3.png"/></a><code>
                    {
                        MarkupString isTypingMarkup = new(text);
                        </code><code class="p">&lt;</code><code class="nt">span</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"has-text-grey-light is-strobing"</code><code class="p">&gt;</code><code>
                            @isTypingMarkup
                        </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">span</code><code class="p">&gt;</code><code>
                    }
                </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">span</code><code class="p">&gt;</code><code>
            </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">p</code><code class="p">&gt;</code><code>

            @foreach (var (id, message) in _messages.Reverse()) </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO12-4" id="co_exemplifying_real_time_web_functionality_CO12-4"><img alt="4" src="assets/4.png"/></a><code>
            {
                </code><code class="p">&lt;</code><code class="nt">ChatMessageComponent</code><code> </code><code class="na">Message</code><code class="o">=</code><code class="s">@message</code><code>
                    </code><code class="na">IsEditable</code><code class="o">=</code><code class="s">@(OwnsMessage(message.UserName))</code><code>
                    </code><code class="na">EditMessage</code><code class="o">=</code><code class="s">@OnEditMessageAsync</code><code> </code><code class="p">/</code><code class="p">&gt;</code><code>
            }
        </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">article</code><code class="p">&gt;</code><code>
    </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">section</code><code class="p">&gt;</code><code>
</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">div</code><code class="p">&gt;</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO12-1" id="callout_exemplifying_real_time_web_functionality_CO12-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>Chat</code> page has a route template of <code>"/chat/{room?}"</code>.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO12-2" id="callout_exemplifying_real_time_web_functionality_CO12-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>Each chat room has a single pair of inputs for the chat room message and a send button.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO12-3" id="callout_exemplifying_real_time_web_functionality_CO12-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>When there are one or more users <a data-primary="Chat.razor" data-startref="ctrzr" data-type="indexterm" id="idm46365012789408"/>actively typing, we display specialized messages to indicate this to participants in the chat room.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO12-4" id="callout_exemplifying_real_time_web_functionality_CO12-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>A collection of chat room messages are iterated over and passed to <code>ChatMessageComponent</code>.</p></dd>
</dl>

<p>The <code>Chat</code> page’s route template <a data-primary="Chat page" data-type="indexterm" id="idm46365012817824"/>allows for an optional room parameter. This value is implicitly bound to the component’s corresponding <code>Room</code> property. Route templates are powerful, and we have a lot of flexibility. This allows users of our client app to share and bookmark rooms. They can invite their friends and interact in real time. For more information about route constraints, see Microsoft’s <a href="https://oreil.ly/397Vn">“ASP.NET Core Blazor Routing and Navigation” documentation</a>.</p>

<p>The chat room functionality enables <a data-primary="chat room functionality" data-type="indexterm" id="idm46365012814992"/>users to edit messages they’ve sent; this is a nice feature to have. It lets the chat user fix typos or update what they’re trying to express as needed. Messages are, however, not persisted. This is intentional; every interaction is live, and if you leave, so too do the messages. It imposes an either <em>be in the moment or don’t bother</em> mentality. The progression of sending a message with a typo, from correcting it to sending it, is an interactive experience. To visualize this, see Figures <a data-type="xref" data-xrefstyle="select:labelnumber" href="#chat-room-typo">6-5</a>, <a data-type="xref" data-xrefstyle="select:labelnumber" href="#chat-room-typo-edit">6-6</a>, and <a data-type="xref" data-xrefstyle="select:labelnumber" href="#chat-room-typo-edited">6-7</a>.</p>

<figure><div class="figure" id="chat-room-typo">
<img alt="" src="assets/lblz_0605.png"/>
<h6><span class="label">Figure 6-5. </span>Chat room message typo</h6>
</div></figure>

<figure><div class="figure" id="chat-room-typo-edit">
<img alt="" src="assets/lblz_0606.png"/>
<h6><span class="label">Figure 6-6. </span>Chat room message editing</h6>
</div></figure>

<figure><div class="figure" id="chat-room-typo-edited">
<img alt="" src="assets/lblz_0607.png"/>
<h6><span class="label">Figure 6-7. </span>Chat room message edited</h6>
</div></figure>

<p>Programmatically speaking, not persisting messages makes the app a bit less complex. The primary concern is the user’s ability to interact with the <code>Chat</code> room by creating or updating their chat messages. The user enters their message in <code>&lt;input type="text"&gt;</code> and sends the message using the <code>&lt;a class="button"&gt;</code> HTML elements. <code>input</code> has its native <code>spellcheck</code> attribute set to <code>true</code>. This enables the element to provide help to the user, ensuring the spelling accuracy of their messages. The user can send a message using the Enter key. The send button is an explicit user request, as opposed to the more passive or implicit nature of pressing the Enter key, but they’re functionally equivalent.</p>

<p>As part of the real-time functionality, when the users in the same chat room are typing a message, their client apps are debouncing their input.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46365012771680">
<h5>What’s the Debounce Algorithm?</h5>
<p>The <em>debounce algorithm</em> is a means of programmatically ensuring that only a single event takes action regardless <a data-primary="debounce algorithm" data-type="indexterm" id="idm46365012770048"/>of the number of source events that occur within a set amount of time. For example, if a user is typing a message, the app needs to immediately signify that they’re typing to others in the chat room. If the user continues typing, we do not want to keep sending this message, because it could saturate the network with noise. Instead, we’ll send a cancellation of the user’s typing status after several hundred milliseconds of nontyping.</p>

<p>Most chat apps have this feature nowadays. It’s helpful to know when someone’s responding to your message, but it can also be nerve-racking (or even worse, if the ellipses are canceled and you never receive a message).</p>
</div></aside>

<p>When the user first starts typing, a notification is triggered using SignalR to let interested chat room participants know that the user is typing. Each time they type a nonterminating key, after a specific amount of time like 750 milliseconds or so, the app sends a cancellation. The UX is such that you can see not only that someone in the chat room is typing but also their names. This is depicted in <a data-type="xref" href="#debounce-diagram">Figure 6-8</a>.</p>

<figure><div class="figure" id="debounce-diagram">
<img alt="" src="assets/lblz_0608.png"/>
<h6><span class="label">Figure 6-8. </span>The debounce state machine diagram</h6>
</div></figure>

<p>The <code>Chat</code> page maintains a .NET <code>Dictionary&lt;Guid, ActorMessage&gt;</code> named 
<span class="keep-together"><code>_messages</code>.</span> This collection is tethered to the receiving of SignalR events from 
<span class="keep-together"><code>NotificationHub</code></span> on the server through the generic <code>Notification&lt;T&gt; where T : notnull</code> and <code>T</code> represents the type for the <code>Payload</code> property. When communicated as 
<span class="keep-together"><code>NotificationType.Chat</code>,</span> the <code>T</code> type is <code>ActorMessage</code>. An actor message is used to represent the message from a user and their intent. These messages can reflect a message in multiple ways, whether the user is editing a message or whether the message is a general greeting. The messages are uniquely identifiable and immutable. A message has a sense of ownership in that there’s a username associated with a message. Consider <a data-primary="Actors.cs" data-type="indexterm" id="idm46365012759680"/>the <em>Actors.cs</em> C# file:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code> <code class="nn">Learning.Blazor.Models</code><code class="p">;</code>

<code class="k">public</code> <code class="n">record</code> <code class="k">class</code> <code class="nf">ActorMessage</code><code class="p">(</code>
    <code class="n">Guid</code> <code class="n">Id</code><code class="p">,</code>
    <code class="kt">string</code> <code class="n">Text</code><code class="p">,</code>
    <code class="kt">string</code> <code class="n">UserName</code><code class="p">,</code>
    <code class="kt">bool</code> <code class="n">IsGreeting</code> <code class="p">=</code> <code class="k">false</code><code class="p">,</code>
    <code class="kt">bool</code> <code class="n">IsEdit</code> <code class="p">=</code> <code class="k">false</code><code class="p">)</code> <code class="p">:</code> <code class="n">Actor</code><code class="p">(</code><code class="n">UserName</code><code class="p">);</code>

<code class="k">public</code> <code class="n">record</code> <code class="k">class</code> <code class="nf">ActorAction</code><code class="p">(</code>
    <code class="kt">string</code> <code class="n">UserName</code><code class="p">,</code> <code class="kt">bool</code> <code class="n">IsTyping</code><code class="p">)</code> <code class="p">:</code> <code class="n">Actor</code><code class="p">(</code><code class="n">UserName</code><code class="p">);</code>

<code class="k">public</code> <code class="n">record</code> <code class="k">class</code> <code class="nf">Actor</code><code class="p">(</code>
    <code class="kt">string</code> <code class="n">UserName</code><code class="p">,</code>
    <code class="kt">string</code><code class="p">[]?</code> <code class="n">Emails</code> <code class="p">=</code> <code class="k">null</code><code class="p">);</code></pre>

<p>This file contains three <code>record class</code> definitions: one base <code>Actor</code> and two descendants, <code>ActorAction</code> and <code>ActorMessage</code>. Each <a data-primary="ActorAction" data-type="indexterm" id="idm46365012657408"/><a data-primary="ActorMessage" data-type="indexterm" id="idm46365012656912"/>message in the <code>_messages</code> collection is iterated over in reverse order. This displays the messages in ascending order from the time they were posted, which is common in all chat apps. The <code>ActorAction</code> class sets the user’s typing status to either <code>true</code> or <code>false</code>. These <code>message</code> objects are passed to the custom <code>&lt;ChatMessageComponent&gt;</code>. This component is defined in the <em>ChatMessageComponent.razor</em> file. Let’s have <a data-primary="ChatMessageComponent.razor" data-type="indexterm" id="cmcrz"/>a look at that first:</p>

<pre data-code-language="html" data-type="programlisting"><code class="p">&lt;</code><code class="nt">a</code><code> </code><code class="na">id</code><code class="o">=</code><code class="s">"@Message.Id"</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO13-1" id="co_exemplifying_real_time_web_functionality_CO13-1"><img alt="1" src="assets/1.png"/></a><code>
    </code><code class="na">class</code><code class="o">=</code><code class="s">"panel-block is-size-5 @_dynamicCss"</code><code>
	</code><code class="err">@</code><code class="na">onclick</code><code class="o">=</code><code class="s">@StartEditAsync</code><code class="p">&gt;</code><code>
    </code><code class="p">&lt;</code><code class="nt">span</code><code class="p">&gt;</code><code>
        @Message.UserName
    </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">span</code><code class="p">&gt;</code><code>
    </code><code class="p">&lt;</code><code class="nt">span</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"panel-icon px-4"</code><code class="p">&gt;</code><code>
        </code><code class="p">&lt;</code><code class="nt">i</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"fas fa-chevron-right"</code><code> </code><code class="na">aria-hidden</code><code class="o">=</code><code class="s">"true"</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">i</code><code class="p">&gt;</code><code>
    </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">span</code><code class="p">&gt;</code><code>
    </code><code class="p">&lt;</code><code class="nt">span</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"pl-2"</code><code class="p">&gt;</code><code>
    @{  </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO13-2" id="co_exemplifying_real_time_web_functionality_CO13-2"><img alt="2" src="assets/2.png"/></a><code>
        MarkupString messageMarkup = new(Message.Text);
        </code><code class="p">&lt;</code><code class="nt">span</code><code class="p">&gt;</code><code>
            @messageMarkup
        </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">span</code><code class="p">&gt;</code><code>
        @if (Message.IsEdit)
        {
            </code><code class="p">&lt;</code><code class="nt">span</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"pl-2"</code><code class="p">&gt;</code><code>
                </code><code class="p">&lt;</code><code class="nt">span</code><code> </code><code class="na">class</code><code class="o">=</code><code class="s">"tag is-success-dark"</code><code class="p">&gt;</code><code>edited</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">span</code><code class="p">&gt;</code><code>
            </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">span</code><code class="p">&gt;</code><code>
        }
    }
    </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">span</code><code class="p">&gt;</code><code>
</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">a</code><code class="p">&gt;</code><code>

@code {
    private string _dynamicCss </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO13-3" id="co_exemplifying_real_time_web_functionality_CO13-3"><img alt="3" src="assets/3.png"/></a><code>
    {
        get
        {
            return string.Join(" ", GetStyles()).Trim();

            IEnumerable</code><code class="p">&lt;</code><code class="nt">string</code><code class="p">&gt;</code><code> GetStyles()
            {
                if (!IsEditable)
                    yield return "is-unselectable";

                if (Message.IsGreeting)
                    yield return "greeting";
            };
        }
    }

    [Parameter, EditorRequired]
    public bool IsEditable { get; set; }

    [Parameter, EditorRequired]
    public ActorMessage Message { get; set; } = null!;

    [Parameter, EditorRequired]
    public EventCallback</code><code class="p">&lt;</code><code class="nt">ActorMessage</code><code class="p">&gt;</code><code> EditMessage { get; set; }

    private async Task StartEditAsync() </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO13-4" id="co_exemplifying_real_time_web_functionality_CO13-4"><img alt="4" src="assets/4.png"/></a><code>
    {
        if (IsEditable </code><code class="err">&amp;</code><code class="err">&amp;</code><code> EditMessage.HasDelegate)
        {
            await EditMessage.InvokeAsync(Message);
        }
    }
}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO13-1" id="callout_exemplifying_real_time_web_functionality_CO13-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>Each message is represented as an <code>&lt;a id="@Message.Id"&gt;...&lt;/a&gt;</code> anchor 
<span class="keep-together">element.</span></p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO13-2" id="callout_exemplifying_real_time_web_functionality_CO13-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The framework-provided <code>MarkupString</code> is used to render a C# <code>string</code> as HTML.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO13-3" id="callout_exemplifying_real_time_web_functionality_CO13-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The component dynamically applies a style from the <code>_dynamicCss</code> calculated property.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO13-4" id="callout_exemplifying_real_time_web_functionality_CO13-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The <code>StartEditAsync()</code> method is used to signal to the parent <code>Chat</code> page that this component is editing a message.</p></dd>
</dl>

<p><code>ChatMessageComponent</code> is used to represent a single chat message. If the component is created with <code>IsEditable</code> set to <code>true</code>, the user can edit the message within this component. If a message has <a data-primary="ChatMessageComponent.razor" data-startref="cmcrz" data-type="indexterm" id="idm46365012489120"/>been edited before, it’s appropriately styled to indicate that to the users of the chat room. When the user is not permitted to edit a message, the <code>is-unselectable</code> style is applied.</p>

<p>Next, let’s explore how the <code>Chat</code> page is implemented <a data-primary="Chat.razor.cs" data-type="indexterm" id="ctrzrc"/>as a few C# partial classes. Consider the <em>Chat.razor.cs</em> C# file:</p>

<pre data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code><code> </code><code class="nn">Learning.Blazor.Pages</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="k">sealed</code><code> </code><code class="k">partial</code><code> </code><code class="k">class</code><code> </code><code class="nc">Chat</code><code> </code><code class="p">:</code><code> </code><code class="n">IAsyncDisposable</code><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="k">private</code><code> </code><code class="k">const</code><code> </code><code class="kt">string</code><code> </code><code class="n">DefaultRoomName</code><code> </code><code class="p">=</code><code> </code><code class="s">"public"</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="k">private</code><code> </code><code class="k">readonly</code><code> </code><code class="n">Stack</code><code class="p">&lt;</code><code class="n">IDisposable</code><code class="p">&gt;</code><code> </code><code class="n">_subscriptions</code><code> </code><code class="p">=</code><code> </code><code class="k">new</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO14-1" id="co_exemplifying_real_time_web_functionality_CO14-1"><img alt="1" src="assets/1.png"/></a><code>
</code><code class="na">
        [Parameter]</code><code>
</code><code>        </code><code class="k">public</code><code> </code><code class="kt">string?</code><code> </code><code class="n">Room</code><code> </code><code class="p">{</code><code> </code><code class="k">get</code><code class="p">;</code><code> </code><code class="k">set</code><code class="p">;</code><code> </code><code class="p">}</code><code> </code><code class="p">=</code><code> </code><code class="n">DefaultRoomName</code><code class="p">;</code><code>
</code><code class="na">
        [Inject]</code><code>
</code><code>        </code><code class="k">public</code><code> </code><code class="n">SharedHubConnection</code><code> </code><code class="n">HubConnection</code><code> </code><code class="p">{</code><code> </code><code class="k">get</code><code class="p">;</code><code> </code><code class="k">set</code><code class="p">;</code><code> </code><code class="p">}</code><code> </code><code class="p">=</code><code> </code><code class="k">null</code><code class="p">!</code><code class="p">;</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO14-2" id="co_exemplifying_real_time_web_functionality_CO14-2"><img alt="2" src="assets/2.png"/></a><code>
</code><code>
</code><code>        </code><code class="k">protected</code><code> </code><code class="k">override</code><code> </code><code class="k">async</code><code> </code><code class="n">Task</code><code> </code><code class="nf">OnInitializedAsync</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO14-3" id="co_exemplifying_real_time_web_functionality_CO14-3"><img alt="3" src="assets/3.png"/></a><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="k">await</code><code> </code><code class="k">base</code><code class="p">.</code><code class="n">OnInitializedAsync</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>            </code><code class="n">_subscriptions</code><code class="p">.</code><code class="n">Push</code><code class="p">(</code><code>
</code><code>                </code><code class="n">HubConnection</code><code class="p">.</code><code class="n">SubscribeToMessageReceived</code><code class="p">(</code><code>
</code><code>                    </code><code class="n">OnMessageReceivedAsync</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>            </code><code class="n">_subscriptions</code><code class="p">.</code><code class="n">Push</code><code class="p">(</code><code>
</code><code>                </code><code class="n">HubConnection</code><code class="p">.</code><code class="n">SubscribeToUserTyping</code><code class="p">(</code><code>
</code><code>                    </code><code class="n">OnUserTypingAsync</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>            </code><code class="k">await</code><code> </code><code class="n">HubConnection</code><code class="p">.</code><code class="n">StartAsync</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>            </code><code class="k">await</code><code> </code><code class="n">HubConnection</code><code class="p">.</code><code class="n">JoinChatAsync</code><code class="p">(</code><code>
</code><code>                </code><code class="n">Room</code><code> </code><code class="p">?</code><code class="p">?</code><code> </code><code class="n">DefaultRoomName</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>
</code><code>        </code><code class="k">protected</code><code> </code><code class="k">override</code><code> </code><code class="k">async</code><code> </code><code class="n">Task</code><code> </code><code class="nf">OnAfterRenderAsync</code><code class="p">(</code><code class="kt">bool</code><code> </code><code class="n">firstRender</code><code class="p">)</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO14-4" id="co_exemplifying_real_time_web_functionality_CO14-4"><img alt="4" src="assets/4.png"/></a><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="k">if</code><code> </code><code class="p">(</code><code class="n">firstRender</code><code class="p">)</code><code>
</code><code>            </code><code class="p">{</code><code>
</code><code>                </code><code class="k">await</code><code> </code><code class="n">_messageInput</code><code class="p">.</code><code class="n">FocusAsync</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>            </code><code class="p">}</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>
</code><code>        </code><code class="k">async</code><code> </code><code class="n">ValueTask</code><code> </code><code class="n">IAsyncDisposable</code><code class="p">.</code><code class="n">DisposeAsync</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO14-5" id="co_exemplifying_real_time_web_functionality_CO14-5"><img alt="5" src="assets/5.png"/></a><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="k">if</code><code> </code><code class="p">(</code><code class="n">HubConnection</code><code> </code><code class="k">is</code><code> </code><code class="n">not</code><code> </code><code class="k">null</code><code class="p">)</code><code>
</code><code>            </code><code class="p">{</code><code>
</code><code>                </code><code class="k">await</code><code> </code><code class="n">HubConnection</code><code class="p">.</code><code class="n">LeaveChatAsync</code><code class="p">(</code><code>
</code><code>                    </code><code class="n">Room</code><code> </code><code class="p">?</code><code class="p">?</code><code> </code><code class="n">DefaultRoomName</code><code class="p">)</code><code class="p">;</code><code>
</code><code>            </code><code class="p">}</code><code>
</code><code>
</code><code>            </code><code class="k">while</code><code> </code><code class="p">(</code><code class="n">_subscriptions</code><code class="p">.</code><code class="n">TryPop</code><code class="p">(</code><code class="k">out</code><code> </code><code class="kt">var</code><code> </code><code class="n">disposable</code><code class="p">)</code><code class="p">)</code><code>
</code><code>            </code><code class="p">{</code><code>
</code><code>                </code><code class="n">disposable</code><code class="p">.</code><code class="n">Dispose</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>            </code><code class="p">}</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO14-1" id="callout_exemplifying_real_time_web_functionality_CO14-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The <code>Chat</code> implementation maintains a <code>Stack&lt;IDisposable&gt;</code> named 
<span class="keep-together"><code>_subscriptions</code>.</span></p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO14-2" id="callout_exemplifying_real_time_web_functionality_CO14-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>ShareHubConnection HubConnection</code> property is injected.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO14-3" id="callout_exemplifying_real_time_web_functionality_CO14-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The class provides an <code>override</code> of the <code>OnInitializedAsync</code> method.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO14-4" id="callout_exemplifying_real_time_web_functionality_CO14-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The <code>OnAfterRenderAsync</code> lifecycle event method is used to set the focus on the message input.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO14-5" id="callout_exemplifying_real_time_web_functionality_CO14-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>An explicit implementation of <code>IAsyncDisposable.DisposeAsync</code> performs cleanup.</p></dd>
</dl>

<p>The first implementation <code>partial</code> that we observe of the <code>Chat</code> component class implements <code>IAsyncDisposable</code>. The component exposes a <code>[Parameter] public string? Room</code> property. This is automatically bound (meaning its value is provided by the framework from a corresponding segment in the browser’s URL) to the navigation route. In other words, if the user visits <code>/chat/MyCoolChatRoom</code>, this <code>Room</code> property will have a value of <code>"MyCoolChatRoom"</code>. When there isn’t a room name specified, the default room name of <code>"public"</code> is used.</p>

<p>When the component is initialized, it subscribes <a data-primary="Chat.razor.cs" data-startref="ctrzrc" data-type="indexterm" id="idm46365012162912"/>to the following events:</p>
<dl>
<dt><code>HubConnection.SubscribeToMessageReceived</code></dt>
<dd>
<p>The <code>OnMessageReceivedAsync</code> method is the handler.</p>
</dd>
<dt><code>HubConnection.SubscribeToUserTyping</code></dt>
<dd>
<p>The <code>OnUserTypingAsync</code> method is the handler.</p>
</dd>
</dl>

<p>When the component is disposed of, it will leave the current chat room but issue the appropriate <code>HubConnection.LeaveChatAsync</code> method call. There’s a stack of 
<span class="keep-together"><code>_subscriptions</code></span> that will be unsubscribed from as well. The next <code>Chat</code> implementation <code>partial</code> is defined <a data-primary="Chat.razor.Messages.cs" data-type="indexterm" id="ctrzm"/>in the <em>Chat.razor.Messages.cs</em> C# file:</p>

<pre class="widows_49" data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code><code> </code><code class="nn">Learning.Blazor.Pages</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="k">sealed</code><code> </code><code class="k">partial</code><code> </code><code class="k">class</code><code> </code><code class="nc">Chat</code><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="k">private</code><code> </code><code class="k">readonly</code><code> </code><code class="n">Dictionary</code><code class="p">&lt;</code><code class="n">Guid</code><code class="p">,</code><code> </code><code class="n">ActorMessage</code><code class="p">&gt;</code><code> </code><code class="n">_messages</code><code> </code><code class="p">=</code><code> </code><code class="k">new</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO15-1" id="co_exemplifying_real_time_web_functionality_CO15-1"><img alt="1" src="assets/1.png"/></a><code>
</code><code>
</code><code>        </code><code class="k">private</code><code> </code><code class="n">Guid</code><code class="p">?</code><code> </code><code class="n">_messageId</code><code> </code><code class="p">=</code><code> </code><code class="k">null</code><code class="p">!</code><code class="p">;</code><code>
</code><code>        </code><code class="k">private</code><code> </code><code class="kt">string?</code><code> </code><code class="n">_message</code><code> </code><code class="p">=</code><code> </code><code class="k">null</code><code class="p">!</code><code class="p">;</code><code>
</code><code>        </code><code class="k">private</code><code> </code><code class="kt">bool</code><code> </code><code class="n">_isSending</code><code> </code><code class="p">=</code><code> </code><code class="k">false</code><code class="p">;</code><code>
</code><code>        </code><code class="k">private</code><code> </code><code class="n">ElementReference</code><code> </code><code class="n">_messageInput</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="kt">bool</code><code> </code><code class="nf">OwnsMessage</code><code class="p">(</code><code class="kt">string</code><code> </code><code class="n">user</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">User</code><code class="p">?</code><code class="p">.</code><code class="n">Identity</code><code class="p">?</code><code class="p">.</code><code class="n">Name</code><code> </code><code class="p">=</code><code class="p">=</code><code> </code><code class="n">user</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="n">Task</code><code> </code><code class="nf">OnMessageReceivedAsync</code><code class="p">(</code><code class="n">Notification</code><code class="p">&lt;</code><code class="n">ActorMessage</code><code class="p">&gt;</code><code> </code><code class="n">message</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO15-2" id="co_exemplifying_real_time_web_functionality_CO15-2"><img alt="2" src="assets/2.png"/></a><code>
</code><code>            </code><code class="n">InvokeAsync</code><code class="p">(</code><code>
</code><code>                </code><code class="k">async</code><code> </code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>                </code><code class="p">{</code><code>
</code><code>                    </code><code class="n">_messages</code><code class="p">[</code><code class="n">message</code><code class="p">.</code><code class="n">Payload</code><code class="p">.</code><code class="n">Id</code><code class="p">]</code><code> </code><code class="p">=</code><code> </code><code class="n">message</code><code class="p">;</code><code>
</code><code>
</code><code>                    </code><code class="n">StateHasChanged</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>                    </code><code class="k">await</code><code> </code><code class="n">JavaScript</code><code class="p">.</code><code class="n">ScrollIntoViewAsync</code><code class="p">(</code><code>
</code><code>                        </code><code class="err">$</code><code class="s">"[id='{message.Payload.Id}']"</code><code class="p">)</code><code class="p">;</code><code>
</code><code>                </code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="n">Task</code><code> </code><code class="nf">OnKeyUpAsync</code><code class="p">(</code><code class="n">KeyboardEventArgs</code><code> </code><code class="n">args</code><code class="p">)</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO15-3" id="co_exemplifying_real_time_web_functionality_CO15-3"><img alt="3" src="assets/3.png"/></a><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="k">if</code><code> </code><code class="p">(</code><code class="n">_isSending</code><code class="p">)</code><code>
</code><code>            </code><code class="p">{</code><code>
</code><code>                </code><code class="k">return</code><code> </code><code class="n">Task</code><code class="p">.</code><code class="n">CompletedTask</code><code class="p">;</code><code>
</code><code>            </code><code class="p">}</code><code>
</code><code>
</code><code>            </code><code class="k">return</code><code> </code><code class="n">args</code><code> </code><code class="k">switch</code><code>
</code><code>            </code><code class="p">{</code><code>
</code><code>                </code><code class="p">{</code><code> </code><code class="n">Key</code><code class="p">:</code><code> </code><code class="s">"Enter"</code><code> </code><code class="p">}</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">SendMessageAsync</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code>
</code><code>                </code><code class="n">_</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">Task</code><code class="p">.</code><code class="n">CompletedTask</code><code>
</code><code>            </code><code class="p">}</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>
</code><code>        </code><code class="k">async</code><code> </code><code class="n">Task</code><code> </code><code class="nf">SendMessageAsync</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO15-4" id="co_exemplifying_real_time_web_functionality_CO15-4"><img alt="4" src="assets/4.png"/></a><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="k">if</code><code> </code><code class="p">(</code><code class="n">_isSending</code><code> </code><code class="p">|</code><code class="p">|</code><code> </code><code class="kt">string</code><code class="p">.</code><code class="n">IsNullOrWhiteSpace</code><code class="p">(</code><code class="n">_message</code><code class="p">)</code><code class="p">)</code><code>
</code><code>            </code><code class="p">{</code><code>
</code><code>                </code><code class="k">return</code><code class="p">;</code><code>
</code><code>            </code><code class="p">}</code><code>
</code><code>
</code><code>            </code><code class="k">try</code><code>
</code><code>            </code><code class="p">{</code><code>
</code><code>                </code><code class="n">_isSending</code><code> </code><code class="p">=</code><code> </code><code class="k">true</code><code class="p">;</code><code>
</code><code>
</code><code>                </code><code class="k">await</code><code> </code><code class="n">HubConnection</code><code class="p">.</code><code class="n">PostOrUpdateMessageAsync</code><code class="p">(</code><code>
</code><code>                    </code><code class="n">Room</code><code> </code><code class="p">?</code><code class="p">?</code><code> </code><code class="n">DefaultRoomName</code><code class="p">,</code><code> </code><code class="n">_message</code><code class="p">,</code><code> </code><code class="n">_messageId</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>                </code><code class="n">_message</code><code> </code><code class="p">=</code><code> </code><code class="k">null</code><code class="p">;</code><code>
</code><code>                </code><code class="n">_messageId</code><code> </code><code class="p">=</code><code> </code><code class="k">null</code><code class="p">;</code><code>
</code><code>            </code><code class="p">}</code><code>
</code><code>            </code><code class="k">finally</code><code>
</code><code>            </code><code class="p">{</code><code>
</code><code>                </code><code class="n">_isSending</code><code> </code><code class="p">=</code><code> </code><code class="k">false</code><code class="p">;</code><code>
</code><code>            </code><code class="p">}</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>
</code><code>        </code><code class="k">async</code><code> </code><code class="n">Task</code><code> </code><code class="nf">OnEditMessageAsync</code><code class="p">(</code><code class="n">ActorMessage</code><code> </code><code class="n">message</code><code class="p">)</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO15-5" id="co_exemplifying_real_time_web_functionality_CO15-5"><img alt="5" src="assets/5.png"/></a><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="k">if</code><code> </code><code class="p">(</code><code class="p">!</code><code class="n">OwnsMessage</code><code class="p">(</code><code class="n">message</code><code class="p">.</code><code class="n">UserName</code><code class="p">)</code><code class="p">)</code><code>
</code><code>            </code><code class="p">{</code><code>
</code><code>                </code><code class="k">return</code><code class="p">;</code><code>
</code><code>            </code><code class="p">}</code><code>
</code><code>
</code><code>            </code><code class="n">_messageId</code><code> </code><code class="p">=</code><code> </code><code class="n">message</code><code class="p">.</code><code class="n">Id</code><code class="p">;</code><code>
</code><code>            </code><code class="n">_message</code><code> </code><code class="p">=</code><code> </code><code class="n">message</code><code class="p">.</code><code class="n">Text</code><code class="p">;</code><code>
</code><code>
</code><code>            </code><code class="k">await</code><code> </code><code class="n">_messageInput</code><code class="p">.</code><code class="n">FocusAsync</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist pagebreak-before less_space">
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO15-1" id="callout_exemplifying_real_time_web_functionality_CO15-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p><code>_messages</code> are represented as a collection <a data-primary="key/value pairs (KVPs)" data-type="indexterm" id="idm46365011687136"/>of key/value pairs.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO15-2" id="callout_exemplifying_real_time_web_functionality_CO15-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>OnMessageReceivedAsync</code> method is the event handler for when messages are received from the hub connection.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO15-3" id="callout_exemplifying_real_time_web_functionality_CO15-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>When the user is typing and they lift their key, the <code>OnKeyUpAsync</code> method is fired.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO15-4" id="callout_exemplifying_real_time_web_functionality_CO15-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>To send a message, the <code>SendMessageAsync</code> method is used.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO15-5" id="callout_exemplifying_real_time_web_functionality_CO15-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>When the chat room user owns a message, they can start editing the message with the <code>OnEditMessageAsync</code> method.</p></dd>
</dl>

<p>The <code>Chat/Messages</code> implementation is all about how messages are managed. From the collection of <code>_messages</code> to a single <code>_message</code> and <code>_messageId</code>, this class contains class-scoped fields for maintaining the state of chat messages. The <code>_isSending</code> value is used to signify that a message is being sent. <code>_messageInput</code> is a framework-provided <code>ElementReference</code>. When the component is rendered for the first time, <code>_messageInput</code> is focused on using the <code>FocusAsync</code> extension method.</p>

<p>The <code>Chat.OwnsMessage</code> method accepts a <code>user</code> parameter and compares it to the current user in context. This prevents anyone from editing messages that they don’t have ownership of. When a message is received, the <code>OnMessageReceivedAsync</code> method is called. Since this can happen at any time, the method needs to call <code>StateHasChanged</code>. The <code>_messages</code> collection is updated with the incoming message and a <code>JavaScript</code> call to the <code>ScrollIntoViewAsync</code> method given the <code>Id</code> of the <code>message.Payload</code>. This is a JavaScript interop call using a named extension method pattern.</p>

<p>As the user types their chat messages, the <code>OnKeyUpAsync</code> method is invoked. If the user is currently sending a message as determined by the <code>_isSending</code> bit, it’s a NOOP (a no operation, <a data-primary="Chat.razor.Messages.cs" data-startref="ctrzm" data-type="indexterm" id="idm46365011708880"/>meaning it does nothing). However, when the user presses the Enter key, the message is sent. The <code>SendMessageAsync</code> method early exits if a message is already being sent or if there is no message at all. When there is a message to send, the <code>HubConnection.PostOrUpdateMessageAsync</code> method is called.</p>

<p>If the user decides to edit a message, the <code>OnEditMessageAsync</code> method first ensures that the user owns the message. <code>_message</code> and <code>_messageId</code> are assigned from the message being edited, and focus is returned to the message input. The final bit of <code>Chat</code> functionality is that of the debounce implementation. For that, take <a data-primary="Chat.razor.Debounce.cs" data-type="indexterm" id="crzdbc"/>a look at the <em>Chat.razor.Debounce.cs</em> C# file:</p>

<pre class="widows_13" data-code-language="csharp" data-type="programlisting"><code class="k">namespace</code><code> </code><code class="nn">Learning.Blazor.Pages</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="k">sealed</code><code> </code><code class="k">partial</code><code> </code><code class="k">class</code><code> </code><code class="nc">Chat</code><code>
</code><code>    </code><code class="p">{</code><code>
</code><code>        </code><code class="k">private</code><code> </code><code class="k">readonly</code><code> </code><code class="n">HashSet</code><code class="p">&lt;</code><code class="n">Actor</code><code class="p">&gt;</code><code> </code><code class="n">_usersTyping</code><code> </code><code class="p">=</code><code> </code><code class="k">new</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO16-1" id="co_exemplifying_real_time_web_functionality_CO16-1"><img alt="1" src="assets/1.png"/></a><code>
</code><code>        </code><code class="k">private</code><code> </code><code class="k">readonly</code><code> </code><code class="n">SystemTimerAlias</code><code> </code><code class="n">_debounceTimer</code><code> </code><code class="p">=</code><code> </code><code class="k">new</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="n">Interval</code><code> </code><code class="p">=</code><code> </code><code class="m">750</code><code class="p">,</code><code>
</code><code>            </code><code class="n">AutoReset</code><code> </code><code class="p">=</code><code> </code><code class="k">false</code><code>
</code><code>        </code><code class="p">}</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="k">private</code><code> </code><code class="kt">bool</code><code> </code><code class="n">_isTyping</code><code> </code><code class="p">=</code><code> </code><code class="k">false</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="k">public</code><code> </code><code class="nf">Chat</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO16-2" id="co_exemplifying_real_time_web_functionality_CO16-2"><img alt="2" src="assets/2.png"/></a><code>
</code><code>            </code><code class="n">_debounceTimer</code><code class="p">.</code><code class="n">Elapsed</code><code> </code><code class="p">+</code><code class="p">=</code><code> </code><code class="n">OnDebounceElapsed</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="n">Task</code><code> </code><code class="nf">InitiateDebounceUserIsTypingAsync</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO16-3" id="co_exemplifying_real_time_web_functionality_CO16-3"><img alt="3" src="assets/3.png"/></a><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="n">_debounceTimer</code><code class="p">.</code><code class="n">Stop</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>            </code><code class="n">_debounceTimer</code><code class="p">.</code><code class="n">Start</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>            </code><code class="k">return</code><code> </code><code class="nf">SetIsTypingAsync</code><code class="p">(</code><code class="k">true</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>
</code><code>        </code><code class="n">Task</code><code> </code><code class="nf">OnUserTypingAsync</code><code class="p">(</code><code class="n">Notification</code><code class="p">&lt;</code><code class="n">ActorAction</code><code class="p">&gt;</code><code> </code><code class="n">actorAction</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO16-4" id="co_exemplifying_real_time_web_functionality_CO16-4"><img alt="4" src="assets/4.png"/></a><code>
</code><code>            </code><code class="n">InvokeAsync</code><code class="p">(</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code>
</code><code>            </code><code class="p">{</code><code>
</code><code>                </code><code class="kt">var</code><code> </code><code class="p">(</code><code class="n">_</code><code class="p">,</code><code> </code><code class="p">(</code><code class="n">user</code><code class="p">,</code><code> </code><code class="n">isTyping</code><code class="p">)</code><code class="p">)</code><code> </code><code class="p">=</code><code> </code><code class="n">actorAction</code><code class="p">;</code><code>
</code><code>                </code><code class="n">_</code><code> </code><code class="p">=</code><code> </code><code class="n">isTyping</code><code>
</code><code>                    </code><code class="p">?</code><code> </code><code class="n">_usersTyping</code><code class="p">.</code><code class="n">Add</code><code class="p">(</code><code class="k">new</code><code class="p">(</code><code class="n">user</code><code class="p">)</code><code class="p">)</code><code>
</code><code>                    </code><code class="p">:</code><code> </code><code class="n">_usersTyping</code><code class="p">.</code><code class="n">Remove</code><code class="p">(</code><code class="k">new</code><code class="p">(</code><code class="n">user</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>                </code><code class="n">StateHasChanged</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>            </code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>        </code><code class="n">Task</code><code> </code><code class="nf">SetIsTypingAsync</code><code class="p">(</code><code class="kt">bool</code><code> </code><code class="n">isTyping</code><code class="p">)</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO16-5" id="co_exemplifying_real_time_web_functionality_CO16-5"><img alt="5" src="assets/5.png"/></a><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="k">if</code><code> </code><code class="p">(</code><code class="n">_isTyping</code><code> </code><code class="p">&amp;</code><code class="p">&amp;</code><code> </code><code class="n">isTyping</code><code class="p">)</code><code>
</code><code>            </code><code class="p">{</code><code>
</code><code>                </code><code class="k">return</code><code> </code><code class="n">Task</code><code class="p">.</code><code class="n">CompletedTask</code><code class="p">;</code><code>
</code><code>            </code><code class="p">}</code><code>
</code><code>
</code><code>            </code><code class="k">return</code><code> </code><code class="n">HubConnection</code><code class="p">.</code><code class="n">ToggleUserTypingAsync</code><code class="p">(</code><code>
</code><code>                </code><code class="n">_isTyping</code><code> </code><code class="p">=</code><code> </code><code class="n">isTyping</code><code class="p">)</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>
</code><code>        </code><code class="kt">bool</code><code> </code><code class="nf">TryGetUsersTypingText</code><code class="p">(</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO16-6" id="co_exemplifying_real_time_web_functionality_CO16-6"><img alt="6" src="assets/6.png"/></a><code>
</code><code class="na">            [NotNullWhen(true)]</code><code> </code><code class="k">out</code><code> </code><code class="kt">string?</code><code> </code><code class="n">text</code><code class="p">)</code><code>
</code><code>        </code><code class="p">{</code><code>
</code><code>            </code><code class="kt">var</code><code> </code><code class="n">ut</code><code> </code><code class="p">=</code><code> </code><code class="n">_usersTyping</code><code>
</code><code>                </code><code class="p">?</code><code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">a</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">a</code><code class="p">.</code><code class="n">UserName</code><code class="p">)</code><code>
</code><code>                </code><code class="p">?</code><code class="p">.</code><code class="n">ToArray</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>            </code><code class="n">text</code><code> </code><code class="p">=</code><code> </code><code class="n">ut</code><code class="p">?</code><code class="p">.</code><code class="n">Length</code><code> </code><code class="k">switch</code><code>
</code><code>            </code><code class="p">{</code><code>
</code><code>                </code><code class="m">0</code><code> </code><code class="n">or</code><code> </code><code class="k">null</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="k">null</code><code class="p">,</code><code>
</code><code>                </code><code class="m">1</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">Localizer</code><code class="p">[</code><code class="s">"UserIsTypingFormat"</code><code class="p">,</code><code> </code><code class="n">ut</code><code class="p">[</code><code class="m">0</code><code class="p">]</code><code class="p">]</code><code class="p">,</code><code>
</code><code>                </code><code class="m">2</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">Localizer</code><code class="p">[</code><code class="s">"TwoUsersAreTypingFormat"</code><code class="p">,</code><code> </code><code class="n">ut</code><code class="p">[</code><code class="m">0</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">ut</code><code class="p">[</code><code class="m">1</code><code class="p">]</code><code class="p">]</code><code class="p">,</code><code>
</code><code>                </code><code class="n">_</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">Localizer</code><code class="p">[</code><code class="s">"MultiplePeopleAreTyping"</code><code class="p">]</code><code>
</code><code>            </code><code class="p">}</code><code class="p">;</code><code>
</code><code>
</code><code>            </code><code class="k">return</code><code> </code><code class="n">text</code><code> </code><code class="k">is</code><code> </code><code class="n">not</code><code> </code><code class="k">null</code><code class="p">;</code><code>
</code><code>        </code><code class="p">}</code><code>
</code><code>
</code><code>        </code><code class="k">async</code><code> </code><code class="k">void</code><code> </code><code class="nf">OnDebounceElapsed</code><code class="p">(</code><code class="kt">object?</code><code> </code><code class="n">_</code><code class="p">,</code><code> </code><code class="n">ElapsedEventArgs</code><code> </code><code class="n">e</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_exemplifying_real_time_web_functionality_CO16-7" id="co_exemplifying_real_time_web_functionality_CO16-7"><img alt="7" src="assets/7.png"/></a><code>
</code><code>            </code><code class="k">await</code><code> </code><code class="nf">SetIsTypingAsync</code><code class="p">(</code><code class="k">false</code><code class="p">)</code><code class="p">;</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO16-1" id="callout_exemplifying_real_time_web_functionality_CO16-1"><img alt="1" src="assets/1.png"/></a></dt>
<dd><p>The debounce implementation maintains <code>HashSet&lt;Actor&gt; _usersTyping</code>.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO16-2" id="callout_exemplifying_real_time_web_functionality_CO16-2"><img alt="2" src="assets/2.png"/></a></dt>
<dd><p>The <code>Chat</code> constructor wires up the <code>_debounceTimer.Elapsed</code> event.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO16-3" id="callout_exemplifying_real_time_web_functionality_CO16-3"><img alt="3" src="assets/3.png"/></a></dt>
<dd><p>The <code>InitiateDebounceUserIsTypingAsync</code> method is responsible for restarting <code>_debounceTimer</code> and calling <code>SetIsTypingAsync</code> with <code>true</code>.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO16-4" id="callout_exemplifying_real_time_web_functionality_CO16-4"><img alt="4" src="assets/4.png"/></a></dt>
<dd><p>The <code>OnUserTypingAsync</code> method handles the event that is fired when people in the chat room are typing.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO16-5" id="callout_exemplifying_real_time_web_functionality_CO16-5"><img alt="5" src="assets/5.png"/></a></dt>
<dd><p>The <code>SetIsTypingAsync</code> method conditionally toggles a value representing the state of whether the user is typing.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO16-6" id="callout_exemplifying_real_time_web_functionality_CO16-6"><img alt="6" src="assets/6.png"/></a></dt>
<dd><p>The <code>TryGetUsersTypingText</code> helper method gets a message to display when users are typing.</p></dd>
<dt><a class="co" href="#co_exemplifying_real_time_web_functionality_CO16-7" id="callout_exemplifying_real_time_web_functionality_CO16-7"><img alt="7" src="assets/7.png"/></a></dt>
<dd><p>After the allotted amount of debounce time, the <code>OnDebounceElapsed</code> method is called, thus clearing the typing status.</p></dd>
</dl>

<p>The <code>Chat/Debounce</code> implementation manages the collection of <code>_usersTyping</code>, <code>_debounceTimer</code> (which comes from the <code>System.Timers.Timer</code> namespace), and a value indicating whether or not the user <code>_isTyping</code>.</p>

<p>When the <code>OnUserTypingAsync</code> method is called, the <code>Notification&lt;ActorAction&gt;</code> parameter provides a value as to whether the user is typing. The user is either added or removed from the <code>_usersTyping</code> collection. The <code>TryGetUsersTypingText</code> helper message relies on the current state of the <code>_usersTyping</code> collection and <code>Localizer</code> to format messages. For example, if my friends Carol and Chad were both typing a <a data-primary="SharedHubConnection" data-secondary="real-time data, components and" data-startref="shcrtc" data-type="indexterm" id="idm46365011199904"/><a data-primary="real-time data" data-secondary="SharedHubConnection" data-startref="rttshb" data-type="indexterm" id="idm46365011198688"/><a data-primary="SignalR" data-secondary="real-time data" data-startref="sgrrt" data-type="indexterm" id="idm46365011150720"/><a data-primary="real-time data" data-secondary="SignalR and" data-startref="rtdsr" data-type="indexterm" id="idm46365011149632"/><a data-primary="Chat.razor.Debounce.cs" data-startref="crzdbc" data-type="indexterm" id="idm46365011148544"/>message, the UI would look similar to <a data-type="xref" href="#chat-room">Figure 6-9</a>.</p>

<figure><div class="figure" id="chat-room">
<img alt="" src="assets/lblz_0609.png"/>
<h6><span class="label">Figure 6-9. </span>The chat room with multiple people typing</h6>
</div></figure>
</div></section>





</div></section>













<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm46365013148352">
<h1>Summary</h1>

<p>In this chapter, you learned how to implement real-time web functionality using ASP.NET Core SignalR. You saw how to cleanly separate domain responsibilities making extensive use of C# partial classes. We walked through the source code for a feature-rich server-side SignalR implementation, complete with <code>Hub</code> and <code>IHub​Con⁠text&lt;T&gt;</code> within a <code>BackgroundService</code>. You learned possible ways to create real-time alerts and notifications, a messaging system for live-user interactions, and a joinable active Twitter stream. Finally, you learned how to consume this data from our Blazor WebAssembly app while focusing on a feature-rich chat app.</p>

<p>In the next chapter, you’ll learn a valid use case for C# source generators. You’ll see how well-known JavaScript Web APIs can be used to source generate extension method implementations, fulfilling JavaScript interop functionality. You’ll learn how this specifically applies to the <code>localStorage</code> JavaScript API.</p>
</div></section>







</div></section></body></html>