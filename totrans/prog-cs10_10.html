<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 10. LINQ" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch_linq">
<h1><span class="label">Chapter 10. </span>LINQ</h1>
<p><a data-primary="LINQ" data-type="indexterm" id="ix_ch10-asciidoc0"/>Language Integrated Query (LINQ) is a powerful collection of C# language features for working with sets of information. It is useful in any application that needs to work with multiple pieces of data (i.e., almost any application). <a data-primary="database access, LINQ and" data-type="indexterm" id="idm45884808633088"/>Although one of its original goals was to provide straightforward access to relational databases, LINQ is applicable to many kinds of information. For example, it can also be used with in-memory object models, HTTP-based information services, JSON, and XML <span class="keep-together">documents.</span> And as we’ll see in <a data-type="xref" href="ch11.xhtml#ch_reactive_extensions">Chapter 11</a>, it can work with live streams of data too.</p>
<p>LINQ is not a single feature. It relies on several language elements that work together. <a data-primary="query expressions" data-secondary="defined" data-type="indexterm" id="idm45884808629968"/>The most conspicuous LINQ-related language feature is the <em>query expression</em>, a form of expression that loosely resembles a database query but that can be used to perform queries against any supported source, including plain old objects. As you’ll see, query expressions rely heavily on some other language features such as lambdas, extension methods, and expression object models.</p>
<p>Language support is only half the story. LINQ needs class libraries to implement a set of querying primitives called <em>LINQ operators</em>. <a data-primary="LINQ providers" data-type="indexterm" id="idm45884808627520"/>Each different kind of data requires its own implementation, and a set of operators for any particular type of information is referred to as a <em>LINQ provider</em>. (These can also be used from Visual Basic and F#, by the way, because those languages support LINQ too.) Microsoft supplies several providers, some built into the runtime libraries and some available as separate NuGet packages. There is a provider for Entity Framework Core for example, an object/relational mapping system for working with databases. The Cosmos DB cloud database (a feature of Microsoft Azure) offers a LINQ provider. And the Reactive Extensions for .NET (Rx) described in <a data-type="xref" href="ch11.xhtml#ch_reactive_extensions">Chapter 11</a> provide LINQ support for live streams of data. In short, LINQ is a widely supported idiom in .NET, and it’s extensible, so you will also find open source and other third-party providers.</p>
<p><a data-primary="LINQ to Objects" data-seealso="LINQ" data-type="indexterm" id="idm45884808625024"/>Most of the examples in this chapter use LINQ to Objects. This is partly because it avoids cluttering the examples with extraneous details such as database or service connections, but there’s a more important reason. LINQ’s introduction in 2007 significantly changed the way I write C#, and that’s entirely because of LINQ to Objects. Although LINQ’s query syntax makes it look like it’s primarily a data access technology, I have found it to be far more valuable than that. Having LINQ’s services available on any collection of objects makes it useful in every part of your code.</p>
<section data-pdf-bookmark="Query Expressions" data-type="sect1"><div class="sect1" id="query_expressions">
<h1>Query Expressions</h1>
<p><a data-primary="LINQ" data-secondary="query expressions" data-type="indexterm" id="ix_ch10-asciidoc1"/><a data-primary="query expressions" data-type="indexterm" id="ix_ch10-asciidoc2"/>The most visible feature of LINQ is the query expression syntax. It’s not the most important—as we’ll see later, it’s entirely possible to use LINQ productively without ever writing a query expression. However, it’s a very natural syntax for many kinds of queries.</p>
<p>At first glance, a query expression loosely resembles a relational database query, but the syntax works with any LINQ provider. <a data-primary="CultureInfo objects" data-type="indexterm" id="ix_ch10-asciidoc3"/><a data-type="xref" href="#a_linq_query_expression">Example 10-1</a> shows a query expression that uses LINQ to Objects to search for certain <code>CultureInfo</code> objects. (A <code>CultureInfo</code> object provides a set of culture-specific information, such as the symbol used for the local currency, what language is spoken, and so on. Some systems call this a <em>locale</em>.) This particular query looks at the character that denotes what would, in English, be called the decimal point. Many countries actually use a comma instead of a period, and in those countries, 100,000 would mean the number 100 written out to three decimal places; in English-speaking cultures, we would normally write this as 100.000. The query expression searches all the cultures known to the system and returns those that use a comma as the decimal separator.</p>
<div data-type="example" id="a_linq_query_expression">
<h5><span class="label">Example 10-1. </span>A LINQ query expression</h5>
<pre data-code-language="csharp" data-type="programlisting">
<strong><code class="n">IEnumerable</code><code class="p">&lt;</code><code class="n">CultureInfo</code><code class="p">&gt;</code><code> </code><code class="n">commaCultures</code><code> </code><code class="p">=</code></strong><code>
</code><code>    </code><strong><code class="k">from</code><code> </code><code class="n">culture</code><code> </code><code class="k">in</code><code> </code><code class="n">CultureInfo</code><code class="p">.</code><code class="n">GetCultures</code><code class="p">(</code><code class="n">CultureTypes</code><code class="p">.</code><code class="n">AllCultures</code><code class="p">)</code></strong><code>
</code><code>    </code><strong><code class="k">where</code><code> </code><code class="n">culture</code><code class="p">.</code><code class="n">NumberFormat</code><code class="p">.</code><code class="n">NumberDecimalSeparator</code><code> </code><code class="p">=</code><code class="p">=</code><code> </code><code class="s">","</code></strong><code>
</code><code>    </code><strong><code class="k">select</code><code> </code><code class="n">culture</code><code class="p">;</code></strong><code>
</code><code>
</code><code class="k">foreach</code><code> </code><code class="p">(</code><code class="n">CultureInfo</code><code> </code><code class="n">culture</code><code> </code><code class="k">in</code><code> </code><code class="n">commaCultures</code><code class="p">)</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">culture</code><code class="p">.</code><code class="n">Name</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="p">}</code></pre></div>
<p>The <code>foreach</code> loop in this example shows the results of the query. On my system, this lists the names of 354 cultures, indicating that slightly under half of the 813 available cultures use a comma, not a decimal point. Of course, I could easily have achieved this without using LINQ. <a data-type="xref" href="#the_non-linq_equivalent">Example 10-2</a> will produce the same results.</p>
<div data-type="example" id="the_non-linq_equivalent">
<h5><span class="label">Example 10-2. </span>The non-LINQ equivalent</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">CultureInfo</code><code class="p">[]</code> <code class="n">allCultures</code> <code class="p">=</code> <code class="n">CultureInfo</code><code class="p">.</code><code class="n">GetCultures</code><code class="p">(</code><code class="n">CultureTypes</code><code class="p">.</code><code class="n">AllCultures</code><code class="p">);</code>
<code class="k">foreach</code> <code class="p">(</code><code class="n">CultureInfo</code> <code class="n">culture</code> <code class="k">in</code> <code class="n">allCultures</code><code class="p">)</code>
<code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="n">culture</code><code class="p">.</code><code class="n">NumberFormat</code><code class="p">.</code><code class="n">NumberDecimalSeparator</code> <code class="p">==</code> <code class="s">","</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">culture</code><code class="p">.</code><code class="n">Name</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>Both examples have eight nonblank lines of code, although if you ignore lines that contain only braces, <a data-type="xref" href="#the_non-linq_equivalent">Example 10-2</a> contains just four, two fewer than <a data-type="xref" href="#a_linq_query_expression">Example 10-1</a>. Then again, if we count statements, the LINQ example has just three, compared to four in the loop-based example. So it’s difficult to argue convincingly that either approach is simpler than the other.</p>
<p>However, <a data-type="xref" href="#a_linq_query_expression">Example 10-1</a> has a significant advantage: the code that decides which items to choose is well separated from the code that decides what to do with those items. <a data-type="xref" href="#the_non-linq_equivalent">Example 10-2</a> intermingles these two concerns: the code that picks the objects is half outside and half inside the loop.</p>
<p>Another difference is that <a data-type="xref" href="#a_linq_query_expression">Example 10-1</a> has a more declarative style: it focuses on what we want, not how to get it. The query expression describes the items we’d like, without mandating that this be achieved in any particular way. For this very simple example, that doesn’t matter much, but for more complex examples, and particularly when using a LINQ provider for database access, it can be very useful to allow the provider a free hand in deciding exactly how to perform the query. <a data-type="xref" href="#the_non-linq_equivalent">Example 10-2</a>’s approach of iterating over everything in a <code>foreach</code> loop and picking the item it wants would be a bad idea if we were talking to a database—you generally want to let the server do this sort of filtering work.</p>
<p><a data-primary="from (LINQ clause)" data-type="indexterm" id="idm45884808481872"/>The query in <a data-type="xref" href="#a_linq_query_expression">Example 10-1</a> has three parts. All query expressions are required to begin with a <code>from</code> clause, which specifies the source of the query. In this case, the source is an array of type <code>CultureInfo[]</code>, returned by the <code>CultureInfo</code> class’s <code>GetCultures</code> method. As well as defining the source for the query, the <code>from</code> clause contains a name, which here is <code>culture</code>. This is called the <em>range variable</em>, and we can use it in the rest of the query to represent a single item from the source. <a data-primary="where (LINQ clause)" data-type="indexterm" id="idm45884808437808"/>Clauses can run many times—the <code>where</code> clause in <a data-type="xref" href="#a_linq_query_expression">Example 10-1</a> runs once for every item in the collection, so the range variable will have a different value each time. This is reminiscent of the iteration variable in a <code>foreach</code> loop. In fact, the overall structure of the <code>from</code> clause is similar—we have the variable that will represent an item from a collection, then the <code>in</code> keyword, then the source for which that variable will represent individual items. Just as a <code>foreach</code> loop’s iteration variable is in scope only inside the loop, the range variable <code>culture</code> is meaningful only inside this query expression.</p>
<div class="note1" data-type="note" epub:type="note"><h6>Note</h6>
<p>Although analogies with <code>foreach</code> can be helpful for understanding the intent of LINQ queries, you shouldn’t take this too literally. For example, not all providers directly execute the expressions in a query. Some LINQ providers convert query expressions into database queries, in which case the C# code in the various expressions inside the query does not run in any conventional sense. So, although it is true to say that the range variable represents a single value from the source, it’s not always true to say that clauses will execute once for every item they process, with the range value taking that item’s value. It happens to be true for <a data-type="xref" href="#a_linq_query_expression">Example 10-1</a> because it uses LINQ to Objects, but it’s not so for all providers.</p>
</div>
<p><a data-primary="where (LINQ clause)" data-type="indexterm" id="idm45884808430384"/>The second part of the query in <a data-type="xref" href="#a_linq_query_expression">Example 10-1</a> is a <code>where</code> clause. This clause is optional, or if you want, you can have several in one query. A <code>where</code> clause filters the results, and the one in this example states that I want only the <code>CultureInfo</code> objects with a <code>NumberFormat</code> that indicates that the decimal separator is a comma.</p>
<p><a data-primary="group (LINQ clause)" data-type="indexterm" id="idm45884808426704"/><a data-primary="select (LINQ clause)" data-type="indexterm" id="idm45884808425664"/>The final part of the query is a <code>select</code> clause. All query expressions end with either a <code>select</code> clause or a <code>group</code> clause. This determines the final output of the query. This example indicates that we want each <code>CultureInfo</code> object that was not filtered out by the query. The <code>foreach</code> loop in <a data-type="xref" href="#a_linq_query_expression">Example 10-1</a> that shows the results of the query uses only the <code>Name</code> property, so I could have written a query that extracted only that. As <a data-type="xref" href="#extracting_just_one_property_in_a_query">Example 10-3</a> shows, if I do this, I also need to change the loop, because the resulting query now produces strings instead of <code>CultureInfo</code> objects.<a data-startref="ix_ch10-asciidoc3" data-type="indexterm" id="idm45884808419792"/></p>
<div data-type="example" id="extracting_just_one_property_in_a_query">
<h5><span class="label">Example 10-3. </span>Extracting just one property in a query</h5>
<pre data-code-language="csharp" data-type="programlisting">
<code class="n">IEnumerable</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code><code> </code><code class="n">commaCultures</code><code> </code><code class="p">=</code><code>
</code><code>    </code><code class="k">from</code><code> </code><code class="n">culture</code><code> </code><code class="k">in</code><code> </code><code class="n">CultureInfo</code><code class="p">.</code><code class="n">GetCultures</code><code class="p">(</code><code class="n">CultureTypes</code><code class="p">.</code><code class="n">AllCultures</code><code class="p">)</code><code>
</code><code>    </code><code class="k">where</code><code> </code><code class="n">culture</code><code class="p">.</code><code class="n">NumberFormat</code><code class="p">.</code><code class="n">NumberDecimalSeparator</code><code> </code><code class="p">=</code><code class="p">=</code><code> </code><code class="s">","</code><code>
</code><code>    </code><strong><code class="k">select</code><code> </code><code class="n">culture</code><code class="p">.</code><code class="n">Name</code><code class="p">;</code></strong><code>
</code><code>
</code><code class="k">foreach</code><code> </code><code class="p">(</code><code class="kt">string</code><code> </code><code class="n">cultureName</code><code> </code><code class="k">in</code><code> </code><code class="n">commaCultures</code><code class="p">)</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">cultureName</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="p">}</code></pre></div>
<p>This raises a question: in general, what type do query expressions have? In <a data-type="xref" href="#a_linq_query_expression">Example 10-1</a>, <code>commaCultures</code> is an <code>IEnumerable&lt;CultureInfo&gt;</code>; in <a data-type="xref" href="#extracting_just_one_property_in_a_query">Example 10-3</a>, it’s an <code>IEnumerable&lt;string&gt;</code>. The output item type is determined by the final clause of the query—the <code>select</code> or, in some cases, the <code>group</code> clause. However, not all query expressions result in an <code>IEnumerable&lt;T&gt;</code>. It depends on which LINQ provider you use—I’ve ended up with <code>IEnumerable&lt;T&gt;</code> because I’m using LINQ to Objects.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><a data-primary="var keyword" data-secondary="with variables holding LINQ queries" data-type="indexterm" id="idm45884808361184"/>It’s very common to use the <code>var</code> keyword when declaring variables that hold LINQ queries. This is necessary if a <code>select</code> clause produces instances of an anonymous type, because there is no way to write the name of the resulting query’s type. Even if anonymous types are not involved, <code>var</code> is still widely used, and there are two reasons. One is just a matter of consistency: some people feel that because you have to use <code>var</code> for some LINQ queries, you should use it for all of them. Another argument is that LINQ query types often have verbose and ugly names, and <code>var</code> results in less cluttered code. This can be a particularly pressing concern in the strictly limiting confines of a book’s layout, so in many examples in this chapter I have departed from my usual preference for explicit types and have used <code>var</code> to make things fit.</p>
</div>
<p>How did C# know that I wanted to use LINQ to Objects? It’s because I used an array as the source in the <code>from</code> clause. More generally, LINQ to Objects will be used when you specify any <code>IEnumerable&lt;T&gt;</code> as the source, unless a more specialized provider is available. However, this doesn’t really explain how C# discovers the existence of providers in the first place and how it chooses between them. To understand that, you need to know what the compiler does with a query expression.</p>
<section data-pdf-bookmark="How Query Expressions Expand" data-type="sect2"><div class="sect2" id="how_query_expressions_expand">
<h2>How Query Expressions Expand</h2>
<p><a data-primary="query expressions" data-secondary="expansion of" data-type="indexterm" id="ix_ch10-asciidoc4"/>The compiler converts all query expressions into one or more method calls. Once it has done that, the LINQ provider is selected through exactly the same mechanisms that C# uses for any other method call. The compiler does not have any built-in concept of what constitutes a LINQ provider. It just relies on convention. <a data-type="xref" href="#the_effect_of_a_query_expression">Example 10-4</a> shows what the compiler does with the query expression in <a data-type="xref" href="#extracting_just_one_property_in_a_query">Example 10-3</a>.</p>
<div data-type="example" id="the_effect_of_a_query_expression">
<h5><span class="label">Example 10-4. </span>The effect of a query expression</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">IEnumerable</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="n">commaCultures</code> <code class="p">=</code>
    <code class="n">CultureInfo</code><code class="p">.</code><code class="n">GetCultures</code><code class="p">(</code><code class="n">CultureTypes</code><code class="p">.</code><code class="n">AllCultures</code><code class="p">)</code>
    <code class="p">.</code><code class="n">Where</code><code class="p">(</code><code class="n">culture</code> <code class="p">=&gt;</code> <code class="n">culture</code><code class="p">.</code><code class="n">NumberFormat</code><code class="p">.</code><code class="n">NumberDecimalSeparator</code> <code class="p">==</code> <code class="s">","</code><code class="p">)</code>
    <code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">culture</code> <code class="p">=&gt;</code> <code class="n">culture</code><code class="p">.</code><code class="n">Name</code><code class="p">);</code></pre></div>
<p>The <code>Where</code> and <code>Select</code> methods are examples of LINQ operators. A LINQ operator is nothing more than a method that conforms to one of the standard patterns. I’ll describe these patterns later, in <a data-type="xref" href="#standard_linq_operators">“Standard LINQ Operators”</a>.</p>
<p>The code in <a data-type="xref" href="#the_effect_of_a_query_expression">Example 10-4</a> is all one statement, and I’m chaining method calls together—I call the <code>Where</code> method on the return value of <code>GetCultures</code>, and I call the <code>Select</code> method on the return value of <code>Where</code>. The formatting looks a little peculiar, but it’s too long to go on one line; and, even though it’s not terribly elegant, I prefer to put the <code>.</code> at the start of the line when splitting chained calls across multiple lines, because it makes it much easier to see that each new line continues from where the last one left off. Leaving the period at the end of the preceding line looks neater but also makes it much easier to misread the code.</p>
<p>The compiler has turned the <code>where</code> and <code>select</code> clauses’ expressions into lambdas. Notice that the range variable ends up as a parameter in each lambda. This is one example of why you should not take the analogy between query expressions and <span class="keep-together"><code>foreach</code></span> loops too literally. Unlike a <code>foreach</code> iteration variable, the range variable does not exist as a single conventional variable. In the query, it is just an identifier that represents an item from the source, and in expanding the query into method calls, C# may end up creating multiple real variables for a single range variable, like it has with the arguments for the two separate lambdas here.</p>
<p>All query expressions boil down to this sort of thing—chained method calls with lambdas. (This is why we don’t strictly need the query expression syntax—you could write any query using method calls instead.) Some are more complex than others. The expression in <a data-type="xref" href="#a_linq_query_expression">Example 10-1</a> ends up with a simpler structure despite looking almost identical to <a data-type="xref" href="#extracting_just_one_property_in_a_query">Example 10-3</a>. <a data-type="xref" href="#how_trivial_select_clauses_expand">Example 10-5</a> shows how it expands. It turns out that when a query’s <code>select</code> clause just passes the range variable straight through, the compiler interprets that as meaning that we want to pass the results of the preceding clause straight through without further processing, so it doesn’t add a call to <code>Select</code>. (There is one exception to this: if you write a query expression that contains nothing but a <code>from</code> and a <code>select</code> clause, it will generate a call to <code>Select</code> even if the <code>select</code> clause is trivial.)</p>
<div data-type="example" id="how_trivial_select_clauses_expand">
<h5><span class="label">Example 10-5. </span>How trivial <code>select</code> clauses expand</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">IEnumerable</code><code class="p">&lt;</code><code class="n">CultureInfo</code><code class="p">&gt;</code> <code class="n">commaCultures</code> <code class="p">=</code>
    <code class="n">CultureInfo</code><code class="p">.</code><code class="n">GetCultures</code><code class="p">(</code><code class="n">CultureTypes</code><code class="p">.</code><code class="n">AllCultures</code><code class="p">)</code>
    <code class="p">.</code><code class="n">Where</code><code class="p">(</code><code class="n">culture</code> <code class="p">=&gt;</code> <code class="n">culture</code><code class="p">.</code><code class="n">NumberFormat</code><code class="p">.</code><code class="n">NumberDecimalSeparator</code> <code class="p">==</code> <code class="s">","</code><code class="p">);</code></pre></div>
<p><a data-primary="let (LINQ clause)" data-type="indexterm" id="idm45884808230176"/>The compiler has to work harder if you introduce multiple variables within the query’s scope. You can do this with a <code>let</code> clause. <a data-type="xref" href="#query_with_a_let_clause">Example 10-6</a> performs the same job as <a data-type="xref" href="#extracting_just_one_property_in_a_query">Example 10-3</a>, but I’ve introduced a new variable called <code>numFormat</code> to refer to the number format. This makes my <code>where</code> clause shorter and easier to read, and in a more complex query that needed to refer to that format object multiple times, this technique could remove a lot of clutter.</p>
<div data-type="example" id="query_with_a_let_clause">
<h5><span class="label">Example 10-6. </span>Query with a <code>let</code> clause</h5>
<pre data-code-language="csharp" data-type="programlisting">
<code class="n">IEnumerable</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code><code> </code><code class="n">commaCultures</code><code> </code><code class="p">=</code><code>
</code><code>    </code><code class="k">from</code><code> </code><code class="n">culture</code><code> </code><code class="k">in</code><code> </code><code class="n">CultureInfo</code><code class="p">.</code><code class="n">GetCultures</code><code class="p">(</code><code class="n">CultureTypes</code><code class="p">.</code><code class="n">AllCultures</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">let</code><code> </code><code class="n">numFormat</code><code> </code><code class="p">=</code><code> </code><code class="n">culture</code><code class="p">.</code><code class="n">NumberFormat</code></strong><code>
</code><code>    </code><code class="k">where</code><code> </code><code class="n">numFormat</code><code class="p">.</code><code class="n">NumberDecimalSeparator</code><code> </code><code class="p">=</code><code class="p">=</code><code> </code><code class="s">","</code><code>
</code><code>    </code><code class="k">select</code><code> </code><code class="n">culture</code><code class="p">.</code><code class="n">Name</code><code class="p">;</code></pre></div>
<p>When you write a query that introduces additional variables like this, the compiler automatically generates a hidden class with a field for each of the variables so that it can make them all available at every stage. To get the same effect with ordinary method calls, we’d need to do something similar, and an easy way to do that is to introduce an anonymous type to contain them, as <a data-type="xref" href="#multivariable_query_expressions_expand">Example 10-7</a> shows.</p>
<div data-type="example" id="multivariable_query_expressions_expand">
<h5><span class="label">Example 10-7. </span>How multivariable query expressions expand (approximately)</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">IEnumerable</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="n">commaCultures</code> <code class="p">=</code>
    <code class="n">CultureInfo</code><code class="p">.</code><code class="n">GetCultures</code><code class="p">(</code><code class="n">CultureTypes</code><code class="p">.</code><code class="n">AllCultures</code><code class="p">)</code>
    <code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">culture</code> <code class="p">=&gt;</code> <code class="k">new</code> <code class="p">{</code> <code class="n">culture</code><code class="p">,</code> <code class="n">numFormat</code> <code class="p">=</code> <code class="n">culture</code><code class="p">.</code><code class="n">NumberFormat</code> <code class="p">})</code>
    <code class="p">.</code><code class="n">Where</code><code class="p">(</code><code class="n">vars</code> <code class="p">=&gt;</code> <code class="n">vars</code><code class="p">.</code><code class="n">numFormat</code><code class="p">.</code><code class="n">NumberDecimalSeparator</code> <code class="p">==</code> <code class="s">","</code><code class="p">)</code>
    <code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">vars</code> <code class="p">=&gt;</code> <code class="n">vars</code><code class="p">.</code><code class="n">culture</code><code class="p">.</code><code class="n">Name</code><code class="p">);</code></pre></div>
<p>No matter how simple or complex they are, query expressions are nothing more than a specialized syntax for method calls. This suggests how we might go about writing a custom source for a query expression.<a data-startref="ix_ch10-asciidoc4" data-type="indexterm" id="idm45884808097680"/></p>
</div></section>
<section data-pdf-bookmark="Supporting Query Expressions" data-type="sect2"><div class="sect2" id="supporting_query_expressions">
<h2>Supporting Query Expressions</h2>
<p><a data-primary="query expressions" data-secondary="supporting" data-type="indexterm" id="ix_ch10-asciidoc5"/>Because the C# compiler just converts the various clauses of a query expression into method calls, we can write a type that participates in these expressions by defining some suitable methods. To illustrate that the C# compiler really doesn’t care what these methods do, <a data-type="xref" href="#nonsensical_where_and_select">Example 10-8</a> shows a class that makes absolutely no sense but nonetheless keeps C# happy when used from a query expression. The compiler just mechanically converts a query expression into a series of method calls, so if suitable-looking methods exist, the code will compile successfully.<a data-primary="typeof operator" data-secondary="examples of use" data-type="indexterm" id="idm45884808010784"/></p>
<div data-type="example" id="nonsensical_where_and_select">
<h5><span class="label">Example 10-8. </span>Nonsensical <code>Where</code> and <code>Select</code></h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">class</code> <code class="nc">SillyLinqProvider</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="n">SillyLinqProvider</code> <code class="nf">Where</code><code class="p">(</code><code class="n">Func</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="kt">int</code><code class="p">&gt;</code> <code class="n">pred</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"Where invoked"</code><code class="p">);</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="kt">string</code> <code class="n">Select</code><code class="p">&lt;</code><code class="n">T</code><code class="p">&gt;(</code><code class="n">Func</code><code class="p">&lt;</code><code class="n">DateTime</code><code class="p">,</code> <code class="n">T</code><code class="p">&gt;</code> <code class="n">map</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"Select invoked, with type argument {typeof(T)}"</code><code class="p">);</code>
        <code class="k">return</code> <code class="s">"This operator makes no sense"</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>I can use an instance of this class as the source of a query expression. That’s crazy because this class does not in any way represent a collection of data, but the compiler doesn’t care. It just needs certain methods to be present, so if I write the code in <a data-type="xref" href="#a_meaningless_query">Example 10-9</a>, the compiler will be perfectly happy even though the code doesn’t make any sense.</p>
<div data-type="example" id="a_meaningless_query">
<h5><span class="label">Example 10-9. </span>A meaningless query</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">q</code> <code class="p">=</code> <code class="k">from</code> <code class="n">x</code> <code class="k">in</code> <code class="k">new</code> <code class="n">SillyLinqProvider</code><code class="p">()</code>
        <code class="k">where</code> <code class="kt">int</code><code class="p">.</code><code class="n">Parse</code><code class="p">(</code><code class="n">x</code><code class="p">)</code>
        <code class="k">select</code> <code class="n">x</code><code class="p">.</code><code class="n">Hour</code><code class="p">;</code></pre></div>
<p>The compiler converts this into method calls in exactly the same way that it did with the more sensible query in <a data-type="xref" href="#a_linq_query_expression">Example 10-1</a>. <a data-type="xref" href="#how_the_compiler_transforms_the_meaningl">Example 10-10</a> shows the result. If you’re paying close attention, you’ll have noticed that my range variable actually changes type partway through—my <code>Where</code> method requires a delegate that takes a string, so in that first lambda, <code>x</code> is of type <code>string</code>. But my <code>Select</code> method requires its delegate to take a <code>DateTime</code>, so that’s the type of <code>x</code> in that lambda. (And it’s all ultimately irrelevant, because my <code>Where</code> and <code>Select</code> methods don’t even use these lambdas.) Again, this is nonsense, but it shows how mechanically the C# compiler converts queries to method calls.</p>
<div data-type="example" id="how_the_compiler_transforms_the_meaningl">
<h5><span class="label">Example 10-10. </span>How the compiler transforms the meaningless query</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">q</code> <code class="p">=</code> <code class="k">new</code> <code class="n">SillyLinqProvider</code><code class="p">().</code><code class="n">Where</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="kt">int</code><code class="p">.</code><code class="n">Parse</code><code class="p">(</code><code class="n">x</code><code class="p">)).</code><code class="n">Select</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="n">x</code><code class="p">.</code><code class="n">Hour</code><code class="p">);</code></pre></div>
<p>Obviously, it’s not useful to write code that makes no sense. The reason I’m showing you this is to demonstrate that the query expression syntax knows nothing about semantics—the compiler has no particular expectation of what any of the methods it invokes will do. All that it requires is that they accept lambdas as arguments and return something other than <code>void</code>.</p>
<p>Clearly, the real work is happening elsewhere. It’s the LINQ providers themselves that make things happen. So now I’ll outline what we would need to write to make the queries I showed in the first couple of examples work if LINQ to Objects didn’t exist.</p>
<p>You’ve seen how LINQ queries are transformed into code such as that shown in <a data-type="xref" href="#the_effect_of_a_query_expression">Example 10-4</a>, but this isn’t the whole story. The <code>where</code> clause becomes a call to the <code>Where</code> method, but we’re calling it on an array of type <code>CultureInfo[]</code>, a type that does not in fact have a <code>Where</code> method. This works only because LINQ to Objects defines an appropriate extension method. As I showed in <a data-type="xref" href="ch03.xhtml#ch_types">Chapter 3</a>, it’s possible to add new methods to existing types, and LINQ to Objects does that for <code>IEnumerable&lt;T&gt;</code>. (Since most collections implement <code>IEnumerable&lt;T&gt;</code>, this means LINQ to Objects can be used on almost any kind of collection.) To use these extension methods, you need a <code>using</code> directive for the <code>System.Linq</code> namespace; <a data-primary=".NET 6.0" data-primary-sortas="NET 6.0" data-secondary="implicit global usings feature" data-type="indexterm" id="idm45884807832080"/><a data-primary="implicit global usings" data-type="indexterm" id="idm45884807830832"/>in .NET 6.0, newly created projects enable the <em>implicit global usings</em> feature (described in <a data-type="xref" href="ch01.xhtml#namespaces">“Namespaces”</a>), which automatically generates a suitable global <code>using</code> directive for <code>System.Linq</code>, so unless you’ve disabled that feature, or your project was created before .NET 6.0 and has not subsequently enabled that setting, you won’t need to write the directive yourself. (The extension methods are all defined by a static class in that namespace called <code>Enumerable</code>, by the way.) If you attempted to use LINQ without that directive, the compiler would produce this error for the query expression for <a data-type="xref" href="#a_linq_query_expression">Example 10-1</a> or <a data-type="xref" href="#extracting_just_one_property_in_a_query">Example 10-3</a>:</p>
<pre data-type="programlisting">error CS1935: Could not find an implementation of the query pattern for source
type 'CultureInfo[]'.  'Where' not found.  Are you missing required assembly
references or a using directive for 'System.Linq'?</pre>
<p>In general, that error message’s suggestion would be helpful, but in this case, I want to write my own LINQ implementation. <a data-type="xref" href="#a_custom_linq_provider_for_cultureinfo">Example 10-11</a> does this, and I’ve shown the whole source file because extension methods are sensitive to the use of namespaces and <code>using</code> directives. (If you download the examples, you’ll also find that I’ve not enabled implicit global usings for this particular project, just so it’s completely clear what’s happening.) The contents of the <code>Main</code> method should look familiar—this is similar to <a data-type="xref" href="#extracting_just_one_property_in_a_query">Example 10-3</a>, but this time, instead of using the LINQ to Objects provider, it will use the extension methods from my <code>CustomLinqProvider</code> class. (Normally, you make extension methods available with a <code>using</code> directive, but because <code>Cus⁠tom⁠Linq​Pro⁠vid⁠er</code> is in the same namespace as the <code>Program</code> class, all of its extension methods are automatically available to <code>Main</code>.)</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>Although <a data-type="xref" href="#a_custom_linq_provider_for_cultureinfo">Example 10-11</a> behaves as intended, you should not take this as an example of how a LINQ provider normally executes its queries. This does illustrate how LINQ providers put themselves in the picture, but as I’ll show later, there are some issues with how this code goes on to perform the query. Also, it’s rather minimalistic—there’s more to LINQ than <code>Where</code> and <code>Select</code>, and most real providers offer more than just these two operators.</p>
</div>
<div data-type="example" id="a_custom_linq_provider_for_cultureinfo">
<h5><span class="label">Example 10-11. </span>A custom LINQ provider for <code>CultureInfo[]</code></h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">using</code> <code class="nn">System</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">System.Globalization</code><code class="p">;</code>

<code class="k">namespace</code> <code class="nn">CustomLinqExample</code><code class="p">;</code>

<code class="k">public</code> <code class="k">static</code> <code class="k">class</code> <code class="nc">CustomLinqProvider</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">static</code> <code class="n">CultureInfo</code><code class="p">[]</code> <code class="nf">Where</code><code class="p">(</code><code class="k">this</code> <code class="n">CultureInfo</code><code class="p">[]</code> <code class="n">cultures</code><code class="p">,</code>
                                        <code class="n">Predicate</code><code class="p">&lt;</code><code class="n">CultureInfo</code><code class="p">&gt;</code> <code class="n">filter</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="n">Array</code><code class="p">.</code><code class="n">FindAll</code><code class="p">(</code><code class="n">cultures</code><code class="p">,</code> <code class="n">filter</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">static</code> <code class="n">T</code><code class="p">[]</code> <code class="n">Select</code><code class="p">&lt;</code><code class="n">T</code><code class="p">&gt;(</code><code class="k">this</code> <code class="n">CultureInfo</code><code class="p">[]</code> <code class="n">cultures</code><code class="p">,</code>
                                <code class="n">Func</code><code class="p">&lt;</code><code class="n">CultureInfo</code><code class="p">,</code> <code class="n">T</code><code class="p">&gt;</code> <code class="n">map</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="kt">var</code> <code class="n">result</code> <code class="p">=</code> <code class="k">new</code> <code class="n">T</code><code class="p">[</code><code class="n">cultures</code><code class="p">.</code><code class="n">Length</code><code class="p">];</code>
        <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code> <code class="n">i</code> <code class="p">&lt;</code> <code class="n">cultures</code><code class="p">.</code><code class="n">Length</code><code class="p">;</code> <code class="p">++</code><code class="n">i</code><code class="p">)</code>
        <code class="p">{</code>
            <code class="n">result</code><code class="p">[</code><code class="n">i</code><code class="p">]</code> <code class="p">=</code> <code class="n">map</code><code class="p">(</code><code class="n">cultures</code><code class="p">[</code><code class="n">i</code><code class="p">]);</code>
        <code class="p">}</code>
        <code class="k">return</code> <code class="n">result</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="k">class</code> <code class="nc">Program</code>
<code class="p">{</code>
    <code class="k">static</code> <code class="k">void</code> <code class="nf">Main</code><code class="p">(</code><code class="kt">string</code><code class="p">[]</code> <code class="n">args</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="kt">var</code> <code class="n">commaCultures</code> <code class="p">=</code>
            <code class="k">from</code> <code class="n">culture</code> <code class="k">in</code> <code class="n">CultureInfo</code><code class="p">.</code><code class="n">GetCultures</code><code class="p">(</code><code class="n">CultureTypes</code><code class="p">.</code><code class="n">AllCultures</code><code class="p">)</code>
            <code class="k">where</code> <code class="n">culture</code><code class="p">.</code><code class="n">NumberFormat</code><code class="p">.</code><code class="n">NumberDecimalSeparator</code> <code class="p">==</code> <code class="s">","</code>
            <code class="k">select</code> <code class="n">culture</code><code class="p">.</code><code class="n">Name</code><code class="p">;</code>

        <code class="k">foreach</code> <code class="p">(</code><code class="kt">string</code> <code class="n">cultureName</code> <code class="k">in</code> <code class="n">commaCultures</code><code class="p">)</code>
        <code class="p">{</code>
            <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">cultureName</code><code class="p">);</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>As you’re now well aware, the query expression in <code>Main</code> will first call <code>Where</code> on the source and will then call <code>Select</code> on whatever <code>Where</code> returns. As before, the source is the return value of <code>GetCultures</code>, which is an array of type <code>CultureInfo[]</code>. That’s the type for which <code>CustomLinqProvider</code> defines extension methods, so this will invoke <code>CustomLinqProvider.Where</code>. That uses the <code>Array</code> class’s <code>FindAll</code> method to find all of the elements in the source array that match the predicate. The <code>Where</code> method passes its own argument straight through to <code>FindAll</code> as the predicate, and as you know, when the C# compiler calls <code>Where</code>, it passes a lambda based on the expression in the LINQ query’s <code>where</code> clause. That predicate will match the cultures that use a comma as their decimal separator, so the <code>Where</code> clause returns an array of type <code>CultureInfo[]</code> that contains only those cultures.</p>
<p>Next, the code that the compiler created for the query will call <code>Select</code> on the <code>CultureInfo[]</code> array returned by <code>Where</code>. Arrays don’t have a <code>Select</code> method, so the extension method in <code>CustomLinqProvider</code> will be used. My <code>Select</code> method is generic, so the compiler will need to work out what the type argument should be, and it can infer this from the expression in the <code>select</code> clause.</p>
<p>First, the compiler transforms it into a lambda: <code>culture =&gt; culture.Name</code>. Because this becomes the second argument for <code>Select</code>, the compiler knows that we require a <code>Func&lt;CultureInfo, T&gt;</code>, so it knows that the <code>culture</code> parameter must be of type <code>CultureInfo</code>. This enables it to infer that <code>T</code> must be <code>string</code>, because the lambda returns <code>culture.Name</code>, and that <code>Name</code> property’s type is <code>string</code>. So the compiler knows that it is invoking <code>CustomLinqProvider.Select&lt;string&gt;</code>. (The deduction I just described is not specific to query expressions, by the way. The type inference takes place after the query has been transformed into method calls. The compiler would have gone through exactly the same process if we had started with the code in <a data-type="xref" href="#the_effect_of_a_query_expression">Example 10-4</a>.)</p>
<p>The <code>Select</code> method will now produce an array of type <code>string[]</code> (because <code>T</code> is <code>string</code> here). It populates that array by iterating through the elements in the incoming 
<span class="keep-together"><code>CultureInfo[]</code></span>, passing each <code>CultureInfo</code> as the argument to the lambda that extracts the <code>Name</code> property. So we end up with an array of strings, containing the name of each culture that uses a comma as its decimal separator.</p>
<p>That’s a slightly more realistic example than my <code>SillyLinqProvider</code>, because this does now provide the expected behavior. However, although the query produces the same strings as it did when using the real LINQ to Objects provider, the mechanism by which it does so is somewhat different. My <code>CustomLinqProvider</code> performed each operation immediately—the <code>Where</code> and <code>Select</code> methods both returned fully populated arrays. LINQ to Objects does something quite different. In fact, so do most LINQ providers.<a data-startref="ix_ch10-asciidoc5" data-type="indexterm" id="idm45884807525056"/><a data-startref="ix_ch10-asciidoc2" data-type="indexterm" id="idm45884807524352"/><a data-startref="ix_ch10-asciidoc1" data-type="indexterm" id="idm45884807523680"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Deferred Evaluation" data-type="sect1"><div class="sect1" id="deferred_evaluation">
<h1>Deferred Evaluation</h1>
<p><a data-primary="deferred evaluation" data-secondary="LINQ" data-type="indexterm" id="ix_ch10-asciidoc6"/><a data-primary="LINQ" data-secondary="deferred evaluation" data-type="indexterm" id="ix_ch10-asciidoc7"/>If LINQ to Objects worked in the same way as my custom provider in <a data-type="xref" href="#a_custom_linq_provider_for_cultureinfo">Example 10-11</a>, it would not cope well with <a data-type="xref" href="#query_with_an_infinite_source_sequence">Example 10-12</a>. This has a <code>Fibonacci</code> method that returns a never-ending sequence—it will keep providing numbers from the Fibonacci series for as long as the code keeps asking for them. I have used the <code>IEn⁠ume⁠rab⁠le​&lt;Big⁠Inte⁠ger&gt;</code> returned by this method as the source for a query expression. Since we have a <code>using</code> directive for <code>System.Linq</code> in place near the start, I’m back to using LINQ to Objects here. (In the downloadable examples, I’ve disabled implicit global <code>using</code> directives for this project to make it clear exactly which namespaces are in use.)</p>
<div data-type="example" id="query_with_an_infinite_source_sequence">
<h5><span class="label">Example 10-12. </span>Query with an infinite source sequence</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">using</code> <code class="nn">System</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">System.Collections.Generic</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">System.Linq</code><code class="p">;</code>
<code class="k">using</code> <code class="nn">System.Numerics</code><code class="p">;</code>

<code class="k">static</code> <code class="n">IEnumerable</code><code class="p">&lt;</code><code class="n">BigInteger</code><code class="p">&gt;</code> <code class="n">Fibonacci</code><code class="p">()</code>
<code class="p">{</code>
    <code class="n">BigInteger</code> <code class="n">n1</code> <code class="p">=</code> <code class="m">1</code><code class="p">;</code>
    <code class="n">BigInteger</code> <code class="n">n2</code> <code class="p">=</code> <code class="m">1</code><code class="p">;</code>
    <code class="k">yield</code> <code class="k">return</code> <code class="n">n1</code><code class="p">;</code>
    <code class="k">while</code> <code class="p">(</code><code class="k">true</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">yield</code> <code class="k">return</code> <code class="n">n2</code><code class="p">;</code>
        <code class="n">BigInteger</code> <code class="n">t</code> <code class="p">=</code> <code class="n">n1</code> <code class="p">+</code> <code class="n">n2</code><code class="p">;</code>
        <code class="n">n1</code> <code class="p">=</code> <code class="n">n2</code><code class="p">;</code>
        <code class="n">n2</code> <code class="p">=</code> <code class="n">t</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="kt">var</code> <code class="n">evenFib</code> <code class="p">=</code> <code class="k">from</code> <code class="n">n</code> <code class="k">in</code> <code class="n">Fibonacci</code><code class="p">()</code>
              <code class="k">where</code> <code class="n">n</code> <code class="p">%</code> <code class="m">2</code> <code class="p">==</code> <code class="m">0</code>
              <code class="k">select</code> <code class="n">n</code><code class="p">;</code>

<code class="k">foreach</code> <code class="p">(</code><code class="n">BigInteger</code> <code class="n">n</code> <code class="k">in</code> <code class="n">evenFib</code><code class="p">)</code>
<code class="p">{</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">n</code><code class="p">);</code>
<code class="p">}</code></pre></div>
<p>This will use the <code>Where</code> extension method that LINQ to Objects provides for 
<span class="keep-together"><code>IEnumerable&lt;T&gt;</code></span>. If that worked the same way as my <code>CustomLinqExtension</code> class’s <code>Where</code> method for <code>CultureInfo[]</code> in <a data-type="xref" href="#a_custom_linq_provider_for_cultureinfo">Example 10-11</a>, this program would never make it as far as displaying a single number. My <code>Where</code> method did not return until it had filtered the whole of its input and produced a fully populated array as its output. If the LINQ to Objects <code>Where</code> method tried that with my infinite Fibonacci enumerator, it would never <span class="keep-together"> finish.</span></p>
<p>In fact, <a data-type="xref" href="#query_with_an_infinite_source_sequence">Example 10-12</a> works perfectly—it produces a steady stream of output consisting of the Fibonacci numbers that are divisible by 2. This means it can’t be attempting to perform all of the filtering when we call <code>Where</code>. Instead, its <code>Where</code> method returns an <code>IEnumerable&lt;T&gt;</code> that filters items on demand. It won’t try to fetch anything from the input sequence until something asks for a value, at which point it will start retrieving one value after another from the source until the filter delegate says that a match has been found. It then produces that and doesn’t try to retrieve anything more from the source until it is asked for the next item. <a data-type="xref" href="#a_custom_deferred_where_operator">Example 10-13</a> shows how you could implement this behavior by taking advantage of C#’s <code>yield return</code> feature.</p>
<div data-type="example" id="a_custom_deferred_where_operator">
<h5><span class="label">Example 10-13. </span>A custom deferred <code>Where</code> operator</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">static</code> <code class="k">class</code> <code class="nc">CustomDeferredLinqProvider</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">static</code> <code class="n">IEnumerable</code><code class="p">&lt;</code><code class="n">T</code><code class="p">&gt;</code> <code class="n">Where</code><code class="p">&lt;</code><code class="n">T</code><code class="p">&gt;(</code><code class="k">this</code> <code class="n">IEnumerable</code><code class="p">&lt;</code><code class="n">T</code><code class="p">&gt;</code> <code class="n">src</code><code class="p">,</code>
                                          <code class="n">Func</code><code class="p">&lt;</code><code class="n">T</code><code class="p">,</code> <code class="kt">bool</code><code class="p">&gt;</code> <code class="n">filter</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">foreach</code> <code class="p">(</code><code class="n">T</code> <code class="n">item</code> <code class="k">in</code> <code class="n">src</code><code class="p">)</code>
        <code class="p">{</code>
            <code class="k">if</code> <code class="p">(</code><code class="n">filter</code><code class="p">(</code><code class="n">item</code><code class="p">))</code>
            <code class="p">{</code>
                <code class="k">yield</code> <code class="k">return</code> <code class="n">item</code><code class="p">;</code>
            <code class="p">}</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>The real LINQ to Objects implementation of <code>Where</code> is somewhat more complex. It detects certain special cases, such as arrays and lists, and it handles them in a way that is slightly more efficient than the general-purpose implementation that it falls back to for other types. <a data-primary="deferred evaluation" data-secondary="defined" data-type="indexterm" id="idm45884807332336"/>However, the principle is the same for <code>Where</code> and all of the other operators: these methods do not perform the specified work. Instead, they return objects that will perform the work on demand. It’s only when you attempt to retrieve the results of a query that anything really happens. This is called <em>deferred evaluation</em>, or sometimes <em>lazy evaluation</em>.</p>
<p>Deferred evaluation has the benefit of not doing work until you need it, and it makes it possible to work with infinite sequences. However, it also has disadvantages. You may need to be careful to avoid evaluating queries multiple times. <a data-type="xref" href="#accidental_deferred_reevaluation">Example 10-14</a> makes this mistake, causing it to do much more work than necessary. This loops through several different numbers and writes out each one using the currency format of each culture that uses a comma as a decimal separator.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>If you run this on Windows, you may find that most of the lines this code displays will contain <code>?</code> characters, indicating that the console cannot display most of the currency symbols. In fact, it can—it just needs permission. By default, the Windows console uses an 8-bit code page for backward-compatibility reasons. If you run the command <code>chcp 65001</code> from a Command Prompt, it will switch that console window into a UTF-8 code page, enabling it to show any Unicode characters supported by your chosen console font. You might want to configure the console to use a font with comprehensive support for uncommon characters—Consolas or Lucida Console, for example—to take best advantage of that.</p>
</div>
<div data-type="example" id="accidental_deferred_reevaluation">
<h5><span class="label">Example 10-14. </span>Accidental reevaluation of a deferred query</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">commaCultures</code> <code class="p">=</code>
    <code class="k">from</code> <code class="n">culture</code> <code class="k">in</code> <code class="n">CultureInfo</code><code class="p">.</code><code class="n">GetCultures</code><code class="p">(</code><code class="n">CultureTypes</code><code class="p">.</code><code class="n">AllCultures</code><code class="p">)</code>
    <code class="k">where</code> <code class="n">culture</code><code class="p">.</code><code class="n">NumberFormat</code><code class="p">.</code><code class="n">NumberDecimalSeparator</code> <code class="p">==</code> <code class="s">","</code>
    <code class="k">select</code> <code class="n">culture</code><code class="p">;</code>

<code class="kt">object</code><code class="p">[]</code> <code class="n">numbers</code> <code class="p">=</code> <code class="p">{</code> <code class="m">1</code><code class="p">,</code> <code class="m">100</code><code class="p">,</code> <code class="m">100.2</code><code class="p">,</code> <code class="m">10000.2</code> <code class="p">};</code>

<code class="k">foreach</code> <code class="p">(</code><code class="kt">object</code> <code class="n">number</code> <code class="k">in</code> <code class="n">numbers</code><code class="p">)</code>
<code class="p">{</code>
    <code class="k">foreach</code> <code class="p">(</code><code class="n">CultureInfo</code> <code class="n">culture</code> <code class="k">in</code> <code class="n">commaCultures</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="kt">string</code><code class="p">.</code><code class="n">Format</code><code class="p">(</code><code class="n">culture</code><code class="p">,</code> <code class="s">"{0}: {1:c}"</code><code class="p">,</code>
                          <code class="n">culture</code><code class="p">.</code><code class="n">Name</code><code class="p">,</code> <code class="n">number</code><code class="p">));</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>The problem with this code is that even though the <code>commaCultures</code> variable is initialized outside of the number loop, we iterate through it for each number. And because LINQ to Objects uses deferred evaluation, that means that the actual work of running the query is redone every time around the outer loop. So, instead of evaluating that <code>where</code> clause once for each culture (813 times on my system), it ends up running four times for each culture (3,252 times) because the whole query is evaluated once for each of the four items in the <code>numbers</code> array. It’s not a disaster—the code still works correctly. But if you do this in a program that runs on a heavily loaded server, it will harm your throughput.</p>
<p>If you know you will need to iterate through the results of a query multiple times, consider using either the <code>ToList</code> or <code>ToArray</code> extension methods provided by LINQ to Objects. These immediately evaluate the whole query once, producing an <code>IList&lt;T&gt;</code> or a <code>T[]</code> array, respectively (so you shouldn’t use these methods on infinite sequences, obviously). You can then iterate through that as many times as you like without incurring any further costs (beyond the minimal cost inherent in reading array or list elements). But in cases where you iterate through a query only once, it is usually better not to use these methods, as they’ll consume more memory than necessary.<a data-startref="ix_ch10-asciidoc7" data-type="indexterm" id="idm45884807165904"/><a data-startref="ix_ch10-asciidoc6" data-type="indexterm" id="idm45884807165312"/></p>
</div></section>
<section data-pdf-bookmark="LINQ, Generics, and IQueryable&lt;T&gt;" data-type="sect1"><div class="sect1" id="linq_comma_generics_comma_and_iqueryable">
<h1>LINQ, Generics, and IQueryable&lt;T&gt;</h1>
<p><a data-primary="generics" data-secondary="types" data-type="indexterm" id="ix_ch10-asciidoc8"/><a data-primary="IEnumerable&lt;T&gt; interface" data-secondary="LINQ and" data-type="indexterm" id="ix_ch10-asciidoc9"/><a data-primary="IQueryable&lt;T&gt; interface" data-secondary="LINQ and" data-type="indexterm" id="ix_ch10-asciidoc10"/><a data-primary="LINQ" data-secondary="generics and IQueryable&lt;T&gt;" data-type="indexterm" id="ix_ch10-asciidoc11"/>Most LINQ providers use generic types. Nothing enforces this, but it is very common. LINQ to Objects uses <code>IEnumerable&lt;T&gt;</code>. Several of the database providers use a type called <code>IQueryable&lt;T&gt;</code>. More broadly, the pattern is to have some generic type <code><em>Source</em>&lt;T&gt;</code>, where <code><em>Source</em></code> represents some source of items, and <code>T</code> is the type of an individual item. A source type with LINQ support makes operator methods available on <code><em>Source</em>&lt;T&gt;</code> for any <code>T</code>, and those operators also typically return <code><em>Source</em>&lt;TResult&gt;</code>, where <code>TResult</code> may or may not be different than <code>T</code>.</p>
<p><code>IQueryable&lt;T&gt;</code> is interesting because it is designed to be used by multiple providers. <a data-primary="IQueryProvider interface" data-type="indexterm" id="idm45884807119488"/>This interface, its base <code>IQueryable</code>, and the related <code>IQueryProvider</code> are shown in <a data-type="xref" href="#iqueryable_and_iqueryable_of_t">Example 10-15</a>.</p>
<div data-type="example" id="iqueryable_and_iqueryable_of_t">
<h5><span class="label">Example 10-15. </span><code>IQueryable</code> and <code>IQueryable&lt;T&gt;</code></h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">interface</code> <code class="n">IQueryable</code> <code class="p">:</code> <code class="n">IEnumerable</code>
<code class="p">{</code>
    <code class="n">Type</code> <code class="n">ElementType</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="p">}</code>
    <code class="n">Expression</code> <code class="n">Expression</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="p">}</code>
    <code class="n">IQueryProvider</code> <code class="n">Provider</code> <code class="p">{</code> <code class="k">get</code><code class="p">;</code> <code class="p">}</code>
<code class="p">}</code>

<code class="k">public</code> <code class="k">interface</code> <code class="n">IQueryable</code><code class="p">&lt;</code><code class="k">out</code> <code class="n">T</code><code class="p">&gt;</code> <code class="p">:</code> <code class="n">IEnumerable</code><code class="p">&lt;</code><code class="n">T</code><code class="p">&gt;,</code> <code class="n">IQueryable</code>
<code class="p">{</code>
<code class="p">}</code>

<code class="k">public</code> <code class="k">interface</code> <code class="n">IQueryProvider</code>
<code class="p">{</code>
    <code class="n">IQueryable</code> <code class="nf">CreateQuery</code><code class="p">(</code><code class="n">Expression</code> <code class="n">expression</code><code class="p">);</code>
    <code class="n">IQueryable</code><code class="p">&lt;</code><code class="n">TElement</code><code class="p">&gt;</code> <code class="n">CreateQuery</code><code class="p">&lt;</code><code class="n">TElement</code><code class="p">&gt;(</code><code class="n">Expression</code> <code class="n">expression</code><code class="p">);</code>
    <code class="kt">object?</code> <code class="n">Execute</code><code class="p">(</code><code class="n">Expression</code> <code class="n">expression</code><code class="p">);</code>
    <code class="n">TResult</code> <code class="n">Execute</code><code class="p">&lt;</code><code class="n">TResult</code><code class="p">&gt;(</code><code class="n">Expression</code> <code class="n">expression</code><code class="p">);</code>
<code class="p">}</code></pre></div>
<p><a data-primary="Queryable class" data-type="indexterm" id="idm45884807106256"/>The most obvious feature of <code>IQueryable&lt;T&gt;</code> is that it adds no members to its bases. That’s because it’s designed to be used entirely via extension methods. The <code>Sys⁠tem.​Li⁠nq</code> namespace defines all of the standard LINQ operators for <code>IQueryable&lt;T&gt;</code> as extension methods provided by the <code>Queryable</code> class. However, all of these simply defer to the <code>Provider</code> property defined by the <code>IQueryable</code> base. So, unlike LINQ to Objects, where the extension methods on <code>IEnumerable&lt;T&gt;</code> define the behavior, an <code>IQueryable&lt;T&gt;</code> implementation is able to decide how to handle queries because it gets to supply the <code>IQueryProvider</code> that does the real work.</p>
<p>However, all <code>IQueryable&lt;T&gt;</code>-based LINQ providers have one thing in common: they interpret the lambdas as expression objects, not delegates. <a data-type="xref" href="#enumerable_versus_queryable">Example 10-16</a> shows the declaration of the <code>Where</code> extension methods defined for <code>IEnumerable&lt;T&gt;</code> and <code>IQueryable&lt;T&gt;</code>. Compare the <code>predicate</code> parameters.</p>
<div data-type="example" id="enumerable_versus_queryable">
<h5><span class="label">Example 10-16. </span><code>Enumerable</code> versus <code>Queryable</code></h5>
<pre data-code-language="csharp" data-type="programlisting">
<code class="k">public</code><code> </code><code class="k">static</code><code> </code><code class="k">class</code><code> </code><code class="nc">Enumerable</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="k">static</code><code> </code><code class="n">IEnumerable</code><code class="p">&lt;</code><code class="n">TSource</code><code class="p">&gt;</code><code> </code><code class="n">Where</code><code class="p">&lt;</code><code class="n">TSource</code><code class="p">&gt;</code><code class="p">(</code><code>
</code><code>        </code><code class="k">this</code><code> </code><code class="n">IEnumerable</code><code class="p">&lt;</code><code class="n">TSource</code><code class="p">&gt;</code><code> </code><code class="n">source</code><code class="p">,</code><code>
</code><code>        </code><strong><code class="n">Func</code><code class="p">&lt;</code><code class="n">TSource</code><code class="p">,</code><code> </code><code class="kt">bool</code><code class="p">&gt;</code><code> </code><code class="n">predicate</code><code class="p">)</code></strong><code>
</code><code>    </code><code class="p">.</code><code class="p">.</code><code class="p">.</code><code>
</code><code class="p">}</code><code>
</code><code>
</code><code class="k">public</code><code> </code><code class="k">static</code><code> </code><code class="k">class</code><code> </code><code class="nc">Queryable</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">public</code><code> </code><code class="k">static</code><code> </code><code class="n">IQueryable</code><code class="p">&lt;</code><code class="n">TSource</code><code class="p">&gt;</code><code> </code><code class="n">Where</code><code class="p">&lt;</code><code class="n">TSource</code><code class="p">&gt;</code><code class="p">(</code><code>
</code><code>        </code><code class="k">this</code><code> </code><code class="n">IQueryable</code><code class="p">&lt;</code><code class="n">TSource</code><code class="p">&gt;</code><code> </code><code class="n">source</code><code class="p">,</code><code>
</code><code>        </code><strong><code class="n">Expression</code><code class="p">&lt;</code><code class="n">Func</code><code class="p">&lt;</code><code class="n">TSource</code><code class="p">,</code><code> </code><code class="kt">bool</code><code class="p">&gt;</code><code class="p">&gt;</code><code> </code><code class="n">predicate</code><code class="p">)</code></strong><code>
</code><code>    </code><code class="p">.</code><code class="p">.</code><code class="p">.</code><code>
</code><code class="p">}</code></pre></div>
<p>The <code>Where</code> extension for <code>IEnumerable&lt;T&gt;</code> (LINQ to Objects) takes a <code>Func&lt;TSource, bool&gt;</code>, and as you saw in <a data-type="xref" href="ch09.xhtml#ch_delegates_lambdas_events">Chapter 9</a>, this is a delegate type. But the <code>Where</code> extension method for <code>IQueryable&lt;T&gt;</code> (used by numerous LINQ providers) takes <code>Exp⁠res⁠sion​&lt;Fu⁠nc&lt;T⁠Sou⁠rce,⁠ bool&gt;&gt;</code>, and as you also saw in <a data-type="xref" href="ch09.xhtml#ch_delegates_lambdas_events">Chapter 9</a>, this causes the compiler to build an object model of the expression and pass that as the argument.</p>
<p>A LINQ provider typically uses <code>IQueryable&lt;T&gt;</code> if it wants these expression trees. And that’s usually because it’s going to inspect your query and convert it into something else, such as a SQL query.</p>
<p><a data-primary="IOrderedEnumerable&lt;T&gt; interface" data-type="indexterm" id="idm45884806892912"/>There are some other common generic types that crop up in LINQ. Some LINQ features guarantee to produce items in a certain order, and some do not. More subtly, a handful of operators produce items in an order that depends upon the order of their input. This can be reflected in the types for which the operators are defined and the types they return. <a data-primary="IOrderedQueryable&lt;T&gt; interface" data-type="indexterm" id="idm45884806891664"/>LINQ to Objects defines <code>IOrderedEnumerable&lt;T&gt;</code> to represent ordered data, and there’s a corresponding <code>IOrderedQueryable&lt;T&gt;</code> type for <code>IQueryable&lt;T&gt;</code>-based providers. (Providers that use their own types tend to do something similar—Parallel LINQ, described in <a data-type="xref" href="ch16.xhtml#ch_multithreading">Chapter 16</a>, defines an <code>Ord⁠ered​Par⁠all⁠elQ⁠uery&lt;T&gt;</code>, for example.) These interfaces derive from their unordered counterparts, such as <code>IEnumerable&lt;T&gt;</code> and <code>IQueryable&lt;T&gt;</code>, so all the usual operators are available, but they make it possible to define operators or other methods that need to take the existing order of their input into account. For example, in <a data-type="xref" href="#ordering">“Ordering”</a>, I will show a LINQ operator called <code>ThenBy</code>, which is available only on sources that are already ordered.</p>
<p>When looking at LINQ to Objects, this ordered/unordered distinction may seem unnecessary, because <code>IEnumerable&lt;T&gt;</code> always produces items in some sort of order. But some providers do not necessarily do things in any particular order, perhaps because they parallelize query execution, or because they get a database to execute the query for them, and databases reserve the right to meddle with the order in certain cases if it enables them to work more efficiently.<a data-startref="ix_ch10-asciidoc11" data-type="indexterm" id="idm45884806846272"/><a data-startref="ix_ch10-asciidoc10" data-type="indexterm" id="idm45884806845664"/><a data-startref="ix_ch10-asciidoc9" data-type="indexterm" id="idm45884806844992"/><a data-startref="ix_ch10-asciidoc8" data-type="indexterm" id="idm45884806844320"/></p>
</div></section>
<section data-pdf-bookmark="Standard LINQ Operators" data-type="sect1"><div class="sect1" id="standard_linq_operators">
<h1>Standard LINQ Operators</h1>
<p><a data-primary="LINQ" data-secondary="standard operators" data-type="indexterm" id="ix_ch10-asciidoc12"/>In this section, I will describe the standard operators that LINQ providers can supply. Where applicable, I will also describe the query expression equivalent, although many operators do not have a corresponding query expression form. Some LINQ features are available only through explicit method invocation. This is even true with certain operators that can be used in query expressions, because most operators are overloaded, and query expressions can’t use some of the more advanced overloads.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>LINQ operators are not operators in the usual C# sense—they are not symbols such as <code>+</code> or <code>&amp;&amp;</code>. LINQ has its own terminology, and for this chapter, an operator is a query capability offered by a LINQ provider. In C#, it looks like a method.</p>
</div>
<p>All of these operators have something in common: they have all been designed to support composition. This means that you can combine them in almost any way you like, making it possible to build complex queries out of simple elements. To enable this, operators not only take some type representing a set of items (e.g., an 
<span class="keep-together"><code>IEnumerable&lt;T&gt;</code></span>) as their input, but most of them also return something representing a set of items. As already mentioned, the item type is not always the same—an operator might take some <code>IEnumerable&lt;T&gt;</code> as input, and produce <code>IEnumerable&lt;TResult&gt;</code> as output, where <code>TResult</code> does not have to be the same as <code>T</code>. Even so, you can still chain the things together in any number of ways. Part of the reason this works is that LINQ operators are like mathematical functions in that they do not modify their inputs; rather, they produce a new result that is based on their operands. (Functional programming languages typically have the same characteristic.) This means that not only are you free to plug operators together in arbitrary combinations without fear of side effects, but you are also free to use the same source as the input to multiple queries, because no LINQ query will ever modify its input. Each operator returns a new query based on its input.</p>
<p>Nothing enforces this functional style. As you saw with my <code>SillyLinqProvider</code>, the compiler doesn’t care what a method representing a LINQ operator does. However, the convention is that operators are functional, in order to support composition. The built-in LINQ providers all work this way.</p>
<p>Not all providers offer complete support for all operators. The main providers Microsoft supplies—such as LINQ to Objects or the LINQ support in Entity Framework Core and Rx—are as comprehensive as they can be, but there are some situations in which certain operators will not make sense.</p>
<p>To demonstrate the operators in action, I need some source data. Many of the examples in the following sections will use the code in <a data-type="xref" href="#sample_input_data_for_linq_queries">Example 10-17</a>.</p>
<div data-type="example" id="sample_input_data_for_linq_queries">
<h5><span class="label">Example 10-17. </span>Sample input data for LINQ queries</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="n">record</code> <code class="nf">Course</code><code class="p">(</code>
    <code class="kt">string</code> <code class="n">Title</code><code class="p">,</code>
    <code class="kt">string</code> <code class="n">Category</code><code class="p">,</code>
    <code class="kt">int</code> <code class="n">Number</code><code class="p">,</code>
    <code class="n">DateOnly</code> <code class="n">PublicationDate</code><code class="p">,</code>
    <code class="n">TimeSpan</code> <code class="n">Duration</code><code class="p">)</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">static</code> <code class="k">readonly</code> <code class="n">Course</code><code class="p">[]</code> <code class="n">Catalog</code> <code class="p">=</code>
    <code class="p">{</code>
            <code class="k">new</code> <code class="nf">Course</code><code class="p">(</code>
                <code class="n">Title</code><code class="p">:</code> <code class="s">"Elements of Geometry"</code><code class="p">,</code>
                <code class="n">Category</code><code class="p">:</code> <code class="s">"MAT"</code><code class="p">,</code> <code class="n">Number</code><code class="p">:</code> <code class="m">101</code><code class="p">,</code> <code class="n">Duration</code><code class="p">:</code> <code class="n">TimeSpan</code><code class="p">.</code><code class="n">FromHours</code><code class="p">(</code><code class="m">3</code><code class="p">),</code>
                <code class="n">PublicationDate</code><code class="p">:</code> <code class="k">new</code> <code class="n">DateOnly</code><code class="p">(</code><code class="m">2009</code><code class="p">,</code> <code class="m">5</code><code class="p">,</code> <code class="m">20</code><code class="p">)),</code>
            <code class="k">new</code> <code class="nf">Course</code><code class="p">(</code>
                <code class="n">Title</code><code class="p">:</code> <code class="s">"Squaring the Circle"</code><code class="p">,</code>
                <code class="n">Category</code><code class="p">:</code> <code class="s">"MAT"</code><code class="p">,</code> <code class="n">Number</code><code class="p">:</code> <code class="m">102</code><code class="p">,</code> <code class="n">Duration</code><code class="p">:</code> <code class="n">TimeSpan</code><code class="p">.</code><code class="n">FromHours</code><code class="p">(</code><code class="m">7</code><code class="p">),</code>
                <code class="n">PublicationDate</code><code class="p">:</code> <code class="k">new</code> <code class="n">DateOnly</code><code class="p">(</code><code class="m">2009</code><code class="p">,</code> <code class="m">4</code><code class="p">,</code> <code class="m">1</code><code class="p">)),</code>
            <code class="k">new</code> <code class="nf">Course</code><code class="p">(</code>
                <code class="n">Title</code><code class="p">:</code> <code class="s">"Recreational Organ Transplantation"</code><code class="p">,</code>
                <code class="n">Category</code><code class="p">:</code> <code class="s">"BIO"</code><code class="p">,</code> <code class="n">Number</code><code class="p">:</code> <code class="m">305</code><code class="p">,</code> <code class="n">Duration</code><code class="p">:</code> <code class="n">TimeSpan</code><code class="p">.</code><code class="n">FromHours</code><code class="p">(</code><code class="m">4</code><code class="p">),</code>
                <code class="n">PublicationDate</code><code class="p">:</code> <code class="k">new</code> <code class="n">DateOnly</code><code class="p">(</code><code class="m">2002</code><code class="p">,</code> <code class="m">7</code><code class="p">,</code> <code class="m">19</code><code class="p">)),</code>
            <code class="k">new</code> <code class="nf">Course</code><code class="p">(</code>
                <code class="n">Title</code><code class="p">:</code> <code class="s">"Hyperbolic Geometry"</code><code class="p">,</code>
                <code class="n">Category</code><code class="p">:</code> <code class="s">"MAT"</code><code class="p">,</code> <code class="n">Number</code><code class="p">:</code> <code class="m">207</code><code class="p">,</code> <code class="n">Duration</code><code class="p">:</code> <code class="n">TimeSpan</code><code class="p">.</code><code class="n">FromHours</code><code class="p">(</code><code class="m">5</code><code class="p">),</code>
                <code class="n">PublicationDate</code><code class="p">:</code> <code class="k">new</code> <code class="n">DateOnly</code><code class="p">(</code><code class="m">2007</code><code class="p">,</code> <code class="m">10</code><code class="p">,</code> <code class="m">5</code><code class="p">)),</code>
            <code class="k">new</code> <code class="nf">Course</code><code class="p">(</code>
                <code class="n">Title</code><code class="p">:</code> <code class="s">"Oversimplified Data Structures for Demos"</code><code class="p">,</code>
                <code class="n">Category</code><code class="p">:</code> <code class="s">"CSE"</code><code class="p">,</code> <code class="n">Number</code><code class="p">:</code> <code class="m">104</code><code class="p">,</code> <code class="n">Duration</code><code class="p">:</code> <code class="n">TimeSpan</code><code class="p">.</code><code class="n">FromHours</code><code class="p">(</code><code class="m">2</code><code class="p">),</code>
                <code class="n">PublicationDate</code><code class="p">:</code> <code class="k">new</code> <code class="n">DateOnly</code><code class="p">(</code><code class="m">2021</code><code class="p">,</code> <code class="m">11</code><code class="p">,</code> <code class="m">8</code><code class="p">)),</code>
            <code class="k">new</code> <code class="nf">Course</code><code class="p">(</code>
                <code class="n">Title</code><code class="p">:</code> <code class="s">"Introduction to Human Anatomy and Physiology"</code><code class="p">,</code>
                <code class="n">Category</code><code class="p">:</code> <code class="s">"BIO"</code><code class="p">,</code> <code class="n">Number</code><code class="p">:</code> <code class="m">201</code><code class="p">,</code> <code class="n">Duration</code><code class="p">:</code> <code class="n">TimeSpan</code><code class="p">.</code><code class="n">FromHours</code><code class="p">(</code><code class="m">12</code><code class="p">),</code>
                <code class="n">PublicationDate</code><code class="p">:</code> <code class="k">new</code> <code class="n">DateOnly</code><code class="p">(</code><code class="m">2001</code><code class="p">,</code> <code class="m">4</code><code class="p">,</code> <code class="m">11</code><code class="p">)),</code>
        <code class="p">};</code>
<code class="p">}</code></pre></div>
<section data-pdf-bookmark="Filtering" data-type="sect2"><div class="sect2" id="filtering">
<h2>Filtering</h2>
<p><a data-primary="filtering, LINQ operators for" data-type="indexterm" id="ix_ch10-asciidoc13"/><a data-primary="LINQ operators" data-secondary="filtering" data-type="indexterm" id="ix_ch10-asciidoc14"/><a data-primary="Where operator" data-type="indexterm" id="ix_ch10-asciidoc15"/><a data-primary="LINQ operators" data-secondary="Where" data-type="indexterm" id="ch10-where"/>One of the simplest operators is <code>Where</code>, which filters its input. You provide a predicate, which is a function that takes an individual item and returns a <code>bool</code>.  <code>Where</code> returns an object representing the items from the input for which the predicate is true. (Conceptually, this is very similar to the <code>FindAll</code> method available on <code>List&lt;T&gt;</code> and array types, but using deferred execution.)</p>
<p>As you’ve already seen, query expressions represent this with a <code>where</code> clause. However, there’s an overload of the <code>Where</code> operator that provides an additional feature not accessible from a query expression. You can write a filter lambda that takes two arguments: an item from the input and an index representing that item’s position in the source. <a data-type="xref" href="#where_operator_with_index">Example 10-18</a> uses this form to remove every second number from the input, and it also removes courses shorter than three hours.</p>
<div data-type="example" id="where_operator_with_index">
<h5><span class="label">Example 10-18. </span><code>Where</code> operator with index</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">IEnumerable</code><code class="p">&lt;</code><code class="n">Course</code><code class="p">&gt;</code> <code class="n">q</code> <code class="p">=</code> <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code><code class="p">.</code><code class="n">Where</code><code class="p">(</code>
    <code class="p">(</code><code class="n">course</code><code class="p">,</code> <code class="n">index</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="p">(</code><code class="n">index</code> <code class="p">%</code> <code class="m">2</code> <code class="p">==</code> <code class="m">0</code><code class="p">)</code> <code class="p">&amp;&amp;</code> <code class="n">course</code><code class="p">.</code><code class="n">Duration</code><code class="p">.</code><code class="n">TotalHours</code> <code class="p">&gt;=</code> <code class="m">3</code><code class="p">);</code></pre></div>
<p>Indexed filtering is meaningful only for ordered data. It always works with LINQ to Objects, because that uses <code>IEnumerable&lt;T&gt;</code>, which produces items one after another, but not all LINQ providers process items in sequence. <a data-primary="database access, LINQ and" data-type="indexterm" id="idm45884806427312"/><a data-primary="Entity Framework Core (EF Core)" data-type="indexterm" id="idm45884806426704"/><a data-primary="EF Core (Entity Framework Core)" data-type="indexterm" id="idm45884806426096"/>For example, with the Entity Framework Core (EF Core), the LINQ queries you write in C# will be handled on the database. Unless a query explicitly requests some particular order, a database is usually free to process items in whatever order it sees fit, possibly in parallel. In some cases, a database may have optimization strategies that enable it to produce the results a query requires using a process that bears little resemblance to the original query. So it might not even be meaningful to talk about, say, the 14th item handled by a <code>WHERE</code> clause. Consequently, if you were to write a query similar to <a data-type="xref" href="#where_operator_with_index">Example 10-18</a> using EF Core, executing the query would cause an exception, complaining that the indexed <code>Where</code> operator is not applicable. If you’re wondering why the overload is even present if the provider doesn’t support it, it’s because EF Core uses <code>IQueryable&lt;T&gt;</code>, so all the standard operators are available at compile time; providers that choose to use <code>IQueryable&lt;T&gt;</code> can only report the nonavailability of operators at runtime.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>LINQ providers that implement some or all of the query logic on the server side usually limit what you can do in a query’s lambdas. Conversely, LINQ to Objects runs queries in process, so it lets you invoke any method from inside a filter lambda—if you want to call <code>Console.WriteLine</code> or read data from a file in your predicate, LINQ to Objects can’t stop you. But only a very limited selection of methods is available in providers for databases. These providers need to be able to translate your lambdas into something the server can process, and they will reject expressions that attempt to invoke methods that have no server-side equivalent.</p>
</div>
<p>Even so, you might have expected the exception to emerge when you invoke <code>Where</code>, instead of when you try to execute the query (i.e., when you first try to retrieve one or more items). <a data-primary="arguments" data-secondary="validation" data-type="indexterm" id="idm45884806420128"/>However, providers that convert LINQ queries into some other form, such as a SQL query, typically defer all validation until you execute the query. This is because some operators may be valid only in certain scenarios, meaning that the provider may not know whether any particular operator will work until you’ve finished building the whole query. It would be inconsistent if errors caused by nonviable queries sometimes emerged while building the query and sometimes when executing it, so even in cases where a provider could determine earlier that a particular operator will fail, it will usually wait until you execute the query to tell you.</p>
<p><a data-primary="Predicate&lt;T&gt; delegate type" data-secondary="Where operator and" data-type="indexterm" id="idm45884806418768"/>The filter lambda you supply to the <code>Where</code> operator must take an argument of the item type (the <code>T</code> in <code>IEnumerable&lt;T&gt;</code>, for example), and it must return a <code>bool</code>. You may remember from <a data-type="xref" href="ch09.xhtml#ch_delegates_lambdas_events">Chapter 9</a> that the runtime libraries define a suitable delegate type called <code>Predicate&lt;T&gt;</code>, but I also mentioned in that chapter that LINQ avoids this, and we can now see why. The indexed version of the <code>Where</code> operator cannot use <code>Predicate&lt;T&gt;</code>, because there’s an additional argument, so that overload uses <code>Func&lt;T, int, bool&gt;</code>. There’s nothing stopping the unindexed form of <code>Where</code> from using <code>Predicate&lt;T&gt;</code>, but LINQ providers tend to use <code>Func</code> across the board to ensure that operators with similar meanings have similar-looking signatures. Most providers therefore use <code>Func&lt;T, bool&gt;</code> instead, to be consistent with the indexed version. (C# doesn’t care which you use—query expressions still work if the provider uses <code>Predicate&lt;T&gt;</code>, as my custom <code>Where</code> operator in <a data-type="xref" href="#a_custom_linq_provider_for_cultureinfo">Example 10-11</a> shows, but none of Microsoft’s providers do this.)</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>The C# compiler’s nullability analysis doesn’t understand LINQ operators. If you have an <code>IEnumerable&lt;string?&gt;</code>, you could write <code>xs.Where(s =&gt; s is not null)</code> to remove any null items, but <code>Where</code> will still return an <code>IEnumerable&lt;string?&gt;</code>. The compiler has no expectations around what <code>Where</code> will do, so it doesn’t understand that the output is effectively an <code>IEnumerable&lt;string&gt;</code>. Arguably it would be a mistake for the compiler to make that inference: as <a data-type="xref" href="#nonsensical_where_and_select">Example 10-8</a> showed, it’s perfectly possible to supply a <code>Where</code> that defies expectations.</p>
</div>
<p><a data-primary="LINQ operators" data-secondary="OfType" data-type="indexterm" id="idm45884806404192"/><a data-primary="OfType operator" data-type="indexterm" id="idm45884806402992"/>LINQ defines another filtering operator: <code>OfType&lt;T&gt;</code>. This is useful if your source contains a mixture of different item types—perhaps the source is an 
<span class="keep-together"><code>IEnumerable&lt;object&gt;</code></span> and you’d like to filter this down to only the items of type <code>string</code>. <a data-type="xref" href="#the_oftype_operator">Example 10-19</a> shows how the <code>OfType&lt;T&gt;</code> operator can do this.</p>
<div data-type="example" id="the_oftype_operator">
<h5><span class="label">Example 10-19. </span>The <code>OfType&lt;T&gt;</code> operator</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">static</code> <code class="k">void</code> <code class="nf">ShowAllStrings</code><code class="p">(</code><code class="n">IEnumerable</code><code class="p">&lt;</code><code class="kt">object</code><code class="p">&gt;</code> <code class="n">src</code><code class="p">)</code>
<code class="p">{</code>
    <code class="k">foreach</code> <code class="p">(</code><code class="kt">string</code> <code class="n">s</code> <code class="k">in</code> <code class="n">src</code><code class="p">.</code><code class="n">OfType</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;())</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">s</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>When you use the <code>OfType&lt;T&gt;</code> operator with a reference type, it will filter out any <code>null</code> values. If you’ve enabled nullable reference types, <code>OfType</code> avoids the problems that <code>Where(s =&gt; s is not null)</code> encounters: if you call <code>OfType&lt;string&gt;</code> on a sequence of type <code>IEnumerable&lt;string?&gt;</code>, the resulting type will be <code>IEnumerable&lt;string&gt;</code>. But that’s not because <code>OfType</code> was designed with nullable reference types in mind. On the contrary, it effectively ignores the nullability when you use a reference type as the type argument. It happens to do what we want in this case because it’s always looking for a positive match. (It effectively performs the same test as patterns like <code>o is string</code>.) The surprising corollary is that <code>OfType&lt;string?&gt;</code> will also filter out <code>null</code> items, with the slightly peculiar result that it returns an <code>IEnumerable&lt;string?&gt;</code> that will never produce a <code>null</code>.</p>
<p>Both <code>Where</code> and <code>OfType&lt;T&gt;</code> will produce empty sequences if none of the objects in the source meet the requirements. This is not considered to be an error—empty sequences are quite normal in LINQ. Many operators can produce them as output, and most operators can cope with them as input.<a data-startref="ix_ch10-asciidoc15" data-type="indexterm" id="idm45884806328944"/><a data-startref="ix_ch10-asciidoc14" data-type="indexterm" id="idm45884806328336"/><a data-startref="ix_ch10-asciidoc13" data-type="indexterm" id="idm45884806327696"/><a data-startref="ch10-where" data-type="indexterm" id="idm45884806327024"/></p>
</div></section>
<section data-pdf-bookmark="Select" data-type="sect2"><div class="sect2" id="select">
<h2>Select</h2>
<p><a data-primary="LINQ operators" data-secondary="Select" data-type="indexterm" id="ix_ch10-asciidoc16"/><a data-primary="Select operator" data-secondary="LINQ operators" data-type="indexterm" id="ix_ch10-asciidoc17"/>When writing a query, we may want to extract only certain pieces of data from the source items. The <code>select</code> clause at the end of most queries lets us supply a lambda that will be used to produce the final output items, and there are a couple of reasons we might want to make our <code>select</code> clause do more than simply pass each item straight through. We might want to pick just one specific piece of information from each item, or we might want to transform it into something else entirely.</p>
<p>You’ve seen several <code>select</code> clauses already, and I showed in <a data-type="xref" href="#extracting_just_one_property_in_a_query">Example 10-3</a> that the compiler turns them into a call to <code>Select</code>. However, as with many LINQ operators, the version accessible through a query expression is not the only option. There’s one other overload, which provides not just the input item from which to generate the output item but also the index of that item. <a data-type="xref" href="#select_operator_with_index">Example 10-20</a> uses this to generate a numbered list of course titles.</p>
<div data-type="example" id="select_operator_with_index">
<h5><span class="label">Example 10-20. </span><code>Select</code> operator with index</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">IEnumerable</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="n">nonIntro</code> <code class="p">=</code> <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code><code class="p">.</code><code class="n">Select</code><code class="p">((</code><code class="n">course</code><code class="p">,</code> <code class="n">index</code><code class="p">)</code> <code class="p">=&gt;</code>
      <code class="err">$</code><code class="s">"Course {index}: {course.Title}"</code><code class="p">);</code></pre></div>
<p>Be aware that the zero-based index passed into the lambda will be based on what comes into the <code>Select</code> operator and will not necessarily represent the item’s original position in the underlying data source. This might not produce the results you were hoping for in code such as <a data-type="xref" href="#indexed_select_downstream_of_where_opera">Example 10-21</a>.</p>
<div data-type="example" id="indexed_select_downstream_of_where_opera">
<h5><span class="label">Example 10-21. </span>Indexed <code>Select</code> downstream of <code>Where</code> operator</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">IEnumerable</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="n">nonIntro</code> <code class="p">=</code> <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code>
    <code class="p">.</code><code class="n">Where</code><code class="p">(</code><code class="n">c</code> <code class="p">=&gt;</code> <code class="n">c</code><code class="p">.</code><code class="n">Number</code> <code class="p">&gt;=</code> <code class="m">200</code><code class="p">)</code>
    <code class="p">.</code><code class="n">Select</code><code class="p">((</code><code class="n">course</code><code class="p">,</code> <code class="n">index</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="err">$</code><code class="s">"Course {index}: {course.Title}"</code><code class="p">);</code></pre></div>
<p>This code will select the courses found at indexes 2, 3, and 5, respectively, in the <code>Course.Catalog</code> array, because those are the courses whose <code>Number</code> property satisfies the <code>Where</code> expression. However, this query will number the three courses as 0, 1, and 2, because the <code>Select</code> operator sees only the items the <code>Where</code> clause let through. As far as it is concerned, there are only three items, because the <code>Select</code> clause never had access to the original source. If you wanted the indexes relative to the original collection, you’d need to extract those upstream of the <code>Where</code> clause, as <a data-type="xref" href="#indexed_select_upstream_of_where_operato">Example 10-22</a> shows.</p>
<div data-type="example" id="indexed_select_upstream_of_where_operato">
<h5><span class="label">Example 10-22. </span>Indexed <code>Select</code> upstream of <code>Where</code> operator</h5>
<pre data-code-language="csharp" data-type="programlisting">
<code class="n">IEnumerable</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code><code> </code><code class="n">nonIntro</code><code> </code><code class="p">=</code><code> </code><code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code><code>
</code><code>    </code><strong><code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="p">(</code><code class="n">course</code><code class="p">,</code><code> </code><code class="n">index</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="k">new</code><code> </code><code class="p">{</code><code> </code><code class="n">course</code><code class="p">,</code><code> </code><code class="n">index</code><code> </code><code class="p">}</code><code class="p">)</code></strong><code>
</code><code>    </code><code class="p">.</code><code class="n">Where</code><code class="p">(</code><code class="n">vars</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">vars</code><code class="p">.</code><code class="n">course</code><code class="p">.</code><code class="n">Number</code><code> </code><code class="p">&gt;</code><code class="p">=</code><code> </code><code class="m">200</code><code class="p">)</code><code>
</code><code>    </code><code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">vars</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="err">$</code><code class="s">"Course {vars.index}: {vars.course.Title}"</code><code class="p">)</code><code class="p">;</code></pre></div>
<p>You may be wondering why I’ve used an anonymous type here and not a tuple. I could replace <code>new { course, index }</code> with just <code>(course, index)</code>, and the code would work equally well. (It might even be more efficient, because tuples are value types, but anonymous types are reference types. Tuples would create less work for the GC here.) However, in general, tuples will not always work in LINQ. The lightweight tuple syntax was introduced in C# 7.0, so they weren’t around when expression trees were added back in C# 3.0. The expression object model has not been updated to support this language feature, so if you try to use a tuple with an <code>IQueryable&lt;T&gt;</code>-based LINQ provider, you will get compiler error CS8143, telling you that <code>An expression tree may not contain a tuple literal</code>.<sup><a data-type="noteref" href="ch10.xhtml#idm45884806145536" id="idm45884806145536-marker">1</a></sup> So I tend to use anonymous types in this chapter because they work with query-based providers. But if you’re using a purely local LINQ provider (e.g., Rx or LINQ to Objects), feel free to use tuples.</p>
<p>The indexed <code>Select</code> operator is similar to the indexed <code>Where</code> operator. So, as you would probably expect, not all LINQ providers support it in all scenarios.</p>
<section data-pdf-bookmark="Data shaping and anonymous types" data-type="sect3"><div class="sect3" id="data_shaping_and_anonymous_types">
<h3>Data shaping and anonymous types</h3>
<p><a data-primary="anonymous types" data-secondary="Select operator and" data-type="indexterm" id="ix_ch10-asciidoc18"/><a data-primary="Select operator" data-secondary="data shaping and anonymous types" data-type="indexterm" id="ix_ch10-asciidoc19"/>If you are using a LINQ provider to access a database, the <code>Select</code> operator can offer an opportunity to reduce the quantity of data you fetch, which could reduce the load on your servers. When you use a data access technology such as EF Core to execute a query that returns a set of objects representing persistent entities, there’s a trade-off between doing too much work up front and having to do lots of extra deferred work. Should those frameworks fully populate all of the object properties that correspond to columns in various database tables? Should they also load related objects? In general, it’s more efficient not to fetch data you’re not going to use, and data that is not fetched up front can always be loaded later on demand. However, if you try to be too frugal in your initial request, you may ultimately end up making a lot of extra requests to fill in the gaps, which could outweigh any benefit from avoiding unnecessary work.</p>
<p><a data-primary="Entity Framework Core (EF Core)" data-type="indexterm" id="idm45884806138288"/><a data-primary="EF Core (Entity Framework Core)" data-type="indexterm" id="idm45884806103472"/>When it comes to related entities, EF Core allows you to configure which related entities should be prefetched and which should be loaded on demand, but for any particular entity that gets fetched, all properties relating to columns are typically fully populated. This means queries that request whole entities end up fetching all the columns for any row that they touch.</p>
<p>If you needed to use only one or two columns, fetching them all is relatively expensive. <a data-type="xref" href="#fetching_more_data_than_is_needed">Example 10-23</a> uses this somewhat inefficient approach. It shows a fairly typical EF Core query.</p>
<div data-type="example" id="fetching_more_data_than_is_needed">
<h5><span class="label">Example 10-23. </span>Fetching more data than is needed</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">pq</code> <code class="p">=</code> <code class="k">from</code> <code class="n">product</code> <code class="k">in</code> <code class="n">dbCtx</code><code class="p">.</code><code class="n">Product</code>
         <code class="k">where</code> <code class="n">product</code><code class="p">.</code><code class="n">ListPrice</code> <code class="p">&gt;</code> <code class="m">3000</code>
         <code class="k">select</code> <code class="n">product</code><code class="p">;</code>
<code class="k">foreach</code> <code class="p">(</code><code class="kt">var</code> <code class="n">prod</code> <code class="k">in</code> <code class="n">pq</code><code class="p">)</code>
<code class="p">{</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"{prod.Name} ({prod.Size}): {prod.ListPrice}"</code><code class="p">);</code>
<code class="p">}</code></pre></div>
<p>This LINQ provider translates the <code>where</code> clause into an efficient SQL equivalent. However, the SQL <code>SELECT</code> clause retrieves all the columns from the table. Compare that with <a data-type="xref" href="#a_select_clause_with_an_anonymous_type">Example 10-24</a>. This modifies only one part of the query: the LINQ <code>select</code> clause now returns an instance of an anonymous type that contains only those properties we require. (The loop that follows the query can remain the same. It uses <code>var</code> for its iteration variable, which will work fine with the anonymous type, which provides the three properties that loop requires.)</p>
<div data-type="example" id="a_select_clause_with_an_anonymous_type">
<h5><span class="label">Example 10-24. </span>A <code>select</code> clause with an anonymous type</h5>
<pre data-code-language="csharp" data-type="programlisting">
<code class="kt">var</code><code> </code><code class="n">pq</code><code> </code><code class="p">=</code><code> </code><code class="k">from</code><code> </code><code class="n">product</code><code> </code><code class="k">in</code><code> </code><code class="n">dbCtx</code><code class="p">.</code><code class="n">Product</code><code>
</code><code>         </code><code class="k">where</code><code> </code><code class="n">product</code><code class="p">.</code><code class="n">ListPrice</code><code> </code><code class="p">&gt;</code><code> </code><code class="m">3000</code><code>
</code><code>         </code><strong><code class="k">select</code><code> </code><code class="k">new</code><code> </code><code class="p">{</code><code> </code><code class="n">product</code><code class="p">.</code><code class="n">Name</code><code class="p">,</code><code> </code><code class="n">product</code><code class="p">.</code><code class="n">ListPrice</code><code class="p">,</code><code> </code><code class="n">product</code><code class="p">.</code><code class="n">Size</code><code> </code><code class="p">}</code><code class="p">;</code></strong></pre></div>
<p>The code produces exactly the same results, but it generates a much more compact SQL query that requests only the <code>Name</code>, <code>ListPrice</code>, and <code>Size</code> columns. If you’re using a table with many columns, this will produce a significantly smaller response because it’s no longer dominated by data we don’t need. This reduces the load on the network connection to the database server and also results in faster processing because the data will take less time to arrive. This technique is called <em>data shaping</em>.</p>
<p>This approach will not always be an improvement. For one thing, it means you are working directly with data in the database instead of using entity objects. This might mean working at a lower level of abstraction than would be possible if you use the entity types, which might increase development costs. Also, in some environments, database administrators do not allow ad hoc queries, forcing you to use stored procedures, in which case you won’t have the flexibility to use this technique.</p>
<p>Projecting the results of a query into an anonymous type is not limited to database queries, by the way. You are free to do this with any LINQ provider, such as LINQ to Objects. It can sometimes be a useful way to get structured information out of a query without needing to define a class specially. (As I mentioned in <a data-type="xref" href="ch03.xhtml#ch_types">Chapter 3</a>, anonymous types can be used outside of LINQ, but this is one of the main scenarios for which they were designed. Grouping by composite keys is another, as I’ll describe in <a data-type="xref" href="#grouping">“Grouping”</a>.)<a data-startref="ix_ch10-asciidoc19" data-type="indexterm" id="idm45884805991680"/><a data-startref="ix_ch10-asciidoc18" data-type="indexterm" id="idm45884805990976"/></p>
</div></section>
<section data-pdf-bookmark="Projection and mapping" data-type="sect3"><div class="sect3" id="projection_and_mapping">
<h3>Projection and mapping</h3>
<p><a data-primary="mapping" data-type="indexterm" id="idm45884805988608"/><a data-primary="projection, Select operator and" data-type="indexterm" id="idm45884805987744"/><a data-primary="Select operator" data-secondary="projection and mapping" data-type="indexterm" id="idm45884805987104"/>The <code>Select</code> operator is sometimes referred to as <em>projection</em>, and it is the same operation that many languages call <em>map</em>, which provides a slightly different way to think about the <code>Select</code> operator. So far, I’ve presented <code>Select</code> as a way to choose what comes out of a query, but you can also look at it as a way to apply a transformation to every item in the source. <a data-type="xref" href="#using_select_to_transform_numbers">Example 10-25</a> uses <code>Select</code> to produce modified versions of a list of numbers. It variously doubles the numbers, squares them, and turns them into strings.<a data-startref="ix_ch10-asciidoc17" data-type="indexterm" id="idm45884805953872"/><a data-startref="ix_ch10-asciidoc16" data-type="indexterm" id="idm45884805953168"/></p>
<div data-type="example" id="using_select_to_transform_numbers">
<h5><span class="label">Example 10-25. </span>Using <code>Select</code> to transform numbers</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">int</code><code class="p">[]</code> <code class="n">numbers</code> <code class="p">=</code> <code class="p">{</code> <code class="m">0</code><code class="p">,</code> <code class="m">1</code><code class="p">,</code> <code class="m">2</code><code class="p">,</code> <code class="m">3</code><code class="p">,</code> <code class="m">4</code><code class="p">,</code> <code class="m">5</code> <code class="p">};</code>

<code class="n">IEnumerable</code><code class="p">&lt;</code><code class="kt">int</code><code class="p">&gt;</code> <code class="n">doubled</code> <code class="p">=</code> <code class="n">numbers</code><code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="m">2</code> <code class="p">*</code> <code class="n">x</code><code class="p">);</code>
<code class="n">IEnumerable</code><code class="p">&lt;</code><code class="kt">int</code><code class="p">&gt;</code> <code class="n">squared</code> <code class="p">=</code> <code class="n">numbers</code><code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="n">x</code> <code class="p">*</code> <code class="n">x</code><code class="p">);</code>
<code class="n">IEnumerable</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="n">numberText</code> <code class="p">=</code> <code class="n">numbers</code><code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">x</code> <code class="p">=&gt;</code> <code class="n">x</code><code class="p">.</code><code class="n">ToString</code><code class="p">());</code></pre></div>
</div></section>
</div></section>
<section data-pdf-bookmark="SelectMany" data-type="sect2"><div class="sect2" id="selectmany">
<h2>SelectMany</h2>
<p><a data-primary="LINQ" data-secondary="SelectMany operator" data-type="indexterm" id="ix_ch10-asciidoc20"/><a data-primary="LINQ operators" data-secondary="SelectMany" data-type="indexterm" id="ix_ch10-asciidoc21"/><a data-primary="SelectMany operator" data-type="indexterm" id="ix_ch10-asciidoc22"/>The <code>SelectMany</code> LINQ operator is used in query expressions that have multiple <code>from</code> clauses. It’s called <code>SelectMany</code> because, instead of selecting a single output item for each input item, you provide it with a lambda that produces a whole collection for each input item. The resulting query produces all of the objects from all of these collections, as though all of the collections your lambda returns were merged into one. (This won’t remove duplicates. <a data-primary="Distinct operator" data-type="indexterm" id="idm45884805837968"/>Sequences can contain duplicates in LINQ. You can remove them with the <code>Distinct</code> operator described in <a data-type="xref" href="#set_operations">“Set Operations”</a>.) There are a couple of ways of thinking about this operator. One is that it provides a means of flattening two levels of hierarchy—a collection of collections—into a single level. Another way to look at it is as a Cartesian product—that is, a way to produce every possible combination from some input sets.</p>
<p><a data-type="xref" href="#selectmany_query_expression">Example 10-26</a> shows how to use this operator in a query expression. This code highlights the Cartesian-product-like behavior. It shows every combination of the letters A, B, and C with a single digit from 1 to 5—that is, A1, B1, C1, A2, B2, C2, etc. (If you’re wondering about the apparent incompatibility of the two input sequences, the <code>select</code> clause of this query relies on the fact that if you use the <code>+</code> operator to add a <code>string</code> and some other type, C# generates code that calls <code>ToString</code> on the nonstring operand for you.)</p>
<div data-type="example" id="selectmany_query_expression">
<h5><span class="label">Example 10-26. </span>Using <code>SelectMany</code> from a query expression</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">int</code><code class="p">[]</code> <code class="n">numbers</code> <code class="p">=</code> <code class="p">{</code> <code class="m">1</code><code class="p">,</code> <code class="m">2</code><code class="p">,</code> <code class="m">3</code><code class="p">,</code> <code class="m">4</code><code class="p">,</code> <code class="m">5</code> <code class="p">};</code>
<code class="kt">string</code><code class="p">[]</code> <code class="n">letters</code> <code class="p">=</code> <code class="p">{</code> <code class="s">"A"</code><code class="p">,</code> <code class="s">"B"</code><code class="p">,</code> <code class="s">"C"</code> <code class="p">};</code>

<code class="n">IEnumerable</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="n">combined</code> <code class="p">=</code> <code class="k">from</code> <code class="n">number</code> <code class="k">in</code> <code class="n">numbers</code>
                               <code class="k">from</code> <code class="n">letter</code> <code class="k">in</code> <code class="n">letters</code>
                               <code class="k">select</code> <code class="n">letter</code> <code class="p">+</code> <code class="n">number</code><code class="p">;</code>
<code class="k">foreach</code> <code class="p">(</code><code class="kt">string</code> <code class="n">s</code> <code class="k">in</code> <code class="n">combined</code><code class="p">)</code>
<code class="p">{</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">s</code><code class="p">);</code>
<code class="p">}</code></pre></div>
<p><a data-type="xref" href="#selectmany_operator">Example 10-27</a> shows how to invoke the operator directly. This is equivalent to the query expression in <a data-type="xref" href="#selectmany_query_expression">Example 10-26</a>.</p>
<div data-type="example" id="selectmany_operator">
<h5><span class="label">Example 10-27. </span><code>SelectMany</code> operator</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">IEnumerable</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="n">combined</code> <code class="p">=</code> <code class="n">numbers</code><code class="p">.</code><code class="n">SelectMany</code><code class="p">(</code>
    <code class="n">number</code> <code class="p">=&gt;</code> <code class="n">letters</code><code class="p">,</code>
    <code class="p">(</code><code class="n">number</code><code class="p">,</code> <code class="n">letter</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="n">letter</code> <code class="p">+</code> <code class="n">number</code><code class="p">);</code></pre></div>
<p><a data-type="xref" href="#selectmany_query_expression">Example 10-26</a> uses two fixed collections—the second <code>from</code> clause returns the same <code>letters</code> collection every time. However, you can make the expression in the second <code>from</code> clause return a value based on the current item from the first <code>from</code> clause. You can see in <a data-type="xref" href="#selectmany_operator">Example 10-27</a> that the first lambda passed to <code>SelectMany</code> (which actually corresponds to the second <code>from</code> clause’s final expression) receives the current item from the first collection through its <code>number</code> argument, so you can use that to choose a different collection for each item from the first collection. I can use this to exploit <code>SelectMany</code>’s flattening behavior.</p>
<p><a data-primary="jagged arrays" data-secondary="flattening" data-type="indexterm" id="idm45884805669136"/><a data-primary="multidimensional arrays" data-secondary="jagged arrays" data-type="indexterm" id="idm45884805668064"/>I’ve copied a jagged array from <a data-type="xref" href="ch05.xhtml#creating_a_jagged_array">Example 5-16</a> in <a data-type="xref" href="ch05.xhtml#ch_collections">Chapter 5</a> into <a data-type="xref" href="#flattening_a_jagged_array">Example 10-28</a>, which then processes it with a query containing two <code>from</code> clauses. Note that the expression in the second <code>from</code> clause is now <code>row</code>, the range variable of the first <code>from</code> clause.</p>
<div data-type="example" id="flattening_a_jagged_array">
<h5><span class="label">Example 10-28. </span>Flattening a jagged array</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">int</code><code class="p">[][]</code> <code class="n">arrays</code> <code class="p">=</code>
<code class="p">{</code>
    <code class="k">new</code><code class="p">[]</code> <code class="p">{</code> <code class="m">1</code><code class="p">,</code> <code class="m">2</code> <code class="p">},</code>
    <code class="k">new</code><code class="p">[]</code> <code class="p">{</code> <code class="m">1</code><code class="p">,</code> <code class="m">2</code><code class="p">,</code> <code class="m">3</code><code class="p">,</code> <code class="m">4</code><code class="p">,</code> <code class="m">5</code><code class="p">,</code> <code class="m">6</code> <code class="p">},</code>
    <code class="k">new</code><code class="p">[]</code> <code class="p">{</code> <code class="m">1</code><code class="p">,</code> <code class="m">2</code><code class="p">,</code> <code class="m">4</code> <code class="p">},</code>
    <code class="k">new</code><code class="p">[]</code> <code class="p">{</code> <code class="m">1</code> <code class="p">},</code>
    <code class="k">new</code><code class="p">[]</code> <code class="p">{</code> <code class="m">1</code><code class="p">,</code> <code class="m">2</code><code class="p">,</code> <code class="m">3</code><code class="p">,</code> <code class="m">4</code><code class="p">,</code> <code class="m">5</code> <code class="p">}</code>
<code class="p">};</code>

<code class="n">IEnumerable</code><code class="p">&lt;</code><code class="kt">int</code><code class="p">&gt;</code> <code class="n">flattened</code> <code class="p">=</code> <code class="k">from</code> <code class="n">row</code> <code class="k">in</code> <code class="n">arrays</code>
                             <code class="k">from</code> <code class="n">number</code> <code class="k">in</code> <code class="n">row</code>
                             <code class="k">select</code> <code class="n">number</code><code class="p">;</code></pre></div>
<p>The first <code>from</code> clause asks to iterate over each item in the top-level array. Each of these items is also an array, and the second <code>from</code> clause asks to iterate over each of these nested arrays. This nested array’s type is <code>int[]</code>, so the range variable of the second <code>from</code> clause, <code>number</code>, represents an <code>int</code> from that nested array. The <code>select</code> clause just returns each of these <code>int</code> values.</p>
<p>The resulting sequence provides every number in the arrays in turn. It has flattened the jagged array into a simple linear sequence of numbers. This behavior is conceptually similar to writing a nested pair of loops, one iterating over the outer <code>int[][]</code> array, and an inner loop iterating over the contents of each individual <code>int[]</code> array.</p>
<p>The compiler uses the same overload of <code>SelectMany</code> for <a data-type="xref" href="#flattening_a_jagged_array">Example 10-28</a> as it does for <a data-type="xref" href="#selectmany_operator">Example 10-27</a>, but there’s an alternative in this case. The final <code>select</code> clause is simpler in <a data-type="xref" href="#flattening_a_jagged_array">Example 10-28</a>—it just passes on items from the second collection unmodified, which means the simpler overload shown in <a data-type="xref" href="#selectmany_without_item_projection">Example 10-29</a> does the job equally well. With this overload, we just provide a single lambda, which chooses the collection that <code>SelectMany</code> will expand for each of the items in the input collection.</p>
<div data-type="example" id="selectmany_without_item_projection">
<h5><span class="label">Example 10-29. </span><code>SelectMany</code> without item projection</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">flattened</code> <code class="p">=</code> <code class="n">arrays</code><code class="p">.</code><code class="n">SelectMany</code><code class="p">(</code><code class="n">row</code> <code class="p">=&gt;</code> <code class="n">row</code><code class="p">);</code></pre></div>
<p>That’s a somewhat terse bit of code, so in case it’s not clear quite how that could end up flattening the array, <a data-type="xref" href="#one_implementation_of_selectmany">Example 10-30</a> shows how you might implement <code>SelectMany</code> for <code>IEnumerable&lt;T&gt;</code> if you had to write it yourself.</p>
<div data-type="example" id="one_implementation_of_selectmany">
<h5><span class="label">Example 10-30. </span>One implementation of <code>SelectMany</code></h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">static</code> <code class="n">IEnumerable</code><code class="p">&lt;</code><code class="n">T2</code><code class="p">&gt;</code> <code class="n">MySelectMany</code><code class="p">&lt;</code><code class="n">T</code><code class="p">,</code> <code class="n">T2</code><code class="p">&gt;(</code>
    <code class="k">this</code> <code class="n">IEnumerable</code><code class="p">&lt;</code><code class="n">T</code><code class="p">&gt;</code> <code class="n">src</code><code class="p">,</code> <code class="n">Func</code><code class="p">&lt;</code><code class="n">T</code><code class="p">,</code> <code class="n">IEnumerable</code><code class="p">&lt;</code><code class="n">T2</code><code class="p">&gt;&gt;</code> <code class="n">getInner</code><code class="p">)</code>
<code class="p">{</code>
    <code class="k">foreach</code> <code class="p">(</code><code class="n">T</code> <code class="n">itemFromOuterCollection</code> <code class="k">in</code> <code class="n">src</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">IEnumerable</code><code class="p">&lt;</code><code class="n">T2</code><code class="p">&gt;</code> <code class="n">innerCollection</code> <code class="p">=</code> <code class="n">getInner</code><code class="p">(</code><code class="n">itemFromOuterCollection</code><code class="p">);</code>
        <code class="k">foreach</code> <code class="p">(</code><code class="n">T2</code> <code class="n">itemFromInnerCollection</code> <code class="k">in</code> <code class="n">innerCollection</code><code class="p">)</code>
        <code class="p">{</code>
            <code class="k">yield</code> <code class="k">return</code> <code class="n">itemFromInnerCollection</code><code class="p">;</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>Why does the compiler not use the simpler option shown in <a data-type="xref" href="#selectmany_without_item_projection">Example 10-29</a>? The C# language specification defines how query expressions are translated into method calls, and it mentions only the overload shown in <a data-type="xref" href="#selectmany_query_expression">Example 10-26</a>. Perhaps the reason the specification doesn’t mention the simpler overload is to reduce the demands C# makes of types that want to support this double-<code>from</code> query form—you’d need to write only one method to enable this syntax for your own types. However, .NET’s various LINQ providers are more generous, providing this simpler overload for the benefit of developers who choose to use the operators directly. In fact, some providers define two more overloads: there are versions of both the <code>SelectMany</code> forms we’ve seen so far that also pass an item index to the first lambda. (The usual caveats about indexed operators apply, of course.)</p>
<p>Although <a data-type="xref" href="#one_implementation_of_selectmany">Example 10-30</a> gives a reasonable idea of what LINQ to Objects does in <code>SelectMany</code>, it’s not the exact implementation. There are optimizations for special cases. Moreover, other providers may use very different strategies. Databases often have built-in support for Cartesian products, so some providers may implement <code>SelectMany</code> in terms of that.<a data-startref="ix_ch10-asciidoc22" data-type="indexterm" id="idm45884805386096"/><a data-startref="ix_ch10-asciidoc21" data-type="indexterm" id="idm45884805385600"/><a data-startref="ix_ch10-asciidoc20" data-type="indexterm" id="idm45884805384992"/></p>
</div></section>
<section data-pdf-bookmark="Chunking" data-type="sect2"><div class="sect2" id="chunking">
<h2>Chunking</h2>
<p><a data-primary=".NET 6.0" data-primary-sortas="NET 6.0" data-secondary="chunking (LINQ operator)" data-type="indexterm" id="idm45884805382624"/><a data-primary="Chunk operator" data-type="indexterm" id="idm45884805381408"/><a data-primary="LINQ operators" data-secondary="Chunk" data-type="indexterm" id="idm45884805380736"/>Whereas <code>SelectMany</code> flattens multiple sequences into one, LINQ’s <code>Chunk</code> operator (added in .NET 6.0) works in the opposite direction, turning a single sequence into a series of fixed-size sequences. This can be useful in cases where it’s more efficient to process multiple items in a batch than handling them one at a time. That’s often true when I/O is involved—there are fixed minimum costs for writing data to disk or sending it over the network, which can often mean that the cost of writing or sending a single record is only slightly smaller than a single operation that writes or sends 10 records.</p>
<p><a data-type="xref" href="#chunking_numbers">Example 10-31</a> uses the <code>Range</code> method (described later in <a data-type="xref" href="#sequence_generation">“Sequence Generation”</a>) to create a sequence of numbers from 1 to 50, and then asks <code>Chunk</code> to split these into chunks of 15 numbers each. While <code>Range</code> produced an 
<span class="keep-together"><code>IEnumerable&lt;int&gt;</code></span>—a sequence of <code>int</code> values—<code>Chunk</code> returns a sequence of <em>arrays</em> of type <code>int[]</code>.</p>
<div data-type="example" id="chunking_numbers">
<h5><span class="label">Example 10-31. </span>Splitting a sequence into batches with <code>Chunk</code></h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">IEnumerable</code><code class="p">&lt;</code><code class="kt">int</code><code class="p">&gt;</code> <code class="n">lotsOfNumbers</code> <code class="p">=</code> <code class="n">Enumerable</code><code class="p">.</code><code class="n">Range</code><code class="p">(</code><code class="m">1</code><code class="p">,</code> <code class="m">50</code><code class="p">);</code>

<code class="n">IEnumerable</code><code class="p">&lt;</code><code class="kt">int</code><code class="p">[]&gt;</code> <code class="n">chunked</code> <code class="p">=</code> <code class="n">lotsOfNumbers</code><code class="p">.</code><code class="n">Chunk</code><code class="p">(</code><code class="m">15</code><code class="p">);</code>
<code class="k">foreach</code><code class="p">(</code><code class="kt">int</code><code class="p">[]</code> <code class="n">chunk</code> <code class="k">in</code> <code class="n">chunked</code><code class="p">)</code>
<code class="p">{</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code>
        <code class="err">$</code><code class="s">"Chunk (length {chunk.Length}): {String.Join("</code><code class="p">,</code> <code class="s">", chunk)}"</code><code class="p">);</code>
<code class="p">}</code></pre></div>
<p>Looking at the output of <a data-type="xref" href="#chunking_numbers">Example 10-31</a>, we can see that <code>Chunk</code> hands us all of the numbers in order, just split into chunks:</p>
<pre data-type="programlisting">Chunk (length 15): 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15
Chunk (length 15): 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30
Chunk (length 15): 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45
Chunk (length 5): 46, 47, 48, 49, 50</pre>
<p>In this example, the source sequence wasn’t an exact multiple of the chunk size. <code>Chunk</code> dealt with this by making the final chunk smaller.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><a data-primary="LINQ operators" data-secondary="Buffer" data-type="indexterm" id="idm45884805290624"/><a data-primary="Buffer operator" data-type="indexterm" id="idm45884805289424"/>Some LINQ providers use a different name for this operator: <code>Buffer</code>. The Rx library described in <a data-type="xref" href="ch11.xhtml#ch_reactive_extensions">Chapter 11</a> chose that name when it introduced an operator of this kind about 10 years earlier. .NET 6.0 has chosen the name <code>Chunk</code> instead, but libraries that were written before this typically followed Rx’s lead, calling their version of this operator <code>Buffer</code>.</p>
</div>
</div></section>
<section data-pdf-bookmark="Ordering" data-type="sect2"><div class="sect2" id="ordering">
<h2>Ordering</h2>
<p><a data-primary="LINQ operators" data-secondary="ordering" data-type="indexterm" id="ix_ch10-asciidoc23"/><a data-primary="orderby (LINQ clause)" data-type="indexterm" id="ix_ch10-asciidoc24"/><a data-primary="ordering, LINQ operators for" data-type="indexterm" id="ix_ch10-asciidoc25"/>In general, LINQ queries do not guarantee to produce items in any particular order unless you explicitly define the order you require. You can do this in a query expression with an <code>orderby</code> clause. As <a data-type="xref" href="#query_expression_with_orderby_clause">Example 10-32</a> shows, you specify the expression that defines how to order the items and a direction—so this will produce a collection of courses ordered by ascending publication date. As it happens, <code>ascending</code> is the default, so you can leave off that qualifier without changing the meaning. As you’ve probably guessed, you can specify <code>descending</code> to reverse the order.</p>
<div data-type="example" id="query_expression_with_orderby_clause">
<h5><span class="label">Example 10-32. </span>Query expression with <code>orderby</code> clause</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">q</code> <code class="p">=</code> <code class="k">from</code> <code class="n">course</code> <code class="k">in</code> <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code>
        <code class="k">orderby</code> <code class="n">course</code><code class="p">.</code><code class="n">PublicationDate</code> <code class="k">ascending</code>
        <code class="k">select</code> <code class="n">course</code><code class="p">;</code></pre></div>
<p><a data-primary="OrderBy operator" data-type="indexterm" id="idm45884805267968"/><a data-primary="OrderByDescending operator" data-type="indexterm" id="idm45884805259984"/>The compiler transforms the <code>orderby</code> clause in <a data-type="xref" href="#query_expression_with_orderby_clause">Example 10-32</a> into a call to the <code>OrderBy</code> method, and it would use <code>OrderByDescending</code> if you had specified a <code>descending</code> sort order. <a data-primary="IOrderedQueryable&lt;T&gt; interface" data-type="indexterm" id="idm45884805254496"/>With source types that make a distinction between ordered and unordered collections, these operators return the ordered type<a data-primary="IOrderedEnumerable&lt;T&gt; interface" data-type="indexterm" id="idm45884805253664"/> (for example, 
<span class="keep-together"><code>IOrderedEnumerable&lt;T&gt;</code></span> for LINQ to Objects, and <code>IOrderedQueryable&lt;T&gt;</code> for <code>IQueryable&lt;T&gt;</code>-based providers).</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>With LINQ to Objects, these operators have to retrieve every element from their input before they can produce any output elements. An ascending <code>OrderBy</code> can determine which item to return first only once it has found the lowest item, and it won’t know for certain which is the lowest until it has seen all of them. It still uses deferred evaluation—it won’t do anything until you ask it for the first item. But as soon as you do ask it for something, it has to do all the work at once. Some providers will have additional knowledge about the data that can enable more efficient strategies. (For example, a database may be able to use an index to return values in the order required.)</p>
</div>
<p>LINQ to Objects’ <code>OrderBy</code> and <code>OrderByDescending</code> operators each have two overloads, only one of which is available from a query expression. If you invoke the methods directly, you can supply an additional parameter of type <code>IComparer&lt;TKey&gt;</code>, where <code>TKey</code> is the type of the expression by which the items are being sorted. This is likely to be important if you sort based on a <code>string</code> property, because there are several different orderings for text, and you may need to choose one based on your application’s locale, or you may want to specify a culture-invariant ordering to ensure consistency across all environments.</p>
<p>The expression that determines the order in <a data-type="xref" href="#query_expression_with_orderby_clause">Example 10-32</a> is very simple—it just retrieves the <code>PublicationDate</code> property from the source item. You can write more complex expressions if you want to. If you’re using a provider that translates a LINQ query into something else, there may be limitations. If the query runs on the database, you may be able to refer to other tables—the provider might be able to convert an expression such as <code>product.ProductCategory.Name</code> into a suitable join. However, you will not be able to run any old code in that expression, because it must be something that the database can execute. But LINQ to Objects just invokes the expression once for each object, so you really can put in there whatever code you like.</p>
<p>You may want to sort by multiple criteria. You should <em>not</em> do this by writing multiple <code>orderby</code> clauses. <a data-type="xref" href="#how_not_to_apply_multiple_ordering_crite">Example 10-33</a> makes this mistake.</p>
<div data-type="example" id="how_not_to_apply_multiple_ordering_crite">
<h5><span class="label">Example 10-33. </span>How not to apply multiple ordering criteria</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">q</code> <code class="p">=</code> <code class="k">from</code> <code class="n">course</code> <code class="k">in</code> <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code>
        <code class="k">orderby</code> <code class="n">course</code><code class="p">.</code><code class="n">PublicationDate</code> <code class="k">ascending</code>
        <code class="k">orderby</code> <code class="n">course</code><code class="p">.</code><code class="n">Duration</code> <code class="k">descending</code> <code class="c1">// BAD! Could discard previous order</code>
        <code class="k">select</code> <code class="n">course</code><code class="p">;</code></pre></div>
<p>This code orders the items by publication date and then by duration but does so as two separate and unrelated steps. The second <code>orderby</code> clause guarantees only that the results will be in the order specified in that clause and does not guarantee to preserve anything about the order in which the elements originated. If what you actually wanted was for the items to be in order of publication date, and for any items with the same publication date to be ordered by descending duration, you would need to write the query in <a data-type="xref" href="#multiple_ordering_criteria_query_expr">Example 10-34</a>.</p>
<div data-type="example" id="multiple_ordering_criteria_query_expr">
<h5><span class="label">Example 10-34. </span>Multiple ordering criteria in a query expression</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">q</code> <code class="p">=</code> <code class="k">from</code> <code class="n">course</code> <code class="k">in</code> <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code>
        <code class="k">orderby</code> <code class="n">course</code><code class="p">.</code><code class="n">PublicationDate</code> <code class="k">ascending</code><code class="p">,</code> <code class="n">course</code><code class="p">.</code><code class="n">Duration</code> <code class="k">descending</code>
        <code class="k">select</code> <code class="n">course</code><code class="p">;</code></pre></div>
<p><a data-primary="ThenBy operator" data-type="indexterm" id="idm45884805115104"/><a data-primary="LINQ operators" data-secondary="ThenBy" data-type="indexterm" id="idm45884805133536"/><a data-primary="LINQ operators" data-secondary="ThenByDescending" data-type="indexterm" id="idm45884805132688"/><a data-primary="ThenByDescending operator" data-type="indexterm" id="idm45884805131744"/>LINQ defines separate operators for this multilevel ordering: <code>ThenBy</code> and <code>The⁠nBy​Des⁠cen⁠ding</code>. <a data-type="xref" href="#multiple_ordering_criteria_linq_ops">Example 10-35</a> shows how to achieve the same effect as the query expression in <a data-type="xref" href="#multiple_ordering_criteria_query_expr">Example 10-34</a> by invoking the LINQ operators directly. <a data-primary="IOrderedEnumerable&lt;T&gt; interface" data-type="indexterm" id="idm45884805128576"/>For LINQ providers whose types make a distinction between ordered and unordered collections, the <code>ThenBy</code> and <code>ThenByDescending</code> operators will be available only on the ordered form, such as <code>IOrderedQueryable&lt;T&gt;</code> or <code>IOrderedEnumerable&lt;T&gt;</code>. If you were to try to invoke <code>ThenBy</code> directly on <code>Course.Catalog</code>, the compiler would report an error.</p>
<div data-type="example" id="multiple_ordering_criteria_linq_ops">
<h5><span class="label">Example 10-35. </span>Multiple ordering criteria with LINQ operators</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">q</code> <code class="p">=</code> <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code>
    <code class="p">.</code><code class="n">OrderBy</code><code class="p">(</code><code class="n">course</code> <code class="p">=&gt;</code> <code class="n">course</code><code class="p">.</code><code class="n">PublicationDate</code><code class="p">)</code>
    <code class="p">.</code><code class="n">ThenByDescending</code><code class="p">(</code><code class="n">course</code> <code class="p">=&gt;</code> <code class="n">course</code><code class="p">.</code><code class="n">Duration</code><code class="p">);</code></pre></div>
<p>You will find that some LINQ operators preserve some aspects of ordering even if you do not ask them to. For example, LINQ to Objects will typically produce items in the same order in which they appeared in the input unless you write a query that causes it to change the order. But this is simply an artifact of how LINQ to Objects works, and you should not rely on it in general. In fact, even when you are using that particular LINQ provider, you should check with the documentation to see whether the order you’re getting is guaranteed or is just an accident of implementation. In most cases, if you care about the order, you should write a query that makes that explicit.<a data-startref="ix_ch10-asciidoc25" data-type="indexterm" id="idm45884805057008"/><a data-startref="ix_ch10-asciidoc24" data-type="indexterm" id="idm45884805056400"/><a data-startref="ix_ch10-asciidoc23" data-type="indexterm" id="idm45884805055792"/></p>
</div></section>
<section data-pdf-bookmark="Containment Tests" data-type="sect2"><div class="sect2" id="containment_tests">
<h2>Containment Tests</h2>
<p><a data-primary="containment tests" data-type="indexterm" id="ix_ch10-asciidoc26"/><a data-primary="LINQ operators" data-secondary="containment tests" data-type="indexterm" id="ix_ch10-asciidoc27"/>LINQ defines various standard operators for discovering things about what the collection contains. Some providers may be able to implement these operators without needing to inspect every item. (For example, a database-based provider might use a <code>WHERE</code> clause, and the database could be able to use an index to evaluate that without needing to look at every element.) However, there are no restrictions—you can use these operators however you like, and it’s up to the provider to discover whether it can exploit a shortcut.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Unlike most LINQ operators, in the majority of providers these return neither a collection nor an item from their input. They generally just return <code>true</code> or <code>false</code>, or in some cases, a count. Rx is a notable exception: its implementations of these operators wrap the <code>bool</code> or <code>int</code> in a single-element <code>IObservable&lt;T&gt;</code> that produces the result. It does this to preserve the reactive nature of processing in Rx.</p>
</div>
<p><a data-primary="Contains operator" data-type="indexterm" id="idm45884805041264"/><a data-primary="LINQ operators" data-secondary="Contains" data-type="indexterm" id="idm45884805040224"/>The simplest operator is <code>Contains</code>. You pass an item, and some providers (including LINQ to Objects) provide an overload that also takes an <code>IEqualityComparer&lt;T&gt;</code> so that you can customize how the operator determines whether an item in the source is the same as the specified item. <code>Contains</code> returns <code>true</code> if the source contains the specified item and <code>false</code> if it does not. If you use the single-argument version with a collection that implements <code>ICollection&lt;T&gt;</code> (which includes all <code>IList&lt;T&gt;</code> and <code>ISet&lt;T&gt;</code> implementations), LINQ to Objects will detect that, and its implementation of <code>Contains</code> just defers to the collection. If you use a non-<code>ICollection&lt;T&gt;</code> collection, or you provide a custom equality comparer, it will have to examine every item in the collection.</p>
<p><a data-primary="LINQ operators" data-secondary="Any" data-type="indexterm" id="idm45884805034784"/><a data-primary="Any operator" data-type="indexterm" id="idm45884805033504"/>If, instead of looking for a particular value, you want to know whether a collection contains any values that satisfy some particular criteria, you can use the <code>Any</code> operator. This takes a predicate, and it returns <code>true</code> if the predicate is true for at least one item in the source. <a data-primary="Count operator" data-type="indexterm" id="idm45884805031904"/>If you want to know how many items match some criteria, you can use the <code>Count</code> operator. This also takes a predicate, and instead of returning a <code>bool</code>, it returns an <code>int</code>. <a data-primary="LongCount operator" data-type="indexterm" id="idm45884805029824"/>If you are working with very large collections, the range of <code>int</code> may be insufficient, in which case you can use the <code>LongCount</code> operator, which returns a 64-bit count. (This is likely to be overkill for most LINQ to Objects applications, but it could matter when the collection lives in a database.)</p>
<p>The <code>Any</code>, <code>Count</code>, and <code>LongCount</code> operators have overloads that do not take any arguments. For <code>Any</code>, this tells you whether the source contains at least one element, and for <code>Count</code> and <code>LongCount</code>, these overloads tell you how many elements the source contains.</p>
<p>You should be wary of code such as <code>if (q.Count() &gt; 0)</code>. Calculating the exact count may require the entire source query (<code>q</code> in this case) to be evaluated, and in any case, it is likely to require more work than simply answering the question, <em>Is this empty?</em> If <code>q</code> refers to a LINQ query, writing <code>if (q.Any())</code> is likely to be more efficient. That said, outside of LINQ, this is not the case for list-like collections, where retrieving an element count is cheap and may actually be more efficient than the <code>Any</code> operator.</p>
<p>There are some situations in which you might want to use a count only if one can be calculated efficiently. (For example, a user interface might want to show the total number of items available if this is easy to determine, but could easily choose not to show it for cases where that would be too expensive.) <a data-primary=".NET 6.0" data-primary-sortas="NET 6.0" data-secondary="TryGetNonEnumeratedCount method" data-type="indexterm" id="idm45884805021184"/><a data-primary="TryGetNonEnumeratedCount method" data-type="indexterm" id="idm45884805019968"/>For these scenarios, .NET 6.0 added a new <code>TryGetNonEnumeratedCount</code> method. This will return <code>true</code> if the count can be determined without having to iterate through the whole collection, and <code>false</code> if not. When it returns <code>true</code>, it passes the count back through its single argument of type <code>out int</code>.</p>
<p><a data-primary="All operator" data-type="indexterm" id="idm45884805016800"/><a data-primary="LINQ operators" data-secondary="All" data-type="indexterm" id="idm45884805015872"/>A close relative to the <code>Any</code> operator is the <code>All</code> operator. This one is not overloaded—it takes a predicate, and it returns <code>true</code> if and only if the source contains no items that do not match the predicate. I used an awkward double negative in the preceding sentence for a reason: <code>All</code> returns <code>true</code> when applied to an empty sequence, because an empty sequence certainly doesn’t contain any elements that fail to match the predicate for the simple reason that it doesn’t contain any elements at all.</p>
<p>This may seem like a curiously pig-headed form of logic. It’s reminiscent of the child who, when asked, “Have you eaten your vegetables?” unhelpfully replies, “I ate all the vegetables I put on my plate,” neglecting to mention that he didn’t put any vegetables on his plate in the first place. It’s not technically untrue, but it fails to provide the information the parent was looking for. Nonetheless, the operators work this way for a reason: they correspond to some standard mathematical logical operators.<a data-primary="existential quantifier" data-type="indexterm" id="idm45884805012048"/><a data-primary="universal quantifier" data-type="indexterm" id="idm45884805011344"/> <code>Any</code> is the <em>existential quantifier</em>, usually written as a backward E (∃) and pronounced “there exists,” and <code>All</code> is the <em>universal quantifier</em>, usually written as an upside-down A (∀) and pronounced “for all.” <a data-primary="vacuous truth" data-type="indexterm" id="idm45884805008816"/>Mathematicians long ago agreed on a convention for statements that apply the universal quantifier to an empty set. For example, defining 𝕍 as the set of all vegetables, I can assert that ∀{v : (v ∈ 𝕍) ∧ putOnPlateByMe(v)} eatenByMe(v), or, in English, “For each vegetable that I put on my plate, it is true to say that I ate that vegetable.” This statement is deemed to be true if the set of vegetables I put on my plate is empty. (Perhaps mathematicians don’t like vegetables either.) Rather pleasingly, the proper term for such a statement is a <em>vacuous truth</em>.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="immediate_evaluation_and_async">
<h5>Asynchronous Immediate Evaluation</h5>
<p><a data-primary="asynchronous immediate evaluation" data-type="indexterm" id="idm45884805006000"/><a data-primary="LINQ operators" data-secondary="asynchronous immediate evaluation" data-type="indexterm" id="idm45884805004960"/><a data-primary="LINQ operators" data-secondary="All" data-type="indexterm" id="idm45884805004080"/><a data-primary="All operator" data-type="indexterm" id="idm45884805003136"/><a data-primary="LINQ operators" data-secondary="Any" data-type="indexterm" id="idm45884805002464"/><a data-primary="Any operator" data-type="indexterm" id="idm45884805001520"/><a data-primary="LINQ operators" data-secondary="Contains" data-type="indexterm" id="idm45884805000848"/><a data-primary="Contains operator" data-type="indexterm" id="idm45884804999904"/>Although most LINQ operators defer execution, as you’ve now seen there are some exceptions. With most LINQ providers, the <code>Contains</code>, <code>Any</code>, and <code>All</code> operators do not produce a wrapped result. (E.g., in LINQ to Objects, these return a <code>bool</code>, not an <code>IEnumerable&lt;bool&gt;</code>.) This sometimes means that these operators need to do some slow work. For example, EF Core’s LINQ provider will need to send a query to the database and wait for the response before being able to return the <code>bool</code> result. The same goes for <code>ToArray</code> and <code>ToList</code>, which produce fully populated collections, instead of an <code>IEnumerable&lt;T&gt;</code> or <code>IQueryable&lt;T&gt;</code> that have the potential to produce results in the future.</p>
<p>As <a data-type="xref" href="ch16.xhtml#ch_multithreading">Chapter 16</a> describes, it is common for slow operations like these to implement the Task-based Asynchronous Pattern (TAP), enabling us to use the <code>await</code> keyword described in <a data-type="xref" href="ch17.xhtml#ch_asynchronous_language_features">Chapter 17</a>. Some LINQ providers therefore choose to offer asynchronous versions of these operators. For example, EF Core offers <code>SingleAsync</code>, <code>Con⁠tai⁠ns​Asy⁠nc</code>, <code>AnyAsync</code>, <code>AllAsync</code>, <code>ToArrayAsync</code>, and <code>ToListAsync</code>, and equivalents for the other operators we’ll see that perform immediate evaluation.<a data-startref="ix_ch10-asciidoc27" data-type="indexterm" id="idm45884804989136"/><a data-startref="ix_ch10-asciidoc26" data-type="indexterm" id="idm45884804988432"/></p>
</div></aside>
</div></section>
<section data-pdf-bookmark="Specific Items and Subranges" data-type="sect2"><div class="sect2" id="specific_items_and_subranges">
<h2>Specific Items and Subranges</h2>
<p><a data-primary="LINQ operators" data-secondary="specific items and subranges" data-type="indexterm" id="ix_ch10-asciidoc28"/>It can be useful to write a query that produces just a single item. Perhaps you’re looking for the first object in a list that meets certain criteria, or maybe you want to fetch information in a database identified by a particular key. LINQ defines several operators that can do this and some related ones for working with a subrange of the items a query might return.</p>
<p><a data-primary="Single operator" data-type="indexterm" id="idm45884804984272"/><a data-primary="LINQ operators" data-secondary="Single" data-type="indexterm" id="idm45884804983568"/>Use the <code>Single</code> operator when you have a query that you believe should produce exactly one result. <a data-type="xref" href="#appling_the_single_operator_to_a_query">Example 10-36</a> shows just such a query—it looks up a course by its category and number, and in my sample data, this uniquely identifies a course.</p>
<div data-type="example" id="appling_the_single_operator_to_a_query">
<h5><span class="label">Example 10-36. </span>Applying the <code>Single</code> operator to a query</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">q</code> <code class="p">=</code> <code class="k">from</code> <code class="n">course</code> <code class="k">in</code> <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code>
        <code class="k">where</code> <code class="n">course</code><code class="p">.</code><code class="n">Category</code> <code class="p">==</code> <code class="s">"MAT"</code> <code class="p">&amp;&amp;</code> <code class="n">course</code><code class="p">.</code><code class="n">Number</code> <code class="p">==</code> <code class="m">101</code>
        <code class="k">select</code> <code class="n">course</code><code class="p">;</code>

<code class="n">Course</code> <code class="n">geometry</code> <code class="p">=</code> <code class="n">q</code><code class="p">.</code><code class="n">Single</code><code class="p">();</code></pre></div>
<p>Because LINQ queries are built by chaining operators together, we can take the query built by the query expression and add on another operator—the <code>Single</code> operator, in this case. While most operators would return an object representing another query (an <code>IEnumerable&lt;T&gt;</code> here, since we’re using LINQ to Objects), <code>Single</code> is different. Like <code>ToArray</code> and <code>ToList</code>, the <code>Single</code> operator evaluates the query immediately, but it then returns the one and only object that the query produced. If the query fails to produce exactly one object—perhaps it produces no items, or two—this will throw an <code>InvalidOperationException</code>. (Since this is another of the operators that produces a result immediately, some providers offer <code>SingleAsync</code> as described in the sidebar <a data-type="xref" href="#immediate_evaluation_and_async">“Asynchronous Immediate Evaluation”</a>.)</p>
<p>There’s an overload of the <code>Single</code> operator that takes a predicate. As <a data-type="xref" href="#single_operator_with_predicate">Example 10-37</a> shows, this allows us to express the same logic as the whole of <a data-type="xref" href="#appling_the_single_operator_to_a_query">Example 10-36</a> more compactly. (As with the <code>Where</code> operator, all the predicate-based operators in this section use <code>Func&lt;T, bool&gt;</code>, not <code>Predicate&lt;T&gt;</code>.)</p>
<div data-type="example" id="single_operator_with_predicate">
<h5><span class="label">Example 10-37. </span>The <code>Single</code> operator with predicate</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">Course</code> <code class="n">geometry</code> <code class="p">=</code> <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code><code class="p">.</code><code class="n">Single</code><code class="p">(</code>
    <code class="n">course</code> <code class="p">=&gt;</code> <code class="n">course</code><code class="p">.</code><code class="n">Category</code> <code class="p">==</code> <code class="s">"MAT"</code> <code class="p">&amp;&amp;</code> <code class="n">course</code><code class="p">.</code><code class="n">Number</code> <code class="p">==</code> <code class="m">101</code><code class="p">);</code></pre></div>
<p>The <code>Single</code> operator is unforgiving: if your query does not return exactly one item, it will throw an exception. There’s a slightly more flexible variant called <code>Sin⁠gle⁠Or​Def⁠ault</code>, which allows a query to return either one item or no items. If the query returns nothing, this method returns the default value for the item type (i.e., <code>null</code> if it’s a reference type, <code>0</code> if it’s a numeric type, etc.). Multiple matches still cause an exception. As with <code>Single</code>, there are two overloads: one with no arguments for use on a source that you believe contains no more than one object, and one that takes a predicate lambda.</p>
<p><a data-primary="First operator" data-type="indexterm" id="idm45884804879216"/><a data-primary="FirstOrDefault operator" data-type="indexterm" id="idm45884804878112"/><a data-primary="LINQ operators" data-secondary="First" data-type="indexterm" id="idm45884804877440"/><a data-primary="LINQ operators" data-secondary="FirstOrDefault" data-type="indexterm" id="idm45884804876496"/>LINQ defines two related operators, <code>First</code> and <code>FirstOrDefault</code>, each of which offers overloads taking no arguments or a predicate. For sequences containing zero or one matching items, these behave in exactly the same way as <code>Single</code> and <code>Sin⁠gle⁠Or​Def⁠ault</code>: they return the item if there is one; if there isn’t, <code>First</code> will throw an exception, while <code>FirstOrDefault</code> will return <code>null</code> or an equivalent value. However, these operators respond differently when there are multiple results—instead of throwing an exception, they just pick the first result and return that, discarding the rest. This might be useful if you want to find the most expensive item in a list—you could order a query by descending price and then pick the first result. <a data-type="xref" href="#using_first_to_select_the_longest_course">Example 10-38</a> uses a similar technique to pick the longest course from my sample data.</p>
<div data-type="example" id="using_first_to_select_the_longest_course">
<h5><span class="label">Example 10-38. </span>Using <code>First</code> to select the longest course</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">q</code> <code class="p">=</code> <code class="k">from</code> <code class="n">course</code> <code class="k">in</code> <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code>
        <code class="k">orderby</code> <code class="n">course</code><code class="p">.</code><code class="n">Duration</code> <code class="k">descending</code>
        <code class="k">select</code> <code class="n">course</code><code class="p">;</code>
<code class="n">Course</code> <code class="n">longest</code> <code class="p">=</code> <code class="n">q</code><code class="p">.</code><code class="n">First</code><code class="p">();</code></pre></div>
<p>If you have a query that doesn’t guarantee any particular order for its results, these operators will pick one item arbitrarily.</p>
<div data-type="tip"><h6>Tip</h6>
<p>Do not use <code>First</code> or <code>FirstOrDefault</code> unless you expect there to be multiple matches and you want to process only one of them. Some developers use these when they expect only a single match. The operators will work, of course, but the <code>Single</code> and <code>Sin⁠gle⁠Or​Def⁠ault</code> operators more accurately express your expectations. They will let you know when your expectations were misplaced, throwing an exception when there are multiple matches. If your code embodies incorrect assumptions, it’s usually best to know about it instead of plowing on regardless.</p>
</div>
<p><a data-primary="Last operator" data-type="indexterm" id="idm45884804796048"/>The existence of <code>First</code> and <code>FirstOrDefault</code> raises an obvious question: Can I pick the last item? The answer is yes; there are also <code>Last</code> and <code>LastOrDefault</code> operators, and again, each offers two overloads—one taking no arguments and one taking a predicate.</p>
<p>.NET 6.0 <a data-primary=".NET 6.0" data-primary-sortas="NET 6.0" data-secondary="overloads for zero-like value" data-type="indexterm" id="idm45884804792848"/><a data-primary="LINQ operators" data-secondary="SingleOrDefault" data-type="indexterm" id="idm45884804784848"/><a data-primary="SingleOrDefault operator" data-type="indexterm" id="idm45884804784000"/>adds a refinement to <code>SingleOrDefault</code>, <code>FirstOrDefault</code>, and <code>Las⁠tOr​Def⁠ault</code>. These get new overloads enabling you to supply a value to return as the default, instead of the usual zero-like value. This could be useful if you have a collection of <code>int</code> elements in which zero is a valid value. <a data-type="xref" href="#single_or_default_explicit_default">Example 10-39</a> shows how to use the new <code>SingleOrDefault</code> overload to get a value of −1 when the list is empty. This makes it possible to distinguish between an empty list and a list containing a single zero value. Of course, if all possible values for <code>int</code> are valid in your application, this doesn’t help you, and you’d need to detect an empty collection in some other way. But in cases where you can designate some special value to represent <em>not here</em> (e.g., −1 in this case), these new overloads are a helpful addition.</p>
<div data-type="example" id="single_or_default_explicit_default">
<h5><span class="label">Example 10-39. </span><code>SingleOrDefault</code> with explicit default value</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">int</code> <code class="n">valueOrNegative</code> <code class="p">=</code> <code class="n">numbers</code><code class="p">.</code><code class="n">SingleOrDefault</code><code class="p">(-</code><code class="m">1</code><code class="p">);</code></pre></div>
<p><a data-primary="ElementAt operator" data-type="indexterm" id="idm45884804773824"/><a data-primary="ElementAtOrDefault operator" data-type="indexterm" id="idm45884804772784"/><a data-primary="LINQ operators" data-secondary="ElementAt" data-type="indexterm" id="idm45884804772176"/><a data-primary="LINQ operators" data-secondary="ElementAtOrDefault" data-type="indexterm" id="idm45884804771296"/>The next obvious question is: What if I want a particular element that’s neither the first nor the last? Your wish is, in this particular instance, LINQ’s command, because it offers <code>ElementAt</code> and <code>ElementAtOrDefault</code> operators, both of which take just an index. This provides a way to access elements of any <code>IEnumerable&lt;T&gt;</code> by index. You can specify the index as an <code>int</code>. <a data-primary=".NET 6.0" data-primary-sortas="NET 6.0" data-secondary="overloads taking an Index" data-type="indexterm" id="idm45884804756208"/>Alternatively, .NET 6.0 adds overloads taking an <code>Index</code>, which, as you may recall from <a data-type="xref" href="ch05.xhtml#index_and_range">“Addressing Elements with Index and Range Syntax”</a>, enables the use of end-relative positions. For example, <code>^2</code> denotes the second-from-last element. (Oddly, <code>ElementAtOrDefault</code> didn’t get a new overload for specifying the default value, unlike the three operators discussed in the preceding paragraph.)</p>
<p>You need to be careful with <code>ElementAt</code> and <code>ElementAtOrDefault</code> because they can be surprisingly expensive. If you ask for the 10,000th element, these operators may need to request and discard the first 9,999 elements to get there. If you specify an end-relative position by writing, say, <code>source.ElementAt(^500)</code>, the operator may need to read every single element to find out which is the last, and with that particular example, it may also have to hang onto the last 500 elements it has seen because until it gets to the end, it doesn’t know which element will be the one it ultimately has to return.</p>
<p>As it happens, LINQ to Objects detects when the source object implements <code>IList&lt;T&gt;</code>, in which case it uses the indexer to retrieve the element directly instead of going the slow way around. But not all <code>IEnumerable&lt;T&gt;</code> implementations support random access, so these operators can be very slow. In particular, even if your source implements <code>IList&lt;T&gt;</code>, once you’ve applied one or more LINQ operators to it, the output of those operators will typically not support indexing. So it would be particularly disastrous to use <code>ElementAt</code> in a loop of the kind shown in <a data-type="xref" href="#how_not_to_use_elementat">Example 10-40</a>.</p>
<div data-type="example" id="how_not_to_use_elementat">
<h5><span class="label">Example 10-40. </span>How not to use <code>ElementAt</code></h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">mathsCourses</code> <code class="p">=</code> <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code><code class="p">.</code><code class="n">Where</code><code class="p">(</code><code class="n">c</code> <code class="p">=&gt;</code> <code class="n">c</code><code class="p">.</code><code class="n">Category</code> <code class="p">==</code> <code class="s">"MAT"</code><code class="p">);</code>
<code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">i</code> <code class="p">=</code> <code class="m">0</code><code class="p">;</code> <code class="n">i</code> <code class="p">&lt;</code> <code class="n">mathsCourses</code><code class="p">.</code><code class="n">Count</code><code class="p">();</code> <code class="p">++</code><code class="n">i</code><code class="p">)</code>
<code class="p">{</code>
    <code class="c1">// Never do this!</code>
    <code class="n">Course</code> <code class="n">c</code> <code class="p">=</code> <code class="n">mathsCourses</code><code class="p">.</code><code class="n">ElementAt</code><code class="p">(</code><code class="n">i</code><code class="p">);</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">c</code><code class="p">.</code><code class="n">Title</code><code class="p">);</code>
<code class="p">}</code></pre></div>
<p>Even though <code>Course.Catalog</code> is an array, I’ve filtered its contents with the <code>Where</code> operator, which returns a query of type <code>IEnumerable&lt;Course&gt;</code> that does not implement <code>IList&lt;Course&gt;</code>. The first iteration won’t be too bad—I’ll be passing <code>ElementAt</code> an index of <code>0</code>, so it just returns the first match, and with my sample data, the very first item <code>Where</code> inspects will match. But the second time around the loop, we’re calling <code>ElementAt</code> again. The query that <code>mathsCourses</code> refers to does not keep track of where we got to in the previous loop—it’s an <code>IEnumerable&lt;T&gt;</code>, not an <code>IEnumerator&lt;T&gt;</code>—so this will start again. <code>ElementAt</code> will ask that query for the first item, which it will promptly discard, and then it will ask for the next item, and that becomes the return value. So the <code>Where</code> query has now been executed twice—the first time, <code>ElementAt</code> asked it for only one item, and then the second time it asked it for two, so it has processed the first course twice now. The third time around the loop (which happens to be the final time), we do it all again, but this time, <code>ElementAt</code> will discard the first two matches and will return the third, so now it has looked at the first course three times, the second one twice, and the third and fourth courses once. (The third course in my sample data is not in the <code>MAT</code> category, so the <code>Where</code> query will skip over this when asked for the third item.) So, to retrieve three items, I’ve evaluated the <code>Where</code> query three times, causing it to evaluate my filter lambda seven times.</p>
<p>In fact, it’s worse than that, because the <code>for</code> loop will also invoke that <code>Count</code> method each time, and with a nonindexable source such as the one returned by <code>Where</code>, <code>Count</code> has to evaluate the entire sequence—the only way the <code>Where</code> operator can tell you how many items match is to look at all of them. So this code fully evaluates the query returned by <code>Where</code> three times in addition to the three partial evaluations performed by <span class="keep-together"><code>ElementAt</code></span>. We get away with it here because the collection is small, but if I had an array with 1,000 elements, all of which turned out to match the filter, we’d be fully evaluating the <code>Where</code> query 1,000 times and performing partial evaluations another 1,000 times. Each full evaluation calls the filter predicate 1,000 times, and the partial evaluations here will do so on average 500 times, so the code would end up executing the filter 1,500,000 times. Iterating through the <code>Where</code> query with the <code>foreach</code> loop would evaluate the query just once, executing the filter expression 1,000 times, and would produce the same results.</p>
<p>So be careful with both <code>Count</code> and <code>ElementAt</code>. If you use them in a loop that iterates over the collection on which you invoke them, the resulting code will have O(<em>n</em><sup>2</sup>) complexity (i.e., the cost of running the code rises proportionally to the number of items squared).</p>
<p><a data-primary="LINQ operators" data-secondary="Skip" data-type="indexterm" id="idm45884804623904"/><a data-primary="Skip operator" data-type="indexterm" id="idm45884804622592"/><a data-primary="LINQ operators" data-secondary="Take" data-type="indexterm" id="idm45884804621920"/><a data-primary="Take operator" data-type="indexterm" id="idm45884804620976"/><a data-primary="LINQ operators" data-secondary="SkipLast" data-type="indexterm" id="idm45884804620304"/><a data-primary="SkipLast operator" data-type="indexterm" id="idm45884804619360"/><a data-primary="LINQ operators" data-secondary="TakeLast" data-type="indexterm" id="idm45884804618688"/><a data-primary="TakeLast operator" data-type="indexterm" id="idm45884804617744"/>All of the operators I’ve just described return a single item from the source. There are four more operators that also get selective about which items to use but can return multiple items: <code>Skip</code>, <code>Take</code>, <code>SkipLast</code>, and <code>TakeLast</code>. Each of these takes a single <code>int</code> argument. As the name suggests, <code>Skip</code> discards the specified number of elements from the beginning of the sequence and then returns everything else from its source. <code>Take</code> returns the specified number of elements from the start of the sequence and then discards the rest (so it is similar to <code>TOP</code> in SQL). <code>SkipLast</code> and <code>TakeLast</code> do the same except they work at the end, e.g., you could use <code>TakeLast</code> to get the final 5 items from the source, or <code>SkipLast</code> to omit the final 5 items.</p>
<p>.NET 6.0 <a data-primary=".NET 6.0" data-primary-sortas="NET 6.0" data-secondary="overload to Take" data-type="indexterm" id="idm45884804611344"/>adds an overload to <code>Take</code> that accepts a <code>Range</code>, enabling the use of the range syntax described in <a data-type="xref" href="ch05.xhtml#index_and_range">“Addressing Elements with Index and Range Syntax”</a>. For example, <code>source.Take(10..^10)</code> skips the first 10 and also the last 10 items (so it is equivalent to <code>source.Skip(10).SkipLast(10)</code>). Since the range syntax lets you use either start- or end-relative indexes for both the start and end of the range, we can express other combinations with this overload of <code>Take</code>. For example, <code>source.Take(10..20)</code> has the same effect as <code>source.Skip(10).Take(10)</code>; <code>source.Take(^10..^2)</code> is equivalent to <code>source.TakeLast(10).SkipLast(2)</code>.</p>
<p><a data-primary="LINQ operators" data-secondary="SkipWhile" data-type="indexterm" id="idm45884804604304"/><a data-primary="SkipWhile operator" data-type="indexterm" id="idm45884804603328"/><a data-primary="LINQ operators" data-secondary="TakeWhile" data-type="indexterm" id="idm45884804602656"/><a data-primary="TakeWhile operator" data-type="indexterm" id="idm45884804601712"/>There are also predicate-driven versions, <code>SkipWhile</code> and <code>TakeWhile</code>. <code>SkipWhile</code> will discard items from the sequence until it finds one that matches the predicate, at which point it will return that and every item that follows for the rest of the sequence (whether or not the remaining items match the predicate). Conversely, <code>TakeWhile</code> returns items until it encounters the first item that does not match the predicate, at which point it discards that and the remainder of the sequence.</p>
<p><a data-primary="IOrderedEnumerable&lt;T&gt; interface" data-type="indexterm" id="idm45884804598768"/>Although <code>Skip</code>, <code>Take</code>, <code>SkipLast</code>, <code>TakeLast</code>, <code>SkipWhile</code>, and <code>TakeWhile</code> are all clearly order-sensitive, they are not restricted to just the ordered types, such as <code>IOr⁠der⁠ed​Enu⁠mer⁠abl⁠e&lt;T&gt;</code>. They are also defined for <code>IEnumerable&lt;T&gt;</code>, which is reasonable, because even though there may be no particular order guaranteed, an 
<span class="keep-together"><code>IEnumerable&lt;T&gt;</code></span> always produces elements in some order. (The only way you can extract items from an <code>IEnumerable&lt;T&gt;</code> is one after another, so there will always be an order, even if it’s arbitrary. It might not be the same every time you enumerate the items, but for any single evaluation, the items must come out in some order.) Moreover, <code>IOrderedEnumerable&lt;T&gt;</code> is not widely implemented outside of LINQ, so it’s quite common to have <span class="keep-together">non-LINQ-aware</span> objects that produce items in a known order but that implement only <code>IEnumerable&lt;T&gt;</code>. These operators are useful in these scenarios, so the restriction is relaxed. Slightly more surprisingly, <code>IQueryable&lt;T&gt;</code> also supports these operations, but that’s consistent with the fact that many databases support <code>TOP</code> (roughly equivalent to <code>Take</code>) even on unordered queries. As always, individual providers may choose not to support individual operations, so in scenarios where there’s no reasonable interpretation of these operators, they will just throw an exception.<a data-startref="ix_ch10-asciidoc28" data-type="indexterm" id="idm45884804589344"/></p>
</div></section>
<section data-pdf-bookmark="Aggregation" data-type="sect2"><div class="sect2" id="aggregation">
<h2>Aggregation</h2>
<p><a data-primary="aggregation" data-type="indexterm" id="ix_ch10-asciidoc29"/><a data-primary="LINQ operators" data-secondary="aggregation" data-type="indexterm" id="ix_ch10-asciidoc30"/><a data-primary="Sum operator" data-type="indexterm" id="idm45884804584544"/>The <code>Sum</code> and <code>Average</code> operators add together the values of all the source items. <code>Sum</code> returns the total, and <code>Average</code> returns the total divided by the number of items. LINQ providers that support these typically make them available for collections of items of these numeric types: <code>decimal</code>, <code>double</code>, <code>float</code>, <code>int</code>, and <code>long</code>. There are also overloads that work with any item type in conjunction with a lambda that takes an item and returns one of those numeric types. That allows us to write code such as <a data-type="xref" href="#average_operator_with_projection">Example 10-41</a>, which works with a collection of <code>Course</code> objects and calculates the average of a particular value extracted from the object: the course length in hours.</p>
<div data-type="example" id="average_operator_with_projection">
<h5><span class="label">Example 10-41. </span><code>Average</code> operator with projection</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"Average course length in hours: {0}"</code><code class="p">,</code>
    <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code><code class="p">.</code><code class="n">Average</code><code class="p">(</code><code class="n">course</code> <code class="p">=&gt;</code> <code class="n">course</code><code class="p">.</code><code class="n">Duration</code><code class="p">.</code><code class="n">TotalHours</code><code class="p">));</code></pre></div>
<p><a data-primary="Min operator" data-type="indexterm" id="idm45884804561744"/><a data-primary="Max operator" data-type="indexterm" id="idm45884804570992"/>LINQ also defines <code>Min</code> and <code>Max</code> operators. You can apply these to any type of sequence, although it is not guaranteed to succeed—the particular provider you’re using may report an error if it doesn’t know how to compare the types you’ve used. For example, LINQ to Objects requires the objects in the sequence to implement <code>IComparable</code>.</p>
<p><code>Min</code> and <code>Max</code> both have overloads that accept a lambda that gets the value to use from the source item. <a data-type="xref" href="#max_with_projection">Example 10-42</a> uses this to find the date on which the most recent course was published.</p>
<div data-type="example" id="max_with_projection">
<h5><span class="label">Example 10-42. </span><code>Max</code> with projection</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">DateOnly</code> <code class="n">m</code> <code class="p">=</code> <code class="n">mathsCourses</code><code class="p">.</code><code class="n">Max</code><code class="p">(</code><code class="n">c</code> <code class="p">=&gt;</code> <code class="n">c</code><code class="p">.</code><code class="n">PublicationDate</code><code class="p">);</code></pre></div>
<p><a data-primary="MaxBy operator" data-type="indexterm" id="idm45884804546064"/><a data-primary="MinBy operator" data-type="indexterm" id="idm45884804545232"/>Notice that this does not return the course with the most recent publication date; it returns that course’s publication date. If you want to select the object for which a particular property has the maximum value, you can use <code>MaxBy</code>. <a data-type="xref" href="#max_by_projection">Example 10-43</a> will find the course with the highest <code>PublicationDate</code>, but unlike <a data-type="xref" href="#max_with_projection">Example 10-42</a>, it returns the relevant course, instead of the date. (As you might expect, there’s also a <code>MinBy</code>.)</p>
<div data-type="example" id="max_by_projection">
<h5><span class="label">Example 10-43. </span><code>Max</code> with projection for criteria but not for result</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">Course</code><code class="p">?</code> <code class="n">mostRecentlyPublished</code> <code class="p">=</code> <code class="n">mathsCourses</code><code class="p">.</code><code class="n">MaxBy</code><code class="p">(</code><code class="n">c</code> <code class="p">=&gt;</code> <code class="n">c</code><code class="p">.</code><code class="n">PublicationDate</code><code class="p">);</code></pre></div>
<p>You may have spotted the <code>?</code> in that example, indicating that <code>MaxBy</code> might return a <code>null</code> result. This happens with both <code>Max</code> and <code>MaxBy</code> in cases where the input collection is empty and the output type is either a reference type or a nullable form of one of the supported numeric types (e.g., <code>int?</code> or <code>double?</code>). When the output is a non-nullable struct (e.g., <code>DateOnly</code>, as with <a data-type="xref" href="#max_with_projection">Example 10-42</a>), these operators cannot return <code>null</code> and will throw an <code>InvalidOperationException</code> instead. If you are working with a reference type and you want an exception for an empty input like you would get if the output were a value type, the only way to do that is to check for a <code>null</code> result yourself and throw an exception. <a data-type="xref" href="#max_by_projection_no_null">Example 10-44</a> shows one way to do this.</p>
<div data-type="example" id="max_by_projection_no_null">
<h5><span class="label">Example 10-44. </span><code>Max</code> with projection for criteria but not for result with error on empty input</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">Course</code> <code class="n">mostRecentlyPublished</code> <code class="p">=</code> <code class="n">mathsCourses</code><code class="p">.</code><code class="n">MaxBy</code><code class="p">(</code><code class="n">c</code> <code class="p">=&gt;</code> <code class="n">c</code><code class="p">.</code><code class="n">PublicationDate</code><code class="p">)</code>
    <code class="p">??</code> <code class="k">throw</code> <code class="k">new</code> <code class="n">InvalidOperationException</code><code class="p">(</code><code class="s">"Collection must not be empty"</code><code class="p">);</code></pre></div>
<p>LINQ to Objects defines specialized overloads of <code>Min</code> and <code>Max</code> for sequences that return the same numeric types that <code>Sum</code> and <code>Average</code> deal with (i.e., <code>decimal</code>, <code>double</code>, <code>float</code>, <code>int</code>, and <code>long</code> and their nullable forms). It also defines similar specializations for the form that takes a lambda. These overloads exist to improve performance by avoiding boxing. The general-purpose form relies on <code>IComparable</code>, and getting an interface type reference to a value always involves boxing that value. For large collections, boxing every single value would put considerable extra pressure 
<span class="keep-together">on the GC.</span></p>
<p><a data-primary="Aggregate operator" data-type="indexterm" id="ix_ch10-asciidoc31"/><a data-primary="LINQ operators" data-secondary="Aggregate" data-type="indexterm" id="ch10-agg"/>LINQ defines an operator called <code>Aggregate</code>, which generalizes the pattern that <code>Min</code>, <code>Max</code>, <code>Sum</code>, and <code>Average</code> all use, which is to produce a single result with a process that involves taking every source item into consideration. It’s possible to implement all four of these operators (and their <code>...By</code> counterparts) in terms of <code>Aggregate</code>. <a data-type="xref" href="#sum_and_equivalent_with_aggregate">Example 10-45</a> uses the <code>Sum</code> operator to calculate the total duration of all courses, and then shows how to use the <code>Aggregate</code> operator to perform the exact same calculation.</p>
<div data-type="example" id="sum_and_equivalent_with_aggregate">
<h5><span class="label">Example 10-45. </span><code>Sum</code> and equivalent with <code>Aggregate</code></h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">double</code> <code class="n">t1</code> <code class="p">=</code> <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code><code class="p">.</code><code class="n">Sum</code><code class="p">(</code><code class="n">course</code> <code class="p">=&gt;</code> <code class="n">course</code><code class="p">.</code><code class="n">Duration</code><code class="p">.</code><code class="n">TotalHours</code><code class="p">);</code>
<code class="kt">double</code> <code class="n">t2</code> <code class="p">=</code> <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code><code class="p">.</code><code class="n">Aggregate</code><code class="p">(</code>
    <code class="m">0.0</code><code class="p">,</code> <code class="p">(</code><code class="n">hours</code><code class="p">,</code> <code class="n">course</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="n">hours</code> <code class="p">+</code> <code class="n">course</code><code class="p">.</code><code class="n">Duration</code><code class="p">.</code><code class="n">TotalHours</code><code class="p">);</code></pre></div>
<p><a data-primary="accumulator" data-type="indexterm" id="idm45884804371888"/>Aggregation works by building up a value that represents what we know about all the items inspected so far, referred to as the <em>accumulator</em>. The type we use depends on the knowledge we want to accumulate. Here, I’m just adding all the numbers together, so I’ve used a <code>double</code> (because the <code>TimeSpan</code> type’s <code>TotalHours</code> property is also a <code>double</code>).</p>
<p>Initially we have no knowledge, because we haven’t looked at any items yet. <a data-primary="seed" data-type="indexterm" id="idm45884804302096"/>We need to provide an accumulator value to represent this starting point, so the <code>Aggregate</code> operator’s first argument is the <em>seed</em>, an initial value for the accumulator. In <a data-type="xref" href="#sum_and_equivalent_with_aggregate">Example 10-45</a>, the accumulator is just a running total, so the seed is <code>0.0</code>.</p>
<p>The second argument is a lambda that describes how to update the accumulator to incorporate information for a single item. Since my goal here is simply to calculate the total time, I just add the duration of the current course to the running total.</p>
<p>Once <code>Aggregate</code> has looked at every item, this particular overload returns the accumulator directly. It will be the total number of hours across all courses in this case. We can implement <code>Max</code> if we use a different accumulation strategy. Instead of maintaining a running total, the value representing everything we know so far about the data is simply the highest value seen yet. <a data-type="xref" href="#implementing_max_with_aggregate">Example 10-46</a> shows the rough equivalent of <a data-type="xref" href="#max_with_projection">Example 10-42</a>. (It’s not exactly the same, because <a data-type="xref" href="#implementing_max_with_aggregate">Example 10-46</a> makes no attempt to detect an empty source. <code>Max</code> will throw an exception if this source is empty, but this will just return the date 0/0/0000.)</p>
<div data-type="example" id="implementing_max_with_aggregate">
<h5><span class="label">Example 10-46. </span>Implementing <code>Max</code> with <code>Aggregate</code></h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">DateOnly</code> <code class="n">m</code> <code class="p">=</code> <code class="n">mathsCourses</code><code class="p">.</code><code class="n">Aggregate</code><code class="p">(</code>
    <code class="k">new</code> <code class="nf">DateOnly</code><code class="p">(),</code>
    <code class="p">(</code><code class="n">date</code><code class="p">,</code> <code class="n">c</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="n">date</code> <code class="p">&gt;</code> <code class="n">c</code><code class="p">.</code><code class="n">PublicationDate</code> <code class="p">?</code> <code class="n">date</code> <code class="p">:</code> <code class="n">c</code><code class="p">.</code><code class="n">PublicationDate</code><code class="p">);</code></pre></div>
<p>This illustrates that <code>Aggregate</code> does not impose any single meaning for the value that accumulates knowledge—the way you use it depends on what you’re doing. Some operations require an accumulator with a bit more structure. <a data-type="xref" href="#implementing_average_with_aggregate">Example 10-47</a> calculates the average course duration with <code>Aggregate</code>.</p>
<div data-type="example" id="implementing_average_with_aggregate">
<h5><span class="label">Example 10-47. </span>Implementing <code>Average</code> with <code>Aggregate</code></h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">double</code> <code class="n">average</code> <code class="p">=</code> <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code><code class="p">.</code><code class="n">Aggregate</code><code class="p">(</code>
    <code class="k">new</code> <code class="p">{</code> <code class="n">TotalHours</code> <code class="p">=</code> <code class="m">0.0</code><code class="p">,</code> <code class="n">Count</code> <code class="p">=</code> <code class="m">0</code> <code class="p">},</code>
    <code class="p">(</code><code class="n">totals</code><code class="p">,</code> <code class="n">course</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="k">new</code>
    <code class="p">{</code>
        <code class="n">TotalHours</code> <code class="p">=</code> <code class="n">totals</code><code class="p">.</code><code class="n">TotalHours</code> <code class="p">+</code> <code class="n">course</code><code class="p">.</code><code class="n">Duration</code><code class="p">.</code><code class="n">TotalHours</code><code class="p">,</code>
        <code class="n">Count</code> <code class="p">=</code> <code class="n">totals</code><code class="p">.</code><code class="n">Count</code> <code class="p">+</code> <code class="m">1</code>
    <code class="p">},</code>
    <code class="n">totals</code> <code class="p">=&gt;</code> <code class="n">totals</code><code class="p">.</code><code class="n">Count</code> <code class="p">&gt;</code> <code class="m">0</code>
        <code class="p">?</code> <code class="n">totals</code><code class="p">.</code><code class="n">TotalHours</code> <code class="p">/</code> <code class="n">totals</code><code class="p">.</code><code class="n">Count</code>
        <code class="p">:</code> <code class="k">throw</code> <code class="k">new</code> <code class="n">InvalidOperationException</code><code class="p">(</code><code class="s">"Sequence was empty"</code><code class="p">));</code></pre></div>
<p>The average duration requires us to know two things: the total duration and the number of items. So, in this example, my accumulator uses a type that can contain two values, one to hold the total and one to hold the item count. I’ve used an anonymous type because as already mentioned, that is sometimes the only option in LINQ, and I want to show the most general case. However, it’s worth mentioning that in this particular case, a tuple might be better. It will work because this is LINQ to Objects, and since lightweight tuples are value types whereas anonymous types are reference types, a tuple would reduce the number of objects being allocated.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><a data-type="xref" href="#implementing_average_with_aggregate">Example 10-47</a> relies on the fact that when two separate methods in the same component create instances of two structurally identical anonymous types, the compiler generates a single type that is used for both. The seed produces an instance of an anonymous type consisting of a <code>double</code> called <code>TotalHours</code> and an <code>int</code> called <code>Count</code>. The accumulation lambda also returns an instance of an anonymous type with the same member names and types in the same order. The C# compiler deems that these will be the same type, which is important, because <code>Aggregate</code> requires the lambda to accept and also return an instance of the accumulator type.</p>
</div>
<p><a data-type="xref" href="#implementing_average_with_aggregate">Example 10-47</a> uses a different overload than the earlier example. It takes an extra lambda, which is used to extract the return value from the accumulator—the accumulator builds up the information I need to produce the result, but the accumulator itself is not the result in this example.</p>
<p>Of course, if all you want to do is calculate the sum, maximum, or average values, you wouldn’t use <code>Aggregate</code>—you’d use the specialized operators designed to do those jobs. Not only are they simpler, but they’re often more efficient. (For example, a LINQ provider for a database might be able to generate a query that uses the database’s built-in features to calculate the minimum or maximum value.) I just wanted to show the flexibility, using examples that are easily understood. But now that I’ve done that, <a data-type="xref" href="#aggregating_bounding_boxes">Example 10-48</a> shows a particularly concise example of <code>Aggregate</code> that doesn’t correspond to any other built-in operator. This takes a collection of rectangles and returns the bounding box that contains all of those rectangles.<a data-primary="Union operator" data-type="indexterm" id="idm45884804111152"/><a data-primary="LINQ operators" data-secondary="Union" data-type="indexterm" id="idm45884804110448"/></p>
<div data-type="example" id="aggregating_bounding_boxes">
<h5><span class="label">Example 10-48. </span>Aggregating bounding boxes</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">static</code> <code class="n">Rect</code> <code class="nf">GetBounds</code><code class="p">(</code><code class="n">IEnumerable</code><code class="p">&lt;</code><code class="n">Rect</code><code class="p">&gt;</code> <code class="n">rects</code><code class="p">)</code> <code class="p">=&gt;</code>
    <code class="n">rects</code><code class="p">.</code><code class="n">Aggregate</code><code class="p">(</code><code class="n">Rect</code><code class="p">.</code><code class="n">Union</code><code class="p">);</code></pre></div>
<p>The <code>Rect</code> structure in this example is from the <code>System.Windows</code> namespace. This is part of WPF, and it’s a very simple data structure that just contains four numbers—<code>X</code>, <code>Y</code>, <code>Width</code>, and <code>Height</code>—so you can use it in non-WPF applications if you like.<sup><a data-type="noteref" href="ch10.xhtml#CHP-10-FN-1" id="CHP-10-FN-1-marker">2</a></sup> <a data-type="xref" href="#aggregating_bounding_boxes">Example 10-48</a> uses the <code>Rect</code> type’s static <code>Union</code> method, which takes two <code>Rect</code> arguments and returns a single <code>Rect</code> that is the bounding box of the two inputs (i.e., the smallest rectangle that contains both of the input rectangles).</p>
<p>I’m using the simplest overload of <code>Aggregate</code> here. It does the same thing as the one I used in <a data-type="xref" href="#sum_and_equivalent_with_aggregate">Example 10-45</a>, but it doesn’t require me to supply a seed—it just uses the first item in the list. <a data-type="xref" href="#more_verbose_and_less_obscure_bounding_b">Example 10-49</a> is equivalent to <a data-type="xref" href="#aggregating_bounding_boxes">Example 10-48</a> but makes the steps more explicit. I’ve provided the first <code>Rect</code> in the sequence as an explicit seed value, using <code>Skip</code> to aggregate over everything except that first element. I’ve also written a lambda to invoke the method, instead of passing the method itself. If you’re using this sort of lambda that just passes its arguments straight on to an existing method with LINQ to Objects, you can just pass the method name instead, and it will call the target method directly rather than going through your lambda. (You can’t do that with expression-based providers, because they require a lambda.)</p>
<p>Using the method directly is more succinct and marginally more efficient, but it also makes for slightly obscure code, which is why I’ve spelled it out in <a data-type="xref" href="#more_verbose_and_less_obscure_bounding_b">Example 10-49</a>.</p>
<div data-type="example" id="more_verbose_and_less_obscure_bounding_b">
<h5><span class="label">Example 10-49. </span>More verbose and less obscure bounding box aggregation</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="k">static</code> <code class="n">Rect</code> <code class="nf">GetBounds</code><code class="p">(</code><code class="n">IEnumerable</code><code class="p">&lt;</code><code class="n">Rect</code><code class="p">&gt;</code> <code class="n">rects</code><code class="p">)</code>
<code class="p">{</code>
    <code class="n">IEnumerable</code><code class="p">&lt;</code><code class="n">Rect</code><code class="p">&gt;</code> <code class="n">theRest</code> <code class="p">=</code> <code class="n">rects</code><code class="p">.</code><code class="n">Skip</code><code class="p">(</code><code class="m">1</code><code class="p">);</code>
    <code class="k">return</code> <code class="n">theRest</code><code class="p">.</code><code class="n">Aggregate</code><code class="p">(</code><code class="n">rects</code><code class="p">.</code><code class="n">First</code><code class="p">(),</code> <code class="p">(</code><code class="n">r1</code><code class="p">,</code> <code class="n">r2</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="n">Rect</code><code class="p">.</code><code class="n">Union</code><code class="p">(</code><code class="n">r1</code><code class="p">,</code> <code class="n">r2</code><code class="p">));</code>
<code class="p">}</code></pre></div>
<p>These two examples work the same way. They start with the first rectangle as the seed. For the next item in the list, <code>Aggregate</code> will call <code>Rect.Union</code>, passing in the seed and the second rectangle. The result—the bounding box of the first two rectangles—becomes the new accumulator value. And that then gets passed to <code>Union</code> along with the third rectangle, and so on. <a data-type="xref" href="#the_effect_of_aggregate">Example 10-50</a> shows what the effect of this <code>Aggregate</code> operation would be if performed on a collection of four <code>Rect</code> values. (I’ve represented the four values here as <code>r1</code>, <code>r2</code>, <code>r3</code>, and <code>r4</code>. To pass them to <code>Aggregate</code>, they’d need to be inside a collection such as an array.)</p>
<div data-type="example" id="the_effect_of_aggregate">
<h5><span class="label">Example 10-50. </span>The effect of <code>Aggregate</code></h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">Rect</code> <code class="n">bounds</code> <code class="p">=</code> <code class="n">Rect</code><code class="p">.</code><code class="n">Union</code><code class="p">(</code><code class="n">Rect</code><code class="p">.</code><code class="n">Union</code><code class="p">(</code><code class="n">Rect</code><code class="p">.</code><code class="n">Union</code><code class="p">(</code><code class="n">r1</code><code class="p">,</code> <code class="n">r2</code><code class="p">),</code> <code class="n">r3</code><code class="p">),</code> <code class="n">r4</code><code class="p">);</code></pre></div>
<p><code>Aggregate</code> is LINQ’s name for an operation some other languages call <em>reduce</em>. You also sometimes see it called <em>fold</em>. LINQ went with the name <code>Aggregate</code> for the same reason it calls its projection operator <code>Select</code> instead of <em>map</em> (the more common name in functional programming languages): LINQ’s terminology is more influenced by SQL than it is by functional programming languages<a data-startref="ix_ch10-asciidoc31" data-type="indexterm" id="idm45884803941696"/>.<a data-startref="ix_ch10-asciidoc30" data-type="indexterm" id="idm45884803940864"/><a data-startref="ix_ch10-asciidoc29" data-type="indexterm" id="idm45884803940160"/><a data-startref="ch10-agg" data-type="indexterm" id="idm45884803939488"/></p>
</div></section>
<section data-pdf-bookmark="Set Operations" data-type="sect2"><div class="sect2" id="set_operations">
<h2>Set Operations</h2>
<p><a data-primary="LINQ operators" data-secondary="set operations" data-type="indexterm" id="idm45884803937488"/><a data-primary="set operations, LINQ" data-type="indexterm" id="idm45884803936288"/><a data-primary="Except operator" data-type="indexterm" id="idm45884803904464"/><a data-primary="Intersect operator" data-type="indexterm" id="idm45884803903856"/>LINQ defines three operators that use some common set operations to combine two sources. <code>Intersect</code> produces a result that contains only those items that were in both of the input sources. <code>Except</code> includes only those items from the first input source that were not in the second. The output of <code>Union</code><sup><a data-type="noteref" href="ch10.xhtml#idm45884803901728" id="idm45884803901728-marker">3</a></sup> contains items that were in either (or both) of the input sources.</p>
<p>Although LINQ defines these set operations, most LINQ source types do not correspond directly to the abstraction of a set. With a mathematical set, any particular item either belongs to a set or it does not, with no innate concept of order or of the number of times a particular item appears in a set. <code>IEnumerable&lt;T&gt;</code> is not like that—it’s a sequence of items, so it’s possible to have duplicates, and the same is true of <code>IQueryable&lt;T&gt;</code>. This is not necessarily a problem, because some collections will happen never to get into a situation where they contain duplicates, and in some cases, the presence of duplicates won’t cause a problem. However, it can sometimes be useful to take a collection that contains duplicates and remove them. <a data-primary="Distinct operator" data-type="indexterm" id="idm45884803899216"/>For this, LINQ defines the <code>Distinct</code> operator, which removes duplicates. <a data-type="xref" href="#removing_duplicates_with_distinct">Example 10-51</a> contains a query that extracts the category names from all the courses and then feeds that into the <code>Distinct</code> operator to ensure that each unique category name appears just once.</p>
<div data-type="example" id="removing_duplicates_with_distinct">
<h5><span class="label">Example 10-51. </span>Removing duplicates with <code>Distinct</code></h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">categories</code> <code class="p">=</code> <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code><code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">c</code> <code class="p">=&gt;</code> <code class="n">c</code><code class="p">.</code><code class="n">Category</code><code class="p">).</code><code class="n">Distinct</code><code class="p">();</code></pre></div>
<p>All of these set operators are available in two forms, because you can optionally pass any of them an <code>IEqualityComparer&lt;T&gt;</code>. This allows you to customize how the operators decide whether two items are the same thing.</p>
<p>.NET 6.0 <a data-primary=".NET 6.0" data-primary-sortas="NET 6.0" data-secondary="IntersectBy, ExceptBy, UnionBy, DistinctBy operators" data-type="indexterm" id="idm45884803890032"/><a data-primary="DistinctBy operator" data-type="indexterm" id="idm45884803888496"/><a data-primary="ExceptBy operator" data-type="indexterm" id="idm45884803887824"/><a data-primary="IntersectBy operator" data-type="indexterm" id="idm45884803887152"/><a data-primary="UnionBy operator" data-type="indexterm" id="idm45884803886480"/><a data-primary="LINQ operators" data-secondary="IntersectBy" data-type="indexterm" id="idm45884803873568"/><a data-primary="LINQ operators" data-secondary="ExceptBy" data-type="indexterm" id="idm45884803872624"/><a data-primary="LINQ operators" data-secondary="UnionBy" data-type="indexterm" id="idm45884803871680"/><a data-primary="LINQ operators" data-secondary="DistinctBy" data-type="indexterm" id="idm45884803870736"/>adds <code>IntersectBy</code>, <code>ExceptBy</code>, <code>UnionBy</code>, and <code>DistinctBy</code> operators. These serve the same basic purpose as <code>Intersect</code>, <code>Except</code>, <code>Union</code>, and <code>Distinct</code> but with a different mechanism for determining equivalence. You can supply a lambda that takes an element from the source collection as input and produces any output you want. Two items are considered to be the same if this lambda produces the same result for both. (For example, you could write <code>courses.DistinctBy(c =&gt; c.Title)</code>, which would treat any two courses as being the same if they have the same <code>Title</code>.) You could have achieved the same effect without this by writing a custom <code>IEq⁠ual⁠ity​Com⁠par⁠er⁠&lt;T&gt;</code>, but a projection is often simpler. (There are also overloads of all four of these methods that accept an <code>IEqualityComparer&lt;T&gt;</code>. This can be useful if your projection produces a string and you want to specify the string comparison mechanism.)</p>
</div></section>
<section data-pdf-bookmark="Whole-Sequence, Order-Preserving Operations" data-type="sect2"><div class="sect2" id="whole-sequence_comma_order-preserving_op">
<h2>Whole-Sequence, Order-Preserving Operations</h2>
<p><a data-primary="LINQ operators" data-secondary="whole-sequence, order-preserving operations" data-type="indexterm" id="idm45884803862752"/>LINQ defines certain operators whose output includes every item from the source, and that preserve or reverse the order. Not all collections necessarily have an order, so these operators will not always be supported. However, LINQ to Objects supports all of them. <a data-primary="Reverse operator" data-type="indexterm" id="idm45884803861392"/><a data-primary="LINQ operators" data-secondary="Reverse" data-type="indexterm" id="idm45884803860720"/>The simplest is <code>Reverse</code>, which reverses the order of the elements.</p>
<p><a data-primary="Concat operator" data-type="indexterm" id="idm45884803858944"/><a data-primary="LINQ operators" data-secondary="Concat" data-type="indexterm" id="idm45884803858016"/>The <code>Concat</code> operator combines two sequences. It returns a sequence that produces all of the elements from the first sequence (in whatever order that sequence returns them), followed by all of the elements from the second sequence (again, preserving the order). In cases where you need to add just a single element to the end of the first sequence, you can use <code>Append</code> instead. There is also <code>Prepend</code>, which adds a single item at the start. The <code>Repeat</code> operator effectively concatenates the specified number of copies of the source.</p>
<p><a data-primary="DefaultIfEmpty operator" data-type="indexterm" id="idm45884803830464"/><a data-primary="LINQ operators" data-secondary="DefaultIfEmpty" data-type="indexterm" id="idm45884803829728"/>The <code>DefaultIfEmpty</code> operator returns all of the elements from its source. However, if the source is empty, it returns a single element. There are two overloads of this method: you can either specify the default value to return when the source is empty or, if you pass no argument, it will use the default, zero-like value of the element type.</p>
<p><a data-primary="Zip operator" data-type="indexterm" id="idm45884803827952"/><a data-primary="LINQ operators" data-secondary="Zip" data-type="indexterm" id="idm45884803827248"/>The <code>Zip</code> operator can also combine two sequences, but instead of returning one after the other, it works with pairs of elements. So the first item it returns will be based on both the first item from the first sequence and the first item from the second sequence. The second item in the zipped sequence will be based on the second items from each of the sequences, and so on. The name <code>Zip</code> is meant to bring to mind how a zipper in an article of clothing brings two things together in perfect alignment. (It’s not an exact analogy. When a zipper brings together the two parts, the teeth from the two halves interlock in an alternating fashion. But the <code>Zip</code> operator does not interleave its inputs like a physical zipper’s teeth. It brings items from the two sources together in pairs.)</p>
<p>We need to tell <code>Zip</code> how to combine items. It takes a lambda with two arguments, and it will pass item pairs from the two sources as those arguments and produce whatever your lambda returns as output items. <a data-type="xref" href="#combining_lists_with_zip">Example 10-52</a> uses a selector that combines each pair of items using string concatenation.</p>
<div data-type="example" id="combining_lists_with_zip">
<h5><span class="label">Example 10-52. </span>Combining lists with <code>Zip</code></h5>
<pre data-code-language="csharp" data-type="programlisting">
<code class="kt">string</code><code class="p">[</code><code class="p">]</code><code> </code><code class="n">firstNames</code><code> </code><code class="p">=</code><code> </code><code class="p">{</code><code> </code><code class="s">"Elisenda"</code><code class="p">,</code><code> </code><code class="s">"Jessica"</code><code class="p">,</code><code> </code><code class="s">"Liam"</code><code> </code><code class="p">}</code><code class="p">;</code><code>
</code><code class="kt">string</code><code class="p">[</code><code class="p">]</code><code> </code><code class="n">lastNames</code><code> </code><code class="p">=</code><code> </code><code class="p">{</code><code> </code><code class="s">"Gascon"</code><code class="p">,</code><code> </code><code class="s">"Hill"</code><code class="p">,</code><code> </code><code class="s">"Mooney"</code><code> </code><code class="p">}</code><code class="p">;</code><code>
</code><strong><code class="n">IEnumerable</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code><code> </code><code class="n">fullNames</code><code> </code><code class="p">=</code><code> </code><code class="n">firstNames</code><code class="p">.</code><code class="n">Zip</code><code class="p">(</code><code class="n">lastNames</code><code class="p">,</code></strong><code>
</code><code>    </code><strong><code class="p">(</code><code class="n">first</code><code class="p">,</code><code> </code><code class="n">last</code><code class="p">)</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">first</code><code> </code><code class="p">+</code><code> </code><code class="s">" "</code><code> </code><code class="p">+</code><code> </code><code class="n">last</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="k">foreach</code><code> </code><code class="p">(</code><code class="kt">string</code><code> </code><code class="n">name</code><code> </code><code class="k">in</code><code> </code><code class="n">fullNames</code><code class="p">)</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">name</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="p">}</code></pre></div>
<p>The two lists that this example zips together contain first names and last names, respectively. The output looks like this:</p>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">Elisenda</code> <code class="n">Gascon</code>
<code class="n">Jessica</code> <code class="n">Hill</code>
<code class="n">Liam</code> <code class="n">Mooney</code></pre>
<p>If the input sources contain different numbers of items, <code>Zip</code> will stop once it reaches the end of the shorter collection and will not attempt to retrieve any further items from the longer collection. It does not treat mismatched lengths as an error.</p>
<p>There are also overloads of <code>Zip</code> that do not require a lambda. These just return a sequence of tuples. There are two versions: one that combines a pair of sequences, producing 2-tuples, and another that takes three sequences, combining them into a sequence of 3-tuples. (There is no corresponding three-input lambda-based <code>Zip</code>.)</p>
<p><a data-primary="SequenceEqual operator" data-type="indexterm" id="idm45884803696400"/><a data-primary="LINQ operators" data-secondary="SequenceEqual" data-type="indexterm" id="idm45884803695696"/>The <code>SequenceEqual</code> operator bears a resemblance to <code>Zip</code> in that it works on two sequences and acts on pairs of items found at the same position in the two sequences. But, instead of passing them to a lambda to be combined, <code>SequenceEqual</code> just compares each pair. If this comparison process finds that the two sources contain the same number of items, and that for every pair, the two items are equal, then it returns <code>true</code>. If the sources are of different lengths, or if even just one pair of items is not equal, it returns <code>false</code>. <code>SequenceEqual</code> has two overloads, one that accepts just the list with which to compare the source and another that also takes an <code>IEqualityComparer&lt;T&gt;</code> to customize what you mean by equal.</p>
</div></section>
<section data-pdf-bookmark="Grouping" data-type="sect2"><div class="sect2" id="grouping">
<h2>Grouping</h2>
<p><a data-primary="grouping operators" data-type="indexterm" id="ix_ch10-asciidoc32"/><a data-primary="LINQ operators" data-secondary="grouping" data-type="indexterm" id="ix_ch10-asciidoc33"/>Sometimes you will want to process all items that have something in common as a group. <a data-type="xref" href="#grouping_query_expression">Example 10-53</a> uses a query to group courses by category, writing out a title for each category before listing all the courses in that category.</p>
<div data-type="example" id="grouping_query_expression">
<h5><span class="label">Example 10-53. </span>Grouping query expression</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">subjectGroups</code> <code class="p">=</code> <code class="k">from</code> <code class="n">course</code> <code class="k">in</code> <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code>
                    <code class="k">group</code> <code class="n">course</code> <code class="k">by</code> <code class="n">course</code><code class="p">.</code><code class="n">Category</code><code class="p">;</code>

<code class="k">foreach</code> <code class="p">(</code><code class="kt">var</code> <code class="k">group</code> <code class="k">in</code> <code class="n">subjectGroups</code><code class="p">)</code>
<code class="p">{</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="s">"Category: "</code> <code class="p">+</code> <code class="k">group</code><code class="p">.</code><code class="n">Key</code><code class="p">);</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">();</code>

    <code class="k">foreach</code> <code class="p">(</code><code class="kt">var</code> <code class="n">course</code> <code class="k">in</code> <code class="k">group</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">course</code><code class="p">.</code><code class="n">Title</code><code class="p">);</code>
    <code class="p">}</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">();</code>
<code class="p">}</code></pre></div>
<p>A <code>group</code> clause takes an expression that determines group membership—in this case, any courses whose <code>Category</code> properties return the same value will be deemed to be in the same group. A <code>group</code> clause produces a collection in which each item implements a type representing a group. Since I am using LINQ to Objects, and I am grouping by category string, the type of the <code>subjectGroup</code> variable in <a data-type="xref" href="#grouping_query_expression">Example 10-53</a> will be <code>IEnumerable&lt;IGrouping&lt;string, Course&gt;&gt;</code>. This particular example produces three group objects, depicted in <a data-type="xref" href="#result_of_evaluating_a_grouping_query">Figure 10-1</a>.</p>
<p>Each of the <code>IGrouping&lt;string, Course&gt;</code> items has a <code>Key</code> property, and because the query groups items by the course’s <code>Category</code> property, each key contains a string value from that property. There are three different category names in the sample data in <a data-type="xref" href="#sample_input_data_for_linq_queries">Example 10-17</a>: <code>MAT</code>, <code>BIO</code>, and <code>CSE</code>, so these are the <code>Key</code> values for the three groups.</p>
<p>The <code>IGrouping&lt;TKey, TItem&gt;</code> interface derives from <code>IEnumerable&lt;TItem&gt;</code>, so each group object can be enumerated to find the items it contains. So in <a data-type="xref" href="#grouping_query_expression">Example 10-53</a>, the outer <code>foreach</code> loop iterates over the three groups returned by the query, and then the inner <code>foreach</code> loop iterates over the <code>Course</code> objects in each of the groups.</p>
<figure><div class="figure" id="result_of_evaluating_a_grouping_query">
<img alt="" height="622" src="assets/pc10_1001.png" width="600"/>
<h6><span class="label">Figure 10-1. </span>Result of evaluating a grouping query</h6>
</div></figure>
<p>The query expression turns into the code in <a data-type="xref" href="#expanding_a_simple_grouping_query">Example 10-54</a>.</p>
<div data-type="example" id="expanding_a_simple_grouping_query">
<h5><span class="label">Example 10-54. </span>Expanding a simple grouping query</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">subjectGroups</code> <code class="p">=</code> <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code><code class="p">.</code><code class="n">GroupBy</code><code class="p">(</code><code class="n">course</code> <code class="p">=&gt;</code> <code class="n">course</code><code class="p">.</code><code class="n">Category</code><code class="p">);</code></pre></div>
<p><a data-primary="GroupBy operator" data-type="indexterm" id="idm45884803507472"/><a data-primary="LINQ operators" data-secondary="GroupBy" data-type="indexterm" id="idm45884803547328"/>Query expressions offer some variations on the theme of grouping. With a slight modification to the original query, we can arrange for the items in each group to be something other than the original <code>Course</code> objects. In <a data-type="xref" href="#group_query_with_item_projection">Example 10-55</a>, I’ve changed the expression immediately after the <code>group</code> keyword from just <code>course</code> to <code>course.Title</code>.</p>
<div data-type="example" id="group_query_with_item_projection">
<h5><span class="label">Example 10-55. </span>Group query with item projection</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">subjectGroups</code> <code class="p">=</code> <code class="k">from</code> <code class="n">course</code> <code class="k">in</code> <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code>
                    <code class="k">group</code> <code class="n">course</code><code class="p">.</code><code class="n">Title</code> <code class="k">by</code> <code class="n">course</code><code class="p">.</code><code class="n">Category</code><code class="p">;</code></pre></div>
<p>This still has the same grouping expression, <code>course.Category</code>, so this produces three groups as before, but now it’s of type <code>IGrouping&lt;string, string&gt;</code>. If you were to iterate over the contents of one of the groups, you’d find each group offers a sequence of strings, containing the course names. As <a data-type="xref" href="#expanding_a_group_query_with_an_item_pro">Example 10-56</a> shows, the compiler expands this query into a different overload of the <code>GroupBy</code> operator.</p>
<div data-type="example" id="expanding_a_group_query_with_an_item_pro">
<h5><span class="label">Example 10-56. </span>Expanding a group query with an item projection</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">subjectGroups</code> <code class="p">=</code> <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code>
    <code class="p">.</code><code class="n">GroupBy</code><code class="p">(</code><code class="n">course</code> <code class="p">=&gt;</code> <code class="n">course</code><code class="p">.</code><code class="n">Category</code><code class="p">,</code> <code class="n">course</code> <code class="p">=&gt;</code> <code class="n">course</code><code class="p">.</code><code class="n">Title</code><code class="p">);</code></pre></div>
<p>Query expressions are required to have either a <code>select</code> or a <code>group</code> as their final clause. However, if a query contains a <code>group</code> clause, that doesn’t have to be the last clause. In <a data-type="xref" href="#group_query_with_item_projection">Example 10-55</a>, I modified how the query represents each item within a group (i.e., the boxes on the right of <a data-type="xref" href="#result_of_evaluating_a_grouping_query">Figure 10-1</a>), but I’m also free to customize the objects representing each group (the items on the left). By default, I get the <code>IGrouping&lt;TKey, TItem&gt;</code> objects (or the equivalent for whichever LINQ provider the query is using), but I can change this. <a data-primary="into keyword (LINQ query expressions)" data-type="indexterm" id="idm45884803433040"/><a data-type="xref" href="#group_query_with_group_projection">Example 10-57</a> uses the optional <code>into</code> keyword in its <code>group</code> clause. This introduces a new range variable, which iterates over the group objects, which I can go on to use in the rest of the query. I could follow this with other clause types, such as <code>orderby</code> or <code>where</code>, but in this case, I’ve chosen to use a <code>select</code> clause.</p>
<div data-type="example" id="group_query_with_group_projection">
<h5><span class="label">Example 10-57. </span>Group query with group projection</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">subjectGroups</code> <code class="p">=</code>
    <code class="k">from</code> <code class="n">course</code> <code class="k">in</code> <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code>
    <code class="k">group</code> <code class="n">course</code> <code class="k">by</code> <code class="n">course</code><code class="p">.</code><code class="n">Category</code> <code class="k">into</code> <code class="n">category</code>
    <code class="k">select</code> <code class="err">$</code><code class="s">"Category '{category.Key}' contains {category.Count()} courses"</code><code class="p">;</code></pre></div>
<p>The result of this query is an <code>IEnumerable&lt;string&gt;</code>, and if you display all the strings it produces, you get this:</p>
<pre data-type="programlisting">Category 'MAT' contains 3 courses
Category 'BIO' contains 2 courses
Category 'CSE' contains 1 courses</pre>
<p>As <a data-type="xref" href="#expanded_group_query_with_group_projecti">Example 10-58</a> shows, this expands into a call to the same <code>GroupBy</code> overload that <a data-type="xref" href="#expanding_a_simple_grouping_query">Example 10-54</a> uses, and then uses the ordinary <code>Select</code> operator for the final clause.</p>
<div data-type="example" id="expanded_group_query_with_group_projecti">
<h5><span class="label">Example 10-58. </span>Expanded group query with group projection</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">IEnumerable</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="n">subjectGroups</code> <code class="p">=</code> <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code>
    <code class="p">.</code><code class="n">GroupBy</code><code class="p">(</code><code class="n">course</code> <code class="p">=&gt;</code> <code class="n">course</code><code class="p">.</code><code class="n">Category</code><code class="p">)</code>
    <code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">category</code> <code class="p">=&gt;</code>
        <code class="err">$</code><code class="s">"Category '{category.Key}' contains {category.Count()} courses"</code><code class="p">);</code></pre></div>
<p>LINQ to Objects defines some more overloads for the <code>GroupBy</code> operator that are not accessible from the query syntax. <a data-type="xref" href="#groupby_with_key_and_group_projections">Example 10-59</a> shows an overload that provides a slightly more direct equivalent to <a data-type="xref" href="#group_query_with_group_projection">Example 10-57</a>.</p>
<div data-type="example" id="groupby_with_key_and_group_projections">
<h5><span class="label">Example 10-59. </span><code>GroupBy</code> with key and group projections</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">IEnumerable</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="n">subjectGroups</code> <code class="p">=</code> <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code><code class="p">.</code><code class="n">GroupBy</code><code class="p">(</code>
    <code class="n">course</code> <code class="p">=&gt;</code> <code class="n">course</code><code class="p">.</code><code class="n">Category</code><code class="p">,</code>
    <code class="p">(</code><code class="n">category</code><code class="p">,</code> <code class="n">courses</code><code class="p">)</code> <code class="p">=&gt;</code>
        <code class="err">$</code><code class="s">"Category '{category}' contains {courses.Count()} courses"</code><code class="p">);</code></pre></div>
<p>This overload takes two lambdas. The first is the expression by which items are grouped. The second is used to produce each group object. Unlike the previous examples, this does not use the <code>IGrouping&lt;TKey, TItem&gt;</code> interface. Instead, the final lambda receives the key as one argument and then a collection of the items in the group as the second. This is exactly the same information that <code>IGrouping&lt;TKey, TItem&gt;</code> encapsulates, but because this form of the operator can pass these as separate arguments, it removes the need for the operator to create objects to represent the groups.</p>
<p>There’s yet another version of this operator shown in <a data-type="xref" href="#groupby_operator_with_key_comma_item_com">Example 10-60</a>. It combines the functionality of all the other flavors.</p>
<div data-type="example" id="groupby_operator_with_key_comma_item_com">
<h5><span class="label">Example 10-60. </span><code>GroupBy</code> operator with key, item, and group projections</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">IEnumerable</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">&gt;</code> <code class="n">subjectGroups</code> <code class="p">=</code> <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code><code class="p">.</code><code class="n">GroupBy</code><code class="p">(</code>
    <code class="n">course</code> <code class="p">=&gt;</code> <code class="n">course</code><code class="p">.</code><code class="n">Category</code><code class="p">,</code>
    <code class="n">course</code> <code class="p">=&gt;</code> <code class="n">course</code><code class="p">.</code><code class="n">Title</code><code class="p">,</code>
    <code class="p">(</code><code class="n">category</code><code class="p">,</code> <code class="n">titles</code><code class="p">)</code> <code class="p">=&gt;</code>
         <code class="err">$</code><code class="s">"Category '{category}' contains {titles.Count()} courses: "</code> <code class="p">+</code>
             <code class="kt">string</code><code class="p">.</code><code class="n">Join</code><code class="p">(</code><code class="s">", "</code><code class="p">,</code> <code class="n">titles</code><code class="p">));</code></pre></div>
<p>This overload takes three lambdas. The first is the expression by which items are grouped. The second determines how individual items in a group are represented—this time I’ve chosen to extract the course title. The third lambda is used to produce each group object, and as with <a data-type="xref" href="#groupby_with_key_and_group_projections">Example 10-59</a>, this final lambda is passed the key as one argument, and its other argument gets the group items, as transformed by the second lambda. So, rather than the original <code>Course</code> items, this second argument will be an <code>IEnumerable&lt;string&gt;</code> containing the course titles, because that’s what the second lambda in this example requested. The result of this <code>GroupBy</code> operator is once again a collection of strings, but now it looks like this:</p>
<pre data-type="programlisting">Category 'MAT' contains 3 courses: Elements of Geometry, Squaring the Circle, Hy
perbolic Geometry
Category 'BIO' contains 2 courses: Recreational Organ Transplantation, Introduct
ion to Human Anatomy and Physiology
Category 'CSE' contains 1 courses: Oversimplified Data Structures for Demos</pre>
<p>I’ve shown four versions of the <code>GroupBy</code> operator. All four take a lambda that selects the key to use for grouping, and the simplest overload takes nothing else. The others let you control the representation of individual items in the group, or the representation of each group, or both. There are four more versions of this operator. They offer all the same services as the four I’ve shown already but also take an <code>IEqualityComparer&lt;T&gt;</code>, which lets you customize the logic that decides whether two keys are considered to be the same for grouping purposes.</p>
<p>Sometimes it is useful to group by more than one value. For example, suppose you want to group courses by both category and publication year. You could chain the operators, grouping first by category and then by year within the category (or vice versa). But you might not want this level of nesting—instead of groups of groups, you might want to group courses under each unique combination of <code>Category</code> and publication year. The way to do this is simply to put both values into the key, and you can do that by using an anonymous type, as <a data-type="xref" href="#composite_group_key">Example 10-61</a> shows.</p>
<div data-type="example" id="composite_group_key">
<h5><span class="label">Example 10-61. </span>Composite group key</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">bySubjectAndYear</code> <code class="p">=</code>
    <code class="k">from</code> <code class="n">course</code> <code class="k">in</code> <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code>
    <code class="k">group</code> <code class="n">course</code> <code class="k">by</code> <code class="k">new</code> <code class="p">{</code> <code class="n">course</code><code class="p">.</code><code class="n">Category</code><code class="p">,</code> <code class="n">course</code><code class="p">.</code><code class="n">PublicationDate</code><code class="p">.</code><code class="n">Year</code> <code class="p">};</code>
<code class="k">foreach</code> <code class="p">(</code><code class="kt">var</code> <code class="k">group</code> <code class="k">in</code> <code class="n">bySubjectAndYear</code><code class="p">)</code>
<code class="p">{</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"{group.Key.Category} ({group.Key.Year})"</code><code class="p">);</code>
    <code class="k">foreach</code> <code class="p">(</code><code class="kt">var</code> <code class="n">course</code> <code class="k">in</code> <code class="k">group</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">course</code><code class="p">.</code><code class="n">Title</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>This takes advantage of the fact that anonymous types implement <code>Equals</code> and <code>GetHashCode</code> for us. It works for all forms of the <code>GroupBy</code> operator. With LINQ providers that don’t treat their lambdas as expressions (e.g., LINQ to Objects), you could use a tuple instead, which would be slightly more succinct while having the same effect.</p>
<p>There is one other operator that groups its outputs, called <code>GroupJoin</code>, but it does so as part of a join operation, and we’ll look at the simpler joins first.<a data-startref="ix_ch10-asciidoc33" data-type="indexterm" id="idm45884803118592"/><a data-startref="ix_ch10-asciidoc32" data-type="indexterm" id="idm45884803117888"/></p>
</div></section>
<section data-pdf-bookmark="Joins" data-type="sect2"><div class="sect2" id="joins">
<h2>Joins</h2>
<p><a data-primary="Join operator" data-type="indexterm" id="ix_ch10-asciidoc34"/><a data-primary="LINQ operators" data-secondary="Join" data-type="indexterm" id="ch10-jn2"/>LINQ defines a <code>Join</code> operator that enables a query over one source to use related data from some other source, much as a database query can join information from one table with data in another table. Suppose our application stored a list of which students had signed up for which courses. If you stored that information in a file, you wouldn’t want to copy the full details for either the course or the student out into every line—you’d want just enough information to identify a student and a particular course. In my example data, courses are uniquely identified by the combination of the category and the number. To track who’s signed up for what, we’d need records containing three pieces of information: the course category, the course number, and something to identify the student. The record type in <a data-type="xref" href="#type_associating_student_with_course">Example 10-62</a> shows how we might represent this association in memory.</p>
<div data-type="example" id="type_associating_student_with_course">
<h5><span class="label">Example 10-62. </span>Record type associating a student with a course</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="k">public</code> <code class="n">record</code> <code class="nf">CourseChoice</code><code class="p">(</code><code class="kt">int</code> <code class="n">StudentId</code><code class="p">,</code> <code class="kt">string</code> <code class="n">Category</code><code class="p">,</code> <code class="kt">int</code> <code class="n">Number</code><code class="p">);</code></pre></div>
<p><a data-primary="join (LINQ clause)" data-type="indexterm" id="idm45884803032784"/>Once our application has loaded this information into memory, we may want access to the <code>Course</code> objects, rather than just the information identifying the course. We can get this with a <code>join</code> clause, as shown in <a data-type="xref" href="#query_with_join_clause">Example 10-63</a> (which also supplies some additional sample data using the <code>CourseChoice</code> class so that the query has something to work with).</p>
<div data-type="example" id="query_with_join_clause">
<h5><span class="label">Example 10-63. </span>Query with <code>join</code> clause</h5>
<pre data-code-language="csharp" data-type="programlisting">
<code class="n">CourseChoice</code><code class="p">[</code><code class="p">]</code><code> </code><code class="n">choices</code><code> </code><code class="p">=</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="k">new</code><code> </code><code class="nf">CourseChoice</code><code class="p">(</code><code class="n">StudentId</code><code class="p">:</code><code> </code><code class="m">1</code><code class="p">,</code><code> </code><code class="n">Category</code><code class="p">:</code><code> </code><code class="s">"MAT"</code><code class="p">,</code><code> </code><code class="n">Number</code><code class="p">:</code><code> </code><code class="m">101</code><code class="p">)</code><code class="p">,</code><code>
</code><code>    </code><code class="k">new</code><code> </code><code class="nf">CourseChoice</code><code class="p">(</code><code class="n">StudentId</code><code class="p">:</code><code> </code><code class="m">1</code><code class="p">,</code><code> </code><code class="n">Category</code><code class="p">:</code><code> </code><code class="s">"MAT"</code><code class="p">,</code><code> </code><code class="n">Number</code><code class="p">:</code><code> </code><code class="m">102</code><code class="p">)</code><code class="p">,</code><code>
</code><code>    </code><code class="k">new</code><code> </code><code class="nf">CourseChoice</code><code class="p">(</code><code class="n">StudentId</code><code class="p">:</code><code> </code><code class="m">1</code><code class="p">,</code><code> </code><code class="n">Category</code><code class="p">:</code><code> </code><code class="s">"MAT"</code><code class="p">,</code><code> </code><code class="n">Number</code><code class="p">:</code><code> </code><code class="m">207</code><code class="p">)</code><code class="p">,</code><code>
</code><code>    </code><code class="k">new</code><code> </code><code class="nf">CourseChoice</code><code class="p">(</code><code class="n">StudentId</code><code class="p">:</code><code> </code><code class="m">2</code><code class="p">,</code><code> </code><code class="n">Category</code><code class="p">:</code><code> </code><code class="s">"MAT"</code><code class="p">,</code><code> </code><code class="n">Number</code><code class="p">:</code><code> </code><code class="m">101</code><code class="p">)</code><code class="p">,</code><code>
</code><code>    </code><code class="k">new</code><code> </code><code class="nf">CourseChoice</code><code class="p">(</code><code class="n">StudentId</code><code class="p">:</code><code> </code><code class="m">2</code><code class="p">,</code><code> </code><code class="n">Category</code><code class="p">:</code><code> </code><code class="s">"BIO"</code><code class="p">,</code><code> </code><code class="n">Number</code><code class="p">:</code><code> </code><code class="m">201</code><code class="p">)</code><code class="p">,</code><code>
</code><code class="p">}</code><code class="p">;</code><code>
</code><code>
</code><code class="kt">var</code><code> </code><code class="n">studentsAndCourses</code><code> </code><code class="p">=</code><code> </code><code class="k">from</code><code> </code><code class="n">choice</code><code> </code><code class="k">in</code><code> </code><code class="n">choices</code><code>
</code><code>                         </code><strong><code class="k">join</code><code> </code><code class="n">course</code><code> </code><code class="k">in</code><code> </code><code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code></strong><code>
</code><code>                           </code><strong><code class="k">on</code><code> </code><code class="k">new</code><code> </code><code class="p">{</code><code> </code><code class="n">choice</code><code class="p">.</code><code class="n">Category</code><code class="p">,</code><code> </code><code class="n">choice</code><code class="p">.</code><code class="n">Number</code><code> </code><code class="p">}</code></strong><code>
</code><code>                           </code><strong><code class="k">equals</code><code> </code><code class="k">new</code><code> </code><code class="p">{</code><code> </code><code class="n">course</code><code class="p">.</code><code class="n">Category</code><code class="p">,</code><code> </code><code class="n">course</code><code class="p">.</code><code class="n">Number</code><code> </code><code class="p">}</code></strong><code>
</code><code>                         </code><code class="k">select</code><code> </code><code class="k">new</code><code> </code><code class="p">{</code><code> </code><code class="n">choice</code><code class="p">.</code><code class="n">StudentId</code><code class="p">,</code><code> </code><code class="n">Course</code><code> </code><code class="p">=</code><code> </code><code class="n">course</code><code> </code><code class="p">}</code><code class="p">;</code><code>
</code><code>
</code><code class="k">foreach</code><code> </code><code class="p">(</code><code class="kt">var</code><code> </code><code class="n">item</code><code> </code><code class="k">in</code><code> </code><code class="n">studentsAndCourses</code><code class="p">)</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code>
</code><code>        </code><code class="err">$</code><code class="s">"Student {item.StudentId} will attend {item.Course.Title}"</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="p">}</code></pre></div>
<p>This displays one line for each entry in the <code>choices</code> array. It shows the title for each course, because even though that was not available in the input collection, the <code>join</code> clause located the relevant item in the course catalog. <a data-type="xref" href="#using_the_join_operator_directly">Example 10-64</a> shows how the compiler translates the query in <a data-type="xref" href="#query_with_join_clause">Example 10-63</a>.</p>
<div data-type="example" id="using_the_join_operator_directly">
<h5><span class="label">Example 10-64. </span>Using the <code>Join</code> operator directly</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">studentsAndCourses</code> <code class="p">=</code> <code class="n">choices</code><code class="p">.</code><code class="n">Join</code><code class="p">(</code>
    <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code><code class="p">,</code>
    <code class="n">choice</code> <code class="p">=&gt;</code> <code class="k">new</code> <code class="p">{</code> <code class="n">choice</code><code class="p">.</code><code class="n">Category</code><code class="p">,</code> <code class="n">choice</code><code class="p">.</code><code class="n">Number</code> <code class="p">},</code>
    <code class="n">course</code> <code class="p">=&gt;</code> <code class="k">new</code> <code class="p">{</code> <code class="n">course</code><code class="p">.</code><code class="n">Category</code><code class="p">,</code> <code class="n">course</code><code class="p">.</code><code class="n">Number</code> <code class="p">},</code>
    <code class="p">(</code><code class="n">choice</code><code class="p">,</code> <code class="n">course</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="k">new</code> <code class="p">{</code> <code class="n">choice</code><code class="p">.</code><code class="n">StudentId</code><code class="p">,</code> <code class="n">Course</code> <code class="p">=</code> <code class="n">course</code> <code class="p">});</code></pre></div>
<p>The <code>Join</code> operator’s job is to find an item in the second sequence that corresponds to the item in the first. This correspondence is determined by the first two lambdas; items from the two sources will be considered to correspond to one another if the values returned by these two lambdas are equal. This example uses an anonymous type and depends on the fact that two structurally identical anonymously typed instances in the same assembly share the same type. In other words, those two lambdas both produce objects with the same type. The compiler generates an <code>Equals</code> method for any anonymous type that compares each member in turn, so the effect of this code is that two rows are considered to correspond if their <code>Category</code> and <code>Number</code> properties are equal. (Once again, with <code>IQueryable&lt;T&gt;</code>-based providers, we have to use anonymous types, not tuples, because these lambdas will be turned into expression trees. But since this example uses a non-expression-based provider, LINQ to Objects, you could simplify this code slightly by using tuples instead.)</p>
<p>I’ve set up this example so that there can be only one match, but what would happen if the course category and number did not uniquely identify a course for some reason? If there are multiple matches for any single input row, the <code>Join</code> operator will produce one output item for each match, so in that case, we’d get more output items than there were entries in the <code>choices</code> array. Conversely, if an item in the first source has no corresponding item in the second collection, <code>Join</code> will not produce any output for the item—it effectively ignores that input item.</p>
<p>LINQ offers an alternative join type that handles input rows with either zero or multiple corresponding rows differently than the <code>Join</code> operator. <a data-type="xref" href="#a_grouped_join">Example 10-65</a> shows the <span class="keep-together">modified</span> query expression. (The difference is the addition of <code>into courses</code> on the end of the <code>join</code> clause, and the final <code>select</code> clause refers to that instead of the <code>course</code> range variable.) This produces output in a different form, so I’ve also modified the code that writes out the results.</p>
<div data-type="example" id="a_grouped_join">
<h5><span class="label">Example 10-65. </span>A grouped join</h5>
<pre data-code-language="csharp" data-type="programlisting">
<code class="kt">var</code><code> </code><code class="n">studentsAndCourses</code><code> </code><code class="p">=</code><code>
</code><code>    </code><code class="k">from</code><code> </code><code class="n">choice</code><code> </code><code class="k">in</code><code> </code><code class="n">choices</code><code>
</code><code>    </code><code class="k">join</code><code> </code><code class="n">course</code><code> </code><code class="k">in</code><code> </code><code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code><code>
</code><code>      </code><code class="k">on</code><code> </code><code class="k">new</code><code> </code><code class="p">{</code><code> </code><code class="n">choice</code><code class="p">.</code><code class="n">Category</code><code class="p">,</code><code> </code><code class="n">choice</code><code class="p">.</code><code class="n">Number</code><code> </code><code class="p">}</code><code>
</code><code>      </code><code class="k">equals</code><code> </code><code class="k">new</code><code> </code><code class="p">{</code><code> </code><code class="n">course</code><code class="p">.</code><code class="n">Category</code><code class="p">,</code><code> </code><code class="n">course</code><code class="p">.</code><code class="n">Number</code><code> </code><code class="p">}</code><code>
</code><strong><code>      </code><code class="k">into</code><code> </code><code class="n">courses</code></strong><code>
</code><code>    </code><code class="k">select</code><code> </code><code class="k">new</code><code> </code><code class="p">{</code><code> </code><code class="n">choice</code><code class="p">.</code><code class="n">StudentId</code><code class="p">,</code><code> </code><code class="n">Courses</code><code> </code><code class="p">=</code><code> </code><code class="n">courses</code><code> </code><code class="p">}</code><code class="p">;</code><code>
</code><code>
</code><code class="k">foreach</code><code> </code><code class="p">(</code><code class="kt">var</code><code> </code><code class="n">item</code><code> </code><code class="k">in</code><code> </code><code class="n">studentsAndCourses</code><code class="p">)</code><code>
</code><code class="p">{</code><code>
</code><code>    </code><code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="err">$</code><code class="s">"Student {item.StudentId} will attend "</code><code> </code><code class="p">+</code><code>
</code><code>        </code><code class="kt">string</code><code class="p">.</code><code class="n">Join</code><code class="p">(</code><code class="s">","</code><code class="p">,</code><code> </code><code class="n">item</code><code class="p">.</code><code class="n">Courses</code><code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">course</code><code> </code><code class="p">=</code><code class="p">&gt;</code><code> </code><code class="n">course</code><code class="p">.</code><code class="n">Title</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="p">}</code></pre></div>
<p><a data-primary="GroupJoin operator" data-type="indexterm" id="idm45884802556256"/><a data-primary="LINQ operators" data-secondary="GroupJoin" data-type="indexterm" id="idm45884802555648"/>As <a data-type="xref" href="#groupjoin_operator">Example 10-66</a> shows, this causes the compiler to generate a call to the <code>GroupJoin</code> operator instead of <code>Join</code>.</p>
<div data-type="example" id="groupjoin_operator">
<h5><span class="label">Example 10-66. </span><code>GroupJoin</code> operator</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">studentsAndCourses</code> <code class="p">=</code> <code class="n">choices</code><code class="p">.</code><code class="n">GroupJoin</code><code class="p">(</code>
    <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code><code class="p">,</code>
    <code class="n">choice</code> <code class="p">=&gt;</code> <code class="k">new</code> <code class="p">{</code> <code class="n">choice</code><code class="p">.</code><code class="n">Category</code><code class="p">,</code> <code class="n">choice</code><code class="p">.</code><code class="n">Number</code> <code class="p">},</code>
    <code class="n">course</code> <code class="p">=&gt;</code> <code class="k">new</code> <code class="p">{</code> <code class="n">course</code><code class="p">.</code><code class="n">Category</code><code class="p">,</code> <code class="n">course</code><code class="p">.</code><code class="n">Number</code> <code class="p">},</code>
    <code class="p">(</code><code class="n">choice</code><code class="p">,</code> <code class="n">courses</code><code class="p">)</code> <code class="p">=&gt;</code> <code class="k">new</code> <code class="p">{</code> <code class="n">choice</code><code class="p">.</code><code class="n">StudentId</code><code class="p">,</code> <code class="n">Courses</code> <code class="p">=</code> <code class="n">courses</code> <code class="p">});</code></pre></div>
<p>This form of join produces one result for each item in the input collection by invoking the final lambda. Its first argument is the input item, and its second argument will be a collection of all the corresponding objects from the second collection. (Compare this with <code>Join</code>, which invokes its final lambda once for each match, passing the corresponding items one at a time.) This provides a way to represent an input item that has no corresponding items in the second collection: the operator can just pass an empty collection.</p>
<p>Both <code>Join</code> and <code>GroupJoin</code> also have overloads that accept an <code>IEqualityComparer&lt;T&gt;</code> so that you can define a custom meaning for equality for the values returned by the first two lambdas.<a data-startref="ix_ch10-asciidoc34" data-type="indexterm" id="idm45884802439248"/><a data-startref="ch10-jn2" data-type="indexterm" id="idm45884802438544"/></p>
</div></section>
<section data-pdf-bookmark="Conversion" data-type="sect2"><div class="sect2" id="conversion">
<h2>Conversion</h2>
<p><a data-primary="conversions" data-secondary="conversion queries" data-type="indexterm" id="ix_ch10-asciidoc36"/><a data-primary="LINQ operators" data-secondary="conversion" data-type="indexterm" id="ix_ch10-asciidoc37"/>Sometimes you will need to convert a query of one type to some other type. For example, you might have ended up with a collection where the type argument specifies some base type (e.g., <code>object</code>), but you have good reason to believe that the collection actually contains items of some more specific type (e.g., <code>Course</code>). When dealing with individual objects, you can just use the C# cast syntax to convert the reference to the type you believe you’re dealing with. Unfortunately, this doesn’t work for types such as <code>IEnumerable&lt;T&gt;</code> or <code>IQueryable&lt;T&gt;</code>.</p>
<p>Although covariance means that an <code>IEnumerable&lt;Course&gt;</code> is implicitly convertible to an <code>IEnumerable&lt;object&gt;</code>, <a data-primary="downcast" data-type="indexterm" id="idm45884802429696"/>you cannot convert in the other direction even with an explicit downcast. If you have a reference of type <code>IEnumerable&lt;object&gt;</code>, attempting to cast that to <code>IEnumerable&lt;Course&gt;</code> will succeed only if the object implements 
<span class="keep-together"><code>IEnumerable&lt;Course&gt;</code></span>. It’s quite possible to end up with a sequence that consists entirely of <code>Course</code> objects but that does not implement <code>IEnumerable&lt;Course&gt;</code>. Note that <a data-type="xref" href="#how_not_to_cast_a_sequence">Example 10-67</a> creates just such a sequence, and it will throw an exception when it tries to cast to <code>IEnumerable&lt;Course&gt;</code>.<a data-primary="InvalidCastException type" data-type="indexterm" id="idm45884802425040"/></p>
<div data-type="example" id="how_not_to_cast_a_sequence">
<h5><span class="label">Example 10-67. </span>How not to cast a sequence</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">IEnumerable</code><code class="p">&lt;</code><code class="kt">object</code><code class="p">&gt;</code> <code class="n">sequence</code> <code class="p">=</code> <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code><code class="p">.</code><code class="n">Select</code><code class="p">(</code><code class="n">c</code> <code class="p">=&gt;</code> <code class="p">(</code><code class="kt">object</code><code class="p">)</code> <code class="n">c</code><code class="p">);</code>
<code class="kt">var</code> <code class="n">courseSequence</code> <code class="p">=</code> <code class="p">(</code><code class="n">IEnumerable</code><code class="p">&lt;</code><code class="n">Course</code><code class="p">&gt;)</code> <code class="n">sequence</code><code class="p">;</code> <code class="c1">// InvalidCastException</code></pre></div>
<p>This is a contrived example, of course. I forced the creation of an 
<span class="keep-together"><code>IEnumerable&lt;object&gt;</code></span> by casting the <code>Select</code> lambda’s return type to <code>object</code>. However, it’s easy enough to end up in this situation for real, in only slightly more complex circumstances. Fortunately, there’s an easy solution. <a data-primary="Cast&lt;T&gt; operator" data-type="indexterm" id="idm45884802371008"/><a data-primary="LINQ operators" data-secondary="Cast&lt;T&gt;" data-type="indexterm" id="idm45884802370336"/>You can use the <code>Cast&lt;T&gt;</code> operator, shown in <a data-type="xref" href="#how_to_cast_a_sequence">Example 10-68</a>.</p>
<div data-type="example" id="how_to_cast_a_sequence">
<h5><span class="label">Example 10-68. </span>How to cast a sequence</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="kt">var</code> <code class="n">courseSequence</code> <code class="p">=</code> <code class="n">sequence</code><code class="p">.</code><code class="n">Cast</code><code class="p">&lt;</code><code class="n">Course</code><code class="p">&gt;();</code></pre></div>
<p>This returns a query that produces every item in its source in order, but it casts each item to the specified target type as it does so. This means that although the initial <code>Cast&lt;T&gt;</code> might succeed, it’s possible that you’ll get an <code>InvalidCastException</code> some point later when you try to extract values from the sequence. After all, in general, the only way the <code>Cast&lt;T&gt;</code> operator can verify that the sequence you’ve given it really does only ever produce values of type <code>T</code> is to extract all those values and attempt to cast them. It can’t evaluate the whole sequence up front because you might have supplied an infinite sequence. If the first billion items your sequence produces will be of the right type, but after that you return one of an incompatible type, the only way <code>Cast&lt;T&gt;</code> can discover this is to try casting items one at a time.</p>
<div data-type="tip"><h6>Tip</h6>
<p><code>Cast&lt;T&gt;</code> and <code>OfType&lt;T&gt;</code> look similar, and developers sometimes use one when they should have used the other (usually because they didn’t know both existed). <code>OfType&lt;T&gt;</code> does almost the same thing as <code>Cast&lt;T&gt;</code>, but it silently filters out any items of the wrong type instead of throwing an exception. If you expect and want to ignore items of the wrong type, use <code>OfType&lt;T&gt;</code>. If you do not expect items of the wrong type to be present at all, use <code>Cast&lt;T&gt;</code>, because if you turn out to be wrong, it will let you know by throwing an exception, reducing the risk of allowing a potential bug to remain hidden.</p>
</div>
<p><a data-primary="AsEnumerable&lt;T&gt; operator" data-type="indexterm" id="idm45884802333408"/>LINQ to Objects defines an <code>AsEnumerable&lt;T&gt;</code> operator. This just returns the source without modification—it has no effect at runtime. Its purpose is to force the use of LINQ to Objects even if you are dealing with something that might have been handled by a different LINQ provider. For example, suppose you have something that implements <code>IQueryable&lt;T&gt;</code>. That interface derives from <code>IEnumerable&lt;T&gt;</code>, but the extension methods that work with <code>IQueryable&lt;T&gt;</code> will take precedence over the LINQ to Objects ones. If your intention is to execute a particular query on a database, and then use further client-side processing of the results with LINQ to Objects, you can use <code>AsEnumerable&lt;T&gt;</code> to draw a line that says, “This is where we move things to the client side.”</p>
<p><a data-primary="AsQueryable&lt;T&gt; operator" data-type="indexterm" id="idm45884802329632"/>Conversely, there’s also <code>AsQueryable&lt;T&gt;</code>. This is designed to be used in scenarios where you have a variable of static type <code>IEnumerable&lt;T&gt;</code> that you believe might contain a reference to an object that also implements <code>IQueryable&lt;T&gt;</code>, and you want to ensure that any queries you create use that instead of LINQ to Objects. If you use this operator on a source that does not in fact implement <code>IQueryable&lt;T&gt;</code>, it returns a wrapper that implements <code>IQueryable&lt;T&gt;</code> but uses LINQ to Objects under the covers.</p>
<p><a data-primary="AsParallel&lt;T&gt; operator" data-type="indexterm" id="idm45884802326272"/>Yet another operator for selecting a different flavor of LINQ is <code>AsParallel</code>. This returns a <code>ParallelQuery&lt;T&gt;</code>, which lets you build queries to be executed by Parallel LINQ, a LINQ provider that can execute certain operations in parallel to improve performance when multiple CPU cores are available.</p>
<p><a data-primary="LINQ operators" data-secondary="ToDictionary" data-type="indexterm" id="idm45884802324320"/><a data-primary="ToArray operator" data-type="indexterm" id="idm45884802322944"/><a data-primary="ToList operator" data-type="indexterm" id="idm45884802322272"/><a data-primary="ToLookup operator" data-type="indexterm" id="idm45884802321600"/>There are some operators that convert the query to other types and also have the effect of executing the query immediately rather than building a new query chained off the back of the previous one. <code>ToArray</code>, <code>ToList</code>, and <code>ToHashSet</code> return an array, list, or hash set, respectively, containing the complete results of executing the input query. <code>ToDictionary</code> and <code>ToLookup</code> do the same, but rather than producing a straightforward list of the items, they both produce results that support associative lookup. <code>ToDictionary</code> returns a <code>Dictionary&lt;TKey, TValue&gt;</code>, so it is intended for scenarios where a key corresponds to exactly one value. <code>ToLookup</code> is designed for scenarios where a key may be associated with multiple values, so it returns a different type, <code>ILookup&lt;TKey, TValue&gt;</code>.</p>
<p>I did not mention this lookup interface in <a data-type="xref" href="ch05.xhtml#ch_collections">Chapter 5</a> because it is specific to LINQ. It is essentially the same as a read-only dictionary interface, except the indexer returns an <code>IEnumerable&lt;TValue&gt;</code> instead of a single <code>TValue</code>.</p>
<p>While the array and list conversions take no arguments, the dictionary and lookup conversions need to be told what value to use as the key for each source item. You tell them by passing a lambda, as <a data-type="xref" href="#creating_a_lookup">Example 10-69</a> shows. This uses the course’s <code>Category</code> property as the key.</p>
<div data-type="example" id="creating_a_lookup">
<h5><span class="label">Example 10-69. </span>Creating a lookup</h5>
<pre data-code-language="csharp" data-type="programlisting"><code class="n">ILookup</code><code class="p">&lt;</code><code class="kt">string</code><code class="p">,</code> <code class="n">Course</code><code class="p">&gt;</code> <code class="n">categoryLookup</code> <code class="p">=</code>
    <code class="n">Course</code><code class="p">.</code><code class="n">Catalog</code><code class="p">.</code><code class="n">ToLookup</code><code class="p">(</code><code class="n">course</code> <code class="p">=&gt;</code> <code class="n">course</code><code class="p">.</code><code class="n">Category</code><code class="p">);</code>
<code class="k">foreach</code> <code class="p">(</code><code class="n">Course</code> <code class="n">c</code> <code class="k">in</code> <code class="n">categoryLookup</code><code class="p">[</code><code class="s">"MAT"</code><code class="p">])</code>
<code class="p">{</code>
    <code class="n">Console</code><code class="p">.</code><code class="n">WriteLine</code><code class="p">(</code><code class="n">c</code><code class="p">.</code><code class="n">Title</code><code class="p">);</code>
<code class="p">}</code></pre></div>
<p><a data-primary="ToDictionary operator" data-type="indexterm" id="idm45884802278080"/>The <code>ToDictionary</code> operator offers an overload that takes the same argument but returns a dictionary instead of a lookup. It would throw an exception if you called it in the same way that I called <code>ToLookup</code> in <a data-type="xref" href="#creating_a_lookup">Example 10-69</a>, because multiple course objects share categories, so they would map to the same key. <code>ToDictionary</code> requires each object to have a unique key. To produce a dictionary from the course catalog, you’d either need to group the data by category first and have each dictionary entry refer to an entire group or need a lambda that returned a composite key based on both the course category and number, because that combination is unique to a course.</p>
<p>Both operators also offer an overload that takes a pair of lambdas—one that extracts the key and a second that chooses what to use as the corresponding value (you are not obliged to use the source item as the value). Finally, there are overloads that also take an <code>IEqualityComparer&lt;T&gt;</code>.<a data-startref="ix_ch10-asciidoc37" data-type="indexterm" id="idm45884802235024"/><a data-startref="ix_ch10-asciidoc36" data-type="indexterm" id="idm45884802234288"/></p>
<p>You’ve now seen all of the standard LINQ operators, but since that has taken quite a few pages, you may find it useful to have a concise summary. <a data-type="xref" href="#summary_of_linq_operators">Table 10-1</a> lists the operators and describes briefly what each is for.</p>
<table id="summary_of_linq_operators">
<caption><span class="label">Table 10-1. </span>Summary of LINQ operators</caption>
<thead>
<tr>
<th>Operator</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><p><code>Aggregate</code></p></td>
<td><p>Combines all items through a user-supplied function to produce a single result.</p></td>
</tr>
<tr>
<td><p><code>All</code></p></td>
<td><p>Returns <code>true</code> if the predicate supplied is false for no items.</p></td>
</tr>
<tr>
<td><p><code>Any</code></p></td>
<td><p>Returns <code>true</code> if the predicate supplied is true for at least one item.</p></td>
</tr>
<tr>
<td><p><code>Append</code></p></td>
<td><p>Returns a sequence with all the items from its input sequence with one item added to the end.</p></td>
</tr>
<tr>
<td><p><code>AsEnumerable</code></p></td>
<td><p>Returns the sequence as an <code>IEnumerable&lt;T&gt;</code>. (Useful for forcing use of LINQ to Objects.)</p></td>
</tr>
<tr>
<td><p><code>AsParallel</code></p></td>
<td><p>Returns a <code>ParallelQuery&lt;T&gt;</code> for parallel query execution.</p></td>
</tr>
<tr>
<td><p><code>AsQueryable</code></p></td>
<td><p>Ensures use of <code>IQueryable&lt;T&gt;</code> handling where available.</p></td>
</tr>
<tr>
<td><p><code>Average</code></p></td>
<td><p>Calculates the arithmetic mean of the items.</p></td>
</tr>
<tr>
<td><p><code>Cast</code></p></td>
<td><p>Casts each item in the sequence to the specified type.</p></td>
</tr>
<tr>
<td><p><code>Chunk</code></p></td>
<td><p>Splits a sequence into equal-sized batches.</p></td>
</tr>
<tr>
<td><p><code>Concat</code></p></td>
<td><p>Forms a sequence by concatenating two sequences.</p></td>
</tr>
<tr>
<td><p><code>Contains</code></p></td>
<td><p>Returns <code>true</code> if the specified item is in the sequence.</p></td>
</tr>
<tr>
<td><p><code>Count</code>, <span class="keep-together"><code>LongCount</code></span></p></td>
<td><p>Return the number of items in the sequence.</p></td>
</tr>
<tr>
<td><p><code>DefaultIfEmpty</code></p></td>
<td><p>Produces the source sequence’s elements, unless there are none, in which case it produces a single element with a default value.</p></td>
</tr>
<tr>
<td><p><code>Distinct</code></p></td>
<td><p>Removes duplicate values.</p></td>
</tr>
<tr>
<td><p><code>DistinctBy</code></p></td>
<td><p>Removes values for which a projection produces duplicate values.</p></td>
</tr>
<tr>
<td><p><code>ElementAt</code></p></td>
<td><p>Returns the element at the specified position (throwing an exception if out of range).</p></td>
</tr>
<tr>
<td><p><code>ElementAtOr​Default</code></p></td>
<td><p>Returns the element at the specified position (producing the element type’s default value if out of range).</p></td>
</tr>
<tr>
<td><p><code>Except</code></p></td>
<td><p>Filters out items that are in the other collection provided.</p></td>
</tr>
<tr>
<td><p><code>First</code></p></td>
<td><p>Returns the first item, throwing an exception if there are no items.</p></td>
</tr>
<tr>
<td><p><code>FirstOrDefault</code></p></td>
<td><p>Returns the first item, or a default value if there are no items.</p></td>
</tr>
<tr>
<td><p><code>GroupBy</code></p></td>
<td><p>Gathers items into groups.</p></td>
</tr>
<tr>
<td><p><code>GroupJoin</code></p></td>
<td><p>Groups items in another sequence by how they relate to items in the input sequence.</p></td>
</tr>
<tr>
<td><p><code>Intersect</code></p></td>
<td><p>Filters out items that are not in the other collection provided.</p></td>
</tr>
<tr>
<td><p><code>IntersectBy</code></p></td>
<td><p>Same as <code>Intersect</code> but using a projection for comparison.</p></td>
</tr>
<tr>
<td><p><code>Join</code></p></td>
<td><p>Produces an item for each matching pair of items from the two input sequences.</p></td>
</tr>
<tr>
<td><p><code>Last</code></p></td>
<td><p>Returns the final item, throwing an exception if there are no items.</p></td>
</tr>
<tr>
<td><p><code>LastOrDefault</code></p></td>
<td><p>Returns the final item, or a default value if there are no items.</p></td>
</tr>
<tr>
<td><p><code>Max</code></p></td>
<td><p>Returns the highest value.</p></td>
</tr>
<tr>
<td><p><code>MaxBy</code></p></td>
<td><p>Returns the item for which a projection produces the highest value.</p></td>
</tr>
<tr>
<td><p><code>Min</code></p></td>
<td><p>Returns the lowest value.</p></td>
</tr>
<tr>
<td><p><code>MinBy</code></p></td>
<td><p>Returns the item for which a projection produces the lowest value.</p></td>
</tr>
<tr>
<td><p><code>OfType</code></p></td>
<td><p>Filters out items that are not of the specified type.</p></td>
</tr>
<tr>
<td><p><code>OrderBy</code></p></td>
<td><p>Produces items in an ascending order.</p></td>
</tr>
<tr>
<td><p><code>Ord⁠erBy​Des⁠cen⁠ding</code></p></td>
<td><p>Produces items in a descending order.</p></td>
</tr>
<tr>
<td><p><code>Prepend</code></p></td>
<td><p>Returns a sequence starting with a specified single item, followed by all the items from its input sequence.</p></td>
</tr>
<tr>
<td><p><code>Reverse</code></p></td>
<td><p>Produces items in the opposite order than the input.</p></td>
</tr>
<tr>
<td><p><code>Select</code></p></td>
<td><p>Projects each item through a function.</p></td>
</tr>
<tr>
<td><p><code>SelectMany</code></p></td>
<td><p>Combines multiple collections into one.</p></td>
</tr>
<tr>
<td><p><code>SequenceEqual</code></p></td>
<td><p>Returns <code>true</code> only if all items are equal to those in the other sequence provided.</p></td>
</tr>
<tr>
<td><p><code>Single</code></p></td>
<td><p>Returns the only item, throwing an exception if there are no items or more than one item.</p></td>
</tr>
<tr>
<td><p><code>SingleOr​Default</code></p></td>
<td><p>Returns the only item, or a default value if there are no items; throws an exception if there is more than one item.</p></td>
</tr>
<tr>
<td><p><code>Skip</code></p></td>
<td><p>Filters out the specified number of items from the start.</p></td>
</tr>
<tr>
<td><p><code>SkipLast</code></p></td>
<td><p>Filters out the specified number of items from the end.</p></td>
</tr>
<tr>
<td><p><code>SkipWhile</code></p></td>
<td><p>Filters out items from the start for as long as the items match a predicate.</p></td>
</tr>
<tr>
<td><p><code>Sum</code></p></td>
<td><p>Returns the result of adding all the items together.</p></td>
</tr>
<tr>
<td><p><code>Take</code></p></td>
<td><p>Produces the specified number or range of items, discarding the rest.</p></td>
</tr>
<tr>
<td><p><code>TakeLast</code></p></td>
<td><p>Produces the specified number of items from the end of the input (discarding all items before that).</p></td>
</tr>
<tr>
<td><p><code>TakeWhile</code></p></td>
<td><p>Produces items as long as they match a predicate, discarding the rest of the sequence as soon as one fails to match.</p></td>
</tr>
<tr>
<td><p><code>ToArray</code></p></td>
<td><p>Returns an array containing all of the items.</p></td>
</tr>
<tr>
<td><p><code>ToDictionary</code></p></td>
<td><p>Returns a dictionary containing all of the items.</p></td>
</tr>
<tr>
<td><p><code>ToHashSet</code></p></td>
<td><p>Returns a <code>HashSet&lt;T&gt;</code> containing all of the items.</p></td>
</tr>
<tr>
<td><p><code>ToList</code></p></td>
<td><p>Returns a <code>List&lt;T&gt;</code> containing all of the items.</p></td>
</tr>
<tr>
<td><p><code>ToLookup</code></p></td>
<td><p>Returns a multivalue associative lookup containing all of the items.</p></td>
</tr>
<tr>
<td><p><code>Union</code></p></td>
<td><p>Produces all items that are in either or both of the inputs.</p></td>
</tr>
<tr>
<td><p><code>UnionBy</code></p></td>
<td><p>Same as <code>Union</code> but using a projection for comparison.</p></td>
</tr>
<tr>
<td><p><code>Where</code></p></td>
<td><p>Filters out items that do not match the predicate provided.</p></td>
</tr>
<tr>
<td><p><code>Zip</code></p></td>
<td><p>Combines items at the same position from two or three inputs.<a data-startref="ix_ch10-asciidoc12" data-type="indexterm" id="idm45884802110496"/></p></td>
</tr>
</tbody>
</table>
</div></section>
</div></section>
<section data-pdf-bookmark="Sequence Generation" data-type="sect1"><div class="sect1" id="sequence_generation">
<h1>Sequence Generation</h1>
<p><a data-primary="Enumerable class" data-type="indexterm" id="idm45884802215760"/><a data-primary="LINQ" data-secondary="sequence generation" data-type="indexterm" id="idm45884802108976"/><a data-primary="sequence generation, LINQ" data-type="indexterm" id="idm45884802108032"/>The <code>Enumerable</code> class defines the extension methods for <code>IEnumerable&lt;T&gt;</code> that constitute LINQ to Objects. It also offers a few additional (nonextension) static methods that can be used to create new sequences. <code>Enumerable.Range</code> takes two <code>int</code> arguments and returns an <code>IEnumerable&lt;int&gt;</code> that produces a sequentially increasing series of numbers, starting from the value of the first argument and containing as many numbers as the second argument. For example, <code>Enumerable.Range(15, 10)</code> produces a sequence containing the numbers 15 to 24 (inclusive).</p>
<p><code>Enumerable.Repeat&lt;T&gt;</code> takes a value of type <code>T</code> and a count. It returns a sequence that will produce that value the specified number of times.</p>
<p><code>Enumerable.Empty&lt;T&gt;</code> returns an <code>IEnumerable&lt;T&gt;</code> that contains no elements. This may not sound very useful, because there’s a much less verbose alternative. You could write <code>new T[0]</code>, which creates an array that contains no elements. (Arrays of type <code>T</code> implement <code>IEnumerable&lt;T&gt;</code>.) However, the advantage of <code>Enumerable.Empty&lt;T&gt;</code> is that for any given <code>T</code>, it returns the same instance every time. This means that if for any reason you end up needing an empty sequence repeatedly in a loop that executes many iterations, <code>Enumerable.Empty&lt;T&gt;</code> is more efficient, because it puts less pressure on the GC.</p>
</div></section>
<section data-pdf-bookmark="Other LINQ Implementations" data-type="sect1"><div class="sect1" id="other_linq_implementations">
<h1>Other LINQ Implementations</h1>
<p>Most of the examples I’ve shown in this chapter have used LINQ to Objects, except for a handful that have referred to EF Core. In this final section, I will provide a quick description of some other LINQ-based technologies. This is not a comprehensive list, because anyone can write a LINQ provider.</p>
<section data-pdf-bookmark="Entity Framework Core" data-type="sect2"><div class="sect2" id="entity_framework">
<h2>Entity Framework Core</h2>
<p><a data-primary="database access, LINQ and" data-type="indexterm" id="idm45884802095248"/><a data-primary="EF Core (Entity Framework Core)" data-type="indexterm" id="idm45884802094480"/><a data-primary="Entity Framework Core (EF Core)" data-type="indexterm" id="idm45884802093792"/><a data-primary="LINQ" data-secondary="Entity Framework" data-type="indexterm" id="idm45884802093104"/>The database examples I have shown have used the LINQ provider that is part of Entity Framework Core (EF Core). EF Core is a data access technology that ships in a NuGet package, <code>Microsoft.EntityFrameworkCore</code>. (EF Core’s predecessor, the Entity Framework, is still built into .NET Framework but not in newer versions of .NET.) EF Core can map between a database and an object layer. It supports multiple database vendors.</p>
<p><a data-primary="IQueryable&lt;T&gt; interface" data-secondary="EF Core and" data-type="indexterm" id="idm45884802091168"/>EF Core relies on <code>IQueryable&lt;T&gt;</code>. For each persistent entity type in a data model, the EF can provide an object that implements <code>IQueryable&lt;T&gt;</code> and that can be used as the starting point for building queries to retrieve entities of that type and of related types. Since <code>IQueryable&lt;T&gt;</code> is not unique to the EF, you will be using the standard set of extension methods provided by the <code>Queryable</code> class in the <code>System.Linq</code> namespace, but that mechanism is designed to allow each provider to plug in its own behavior.</p>
<p>Because <code>IQueryable&lt;T&gt;</code> defines the LINQ operators as methods that accept 
<span class="keep-together"><code>Expression&lt;T&gt;</code></span> arguments and not plain delegate types, any expressions you write in either query expressions or as lambda arguments to the underlying operator methods will turn into compiler-generated code that creates a tree of objects representing the structure of the expression. The EF relies on this to be able to generate database queries that fetch the data you require. This means that you are obliged to use lambdas; unlike with LINQ to Objects, you cannot use anonymous methods or delegates with an EF query.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>Because <code>IQueryable&lt;T&gt;</code> derives from <code>IEnumerable&lt;T&gt;</code>, it’s possible to use LINQ to Objects operators on any EF source. You can do this explicitly with the <code>AsEnumerable&lt;T&gt;</code> operator, but it could also happen accidentally if you used an overload that’s supported by LINQ to Objects and not <code>IQueryable&lt;T&gt;</code>. For example, if you attempt to use a delegate instead of a lambda as, say, the predicate for the <code>Where</code> operator, this will fall back to LINQ to Objects. The upshot here is that EF will end up downloading the entire contents of the table and then evaluating the <code>Where</code> operator on the client side. This is unlikely to be a good idea.</p>
</div>
</div></section>
<section data-pdf-bookmark="Parallel LINQ (PLINQ)" data-type="sect2"><div class="sect2" id="parallel_linq_open_parenthesis_plinq_clo">
<h2>Parallel LINQ (PLINQ)</h2>
<p><a data-primary="LINQ" data-secondary="Parallel LINQ (PLINQ)" data-type="indexterm" id="idm45884802079568"/><a data-primary="Parallel LINQ (PLINQ)" data-type="indexterm" id="idm45884802078592"/><a data-primary="PLINQ (Parallel LINQ)" data-type="indexterm" id="idm45884802077920"/>Parallel LINQ is similar to LINQ to Objects in that it is based on objects and delegates rather than expression trees and query translation. But when you start asking for results from a query, it will use multithreaded evaluation where possible, using the thread pool to try to use the available CPU resources efficiently. <a data-type="xref" href="ch16.xhtml#ch_multithreading">Chapter 16</a> will show multithreading in action.</p>
</div></section>
<section data-pdf-bookmark="LINQ to XML" data-type="sect2"><div class="sect2" id="linq_to_xml">
<h2>LINQ to XML</h2>
<p><a data-primary="LINQ" data-secondary="LINQ to XML" data-type="indexterm" id="idm45884802074624"/><a data-primary="LINQ to XML" data-type="indexterm" id="idm45884802073648"/>LINQ to XML is not a LINQ provider. I’m mentioning it here because its name makes it sound like one. It’s really an API for creating and parsing XML documents. It’s called <em>LINQ to XML</em> because it was designed to make it easy to execute LINQ queries against XML documents, but it achieves this by presenting XML documents through a .NET object model. The runtime libraries provide two separate APIs that do this: as well as LINQ to XML, it also offers the XML Document Object Model (DOM). The DOM is based on a platform-independent standard, and thus, it’s not a brilliant match for .NET idioms and feels unnecessarily quirky compared with most of the runtime libraries. LINQ to XML was designed purely for .NET, so it integrates better with normal C# techniques. This includes working well with LINQ, which it does by providing methods that extract features from the document in terms of <code>IEnumerable&lt;T&gt;</code>. This enables it to defer to LINQ to Objects to define and execute the queries.</p>
</div></section>
<section data-pdf-bookmark="IAsyncEnumerable&lt;T&gt;" data-type="sect2"><div class="sect2" id="linq_to_iasyncenumerable">
<h2>IAsyncEnumerable&lt;T&gt;</h2>
<p><a data-primary="IAsyncEnumerable&lt;T&gt; interface" data-type="indexterm" id="idm45884802070160"/>As <a data-type="xref" href="ch05.xhtml#ch_collections">Chapter 5</a> described, .NET defines the <code>IAsyncEnumerable&lt;T&gt;</code> interface, which is an asynchronous equivalent to <code>IEnumerable&lt;T&gt;</code>. <a data-type="xref" href="ch17.xhtml#ch_asynchronous_language_features">Chapter 17</a> will describe the language features that enable you to use this. A full set of LINQ operators is available, although they are not built into the .NET runtime libraries. They are available in a NuGet package called <code>System.Linq.Async</code>.</p>
</div></section>
<section data-pdf-bookmark="Reactive Extensions" data-type="sect2"><div class="sect2" id="reactive_extensions">
<h2>Reactive Extensions</h2>
<p><a data-primary="LINQ" data-secondary="reactive extensions" data-type="indexterm" id="idm45884802064416"/><a data-primary="reactive extensions (Rx)" data-type="indexterm" id="idm45884802063440"/>The Reactive Extensions for .NET (or Rx, as they’re often abbreviated) are the subject of the next chapter, so I won’t say too much about them here, but they are a good illustration of how LINQ operators can work on a variety of types. Rx inverts the model shown in this chapter where we ask a query for items once we’re good and ready. So, instead of writing a <code>foreach</code> loop that iterates over a query, or calling one of the operators that evaluates the query such as <code>ToArray</code> or <code>SingleOrDefault</code>, an Rx source calls us when it’s ready to supply data.</p>
<p>Despite this inversion, there is a LINQ provider for Rx that supports most of the standard LINQ operators.</p>
</div></section>
</div></section>
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="summary-id9">
<h1>Summary</h1>
<p>In this chapter, I showed the query syntax that supports some of the most commonly used LINQ features. This lets us write queries in C# that resemble database queries but can query any LINQ provider, including LINQ to Objects, which lets us run queries against our object models. I showed the standard LINQ operators for querying, all of which are available with LINQ to Objects, and most of which are available with database providers. I also provided a quick roundup of some of the common LINQ providers for .NET applications.<a data-startref="ix_ch10-asciidoc0" data-type="indexterm" id="idm45884802058784"/></p>
<p>The last provider I mentioned was Rx. But before we look at Rx’s LINQ provider, the next chapter will begin by looking at how Rx itself works.</p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="idm45884806145536"><sup><a href="ch10.xhtml#idm45884806145536-marker">1</a></sup> As I write this, the tentative feature set for .NET 7.0 includes fixing this, so there’s some hope that this might improve.</p><p data-type="footnote" id="CHP-10-FN-1"><sup><a href="ch10.xhtml#CHP-10-FN-1-marker">2</a></sup> If you do so, be careful not to confuse it with another WPF type, <code>Rectangle</code>. That’s an altogether more complex beast that supports animation, styling, layout, user input, databinding, and various other WPF features. Do not attempt to use <code>Rectangle</code> outside of a WPF application.</p><p data-type="footnote" id="idm45884803901728"><sup><a href="ch10.xhtml#idm45884803901728-marker">3</a></sup> This is unrelated to the <code>Rect.Union</code> method used in the preceding example.</p></div></div></section></div></body></html>